<?xml version="1.0" encoding="utf-8"?>
<HTTPSnapshot xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" id="4">
  <HTTPTask id="19" hostname="demo.borland.com" path="/InsuranceWebExtJS/agent_lookup.jsf" url="http://demo.borland.com/InsuranceWebExtJS/agent_lookup.jsf" ip="143.186.120.171" port="80" client_ip="192.168.0.123" client_port="15233" connectionId="1828" origin="Primary" encodingType="ANSI" startDateTime="2019-02-27T16:49:28.988+05:30" startTime="3629" endTime="3825" blockedTime="0" dnsTime="0" connectTime="0" sendTime="0" waitTime="0" receiveTime="0" sslNegotiateTime="0" responseBodySize="0">
    <HTTPRequest method="POST">
      <HTTPHeaders>
        <HTTPHeaderEntity name="Content-Type" index="0">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>YXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVk</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Referer" index="1">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>aHR0cDovL2RlbW8uYm9ybGFuZC5jb20vSW5zdXJhbmNlV2ViRXh0SlMvYWdlbnRfbG9va3VwLmpzZg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="User-Agent" index="2">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>TW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzcyLjAuMzYyNi4xMTkgU2FmYXJpLzUzNy4zNg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept-Encoding" index="3">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Z3ppcCwgZGVmbGF0ZQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept-Language" index="4">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>ZW4tVVMsZW47cT0wLjk=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept" index="5">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Ki8q</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Connection" index="6">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>S2VlcC1BbGl2ZQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Host" index="7">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>ZGVtby5ib3JsYW5kLmNvbQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Cookie" index="8">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>SlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFC</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Length" index="9">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>MTUw</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPAllHeaders>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>UE9TVCAvSW5zdXJhbmNlV2ViRXh0SlMvYWdlbnRfbG9va3VwLmpzZiBIVFRQLzEuMQ0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQNClJlZmVyZXI6IGh0dHA6Ly9kZW1vLmJvcmxhbmQuY29tL0luc3VyYW5jZVdlYkV4dEpTL2FnZW50X2xvb2t1cC5qc2YNClVzZXItQWdlbnQ6IE1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS83Mi4wLjM2MjYuMTE5IFNhZmFyaS81MzcuMzYNCkFjY2VwdC1FbmNvZGluZzogZ3ppcCwgZGVmbGF0ZQ0KQWNjZXB0LUxhbmd1YWdlOiBlbi1VUyxlbjtxPTAuOQ0KQWNjZXB0OiAqLyoNCkNvbm5lY3Rpb246IEtlZXAtQWxpdmUNCkhvc3Q6IGRlbW8uYm9ybGFuZC5jb20NCkNvb2tpZTogSlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFCDQpDb250ZW50LUxlbmd0aDogMTUwDQoNCg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPAllHeaders>
        <HTTPCookies>
          <HTTPHeaderEntity name="JSESSIONID" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="UserSessionFilter.sessionId" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
        </HTTPCookies>
      </HTTPHeaders>
      <HTTPBody>
        <HTTPDataSet>
          <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
            <ActualData>emlwLXNlYXJjaD16aXAtc2VhcmNoJnppcC1zZWFyY2glM0F6aXBjb2RlPTUwODIxMiZ6aXAtc2VhcmNoJTNBc2VhcmNoLXppcGNvZGUueD01MiZ6aXAtc2VhcmNoJTNBc2VhcmNoLXppcGNvZGUueT02JmphdmF4LmZhY2VzLlZpZXdTdGF0ZT1qX2lkNCUzQWpfaWQ1</ActualData>
          </HTTPData>
        </HTTPDataSet>
        <IsExternalData>false</IsExternalData>
      </HTTPBody>
    </HTTPRequest>
    <HTTPResponse>
      <contentLenght>2030</contentLenght>
      <HTTPHeaders>
        <HTTPHeaderEntity name="Cache-Control" index="0">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>bm8tY2FjaGUsbXVzdC1yZXZhbGlkYXRl</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Pragma" index="1">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>bm8tY2FjaGU=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Type" index="2">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>dGV4dC9odG1sO2NoYXJzZXQ9VVRGLTg=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Encoding" index="3">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Z3ppcA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Expires" index="4">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>TW9uLCA4IEF1ZyAyMDAwIDEwOjAwOjAwIEdNVA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Vary" index="5">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>QWNjZXB0LUVuY29kaW5n</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Server" index="6">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>TWljcm9zb2Z0LUlJUy83LjU=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="X-Powered-By" index="7">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>SlNGLzEuMg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="X-Powered-By" index="8">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>QVNQLk5FVA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="X-FRAME-OPTIONS" index="9">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>U0FNRU9SSUdJTg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Date" index="10">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>V2VkLCAyNyBGZWIgMjAxOSAxMToxODo1NyBHTVQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Length" index="11">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>MjAzMA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPAllHeaders>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>SFRUUC8xLjEgMjAwIE9LDQpDYWNoZS1Db250cm9sOiBuby1jYWNoZSxtdXN0LXJldmFsaWRhdGUNClByYWdtYTogbm8tY2FjaGUNCkNvbnRlbnQtVHlwZTogdGV4dC9odG1sO2NoYXJzZXQ9VVRGLTgNCkNvbnRlbnQtRW5jb2Rpbmc6IGd6aXANCkV4cGlyZXM6IE1vbiwgOCBBdWcgMjAwMCAxMDowMDowMCBHTVQNClZhcnk6IEFjY2VwdC1FbmNvZGluZw0KU2VydmVyOiBNaWNyb3NvZnQtSUlTLzcuNQ0KWC1Qb3dlcmVkLUJ5OiBKU0YvMS4yDQpYLVBvd2VyZWQtQnk6IEFTUC5ORVQNClgtRlJBTUUtT1BUSU9OUzogU0FNRU9SSUdJTg0KRGF0ZTogV2VkLCAyNyBGZWIgMjAxOSAxMToxODo1NyBHTVQNCkNvbnRlbnQtTGVuZ3RoOiAyMDMwDQoNCg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPAllHeaders>
      </HTTPHeaders>
      <HTTPBody>
        <HTTPDataSet>
          <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
            <ActualData>PCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBYSFRNTCAxLjAgVHJhbnNpdGlvbmFsLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL1RSL3hodG1sMS9EVEQveGh0bWwxLXRyYW5zaXRpb25hbC5kdGQiID4KPGh0bWwgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPiAgIAogICAgPGhlYWQ+CiAgICAgICAgPHRpdGxlPkluc3VyYW5jZVdlYjogQWdlbnQgTGlzdDwvdGl0bGU+CiAgICAgICAgPG1ldGEgaHR0cC1lcXVpdj0iQ29udGVudC1UeXBlIiBjb250ZW50PSJ0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgiIC8+CiAgICAgICAgPG1ldGEgaHR0cC1lcXVpdj0iQ29udGVudC1MYW5ndWFnZSIgY29udGVudD0iZW4iIC8+CiAgICAgICAgPG1ldGEgaHR0cC1lcXVpdj0icHJhZ21hIiBjb250ZW50PSJuby1jYWNoZSIgLz4KICAgICAgICA8bWV0YSBodHRwLWVxdWl2PSJjYWNoZS1jb250cm9sIiBjb250ZW50PSJuby1jYWNoZSIgLz4gIAogICAgICAgIDxtZXRhIGh0dHAtZXF1aXY9ImV4cGlyZXMiIGNvbnRlbnQ9Ii0xIiAvPgogICAgICAgIDxtZXRhIG5hbWU9ImtleXdvcmRzIiAvPgogICAgICAgIDxtZXRhIG5hbWU9ImRlc2NyaXB0aW9uIiAvPgogICAgICAgIDxsaW5rIHJlbD0ic3R5bGVzaGVldCIgdHlwZT0idGV4dC9jc3MiIGhyZWY9ImV4dC9yZXNvdXJjZXMvY3NzL2V4dC1hbGwuY3NzIiAvPgogICAgICAgIDxsaW5rIHJlbD0ic3R5bGVzaGVldCIgdHlwZT0idGV4dC9jc3MiIGhyZWY9ImNzcy9zdHlsZS5jc3MiIC8+CiAgICAgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIHNyYz0iZXh0L2FkYXB0ZXIvZXh0L2V4dC1iYXNlLWRlYnVnLmpzIj48L3NjcmlwdD4KICAgICAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJleHQvZXh0LWFsbC1kZWJ1Zy5qcyI+PC9zY3JpcHQ+CiAgICAgICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIHNyYz0iamF2YXNjcmlwdC9zZXJpYWxpemVyLmpzIj48L3NjcmlwdD4KICAgICAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJqYXZhc2NyaXB0L21lbnUuanMiPjwvc2NyaXB0PgogICAgICAgIDxzY3JpcHQgdHlwZT0idGV4dC9qYXZhc2NyaXB0IiBzcmM9ImphdmFzY3JpcHQvYWdlbnRUYWJsZS5qcyI+PC9zY3JpcHQ+CiAgICA8L2hlYWQ+CiAgICA8Ym9keT4KICAgICAgICA8ZGl2IGlkPSJjb250YWluZXIiPgogICAgICAgICAgICA8ZGl2IGlkPSJoZWFkZXIiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPgogICAgCiAgICA8ZGl2IGlkPSJoZWFkZXIiPgogICAgICAmbmJzcDsgCiAgICA8L2Rpdj4KICAgIAo8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNsZWFyIj48L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0ibmF2aWdhdGlvbiI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCI+CiAgICAKICAgIDxkaXYgaWQ9Im5hdiI+CiAgICAgIDx1bD4KICAgICAgICA8bGkgaWQ9ImhvbWUiPjxhIGhyZWY9ImluZGV4LmpzZiI+SG9tZTwvYT48L2xpPiAgICAgICAgCiAgICAgICAgPGxpPgo8Zm9ybSBpZD0iTGlua2Zvcm0iIG5hbWU9Ikxpbmtmb3JtIiBtZXRob2Q9InBvc3QiIGFjdGlvbj0iL0luc3VyYW5jZVdlYkV4dEpTL2FnZW50X2xpc3QuanNmIiBlbmN0eXBlPSJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiPgo8aW5wdXQgdHlwZT0iaGlkZGVuIiBuYW1lPSJMaW5rZm9ybSIgdmFsdWU9Ikxpbmtmb3JtIiAvPgoKPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIGxhbmd1YWdlPSJKYXZhc2NyaXB0Ij5mdW5jdGlvbiBkcGYoZikge3ZhciBhZHAgPSBmLmFkcDtpZiAoYWRwICE9IG51bGwpIHtmb3IgKHZhciBpID0gMDtpIDwgYWRwLmxlbmd0aDtpKyspIHtmLnJlbW92ZUNoaWxkKGFkcFtpXSk7fX19O2Z1bmN0aW9uIGFwZihmLCBwdnApIHt2YXIgYWRwID0gbmV3IEFycmF5KCk7Zi5hZHAgPSBhZHA7dmFyIHBzID0gcHZwLnNwbGl0KCcsJyk7Zm9yICh2YXIgaSA9IDAsaWkgPSAwO2kgPCBwcy5sZW5ndGg7aSsrLGlpKyspIHt2YXIgcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7cC50eXBlID0gImhpZGRlbiI7cC5uYW1lID0gcHNbaV07cC52YWx1ZSA9IHBzW2kgKyAxXTtmLmFwcGVuZENoaWxkKHApO2FkcFtpaV0gPSBwO2kgKz0gMTt9fTtmdW5jdGlvbiBqc2ZjbGpzKGYsIHB2cCwgdCkge2FwZihmLCBwdnApO3ZhciBmdCA9IGYudGFyZ2V0O2lmICh0KSB7Zi50YXJnZXQgPSB0O31mLnN1Ym1pdCgpO2YudGFyZ2V0ID0gZnQ7ZHBmKGYpO307PC9zY3JpcHQ+CjxhIGhyZWY9IiMiIG9uY2xpY2s9ImlmKHR5cGVvZiBqc2ZjbGpzID09ICdmdW5jdGlvbicpe2pzZmNsanMoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ0xpbmtmb3JtJyksJ0xpbmtmb3JtOmpfaWQ2LExpbmtmb3JtOmpfaWQ2JywnJyk7fXJldHVybiBmYWxzZSI+QWNjb3VudDwvYT48aW5wdXQgdHlwZT0iaGlkZGVuIiBuYW1lPSJqYXZheC5mYWNlcy5WaWV3U3RhdGUiIGlkPSJqYXZheC5mYWNlcy5WaWV3U3RhdGUiIHZhbHVlPSJqX2lkNDpqX2lkNiIgLz4KPC9mb3JtPjwvbGk+ICAgICAgICAgICAgICAgIAogICAgICAgIDxsaSBpZD0iY29udGFjdCI+PGEgaHJlZj0iY29udGFjdC5qc2YiPkNvbnRhY3QgVXM8L2E+PC9saT4KICAgICAgPC91bD4KICAgIDwvZGl2PgogICAgCiAgICA8ZGl2IGlkPSJxdWlja2xpbmsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPgo8Zm9ybSBpZD0icXVpY2stbGluayIgbmFtZT0icXVpY2stbGluayIgbWV0aG9kPSJwb3N0IiBhY3Rpb249Ii9JbnN1cmFuY2VXZWJFeHRKUy9hZ2VudF9saXN0LmpzZiIgZW5jdHlwZT0iYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIj4KPGlucHV0IHR5cGU9ImhpZGRlbiIgbmFtZT0icXVpY2stbGluayIgdmFsdWU9InF1aWNrLWxpbmsiIC8+CjxzZWxlY3QgaWQ9InF1aWNrLWxpbms6anVtcC1tZW51IiBuYW1lPSJxdWljay1saW5rOmp1bXAtbWVudSIgc2l6ZT0iMSIgb25jaGFuZ2U9Ik1NX2p1bXBNZW51KCdwYXJlbnQnLHRoaXMsMCkiPgk8b3B0aW9uIHZhbHVlPSIjIj5DaG9vc2UgT25lPC9vcHRpb24+Cgk8b3B0aW9uIHZhbHVlPSJxdW90ZV9hdXRvLmpzZiI+QXV0byBRdW90ZTwvb3B0aW9uPgoJPG9wdGlvbiB2YWx1ZT0iYWdlbnRfbG9va3VwLmpzZiI+QWdlbnQgTG9va3VwPC9vcHRpb24+Cgk8b3B0aW9uIHZhbHVlPSJhZ2VudF9sb29rdXBfeG1sLmpzZiI+QWdlbnQgTG9va3VwIChYTUwpPC9vcHRpb24+Cgk8b3B0aW9uIHZhbHVlPSJub3RJbXBsWWV0LmpzZiI+VGVybSBMaWZlIFF1b3RlPC9vcHRpb24+Cgk8b3B0aW9uIHZhbHVlPSJub3RJbXBsWWV0LmpzZiI+UXVvdGUgSG9tZW93bmVyczwvb3B0aW9uPgoJPG9wdGlvbiB2YWx1ZT0ibm90SW1wbFlldC5qc2YiPlJldHJpZXZlIFNhdmVkIFF1b3RlPC9vcHRpb24+Cgk8b3B0aW9uIHZhbHVlPSJub3RJbXBsWWV0LmpzZiI+UmVwb3J0IENsYWltPC9vcHRpb24+Cgk8b3B0aW9uIHZhbHVlPSJub3RJbXBsWWV0LmpzZiI+VHJhY2sgQ2xhaW08L29wdGlvbj4KPC9zZWxlY3Q+PGlucHV0IHR5cGU9ImhpZGRlbiIgbmFtZT0iamF2YXguZmFjZXMuVmlld1N0YXRlIiBpZD0iamF2YXguZmFjZXMuVmlld1N0YXRlIiB2YWx1ZT0ial9pZDQ6al9pZDYiIC8+CjwvZm9ybT4gICAgCjwvZGl2PiAgICAgICAgICAgIAogICAgPC9kaXY+CiAgICAKICAgIDxkaXYgY2xhc3M9ImNsZWFyIj48L2Rpdj4KICAgIAogICAgPGRpdiBjbGFzcz0ibGluZSI+PC9kaXY+CiAgICAKICAgIDxkaXYgaWQ9ImxlZnQtbmF2Ij4KICAgIAk8aW1nIHNyYz0iaW1hZ2VzL3RpbGVzVi5wbmciIC8+CiAgICA8L2Rpdj4JCiAgICAKPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGlkPSJjb250ZW50LW1haW4iPgo8Zm9ybSBpZD0iYWdlbnQtbGlzdCIgbmFtZT0iYWdlbnQtbGlzdCIgbWV0aG9kPSJwb3N0IiBhY3Rpb249Ii9JbnN1cmFuY2VXZWJFeHRKUy9hZ2VudF9saXN0LmpzZiIgZW5jdHlwZT0iYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIj4KPGlucHV0IHR5cGU9ImhpZGRlbiIgbmFtZT0iYWdlbnQtbGlzdCIgdmFsdWU9ImFnZW50LWxpc3QiIC8+CiAgICAgICAgCiAgICAgICAgICAgIDxoMT5JbnN1cmFuY2UgQWdlbnQgU2VhcmNoIFJlc3VsdHMgPC9oMT4KICAgICAgICAgICAgPGJyIC8+PHRhYmxlPjx0ciBjbGFzcz0ibWVzc2FnZS1pbmZvIj48dGQ+CUNvdWxkIG5vdCByZXRyaWV2ZSBBZ2VudHMgd2l0aCBnaXZlbiBaaXAgQ29kZSwgaGVyZSBpcyB0aGUgbGlzdCBvZiBhbGwgYXZhaWxhYmxlIEFnZW50cyA8L3RkPjwvdHI+PC90YWJsZT4KICAgICAgICAgICAgPGRpdiBpZD0iYWdlbnRUYWJsZURJViI+PC9kaXY+PGlucHV0IHR5cGU9ImhpZGRlbiIgbmFtZT0iamF2YXguZmFjZXMuVmlld1N0YXRlIiBpZD0iamF2YXguZmFjZXMuVmlld1N0YXRlIiB2YWx1ZT0ial9pZDQ6al9pZDYiIC8+CjwvZm9ybT4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNsZWFyIj48L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0iZm9vdGVyIj48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIj4KICAgIAogICAgPGRpdiBjbGFzcz0iY29sdW1uLWxlZnQiPgogICAgICAgIFRoaXMgc2l0ZSBpcyBhIGZpY3RpdGlvdXMgcmVwcmVzZW50YXRpb248YnIgLz4KICAgICAgICBvZiBhbiBvbmxpbmUgY29tcGFueSBmb3IgdGhlIHB1cnBvc2Ugb2YgZGVtb25zdHJhdGluZyBCb3JsYW5kIFNvbHV0aW9ucwogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJjb2x1bW4tcmlnaHQiPgogICAgICAgIDxhIGhyZWY9ImluZGV4LmpzZiI+SG9tZTwvYT4gLSAgICAgICAgCiAgICAgICAgPGEgaHJlZj0id2Vic2VydmljZXMuanNmIj5XZWJzZXJ2aWNlPC9hPiAtCiAgICAgICAgPCEtLSA8YSBocmVmPSJzZXR0aW5ncy5qc2YiPlNldHRpbmdzPC9hPiAtIC0tPgogICAgICAgIDxhIGhyZWY9ImNvbnRhY3QuanNmIj5Db250YWN0IFVzPC9hPgogICAgPC9kaXY+CiAgICAKPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PiAKICAgIDwvYm9keT4KPC9odG1sPg==</ActualData>
          </HTTPData>
        </HTTPDataSet>
        <IsExternalData>false</IsExternalData>
      </HTTPBody>
    </HTTPResponse>
    <HTTPTask id="20" hostname="demo.borland.com" path="/InsuranceWebExtJS/ext/resources/css/ext-all.css" url="http://demo.borland.com/InsuranceWebExtJS/ext/resources/css/ext-all.css" ip="143.186.120.171" port="80" client_ip="192.168.0.123" client_port="15234" connectionId="1784" origin="HTML" encodingType="ANSI" ordinal="1" startDateTime="2019-02-27T16:49:29.185+05:30" startTime="3826" endTime="4057" blockedTime="0" dnsTime="0" connectTime="0" sendTime="0" waitTime="0" receiveTime="0" sslNegotiateTime="0" responseBodySize="0">
      <HTTPRequest method="GET">
        <HTTPHeaders>
          <HTTPHeaderEntity name="Referer" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>aHR0cDovL2RlbW8uYm9ybGFuZC5jb20vSW5zdXJhbmNlV2ViRXh0SlMvYWdlbnRfbG9va3VwLmpzZg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="User-Agent" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzcyLjAuMzYyNi4xMTkgU2FmYXJpLzUzNy4zNg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Encoding" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Z3ppcCwgZGVmbGF0ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Language" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZW4tVVMsZW47cT0wLjk=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ki8q</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Connection" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>S2VlcC1BbGl2ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Host" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZGVtby5ib3JsYW5kLmNvbQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Cookie" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFC</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>R0VUIC9JbnN1cmFuY2VXZWJFeHRKUy9leHQvcmVzb3VyY2VzL2Nzcy9leHQtYWxsLmNzcyBIVFRQLzEuMQ0KUmVmZXJlcjogaHR0cDovL2RlbW8uYm9ybGFuZC5jb20vSW5zdXJhbmNlV2ViRXh0SlMvYWdlbnRfbG9va3VwLmpzZg0KVXNlci1BZ2VudDogTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzcyLjAuMzYyNi4xMTkgU2FmYXJpLzUzNy4zNg0KQWNjZXB0LUVuY29kaW5nOiBnemlwLCBkZWZsYXRlDQpBY2NlcHQtTGFuZ3VhZ2U6IGVuLVVTLGVuO3E9MC45DQpBY2NlcHQ6ICovKg0KQ29ubmVjdGlvbjogS2VlcC1BbGl2ZQ0KSG9zdDogZGVtby5ib3JsYW5kLmNvbQ0KQ29va2llOiBKU0VTU0lPTklEPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFCOyBVc2VyU2Vzc2lvbkZpbHRlci5zZXNzaW9uSWQ9RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUINCg0K</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
          <HTTPCookies>
            <HTTPHeaderEntity name="JSESSIONID" index="0">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
            <HTTPHeaderEntity name="UserSessionFilter.sessionId" index="1">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
          </HTTPCookies>
        </HTTPHeaders>
      </HTTPRequest>
      <HTTPResponse>
        <contentLenght>31656</contentLenght>
        <HTTPHeaders>
          <HTTPHeaderEntity name="Content-Type" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>dGV4dC9jc3M=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Content-Encoding" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Z3ppcA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Last-Modified" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TW9uLCAyMSBKYW4gMjAxMyAxMjozMDo1NCBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Ranges" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ynl0ZXM=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="ETag" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Vy8iMTM5NTkxLTEzNTg3NzE0NTQwMDAi</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Vary" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>QWNjZXB0LUVuY29kaW5n</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Server" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TWljcm9zb2Z0LUlJUy83LjU=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-Powered-By" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>QVNQLk5FVA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-FRAME-OPTIONS" index="8">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>U0FNRU9SSUdJTg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Date" index="9">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>V2VkLCAyNyBGZWIgMjAxOSAxMToxODo1NyBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Content-Length" index="10">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>MzE2NTY=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LVR5cGU6IHRleHQvY3NzDQpDb250ZW50LUVuY29kaW5nOiBnemlwDQpMYXN0LU1vZGlmaWVkOiBNb24sIDIxIEphbiAyMDEzIDEyOjMwOjU0IEdNVA0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkVUYWc6IFcvIjEzOTU5MS0xMzU4NzcxNDU0MDAwIg0KVmFyeTogQWNjZXB0LUVuY29kaW5nDQpTZXJ2ZXI6IE1pY3Jvc29mdC1JSVMvNy41DQpYLVBvd2VyZWQtQnk6IEFTUC5ORVQNClgtRlJBTUUtT1BUSU9OUzogU0FNRU9SSUdJTg0KRGF0ZTogV2VkLCAyNyBGZWIgMjAxOSAxMToxODo1NyBHTVQNCkNvbnRlbnQtTGVuZ3RoOiAzMTY1Ng0KDQo=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
        </HTTPHeaders>
        <HTTPBody>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>LyohCiAqIEV4dCBKUyBMaWJyYXJ5IDMuNC4wCiAqIENvcHlyaWdodChjKSAyMDA2LTIwMTEgU2VuY2hhIEluYy4KICogbGljZW5zaW5nQHNlbmNoYS5jb20KICogaHR0cDovL3d3dy5zZW5jaGEuY29tL2xpY2Vuc2UKICovCmh0bWwsYm9keSxkaXYsZGwsZHQsZGQsdWwsb2wsbGksaDEsaDIsaDMsaDQsaDUsaDYscHJlLGZvcm0sZmllbGRzZXQsaW5wdXQscCxibG9ja3F1b3RlLHRoLHRke21hcmdpbjowO3BhZGRpbmc6MDt9aW1nLGJvZHksaHRtbHtib3JkZXI6MDt9YWRkcmVzcyxjYXB0aW9uLGNpdGUsY29kZSxkZm4sZW0sc3Ryb25nLHRoLHZhcntmb250LXN0eWxlOm5vcm1hbDtmb250LXdlaWdodDpub3JtYWw7fW9sLHVsIHtsaXN0LXN0eWxlOm5vbmU7fWNhcHRpb24sdGgge3RleHQtYWxpZ246bGVmdDt9aDEsaDIsaDMsaDQsaDUsaDZ7Zm9udC1zaXplOjEwMCU7fXE6YmVmb3JlLHE6YWZ0ZXJ7Y29udGVudDonJzt9CgouZXh0LWZvcmNlZC1ib3JkZXItYm94LCAuZXh0LWZvcmNlZC1ib3JkZXItYm94ICogewogICAgLW1vei1ib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgLW1zLWJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICAtd2Via2l0LWJveC1zaXppbmc6IGJvcmRlci1ib3g7Cn0KLmV4dC1lbC1tYXNrIHsKICAgIHotaW5kZXg6IDEwMDsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDowOwogICAgbGVmdDowOwogICAgLW1vei1vcGFjaXR5OiAwLjU7CiAgICBvcGFjaXR5OiAuNTA7CiAgICBmaWx0ZXI6IGFscGhhKG9wYWNpdHk9NTApOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICB6b29tOiAxOwp9CgouZXh0LWVsLW1hc2stbXNnIHsKICAgIHotaW5kZXg6IDIwMDAxOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOiAwOwogICAgbGVmdDogMDsKICAgIGJvcmRlcjoxcHggc29saWQ7CiAgICBiYWNrZ3JvdW5kOnJlcGVhdC14IDAgLTE2cHg7CiAgICBwYWRkaW5nOjJweDsKfQoKLmV4dC1lbC1tYXNrLW1zZyBkaXYgewogICAgcGFkZGluZzo1cHggMTBweCA1cHggMTBweDsKICAgIGJvcmRlcjoxcHggc29saWQ7CiAgICBjdXJzb3I6d2FpdDsKfQoKLmV4dC1zaGltIHsKICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgdmlzaWJpbGl0eTpoaWRkZW47CiAgICBsZWZ0OjA7CiAgICB0b3A6MDsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoKLmV4dC1pZSAuZXh0LXNoaW0gewogICAgZmlsdGVyOiBhbHBoYShvcGFjaXR5PTApOwp9CgouZXh0LWllNiAuZXh0LXNoaW0gewogICAgbWFyZ2luLWxlZnQ6IDVweDsKICAgIG1hcmdpbi10b3A6IDNweDsKfQoKLngtbWFzay1sb2FkaW5nIGRpdiB7CiAgICBwYWRkaW5nOjVweCAxMHB4IDVweCAyNXB4OwogICAgYmFja2dyb3VuZDpuby1yZXBlYXQgNXB4IDVweDsKICAgIGxpbmUtaGVpZ2h0OjE2cHg7Cn0KCi8qIGNsYXNzIGZvciBoaWRpbmcgZWxlbWVudHMgd2l0aG91dCB1c2luZyBkaXNwbGF5Om5vbmUgKi8KLngtaGlkZGVuLCAueC1oaWRlLW9mZnNldHMgewogICAgcG9zaXRpb246YWJzb2x1dGUgIWltcG9ydGFudDsKICAgIGxlZnQ6LTEwMDAwcHg7CiAgICB0b3A6LTEwMDAwcHg7CiAgICB2aXNpYmlsaXR5OmhpZGRlbjsKfQoKLngtaGlkZS1kaXNwbGF5IHsKICAgIGRpc3BsYXk6bm9uZSAhaW1wb3J0YW50Owp9CgoueC1oaWRlLW5vc2l6ZSwKLngtaGlkZS1ub3NpemUgKiAgICAvKiBFbXVsYXRlIGRpc3BsYXk6bm9uZSBmb3IgY2hpbGRyZW4gKi8KIHsKICAgaGVpZ2h0OjBweCFpbXBvcnRhbnQ7CiAgIHdpZHRoOjBweCFpbXBvcnRhbnQ7CiAgIHZpc2liaWxpdHk6aGlkZGVuIWltcG9ydGFudDsKICAgYm9yZGVyOm5vbmUhaW1wb3J0YW50OwogICB6b29tOjE7Cn0KCi54LWhpZGUtdmlzaWJpbGl0eSB7CiAgICB2aXNpYmlsaXR5OmhpZGRlbiAhaW1wb3J0YW50Owp9CgoueC1tYXNrZWQgewogICAgb3ZlcmZsb3c6IGhpZGRlbiAhaW1wb3J0YW50Owp9Ci54LW1hc2tlZC1yZWxhdGl2ZSB7CiAgICBwb3NpdGlvbjogcmVsYXRpdmUgIWltcG9ydGFudDsKfQoKLngtbWFza2VkIHNlbGVjdCwgLngtbWFza2VkIG9iamVjdCwgLngtbWFza2VkIGVtYmVkIHsKICAgIHZpc2liaWxpdHk6IGhpZGRlbjsKfQoKLngtbGF5ZXIgewogICAgdmlzaWJpbGl0eTogaGlkZGVuOwp9CgoueC11bnNlbGVjdGFibGUsIC54LXVuc2VsZWN0YWJsZSAqIHsKICAgIC1tb3otdXNlci1zZWxlY3Q6IG5vbmU7CiAgICAta2h0bWwtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICAtd2Via2l0LXVzZXItc2VsZWN0Omlnbm9yZTsKfQoKLngtcmVwYWludCB7CiAgICB6b29tOiAxOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICAtbW96LW91dGxpbmU6IG5vbmU7CiAgICBvdXRsaW5lOiBub25lOwp9CgoueC1pdGVtLWRpc2FibGVkIHsKICAgIGN1cnNvcjogZGVmYXVsdDsKICAgIG9wYWNpdHk6IC42OwogICAgLW1vei1vcGFjaXR5OiAuNjsKICAgIGZpbHRlcjogYWxwaGEob3BhY2l0eT02MCk7Cn0KCi54LWl0ZW0tZGlzYWJsZWQgKiB7CiAgICBjdXJzb3I6IGRlZmF1bHQgIWltcG9ydGFudDsKfQoKLngtZm9ybS1yYWRpby1ncm91cCAueC1pdGVtLWRpc2FibGVkIHsKICAgIGZpbHRlcjogbm9uZTsKfQoKLngtc3BsaXRiYXItcHJveHkgewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdmlzaWJpbGl0eTogaGlkZGVuOwogICAgei1pbmRleDogMjAwMDE7CiAgICB6b29tOiAxOwogICAgbGluZS1oZWlnaHQ6IDFweDsKICAgIGZvbnQtc2l6ZTogMXB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLngtc3BsaXRiYXItaCwgLngtc3BsaXRiYXItcHJveHktaCB7CiAgICBjdXJzb3I6IGUtcmVzaXplOwogICAgY3Vyc29yOiBjb2wtcmVzaXplOwp9CgoueC1zcGxpdGJhci12LCAueC1zcGxpdGJhci1wcm94eS12IHsKICAgIGN1cnNvcjogcy1yZXNpemU7CiAgICBjdXJzb3I6IHJvdy1yZXNpemU7Cn0KCi54LWNvbG9yLXBhbGV0dGUgewogICAgd2lkdGg6IDE1MHB4OwogICAgaGVpZ2h0OiA5MnB4OwogICAgY3Vyc29yOiBwb2ludGVyOwp9CgoueC1jb2xvci1wYWxldHRlIGEgewogICAgYm9yZGVyOiAxcHggc29saWQ7CiAgICBmbG9hdDogbGVmdDsKICAgIHBhZGRpbmc6IDJweDsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKICAgIC1tb3otb3V0bGluZTogMCBub25lOwogICAgb3V0bGluZTogMCBub25lOwogICAgY3Vyc29yOiBwb2ludGVyOwp9CgoueC1jb2xvci1wYWxldHRlIGE6aG92ZXIsIC54LWNvbG9yLXBhbGV0dGUgYS54LWNvbG9yLXBhbGV0dGUtc2VsIHsKICAgIGJvcmRlcjogMXB4IHNvbGlkOwp9CgoueC1jb2xvci1wYWxldHRlIGVtIHsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgYm9yZGVyOiAxcHggc29saWQ7Cn0KCi54LWNvbG9yLXBhbGV0dGUgZW0gc3BhbiB7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGhlaWdodDogMTBweDsKICAgIGxpbmUtaGVpZ2h0OiAxMHB4OwogICAgd2lkdGg6IDEwcHg7Cn0KCi54LWllLXNoYWRvdyB7CiAgICBkaXNwbGF5OiBub25lOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIGxlZnQ6MDsKICAgIHRvcDowOwogICAgem9vbToxOwp9CgoueC1zaGFkb3cgewogICAgZGlzcGxheTogbm9uZTsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICBsZWZ0OjA7CiAgICB0b3A6MDsKfQoKLngtc2hhZG93ICogewogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLngtc2hhZG93ICogewogICAgcGFkZGluZzogMDsKICAgIGJvcmRlcjogMDsKICAgIG1hcmdpbjogMDsKICAgIGNsZWFyOiBub25lOwogICAgem9vbTogMTsKfQoKLyogdG9wICBib3R0b20gKi8KLngtc2hhZG93IC54c3RjLCAueC1zaGFkb3cgLnhzYmMgewogICAgaGVpZ2h0OiA2cHg7CiAgICBmbG9hdDogbGVmdDsKfQoKLyogY29ybmVycyAqLwoueC1zaGFkb3cgLnhzdGwsIC54LXNoYWRvdyAueHN0ciwgLngtc2hhZG93IC54c2JsLCAueC1zaGFkb3cgLnhzYnIgewogICAgd2lkdGg6IDZweDsKICAgIGhlaWdodDogNnB4OwogICAgZmxvYXQ6IGxlZnQ7Cn0KCi8qIHNpZGVzICovCi54LXNoYWRvdyAueHNjIHsKICAgIHdpZHRoOiAxMDAlOwp9CgoueC1zaGFkb3cgLnhzbWwsIC54LXNoYWRvdyAueHNtciB7CiAgICB3aWR0aDogNnB4OwogICAgZmxvYXQ6IGxlZnQ7CiAgICBoZWlnaHQ6IDEwMCU7Cn0KCi54LXNoYWRvdyAueHNtYyB7CiAgICBmbG9hdDogbGVmdDsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50Owp9CgoueC1zaGFkb3cgLnhzdCwgLngtc2hhZG93IC54c2IgewogICAgaGVpZ2h0OiA2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgd2lkdGg6IDEwMCU7Cn0KCi54LXNoYWRvdyAueHNtbCB7CiAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCByZXBlYXQteSAwIDA7Cn0KCi54LXNoYWRvdyAueHNtciB7CiAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCByZXBlYXQteSAtNnB4IDA7Cn0KCi54LXNoYWRvdyAueHN0bCB7CiAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgMCAwOwp9CgoueC1zaGFkb3cgLnhzdGMgewogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgcmVwZWF0LXggMCAtMzBweDsKfQoKLngtc2hhZG93IC54c3RyIHsKICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC14IDAgLTE4cHg7Cn0KCi54LXNoYWRvdyAueHNibCB7CiAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgMCAtMTJweDsKfQoKLngtc2hhZG93IC54c2JjIHsKICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC14IDAgLTM2cHg7Cn0KCi54LXNoYWRvdyAueHNiciB7CiAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCByZXBlYXQteCAwIC02cHg7Cn0KCi5sb2FkaW5nLWluZGljYXRvciB7CiAgICBiYWNrZ3JvdW5kOiBuby1yZXBlYXQgbGVmdDsKICAgIHBhZGRpbmctbGVmdDogMjBweDsKICAgIGxpbmUtaGVpZ2h0OiAxNnB4OwogICAgbWFyZ2luOiAzcHg7Cn0KCi54LXRleHQtcmVzaXplIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIGxlZnQ6IC0xMDAwcHg7CiAgICB0b3A6IC0xMDAwcHg7CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47CiAgICB6b29tOiAxOwp9CgoueC1kcmFnLW92ZXJsYXkgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBkaXNwbGF5OiBub25lOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgbGVmdDogMDsKICAgIHRvcDogMDsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3MuZ2lmKTsKICAgIHotaW5kZXg6IDIwMDAwOwp9CgoueC1jbGVhciB7CiAgICBjbGVhcjpib3RoOwogICAgaGVpZ2h0OjA7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICBsaW5lLWhlaWdodDowOwogICAgZm9udC1zaXplOjA7Cn0KCi54LXNwb3RsaWdodCB7CiAgICB6LWluZGV4OiA4OTk5OwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdG9wOjA7CiAgICBsZWZ0OjA7CiAgICAtbW96LW9wYWNpdHk6IDAuNTsKICAgIG9wYWNpdHk6IC41MDsKICAgIGZpbHRlcjogYWxwaGEob3BhY2l0eT01MCk7CiAgICB3aWR0aDowOwogICAgaGVpZ2h0OjA7CiAgICB6b29tOiAxOwp9CgojeC1oaXN0b3J5LWZyYW1lIHsKICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgdG9wOi0xcHg7CiAgICBsZWZ0OjA7Cgl3aWR0aDoxcHg7CiAgICBoZWlnaHQ6MXB4OwogICAgdmlzaWJpbGl0eTpoaWRkZW47Cn0KCiN4LWhpc3RvcnktZmllbGQgewogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICB0b3A6MDsKICAgIGxlZnQ6LTFweDsKCXdpZHRoOjFweDsKICAgIGhlaWdodDoxcHg7CiAgICB2aXNpYmlsaXR5OmhpZGRlbjsKfQoueC1yZXNpemFibGUtaGFuZGxlIHsKICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgei1pbmRleDoxMDA7CiAgICAvKiBpZSBuZWVkcyB0aGVzZSAqLwogICAgZm9udC1zaXplOjFweDsKICAgIGxpbmUtaGVpZ2h0OjZweDsKICAgIG92ZXJmbG93OmhpZGRlbjsKCWZpbHRlcjphbHBoYShvcGFjaXR5PTApOwoJb3BhY2l0eTowOwoJem9vbToxOwp9CgoueC1yZXNpemFibGUtaGFuZGxlLWVhc3R7CiAgICB3aWR0aDo2cHg7CiAgICBjdXJzb3I6ZS1yZXNpemU7CiAgICByaWdodDowOwogICAgdG9wOjA7CiAgICBoZWlnaHQ6MTAwJTsKfQoKLmV4dC1pZSAueC1yZXNpemFibGUtaGFuZGxlLWVhc3QgewogICAgbWFyZ2luLXJpZ2h0Oi0xcHg7IC8qSUUgcm91bmRpbmcgZXJyb3IqLwp9CgoueC1yZXNpemFibGUtaGFuZGxlLXNvdXRoewogICAgd2lkdGg6MTAwJTsKICAgIGN1cnNvcjpzLXJlc2l6ZTsKICAgIGxlZnQ6MDsKICAgIGJvdHRvbTowOwogICAgaGVpZ2h0OjZweDsKfQoKLmV4dC1pZSAueC1yZXNpemFibGUtaGFuZGxlLXNvdXRoIHsKICAgIG1hcmdpbi1ib3R0b206LTFweDsgLypJRSByb3VuZGluZyBlcnJvciovCn0KCi54LXJlc2l6YWJsZS1oYW5kbGUtd2VzdHsKICAgIHdpZHRoOjZweDsKICAgIGN1cnNvcjp3LXJlc2l6ZTsKICAgIGxlZnQ6MDsKICAgIHRvcDowOwogICAgaGVpZ2h0OjEwMCU7Cn0KCi54LXJlc2l6YWJsZS1oYW5kbGUtbm9ydGh7CiAgICB3aWR0aDoxMDAlOwogICAgY3Vyc29yOm4tcmVzaXplOwogICAgbGVmdDowOwogICAgdG9wOjA7CiAgICBoZWlnaHQ6NnB4Owp9CgoueC1yZXNpemFibGUtaGFuZGxlLXNvdXRoZWFzdHsKICAgIHdpZHRoOjZweDsKICAgIGN1cnNvcjpzZS1yZXNpemU7CiAgICByaWdodDowOwogICAgYm90dG9tOjA7CiAgICBoZWlnaHQ6NnB4OwogICAgei1pbmRleDoxMDE7Cn0KCi54LXJlc2l6YWJsZS1oYW5kbGUtbm9ydGh3ZXN0ewogICAgd2lkdGg6NnB4OwogICAgY3Vyc29yOm53LXJlc2l6ZTsKICAgIGxlZnQ6MDsKICAgIHRvcDowOwogICAgaGVpZ2h0OjZweDsKICAgIHotaW5kZXg6MTAxOwp9CgoueC1yZXNpemFibGUtaGFuZGxlLW5vcnRoZWFzdHsKICAgIHdpZHRoOjZweDsKICAgIGN1cnNvcjpuZS1yZXNpemU7CiAgICByaWdodDowOwogICAgdG9wOjA7CiAgICBoZWlnaHQ6NnB4OwogICAgei1pbmRleDoxMDE7Cn0KCi54LXJlc2l6YWJsZS1oYW5kbGUtc291dGh3ZXN0ewogICAgd2lkdGg6NnB4OwogICAgY3Vyc29yOnN3LXJlc2l6ZTsKICAgIGxlZnQ6MDsKICAgIGJvdHRvbTowOwogICAgaGVpZ2h0OjZweDsKICAgIHotaW5kZXg6MTAxOwp9CgoueC1yZXNpemFibGUtb3ZlciAueC1yZXNpemFibGUtaGFuZGxlLCAueC1yZXNpemFibGUtcGlubmVkIC54LXJlc2l6YWJsZS1oYW5kbGV7CiAgICBmaWx0ZXI6YWxwaGEob3BhY2l0eT0xMDApOwoJb3BhY2l0eToxOwp9CgoueC1yZXNpemFibGUtb3ZlciAueC1yZXNpemFibGUtaGFuZGxlLWVhc3QsIC54LXJlc2l6YWJsZS1waW5uZWQgLngtcmVzaXphYmxlLWhhbmRsZS1lYXN0LAoueC1yZXNpemFibGUtb3ZlciAueC1yZXNpemFibGUtaGFuZGxlLXdlc3QsIC54LXJlc2l6YWJsZS1waW5uZWQgLngtcmVzaXphYmxlLWhhbmRsZS13ZXN0CnsKCWJhY2tncm91bmQtcG9zaXRpb246IGxlZnQ7Cn0KCi54LXJlc2l6YWJsZS1vdmVyIC54LXJlc2l6YWJsZS1oYW5kbGUtc291dGgsIC54LXJlc2l6YWJsZS1waW5uZWQgLngtcmVzaXphYmxlLWhhbmRsZS1zb3V0aCwKLngtcmVzaXphYmxlLW92ZXIgLngtcmVzaXphYmxlLWhhbmRsZS1ub3J0aCwgLngtcmVzaXphYmxlLXBpbm5lZCAueC1yZXNpemFibGUtaGFuZGxlLW5vcnRoCnsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IHRvcDsKfQoKLngtcmVzaXphYmxlLW92ZXIgLngtcmVzaXphYmxlLWhhbmRsZS1zb3V0aGVhc3QsIC54LXJlc2l6YWJsZS1waW5uZWQgLngtcmVzaXphYmxlLWhhbmRsZS1zb3V0aGVhc3R7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiB0b3AgbGVmdDsKfQoKLngtcmVzaXphYmxlLW92ZXIgLngtcmVzaXphYmxlLWhhbmRsZS1ub3J0aHdlc3QsIC54LXJlc2l6YWJsZS1waW5uZWQgLngtcmVzaXphYmxlLWhhbmRsZS1ub3J0aHdlc3R7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOmJvdHRvbSByaWdodDsKfQoKLngtcmVzaXphYmxlLW92ZXIgLngtcmVzaXphYmxlLWhhbmRsZS1ub3J0aGVhc3QsIC54LXJlc2l6YWJsZS1waW5uZWQgLngtcmVzaXphYmxlLWhhbmRsZS1ub3J0aGVhc3R7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiBib3R0b20gbGVmdDsKfQoKLngtcmVzaXphYmxlLW92ZXIgLngtcmVzaXphYmxlLWhhbmRsZS1zb3V0aHdlc3QsIC54LXJlc2l6YWJsZS1waW5uZWQgLngtcmVzaXphYmxlLWhhbmRsZS1zb3V0aHdlc3R7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiB0b3AgcmlnaHQ7Cn0KCi54LXJlc2l6YWJsZS1wcm94eXsKICAgIGJvcmRlcjogMXB4IGRhc2hlZDsKICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgZGlzcGxheTpub25lOwoJbGVmdDowOwogICAgdG9wOjA7CiAgICB6LWluZGV4OjUwMDAwOwp9CgoueC1yZXNpemFibGUtb3ZlcmxheXsKICAgIHdpZHRoOjEwMCU7CgloZWlnaHQ6MTAwJTsKCWRpc3BsYXk6bm9uZTsKCXBvc2l0aW9uOmFic29sdXRlOwoJbGVmdDowOwoJdG9wOjA7Cgl6LWluZGV4OjIwMDAwMDsKCS1tb3otb3BhY2l0eTogMDsKICAgIG9wYWNpdHk6MDsKICAgIGZpbHRlcjogYWxwaGEob3BhY2l0eT0wKTsKfQoueC10YWItcGFuZWwgewogICAgb3ZlcmZsb3c6aGlkZGVuOwp9CgoueC10YWItcGFuZWwtaGVhZGVyLCAueC10YWItcGFuZWwtZm9vdGVyIHsKCWJvcmRlcjogMXB4IHNvbGlkOwogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgem9vbToxOwp9CgoueC10YWItcGFuZWwtaGVhZGVyIHsKCWJvcmRlcjogMXB4IHNvbGlkOwoJcGFkZGluZy1ib3R0b206IDJweDsKfQoKLngtdGFiLXBhbmVsLWZvb3RlciB7Cglib3JkZXI6IDFweCBzb2xpZDsKCXBhZGRpbmctdG9wOiAycHg7Cn0KCi54LXRhYi1zdHJpcC13cmFwIHsKCXdpZHRoOjEwMCU7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgIHpvb206MTsKfQoKdWwueC10YWItc3RyaXAgewoJZGlzcGxheTpibG9jazsKICAgIHdpZHRoOjUwMDBweDsKICAgIHpvb206MTsKfQoKdWwueC10YWItc3RyaXAtdG9wewoJcGFkZGluZy10b3A6IDFweDsKCWJhY2tncm91bmQ6IHJlcGVhdC14IGJvdHRvbTsKCWJvcmRlci1ib3R0b206IDFweCBzb2xpZDsKfQoKdWwueC10YWItc3RyaXAtYm90dG9tewoJcGFkZGluZy1ib3R0b206IDFweDsKCWJhY2tncm91bmQ6IHJlcGVhdC14IHRvcDsKCWJvcmRlci10b3A6IDFweCBzb2xpZDsKCWJvcmRlci1ib3R0b206IDAgbm9uZTsKfQoKLngtdGFiLXBhbmVsLWhlYWRlci1wbGFpbiAueC10YWItc3RyaXAtdG9wIHsKICAgIGJhY2tncm91bmQ6dHJhbnNwYXJlbnQgIWltcG9ydGFudDsKICAgIHBhZGRpbmctdG9wOjAgIWltcG9ydGFudDsKfQoKLngtdGFiLXBhbmVsLWhlYWRlci1wbGFpbiB7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50ICFpbXBvcnRhbnQ7CiAgICBib3JkZXItd2lkdGg6MCAhaW1wb3J0YW50OwogICAgcGFkZGluZy1ib3R0b206MCAhaW1wb3J0YW50Owp9CgoueC10YWItcGFuZWwtaGVhZGVyLXBsYWluIC54LXRhYi1zdHJpcC1zcGFjZXIsCi54LXRhYi1wYW5lbC1mb290ZXItcGxhaW4gLngtdGFiLXN0cmlwLXNwYWNlciB7CiAgICBib3JkZXI6MXB4IHNvbGlkOwogICAgaGVpZ2h0OjJweDsKICAgIGZvbnQtc2l6ZToxcHg7CiAgICBsaW5lLWhlaWdodDoxcHg7Cn0KCi54LXRhYi1wYW5lbC1oZWFkZXItcGxhaW4gLngtdGFiLXN0cmlwLXNwYWNlciB7CiAgICBib3JkZXItdG9wOiAwIG5vbmU7Cn0KCi54LXRhYi1wYW5lbC1mb290ZXItcGxhaW4gLngtdGFiLXN0cmlwLXNwYWNlciB7CiAgICBib3JkZXItYm90dG9tOiAwIG5vbmU7Cn0KCi54LXRhYi1wYW5lbC1mb290ZXItcGxhaW4gLngtdGFiLXN0cmlwLWJvdHRvbSB7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50ICFpbXBvcnRhbnQ7CiAgICBwYWRkaW5nLWJvdHRvbTowICFpbXBvcnRhbnQ7Cn0KCi54LXRhYi1wYW5lbC1mb290ZXItcGxhaW4gewogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCAhaW1wb3J0YW50OwogICAgYm9yZGVyLXdpZHRoOjAgIWltcG9ydGFudDsKICAgIHBhZGRpbmctdG9wOjAgIWltcG9ydGFudDsKfQoKLmV4dC1ib3JkZXItYm94IC54LXRhYi1wYW5lbC1oZWFkZXItcGxhaW4gLngtdGFiLXN0cmlwLXNwYWNlciwKLmV4dC1ib3JkZXItYm94IC54LXRhYi1wYW5lbC1mb290ZXItcGxhaW4gLngtdGFiLXN0cmlwLXNwYWNlciB7CiAgICBoZWlnaHQ6M3B4Owp9Cgp1bC54LXRhYi1zdHJpcCBsaSB7CiAgICBmbG9hdDpsZWZ0OwogICAgbWFyZ2luLWxlZnQ6MnB4Owp9Cgp1bC54LXRhYi1zdHJpcCBsaS54LXRhYi1lZGdlIHsKICAgIGZsb2F0OmxlZnQ7CiAgICBtYXJnaW46MCAhaW1wb3J0YW50OwogICAgcGFkZGluZzowICFpbXBvcnRhbnQ7CiAgICBib3JkZXI6MCBub25lICFpbXBvcnRhbnQ7CiAgICBmb250LXNpemU6MXB4ICFpbXBvcnRhbnQ7CiAgICBsaW5lLWhlaWdodDoxcHggIWltcG9ydGFudDsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKICAgIGJhY2tncm91bmQ6dHJhbnNwYXJlbnQgIWltcG9ydGFudDsKICAgIHdpZHRoOjFweDsKfQoKLngtdGFiLXN0cmlwIGEsIC54LXRhYi1zdHJpcCBzcGFuLCAueC10YWItc3RyaXAgZW0gewoJZGlzcGxheTpibG9jazsKfQoKLngtdGFiLXN0cmlwIGEgewoJdGV4dC1kZWNvcmF0aW9uOm5vbmUgIWltcG9ydGFudDsKCS1tb3otb3V0bGluZTogbm9uZTsKCW91dGxpbmU6IG5vbmU7CgljdXJzb3I6cG9pbnRlcjsKfQoKLngtdGFiLXN0cmlwLWlubmVyIHsKICAgIG92ZXJmbG93OmhpZGRlbjsKCXRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwp9CgoueC10YWItc3RyaXAgc3Bhbi54LXRhYi1zdHJpcC10ZXh0IHsKCXdoaXRlLXNwYWNlOiBub3dyYXA7CgljdXJzb3I6cG9pbnRlcjsKICAgIHBhZGRpbmc6NHB4IDA7Cn0KCi54LXRhYi1zdHJpcC10b3AgLngtdGFiLXdpdGgtaWNvbiAueC10YWItcmlnaHQgewogICAgcGFkZGluZy1sZWZ0OjZweDsKfQoKLngtdGFiLXN0cmlwIC54LXRhYi13aXRoLWljb24gc3Bhbi54LXRhYi1zdHJpcC10ZXh0IHsKCXBhZGRpbmctbGVmdDoyMHB4OwogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogMCAzcHg7CiAgICBiYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0Owp9CgoueC10YWItc3RyaXAtYWN0aXZlLCAueC10YWItc3RyaXAtYWN0aXZlIGEueC10YWItcmlnaHQgewogICAgY3Vyc29yOmRlZmF1bHQ7Cn0KCi54LXRhYi1zdHJpcC1hY3RpdmUgc3Bhbi54LXRhYi1zdHJpcC10ZXh0IHsKCWN1cnNvcjpkZWZhdWx0Owp9CgoueC10YWItc3RyaXAtZGlzYWJsZWQgLngtdGFicy10ZXh0IHsKCWN1cnNvcjpkZWZhdWx0Owp9CgoueC10YWItcGFuZWwtYm9keSB7CiAgICBvdmVyZmxvdzpoaWRkZW47Cn0KCi54LXRhYi1wYW5lbC1id3JhcCB7CiAgICBvdmVyZmxvdzpoaWRkZW47Cn0KCi5leHQtaWUgLngtdGFiLXN0cmlwIC54LXRhYi1yaWdodCB7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKfQoKLngtdGFiLXN0cmlwLXRvcCAueC10YWItc3RyaXAtYWN0aXZlIC54LXRhYi1yaWdodCB7CiAgICBtYXJnaW4tYm90dG9tOi0xcHg7Cn0KCi8qCiAqIEhvcnJpYmxlIGhhY2sgZm9yIElFOCBpbiBxdWlya3MgbW9kZQogKi8KLmV4dC1pZTggLngtdGFiLXN0cmlwIGxpIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQouZXh0LWJvcmRlci1ib3ggLmV4dC1pZTggLngtdGFiLXN0cmlwLXRvcCAueC10YWItcmlnaHQgewogICAgdG9wOiAxcHg7Cn0KLmV4dC1pZTggLngtdGFiLXN0cmlwLXRvcCB7CiAgICBwYWRkaW5nLXRvcDogMTsKfQouZXh0LWJvcmRlci1ib3ggLmV4dC1pZTggLngtdGFiLXN0cmlwLXRvcCB7CiAgICBwYWRkaW5nLXRvcDogMDsKfQouZXh0LWllOCAueC10YWItc3RyaXAgLngtdGFiLXN0cmlwLWNsb3NhYmxlIGEueC10YWItc3RyaXAtY2xvc2UgewogICAgdG9wOjNweDsKfQouZXh0LWJvcmRlci1ib3ggLmV4dC1pZTggLngtdGFiLXN0cmlwIC54LXRhYi1zdHJpcC1jbG9zYWJsZSBhLngtdGFiLXN0cmlwLWNsb3NlIHsKICAgIHRvcDo0cHg7Cn0KLmV4dC1pZTggLngtdGFiLXN0cmlwLWJvdHRvbSAueC10YWItcmlnaHR7CiAgICB0b3A6MDsKfQoKCi54LXRhYi1zdHJpcC10b3AgLngtdGFiLXN0cmlwLWFjdGl2ZSAueC10YWItcmlnaHQgc3Bhbi54LXRhYi1zdHJpcC10ZXh0IHsKICAgIHBhZGRpbmctYm90dG9tOjVweDsKfQoKLngtdGFiLXN0cmlwLWJvdHRvbSAueC10YWItc3RyaXAtYWN0aXZlIC54LXRhYi1yaWdodCB7CiAgICBtYXJnaW4tdG9wOi0xcHg7Cn0KCi54LXRhYi1zdHJpcC1ib3R0b20gLngtdGFiLXN0cmlwLWFjdGl2ZSAueC10YWItcmlnaHQgc3Bhbi54LXRhYi1zdHJpcC10ZXh0IHsKICAgIHBhZGRpbmctdG9wOjVweDsKfQoKLngtdGFiLXN0cmlwLXRvcCAueC10YWItcmlnaHQgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IDAgLTUxcHg7CiAgICBwYWRkaW5nLWxlZnQ6MTBweDsKfQoKLngtdGFiLXN0cmlwLXRvcCAueC10YWItbGVmdCB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgLTM1MXB4OwogICAgcGFkZGluZy1yaWdodDoxMHB4Owp9CgoueC10YWItc3RyaXAtdG9wIC54LXRhYi1zdHJpcC1pbm5lciB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCByZXBlYXQteCAwIC0yMDFweDsKfQoKLngtdGFiLXN0cmlwLXRvcCAueC10YWItc3RyaXAtb3ZlciAueC10YWItcmlnaHQgewoJIGJhY2tncm91bmQtcG9zaXRpb246MCAtMTAxcHg7Cn0KCi54LXRhYi1zdHJpcC10b3AgLngtdGFiLXN0cmlwLW92ZXIgLngtdGFiLWxlZnQgewoJIGJhY2tncm91bmQtcG9zaXRpb246cmlnaHQgLTQwMXB4Owp9CgoueC10YWItc3RyaXAtdG9wIC54LXRhYi1zdHJpcC1vdmVyIC54LXRhYi1zdHJpcC1pbm5lciB7CgkgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0yNTFweDsKfQoKLngtdGFiLXN0cmlwLXRvcCAueC10YWItc3RyaXAtYWN0aXZlIC54LXRhYi1yaWdodCB7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAwIDA7Cn0KCi54LXRhYi1zdHJpcC10b3AgLngtdGFiLXN0cmlwLWFjdGl2ZSAueC10YWItbGVmdCB7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiByaWdodCAtMzAxcHg7Cn0KCi54LXRhYi1zdHJpcC10b3AgLngtdGFiLXN0cmlwLWFjdGl2ZSAueC10YWItc3RyaXAtaW5uZXIgewoJYmFja2dyb3VuZC1wb3NpdGlvbjogMCAtMTUxcHg7Cn0KCi54LXRhYi1zdHJpcC1ib3R0b20gLngtdGFiLXJpZ2h0IHsKCWJhY2tncm91bmQ6IG5vLXJlcGVhdCBib3R0b20gcmlnaHQ7Cn0KCi54LXRhYi1zdHJpcC1ib3R0b20gLngtdGFiLWxlZnQgewoJYmFja2dyb3VuZDogbm8tcmVwZWF0IGJvdHRvbSBsZWZ0Owp9CgoueC10YWItc3RyaXAtYm90dG9tIC54LXRhYi1zdHJpcC1hY3RpdmUgLngtdGFiLXJpZ2h0IHsKCWJhY2tncm91bmQ6IG5vLXJlcGVhdCBib3R0b20gcmlnaHQ7Cn0KCi54LXRhYi1zdHJpcC1ib3R0b20gLngtdGFiLXN0cmlwLWFjdGl2ZSAueC10YWItbGVmdCB7CgliYWNrZ3JvdW5kOiBuby1yZXBlYXQgYm90dG9tIGxlZnQ7Cn0KCi54LXRhYi1zdHJpcC1ib3R0b20gLngtdGFiLWxlZnQgewogICAgbWFyZ2luLXJpZ2h0OiAzcHg7CiAgICBwYWRkaW5nOjAgMTBweDsKfQoKLngtdGFiLXN0cmlwLWJvdHRvbSAueC10YWItcmlnaHQgewogICAgcGFkZGluZzowOwp9CgoueC10YWItc3RyaXAgLngtdGFiLXN0cmlwLWNsb3NlIHsKICAgIGRpc3BsYXk6bm9uZTsKfQoKLngtdGFiLXN0cmlwLWNsb3NhYmxlIHsKICAgIHBvc2l0aW9uOnJlbGF0aXZlOwp9CgoueC10YWItc3RyaXAtY2xvc2FibGUgLngtdGFiLWxlZnQgewogICAgcGFkZGluZy1yaWdodDoxOXB4Owp9CgoueC10YWItc3RyaXAgLngtdGFiLXN0cmlwLWNsb3NhYmxlIGEueC10YWItc3RyaXAtY2xvc2UgewogICAgb3BhY2l0eTouNjsKICAgIC1tb3otb3BhY2l0eTouNjsKICAgIGJhY2tncm91bmQtcmVwZWF0Om5vLXJlcGVhdDsKICAgIGRpc3BsYXk6YmxvY2s7Cgl3aWR0aDoxMXB4OwogICAgaGVpZ2h0OjExcHg7CiAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgIHRvcDozcHg7CiAgICByaWdodDozcHg7CiAgICBjdXJzb3I6cG9pbnRlcjsKICAgIHotaW5kZXg6MjsKfQoKLngtdGFiLXN0cmlwIC54LXRhYi1zdHJpcC1hY3RpdmUgYS54LXRhYi1zdHJpcC1jbG9zZSB7CiAgICBvcGFjaXR5Oi44OwogICAgLW1vei1vcGFjaXR5Oi44Owp9Ci54LXRhYi1zdHJpcCAueC10YWItc3RyaXAtY2xvc2FibGUgYS54LXRhYi1zdHJpcC1jbG9zZTpob3ZlcnsKICAgIG9wYWNpdHk6MTsKICAgIC1tb3otb3BhY2l0eToxOwp9CgoueC10YWItcGFuZWwtYm9keSB7CiAgICBib3JkZXI6IDFweCBzb2xpZDsKfQoKLngtdGFiLXBhbmVsLWJvZHktdG9wIHsKICAgIGJvcmRlci10b3A6IDAgbm9uZTsKfQoKLngtdGFiLXBhbmVsLWJvZHktYm90dG9tIHsKICAgIGJvcmRlci1ib3R0b206IDAgbm9uZTsKfQoKLngtdGFiLXNjcm9sbGVyLWxlZnQgewogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IC0xOHB4IDA7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQ7CiAgICB3aWR0aDoxOHB4OwogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICBsZWZ0OjA7CiAgICB0b3A6MDsKICAgIHotaW5kZXg6MTA7CiAgICBjdXJzb3I6cG9pbnRlcjsKfQoueC10YWItc2Nyb2xsZXItbGVmdC1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IDAgMDsKfQoKLngtdGFiLXNjcm9sbGVyLWxlZnQtZGlzYWJsZWQgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogLTE4cHggMDsKICAgIG9wYWNpdHk6LjU7CiAgICAtbW96LW9wYWNpdHk6LjU7CiAgICBmaWx0ZXI6YWxwaGEob3BhY2l0eT01MCk7CiAgICBjdXJzb3I6ZGVmYXVsdDsKfQoKLngtdGFiLXNjcm9sbGVyLXJpZ2h0IHsKICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIDA7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQ7CiAgICB3aWR0aDoxOHB4OwogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICByaWdodDowOwogICAgdG9wOjA7CiAgICB6LWluZGV4OjEwOwogICAgY3Vyc29yOnBvaW50ZXI7Cn0KCi54LXRhYi1zY3JvbGxlci1yaWdodC1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IC0xOHB4IDA7Cn0KCi54LXRhYi1zY3JvbGxlci1yaWdodC1kaXNhYmxlZCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAwIDA7CiAgICBvcGFjaXR5Oi41OwogICAgLW1vei1vcGFjaXR5Oi41OwogICAgZmlsdGVyOmFscGhhKG9wYWNpdHk9NTApOwogICAgY3Vyc29yOmRlZmF1bHQ7Cn0KCi54LXRhYi1zY3JvbGxpbmctYm90dG9tIC54LXRhYi1zY3JvbGxlci1sZWZ0LCAueC10YWItc2Nyb2xsaW5nLWJvdHRvbSAueC10YWItc2Nyb2xsZXItcmlnaHR7CiAgICBtYXJnaW4tdG9wOiAxcHg7Cn0KCi54LXRhYi1zY3JvbGxpbmcgLngtdGFiLXN0cmlwLXdyYXAgewogICAgbWFyZ2luLWxlZnQ6MThweDsKICAgIG1hcmdpbi1yaWdodDoxOHB4Owp9CgoueC10YWItc2Nyb2xsaW5nIHsKICAgIHBvc2l0aW9uOnJlbGF0aXZlOyAgICAKfQoKLngtdGFiLXBhbmVsLWJiYXIgLngtdG9vbGJhciB7CiAgICBib3JkZXI6MXB4IHNvbGlkOwogICAgYm9yZGVyLXRvcDowIG5vbmU7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICBwYWRkaW5nOjJweDsKfQoKLngtdGFiLXBhbmVsLXRiYXIgLngtdG9vbGJhciB7CiAgICBib3JkZXI6MXB4IHNvbGlkOwogICAgYm9yZGVyLXRvcDowIG5vbmU7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICBwYWRkaW5nOjJweDsKfS8qIGFsbCBmaWVsZHMgKi8KLngtZm9ybS1maWVsZHsKICAgIG1hcmdpbjogMCAwIDAgMDsKfQoKLmV4dC13ZWJraXQgKjpmb2N1c3sKICAgIG91dGxpbmU6IG5vbmUgIWltcG9ydGFudDsKfQoKLyogLS0tLSB0ZXh0IGZpZWxkcyAtLS0tICovCi54LWZvcm0tdGV4dCwgdGV4dGFyZWEueC1mb3JtLWZpZWxkewogICAgcGFkZGluZzoxcHggM3B4OwogICAgYmFja2dyb3VuZDpyZXBlYXQteCAwIDA7CiAgICBib3JkZXI6MXB4IHNvbGlkOwp9Cgp0ZXh0YXJlYS54LWZvcm0tZmllbGQgewogICAgcGFkZGluZzoycHggM3B4Owp9CgoueC1mb3JtLXRleHQsIC5leHQtaWUgLngtZm9ybS1maWxlIHsKICAgIGhlaWdodDoyMnB4OwogICAgbGluZS1oZWlnaHQ6MThweDsKICAgIHZlcnRpY2FsLWFsaWduOm1pZGRsZTsKfQoKLmV4dC1pZTYgLngtZm9ybS10ZXh0LCAuZXh0LWllNyAueC1mb3JtLXRleHQgewogICAgbWFyZ2luOi0xcHggMDsgLyogaWUgYm9ndXMgbWFyZ2luIGJ1ZyAqLwogICAgaGVpZ2h0OjIycHg7IC8qIGllIHF1aXJrcyAqLwogICAgbGluZS1oZWlnaHQ6MThweDsKfQoKLngtcXVpcmtzIC5leHQtaWU5IC54LWZvcm0tdGV4dCB7CiAgICBoZWlnaHQ6IDIycHg7CiAgICBwYWRkaW5nLXRvcDogM3B4OwogICAgcGFkZGluZy1ib3R0b206IDBweDsKfQoKLyogVWdseSBoYWNrcyBmb3IgdGhlIGJvZ3VzIDFweCBtYXJnaW4gYnVnIGluIElFOSBxdWlya3MgKi8KLngtcXVpcmtzIC5leHQtaWU5IC54LWlucHV0LXdyYXBwZXIgLngtZm9ybS10ZXh0LAoueC1xdWlya3MgLmV4dC1pZTkgLngtZm9ybS1maWVsZC10cmlnZ2VyLXdyYXAgLngtZm9ybS10ZXh0IHsKICAgIG1hcmdpbi10b3A6IC0xcHg7CiAgICBtYXJnaW4tYm90dG9tOiAtMXB4Owp9Ci54LXF1aXJrcyAuZXh0LWllOSAueC1pbnB1dC13cmFwcGVyIC54LWZvcm0tZWxlbWVudCB7CiAgICBtYXJnaW4tYm90dG9tOiAtMXB4Owp9CgouZXh0LWllNiAueC1mb3JtLWZpZWxkLXdyYXAgLngtZm9ybS1maWxlLWJ0biwgLmV4dC1pZTcgLngtZm9ybS1maWVsZC13cmFwIC54LWZvcm0tZmlsZS1idG4gewogICAgdG9wOiAtMXB4OyAvKiBiZWNhdXNlIG9mIGFsbCB0aGVzZSBtYXJnaW4gaGFja3MsIHRoZXNlIGJ1dHRvbnMgYXJlIG9mZiBieSBvbmUgcGl4ZWwgaW4gSUU2LDcgKi8KfQoKLmV4dC1pZTYgdGV4dGFyZWEueC1mb3JtLWZpZWxkLCAuZXh0LWllNyB0ZXh0YXJlYS54LWZvcm0tZmllbGQgewogICAgbWFyZ2luOi0xcHggMDsgLyogaWUgYm9ndXMgbWFyZ2luIGJ1ZyAqLwp9CgouZXh0LXN0cmljdCAueC1mb3JtLXRleHQgewogICAgaGVpZ2h0OjE4cHg7Cn0KCi5leHQtc2FmYXJpLmV4dC1tYWMgdGV4dGFyZWEueC1mb3JtLWZpZWxkIHsKICAgIG1hcmdpbi1ib3R0b206LTJweDsgLyogYW5vdGhlciBib2d1cyBtYXJnaW4gYnVnLCBzYWZhcmkvbWFjIG9ubHkgKi8KfQoKLyoKLmV4dC1zdHJpY3QgLmV4dC1pZTggLngtZm9ybS10ZXh0LCAuZXh0LXN0cmljdCAuZXh0LWllOCB0ZXh0YXJlYS54LWZvcm0tZmllbGQgewogICAgbWFyZ2luLWJvdHRvbTogMXB4Owp9CiovCgouZXh0LWdlY2tvIC54LWZvcm0tdGV4dCAsIC5leHQtaWU4IC54LWZvcm0tdGV4dCB7CiAgICBwYWRkaW5nLXRvcDoycHg7IC8qIEZGIHdvbid0IGNlbnRlciB0aGUgdGV4dCB2ZXJ0aWNhbGx5ICovCiAgICBwYWRkaW5nLWJvdHRvbTowOwp9CgouZXh0LWllNiAueC1mb3JtLWNvbXBvc2l0ZSAueC1mb3JtLXRleHQueC1ib3gtaXRlbSwgLmV4dC1pZTcgLngtZm9ybS1jb21wb3NpdGUgLngtZm9ybS10ZXh0LngtYm94LWl0ZW0gewogICAgbWFyZ2luOiAwICFpbXBvcnRhbnQ7IC8qIGNsZWFyIGllIGJvZ3VzIG1hcmdpbiBidWcgZml4ICovCn0KCnRleHRhcmVhIHsKICAgIHJlc2l6ZTogbm9uZTsgIC8qIERpc2FibGUgYnJvd3NlciByZXNpemFibGUgdGV4dGFyZWEgKi8KfQoKLyogc2VsZWN0IGJveGVzICovCi54LWZvcm0tc2VsZWN0LW9uZSB7CiAgICBoZWlnaHQ6MjBweDsKICAgIGxpbmUtaGVpZ2h0OjE4cHg7CiAgICB2ZXJ0aWNhbC1hbGlnbjptaWRkbGU7CiAgICBib3JkZXI6IDFweCBzb2xpZDsKfQoKLyogbXVsdGkgc2VsZWN0IGJveGVzICovCgovKiAtLS0gVE9ETyAtLS0gKi8KCi8qIDIuMC4yIHN0eWxlICovCi54LWZvcm0tY2hlY2std3JhcCB7CiAgICBsaW5lLWhlaWdodDoxOHB4OwogICAgaGVpZ2h0OiBhdXRvOwp9CgouZXh0LWllIC54LWZvcm0tY2hlY2std3JhcCBpbnB1dCB7CiAgICB3aWR0aDoxNXB4OwogICAgaGVpZ2h0OjE1cHg7Cn0KCi54LWZvcm0tY2hlY2std3JhcCBpbnB1dHsKICAgIHZlcnRpY2FsLWFsaWduOiBib3R0b207Cn0KCi54LWVkaXRvciAueC1mb3JtLWNoZWNrLXdyYXAgewogICAgcGFkZGluZzozcHg7Cn0KCi54LWVkaXRvciAueC1mb3JtLWNoZWNrYm94IHsKICAgIGhlaWdodDoxM3B4Owp9CgoueC1mb3JtLWNoZWNrLWdyb3VwLWxhYmVsIHsKICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZDsKICAgIG1hcmdpbi1ib3R0b206IDVweDsKICAgIHBhZGRpbmctbGVmdDogM3B4ICFpbXBvcnRhbnQ7CiAgICBmbG9hdDogbm9uZSAhaW1wb3J0YW50Owp9CgovKiB3cmFwcGVkIGZpZWxkcyBhbmQgdHJpZ2dlcnMgKi8KLngtZm9ybS1maWVsZC13cmFwIC54LWZvcm0tdHJpZ2dlcnsKICAgIHdpZHRoOjE3cHg7CiAgICBoZWlnaHQ6MjFweDsKICAgIGJvcmRlcjowOwogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQgMCAwOwogICAgY3Vyc29yOnBvaW50ZXI7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQ7CiAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgIHRvcDowOwp9CgoueC1mb3JtLWZpZWxkLXdyYXAgLngtZm9ybS1kYXRlLXRyaWdnZXIsIC54LWZvcm0tZmllbGQtd3JhcCAueC1mb3JtLWNsZWFyLXRyaWdnZXIsIC54LWZvcm0tZmllbGQtd3JhcCAueC1mb3JtLXNlYXJjaC10cmlnZ2VyewogICAgY3Vyc29yOnBvaW50ZXI7Cn0KCi54LWZvcm0tZmllbGQtd3JhcCAueC1mb3JtLXR3aW4tdHJpZ2dlcnMgLngtZm9ybS10cmlnZ2VyewogICAgcG9zaXRpb246c3RhdGljOwogICAgdG9wOmF1dG87CiAgICB2ZXJ0aWNhbC1hbGlnbjp0b3A7Cn0KCi54LWZvcm0tZmllbGQtd3JhcCB7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgIGxlZnQ6MDt0b3A6MDsKICAgIHRleHQtYWxpZ246IGxlZnQ7CiAgICB6b29tOjE7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgouZXh0LXN0cmljdCAuZXh0LWllOCAueC10b29sYmFyLWNlbGwgLngtZm9ybS1maWVsZC10cmlnZ2VyLXdyYXAgLngtZm9ybS10cmlnZ2VyIHsKICAgIHJpZ2h0OiAwOyAvKiBJRTggU3RyaWN0IG1vZGUgdHJpZ2dlciBidWcgKi8KfQoKLngtZm9ybS1maWVsZC13cmFwIC54LWZvcm0tdHJpZ2dlci1vdmVyewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTdweCAwOwp9CgoueC1mb3JtLWZpZWxkLXdyYXAgLngtZm9ybS10cmlnZ2VyLWNsaWNrewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMzRweCAwOwp9CgoueC10cmlnZ2VyLXdyYXAtZm9jdXMgLngtZm9ybS10cmlnZ2VyewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotNTFweCAwOwp9CgoueC10cmlnZ2VyLXdyYXAtZm9jdXMgLngtZm9ybS10cmlnZ2VyLW92ZXJ7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi02OHB4IDA7Cn0KCi54LXRyaWdnZXItd3JhcC1mb2N1cyAueC1mb3JtLXRyaWdnZXItY2xpY2t7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi04NXB4IDA7Cn0KCi54LXRyaWdnZXItd3JhcC1mb2N1cyAueC1mb3JtLXRyaWdnZXJ7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQ7Cn0KCi54LWl0ZW0tZGlzYWJsZWQgLngtZm9ybS10cmlnZ2VyLW92ZXJ7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgMCAhaW1wb3J0YW50OwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkOwp9CgoueC1pdGVtLWRpc2FibGVkIC54LWZvcm0tdHJpZ2dlci1jbGlja3sKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAwICFpbXBvcnRhbnQ7CiAgICBib3JkZXItYm90dG9tOiAxcHggc29saWQ7Cn0KCi54LXRyaWdnZXItbm9lZGl0ewogICAgY3Vyc29yOnBvaW50ZXI7Cn0KCi8qIGZpZWxkIGZvY3VzIHN0eWxlICovCi54LWZvcm0tZm9jdXMsIHRleHRhcmVhLngtZm9ybS1mb2N1c3sKICAgIGJvcmRlcjogMXB4IHNvbGlkOwp9CgovKiBpbnZhbGlkIGZpZWxkcyAqLwoueC1mb3JtLWludmFsaWQsIHRleHRhcmVhLngtZm9ybS1pbnZhbGlkewogICAgYmFja2dyb3VuZDpyZXBlYXQteCBib3R0b207CiAgICBib3JkZXI6IDFweCBzb2xpZDsKfQoKLngtZm9ybS1pbm5lci1pbnZhbGlkLCB0ZXh0YXJlYS54LWZvcm0taW5uZXItaW52YWxpZHsKICAgIGJhY2tncm91bmQ6cmVwZWF0LXggYm90dG9tOwp9CgovKiBlZGl0b3JzICovCi54LWVkaXRvciB7CiAgICB2aXNpYmlsaXR5OmhpZGRlbjsKICAgIHBhZGRpbmc6MDsKICAgIG1hcmdpbjowOwp9CgoueC1mb3JtLWdyb3ctc2l6ZXIgewogICAgbGVmdDogLTEwMDAwcHg7CiAgICBwYWRkaW5nOiA4cHggM3B4OwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdmlzaWJpbGl0eTpoaWRkZW47CiAgICB0b3A6IC0xMDAwMHB4OwogICAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwogICAgd2hpdGUtc3BhY2U6IC1tb3otcHJlLXdyYXA7CiAgICB3aGl0ZS1zcGFjZTogLXByZS13cmFwOwogICAgd2hpdGUtc3BhY2U6IC1vLXByZS13cmFwOwogICAgd29yZC13cmFwOiBicmVhay13b3JkOwogICAgem9vbToxOwp9CgoueC1mb3JtLWdyb3ctc2l6ZXIgcCB7CiAgICBtYXJnaW46MCAhaW1wb3J0YW50OwogICAgYm9yZGVyOjAgbm9uZSAhaW1wb3J0YW50OwogICAgcGFkZGluZzowICFpbXBvcnRhbnQ7Cn0KCi8qIEZvcm0gSXRlbXMgQ1NTICovCgoueC1mb3JtLWl0ZW0gewogICAgZGlzcGxheTpibG9jazsKICAgIG1hcmdpbi1ib3R0b206NHB4OwogICAgem9vbToxOwp9CgoueC1mb3JtLWl0ZW0gbGFiZWwueC1mb3JtLWl0ZW0tbGFiZWwgewogICAgZGlzcGxheTpibG9jazsKICAgIGZsb2F0OmxlZnQ7CiAgICB3aWR0aDoxMDBweDsKICAgIHBhZGRpbmc6M3B4OwogICAgcGFkZGluZy1sZWZ0OjA7CiAgICBjbGVhcjpsZWZ0OwogICAgei1pbmRleDoyOwogICAgcG9zaXRpb246cmVsYXRpdmU7Cn0KCi54LWZvcm0tZWxlbWVudCB7CiAgICBwYWRkaW5nLWxlZnQ6MTA1cHg7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKfQoKLngtZm9ybS1pbnZhbGlkLW1zZyB7CiAgICBwYWRkaW5nOjJweDsKICAgIHBhZGRpbmctbGVmdDoxOHB4OwogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IDAgMnB4OwogICAgbGluZS1oZWlnaHQ6MTZweDsKICAgIHdpZHRoOjIwMHB4Owp9CgoueC1mb3JtLWxhYmVsLWxlZnQgbGFiZWwueC1mb3JtLWl0ZW0tbGFiZWwgewogICB0ZXh0LWFsaWduOmxlZnQ7Cn0KCi54LWZvcm0tbGFiZWwtcmlnaHQgbGFiZWwueC1mb3JtLWl0ZW0tbGFiZWwgewogICB0ZXh0LWFsaWduOnJpZ2h0Owp9CgoueC1mb3JtLWxhYmVsLXRvcCAueC1mb3JtLWl0ZW0gbGFiZWwueC1mb3JtLWl0ZW0tbGFiZWwgewogICAgd2lkdGg6YXV0bzsKICAgIGZsb2F0Om5vbmU7CiAgICBjbGVhcjpub25lOwogICAgZGlzcGxheTppbmxpbmU7CiAgICBtYXJnaW4tYm90dG9tOjRweDsKICAgIHBvc2l0aW9uOnN0YXRpYzsKfQoKLngtZm9ybS1sYWJlbC10b3AgLngtZm9ybS1lbGVtZW50IHsKICAgIHBhZGRpbmctbGVmdDowOwogICAgcGFkZGluZy10b3A6NHB4Owp9CgoueC1mb3JtLWxhYmVsLXRvcCAueC1mb3JtLWl0ZW0gewogICAgcGFkZGluZy1ib3R0b206NHB4Owp9CgovKiBFZGl0b3Igc21hbGwgZm9udCBmb3IgZ3JpZCwgdG9vbGJhciBhbmQgdHJlZSAqLwoueC1zbWFsbC1lZGl0b3IgLngtZm9ybS10ZXh0IHsKICAgIGhlaWdodDoyMHB4OwogICAgbGluZS1oZWlnaHQ6MTZweDsKICAgIHZlcnRpY2FsLWFsaWduOm1pZGRsZTsKfQoKLmV4dC1pZTYgLngtc21hbGwtZWRpdG9yIC54LWZvcm0tdGV4dCwgLmV4dC1pZTcgLngtc21hbGwtZWRpdG9yIC54LWZvcm0tdGV4dCB7CiAgICBtYXJnaW4tdG9wOi0xcHggIWltcG9ydGFudDsgLyogaWUgYm9ndXMgbWFyZ2luIGJ1ZyAqLwogICAgbWFyZ2luLWJvdHRvbTotMXB4ICFpbXBvcnRhbnQ7CiAgICBoZWlnaHQ6MjBweCAhaW1wb3J0YW50OyAvKiBpZSBxdWlya3MgKi8KICAgIGxpbmUtaGVpZ2h0OjE2cHggIWltcG9ydGFudDsKfQoKLmV4dC1zdHJpY3QgLngtc21hbGwtZWRpdG9yIC54LWZvcm0tdGV4dCB7CiAgICBoZWlnaHQ6MTZweCAhaW1wb3J0YW50Owp9CgouZXh0LWllNiAueC1zbWFsbC1lZGl0b3IgLngtZm9ybS10ZXh0LCAuZXh0LWllNyAueC1zbWFsbC1lZGl0b3IgLngtZm9ybS10ZXh0IHsKICAgIGhlaWdodDoyMHB4OwogICAgbGluZS1oZWlnaHQ6MTZweDsKfQoKLmV4dC1ib3JkZXItYm94IC54LXNtYWxsLWVkaXRvciAueC1mb3JtLXRleHQgewogICAgaGVpZ2h0OjIwcHg7Cn0KCi54LXNtYWxsLWVkaXRvciAueC1mb3JtLXNlbGVjdC1vbmUgewogICAgaGVpZ2h0OjIwcHg7CiAgICBsaW5lLWhlaWdodDoxNnB4OwogICAgdmVydGljYWwtYWxpZ246bWlkZGxlOwp9CgoueC1zbWFsbC1lZGl0b3IgLngtZm9ybS1udW0tZmllbGQgewogICAgdGV4dC1hbGlnbjpyaWdodDsKfQoKLngtc21hbGwtZWRpdG9yIC54LWZvcm0tZmllbGQtd3JhcCAueC1mb3JtLXRyaWdnZXJ7CiAgICBoZWlnaHQ6MTlweDsKfQoKLmV4dC13ZWJraXQgLngtc21hbGwtZWRpdG9yIC54LWZvcm0tdGV4dHtwYWRkaW5nLXRvcDozcHg7Zm9udC1zaXplOjEwMCU7fQoKLmV4dC1zdHJpY3QgLmV4dC13ZWJraXQgLngtc21hbGwtZWRpdG9yIC54LWZvcm0tdGV4dHsKICAgIGhlaWdodDoxNHB4ICFpbXBvcnRhbnQ7Cn0KCi54LWZvcm0tY2xlYXIgewogICAgY2xlYXI6Ym90aDsKICAgIGhlaWdodDowOwogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgbGluZS1oZWlnaHQ6MDsKICAgIGZvbnQtc2l6ZTowOwp9Ci54LWZvcm0tY2xlYXItbGVmdCB7CiAgICBjbGVhcjpsZWZ0OwogICAgaGVpZ2h0OjA7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICBsaW5lLWhlaWdodDowOwogICAgZm9udC1zaXplOjA7Cn0KCi5leHQtaWU2IC54LWZvcm0tY2hlY2std3JhcCBpbnB1dCwgLmV4dC1ib3JkZXItYm94IC54LWZvcm0tY2hlY2std3JhcCBpbnB1dHsKICAgbWFyZ2luLXRvcDogM3B4Owp9CgoueC1mb3JtLWNiLWxhYmVsIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKICAgIG1hcmdpbi1sZWZ0OjRweDsKICAgIHRvcDogMnB4Owp9CgouZXh0LWllIC54LWZvcm0tY2ItbGFiZWx7CiAgICB0b3A6IDFweDsKfQoKLmV4dC1pZTYgLngtZm9ybS1jYi1sYWJlbCwgLmV4dC1ib3JkZXItYm94IC54LWZvcm0tY2ItbGFiZWx7CiAgICB0b3A6IDNweDsKfQoKLngtZm9ybS1kaXNwbGF5LWZpZWxkewogICAgcGFkZGluZy10b3A6IDJweDsKfQoKLmV4dC1nZWNrbyAueC1mb3JtLWRpc3BsYXktZmllbGQsIC5leHQtc3RyaWN0IC5leHQtaWU3IC54LWZvcm0tZGlzcGxheS1maWVsZHsKICAgIHBhZGRpbmctdG9wOiAxcHg7Cn0KCi5leHQtaWUgLngtZm9ybS1kaXNwbGF5LWZpZWxkewogICAgcGFkZGluZy10b3A6IDNweDsKfQoKLmV4dC1zdHJpY3QgLmV4dC1pZTggLngtZm9ybS1kaXNwbGF5LWZpZWxkewogICAgcGFkZGluZy10b3A6IDA7Cn0KCi54LWZvcm0tY29sdW1uIHsKICAgIGZsb2F0OmxlZnQ7CiAgICBwYWRkaW5nOjA7CiAgICBtYXJnaW46MDsKICAgIHdpZHRoOjQ4JTsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKfQoKLyogYnV0dG9ucyAqLwoueC1mb3JtIC54LWZvcm0tYnRucy1jdCAueC1idG57CiAgICBmbG9hdDpyaWdodDsKICAgIGNsZWFyOm5vbmU7Cn0KCi54LWZvcm0gLngtZm9ybS1idG5zLWN0IC54LWZvcm0tYnRucyB0ZCB7CiAgICBib3JkZXI6MDsKICAgIHBhZGRpbmc6MDsKfQoKLngtZm9ybSAueC1mb3JtLWJ0bnMtY3QgLngtZm9ybS1idG5zLXJpZ2h0IHRhYmxlewogICAgZmxvYXQ6cmlnaHQ7CiAgICBjbGVhcjpub25lOwp9CgoueC1mb3JtIC54LWZvcm0tYnRucy1jdCAueC1mb3JtLWJ0bnMtbGVmdCB0YWJsZXsKICAgIGZsb2F0OmxlZnQ7CiAgICBjbGVhcjpub25lOwp9CgoueC1mb3JtIC54LWZvcm0tYnRucy1jdCAueC1mb3JtLWJ0bnMtY2VudGVyewogICAgdGV4dC1hbGlnbjpjZW50ZXI7IC8qaWUqLwp9CgoueC1mb3JtIC54LWZvcm0tYnRucy1jdCAueC1mb3JtLWJ0bnMtY2VudGVyIHRhYmxlewogICAgbWFyZ2luOjAgYXV0bzsgLypldmVyeW9uZSBlbHNlKi8KfQoKLngtZm9ybSAueC1mb3JtLWJ0bnMtY3QgdGFibGUgdGQueC1mb3JtLWJ0bi10ZHsKICAgIHBhZGRpbmc6M3B4Owp9CgoueC1mb3JtIC54LWZvcm0tYnRucy1jdCAueC1idG4tZm9jdXMgLngtYnRuLWxlZnR7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTE0N3B4Owp9CgoueC1mb3JtIC54LWZvcm0tYnRucy1jdCAueC1idG4tZm9jdXMgLngtYnRuLXJpZ2h0ewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0xNjhweDsKfQoKLngtZm9ybSAueC1mb3JtLWJ0bnMtY3QgLngtYnRuLWZvY3VzIC54LWJ0bi1jZW50ZXJ7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTE4OXB4Owp9CgoueC1mb3JtIC54LWZvcm0tYnRucy1jdCAueC1idG4tY2xpY2sgLngtYnRuLWNlbnRlcnsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMTI2cHg7Cn0KCi54LWZvcm0gLngtZm9ybS1idG5zLWN0IC54LWJ0bi1jbGljayAgLngtYnRuLXJpZ2h0ewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC04NHB4Owp9CgoueC1mb3JtIC54LWZvcm0tYnRucy1jdCAueC1idG4tY2xpY2sgLngtYnRuLWxlZnR7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTYzcHg7Cn0KCi54LWZvcm0taW52YWxpZC1pY29uIHsKICAgIHdpZHRoOjE2cHg7CiAgICBoZWlnaHQ6MThweDsKICAgIHZpc2liaWxpdHk6aGlkZGVuOwogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICBsZWZ0OjA7CiAgICB0b3A6MDsKICAgIGRpc3BsYXk6YmxvY2s7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIDJweDsKfQoKLyogZmllbGRzZXRzICovCi54LWZpZWxkc2V0IHsKICAgIGJvcmRlcjoxcHggc29saWQ7CiAgICBwYWRkaW5nOjEwcHg7CiAgICBtYXJnaW4tYm90dG9tOjEwcHg7CiAgICBkaXNwbGF5OmJsb2NrOyAvKiBwcmVzZXJ2ZSBtYXJnaW5zIGluIElFICovCn0KCi8qIG1ha2UgdG9wIG9mIGNoZWNrYm94L3Rvb2xzIHZpc2libGUgaW4gd2Via2l0ICovCi5leHQtd2Via2l0IC54LWZpZWxkc2V0LWhlYWRlciB7CiAgICBwYWRkaW5nLXRvcDogMXB4Owp9CgouZXh0LWllIC54LWZpZWxkc2V0IGxlZ2VuZCB7CiAgICBtYXJnaW4tYm90dG9tOjEwcHg7Cn0KCi5leHQtc3RyaWN0IC5leHQtaWU5IC54LWZpZWxkc2V0IGxlZ2VuZC54LWZpZWxkc2V0LWhlYWRlciB7CiAgICBwYWRkaW5nLXRvcDogMXB4Owp9CgouZXh0LWllIC54LWZpZWxkc2V0IHsKICAgIHBhZGRpbmctdG9wOiAwOwogICAgcGFkZGluZy1ib3R0b206MTBweDsKfQoKLngtZmllbGRzZXQgbGVnZW5kIC54LXRvb2wtdG9nZ2xlIHsKICAgIG1hcmdpbi1yaWdodDozcHg7CiAgICBtYXJnaW4tbGVmdDowOwogICAgZmxvYXQ6bGVmdCAhaW1wb3J0YW50Owp9CgoueC1maWVsZHNldCBsZWdlbmQgaW5wdXQgewogICAgbWFyZ2luLXJpZ2h0OjNweDsKICAgIGZsb2F0OmxlZnQgIWltcG9ydGFudDsKICAgIGhlaWdodDoxM3B4OwogICAgd2lkdGg6MTNweDsKfQoKZmllbGRzZXQueC1wYW5lbC1jb2xsYXBzZWQgewogICAgcGFkZGluZy1ib3R0b206MCAhaW1wb3J0YW50OwogICAgYm9yZGVyLXdpZHRoOiAxcHggMXB4IDAgMXB4ICFpbXBvcnRhbnQ7CiAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItcmlnaHQtY29sb3I6IHRyYW5zcGFyZW50Owp9CgouZXh0LWllNiBmaWVsZHNldC54LXBhbmVsLWNvbGxhcHNlZHsKICAgIHBhZGRpbmctYm90dG9tOjAgIWltcG9ydGFudDsKICAgIGJvcmRlci13aWR0aDogMXB4IDAgMCAwICFpbXBvcnRhbnQ7CiAgICBtYXJnaW4tbGVmdDogMXB4OwogICAgbWFyZ2luLXJpZ2h0OiAxcHg7Cn0KCmZpZWxkc2V0LngtcGFuZWwtY29sbGFwc2VkIC54LWZpZWxkc2V0LWJ3cmFwIHsKICAgIHZpc2liaWxpdHk6aGlkZGVuOwogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICBsZWZ0Oi0xMDAwcHg7CiAgICB0b3A6LTEwMDBweDsKfQoKLmV4dC1pZSAueC1maWVsZHNldC1id3JhcCB7CiAgICB6b29tOjE7Cn0KCi54LWZpZWxkc2V0LW5vYm9yZGVyIHsKICAgIGJvcmRlcjowcHggbm9uZSB0cmFuc3BhcmVudDsKfQoKLngtZmllbGRzZXQtbm9ib3JkZXIgbGVnZW5kIHsKICAgIG1hcmdpbi1sZWZ0Oi0zcHg7Cn0KCi8qIElFIGxlZ2VuZCBwb3NpdGlvbmluZyBidWcgKi8KLmV4dC1pZSAueC1maWVsZHNldC1ub2JvcmRlciBsZWdlbmQgewogICAgcG9zaXRpb246IHJlbGF0aXZlOwogICAgbWFyZ2luLWJvdHRvbToyM3B4Owp9Ci5leHQtaWUgLngtZmllbGRzZXQtbm9ib3JkZXIgbGVnZW5kIHNwYW4gewogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgbGVmdDoxNnB4Owp9CgouZXh0LWdlY2tvIC54LXdpbmRvdy1ib2R5IC54LWZvcm0taXRlbSB7CiAgICAtbW96LW91dGxpbmU6IG5vbmU7CiAgICBvdXRsaW5lOiBub25lOwogICAgb3ZlcmZsb3c6IGF1dG87Cn0KCi5leHQtbWFjLmV4dC1nZWNrbyAueC13aW5kb3ctYm9keSAueC1mb3JtLWl0ZW0gewogICAgb3ZlcmZsb3c6aGlkZGVuOwp9CgouZXh0LWdlY2tvIC54LWZvcm0taXRlbSB7CiAgICAtbW96LW91dGxpbmU6IG5vbmU7CiAgICBvdXRsaW5lOiBub25lOwp9CgoueC1oaWRlLWxhYmVsIGxhYmVsLngtZm9ybS1pdGVtLWxhYmVsIHsKICAgICBkaXNwbGF5Om5vbmU7Cn0KCi54LWhpZGUtbGFiZWwgLngtZm9ybS1lbGVtZW50IHsKICAgICBwYWRkaW5nLWxlZnQ6IDAgIWltcG9ydGFudDsKfQoKLngtZm9ybS1sYWJlbC10b3AgLngtaGlkZS1sYWJlbCBsYWJlbC54LWZvcm0taXRlbS1sYWJlbHsKICAgIGRpc3BsYXk6IG5vbmU7Cn0KCi54LWZpZWxkc2V0IHsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoKLngtZmllbGRzZXQtYndyYXAgewogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgem9vbToxOwp9CgoueC1maWVsZHNldC1ib2R5IHsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoueC1idG57CgljdXJzb3I6cG9pbnRlcjsKCXdoaXRlLXNwYWNlOiBub3dyYXA7Cn0KCi54LWJ0biBidXR0b257CiAgICBib3JkZXI6MCBub25lOwogICAgYmFja2dyb3VuZC1jb2xvcjp0cmFuc3BhcmVudDsKICAgIHBhZGRpbmctbGVmdDozcHg7CiAgICBwYWRkaW5nLXJpZ2h0OjNweDsKICAgIGN1cnNvcjpwb2ludGVyOwogICAgbWFyZ2luOjA7CiAgICBvdmVyZmxvdzp2aXNpYmxlOwogICAgd2lkdGg6YXV0bzsKICAgIC1tb3otb3V0bGluZTowIG5vbmU7CiAgICBvdXRsaW5lOjAgbm9uZTsKfQoKKiBodG1sIC5leHQtaWUgLngtYnRuIGJ1dHRvbiB7CiAgICB3aWR0aDoxcHg7Cn0KCi5leHQtZ2Vja28gLngtYnRuIGJ1dHRvbiwgLmV4dC13ZWJraXQgLngtYnRuIGJ1dHRvbiB7CiAgICBwYWRkaW5nLWxlZnQ6MDsKICAgIHBhZGRpbmctcmlnaHQ6MDsKfQoKLmV4dC1nZWNrbyAueC1idG4gYnV0dG9uOjotbW96LWZvY3VzLWlubmVyIHsKICAgIHBhZGRpbmc6MDsKfQoKLmV4dC1pZSAueC1idG4gYnV0dG9uIHsKICAgIHBhZGRpbmctdG9wOjJweDsKfQoKLngtYnRuIHRkIHsKICAgIHBhZGRpbmc6MCAhaW1wb3J0YW50Owp9CgoueC1idG4tdGV4dCB7CiAgICBjdXJzb3I6cG9pbnRlcjsKCXdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBwYWRkaW5nOjA7Cn0KCi8qIGljb24gcGxhY2VtZW50IGFuZCBzaXppbmcgc3R5bGVzICovCgovKiBPbmx5IHRleHQgKi8KLngtYnRuLW5vaWNvbiAueC1idG4tc21hbGwgLngtYnRuLXRleHR7CgloZWlnaHQ6IDE2cHg7Cn0KCi54LWJ0bi1ub2ljb24gLngtYnRuLW1lZGl1bSAueC1idG4tdGV4dHsKICAgIGhlaWdodDogMjRweDsKfQoKLngtYnRuLW5vaWNvbiAueC1idG4tbGFyZ2UgLngtYnRuLXRleHR7CiAgICBoZWlnaHQ6IDMycHg7Cn0KCi8qIE9ubHkgaWNvbnMgKi8KLngtYnRuLWljb24gLngtYnRuLXRleHR7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiBjZW50ZXI7CgliYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0Owp9CgoueC1idG4taWNvbiAueC1idG4tc21hbGwgLngtYnRuLXRleHR7CgloZWlnaHQ6IDE2cHg7Cgl3aWR0aDogMTZweDsKfQoKLngtYnRuLWljb24gLngtYnRuLW1lZGl1bSAueC1idG4tdGV4dHsKICAgIGhlaWdodDogMjRweDsKCXdpZHRoOiAyNHB4Owp9CgoueC1idG4taWNvbiAueC1idG4tbGFyZ2UgLngtYnRuLXRleHR7CiAgICBoZWlnaHQ6IDMycHg7Cgl3aWR0aDogMzJweDsKfQoKLyogSWNvbnMgYW5kIHRleHQgKi8KLyogbGVmdCAqLwoueC1idG4tdGV4dC1pY29uIC54LWJ0bi1pY29uLXNtYWxsLWxlZnQgLngtYnRuLXRleHR7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAwIGNlbnRlcjsKCWJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7CiAgICBwYWRkaW5nLWxlZnQ6MThweDsKICAgIGhlaWdodDoxNnB4Owp9CgoueC1idG4tdGV4dC1pY29uIC54LWJ0bi1pY29uLW1lZGl1bS1sZWZ0IC54LWJ0bi10ZXh0ewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogMCBjZW50ZXI7CgliYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0OwogICAgcGFkZGluZy1sZWZ0OjI2cHg7CiAgICBoZWlnaHQ6MjRweDsKfQoKLngtYnRuLXRleHQtaWNvbiAueC1idG4taWNvbi1sYXJnZS1sZWZ0IC54LWJ0bi10ZXh0ewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogMCBjZW50ZXI7CgliYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0OwogICAgcGFkZGluZy1sZWZ0OjM0cHg7CiAgICBoZWlnaHQ6MzJweDsKfQoKLyogdG9wICovCi54LWJ0bi10ZXh0LWljb24gLngtYnRuLWljb24tc21hbGwtdG9wIC54LWJ0bi10ZXh0ewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyIDA7CgliYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0OwogICAgcGFkZGluZy10b3A6MThweDsKfQoKLngtYnRuLXRleHQtaWNvbiAueC1idG4taWNvbi1tZWRpdW0tdG9wIC54LWJ0bi10ZXh0ewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyIDA7CgliYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0OwogICAgcGFkZGluZy10b3A6MjZweDsKfQoKLngtYnRuLXRleHQtaWNvbiAueC1idG4taWNvbi1sYXJnZS10b3AgLngtYnRuLXRleHR7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiBjZW50ZXIgMDsKCWJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7CiAgICBwYWRkaW5nLXRvcDozNHB4Owp9CgovKiByaWdodCAqLwoueC1idG4tdGV4dC1pY29uIC54LWJ0bi1pY29uLXNtYWxsLXJpZ2h0IC54LWJ0bi10ZXh0ewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogcmlnaHQgY2VudGVyOwoJYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDsKICAgIHBhZGRpbmctcmlnaHQ6MThweDsKICAgIGhlaWdodDoxNnB4Owp9CgoueC1idG4tdGV4dC1pY29uIC54LWJ0bi1pY29uLW1lZGl1bS1yaWdodCAueC1idG4tdGV4dHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IHJpZ2h0IGNlbnRlcjsKCWJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7CiAgICBwYWRkaW5nLXJpZ2h0OjI2cHg7CiAgICBoZWlnaHQ6MjRweDsKfQoKLngtYnRuLXRleHQtaWNvbiAueC1idG4taWNvbi1sYXJnZS1yaWdodCAueC1idG4tdGV4dHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IHJpZ2h0IGNlbnRlcjsKCWJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7CiAgICBwYWRkaW5nLXJpZ2h0OjM0cHg7CiAgICBoZWlnaHQ6MzJweDsKfQoKLyogYm90dG9tICovCi54LWJ0bi10ZXh0LWljb24gLngtYnRuLWljb24tc21hbGwtYm90dG9tIC54LWJ0bi10ZXh0ewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyIGJvdHRvbTsKCWJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7CiAgICBwYWRkaW5nLWJvdHRvbToxOHB4Owp9CgoueC1idG4tdGV4dC1pY29uIC54LWJ0bi1pY29uLW1lZGl1bS1ib3R0b20gLngtYnRuLXRleHR7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiBjZW50ZXIgYm90dG9tOwoJYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDsKICAgIHBhZGRpbmctYm90dG9tOjI2cHg7Cn0KCi54LWJ0bi10ZXh0LWljb24gLngtYnRuLWljb24tbGFyZ2UtYm90dG9tIC54LWJ0bi10ZXh0ewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyIGJvdHRvbTsKCWJhY2tncm91bmQtcmVwZWF0OiBuby1yZXBlYXQ7CiAgICBwYWRkaW5nLWJvdHRvbTozNHB4Owp9CgovKiBiYWNrZ3JvdW5kIHBvc2l0aW9uaW5nICovCi54LWJ0bi10ciBpLCAueC1idG4tdGwgaSwgLngtYnRuLW1yIGksIC54LWJ0bi1tbCBpLCAueC1idG4tYnIgaSwgLngtYnRuLWJsIGl7Cglmb250LXNpemU6MXB4OwogICAgbGluZS1oZWlnaHQ6MXB4OwogICAgd2lkdGg6M3B4OwogICAgZGlzcGxheTpibG9jazsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoKLngtYnRuLXRyIGksIC54LWJ0bi10bCBpLCAueC1idG4tYnIgaSwgLngtYnRuLWJsIGl7CgloZWlnaHQ6M3B4Owp9CgoueC1idG4tdGx7Cgl3aWR0aDozcHg7CgloZWlnaHQ6M3B4OwoJYmFja2dyb3VuZDpuby1yZXBlYXQgMCAwOwp9Ci54LWJ0bi10cnsKCXdpZHRoOjNweDsKCWhlaWdodDozcHg7CgliYWNrZ3JvdW5kOm5vLXJlcGVhdCAtM3B4IDA7Cn0KLngtYnRuLXRjewoJaGVpZ2h0OjNweDsKCWJhY2tncm91bmQ6cmVwZWF0LXggMCAtNnB4Owp9CgoueC1idG4tbWx7Cgl3aWR0aDozcHg7CgliYWNrZ3JvdW5kOm5vLXJlcGVhdCAwIC0yNHB4Owp9Ci54LWJ0bi1tcnsKCXdpZHRoOjNweDsKCWJhY2tncm91bmQ6bm8tcmVwZWF0IC0zcHggLTI0cHg7Cn0KCi54LWJ0bi1tY3sKCWJhY2tncm91bmQ6cmVwZWF0LXggMCAtMTA5NnB4OwogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsKCXRleHQtYWxpZ246Y2VudGVyOwoJcGFkZGluZzowIDVweDsKCWN1cnNvcjpwb2ludGVyOwoJd2hpdGUtc3BhY2U6bm93cmFwOwp9CgovKiBGaXhlcyBhbiBpc3N1ZSB3aXRoIHRoZSBidXR0b24gaGVpZ2h0ICovCi5leHQtc3RyaWN0IC5leHQtaWU2IC54LWJ0bi1tYywgLmV4dC1zdHJpY3QgLmV4dC1pZTcgLngtYnRuLW1jIHsKICAgIGhlaWdodDogMTAwJTsKfQoKLngtYnRuLWJsewoJd2lkdGg6M3B4OwoJaGVpZ2h0OjNweDsKCWJhY2tncm91bmQ6bm8tcmVwZWF0IDAgLTNweDsKfQoKLngtYnRuLWJyewoJd2lkdGg6M3B4OwoJaGVpZ2h0OjNweDsKCWJhY2tncm91bmQ6bm8tcmVwZWF0IC0zcHggLTNweDsKfQoKLngtYnRuLWJjewoJaGVpZ2h0OjNweDsKCWJhY2tncm91bmQ6cmVwZWF0LXggMCAtMTVweDsKfQoKLngtYnRuLW92ZXIgLngtYnRuLXRsewoJYmFja2dyb3VuZC1wb3NpdGlvbjogLTZweCAwOwp9CgoueC1idG4tb3ZlciAueC1idG4tdHJ7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAtOXB4IDA7Cn0KCi54LWJ0bi1vdmVyIC54LWJ0bi10Y3sKCWJhY2tncm91bmQtcG9zaXRpb246IDAgLTlweDsKfQoKLngtYnRuLW92ZXIgLngtYnRuLW1sewoJYmFja2dyb3VuZC1wb3NpdGlvbjogLTZweCAtMjRweDsKfQoKLngtYnRuLW92ZXIgLngtYnRuLW1yewoJYmFja2dyb3VuZC1wb3NpdGlvbjogLTlweCAtMjRweDsKfQoKLngtYnRuLW92ZXIgLngtYnRuLW1jewoJYmFja2dyb3VuZC1wb3NpdGlvbjogMCAtMjE2OHB4Owp9CgoueC1idG4tb3ZlciAueC1idG4tYmx7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAtNnB4IC0zcHg7Cn0KCi54LWJ0bi1vdmVyIC54LWJ0bi1icnsKCWJhY2tncm91bmQtcG9zaXRpb246IC05cHggLTNweDsKfQoKLngtYnRuLW92ZXIgLngtYnRuLWJjewoJYmFja2dyb3VuZC1wb3NpdGlvbjogMCAtMThweDsKfQoKLngtYnRuLWNsaWNrIC54LWJ0bi10bCwgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi10bCwgLngtYnRuLXByZXNzZWQgLngtYnRuLXRsewoJYmFja2dyb3VuZC1wb3NpdGlvbjogLTEycHggMDsKfQoKLngtYnRuLWNsaWNrIC54LWJ0bi10ciwgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi10ciwgLngtYnRuLXByZXNzZWQgLngtYnRuLXRyewoJYmFja2dyb3VuZC1wb3NpdGlvbjogLTE1cHggMDsKfQoKLngtYnRuLWNsaWNrIC54LWJ0bi10YywgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi10YywgLngtYnRuLXByZXNzZWQgLngtYnRuLXRjewoJYmFja2dyb3VuZC1wb3NpdGlvbjogMCAtMTJweDsKfQoKLngtYnRuLWNsaWNrIC54LWJ0bi1tbCwgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi1tbCwgLngtYnRuLXByZXNzZWQgLngtYnRuLW1sewoJYmFja2dyb3VuZC1wb3NpdGlvbjogLTEycHggLTI0cHg7Cn0KCi54LWJ0bi1jbGljayAueC1idG4tbXIsIC54LWJ0bi1tZW51LWFjdGl2ZSAueC1idG4tbXIsIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi1tcnsKCWJhY2tncm91bmQtcG9zaXRpb246IC0xNXB4IC0yNHB4Owp9CgoueC1idG4tY2xpY2sgLngtYnRuLW1jLCAueC1idG4tbWVudS1hY3RpdmUgLngtYnRuLW1jLCAueC1idG4tcHJlc3NlZCAueC1idG4tbWN7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAwIC0zMjQwcHg7Cn0KCi54LWJ0bi1jbGljayAueC1idG4tYmwsIC54LWJ0bi1tZW51LWFjdGl2ZSAueC1idG4tYmwsIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi1ibHsKCWJhY2tncm91bmQtcG9zaXRpb246IC0xMnB4IC0zcHg7Cn0KCi54LWJ0bi1jbGljayAueC1idG4tYnIsIC54LWJ0bi1tZW51LWFjdGl2ZSAueC1idG4tYnIsIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi1icnsKCWJhY2tncm91bmQtcG9zaXRpb246IC0xNXB4IC0zcHg7Cn0KCi54LWJ0bi1jbGljayAueC1idG4tYmMsIC54LWJ0bi1tZW51LWFjdGl2ZSAueC1idG4tYmMsIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi1iY3sKCWJhY2tncm91bmQtcG9zaXRpb246IDAgLTIxcHg7Cn0KCi54LWJ0bi1kaXNhYmxlZCAqewoJY3Vyc29yOmRlZmF1bHQgIWltcG9ydGFudDsKfQoKCi8qIFdpdGggYSBtZW51IGFycm93ICovCi8qIHJpZ2h0ICovCi54LWJ0bi1tYyBlbS54LWJ0bi1hcnJvdyB7CiAgICBkaXNwbGF5OmJsb2NrOwogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgY2VudGVyOwoJcGFkZGluZy1yaWdodDoxMHB4Owp9CgoueC1idG4tbWMgZW0ueC1idG4tc3BsaXQgewogICAgZGlzcGxheTpibG9jazsKICAgIGJhY2tncm91bmQ6dHJhbnNwYXJlbnQgbm8tcmVwZWF0IHJpZ2h0IGNlbnRlcjsKCXBhZGRpbmctcmlnaHQ6MTRweDsKfQoKLyogYm90dG9tICovCi54LWJ0bi1tYyBlbS54LWJ0bi1hcnJvdy1ib3R0b20gewogICAgZGlzcGxheTpibG9jazsKICAgIGJhY2tncm91bmQ6dHJhbnNwYXJlbnQgbm8tcmVwZWF0IGNlbnRlciBib3R0b207CglwYWRkaW5nLWJvdHRvbToxNHB4Owp9CgoueC1idG4tbWMgZW0ueC1idG4tc3BsaXQtYm90dG9tIHsKICAgIGRpc3BsYXk6YmxvY2s7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCBjZW50ZXIgYm90dG9tOwoJcGFkZGluZy1ib3R0b206MTRweDsKfQoKLyogaGVpZ2h0IGFkanVzdG1lbnQgY2xhc3MgKi8KLngtYnRuLWFzLWFycm93IC54LWJ0bi1tYyBlbSB7CiAgICBkaXNwbGF5OmJsb2NrOwogICAgYmFja2dyb3VuZC1jb2xvcjp0cmFuc3BhcmVudDsKCXBhZGRpbmctYm90dG9tOjE0cHg7Cn0KCi8qIGdyb3VwcyAqLwoueC1idG4tZ3JvdXAgewogICAgcGFkZGluZzoxcHg7Cn0KCi54LWJ0bi1ncm91cC1oZWFkZXIgewogICAgcGFkZGluZzoycHg7CiAgICB0ZXh0LWFsaWduOmNlbnRlcjsKfQoKLngtYnRuLWdyb3VwLXRjIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC14IDAgMDsKCW92ZXJmbG93OmhpZGRlbjsKfQoKLngtYnRuLWdyb3VwLXRsIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIDA7CglwYWRkaW5nLWxlZnQ6M3B4OwogICAgem9vbToxOwp9CgoueC1idG4tZ3JvdXAtdHIgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IHJpZ2h0IDA7Cgl6b29tOjE7CiAgICBwYWRkaW5nLXJpZ2h0OjNweDsKfQoKLngtYnRuLWdyb3VwLWJjIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC14IDAgYm90dG9tOwogICAgem9vbToxOwp9CgoueC1idG4tZ3JvdXAtYmMgLngtcGFuZWwtZm9vdGVyIHsKICAgIHpvb206MTsKfQoKLngtYnRuLWdyb3VwLWJsIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIGJvdHRvbTsKCXBhZGRpbmctbGVmdDozcHg7CiAgICB6b29tOjE7Cn0KCi54LWJ0bi1ncm91cC1iciB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgYm90dG9tOwoJcGFkZGluZy1yaWdodDozcHg7CiAgICB6b29tOjE7Cn0KCi54LWJ0bi1ncm91cC1tYyB7CiAgICBib3JkZXI6MCBub25lOwogICAgcGFkZGluZzoxcHggMCAwIDA7CiAgICBtYXJnaW46MDsKfQoKLngtYnRuLWdyb3VwLW1jIC54LWJ0bi1ncm91cC1ib2R5IHsKICAgIGJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7CiAgICBib3JkZXI6IDAgbm9uZTsKfQoKLngtYnRuLWdyb3VwLW1sIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC15IDAgMDsKCXBhZGRpbmctbGVmdDozcHg7CiAgICB6b29tOjE7Cn0KCi54LWJ0bi1ncm91cC1tciB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCByZXBlYXQteSByaWdodCAwOwoJcGFkZGluZy1yaWdodDozcHg7CiAgICB6b29tOjE7Cn0KCi54LWJ0bi1ncm91cC1iYyAueC1idG4tZ3JvdXAtZm9vdGVyIHsKICAgIHBhZGRpbmctYm90dG9tOjZweDsKfQoKLngtcGFuZWwtbm9mb290ZXIgLngtYnRuLWdyb3VwLWJjIHsKCWhlaWdodDozcHg7CiAgICBmb250LXNpemU6MDsKICAgIGxpbmUtaGVpZ2h0OjA7Cn0KCi54LWJ0bi1ncm91cC1id3JhcCB7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICB6b29tOjE7Cn0KCi54LWJ0bi1ncm91cC1ib2R5IHsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKfQoKLngtYnRuLWdyb3VwLW5vdGl0bGUgLngtYnRuLWdyb3VwLXRjIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC14IDAgMDsKCW92ZXJmbG93OmhpZGRlbjsKICAgIGhlaWdodDoycHg7Cn0ueC10b29sYmFyewogICAgYm9yZGVyLXN0eWxlOnNvbGlkOwogICAgYm9yZGVyLXdpZHRoOjAgMCAxcHggMDsKICAgIGRpc3BsYXk6IGJsb2NrOwoJcGFkZGluZzoycHg7CiAgICBiYWNrZ3JvdW5kOnJlcGVhdC14IHRvcCBsZWZ0OwogICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICBsZWZ0OjA7CiAgICB0b3A6MDsKICAgIHpvb206MTsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoKLngtdG9vbGJhci1sZWZ0IHsKICAgIHdpZHRoOiAxMDAlOwp9CgoueC10b29sYmFyIC54LWl0ZW0tZGlzYWJsZWQgLngtYnRuLWljb24gewogICAgb3BhY2l0eTogLjM1OwogICAgLW1vei1vcGFjaXR5OiAuMzU7CiAgICBmaWx0ZXI6IGFscGhhKG9wYWNpdHk9MzUpOwp9CgoueC10b29sYmFyIHRkIHsKCXZlcnRpY2FsLWFsaWduOm1pZGRsZTsKfQoKLngtdG9vbGJhciB0ZCwueC10b29sYmFyIHNwYW4sLngtdG9vbGJhciBpbnB1dCwueC10b29sYmFyIGRpdiwueC10b29sYmFyIHNlbGVjdCwueC10b29sYmFyIGxhYmVsewoJd2hpdGUtc3BhY2U6IG5vd3JhcDsKfQoKLngtdG9vbGJhciAueC1pdGVtLWRpc2FibGVkIHsKCWN1cnNvcjpkZWZhdWx0OwoJb3BhY2l0eTouNjsKCS1tb3otb3BhY2l0eTouNjsKCWZpbHRlcjphbHBoYShvcGFjaXR5PTYwKTsKfQoKLngtdG9vbGJhciAueC1pdGVtLWRpc2FibGVkICogewoJY3Vyc29yOmRlZmF1bHQ7Cn0KCi54LXRvb2xiYXIgLngtdG9vbGJhci1jZWxsIHsKICAgIHZlcnRpY2FsLWFsaWduOm1pZGRsZTsKfQoKLngtdG9vbGJhciAueC1idG4tdGwsIC54LXRvb2xiYXIgLngtYnRuLXRyLCAueC10b29sYmFyIC54LWJ0bi10YywgLngtdG9vbGJhciAueC1idG4tbWwsIC54LXRvb2xiYXIgLngtYnRuLW1yLAoueC10b29sYmFyIC54LWJ0bi1tYywgLngtdG9vbGJhciAueC1idG4tYmwsIC54LXRvb2xiYXIgLngtYnRuLWJyLCAueC10b29sYmFyIC54LWJ0bi1iYwp7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiA1MDBweCA1MDBweDsKfQoKLyogVGhlc2UgcnVsZXMgYXJlIGR1cGxpY2F0ZWQgZnJvbSBidXR0b24uY3NzIHRvIGdpdmUgcHJpb3JpdHkgb2YgeC10b29sYmFyIHJ1bGVzIGFib3ZlICovCi54LXRvb2xiYXIgLngtYnRuLW92ZXIgLngtYnRuLXRsewoJYmFja2dyb3VuZC1wb3NpdGlvbjogLTZweCAwOwp9CgoueC10b29sYmFyIC54LWJ0bi1vdmVyIC54LWJ0bi10cnsKCWJhY2tncm91bmQtcG9zaXRpb246IC05cHggMDsKfQoKLngtdG9vbGJhciAueC1idG4tb3ZlciAueC1idG4tdGN7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAwIC05cHg7Cn0KCi54LXRvb2xiYXIgLngtYnRuLW92ZXIgLngtYnRuLW1sewoJYmFja2dyb3VuZC1wb3NpdGlvbjogLTZweCAtMjRweDsKfQoKLngtdG9vbGJhciAueC1idG4tb3ZlciAueC1idG4tbXJ7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAtOXB4IC0yNHB4Owp9CgoueC10b29sYmFyIC54LWJ0bi1vdmVyIC54LWJ0bi1tY3sKCWJhY2tncm91bmQtcG9zaXRpb246IDAgLTIxNjhweDsKfQoKLngtdG9vbGJhciAueC1idG4tb3ZlciAueC1idG4tYmx7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAtNnB4IC0zcHg7Cn0KCi54LXRvb2xiYXIgLngtYnRuLW92ZXIgLngtYnRuLWJyewoJYmFja2dyb3VuZC1wb3NpdGlvbjogLTlweCAtM3B4Owp9CgoueC10b29sYmFyIC54LWJ0bi1vdmVyIC54LWJ0bi1iY3sKCWJhY2tncm91bmQtcG9zaXRpb246IDAgLTE4cHg7Cn0KCi54LXRvb2xiYXIgLngtYnRuLWNsaWNrIC54LWJ0bi10bCwgLngtdG9vbGJhciAueC1idG4tbWVudS1hY3RpdmUgLngtYnRuLXRsLCAueC10b29sYmFyIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi10bHsKCWJhY2tncm91bmQtcG9zaXRpb246IC0xMnB4IDA7Cn0KCi54LXRvb2xiYXIgLngtYnRuLWNsaWNrIC54LWJ0bi10ciwgLngtdG9vbGJhciAueC1idG4tbWVudS1hY3RpdmUgLngtYnRuLXRyLCAueC10b29sYmFyIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi10cnsKCWJhY2tncm91bmQtcG9zaXRpb246IC0xNXB4IDA7Cn0KCi54LXRvb2xiYXIgLngtYnRuLWNsaWNrIC54LWJ0bi10YywgLngtdG9vbGJhciAueC1idG4tbWVudS1hY3RpdmUgLngtYnRuLXRjLCAueC10b29sYmFyIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi10Y3sKCWJhY2tncm91bmQtcG9zaXRpb246IDAgLTEycHg7Cn0KCi54LXRvb2xiYXIgLngtYnRuLWNsaWNrIC54LWJ0bi1tbCwgLngtdG9vbGJhciAueC1idG4tbWVudS1hY3RpdmUgLngtYnRuLW1sLCAueC10b29sYmFyIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi1tbHsKCWJhY2tncm91bmQtcG9zaXRpb246IC0xMnB4IC0yNHB4Owp9CgoueC10b29sYmFyIC54LWJ0bi1jbGljayAueC1idG4tbXIsIC54LXRvb2xiYXIgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi1tciwgLngtdG9vbGJhciAueC1idG4tcHJlc3NlZCAueC1idG4tbXJ7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAtMTVweCAtMjRweDsKfQoKLngtdG9vbGJhciAueC1idG4tY2xpY2sgLngtYnRuLW1jLCAueC10b29sYmFyIC54LWJ0bi1tZW51LWFjdGl2ZSAueC1idG4tbWMsIC54LXRvb2xiYXIgLngtYnRuLXByZXNzZWQgLngtYnRuLW1jewoJYmFja2dyb3VuZC1wb3NpdGlvbjogMCAtMzI0MHB4Owp9CgoueC10b29sYmFyIC54LWJ0bi1jbGljayAueC1idG4tYmwsIC54LXRvb2xiYXIgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi1ibCwgLngtdG9vbGJhciAueC1idG4tcHJlc3NlZCAueC1idG4tYmx7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAtMTJweCAtM3B4Owp9CgoueC10b29sYmFyIC54LWJ0bi1jbGljayAueC1idG4tYnIsIC54LXRvb2xiYXIgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi1iciwgLngtdG9vbGJhciAueC1idG4tcHJlc3NlZCAueC1idG4tYnJ7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAtMTVweCAtM3B4Owp9CgoueC10b29sYmFyIC54LWJ0bi1jbGljayAueC1idG4tYmMsIC54LXRvb2xiYXIgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi1iYywgLngtdG9vbGJhciAueC1idG4tcHJlc3NlZCAueC1idG4tYmN7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiAwIC0yMXB4Owp9CgoueC10b29sYmFyIGRpdi54dGItdGV4dHsKICAgIHBhZGRpbmc6MnB4IDJweCAwOwogICAgbGluZS1oZWlnaHQ6MTZweDsKICAgIGRpc3BsYXk6YmxvY2s7Cn0KCi54LXRvb2xiYXIgLnh0Yi1zZXAgewoJYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyOwoJYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDsKCWRpc3BsYXk6IGJsb2NrOwoJZm9udC1zaXplOiAxcHg7CgloZWlnaHQ6IDE2cHg7Cgl3aWR0aDo0cHg7CglvdmVyZmxvdzogaGlkZGVuOwoJY3Vyc29yOmRlZmF1bHQ7CgltYXJnaW46IDAgMnB4IDA7Cglib3JkZXI6MDsKfQoKLngtdG9vbGJhciAueHRiLXNwYWNlciB7CiAgICB3aWR0aDoycHg7Cn0KCi8qIFBhZ2luZyBUb29sYmFyICovCi54LXRiYXItcGFnZS1udW1iZXJ7Cgl3aWR0aDozMHB4OwoJaGVpZ2h0OjE0cHg7Cn0KCi5leHQtaWUgLngtdGJhci1wYWdlLW51bWJlcnsKICAgIG1hcmdpbi10b3A6IDJweDsKfQoKLngtcGFnaW5nLWluZm8gewogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICB0b3A6NXB4OwogICAgcmlnaHQ6IDhweDsKfQoKLyogZmxvYXRpbmcgKi8KLngtdG9vbGJhci1jdCB7CiAgICB3aWR0aDoxMDAlOwp9CgoueC10b29sYmFyLXJpZ2h0IHRkIHsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKfQoKLngtcGFuZWwtdGJhciwgLngtcGFuZWwtYmJhciwgLngtd2luZG93LXRiYXIsIC54LXdpbmRvdy1iYmFyLCAueC10YWItcGFuZWwtdGJhciwgLngtdGFiLXBhbmVsLWJiYXIsIC54LXBsYWluLXRiYXIsIC54LXBsYWluLWJiYXIgewogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgem9vbToxOwp9CgoueC10b29sYmFyLW1vcmUgLngtYnRuLXNtYWxsIC54LWJ0bi10ZXh0ewoJaGVpZ2h0OiAxNnB4OwoJd2lkdGg6IDEycHg7Cn0KCi54LXRvb2xiYXItbW9yZSBlbS54LWJ0bi1hcnJvdyB7CiAgICBkaXNwbGF5OmlubGluZTsKICAgIGJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7CglwYWRkaW5nLXJpZ2h0OjA7Cn0KCi54LXRvb2xiYXItbW9yZSAueC1idG4tbWMgZW0ueC1idG4tYXJyb3cgewogICAgYmFja2dyb3VuZC1pbWFnZTogbm9uZTsKfQoKZGl2LngtdG9vbGJhci1uby1pdGVtcyB7CiAgICBjb2xvcjpncmF5ICFpbXBvcnRhbnQ7CiAgICBwYWRkaW5nOjVweCAxMHB4ICFpbXBvcnRhbnQ7Cn0KCi8qIGZpeCBpZSB0b29sYmFyIGZvcm0gaXRlbXMgKi8KLmV4dC1ib3JkZXItYm94IC54LXRvb2xiYXItY2VsbCAueC1mb3JtLXRleHQgewogICAgbWFyZ2luLWJvdHRvbTotMXB4ICFpbXBvcnRhbnQ7Cn0KCi5leHQtYm9yZGVyLWJveCAueC10b29sYmFyLWNlbGwgLngtZm9ybS1maWVsZC13cmFwIC54LWZvcm0tdGV4dCB7CiAgICBtYXJnaW46MCAhaW1wb3J0YW50Owp9CgouZXh0LWllIC54LXRvb2xiYXItY2VsbCAueC1mb3JtLWZpZWxkLXdyYXAgewogICAgaGVpZ2h0OjIxcHg7Cn0KCi5leHQtaWUgLngtdG9vbGJhci1jZWxsIC54LWZvcm0tdGV4dCB7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgIHRvcDotMXB4Owp9CgouZXh0LXN0cmljdCAuZXh0LWllOCAueC10b29sYmFyLWNlbGwgLngtZm9ybS1maWVsZC10cmlnZ2VyLXdyYXAgLngtZm9ybS10ZXh0LCAuZXh0LXN0cmljdCAuZXh0LWllIC54LXRvb2xiYXItY2VsbCAueC1mb3JtLXRleHQgewogICAgdG9wOiAwcHg7Cn0KCi54LXRvb2xiYXItcmlnaHQgdGQgLngtZm9ybS1maWVsZC10cmlnZ2VyLXdyYXB7CiAgICB0ZXh0LWFsaWduOiBsZWZ0Owp9CgoueC10b29sYmFyLWNlbGwgLngtZm9ybS1jaGVja2JveCwgLngtdG9vbGJhci1jZWxsIC54LWZvcm0tcmFkaW97CiAgICBtYXJnaW4tdG9wOiA1cHg7Cn0KCi54LXRvb2xiYXItY2VsbCAueC1mb3JtLWNiLWxhYmVsewogICAgdmVydGljYWwtYWxpZ246IGJvdHRvbTsKICAgIHRvcDogMXB4Owp9CgouZXh0LWllIC54LXRvb2xiYXItY2VsbCAueC1mb3JtLWNoZWNrYm94LCAuZXh0LWllIC54LXRvb2xiYXItY2VsbCAueC1mb3JtLXJhZGlvewogICAgbWFyZ2luLXRvcDogNHB4Owp9CgouZXh0LWllIC54LXRvb2xiYXItY2VsbCAueC1mb3JtLWNiLWxhYmVsewogICAgdG9wOiAwOwp9Ci8qIEdyaWQzIHN0eWxlcyAqLwoueC1ncmlkMyB7Cglwb3NpdGlvbjpyZWxhdGl2ZTsKCW92ZXJmbG93OmhpZGRlbjsKfQoKLngtZ3JpZC1wYW5lbCAueC1wYW5lbC1ib2R5IHsKICAgIG92ZXJmbG93OmhpZGRlbiAhaW1wb3J0YW50Owp9CgoueC1ncmlkLXBhbmVsIC54LXBhbmVsLW1jIC54LXBhbmVsLWJvZHkgewogICAgYm9yZGVyOjFweCBzb2xpZDsKfQoKLngtZ3JpZDMgdGFibGUgewogICAgdGFibGUtbGF5b3V0OmZpeGVkOwp9CgoueC1ncmlkMy12aWV3cG9ydHsKCW92ZXJmbG93OmhpZGRlbjsKfQoKLngtZ3JpZDMtaGQtcm93IHRkLCAueC1ncmlkMy1yb3cgdGQsIC54LWdyaWQzLXN1bW1hcnktcm93IHRkewogICAgLW1vei1vdXRsaW5lOiBub25lOwogICAgb3V0bGluZTogbm9uZTsKCS1tb3otdXNlci1mb2N1czogbm9ybWFsOwp9CgoueC1ncmlkMy1yb3cgdGQsIC54LWdyaWQzLXN1bW1hcnktcm93IHRkIHsKICAgIGxpbmUtaGVpZ2h0OjEzcHg7CiAgICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwoJcGFkZGluZy1sZWZ0OjFweDsKICAgIHBhZGRpbmctcmlnaHQ6MXB4OwogICAgLW1vei11c2VyLXNlbGVjdDogbm9uZTsKICAgIC1raHRtbC11c2VyLXNlbGVjdDpub25lOwogICAgLXdlYmtpdC11c2VyLXNlbGVjdDppZ25vcmU7Cn0KCi54LWdyaWQzLWNlbGx7CiAgICAtbW96LXVzZXItc2VsZWN0OiBub25lOwogICAgLWtodG1sLXVzZXItc2VsZWN0Om5vbmU7CiAgICAtd2Via2l0LXVzZXItc2VsZWN0Omlnbm9yZTsKfQoKLngtZ3JpZDMtaGQtcm93IHRkIHsKICAgIGxpbmUtaGVpZ2h0OjE1cHg7CiAgICB2ZXJ0aWNhbC1hbGlnbjptaWRkbGU7CiAgICBib3JkZXItbGVmdDoxcHggc29saWQ7CiAgICBib3JkZXItcmlnaHQ6MXB4IHNvbGlkOwp9CgoueC1ncmlkMy1oZC1yb3cgLngtZ3JpZDMtbWFya2VyLWhkIHsKICAgIHBhZGRpbmc6M3B4Owp9CgoueC1ncmlkMy1yb3cgLngtZ3JpZDMtbWFya2VyIHsKICAgIHBhZGRpbmc6M3B4Owp9CgoueC1ncmlkMy1jZWxsLWlubmVyLCAueC1ncmlkMy1oZC1pbm5lcnsKCW92ZXJmbG93OmhpZGRlbjsKCS1vLXRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwoJdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7CiAgICBwYWRkaW5nOjNweCAzcHggM3B4IDVweDsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7Cn0KCi8qIEFjdGlvbkNvbHVtbiwgcmVkdWNlIHBhZGRpbmcgdG8gYWNjb21tb2RhdGUgMTZ4MTYgaWNvbnMgaW4gbm9ybWFsIHJvdyBoZWlnaHQgKi8KLngtYWN0aW9uLWNvbC1jZWxsIC54LWdyaWQzLWNlbGwtaW5uZXIgewogICAgcGFkZGluZy10b3A6IDFweDsKICAgIHBhZGRpbmctYm90dG9tOiAxcHg7Cn0KCi54LWFjdGlvbi1jb2wtaWNvbiB7CiAgICBjdXJzb3I6IHBvaW50ZXI7Cn0KCi54LWdyaWQzLWhkLWlubmVyIHsKICAgIHBvc2l0aW9uOnJlbGF0aXZlOwoJY3Vyc29yOmluaGVyaXQ7CglwYWRkaW5nOjRweCAzcHggNHB4IDVweDsKfQoKLngtZ3JpZDMtcm93LWJvZHkgewogICAgd2hpdGUtc3BhY2U6bm9ybWFsOwp9CgoueC1ncmlkMy1ib2R5LWNlbGwgewogICAgLW1vei1vdXRsaW5lOjAgbm9uZTsKICAgIG91dGxpbmU6MCBub25lOwp9CgovKiBJRSBRdWlya3MgdG8gY2xpcCAqLwouZXh0LWllIC54LWdyaWQzLWNlbGwtaW5uZXIsIC5leHQtaWUgLngtZ3JpZDMtaGQtaW5uZXJ7Cgl3aWR0aDoxMDAlOwp9CgovKiByZXZlcnNlIGFib3ZlIGluIHN0cmljdCBtb2RlICovCi5leHQtc3RyaWN0IC54LWdyaWQzLWNlbGwtaW5uZXIsIC5leHQtc3RyaWN0IC54LWdyaWQzLWhkLWlubmVyewoJd2lkdGg6YXV0bzsKfQoKLngtZ3JpZC1yb3ctbG9hZGluZyB7CiAgICBiYWNrZ3JvdW5kOiBuby1yZXBlYXQgY2VudGVyIGNlbnRlcjsKfQoKLngtZ3JpZC1wYWdlIHsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoKLngtZ3JpZDMtcm93IHsKCWN1cnNvcjogZGVmYXVsdDsKICAgIGJvcmRlcjogMXB4IHNvbGlkOwogICAgd2lkdGg6MTAwJTsKfQoKLngtZ3JpZDMtcm93LW92ZXIgewoJYm9yZGVyOjFweCBzb2xpZDsKICAgIGJhY2tncm91bmQ6IHJlcGVhdC14IGxlZnQgdG9wOwp9CgoueC1ncmlkMy1yZXNpemUtcHJveHkgewoJd2lkdGg6MXB4OwogICAgbGVmdDowOwoJY3Vyc29yOiBlLXJlc2l6ZTsKCWN1cnNvcjogY29sLXJlc2l6ZTsKCXBvc2l0aW9uOmFic29sdXRlOwoJdG9wOjA7CgloZWlnaHQ6MTAwcHg7CglvdmVyZmxvdzpoaWRkZW47Cgl2aXNpYmlsaXR5OmhpZGRlbjsKCWJvcmRlcjowIG5vbmU7Cgl6LWluZGV4Ojc7Cn0KCi54LWdyaWQzLXJlc2l6ZS1tYXJrZXIgewoJd2lkdGg6MXB4OwoJbGVmdDowOwoJcG9zaXRpb246YWJzb2x1dGU7Cgl0b3A6MDsKCWhlaWdodDoxMDBweDsKCW92ZXJmbG93OmhpZGRlbjsKCXZpc2liaWxpdHk6aGlkZGVuOwoJYm9yZGVyOjAgbm9uZTsKCXotaW5kZXg6NzsKfQoKLngtZ3JpZDMtZm9jdXMgewoJcG9zaXRpb246YWJzb2x1dGU7CglsZWZ0OjA7Cgl0b3A6MDsKCXdpZHRoOjFweDsKCWhlaWdodDoxcHg7CiAgICBsaW5lLWhlaWdodDoxcHg7CiAgICBmb250LXNpemU6MXB4OwogICAgLW1vei1vdXRsaW5lOjAgbm9uZTsKICAgIG91dGxpbmU6MCBub25lOwogICAgLW1vei11c2VyLXNlbGVjdDogdGV4dDsKICAgIC1raHRtbC11c2VyLXNlbGVjdDogdGV4dDsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6aWdub3JlOwp9CgovKiBoZWFkZXIgc3R5bGVzICovCi54LWdyaWQzLWhlYWRlcnsKCWJhY2tncm91bmQ6IHJlcGVhdC14IDAgYm90dG9tOwoJY3Vyc29yOmRlZmF1bHQ7CiAgICB6b29tOjE7CiAgICBwYWRkaW5nOjFweCAwIDAgMDsKfQoKLngtZ3JpZDMtaGVhZGVyLXBvcCB7CiAgICBib3JkZXItbGVmdDoxcHggc29saWQ7CiAgICBmbG9hdDpyaWdodDsKICAgIGNsZWFyOm5vbmU7Cn0KCi54LWdyaWQzLWhlYWRlci1wb3AtaW5uZXIgewogICAgYm9yZGVyLWxlZnQ6MXB4IHNvbGlkOwogICAgd2lkdGg6MTRweDsKICAgIGhlaWdodDoxOXB4OwogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IGNlbnRlciBjZW50ZXI7Cn0KCi5leHQtaWUgLngtZ3JpZDMtaGVhZGVyLXBvcC1pbm5lciB7CiAgICB3aWR0aDoxNXB4Owp9CgouZXh0LXN0cmljdCAueC1ncmlkMy1oZWFkZXItcG9wLWlubmVyIHsKICAgIHdpZHRoOjE0cHg7IAp9CgoueC1ncmlkMy1oZWFkZXItaW5uZXIgewogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgem9vbToxOwogICAgZmxvYXQ6bGVmdDsKfQoKLngtZ3JpZDMtaGVhZGVyLW9mZnNldCB7CiAgICBwYWRkaW5nLWxlZnQ6MXB4OwogICAgdGV4dC1hbGlnbjogbGVmdDsKfQoKdGQueC1ncmlkMy1oZC1vdmVyLCB0ZC5zb3J0LWRlc2MsIHRkLnNvcnQtYXNjLCB0ZC54LWdyaWQzLWhkLW1lbnUtb3BlbiB7CiAgICBib3JkZXItbGVmdDoxcHggc29saWQ7CiAgICBib3JkZXItcmlnaHQ6MXB4IHNvbGlkOwp9Cgp0ZC54LWdyaWQzLWhkLW92ZXIgLngtZ3JpZDMtaGQtaW5uZXIsIHRkLnNvcnQtZGVzYyAueC1ncmlkMy1oZC1pbm5lciwgdGQuc29ydC1hc2MgLngtZ3JpZDMtaGQtaW5uZXIsIHRkLngtZ3JpZDMtaGQtbWVudS1vcGVuIC54LWdyaWQzLWhkLWlubmVyIHsKICAgIGJhY2tncm91bmQ6IHJlcGVhdC14IGxlZnQgYm90dG9tOwoKfQoKLngtZ3JpZDMtc29ydC1pY29uewoJYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDsKCWRpc3BsYXk6IG5vbmU7CgloZWlnaHQ6IDRweDsKCXdpZHRoOiAxM3B4OwoJbWFyZ2luLWxlZnQ6M3B4OwoJdmVydGljYWwtYWxpZ246IG1pZGRsZTsKfQoKLnNvcnQtYXNjIC54LWdyaWQzLXNvcnQtaWNvbiwgLnNvcnQtZGVzYyAueC1ncmlkMy1zb3J0LWljb24gewoJZGlzcGxheTogaW5saW5lOwp9CgovKiBIZWFkZXIgcG9zaXRpb24gZml4ZXMgZm9yIElFIHN0cmljdCBtb2RlICovCi5leHQtc3RyaWN0IC5leHQtaWUgLngtZ3JpZDMtaGVhZGVyLWlubmVyLCAuZXh0LXN0cmljdCAuZXh0LWllNiAueC1ncmlkMy1oZCB7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKfQoKLmV4dC1zdHJpY3QgLmV4dC1pZTYgLngtZ3JpZDMtaGQtaW5uZXJ7CiAgICBwb3NpdGlvbjpzdGF0aWM7Cn0KCi8qIEJvZHkgU3R5bGVzICovCi54LWdyaWQzLWJvZHkgewoJem9vbToxOwp9CgoueC1ncmlkMy1zY3JvbGxlciB7CglvdmVyZmxvdzphdXRvOwogICAgem9vbToxOwogICAgcG9zaXRpb246cmVsYXRpdmU7Cn0KCi54LWdyaWQzLWNlbGwtdGV4dCwgLngtZ3JpZDMtaGQtdGV4dCB7CglkaXNwbGF5OiBibG9jazsKCXBhZGRpbmc6IDNweCA1cHggM3B4IDVweDsKCS1tb3otdXNlci1zZWxlY3Q6IG5vbmU7Cgkta2h0bWwtdXNlci1zZWxlY3Q6IG5vbmU7CiAgICAtd2Via2l0LXVzZXItc2VsZWN0Omlnbm9yZTsKfQoKLngtZ3JpZDMtc3BsaXQgewoJYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyOwoJYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDsKCWN1cnNvcjogZS1yZXNpemU7CgljdXJzb3I6IGNvbC1yZXNpemU7CglkaXNwbGF5OiBibG9jazsKCWZvbnQtc2l6ZTogMXB4OwoJaGVpZ2h0OiAxNnB4OwoJb3ZlcmZsb3c6IGhpZGRlbjsKCXBvc2l0aW9uOiBhYnNvbHV0ZTsKCXRvcDogMnB4OwoJd2lkdGg6IDZweDsKCXotaW5kZXg6IDM7Cn0KCi8qIENvbHVtbiBSZW9yZGVyIEREICovCi54LWRkLWRyYWctcHJveHkgLngtZ3JpZDMtaGQtaW5uZXJ7CgliYWNrZ3JvdW5kOiByZXBlYXQteCBsZWZ0IGJvdHRvbTsKCXdpZHRoOjEyMHB4OwoJcGFkZGluZzozcHg7Cglib3JkZXI6MXB4IHNvbGlkOwoJb3ZlcmZsb3c6aGlkZGVuOwp9CgouY29sLW1vdmUtdG9wLCAuY29sLW1vdmUtYm90dG9tewoJd2lkdGg6OXB4OwoJaGVpZ2h0OjlweDsKCXBvc2l0aW9uOmFic29sdXRlOwoJdG9wOjA7CglsaW5lLWhlaWdodDoxcHg7Cglmb250LXNpemU6MXB4OwoJb3ZlcmZsb3c6aGlkZGVuOwoJdmlzaWJpbGl0eTpoaWRkZW47Cgl6LWluZGV4OjIwMDAwOwogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQgbGVmdCB0b3A7Cn0KCi8qIFNlbGVjdGlvbiBTdHlsZXMgKi8KLngtZ3JpZDMtcm93LXNlbGVjdGVkIHsKCWJvcmRlcjoxcHggZG90dGVkOwp9CgoueC1ncmlkMy1sb2NrZWQgdGQueC1ncmlkMy1yb3ctbWFya2VyLCAueC1ncmlkMy1sb2NrZWQgLngtZ3JpZDMtcm93LXNlbGVjdGVkIHRkLngtZ3JpZDMtcm93LW1hcmtlcnsKICAgIGJhY2tncm91bmQ6IHJlcGVhdC14IDAgYm90dG9tICFpbXBvcnRhbnQ7CiAgICB2ZXJ0aWNhbC1hbGlnbjptaWRkbGUgIWltcG9ydGFudDsKICAgIHBhZGRpbmc6MDsKICAgIGJvcmRlci10b3A6MXB4IHNvbGlkOwogICAgYm9yZGVyLWJvdHRvbTpub25lICFpbXBvcnRhbnQ7CiAgICBib3JkZXItcmlnaHQ6MXB4IHNvbGlkICFpbXBvcnRhbnQ7CiAgICB0ZXh0LWFsaWduOmNlbnRlcjsKfQoKLngtZ3JpZDMtbG9ja2VkIHRkLngtZ3JpZDMtcm93LW1hcmtlciBkaXYsIC54LWdyaWQzLWxvY2tlZCAueC1ncmlkMy1yb3ctc2VsZWN0ZWQgdGQueC1ncmlkMy1yb3ctbWFya2VyIGRpdnsKICAgIHBhZGRpbmc6MCA0cHg7CiAgICB0ZXh0LWFsaWduOmNlbnRlcjsKfQoKLyogZGlydHkgY2VsbHMgKi8KLngtZ3JpZDMtZGlydHktY2VsbCB7CiAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgMCAwOwp9CgovKiBHcmlkIFRvb2xiYXJzICovCi54LWdyaWQzLXRvcGJhciwgLngtZ3JpZDMtYm90dG9tYmFyewogICAgb3ZlcmZsb3c6aGlkZGVuOwoJZGlzcGxheTpub25lOwoJem9vbToxOwogICAgcG9zaXRpb246cmVsYXRpdmU7Cn0KCi54LWdyaWQzLXRvcGJhciAueC10b29sYmFyewoJYm9yZGVyLXJpZ2h0OjAgbm9uZTsKfQoKLngtZ3JpZDMtYm90dG9tYmFyIC54LXRvb2xiYXJ7Cglib3JkZXItcmlnaHQ6MCBub25lOwoJYm9yZGVyLWJvdHRvbTowIG5vbmU7Cglib3JkZXItdG9wOjFweCBzb2xpZDsKfQoKLyogUHJvcHMgR3JpZCBTdHlsZXMgKi8KLngtcHJvcHMtZ3JpZCAueC1ncmlkMy1jZWxsewoJcGFkZGluZzoxcHg7Cn0KCi54LXByb3BzLWdyaWQgLngtZ3JpZDMtdGQtbmFtZSAueC1ncmlkMy1jZWxsLWlubmVyewoJYmFja2dyb3VuZDp0cmFuc3BhcmVudCByZXBlYXQteSAtMTZweCAhaW1wb3J0YW50OwogICAgcGFkZGluZy1sZWZ0OjEycHg7Cn0KCi54LXByb3BzLWdyaWQgLngtZ3JpZDMtYm9keSAueC1ncmlkMy10ZC1uYW1lewogICAgcGFkZGluZzoxcHg7CiAgICBwYWRkaW5nLXJpZ2h0OjA7CiAgICBib3JkZXI6MCBub25lOwogICAgYm9yZGVyLXJpZ2h0OjFweCBzb2xpZDsKfQoKLyogZGQgKi8KLngtZ3JpZDMtY29sLWRkIHsKICAgIGJvcmRlcjowIG5vbmU7CiAgICBwYWRkaW5nOjA7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOnRyYW5zcGFyZW50Owp9CgoueC1kZC1kcmFnLWdob3N0IC54LWdyaWQzLWRkLXdyYXAgewogICAgcGFkZGluZzoxcHggM3B4IDNweCAxcHg7Cn0KCi54LWdyaWQzLWhkIHsKICAgIC1tb3otdXNlci1zZWxlY3Q6bm9uZTsKICAgIC1raHRtbC11c2VyLXNlbGVjdDpub25lOwogICAgLXdlYmtpdC11c2VyLXNlbGVjdDppZ25vcmU7Cn0KCi54LWdyaWQzLWhkLWJ0biB7CiAgICBkaXNwbGF5Om5vbmU7CiAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgIHdpZHRoOjE0cHg7CiAgICBiYWNrZ3JvdW5kOm5vLXJlcGVhdCBsZWZ0IGNlbnRlcjsKICAgIHJpZ2h0OjA7CiAgICB0b3A6MDsKICAgIHotaW5kZXg6MjsKCWN1cnNvcjpwb2ludGVyOwp9CgoueC1ncmlkMy1oZC1vdmVyIC54LWdyaWQzLWhkLWJ0biwgLngtZ3JpZDMtaGQtbWVudS1vcGVuIC54LWdyaWQzLWhkLWJ0biB7CiAgICBkaXNwbGF5OmJsb2NrOwp9CgphLngtZ3JpZDMtaGQtYnRuOmhvdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE0cHggY2VudGVyOwp9CgovKiBFeHBhbmRlcnMgKi8KLngtZ3JpZDMtYm9keSAueC1ncmlkMy10ZC1leHBhbmRlciB7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IHJlcGVhdC15IHJpZ2h0Owp9CgoueC1ncmlkMy1ib2R5IC54LWdyaWQzLXRkLWV4cGFuZGVyIC54LWdyaWQzLWNlbGwtaW5uZXIgewogICAgcGFkZGluZzowICFpbXBvcnRhbnQ7CiAgICBoZWlnaHQ6MTAwJTsKfQoKLngtZ3JpZDMtcm93LWV4cGFuZGVyIHsKICAgIHdpZHRoOjEwMCU7CiAgICBoZWlnaHQ6MThweDsKICAgIGJhY2tncm91bmQtcG9zaXRpb246NHB4IDJweDsKICAgIGJhY2tncm91bmQtcmVwZWF0Om5vLXJlcGVhdDsKICAgIGJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7Cn0KCi54LWdyaWQzLXJvdy1jb2xsYXBzZWQgLngtZ3JpZDMtcm93LWV4cGFuZGVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246NHB4IDJweDsKfQoKLngtZ3JpZDMtcm93LWV4cGFuZGVkIC54LWdyaWQzLXJvdy1leHBhbmRlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0yMXB4IDJweDsKfQoKLngtZ3JpZDMtcm93LWNvbGxhcHNlZCAueC1ncmlkMy1yb3ctYm9keSB7CiAgICBkaXNwbGF5Om5vbmUgIWltcG9ydGFudDsKfQoKLngtZ3JpZDMtcm93LWV4cGFuZGVkIC54LWdyaWQzLXJvdy1ib2R5IHsKICAgIGRpc3BsYXk6YmxvY2sgIWltcG9ydGFudDsKfQoKLyogQ2hlY2tlcnMgKi8KLngtZ3JpZDMtYm9keSAueC1ncmlkMy10ZC1jaGVja2VyIHsKICAgIGJhY2tncm91bmQ6dHJhbnNwYXJlbnQgcmVwZWF0LXkgcmlnaHQ7Cn0KCi54LWdyaWQzLWJvZHkgLngtZ3JpZDMtdGQtY2hlY2tlciAueC1ncmlkMy1jZWxsLWlubmVyLCAueC1ncmlkMy1oZWFkZXIgLngtZ3JpZDMtdGQtY2hlY2tlciAueC1ncmlkMy1oZC1pbm5lciB7CiAgICBwYWRkaW5nOjAgIWltcG9ydGFudDsKICAgIGhlaWdodDoxMDAlOwp9CgoueC1ncmlkMy1yb3ctY2hlY2tlciwgLngtZ3JpZDMtaGQtY2hlY2tlciB7CiAgICB3aWR0aDoxMDAlOwogICAgaGVpZ2h0OjE4cHg7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjJweCAycHg7CiAgICBiYWNrZ3JvdW5kLXJlcGVhdDpuby1yZXBlYXQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOnRyYW5zcGFyZW50Owp9CgoueC1ncmlkMy1yb3cgLngtZ3JpZDMtcm93LWNoZWNrZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjoycHggMnB4Owp9CgoueC1ncmlkMy1yb3ctc2VsZWN0ZWQgLngtZ3JpZDMtcm93LWNoZWNrZXIsIC54LWdyaWQzLWhkLWNoZWNrZXItb24gLngtZ3JpZDMtaGQtY2hlY2tlciwueC1ncmlkMy1yb3ctY2hlY2tlZCAueC1ncmlkMy1yb3ctY2hlY2tlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0yM3B4IDJweDsKfQoKLngtZ3JpZDMtaGQtY2hlY2tlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjJweCAxcHg7Cn0KCi5leHQtYm9yZGVyLWJveCAueC1ncmlkMy1oZC1jaGVja2VyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MnB4IDNweDsKfQoKLngtZ3JpZDMtaGQtY2hlY2tlci1vbiAueC1ncmlkMy1oZC1jaGVja2VyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTIzcHggMXB4Owp9CgouZXh0LWJvcmRlci1ib3ggLngtZ3JpZDMtaGQtY2hlY2tlci1vbiAueC1ncmlkMy1oZC1jaGVja2VyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTIzcHggM3B4Owp9CgovKiBOdW1iZXJlciAqLwoueC1ncmlkMy1ib2R5IC54LWdyaWQzLXRkLW51bWJlcmVyIHsKICAgIGJhY2tncm91bmQ6dHJhbnNwYXJlbnQgcmVwZWF0LXkgcmlnaHQ7Cn0KCi54LWdyaWQzLWJvZHkgLngtZ3JpZDMtdGQtbnVtYmVyZXIgLngtZ3JpZDMtY2VsbC1pbm5lciB7CiAgICBwYWRkaW5nOjNweCA1cHggMCAwICFpbXBvcnRhbnQ7CiAgICB0ZXh0LWFsaWduOnJpZ2h0Owp9CgovKiBSb3cgSWNvbiAqLwoKLngtZ3JpZDMtYm9keSAueC1ncmlkMy10ZC1yb3ctaWNvbiB7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IHJlcGVhdC15IHJpZ2h0OwogICAgdmVydGljYWwtYWxpZ246dG9wOwogICAgdGV4dC1hbGlnbjpjZW50ZXI7Cn0KCi54LWdyaWQzLWJvZHkgLngtZ3JpZDMtdGQtcm93LWljb24gLngtZ3JpZDMtY2VsbC1pbm5lciB7CiAgICBwYWRkaW5nOjAgIWltcG9ydGFudDsKICAgIGJhY2tncm91bmQtcG9zaXRpb246Y2VudGVyIGNlbnRlcjsKICAgIGJhY2tncm91bmQtcmVwZWF0Om5vLXJlcGVhdDsKICAgIHdpZHRoOjE2cHg7CiAgICBoZWlnaHQ6MTZweDsKICAgIG1hcmdpbi1sZWZ0OjJweDsKICAgIG1hcmdpbi10b3A6M3B4Owp9CgovKiBBbGwgc3BlY2lhbHMgKi8KLngtZ3JpZDMtYm9keSAueC1ncmlkMy1yb3ctc2VsZWN0ZWQgLngtZ3JpZDMtdGQtbnVtYmVyZXIsCi54LWdyaWQzLWJvZHkgLngtZ3JpZDMtcm93LXNlbGVjdGVkIC54LWdyaWQzLXRkLWNoZWNrZXIsCi54LWdyaWQzLWJvZHkgLngtZ3JpZDMtcm93LXNlbGVjdGVkIC54LWdyaWQzLXRkLWV4cGFuZGVyIHsKCWJhY2tncm91bmQ6dHJhbnNwYXJlbnQgcmVwZWF0LXkgcmlnaHQ7Cn0KCi54LWdyaWQzLWJvZHkgLngtZ3JpZDMtY2hlY2stY29sLXRkIC54LWdyaWQzLWNlbGwtaW5uZXIgewogICAgcGFkZGluZzogMXB4IDAgMCAwICFpbXBvcnRhbnQ7Cn0KCi54LWdyaWQzLWNoZWNrLWNvbCB7CiAgICB3aWR0aDoxMDAlOwogICAgaGVpZ2h0OjE2cHg7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOmNlbnRlciBjZW50ZXI7CiAgICBiYWNrZ3JvdW5kLXJlcGVhdDpuby1yZXBlYXQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOnRyYW5zcGFyZW50Owp9CgoueC1ncmlkMy1jaGVjay1jb2wtb24gewogICAgd2lkdGg6MTAwJTsKICAgIGhlaWdodDoxNnB4OwogICAgYmFja2dyb3VuZC1wb3NpdGlvbjpjZW50ZXIgY2VudGVyOwogICAgYmFja2dyb3VuZC1yZXBlYXQ6bm8tcmVwZWF0OwogICAgYmFja2dyb3VuZC1jb2xvcjp0cmFuc3BhcmVudDsKfQoKLyogR3JvdXBpbmcgY2xhc3NlcyAqLwoueC1ncmlkLWdyb3VwLCAueC1ncmlkLWdyb3VwLWJvZHksIC54LWdyaWQtZ3JvdXAtaGQgewogICAgem9vbToxOwp9CgoueC1ncmlkLWdyb3VwLWhkIHsKICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZDsKICAgIGN1cnNvcjpwb2ludGVyOwogICAgcGFkZGluZy10b3A6NnB4Owp9CgoueC1ncmlkLWdyb3VwLWhkIGRpdi54LWdyaWQtZ3JvdXAtdGl0bGUgewogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQgM3B4IDNweDsKICAgIHBhZGRpbmc6NHB4IDRweCA0cHggMTdweDsKfQoKLngtZ3JpZC1ncm91cC1jb2xsYXBzZWQgLngtZ3JpZC1ncm91cC1ib2R5IHsKICAgIGRpc3BsYXk6bm9uZTsKfQoKLmV4dC1pZTYgLngtZ3JpZDMgLngtZWRpdG9yIC54LWZvcm0tdGV4dCwgLmV4dC1pZTcgLngtZ3JpZDMgLngtZWRpdG9yIC54LWZvcm0tdGV4dCB7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgIHRvcDotMXB4Owp9CgouZXh0LWllIC54LXByb3BzLWdyaWQgLngtZWRpdG9yIC54LWZvcm0tdGV4dCB7CiAgICBwb3NpdGlvbjpzdGF0aWM7CiAgICB0b3A6MDsKfQoKLngtZ3JpZC1lbXB0eSB7CiAgICBwYWRkaW5nOjEwcHg7Cn0KCi8qIGZpeCBmbG9hdGluZyB0b29sYmFyIGlzc3VlICovCi5leHQtaWU3IC54LWdyaWQtcGFuZWwgLngtcGFuZWwtYmJhciB7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKfQoKCi8qIFJlc2V0IHBvc2l0aW9uIHRvIHN0YXRpYyB3aGVuIEdyaWQgUGFuZWwgaGFzIGJlZW4gZnJhbWVkICovCi8qIHRvIHJlc29sdmUgJ3NuYXBwaW5nJyBmcm9tIHRvcCB0byBib3R0b20gYmVoYXZpb3IuICovCi8qIEBmb3J1bVRocmVhZCA4NjY1NiAqLwouZXh0LWllNyAueC1ncmlkLXBhbmVsIC54LXBhbmVsLW1jIC54LXBhbmVsLWJiYXIgewogICAgcG9zaXRpb246IHN0YXRpYzsKfQoKLmV4dC1pZTYgLngtZ3JpZDMtaGVhZGVyIHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQoKLyogRml4IFdlYktpdCBidWcgaW4gR3JpZHMgKi8KLmV4dC13ZWJraXQgLngtZ3JpZC1wYW5lbCAueC1wYW5lbC1id3JhcHsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6bm9uZTsKfQouZXh0LXdlYmtpdCAueC10YmFyLXBhZ2UtbnVtYmVyewogICAgLXdlYmtpdC11c2VyLXNlbGVjdDppZ25vcmU7Cn0KLyogZW5kKi8KCi8qIGNvbHVtbiBsaW5lcyAqLwoueC1ncmlkLXdpdGgtY29sLWxpbmVzIC54LWdyaWQzLXJvdyB0ZC54LWdyaWQzLWNlbGwgewogICAgcGFkZGluZy1yaWdodDowOwogICAgYm9yZGVyLXJpZ2h0OjFweCBzb2xpZDsKfQoueC1waXZvdGdyaWQgLngtZ3JpZDMtaGVhZGVyLW9mZnNldCB0YWJsZSB7CiAgICB3aWR0aDogMTAwJTsKICAgIGJvcmRlci1jb2xsYXBzZTogY29sbGFwc2U7Cn0KCi54LXBpdm90Z3JpZCAueC1ncmlkMy1oZWFkZXItb2Zmc2V0IHRhYmxlIHRkIHsKICAgIHBhZGRpbmc6IDRweCAzcHggNHB4IDVweDsKICAgIHRleHQtYWxpZ246IGNlbnRlcjsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7CiAgICBmb250LXNpemU6IDExcHg7CiAgICBsaW5lLWhlaWdodDogMTNweDsKICAgIGZvbnQtZmFtaWx5OiB0YWhvbWE7Cn0KCi54LXBpdm90Z3JpZCAueC1ncmlkMy1yb3ctaGVhZGVycyB7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGZsb2F0OiBsZWZ0Owp9CgoueC1waXZvdGdyaWQgLngtZ3JpZDMtcm93LWhlYWRlcnMgdGFibGUgewogICAgaGVpZ2h0OiAxMDAlOwogICAgd2lkdGg6IDEwMCU7CiAgICBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOwp9CgoueC1waXZvdGdyaWQgLngtZ3JpZDMtcm93LWhlYWRlcnMgdGFibGUgdGQgewogICAgaGVpZ2h0OiAxOHB4OwogICAgcGFkZGluZzogMnB4IDdweCAwIDA7CiAgICB0ZXh0LWFsaWduOiByaWdodDsKICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwogICAgZm9udC1zaXplOiAxMXB4OwogICAgZm9udC1mYW1pbHk6IHRhaG9tYTsKfQoKLmV4dC1nZWNrbyAueC1waXZvdGdyaWQgLngtZ3JpZDMtcm93LWhlYWRlcnMgdGFibGUgdGQgewogICAgaGVpZ2h0OiAyMXB4Owp9CgoueC1ncmlkMy1oZWFkZXItdGl0bGUgewogICAgdG9wOiAwJTsKICAgIGxlZnQ6IDAlOwogICAgcG9zaXRpb246IGFic29sdXRlOwogICAgdGV4dC1hbGlnbjogY2VudGVyOwogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsKICAgIGZvbnQtZmFtaWx5OiB0YWhvbWE7CiAgICBmb250LXNpemU6IDExcHg7CiAgICBwYWRkaW5nOiBhdXRvIDFweDsKICAgIGRpc3BsYXk6IHRhYmxlLWNlbGw7Cn0KCi54LWdyaWQzLWhlYWRlci10aXRsZSBzcGFuIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHRvcDogNTAlOwogICAgbGVmdDogMCU7CiAgICB3aWR0aDogMTAwJTsKICAgIG1hcmdpbi10b3A6IC02cHg7Cn0ueC1kZC1kcmFnLXByb3h5ewoJcG9zaXRpb246YWJzb2x1dGU7CglsZWZ0OjA7CiAgICB0b3A6MDsKCXZpc2liaWxpdHk6aGlkZGVuOwoJei1pbmRleDoxNTAwMDsKfQoKLngtZGQtZHJhZy1naG9zdHsKCS1tb3otb3BhY2l0eTogMC44NTsKICAgIG9wYWNpdHk6Ljg1OwogICAgZmlsdGVyOiBhbHBoYShvcGFjaXR5PTg1KTsKICAgIGJvcmRlcjogMXB4IHNvbGlkOwoJcGFkZGluZzozcHg7CglwYWRkaW5nLWxlZnQ6MjBweDsKCXdoaXRlLXNwYWNlOm5vd3JhcDsKfQoKLngtZGQtZHJhZy1yZXBhaXIgLngtZGQtZHJhZy1naG9zdHsKCS1tb3otb3BhY2l0eTogMC40OwogICAgb3BhY2l0eTouNDsKICAgIGZpbHRlcjogYWxwaGEob3BhY2l0eT00MCk7Cglib3JkZXI6MCBub25lOwoJcGFkZGluZzowOwoJYmFja2dyb3VuZC1jb2xvcjp0cmFuc3BhcmVudDsKfQoKLngtZGQtZHJhZy1yZXBhaXIgLngtZGQtZHJvcC1pY29uewoJdmlzaWJpbGl0eTpoaWRkZW47Cn0KCi54LWRkLWRyb3AtaWNvbnsKICAgIHBvc2l0aW9uOmFic29sdXRlOwoJdG9wOjNweDsKCWxlZnQ6M3B4OwoJZGlzcGxheTpibG9jazsKCXdpZHRoOjE2cHg7CgloZWlnaHQ6MTZweDsKCWJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOiBjZW50ZXI7CgliYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0OwoJei1pbmRleDoxOwp9CgoueC12aWV3LXNlbGVjdG9yIHsKICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgbGVmdDowOwogICAgdG9wOjA7CiAgICB3aWR0aDowOwogICAgYm9yZGVyOjFweCBkb3R0ZWQ7CglvcGFjaXR5OiAuNTsKICAgIC1tb3otb3BhY2l0eTogLjU7CiAgICBmaWx0ZXI6YWxwaGEob3BhY2l0eT01MCk7CiAgICB6b29tOjE7Cn0uZXh0LXN0cmljdCAuZXh0LWllIC54LXRyZWUgLngtcGFuZWwtYndyYXB7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoKLngtdHJlZS1pY29uLCAueC10cmVlLWVjLWljb24sIC54LXRyZWUtZWxib3ctbGluZSwgLngtdHJlZS1lbGJvdywgLngtdHJlZS1lbGJvdy1lbmQsIC54LXRyZWUtZWxib3ctcGx1cywgLngtdHJlZS1lbGJvdy1taW51cywgLngtdHJlZS1lbGJvdy1lbmQtcGx1cywgLngtdHJlZS1lbGJvdy1lbmQtbWludXN7Cglib3JkZXI6IDAgbm9uZTsKCWhlaWdodDogMThweDsKCW1hcmdpbjogMDsKCXBhZGRpbmc6IDA7Cgl2ZXJ0aWNhbC1hbGlnbjogdG9wOwoJd2lkdGg6IDE2cHg7CiAgICBiYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0Owp9CgoueC10cmVlLW5vZGUtY29sbGFwc2VkIC54LXRyZWUtbm9kZS1pY29uLCAueC10cmVlLW5vZGUtZXhwYW5kZWQgLngtdHJlZS1ub2RlLWljb24sIC54LXRyZWUtbm9kZS1sZWFmIC54LXRyZWUtbm9kZS1pY29uewoJYm9yZGVyOiAwIG5vbmU7CgloZWlnaHQ6IDE4cHg7CgltYXJnaW46IDA7CglwYWRkaW5nOiAwOwoJdmVydGljYWwtYWxpZ246IHRvcDsKCXdpZHRoOiAxNnB4OwoJYmFja2dyb3VuZC1wb3NpdGlvbjpjZW50ZXI7CiAgICBiYWNrZ3JvdW5kLXJlcGVhdDogbm8tcmVwZWF0Owp9CgouZXh0LWllIC54LXRyZWUtbm9kZS1pbmRlbnQgaW1nLCAuZXh0LWllIC54LXRyZWUtbm9kZS1pY29uLCAuZXh0LWllIC54LXRyZWUtZWMtaWNvbiB7CiAgICB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlICFpbXBvcnRhbnQ7Cn0KCi5leHQtc3RyaWN0IC5leHQtaWU4IC54LXRyZWUtbm9kZS1pbmRlbnQgaW1nLCAuZXh0LXN0cmljdCAuZXh0LWllOCAueC10cmVlLW5vZGUtaWNvbiwgLmV4dC1zdHJpY3QgLmV4dC1pZTggLngtdHJlZS1lYy1pY29uIHsKICAgIHZlcnRpY2FsLWFsaWduOiB0b3AgIWltcG9ydGFudDsKfQoKLyogY2hlY2tib3hlcyAqLwoKaW5wdXQueC10cmVlLW5vZGUtY2IgewogICAgbWFyZ2luLWxlZnQ6MXB4OwogICAgaGVpZ2h0OiAxOXB4OwoJdmVydGljYWwtYWxpZ246IGJvdHRvbTsKfQoKLmV4dC1pZSBpbnB1dC54LXRyZWUtbm9kZS1jYiB7CiAgICBtYXJnaW4tbGVmdDowOwogICAgbWFyZ2luLXRvcDogMXB4OwogICAgd2lkdGg6IDE2cHg7CiAgICBoZWlnaHQ6IDE2cHg7CiAgICB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOwp9CgouZXh0LXN0cmljdCAuZXh0LWllOCBpbnB1dC54LXRyZWUtbm9kZS1jYnsKICAgIG1hcmdpbjogMXB4IDFweDsKICAgIGhlaWdodDogMTRweDsKICAgIHZlcnRpY2FsLWFsaWduOiBib3R0b207Cn0KCi5leHQtc3RyaWN0IC5leHQtaWU4IGlucHV0LngtdHJlZS1ub2RlLWNiICsgYXsKICAgIHZlcnRpY2FsLWFsaWduOiBib3R0b207Cn0KCi5leHQtb3BlcmEgaW5wdXQueC10cmVlLW5vZGUtY2IgewogICAgaGVpZ2h0OiAxNHB4OwogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsKfQoKLngtdHJlZS1ub2ljb24gLngtdHJlZS1ub2RlLWljb257Cgl3aWR0aDowOyBoZWlnaHQ6MDsKfQoKLyogTm8gbGluZSBzdHlsZXMgKi8KLngtdHJlZS1uby1saW5lcyAueC10cmVlLWVsYm93ewoJYmFja2dyb3VuZC1jb2xvcjp0cmFuc3BhcmVudDsKfQoKLngtdHJlZS1uby1saW5lcyAueC10cmVlLWVsYm93LWVuZHsKCWJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7Cn0KCi54LXRyZWUtbm8tbGluZXMgLngtdHJlZS1lbGJvdy1saW5lewoJYmFja2dyb3VuZC1jb2xvcjp0cmFuc3BhcmVudDsKfQoKLyogQXJyb3dzICovCi54LXRyZWUtYXJyb3dzIC54LXRyZWUtZWxib3d7CgliYWNrZ3JvdW5kLWNvbG9yOnRyYW5zcGFyZW50Owp9CgoueC10cmVlLWFycm93cyAueC10cmVlLWVsYm93LXBsdXN7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIDA7Cn0KCi54LXRyZWUtYXJyb3dzIC54LXRyZWUtZWxib3ctbWludXN7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCAtMTZweCAwOwp9CgoueC10cmVlLWFycm93cyAueC10cmVlLWVsYm93LWVuZHsKCWJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7Cn0KCi54LXRyZWUtYXJyb3dzIC54LXRyZWUtZWxib3ctZW5kLXBsdXN7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIDA7Cn0KCi54LXRyZWUtYXJyb3dzIC54LXRyZWUtZWxib3ctZW5kLW1pbnVzewogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQgLTE2cHggMDsKfQoKLngtdHJlZS1hcnJvd3MgLngtdHJlZS1lbGJvdy1saW5lewoJYmFja2dyb3VuZC1jb2xvcjp0cmFuc3BhcmVudDsKfQoKLngtdHJlZS1hcnJvd3MgLngtdHJlZS1lYy1vdmVyIC54LXRyZWUtZWxib3ctcGx1c3sKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTMycHggMDsKfQoKLngtdHJlZS1hcnJvd3MgLngtdHJlZS1lYy1vdmVyIC54LXRyZWUtZWxib3ctbWludXN7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi00OHB4IDA7Cn0KCi54LXRyZWUtYXJyb3dzIC54LXRyZWUtZWMtb3ZlciAueC10cmVlLWVsYm93LWVuZC1wbHVzewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMzJweCAwOwp9CgoueC10cmVlLWFycm93cyAueC10cmVlLWVjLW92ZXIgLngtdHJlZS1lbGJvdy1lbmQtbWludXN7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi00OHB4IDA7Cn0KCi54LXRyZWUtZWxib3ctcGx1cywgLngtdHJlZS1lbGJvdy1taW51cywgLngtdHJlZS1lbGJvdy1lbmQtcGx1cywgLngtdHJlZS1lbGJvdy1lbmQtbWludXN7CgljdXJzb3I6cG9pbnRlcjsKfQoKLmV4dC1pZSB1bC54LXRyZWUtbm9kZS1jdHsKICAgIGZvbnQtc2l6ZTowOwogICAgbGluZS1oZWlnaHQ6MDsKICAgIHpvb206MTsKfQoKLngtdHJlZS1ub2RlewoJd2hpdGUtc3BhY2U6IG5vd3JhcDsKfQoKLngtdHJlZS1ub2RlLWVsIHsKICAgIGxpbmUtaGVpZ2h0OjE4cHg7CiAgICBjdXJzb3I6cG9pbnRlcjsKfQoKLngtdHJlZS1ub2RlIGEsIC54LWRkLWRyYWctZ2hvc3QgYXsKCXRleHQtZGVjb3JhdGlvbjpub25lOwoJLWtodG1sLXVzZXItc2VsZWN0Om5vbmU7CgktbW96LXVzZXItc2VsZWN0Om5vbmU7CiAgICAtd2Via2l0LXVzZXItc2VsZWN0Omlnbm9yZTsKICAgIC1rdGhtbC11c2VyLWZvY3VzOm5vcm1hbDsKICAgIC1tb3otdXNlci1mb2N1czpub3JtYWw7CiAgICAtbW96LW91dGxpbmU6IDAgbm9uZTsKICAgIG91dGxpbmU6MCBub25lOwp9CgoueC10cmVlLW5vZGUgYSBzcGFuLCAueC1kZC1kcmFnLWdob3N0IGEgc3BhbnsKCXRleHQtZGVjb3JhdGlvbjpub25lOwoJcGFkZGluZzoxcHggM3B4IDFweCAycHg7Cn0KCi54LXRyZWUtbm9kZSAueC10cmVlLW5vZGUtZGlzYWJsZWQgLngtdHJlZS1ub2RlLWljb257CgktbW96LW9wYWNpdHk6IDAuNTsKICAgb3BhY2l0eTouNTsKICAgZmlsdGVyOiBhbHBoYShvcGFjaXR5PTUwKTsKfQoKLngtdHJlZS1ub2RlIC54LXRyZWUtbm9kZS1pbmxpbmUtaWNvbnsKCWJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7Cn0KCi54LXRyZWUtbm9kZSBhOmhvdmVyLCAueC1kZC1kcmFnLWdob3N0IGE6aG92ZXJ7Cgl0ZXh0LWRlY29yYXRpb246bm9uZTsKfQoKLngtdHJlZS1ub2RlIGRpdi54LXRyZWUtZHJhZy1pbnNlcnQtYmVsb3d7CiAJIGJvcmRlci1ib3R0b206MXB4IGRvdHRlZDsKfQoKLngtdHJlZS1ub2RlIGRpdi54LXRyZWUtZHJhZy1pbnNlcnQtYWJvdmV7CgkgYm9yZGVyLXRvcDoxcHggZG90dGVkOwp9CgoueC10cmVlLWRkLXVuZGVybGluZSAueC10cmVlLW5vZGUgZGl2LngtdHJlZS1kcmFnLWluc2VydC1iZWxvd3sKIAkgYm9yZGVyLWJvdHRvbTowIG5vbmU7Cn0KCi54LXRyZWUtZGQtdW5kZXJsaW5lIC54LXRyZWUtbm9kZSBkaXYueC10cmVlLWRyYWctaW5zZXJ0LWFib3ZlewoJIGJvcmRlci10b3A6MCBub25lOwp9CgoueC10cmVlLWRkLXVuZGVybGluZSAueC10cmVlLW5vZGUgZGl2LngtdHJlZS1kcmFnLWluc2VydC1iZWxvdyBhewogCSBib3JkZXItYm90dG9tOjJweCBzb2xpZDsKfQoKLngtdHJlZS1kZC11bmRlcmxpbmUgLngtdHJlZS1ub2RlIGRpdi54LXRyZWUtZHJhZy1pbnNlcnQtYWJvdmUgYXsKCSBib3JkZXItdG9wOjJweCBzb2xpZDsKfQoKLngtdHJlZS1ub2RlIC54LXRyZWUtZHJhZy1hcHBlbmQgYSBzcGFuewoJIGJvcmRlcjoxcHggZG90dGVkOwp9CgoueC1kZC1kcmFnLWdob3N0IC54LXRyZWUtbm9kZS1pbmRlbnQsIC54LWRkLWRyYWctZ2hvc3QgLngtdHJlZS1lYy1pY29uewoJZGlzcGxheTpub25lICFpbXBvcnRhbnQ7Cn0KCi8qIEZpeCBmb3IgaWUgcm9vdFZpc2libGU6ZmFsc2UgaXNzdWUgKi8KLngtdHJlZS1yb290LWN0IHsKICAgIHpvb206MTsKfQoueC1kYXRlLXBpY2tlciB7CiAgICBib3JkZXI6IDFweCBzb2xpZDsKICAgIGJvcmRlci10b3A6MCBub25lOwoJcG9zaXRpb246cmVsYXRpdmU7Cn0KCi54LWRhdGUtcGlja2VyIGEgewogICAgLW1vei1vdXRsaW5lOjAgbm9uZTsKICAgIG91dGxpbmU6MCBub25lOwp9CgoueC1kYXRlLWlubmVyLCAueC1kYXRlLWlubmVyIHRkLCAueC1kYXRlLWlubmVyIHRoewogICAgYm9yZGVyLWNvbGxhcHNlOnNlcGFyYXRlOwp9CgoueC1kYXRlLW1pZGRsZSwueC1kYXRlLWxlZnQsLngtZGF0ZS1yaWdodCB7CgliYWNrZ3JvdW5kOiByZXBlYXQteCAwIC04M3B4OwoJb3ZlcmZsb3c6aGlkZGVuOwp9CgoueC1kYXRlLW1pZGRsZSAueC1idG4tdGMsLngtZGF0ZS1taWRkbGUgLngtYnRuLXRsLC54LWRhdGUtbWlkZGxlIC54LWJ0bi10ciwKLngtZGF0ZS1taWRkbGUgLngtYnRuLW1jLC54LWRhdGUtbWlkZGxlIC54LWJ0bi1tbCwueC1kYXRlLW1pZGRsZSAueC1idG4tbXIsCi54LWRhdGUtbWlkZGxlIC54LWJ0bi1iYywueC1kYXRlLW1pZGRsZSAueC1idG4tYmwsLngtZGF0ZS1taWRkbGUgLngtYnRuLWJyewoJYmFja2dyb3VuZDp0cmFuc3BhcmVudCAhaW1wb3J0YW50OwogICAgdmVydGljYWwtYWxpZ246bWlkZGxlOwp9CgoueC1kYXRlLW1pZGRsZSAueC1idG4tbWMgZW0ueC1idG4tYXJyb3cgewogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgMDsKfQoKLngtZGF0ZS1yaWdodCwgLngtZGF0ZS1sZWZ0IHsKICAgIHdpZHRoOjE4cHg7Cn0KCi54LWRhdGUtcmlnaHR7CiAgICB0ZXh0LWFsaWduOnJpZ2h0Owp9CgoueC1kYXRlLW1pZGRsZSB7CiAgICBwYWRkaW5nLXRvcDoycHg7CiAgICBwYWRkaW5nLWJvdHRvbToycHg7CiAgICB3aWR0aDoxMzBweDsgLyogRkYzICovCn0KCi54LWRhdGUtcmlnaHQgYSwgLngtZGF0ZS1sZWZ0IGF7CiAgICBkaXNwbGF5OmJsb2NrOwogICAgd2lkdGg6MTZweDsKCWhlaWdodDoxNnB4OwoJYmFja2dyb3VuZC1wb3NpdGlvbjogY2VudGVyOwoJYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDsKCWN1cnNvcjpwb2ludGVyOwogICAgLW1vei1vcGFjaXR5OiAwLjY7CiAgICBvcGFjaXR5Oi42OwogICAgZmlsdGVyOiBhbHBoYShvcGFjaXR5PTYwKTsKfQoKLngtZGF0ZS1yaWdodCBhOmhvdmVyLCAueC1kYXRlLWxlZnQgYTpob3ZlcnsKICAgIC1tb3otb3BhY2l0eTogMTsKICAgIG9wYWNpdHk6MTsKICAgIGZpbHRlcjogYWxwaGEob3BhY2l0eT0xMDApOwp9CgoueC1pdGVtLWRpc2FibGVkIC54LWRhdGUtcmlnaHQgYTpob3ZlciwgLngtaXRlbS1kaXNhYmxlZCAueC1kYXRlLWxlZnQgYTpob3ZlcnsKICAgIC1tb3otb3BhY2l0eTogMC42OwogICAgb3BhY2l0eTouNjsKICAgIGZpbHRlcjogYWxwaGEob3BhY2l0eT02MCk7Cn0KCi54LWRhdGUtcmlnaHQgYSB7CiAgICBtYXJnaW4tcmlnaHQ6MnB4OwogICAgdGV4dC1kZWNvcmF0aW9uOm5vbmUgIWltcG9ydGFudDsKfQoKLngtZGF0ZS1sZWZ0IGF7CiAgICBtYXJnaW4tbGVmdDoycHg7CiAgICB0ZXh0LWRlY29yYXRpb246bm9uZSAhaW1wb3J0YW50Owp9Cgp0YWJsZS54LWRhdGUtaW5uZXIgewogICAgd2lkdGg6IDEwMCU7CiAgICB0YWJsZS1sYXlvdXQ6Zml4ZWQ7Cn0KCi5leHQtd2Via2l0IHRhYmxlLngtZGF0ZS1pbm5lcnsKICAgIC8qIEZpeCBmb3Igd2Via2l0IGJyb3dzZXJzICovCiAgICB3aWR0aDogMTc1cHg7Cn0KCgoueC1kYXRlLWlubmVyIHRoIHsKICAgIHdpZHRoOjI1cHg7Cn0KCi54LWRhdGUtaW5uZXIgdGggewogICAgYmFja2dyb3VuZDogcmVwZWF0LXggbGVmdCB0b3A7CiAgICB0ZXh0LWFsaWduOnJpZ2h0ICFpbXBvcnRhbnQ7Cglib3JkZXItYm90dG9tOiAxcHggc29saWQ7CgljdXJzb3I6ZGVmYXVsdDsKICAgIHBhZGRpbmc6MDsKICAgIGJvcmRlci1jb2xsYXBzZTpzZXBhcmF0ZTsKfQoKLngtZGF0ZS1pbm5lciB0aCBzcGFuIHsKICAgIGRpc3BsYXk6YmxvY2s7CiAgICBwYWRkaW5nOjJweDsKICAgIHBhZGRpbmctcmlnaHQ6N3B4Owp9CgoueC1kYXRlLWlubmVyIHRkIHsKICAgIGJvcmRlcjogMXB4IHNvbGlkOwoJdGV4dC1hbGlnbjpyaWdodDsKICAgIHBhZGRpbmc6MDsKfQoKLngtZGF0ZS1pbm5lciBhIHsKICAgIHBhZGRpbmc6MnB4IDVweDsKICAgIGRpc3BsYXk6YmxvY2s7Cgl0ZXh0LWRlY29yYXRpb246bm9uZTsKICAgIHRleHQtYWxpZ246cmlnaHQ7CiAgICB6b29tOjE7Cn0KCi54LWRhdGUtaW5uZXIgLngtZGF0ZS1hY3RpdmV7CgljdXJzb3I6cG9pbnRlcjsKCWNvbG9yOmJsYWNrOwp9CgoueC1kYXRlLWlubmVyIC54LWRhdGUtc2VsZWN0ZWQgYXsKCWJhY2tncm91bmQ6IHJlcGVhdC14IGxlZnQgdG9wOwoJYm9yZGVyOjFweCBzb2xpZDsKICAgIHBhZGRpbmc6MXB4IDRweDsKfQoKLngtZGF0ZS1pbm5lciAueC1kYXRlLXRvZGF5IGF7Cglib3JkZXI6IDFweCBzb2xpZDsKICAgIHBhZGRpbmc6MXB4IDRweDsKfQoKLngtZGF0ZS1pbm5lciAueC1kYXRlLXByZXZkYXkgYSwueC1kYXRlLWlubmVyIC54LWRhdGUtbmV4dGRheSBhIHsKICAgIHRleHQtZGVjb3JhdGlvbjpub25lICFpbXBvcnRhbnQ7Cn0KCi54LWRhdGUtYm90dG9tIHsKICAgIHBhZGRpbmc6NHB4OwogICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkOwogICAgYmFja2dyb3VuZDogcmVwZWF0LXggbGVmdCB0b3A7Cn0KCi54LWRhdGUtaW5uZXIgYTpob3ZlciwgLngtZGF0ZS1pbm5lciAueC1kYXRlLWRpc2FibGVkIGE6aG92ZXJ7CiAgICB0ZXh0LWRlY29yYXRpb246bm9uZSAhaW1wb3J0YW50Owp9CgoueC1pdGVtLWRpc2FibGVkIC54LWRhdGUtaW5uZXIgYTpob3ZlcnsKICAgIGJhY2tncm91bmQ6IG5vbmU7Cn0KCi54LWRhdGUtaW5uZXIgLngtZGF0ZS1kaXNhYmxlZCBhIHsKCWN1cnNvcjpkZWZhdWx0Owp9CgoueC1kYXRlLW1lbnUgLngtbWVudS1pdGVtIHsKCXBhZGRpbmc6MXB4IDI0cHggMXB4IDRweDsKCXdoaXRlLXNwYWNlOiBub3dyYXA7Cn0KCi54LWRhdGUtbWVudSAueC1tZW51LWl0ZW0gLngtbWVudS1pdGVtLWljb24gewogICAgd2lkdGg6MTBweDsKICAgIGhlaWdodDoxMHB4OwogICAgbWFyZ2luLXJpZ2h0OjVweDsKICAgIGJhY2tncm91bmQtcG9zaXRpb246Y2VudGVyIC00cHggIWltcG9ydGFudDsKfQoKLngtZGF0ZS1tcCB7Cglwb3NpdGlvbjphYnNvbHV0ZTsKCWxlZnQ6MDsKCXRvcDowOwoJZGlzcGxheTpub25lOwp9CgoueC1kYXRlLW1wIHRkIHsKICAgIHBhZGRpbmc6MnB4OwoJZm9udDpub3JtYWwgMTFweCBhcmlhbCwgaGVsdmV0aWNhLHRhaG9tYSxzYW5zLXNlcmlmOwp9Cgp0ZC54LWRhdGUtbXAtbW9udGgsdGQueC1kYXRlLW1wLXllYXIsdGQueC1kYXRlLW1wLXlidG4gewogICAgYm9yZGVyOiAwIG5vbmU7Cgl0ZXh0LWFsaWduOmNlbnRlcjsKCXZlcnRpY2FsLWFsaWduOiBtaWRkbGU7Cgl3aWR0aDoyNSU7Cn0KCi54LWRhdGUtbXAtb2sgewoJbWFyZ2luLXJpZ2h0OjNweDsKfQoKLngtZGF0ZS1tcC1idG5zIGJ1dHRvbiB7Cgl0ZXh0LWRlY29yYXRpb246bm9uZTsKCXRleHQtYWxpZ246Y2VudGVyOwoJdGV4dC1kZWNvcmF0aW9uOm5vbmUgIWltcG9ydGFudDsKCWJvcmRlcjoxcHggc29saWQ7CglwYWRkaW5nOjFweCAzcHggMXB4OwoJY3Vyc29yOnBvaW50ZXI7Cn0KCi54LWRhdGUtbXAtYnRucyB7CgliYWNrZ3JvdW5kOiByZXBlYXQteCBsZWZ0IHRvcDsKfQoKLngtZGF0ZS1tcC1idG5zIHRkIHsKCWJvcmRlci10b3A6IDFweCBzb2xpZDsKICAgIHRleHQtYWxpZ246Y2VudGVyOwp9Cgp0ZC54LWRhdGUtbXAtbW9udGggYSx0ZC54LWRhdGUtbXAteWVhciBhIHsKCWRpc3BsYXk6YmxvY2s7CglwYWRkaW5nOjJweCA0cHg7Cgl0ZXh0LWRlY29yYXRpb246bm9uZTsKCXRleHQtYWxpZ246Y2VudGVyOwp9Cgp0ZC54LWRhdGUtbXAtbW9udGggYTpob3Zlcix0ZC54LWRhdGUtbXAteWVhciBhOmhvdmVyIHsKCXRleHQtZGVjb3JhdGlvbjpub25lOwoJY3Vyc29yOnBvaW50ZXI7Cn0KCnRkLngtZGF0ZS1tcC1zZWwgYSB7CglwYWRkaW5nOjFweCAzcHg7CgliYWNrZ3JvdW5kOiByZXBlYXQteCBsZWZ0IHRvcDsKCWJvcmRlcjoxcHggc29saWQ7Cn0KCi54LWRhdGUtbXAteWJ0biBhIHsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHdpZHRoOjE1cHg7CiAgICBoZWlnaHQ6MTVweDsKICAgIGN1cnNvcjpwb2ludGVyOwogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQ7CiAgICBkaXNwbGF5OmJsb2NrOwogICAgbWFyZ2luOjAgYXV0bzsKfQoKLngtZGF0ZS1tcC15YnRuIGEueC1kYXRlLW1wLW5leHQgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0xMjBweDsKfQoKLngtZGF0ZS1tcC15YnRuIGEueC1kYXRlLW1wLW5leHQ6aG92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMTIwcHg7Cn0KCi54LWRhdGUtbXAteWJ0biBhLngtZGF0ZS1tcC1wcmV2IHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMTA1cHg7Cn0KCi54LWRhdGUtbXAteWJ0biBhLngtZGF0ZS1tcC1wcmV2OmhvdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTEwNXB4Owp9CgoueC1kYXRlLW1wLXlidG4gewogICB0ZXh0LWFsaWduOmNlbnRlcjsKfQoKdGQueC1kYXRlLW1wLXNlcCB7CiAgIGJvcmRlci1yaWdodDoxcHggc29saWQ7Cn0ueC10aXB7Cglwb3NpdGlvbjogYWJzb2x1dGU7Cgl0b3A6IDA7CiAgICBsZWZ0OjA7CiAgICB2aXNpYmlsaXR5OiBoaWRkZW47Cgl6LWluZGV4OiAyMDAwMjsKICAgIGJvcmRlcjowIG5vbmU7Cn0KCi54LXRpcCAueC10aXAtY2xvc2V7CgloZWlnaHQ6IDE1cHg7CglmbG9hdDpyaWdodDsKCXdpZHRoOiAxNXB4OwogICAgbWFyZ2luOjAgMCAycHggMnB4OwogICAgY3Vyc29yOnBvaW50ZXI7CiAgICBkaXNwbGF5Om5vbmU7Cn0KCi54LXRpcCAueC10aXAtdGMgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IDAgLTYycHg7CglwYWRkaW5nLXRvcDozcHg7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICB6b29tOjE7Cn0KCi54LXRpcCAueC10aXAtdGwgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IDAgMDsKCXBhZGRpbmctbGVmdDo2cHg7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICB6b29tOjE7Cn0KCi54LXRpcCAueC10aXAtdHIgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IHJpZ2h0IDA7CglwYWRkaW5nLXJpZ2h0OjZweDsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKfQoKLngtdGlwIC54LXRpcC1iYyB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgMCAtMTIxcHg7CgloZWlnaHQ6M3B4OwogICAgb3ZlcmZsb3c6aGlkZGVuOwp9CgoueC10aXAgLngtdGlwLWJsIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIC01OXB4OwoJcGFkZGluZy1sZWZ0OjZweDsKICAgIHpvb206MTsKfQoKLngtdGlwIC54LXRpcC1iciB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgLTU5cHg7CglwYWRkaW5nLXJpZ2h0OjZweDsKICAgIHpvb206MTsKfQoKLngtdGlwIC54LXRpcC1tYyB7CiAgICBib3JkZXI6MCBub25lOwp9CgoueC10aXAgLngtdGlwLW1sIHsKCWJhY2tncm91bmQ6IG5vLXJlcGVhdCAwIC0xMjRweDsKCXBhZGRpbmctbGVmdDo2cHg7CiAgICB6b29tOjE7Cn0KCi54LXRpcCAueC10aXAtbXIgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IHJpZ2h0IC0xMjRweDsKCXBhZGRpbmctcmlnaHQ6NnB4OwogICAgem9vbToxOwp9CgouZXh0LWllIC54LXRpcCAueC10aXAtaGVhZGVyLC5leHQtaWUgLngtdGlwIC54LXRpcC10YyB7CiAgICBmb250LXNpemU6MDsKICAgIGxpbmUtaGVpZ2h0OjA7Cn0KCi5leHQtYm9yZGVyLWJveCAueC10aXAgLngtdGlwLWhlYWRlciwgLmV4dC1ib3JkZXItYm94IC54LXRpcCAueC10aXAtdGN7CiAgICBsaW5lLWhlaWdodDogMXB4Owp9CgoueC10aXAgLngtdGlwLWhlYWRlci10ZXh0IHsKICAgIHBhZGRpbmc6MDsKICAgIG1hcmdpbjowIDAgMnB4IDA7Cn0KCi54LXRpcCAueC10aXAtYm9keSB7CiAgICBtYXJnaW46MCAhaW1wb3J0YW50OwogICAgbGluZS1oZWlnaHQ6MTRweDsKICAgIHBhZGRpbmc6MDsKfQoKLngtdGlwIC54LXRpcC1ib2R5IC5sb2FkaW5nLWluZGljYXRvciB7CiAgICBtYXJnaW46MDsKfQoKLngtdGlwLWRyYWdnYWJsZSAueC10aXAtaGVhZGVyLC54LXRpcC1kcmFnZ2FibGUgLngtdGlwLWhlYWRlci10ZXh0IHsKICAgIGN1cnNvcjptb3ZlOwp9CgoueC1mb3JtLWludmFsaWQtdGlwIC54LXRpcC10YyB7CgliYWNrZ3JvdW5kOiByZXBlYXQteCAwIC0xMnB4OwogICAgcGFkZGluZy10b3A6NnB4Owp9CgoueC1mb3JtLWludmFsaWQtdGlwIC54LXRpcC1iYyB7CgliYWNrZ3JvdW5kOiByZXBlYXQteCAwIC0xOHB4OwogICAgaGVpZ2h0OjZweDsKfQoKLngtZm9ybS1pbnZhbGlkLXRpcCAueC10aXAtYmwgewoJYmFja2dyb3VuZDogbm8tcmVwZWF0IDAgLTZweDsKfQoKLngtZm9ybS1pbnZhbGlkLXRpcCAueC10aXAtYnIgewoJYmFja2dyb3VuZDogbm8tcmVwZWF0IHJpZ2h0IC02cHg7Cn0KCi54LWZvcm0taW52YWxpZC10aXAgLngtdGlwLWJvZHkgewogICAgcGFkZGluZzoycHg7Cn0KCi54LWZvcm0taW52YWxpZC10aXAgLngtdGlwLWJvZHkgewogICAgcGFkZGluZy1sZWZ0OjI0cHg7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCAycHggMnB4Owp9CgoueC10aXAtYW5jaG9yIHsKICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICAgIHdpZHRoOiA5cHg7CiAgICBoZWlnaHQ6IDEwcHg7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgMCAwOwogICAgem9vbToxOwp9Ci54LXRpcC1hbmNob3ItYm90dG9tIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IC05cHggMDsKfQoueC10aXAtYW5jaG9yLXJpZ2h0IHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IC0xOHB4IDA7CiAgICB3aWR0aDogMTBweDsKfQoueC10aXAtYW5jaG9yLWxlZnQgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogLTI4cHggMDsKICAgIHdpZHRoOiAxMHB4Owp9LngtbWVudSB7Cgl6LWluZGV4OiAxNTAwMDsKCXpvb206IDE7CgliYWNrZ3JvdW5kOiByZXBlYXQteTsKfQoKLngtbWVudS1mbG9hdGluZ3sKICAgIGJvcmRlcjogMXB4IHNvbGlkOwp9CgoueC1tZW51IGEgewogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lICFpbXBvcnRhbnQ7Cn0KCi5leHQtaWUgLngtbWVudSB7CiAgICB6b29tOjE7CiAgICBvdmVyZmxvdzpoaWRkZW47Cn0KCi54LW1lbnUtbGlzdHsKICAgIHBhZGRpbmc6IDJweDsKCWJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7Cglib3JkZXI6MCBub25lOwogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgb3ZlcmZsb3cteTogaGlkZGVuOwp9CgouZXh0LXN0cmljdCAuZXh0LWllIC54LW1lbnUtbGlzdHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQoKLngtbWVudSBsaXsKCWxpbmUtaGVpZ2h0OjEwMCU7Cn0KCi54LW1lbnUgbGkueC1tZW51LXNlcC1saXsKCWZvbnQtc2l6ZToxcHg7CglsaW5lLWhlaWdodDoxcHg7Cn0KCi54LW1lbnUtbGlzdC1pdGVtewogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKCWRpc3BsYXk6YmxvY2s7CglwYWRkaW5nOjFweDsKfQoKLngtbWVudS1pdGVtewogICAgLW1vei11c2VyLXNlbGVjdDogbm9uZTsKICAgIC1raHRtbC11c2VyLXNlbGVjdDpub25lOwogICAgLXdlYmtpdC11c2VyLXNlbGVjdDppZ25vcmU7Cn0KCi54LW1lbnUtaXRlbS1hcnJvd3sKCWJhY2tncm91bmQ6dHJhbnNwYXJlbnQgbm8tcmVwZWF0IHJpZ2h0Owp9CgoueC1tZW51LXNlcCB7CglkaXNwbGF5OmJsb2NrOwoJZm9udC1zaXplOjFweDsKCWxpbmUtaGVpZ2h0OjFweDsKCW1hcmdpbjogMnB4IDNweDsKCWJvcmRlci1ib3R0b206MXB4IHNvbGlkOwogICAgb3ZlcmZsb3c6aGlkZGVuOwp9CgoueC1tZW51LWZvY3VzIHsKCXBvc2l0aW9uOmFic29sdXRlOwoJbGVmdDotMXB4OwoJdG9wOi0xcHg7Cgl3aWR0aDoxcHg7CgloZWlnaHQ6MXB4OwogICAgbGluZS1oZWlnaHQ6MXB4OwogICAgZm9udC1zaXplOjFweDsKICAgIC1tb3otb3V0bGluZTowIG5vbmU7CiAgICBvdXRsaW5lOjAgbm9uZTsKICAgIC1tb3otdXNlci1zZWxlY3Q6IG5vbmU7CiAgICAta2h0bWwtdXNlci1zZWxlY3Q6bm9uZTsKICAgIC13ZWJraXQtdXNlci1zZWxlY3Q6aWdub3JlOwogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgZGlzcGxheTpibG9jazsKfQoKYS54LW1lbnUtaXRlbSB7CiAgICBjdXJzb3I6IHBvaW50ZXI7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGxpbmUtaGVpZ2h0OiAxNnB4OwogICAgb3V0bGluZS1jb2xvcjogLW1vei11c2UtdGV4dC1jb2xvcjsKICAgIG91dGxpbmUtc3R5bGU6IG5vbmU7CiAgICBvdXRsaW5lLXdpZHRoOiAwOwogICAgcGFkZGluZzogM3B4IDIxcHggM3B4IDI3cHg7CiAgICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7CiAgICB3aGl0ZS1zcGFjZTogbm93cmFwOwp9CgoueC1tZW51LWl0ZW0tYWN0aXZlIHsKICAgIGJhY2tncm91bmQtcmVwZWF0OiByZXBlYXQteDsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IGxlZnQgYm90dG9tOwogICAgYm9yZGVyLXN0eWxlOnNvbGlkOwogICAgYm9yZGVyLXdpZHRoOiAxcHggMDsKICAgIG1hcmdpbjowIDFweDsKCXBhZGRpbmc6IDA7Cn0KCi54LW1lbnUtaXRlbS1hY3RpdmUgYS54LW1lbnUtaXRlbSB7CiAgICBib3JkZXItc3R5bGU6c29saWQ7CiAgICBib3JkZXItd2lkdGg6MCAxcHg7CiAgICBtYXJnaW46MCAtMXB4Owp9CgoueC1tZW51LWl0ZW0taWNvbiB7Cglib3JkZXI6IDAgbm9uZTsKCWhlaWdodDogMTZweDsKCXBhZGRpbmc6IDA7Cgl2ZXJ0aWNhbC1hbGlnbjogdG9wOwoJd2lkdGg6IDE2cHg7Cglwb3NpdGlvbjogYWJzb2x1dGU7CiAgICBsZWZ0OiAzcHg7CiAgICB0b3A6IDNweDsKICAgIG1hcmdpbjogMDsKICAgIGJhY2tncm91bmQtcG9zaXRpb246Y2VudGVyOwp9CgouZXh0LWllIC54LW1lbnUtaXRlbS1pY29uIHsKICAgIGxlZnQ6IC0yNHB4Owp9Ci5leHQtc3RyaWN0IC54LW1lbnUtaXRlbS1pY29uIHsKICAgIGxlZnQ6IDNweDsKfQoKLmV4dC1pZTYgLngtbWVudS1pdGVtLWljb24gewogICAgbGVmdDogLTI0cHg7Cn0KCi5leHQtaWUgLngtbWVudS1pdGVtLWljb24gewogICAgdmVydGljYWwtYWxpZ246IG1pZGRsZTsKfQoKLngtbWVudS1jaGVjay1pdGVtIC54LW1lbnUtaXRlbS1pY29uewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IGNlbnRlcjsKfQoKLngtbWVudS1ncm91cC1pdGVtIC54LW1lbnUtaXRlbS1pY29uewoJYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi54LW1lbnUtaXRlbS1jaGVja2VkIC54LW1lbnUtZ3JvdXAtaXRlbSAueC1tZW51LWl0ZW0taWNvbnsKICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCBjZW50ZXI7Cn0KCi54LWRhdGUtbWVudSAueC1tZW51LWxpc3R7CiAgICBwYWRkaW5nOiAwOwp9CgoueC1tZW51LWRhdGUtaXRlbXsKCXBhZGRpbmc6MDsKfQoKLngtbWVudSAueC1jb2xvci1wYWxldHRlLCAueC1tZW51IC54LWRhdGUtcGlja2VyewogICAgbWFyZ2luLWxlZnQ6IDI2cHg7CgltYXJnaW4tcmlnaHQ6NHB4Owp9CgoueC1tZW51IC54LWRhdGUtcGlja2VyewogICAgYm9yZGVyOjFweCBzb2xpZDsKICAgIG1hcmdpbi10b3A6MnB4OwogICAgbWFyZ2luLWJvdHRvbToycHg7Cn0KCi54LW1lbnUtcGxhaW4gLngtY29sb3ItcGFsZXR0ZSwgLngtbWVudS1wbGFpbiAueC1kYXRlLXBpY2tlcnsKCSBtYXJnaW46IDA7CgkgYm9yZGVyOiAwIG5vbmU7Cn0KCi54LWRhdGUtbWVudSB7CiAgIHBhZGRpbmc6MCAhaW1wb3J0YW50Owp9CgovKgogKiBmaXhlcyBzZXBhcmF0b3IgdmlzaWJpbGl0eSBwcm9ibGVtIGluIElFIDYKICovCi5leHQtc3RyaWN0IC5leHQtaWU2IC54LW1lbnUtc2VwLWxpIHsKICAgIHBhZGRpbmc6IDNweCA0cHg7Cn0KLmV4dC1zdHJpY3QgLmV4dC1pZTYgLngtbWVudS1zZXAgewogICAgbWFyZ2luOiAwOwogICAgaGVpZ2h0OiAxcHg7Cn0KCi8qCiAqIEZpeGVzIGFuIGlzc3VlIHdpdGggImZhdCIgc2VwYXJhdG9ycyBpbiB3ZWJraXQKICovCi5leHQtd2Via2l0IC54LW1lbnUtc2VwewogICAgaGVpZ2h0OiAxcHg7Cn0KCi8qCiAqIFVnbHkgbWVzcyB0byByZW1vdmUgdGhlIHdoaXRlIGJvcmRlciB1bmRlciB0aGUgcGlja2VyCiAqLwouZXh0LWllIC54LWRhdGUtbWVudXsKICAgIGhlaWdodDogMTk5cHg7Cn0KCi5leHQtc3RyaWN0IC5leHQtaWUgLngtZGF0ZS1tZW51LCAuZXh0LWJvcmRlci1ib3ggLmV4dC1pZTggLngtZGF0ZS1tZW51ewogICAgaGVpZ2h0OiAxOTdweDsKfQoKLmV4dC1zdHJpY3QgLmV4dC1pZTcgLngtZGF0ZS1tZW51ewogICAgaGVpZ2h0OiAxOTVweDsKfQoKLmV4dC1zdHJpY3QgLmV4dC1pZTggLngtZGF0ZS1tZW51ewogICAgaGVpZ2h0OiBhdXRvOwp9CgoueC1jeWNsZS1tZW51IC54LW1lbnUtaXRlbS1jaGVja2VkIHsKICAgIGJvcmRlcjoxcHggZG90dGVkICFpbXBvcnRhbnQ7CglwYWRkaW5nOjA7Cn0KCi54LW1lbnUgLngtbWVudS1zY3JvbGxlciB7CiAgICB3aWR0aDogMTAwJTsKCWJhY2tncm91bmQtcmVwZWF0Om5vLXJlcGVhdDsKCWJhY2tncm91bmQtcG9zaXRpb246Y2VudGVyOwoJaGVpZ2h0OjhweDsKICAgIGxpbmUtaGVpZ2h0OiA4cHg7CgljdXJzb3I6cG9pbnRlcjsKICAgIG1hcmdpbjogMDsKICAgIHBhZGRpbmc6IDA7Cn0KCi54LW1lbnUgLngtbWVudS1zY3JvbGxlci1hY3RpdmV7CiAgICBoZWlnaHQ6IDZweDsKICAgIGxpbmUtaGVpZ2h0OiA2cHg7Cn0KCi54LW1lbnUtbGlzdC1pdGVtLWluZGVudHsKICAgIHBhZGRpbmctbGVmdDogMjdweDsKfS8qCiBDcmVhdGVzIHJvdW5kZWQsIHJhaXNlZCBib3hlcyBsaWtlIG9uIHRoZSBFeHQgd2Vic2l0ZSAtIHRoZSBtYXJrdXAgaXNuJ3QgcHJldHR5OgogIDxkaXYgY2xhc3M9IngtYm94LWJsdWUiPgogICAgICAgIDxkaXYgY2xhc3M9IngtYm94LXRsIj48ZGl2IGNsYXNzPSJ4LWJveC10ciI+PGRpdiBjbGFzcz0ieC1ib3gtdGMiPjwvZGl2PjwvZGl2PjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9IngtYm94LW1sIj48ZGl2IGNsYXNzPSJ4LWJveC1tciI+PGRpdiBjbGFzcz0ieC1ib3gtbWMiPgogICAgICAgICAgICA8aDM+WU9VUiBUSVRMRSBIRVJFIChvcHRpb25hbCk8L2gzPgogICAgICAgICAgICA8ZGl2PllPVVIgQ09OVEVOVCBIRVJFPC9kaXY+CiAgICAgICAgPC9kaXY+PC9kaXY+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0ieC1ib3gtYmwiPjxkaXYgY2xhc3M9IngtYm94LWJyIj48ZGl2IGNsYXNzPSJ4LWJveC1iYyI+PC9kaXY+PC9kaXY+PC9kaXY+CiAgICA8L2Rpdj4KICovCgoueC1ib3gtdGwgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IDAgMDsKICAgIHpvb206MTsKfQoKLngtYm94LXRjIHsKCWhlaWdodDogOHB4OwoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgcmVwZWF0LXggMCAwOwoJb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLngtYm94LXRyIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCByaWdodCAtOHB4Owp9CgoueC1ib3gtbWwgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgcmVwZWF0LXkgMDsKCXBhZGRpbmctbGVmdDogNHB4OwoJb3ZlcmZsb3c6IGhpZGRlbjsKICAgIHpvb206MTsKfQoKLngtYm94LW1jIHsKCWJhY2tncm91bmQ6IHJlcGVhdC14IDAgLTE2cHg7CglwYWRkaW5nOiA0cHggMTBweDsKfQoKLngtYm94LW1jIGgzIHsKCW1hcmdpbjogMCAwIDRweCAwOwogICAgem9vbToxOwp9CgoueC1ib3gtbXIgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgcmVwZWF0LXkgcmlnaHQ7CglwYWRkaW5nLXJpZ2h0OiA0cHg7CglvdmVyZmxvdzogaGlkZGVuOwp9CgoueC1ib3gtYmwgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IDAgLTE2cHg7CiAgICB6b29tOjE7Cn0KCi54LWJveC1iYyB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCByZXBlYXQteCAwIC04cHg7CgloZWlnaHQ6IDhweDsKCW92ZXJmbG93OiBoaWRkZW47Cn0KCi54LWJveC1iciB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgLTI0cHg7Cn0KCi54LWJveC10bCwgLngtYm94LWJsIHsKCXBhZGRpbmctbGVmdDogOHB4OwoJb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLngtYm94LXRyLCAueC1ib3gtYnIgewoJcGFkZGluZy1yaWdodDogOHB4OwoJb3ZlcmZsb3c6IGhpZGRlbjsKfS54LWNvbWJvLWxpc3QgewogICAgYm9yZGVyOjFweCBzb2xpZDsKICAgIHpvb206MTsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoKLngtY29tYm8tbGlzdC1pbm5lciB7CiAgICBvdmVyZmxvdzphdXRvOwogICAgcG9zaXRpb246cmVsYXRpdmU7IC8qIGZvciBjYWxjdWxhdGluZyBzY3JvbGwgb2Zmc2V0cyAqLwogICAgem9vbToxOwogICAgb3ZlcmZsb3cteDpoaWRkZW47Cn0KCi54LWNvbWJvLWxpc3QtaGQgewogICAgYm9yZGVyLWJvdHRvbToxcHggc29saWQ7CiAgICBwYWRkaW5nOjNweDsKfQoKLngtcmVzaXphYmxlLXBpbm5lZCAueC1jb21iby1saXN0LWlubmVyIHsKICAgIGJvcmRlci1ib3R0b206MXB4IHNvbGlkOwp9CgoueC1jb21iby1saXN0LWl0ZW0gewogICAgcGFkZGluZzoycHg7CiAgICBib3JkZXI6MXB4IHNvbGlkOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwp9CgoueC1jb21iby1saXN0IC54LWNvbWJvLXNlbGVjdGVkewoJYm9yZGVyOjFweCBkb3R0ZWQgIWltcG9ydGFudDsKICAgIGN1cnNvcjpwb2ludGVyOwp9CgoueC1jb21iby1saXN0IC54LXRvb2xiYXIgewogICAgYm9yZGVyLXRvcDoxcHggc29saWQ7CiAgICBib3JkZXItYm90dG9tOjAgbm9uZTsKfS54LXBhbmVsIHsKICAgIGJvcmRlci1zdHlsZTogc29saWQ7CiAgICBib3JkZXItd2lkdGg6MDsKfQoKLngtcGFuZWwtaGVhZGVyIHsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKICAgIHBhZGRpbmc6NXB4IDNweCA0cHggNXB4OwogICAgYm9yZGVyOjFweCBzb2xpZDsKICAgIGxpbmUtaGVpZ2h0OiAxNXB4OwogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgcmVwZWF0LXggMCAtMXB4Owp9CgoueC1wYW5lbC1ib2R5IHsKICAgIGJvcmRlcjoxcHggc29saWQ7CiAgICBib3JkZXItdG9wOjAgbm9uZTsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsgLyogYWRkZWQgZm9yIGl0ZW0gc2Nyb2xsIHBvc2l0aW9uaW5nICovCn0KCi54LXBhbmVsLWJiYXIgLngtdG9vbGJhciwgLngtcGFuZWwtdGJhciAueC10b29sYmFyIHsKICAgIGJvcmRlcjoxcHggc29saWQ7CiAgICBib3JkZXItdG9wOjAgbm9uZTsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHBhZGRpbmc6MnB4Owp9CgoueC1wYW5lbC10YmFyLW5vaGVhZGVyIC54LXRvb2xiYXIsIC54LXBhbmVsLW1jIC54LXBhbmVsLXRiYXIgLngtdG9vbGJhciB7CiAgICBib3JkZXItdG9wOjFweCBzb2xpZDsKICAgIGJvcmRlci1ib3R0b206IDAgbm9uZTsKfQoKLngtcGFuZWwtYm9keS1ub2hlYWRlciwgLngtcGFuZWwtbWMgLngtcGFuZWwtYm9keSB7CiAgICBib3JkZXItdG9wOjFweCBzb2xpZDsKfQoKLngtcGFuZWwtaGVhZGVyIHsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKfQoKLngtcGFuZWwtdGwgLngtcGFuZWwtaGVhZGVyIHsKICAgIHBhZGRpbmc6NXB4IDAgNHB4IDA7CiAgICBib3JkZXI6MCBub25lOwogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQ7Cn0KCi54LXBhbmVsLXRsIC54LXBhbmVsLWljb24sIC54LXdpbmRvdy10bCAueC1wYW5lbC1pY29uIHsKICAgIHBhZGRpbmctbGVmdDoyMHB4ICFpbXBvcnRhbnQ7CiAgICBiYWNrZ3JvdW5kLXJlcGVhdDpuby1yZXBlYXQ7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgNHB4OwogICAgem9vbToxOwp9CgoueC1wYW5lbC1pbmxpbmUtaWNvbiB7CiAgICB3aWR0aDoxNnB4OwoJaGVpZ2h0OjE2cHg7CiAgICBiYWNrZ3JvdW5kLXJlcGVhdDpuby1yZXBlYXQ7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgMDsKCXZlcnRpY2FsLWFsaWduOm1pZGRsZTsKCW1hcmdpbi1yaWdodDo0cHg7CgltYXJnaW4tdG9wOi0xcHg7CgltYXJnaW4tYm90dG9tOi0xcHg7Cn0KCi54LXBhbmVsLXRjIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC14IDAgMDsKCW92ZXJmbG93OmhpZGRlbjsKfQoKLyogZml4IGllNyBzdHJpY3QgbW9kZSBidWcgKi8KLmV4dC1zdHJpY3QgLmV4dC1pZTcgLngtcGFuZWwtdGMgewogICAgb3ZlcmZsb3c6IHZpc2libGU7Cn0KCi54LXBhbmVsLXRsIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIDA7CglwYWRkaW5nLWxlZnQ6NnB4OwogICAgem9vbToxOwogICAgYm9yZGVyLWJvdHRvbToxcHggc29saWQ7Cn0KCi54LXBhbmVsLXRyIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCByaWdodCAwOwoJem9vbToxOwogICAgcGFkZGluZy1yaWdodDo2cHg7Cn0KCi54LXBhbmVsLWJjIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC14IDAgYm90dG9tOwogICAgem9vbToxOwp9CgoueC1wYW5lbC1iYyAueC1wYW5lbC1mb290ZXIgewogICAgem9vbToxOwp9CgoueC1wYW5lbC1ibCB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgMCBib3R0b207CglwYWRkaW5nLWxlZnQ6NnB4OwogICAgem9vbToxOwp9CgoueC1wYW5lbC1iciB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgYm90dG9tOwoJcGFkZGluZy1yaWdodDo2cHg7CiAgICB6b29tOjE7Cn0KCi54LXBhbmVsLW1jIHsKICAgIGJvcmRlcjowIG5vbmU7CiAgICBwYWRkaW5nOjA7CiAgICBtYXJnaW46MDsKICAgIHBhZGRpbmctdG9wOjZweDsKfQoKLngtcGFuZWwtbWMgLngtcGFuZWwtYm9keSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOnRyYW5zcGFyZW50OwogICAgYm9yZGVyOiAwIG5vbmU7Cn0KCi54LXBhbmVsLW1sIHsKCWJhY2tncm91bmQ6IHJlcGVhdC15IDAgMDsKCXBhZGRpbmctbGVmdDo2cHg7CiAgICB6b29tOjE7Cn0KCi54LXBhbmVsLW1yIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC15IHJpZ2h0IDA7CglwYWRkaW5nLXJpZ2h0OjZweDsKICAgIHpvb206MTsKfQoKLngtcGFuZWwtYmMgLngtcGFuZWwtZm9vdGVyIHsKICAgIHBhZGRpbmctYm90dG9tOjZweDsKfQoKLngtcGFuZWwtbm9mb290ZXIgLngtcGFuZWwtYmMsIC54LXBhbmVsLW5vZm9vdGVyIC54LXdpbmRvdy1iYyB7CgloZWlnaHQ6NnB4OwogICAgZm9udC1zaXplOjA7CiAgICBsaW5lLWhlaWdodDowOwp9CgoueC1wYW5lbC1id3JhcCB7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICB6b29tOjE7CiAgICBsZWZ0OjA7CiAgICB0b3A6MDsKfQoueC1wYW5lbC1ib2R5IHsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKfQoKLngtcGFuZWwtY29sbGFwc2VkIC54LXJlc2l6YWJsZS1oYW5kbGV7CiAgICBkaXNwbGF5Om5vbmU7Cn0KCi5leHQtZ2Vja28gLngtcGFuZWwtYW5pbWF0ZWQgZGl2IHsKICAgIG92ZXJmbG93OmhpZGRlbiAhaW1wb3J0YW50Owp9CgovKiBQbGFpbiAqLwoueC1wbGFpbi1ib2R5IHsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoKLngtcGxhaW4tYmJhciAueC10b29sYmFyIHsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHBhZGRpbmc6MnB4Owp9CgoueC1wbGFpbi10YmFyIC54LXRvb2xiYXIgewogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgcGFkZGluZzoycHg7Cn0KCi54LXBsYWluLWJ3cmFwIHsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKfQoKLngtcGxhaW4gewogICAgb3ZlcmZsb3c6aGlkZGVuOwp9CgovKiBUb29scyAqLwoueC10b29sIHsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHdpZHRoOjE1cHg7CiAgICBoZWlnaHQ6MTVweDsKICAgIGZsb2F0OnJpZ2h0OwogICAgY3Vyc29yOnBvaW50ZXI7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdDsKICAgIG1hcmdpbi1sZWZ0OjJweDsKfQoKLyogZXhwYW5kIC8gY29sbGFwc2UgdG9vbHMgKi8KLngtdG9vbC10b2dnbGUgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC02MHB4Owp9CgoueC10b29sLXRvZ2dsZS1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTYwcHg7Cn0KCi54LXBhbmVsLWNvbGxhcHNlZCAueC10b29sLXRvZ2dsZSB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTc1cHg7Cn0KCi54LXBhbmVsLWNvbGxhcHNlZCAueC10b29sLXRvZ2dsZS1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTc1cHg7Cn0KCgoueC10b29sLWNsb3NlIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMDsKfQoKLngtdG9vbC1jbG9zZS1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggMDsKfQoKLngtdG9vbC1taW5pbWl6ZSB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTE1cHg7Cn0KCi54LXRvb2wtbWluaW1pemUtb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNXB4IC0xNXB4Owp9CgoueC10b29sLW1heGltaXplIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMzBweDsKfQoKLngtdG9vbC1tYXhpbWl6ZS1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTMwcHg7Cn0KCi54LXRvb2wtcmVzdG9yZSB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTQ1cHg7Cn0KCi54LXRvb2wtcmVzdG9yZS1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTQ1cHg7Cn0KCi54LXRvb2wtZ2VhciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTkwcHg7Cn0KCi54LXRvb2wtZ2Vhci1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTkwcHg7Cn0KCi54LXRvb2wtcHJldiB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTEwNXB4Owp9CgoueC10b29sLXByZXYtb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNXB4IC0xMDVweDsKfQoKLngtdG9vbC1uZXh0IHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMTIwcHg7Cn0KCi54LXRvb2wtbmV4dC1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTEyMHB4Owp9CgoueC10b29sLXBpbiB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTEzNXB4Owp9CgoueC10b29sLXBpbi1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTEzNXB4Owp9CgoueC10b29sLXVucGluIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMTUwcHg7Cn0KCi54LXRvb2wtdW5waW4tb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNXB4IC0xNTBweDsKfQoKLngtdG9vbC1yaWdodCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTE2NXB4Owp9CgoueC10b29sLXJpZ2h0LW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMTY1cHg7Cn0KCi54LXRvb2wtbGVmdCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTE4MHB4Owp9CgoueC10b29sLWxlZnQtb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNXB4IC0xODBweDsKfQoKLngtdG9vbC1kb3duIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMTk1cHg7Cn0KCi54LXRvb2wtZG93bi1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTE5NXB4Owp9CgoueC10b29sLXVwIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMjEwcHg7Cn0KCi54LXRvb2wtdXAtb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNXB4IC0yMTBweDsKfQoKLngtdG9vbC1yZWZyZXNoIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMjI1cHg7Cn0KCi54LXRvb2wtcmVmcmVzaC1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTIyNXB4Owp9CgoueC10b29sLXBsdXMgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0yNDBweDsKfQoKLngtdG9vbC1wbHVzLW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMjQwcHg7Cn0KCi54LXRvb2wtbWludXMgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0yNTVweDsKfQoKLngtdG9vbC1taW51cy1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTI1NXB4Owp9CgoueC10b29sLXNlYXJjaCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTI3MHB4Owp9CgoueC10b29sLXNlYXJjaC1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTI3MHB4Owp9CgoueC10b29sLXNhdmUgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0yODVweDsKfQoKLngtdG9vbC1zYXZlLW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMjg1cHg7Cn0KCi54LXRvb2wtaGVscCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTMwMHB4Owp9CgoueC10b29sLWhlbHAtb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNXB4IC0zMDBweDsKfQoKLngtdG9vbC1wcmludCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTMxNXB4Owp9CgoueC10b29sLXByaW50LW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMzE1cHg7Cn0KCi54LXRvb2wtZXhwYW5kIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMzMwcHg7Cn0KCi54LXRvb2wtZXhwYW5kLW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMzMwcHg7Cn0KCi54LXRvb2wtY29sbGFwc2UgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0zNDVweDsKfQoKLngtdG9vbC1jb2xsYXBzZS1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTM0NXB4Owp9CgoueC10b29sLXJlc2l6ZSB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTM2MHB4Owp9CgoueC10b29sLXJlc2l6ZS1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTM2MHB4Owp9CgoueC10b29sLW1vdmUgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0zNzVweDsKfQoKLngtdG9vbC1tb3ZlLW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMzc1cHg7Cn0KCi8qIEdob3N0aW5nICovCi54LXBhbmVsLWdob3N0IHsKICAgIHotaW5kZXg6MTIwMDA7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgIGxlZnQ6MDt0b3A6MDsKICAgIG9wYWNpdHk6LjY1OwogICAgLW1vei1vcGFjaXR5Oi42NTsKICAgIGZpbHRlcjphbHBoYShvcGFjaXR5PTY1KTsKfQoKLngtcGFuZWwtZ2hvc3QgdWwgewogICAgbWFyZ2luOjA7CiAgICBwYWRkaW5nOjA7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICBmb250LXNpemU6MDsKICAgIGxpbmUtaGVpZ2h0OjA7CiAgICBib3JkZXI6MXB4IHNvbGlkOwogICAgYm9yZGVyLXRvcDowIG5vbmU7CiAgICBkaXNwbGF5OmJsb2NrOwp9CgoueC1wYW5lbC1naG9zdCAqIHsKICAgIGN1cnNvcjptb3ZlICFpbXBvcnRhbnQ7Cn0KCi54LXBhbmVsLWRkLXNwYWNlciB7CiAgICBib3JkZXI6MnB4IGRhc2hlZDsKfQoKLyogQnV0dG9ucyAqLwoueC1wYW5lbC1idG5zIHsKICAgIHBhZGRpbmc6NXB4OwogICAgb3ZlcmZsb3c6aGlkZGVuOwp9CgoueC1wYW5lbC1idG5zIHRkLngtdG9vbGJhci1jZWxsewoJcGFkZGluZzozcHg7Cn0KCi54LXBhbmVsLWJ0bnMgLngtYnRuLWZvY3VzIC54LWJ0bi1sZWZ0ewoJYmFja2dyb3VuZC1wb3NpdGlvbjowIC0xNDdweDsKfQoKLngtcGFuZWwtYnRucyAueC1idG4tZm9jdXMgLngtYnRuLXJpZ2h0ewoJYmFja2dyb3VuZC1wb3NpdGlvbjowIC0xNjhweDsKfQoKLngtcGFuZWwtYnRucyAueC1idG4tZm9jdXMgLngtYnRuLWNlbnRlcnsKCWJhY2tncm91bmQtcG9zaXRpb246MCAtMTg5cHg7Cn0KCi54LXBhbmVsLWJ0bnMgLngtYnRuLW92ZXIgLngtYnRuLWxlZnR7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTYzcHg7Cn0KCi54LXBhbmVsLWJ0bnMgLngtYnRuLW92ZXIgLngtYnRuLXJpZ2h0ewoJYmFja2dyb3VuZC1wb3NpdGlvbjowIC04NHB4Owp9CgoueC1wYW5lbC1idG5zIC54LWJ0bi1vdmVyIC54LWJ0bi1jZW50ZXJ7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTEwNXB4Owp9CgoueC1wYW5lbC1idG5zIC54LWJ0bi1jbGljayAueC1idG4tY2VudGVyewoJYmFja2dyb3VuZC1wb3NpdGlvbjowIC0xMjZweDsKfQoKLngtcGFuZWwtYnRucyAueC1idG4tY2xpY2sgIC54LWJ0bi1yaWdodHsKCWJhY2tncm91bmQtcG9zaXRpb246MCAtODRweDsKfQoKLngtcGFuZWwtYnRucyAueC1idG4tY2xpY2sgLngtYnRuLWxlZnR7CgliYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTYzcHg7Cn0KCi54LXBhbmVsLWZiYXIgdGQsLngtcGFuZWwtZmJhciBzcGFuLC54LXBhbmVsLWZiYXIgaW5wdXQsLngtcGFuZWwtZmJhciBkaXYsLngtcGFuZWwtZmJhciBzZWxlY3QsLngtcGFuZWwtZmJhciBsYWJlbHsKCXdoaXRlLXNwYWNlOiBub3dyYXA7Cn0KLyoqCiAqIFczQyBTdWdnZXN0ZWQgRGVmYXVsdCBzdHlsZSBzaGVldCBmb3IgSFRNTCA0CiAqIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3NhbXBsZS5odG1sCiAqCiAqIFJlc2V0cyBmb3IgRXh0LlBhbmVsIEBjZmcgbm9ybWFsOiB0cnVlCiAqLwoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGh0bWwsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgYWRkcmVzcywKLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBibG9ja3F1b3RlLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGJvZHksCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgZGQsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgZGl2LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGRsLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGR0LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGZpZWxkc2V0LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGZvcm0sCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgZnJhbWUsIGZyYW1lc2V0LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGgxLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGgyLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGgzLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGg0LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGg1LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGg2LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IG5vZnJhbWVzLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IG9sLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHAsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgdWwsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgY2VudGVyLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGRpciwKLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBociwKLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBtZW51LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHByZSAJCQkgIHsgZGlzcGxheTogYmxvY2sgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGxpICAgICAgICAgICAgICB7IGRpc3BsYXk6IGxpc3QtaXRlbSB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaGVhZCAgICAgICAgICAgIHsgZGlzcGxheTogbm9uZSB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgdGFibGUgICAgICAgICAgIHsgZGlzcGxheTogdGFibGUgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRyICAgICAgICAgICAgICB7IGRpc3BsYXk6IHRhYmxlLXJvdyB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgdGhlYWQgICAgICAgICAgIHsgZGlzcGxheTogdGFibGUtaGVhZGVyLWdyb3VwIH0KLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSB0Ym9keSAgICAgICAgICAgeyBkaXNwbGF5OiB0YWJsZS1yb3ctZ3JvdXAgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRmb290ICAgICAgICAgICB7IGRpc3BsYXk6IHRhYmxlLWZvb3Rlci1ncm91cCB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgY29sICAgICAgICAgICAgIHsgZGlzcGxheTogdGFibGUtY29sdW1uIH0KLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBjb2xncm91cCAgICAgICAgeyBkaXNwbGF5OiB0YWJsZS1jb2x1bW4tZ3JvdXAgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRkLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRoIAkgICAgICAgICAgeyBkaXNwbGF5OiB0YWJsZS1jZWxsIH0KLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBjYXB0aW9uICAgICAgICAgeyBkaXNwbGF5OiB0YWJsZS1jYXB0aW9uIH0KLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSB0aCAgICAgICAgICAgICAgeyBmb250LXdlaWdodDogYm9sZGVyOyB0ZXh0LWFsaWduOiBjZW50ZXIgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGNhcHRpb24gICAgICAgICB7IHRleHQtYWxpZ246IGNlbnRlciB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgYm9keSAgICAgICAgICAgIHsgbWFyZ2luOiA4cHggfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGgxICAgICAgICAgICAgICB7IGZvbnQtc2l6ZTogMmVtOyBtYXJnaW46IC42N2VtIDAgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGgyICAgICAgICAgICAgICB7IGZvbnQtc2l6ZTogMS41ZW07IG1hcmdpbjogLjc1ZW0gMCB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaDMgICAgICAgICAgICAgIHsgZm9udC1zaXplOiAxLjE3ZW07IG1hcmdpbjogLjgzZW0gMCB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaDQsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgcCwKLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBibG9ja3F1b3RlLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHVsLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGZpZWxkc2V0LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGZvcm0sCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgb2wsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgZGwsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgZGlyLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IG1lbnUgICAgICAgICAgICB7IG1hcmdpbjogMS4xMmVtIDAgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGg1ICAgICAgICAgICAgICB7IGZvbnQtc2l6ZTogLjgzZW07IG1hcmdpbjogMS41ZW0gMCB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaDYgICAgICAgICAgICAgIHsgZm9udC1zaXplOiAuNzVlbTsgbWFyZ2luOiAxLjY3ZW0gMCB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaDEsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaDIsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaDMsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaDQsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaDUsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaDYsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgYiwKLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBzdHJvbmcgICAgICAgICAgeyBmb250LXdlaWdodDogYm9sZGVyIH0KLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBibG9ja3F1b3RlICAgICAgeyBtYXJnaW4tbGVmdDogNDBweDsgbWFyZ2luLXJpZ2h0OiA0MHB4IH0KLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBpLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGNpdGUsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgZW0sCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgdmFyLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGFkZHJlc3MgICAgCSAgeyBmb250LXN0eWxlOiBpdGFsaWMgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHByZSwKLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSB0dCwKLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBjb2RlLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGtiZCwKLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBzYW1wICAgICAgIAkgIHsgZm9udC1mYW1pbHk6IG1vbm9zcGFjZSB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgcHJlICAgICAgICAgICAgIHsgd2hpdGUtc3BhY2U6IHByZSB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgYnV0dG9uLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRleHRhcmVhLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGlucHV0LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHNlbGVjdCAgIAkJICB7IGRpc3BsYXk6IGlubGluZS1ibG9jayB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgYmlnICAgICAgICAgICAgIHsgZm9udC1zaXplOiAxLjE3ZW0gfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHNtYWxsLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHN1YiwKLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBzdXAgCQkJICB7IGZvbnQtc2l6ZTogLjgzZW0gfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHN1YiAgICAgICAgICAgICB7IHZlcnRpY2FsLWFsaWduOiBzdWIgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHN1cCAgICAgICAgICAgICB7IHZlcnRpY2FsLWFsaWduOiBzdXBlciB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgdGFibGUgICAgICAgICAgIHsgYm9yZGVyLXNwYWNpbmc6IDJweDsgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRoZWFkLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRib2R5LAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRmb290ICAgICAgICAgICB7IHZlcnRpY2FsLWFsaWduOiBtaWRkbGUgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRkLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHRoICAgICAgICAgIAkgIHsgdmVydGljYWwtYWxpZ246IGluaGVyaXQgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHMsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgc3RyaWtlLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGRlbCAgCQkJICB7IHRleHQtZGVjb3JhdGlvbjogbGluZS10aHJvdWdoIH0KLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBociAgICAgICAgICAgICAgeyBib3JkZXI6IDFweCBpbnNldCB9Ci54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgb2wsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgdWwsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgZGlyLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IG1lbnUsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgZGQgICAgICAgIAkgIHsgbWFyZ2luLWxlZnQ6IDQwcHggfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHVsLCAueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IG1lbnUsIC54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgZGlyIHsgbGlzdC1zdHlsZS10eXBlOiBkaXNjO30KLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBvbCAgICAgICAgICAgICAgeyBsaXN0LXN0eWxlLXR5cGU6IGRlY2ltYWwgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IG9sIHVsLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHVsIG9sLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHVsIHVsLAoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IG9sIG9sICAgIAkJICB7IG1hcmdpbi10b3A6IDA7IG1hcmdpbi1ib3R0b206IDAgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IHUsCi54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgaW5zICAgICAgICAgIAkgIHsgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmUgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IGJyOmJlZm9yZSAgICAgICB7IGNvbnRlbnQ6ICJcQSIgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IDpiZWZvcmUsIC54LXBhbmVsLXJlc2V0IC54LXBhbmVsLWJvZHkgOmFmdGVyIHsgd2hpdGUtc3BhY2U6IHByZS1saW5lIH0KLngtcGFuZWwtcmVzZXQgLngtcGFuZWwtYm9keSBjZW50ZXIgICAgICAgICAgeyB0ZXh0LWFsaWduOiBjZW50ZXIgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IDpsaW5rLCAueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IDp2aXNpdGVkIHsgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmUgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IDpmb2N1cyAgICAgICAgICB7IG91dGxpbmU6IGludmVydCBkb3R0ZWQgdGhpbiB9CgovKiBCZWdpbiBiaWRpcmVjdGlvbmFsaXR5IHNldHRpbmdzIChkbyBub3QgY2hhbmdlKSAqLwoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IEJET1tESVI9Imx0ciJdICB7IGRpcmVjdGlvbjogbHRyOyB1bmljb2RlLWJpZGk6IGJpZGktb3ZlcnJpZGUgfQoueC1wYW5lbC1yZXNldCAueC1wYW5lbC1ib2R5IEJET1tESVI9InJ0bCJdICB7IGRpcmVjdGlvbjogcnRsOyB1bmljb2RlLWJpZGk6IGJpZGktb3ZlcnJpZGUgfQoueC13aW5kb3cgewogICAgem9vbToxOwp9CgoueC13aW5kb3cgLngtd2luZG93LWhhbmRsZSB7CiAgICBvcGFjaXR5OjA7CiAgICAtbW96LW9wYWNpdHk6MDsKICAgIGZpbHRlcjphbHBoYShvcGFjaXR5PTApOwp9CgoueC13aW5kb3ctcHJveHkgewogICAgYm9yZGVyOjFweCBzb2xpZDsKICAgIHotaW5kZXg6MTIwMDA7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgIGxlZnQ6MDt0b3A6MDsKICAgIGRpc3BsYXk6bm9uZTsKICAgIG9wYWNpdHk6LjU7CiAgICAtbW96LW9wYWNpdHk6LjU7CiAgICBmaWx0ZXI6YWxwaGEob3BhY2l0eT01MCk7Cn0KCi54LXdpbmRvdy1oZWFkZXIgewogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgem9vbToxOwp9CgoueC13aW5kb3ctYndyYXAgewogICAgei1pbmRleDoxOwogICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICB6b29tOjE7CiAgICBsZWZ0OjA7dG9wOjA7Cn0KCi54LXdpbmRvdy10bCAueC13aW5kb3ctaGVhZGVyIHsKICAgIHBhZGRpbmc6NXB4IDAgNHB4IDA7Cn0KCi54LXdpbmRvdy1oZWFkZXItdGV4dCB7CiAgICBjdXJzb3I6cG9pbnRlcjsKfQoKLngtd2luZG93LXRjIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IHJlcGVhdC14IDAgMDsKCW92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKfQoKLngtd2luZG93LXRsIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIDA7CglwYWRkaW5nLWxlZnQ6NnB4OwogICAgem9vbToxOwogICAgei1pbmRleDoxOwogICAgcG9zaXRpb246cmVsYXRpdmU7Cn0KCi54LXdpbmRvdy10ciB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgMDsKCXBhZGRpbmctcmlnaHQ6NnB4Owp9CgoueC13aW5kb3ctYmMgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgcmVwZWF0LXggMCBib3R0b207CiAgICB6b29tOjE7Cn0KCi54LXdpbmRvdy1iYyAueC13aW5kb3ctZm9vdGVyIHsKICAgIHBhZGRpbmctYm90dG9tOjZweDsKICAgIHpvb206MTsKICAgIGZvbnQtc2l6ZTowOwogICAgbGluZS1oZWlnaHQ6MDsKfQoKLngtd2luZG93LWJsIHsKCWJhY2tncm91bmQ6IHRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIGJvdHRvbTsKCXBhZGRpbmctbGVmdDo2cHg7CiAgICB6b29tOjE7Cn0KCi54LXdpbmRvdy1iciB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgYm90dG9tOwoJcGFkZGluZy1yaWdodDo2cHg7CiAgICB6b29tOjE7Cn0KCi54LXdpbmRvdy1tYyB7CiAgICBib3JkZXI6MXB4IHNvbGlkOwogICAgcGFkZGluZzowOwogICAgbWFyZ2luOjA7Cn0KCi54LXdpbmRvdy1tbCB7CgliYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCByZXBlYXQteSAwIDA7CglwYWRkaW5nLWxlZnQ6NnB4OwogICAgem9vbToxOwp9CgoueC13aW5kb3ctbXIgewoJYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgcmVwZWF0LXkgcmlnaHQgMDsKCXBhZGRpbmctcmlnaHQ6NnB4OwogICAgem9vbToxOwp9CgoueC13aW5kb3ctYm9keSB7CiAgICBvdmVyZmxvdzpoaWRkZW47Cn0KCi54LXdpbmRvdy1id3JhcCB7CiAgICBvdmVyZmxvdzpoaWRkZW47Cn0KCi54LXdpbmRvdy1tYXhpbWl6ZWQgLngtd2luZG93LWJsLCAueC13aW5kb3ctbWF4aW1pemVkIC54LXdpbmRvdy1iciwKICAgIC54LXdpbmRvdy1tYXhpbWl6ZWQgLngtd2luZG93LW1sLCAueC13aW5kb3ctbWF4aW1pemVkIC54LXdpbmRvdy1tciwKICAgIC54LXdpbmRvdy1tYXhpbWl6ZWQgLngtd2luZG93LXRsLCAueC13aW5kb3ctbWF4aW1pemVkIC54LXdpbmRvdy10ciB7CiAgICBwYWRkaW5nOjA7Cn0KCi54LXdpbmRvdy1tYXhpbWl6ZWQgLngtd2luZG93LWZvb3RlciB7CiAgICBwYWRkaW5nLWJvdHRvbTowOwp9CgoueC13aW5kb3ctbWF4aW1pemVkIC54LXdpbmRvdy10YyB7CiAgICBwYWRkaW5nLWxlZnQ6M3B4OwogICAgcGFkZGluZy1yaWdodDozcHg7Cn0KCi54LXdpbmRvdy1tYXhpbWl6ZWQgLngtd2luZG93LW1jIHsKICAgIGJvcmRlci1sZWZ0OjAgbm9uZTsKICAgIGJvcmRlci1yaWdodDowIG5vbmU7Cn0KCi54LXdpbmRvdy10YmFyIC54LXRvb2xiYXIsIC54LXdpbmRvdy1iYmFyIC54LXRvb2xiYXIgewogICAgYm9yZGVyLWxlZnQ6MCBub25lOwogICAgYm9yZGVyLXJpZ2h0OiAwIG5vbmU7Cn0KCi54LXdpbmRvdy1iYmFyIC54LXRvb2xiYXIgewogICAgYm9yZGVyLXRvcDoxcHggc29saWQ7CiAgICBib3JkZXItYm90dG9tOjAgbm9uZTsKfQoKLngtd2luZG93LWRyYWdnYWJsZSwgLngtd2luZG93LWRyYWdnYWJsZSAueC13aW5kb3ctaGVhZGVyLXRleHQgewogICAgY3Vyc29yOm1vdmU7Cn0KCi54LXdpbmRvdy1tYXhpbWl6ZWQgLngtd2luZG93LWRyYWdnYWJsZSwgLngtd2luZG93LW1heGltaXplZCAueC13aW5kb3ctZHJhZ2dhYmxlIC54LXdpbmRvdy1oZWFkZXItdGV4dCB7CiAgICBjdXJzb3I6ZGVmYXVsdDsKfQoKLngtd2luZG93LWJvZHkgewogICAgYmFja2dyb3VuZC1jb2xvcjp0cmFuc3BhcmVudDsKfQoKLngtcGFuZWwtZ2hvc3QgLngtd2luZG93LXRsIHsKICAgIGJvcmRlci1ib3R0b206MXB4IHNvbGlkOwp9CgoueC1wYW5lbC1jb2xsYXBzZWQgLngtd2luZG93LXRsIHsKICAgIGJvcmRlci1ib3R0b206MXB4IHNvbGlkOwp9CgoueC13aW5kb3ctbWF4aW1pemVkLWN0IHsKICAgIG92ZXJmbG93OmhpZGRlbjsKfQoKLngtd2luZG93LW1heGltaXplZCAueC13aW5kb3ctaGFuZGxlIHsKICAgIGRpc3BsYXk6bm9uZTsKfQoKLngtd2luZG93LXNpemluZy1naG9zdCB1bCB7CiAgICBib3JkZXI6MCBub25lICFpbXBvcnRhbnQ7Cn0KCi54LWRsZy1mb2N1c3sKCS1tb3otb3V0bGluZTowIG5vbmU7CglvdXRsaW5lOjAgbm9uZTsKCXdpZHRoOjA7CgloZWlnaHQ6MDsKCW92ZXJmbG93OmhpZGRlbjsKCXBvc2l0aW9uOmFic29sdXRlOwoJdG9wOjA7CglsZWZ0OjA7Cn0KCi5leHQtd2Via2l0IC54LWRsZy1mb2N1c3sKICAgIHdpZHRoOiAxcHg7CiAgICBoZWlnaHQ6IDFweDsKfQoKLngtZGxnLW1hc2t7CiAgICB6LWluZGV4OjEwMDAwOwogICAgZGlzcGxheTpub25lOwogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICB0b3A6MDsKICAgIGxlZnQ6MDsKICAgIC1tb3otb3BhY2l0eTogMC41OwogICAgb3BhY2l0eTouNTA7CiAgICBmaWx0ZXI6IGFscGhhKG9wYWNpdHk9NTApOwp9Cgpib2R5LmV4dC1pZTYueC1ib2R5LW1hc2tlZCBzZWxlY3QgewoJdmlzaWJpbGl0eTpoaWRkZW47Cn0KCmJvZHkuZXh0LWllNi54LWJvZHktbWFza2VkIC54LXdpbmRvdyBzZWxlY3QgewoJdmlzaWJpbGl0eTp2aXNpYmxlOwp9CgoueC13aW5kb3ctcGxhaW4gLngtd2luZG93LW1jIHsKICAgIGJvcmRlcjogMXB4IHNvbGlkOwp9CgoueC13aW5kb3ctcGxhaW4gLngtd2luZG93LWJvZHkgewogICAgYm9yZGVyOiAxcHggc29saWQ7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50ICFpbXBvcnRhbnQ7Cn0ueC1odG1sLWVkaXRvci13cmFwIHsKICAgIGJvcmRlcjoxcHggc29saWQ7Cn0KCi54LWh0bWwtZWRpdG9yLXRiIC54LWJ0bi10ZXh0IHsKICAgIGJhY2tncm91bmQ6dHJhbnNwYXJlbnQgbm8tcmVwZWF0Owp9CgoueC1odG1sLWVkaXRvci10YiAueC1lZGl0LWJvbGQsIC54LW1lbnUtaXRlbSBpbWcueC1lZGl0LWJvbGQgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIDA7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9lZGl0b3IvdGItc3ByaXRlLmdpZik7ICAgIAp9CgoueC1odG1sLWVkaXRvci10YiAueC1lZGl0LWl0YWxpYywgLngtbWVudS1pdGVtIGltZy54LWVkaXQtaXRhbGljIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE2cHggMDsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2VkaXRvci90Yi1zcHJpdGUuZ2lmKTsKfQoKLngtaHRtbC1lZGl0b3ItdGIgLngtZWRpdC11bmRlcmxpbmUsIC54LW1lbnUtaXRlbSBpbWcueC1lZGl0LXVuZGVybGluZSB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0zMnB4IDA7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9lZGl0b3IvdGItc3ByaXRlLmdpZik7Cn0KCi54LWh0bWwtZWRpdG9yLXRiIC54LWVkaXQtZm9yZWNvbG9yLCAueC1tZW51LWl0ZW0gaW1nLngtZWRpdC1mb3JlY29sb3IgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTYwcHggMDsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2VkaXRvci90Yi1zcHJpdGUuZ2lmKTsKfQoKLngtaHRtbC1lZGl0b3ItdGIgLngtZWRpdC1iYWNrY29sb3IsIC54LW1lbnUtaXRlbSBpbWcueC1lZGl0LWJhY2tjb2xvciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNzZweCAwOwogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZWRpdG9yL3RiLXNwcml0ZS5naWYpOwp9CgoueC1odG1sLWVkaXRvci10YiAueC1lZGl0LWp1c3RpZnlsZWZ0LCAueC1tZW51LWl0ZW0gaW1nLngtZWRpdC1qdXN0aWZ5bGVmdCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xMTJweCAwOwogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZWRpdG9yL3RiLXNwcml0ZS5naWYpOwp9CgoueC1odG1sLWVkaXRvci10YiAueC1lZGl0LWp1c3RpZnljZW50ZXIsIC54LW1lbnUtaXRlbSBpbWcueC1lZGl0LWp1c3RpZnljZW50ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTI4cHggMDsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2VkaXRvci90Yi1zcHJpdGUuZ2lmKTsKfQoKLngtaHRtbC1lZGl0b3ItdGIgLngtZWRpdC1qdXN0aWZ5cmlnaHQsIC54LW1lbnUtaXRlbSBpbWcueC1lZGl0LWp1c3RpZnlyaWdodCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNDRweCAwOwogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZWRpdG9yL3RiLXNwcml0ZS5naWYpOwp9CgoueC1odG1sLWVkaXRvci10YiAueC1lZGl0LWluc2VydG9yZGVyZWRsaXN0LCAueC1tZW51LWl0ZW0gaW1nLngtZWRpdC1pbnNlcnRvcmRlcmVkbGlzdCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi04MHB4IDA7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9lZGl0b3IvdGItc3ByaXRlLmdpZik7Cn0KCi54LWh0bWwtZWRpdG9yLXRiIC54LWVkaXQtaW5zZXJ0dW5vcmRlcmVkbGlzdCwgLngtbWVudS1pdGVtIGltZy54LWVkaXQtaW5zZXJ0dW5vcmRlcmVkbGlzdCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi05NnB4IDA7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9lZGl0b3IvdGItc3ByaXRlLmdpZik7Cn0KCi54LWh0bWwtZWRpdG9yLXRiIC54LWVkaXQtaW5jcmVhc2Vmb250c2l6ZSwgLngtbWVudS1pdGVtIGltZy54LWVkaXQtaW5jcmVhc2Vmb250c2l6ZSB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi00OHB4IDA7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9lZGl0b3IvdGItc3ByaXRlLmdpZik7Cn0KCi54LWh0bWwtZWRpdG9yLXRiIC54LWVkaXQtZGVjcmVhc2Vmb250c2l6ZSwgLngtbWVudS1pdGVtIGltZy54LWVkaXQtZGVjcmVhc2Vmb250c2l6ZSB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi02NHB4IDA7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9lZGl0b3IvdGItc3ByaXRlLmdpZik7Cn0KCi54LWh0bWwtZWRpdG9yLXRiIC54LWVkaXQtc291cmNlZWRpdCwgLngtbWVudS1pdGVtIGltZy54LWVkaXQtc291cmNlZWRpdCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xOTJweCAwOwogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZWRpdG9yL3RiLXNwcml0ZS5naWYpOwp9CgoueC1odG1sLWVkaXRvci10YiAueC1lZGl0LWNyZWF0ZWxpbmssIC54LW1lbnUtaXRlbSBpbWcueC1lZGl0LWNyZWF0ZWxpbmsgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMjA4cHggMDsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2VkaXRvci90Yi1zcHJpdGUuZ2lmKTsKfQoKLngtaHRtbC1lZGl0b3ItdGlwIC54LXRpcC1iZCAueC10aXAtYmQtaW5uZXIgewogICAgcGFkZGluZzo1cHg7CiAgICBwYWRkaW5nLWJvdHRvbToxcHg7Cn0KCi54LWh0bWwtZWRpdG9yLXRiIC54LXRvb2xiYXIgewogICAgcG9zaXRpb246c3RhdGljICFpbXBvcnRhbnQ7Cn0ueC1wYW5lbC1ub2JvcmRlciAueC1wYW5lbC1ib2R5LW5vYm9yZGVyIHsKICAgIGJvcmRlci13aWR0aDowOwp9CgoueC1wYW5lbC1ub2JvcmRlciAueC1wYW5lbC1oZWFkZXItbm9ib3JkZXIgewogICAgYm9yZGVyLXdpZHRoOjAgMCAxcHg7CiAgICBib3JkZXItc3R5bGU6c29saWQ7Cn0KCi54LXBhbmVsLW5vYm9yZGVyIC54LXBhbmVsLXRiYXItbm9ib3JkZXIgLngtdG9vbGJhciB7CiAgICBib3JkZXItd2lkdGg6MCAwIDFweDsKICAgIGJvcmRlci1zdHlsZTpzb2xpZDsKfQoKLngtcGFuZWwtbm9ib3JkZXIgLngtcGFuZWwtYmJhci1ub2JvcmRlciAueC10b29sYmFyIHsKICAgIGJvcmRlci13aWR0aDoxcHggMCAwIDA7CiAgICBib3JkZXItc3R5bGU6c29saWQ7Cn0KCi54LXdpbmRvdy1ub2JvcmRlciAueC13aW5kb3ctbWMgewogICAgYm9yZGVyLXdpZHRoOjA7Cn0KCi54LXdpbmRvdy1wbGFpbiAueC13aW5kb3ctYm9keS1ub2JvcmRlciB7CiAgICBib3JkZXItd2lkdGg6MDsKfQoKLngtdGFiLXBhbmVsLW5vYm9yZGVyIC54LXRhYi1wYW5lbC1ib2R5LW5vYm9yZGVyIHsKCWJvcmRlci13aWR0aDowOwp9CgoueC10YWItcGFuZWwtbm9ib3JkZXIgLngtdGFiLXBhbmVsLWhlYWRlci1ub2JvcmRlciB7CiAgICBib3JkZXItd2lkdGg6IDAgMCAxcHggMDsKfQoKLngtdGFiLXBhbmVsLW5vYm9yZGVyIC54LXRhYi1wYW5lbC1mb290ZXItbm9ib3JkZXIgewogICAgYm9yZGVyLXdpZHRoOiAxcHggMCAwIDA7Cn0KCi54LXRhYi1wYW5lbC1iYmFyLW5vYm9yZGVyIC54LXRvb2xiYXIgewogICAgYm9yZGVyLXdpZHRoOiAxcHggMCAwIDA7CiAgICBib3JkZXItc3R5bGU6c29saWQ7Cn0KCi54LXRhYi1wYW5lbC10YmFyLW5vYm9yZGVyIC54LXRvb2xiYXIgewogICAgYm9yZGVyLXdpZHRoOjAgMCAxcHg7CiAgICBib3JkZXItc3R5bGU6c29saWQ7Cn0ueC1ib3JkZXItbGF5b3V0LWN0IHsKICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsKfQoKLngtYm9yZGVyLXBhbmVsIHsKICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgbGVmdDowOwogICAgdG9wOjA7Cn0KCi54LXRvb2wtY29sbGFwc2Utc291dGggewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0xOTVweDsKfQoKLngtdG9vbC1jb2xsYXBzZS1zb3V0aC1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTE5NXB4Owp9CgoueC10b29sLWNvbGxhcHNlLW5vcnRoIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMjEwcHg7Cn0KCi54LXRvb2wtY29sbGFwc2Utbm9ydGgtb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNXB4IC0yMTBweDsKfQoKLngtdG9vbC1jb2xsYXBzZS13ZXN0IHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMTgwcHg7Cn0KCi54LXRvb2wtY29sbGFwc2Utd2VzdC1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTE4MHB4Owp9CgoueC10b29sLWNvbGxhcHNlLWVhc3QgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0xNjVweDsKfQoKLngtdG9vbC1jb2xsYXBzZS1lYXN0LW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMTY1cHg7Cn0KCi54LXRvb2wtZXhwYW5kLXNvdXRoIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMjEwcHg7Cn0KCi54LXRvb2wtZXhwYW5kLXNvdXRoLW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMjEwcHg7Cn0KCi54LXRvb2wtZXhwYW5kLW5vcnRoIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMTk1cHg7Cn0KLngtdG9vbC1leHBhbmQtbm9ydGgtb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNXB4IC0xOTVweDsKfQoKLngtdG9vbC1leHBhbmQtd2VzdCB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOjAgLTE2NXB4Owp9CgoueC10b29sLWV4cGFuZC13ZXN0LW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjotMTVweCAtMTY1cHg7Cn0KCi54LXRvb2wtZXhwYW5kLWVhc3QgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjowIC0xODBweDsKfQoKLngtdG9vbC1leHBhbmQtZWFzdC1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTE4MHB4Owp9CgoueC10b29sLWV4cGFuZC1ub3J0aCwgLngtdG9vbC1leHBhbmQtc291dGggewogICAgZmxvYXQ6cmlnaHQ7CiAgICBtYXJnaW46M3B4Owp9CgoueC10b29sLWV4cGFuZC1lYXN0LCAueC10b29sLWV4cGFuZC13ZXN0IHsKICAgIGZsb2F0Om5vbmU7CiAgICBtYXJnaW46M3B4IDJweDsKfQoKLngtYWNjb3JkaW9uLWhkIC54LXRvb2wtdG9nZ2xlIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMjU1cHg7Cn0KCi54LWFjY29yZGlvbi1oZCAueC10b29sLXRvZ2dsZS1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246LTE1cHggLTI1NXB4Owp9CgoueC1wYW5lbC1jb2xsYXBzZWQgLngtYWNjb3JkaW9uLWhkIC54LXRvb2wtdG9nZ2xlIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246MCAtMjQwcHg7Cn0KCi54LXBhbmVsLWNvbGxhcHNlZCAueC1hY2NvcmRpb24taGQgLngtdG9vbC10b2dnbGUtb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOi0xNXB4IC0yNDBweDsKfQoKLngtYWNjb3JkaW9uLWhkIHsKCXBhZGRpbmctdG9wOjRweDsKCXBhZGRpbmctYm90dG9tOjNweDsKCWJvcmRlci10b3A6MCBub25lOwogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgcmVwZWF0LXggMCAtOXB4Owp9CgoueC1sYXlvdXQtY29sbGFwc2VkewogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICBsZWZ0Oi0xMDAwMHB4OwogICAgdG9wOi0xMDAwMHB4OwogICAgdmlzaWJpbGl0eTpoaWRkZW47CiAgICB3aWR0aDoyMHB4OwogICAgaGVpZ2h0OjIwcHg7CiAgICBvdmVyZmxvdzpoaWRkZW47Cglib3JkZXI6MXB4IHNvbGlkOwoJei1pbmRleDoyMDsKfQoKLmV4dC1ib3JkZXItYm94IC54LWxheW91dC1jb2xsYXBzZWR7CiAgICB3aWR0aDoyMnB4OwogICAgaGVpZ2h0OjIycHg7Cn0KCi54LWxheW91dC1jb2xsYXBzZWQtb3ZlcnsKICAgIGN1cnNvcjpwb2ludGVyOwp9CgoueC1sYXlvdXQtY29sbGFwc2VkLXdlc3QgLngtbGF5b3V0LWNvbGxhcHNlZC10b29scywgLngtbGF5b3V0LWNvbGxhcHNlZC1lYXN0IC54LWxheW91dC1jb2xsYXBzZWQtdG9vbHN7Cglwb3NpdGlvbjphYnNvbHV0ZTsKICAgIHRvcDowOwogICAgbGVmdDowOwogICAgd2lkdGg6MjBweDsKICAgIGhlaWdodDoyMHB4Owp9CgoKLngtbGF5b3V0LXNwbGl0ewogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICBoZWlnaHQ6NXB4OwogICAgd2lkdGg6NXB4OwogICAgbGluZS1oZWlnaHQ6MXB4OwogICAgZm9udC1zaXplOjFweDsKICAgIHotaW5kZXg6MzsKICAgIGJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7Cn0KCi8qIElFNiBzdHJpY3Qgd29uJ3QgZHJhZyB3L291dCBhIGNvbG9yICovCi5leHQtc3RyaWN0IC5leHQtaWU2IC54LWxheW91dC1zcGxpdHsKICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmYgIWltcG9ydGFudDsKICAgIGZpbHRlcjogYWxwaGEob3BhY2l0eT0xKTsKfQoKLngtbGF5b3V0LXNwbGl0LWh7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9zLmdpZik7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiBsZWZ0Owp9CgoueC1sYXlvdXQtc3BsaXQtdnsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3MuZ2lmKTsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IHRvcDsKfQoKLngtY29sdW1uLWxheW91dC1jdCB7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICB6b29tOjE7Cn0KCi54LWNvbHVtbiB7CiAgICBmbG9hdDpsZWZ0OwogICAgcGFkZGluZzowOwogICAgbWFyZ2luOjA7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICB6b29tOjE7Cn0KCi54LWNvbHVtbi1pbm5lciB7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICB6b29tOjE7Cn0KCi8qIG1pbmkgbW9kZSAqLwoueC1sYXlvdXQtbWluaSB7CiAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgIHRvcDowOwogICAgbGVmdDowOwogICAgZGlzcGxheTpibG9jazsKICAgIHdpZHRoOjVweDsKICAgIGhlaWdodDozNXB4OwogICAgY3Vyc29yOnBvaW50ZXI7CiAgICBvcGFjaXR5Oi41OwogICAgLW1vei1vcGFjaXR5Oi41OwogICAgZmlsdGVyOmFscGhhKG9wYWNpdHk9NTApOwp9CgoueC1sYXlvdXQtbWluaS1vdmVyLCAueC1sYXlvdXQtY29sbGFwc2VkLW92ZXIgLngtbGF5b3V0LW1pbml7CiAgICBvcGFjaXR5OjE7CiAgICAtbW96LW9wYWNpdHk6MTsKICAgIGZpbHRlcjpub25lOwp9CgoueC1sYXlvdXQtc3BsaXQtd2VzdCAueC1sYXlvdXQtbWluaSB7CiAgICB0b3A6NDglOwp9CgoueC1sYXlvdXQtc3BsaXQtZWFzdCAueC1sYXlvdXQtbWluaSB7CiAgICB0b3A6NDglOwp9CgoueC1sYXlvdXQtc3BsaXQtbm9ydGggLngtbGF5b3V0LW1pbmkgewogICAgbGVmdDo0OCU7CiAgICBoZWlnaHQ6NXB4OwogICAgd2lkdGg6MzVweDsKfQoKLngtbGF5b3V0LXNwbGl0LXNvdXRoIC54LWxheW91dC1taW5pIHsKICAgIGxlZnQ6NDglOwogICAgaGVpZ2h0OjVweDsKICAgIHdpZHRoOjM1cHg7Cn0KCi54LWxheW91dC1jbWluaS13ZXN0IC54LWxheW91dC1taW5pIHsKICAgIHRvcDo0OCU7Cn0KCi54LWxheW91dC1jbWluaS1lYXN0IC54LWxheW91dC1taW5pIHsKICAgIHRvcDo0OCU7Cn0KCi54LWxheW91dC1jbWluaS1ub3J0aCAueC1sYXlvdXQtbWluaSB7CiAgICBsZWZ0OjQ4JTsKICAgIGhlaWdodDo1cHg7CiAgICB3aWR0aDozNXB4Owp9CgoueC1sYXlvdXQtY21pbmktc291dGggLngtbGF5b3V0LW1pbmkgewogICAgbGVmdDo0OCU7CiAgICBoZWlnaHQ6NXB4OwogICAgd2lkdGg6MzVweDsKfQoKLngtbGF5b3V0LWNtaW5pLXdlc3QsIC54LWxheW91dC1jbWluaS1lYXN0IHsKICAgIGJvcmRlcjowIG5vbmU7CiAgICB3aWR0aDo1cHggIWltcG9ydGFudDsKICAgIHBhZGRpbmc6MDsKICAgIGJhY2tncm91bmQtY29sb3I6dHJhbnNwYXJlbnQ7Cn0KCi54LWxheW91dC1jbWluaS1ub3J0aCwgLngtbGF5b3V0LWNtaW5pLXNvdXRoIHsKICAgIGJvcmRlcjowIG5vbmU7CiAgICBoZWlnaHQ6NXB4ICFpbXBvcnRhbnQ7CiAgICBwYWRkaW5nOjA7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOnRyYW5zcGFyZW50Owp9CgoueC12aWV3cG9ydCwgLngtdmlld3BvcnQgYm9keSB7CiAgICBtYXJnaW46IDA7CiAgICBwYWRkaW5nOiAwOwogICAgYm9yZGVyOiAwIG5vbmU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgaGVpZ2h0OiAxMDAlOwp9CgoueC1hYnMtbGF5b3V0LWl0ZW0gewogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICBsZWZ0OjA7CiAgICB0b3A6MDsKfQoKLmV4dC1pZSBpbnB1dC54LWFicy1sYXlvdXQtaXRlbSwgLmV4dC1pZSB0ZXh0YXJlYS54LWFicy1sYXlvdXQtaXRlbSB7CiAgICBtYXJnaW46MDsKfQoKLngtYm94LWxheW91dC1jdCB7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICB6b29tOjE7Cn0KCi54LWJveC1pbm5lciB7CiAgICBvdmVyZmxvdzpoaWRkZW47CiAgICB6b29tOjE7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgIGxlZnQ6MDsKICAgIHRvcDowOwp9CgoueC1ib3gtaXRlbSB7CiAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgIGxlZnQ6MDsKICAgIHRvcDowOwp9LngtcHJvZ3Jlc3Mtd3JhcCB7CiAgICBib3JkZXI6MXB4IHNvbGlkOwogICAgb3ZlcmZsb3c6aGlkZGVuOwp9CgoueC1wcm9ncmVzcy1pbm5lciB7CiAgICBoZWlnaHQ6MThweDsKICAgIGJhY2tncm91bmQ6cmVwZWF0LXg7CiAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKfQoKLngtcHJvZ3Jlc3MtYmFyIHsKICAgIGhlaWdodDoxOHB4OwogICAgZmxvYXQ6bGVmdDsKICAgIHdpZHRoOjA7CiAgICBiYWNrZ3JvdW5kOiByZXBlYXQteCBsZWZ0IGNlbnRlcjsKICAgIGJvcmRlci10b3A6MXB4IHNvbGlkOwogICAgYm9yZGVyLWJvdHRvbToxcHggc29saWQ7CiAgICBib3JkZXItcmlnaHQ6MXB4IHNvbGlkOwp9CgoueC1wcm9ncmVzcy10ZXh0IHsKICAgIHBhZGRpbmc6MXB4IDVweDsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgbGVmdDowOwogICAgdGV4dC1hbGlnbjpjZW50ZXI7Cn0KCi54LXByb2dyZXNzLXRleHQtYmFjayB7CiAgICBsaW5lLWhlaWdodDoxNnB4Owp9CgouZXh0LWllIC54LXByb2dyZXNzLXRleHQtYmFjayB7CiAgICBsaW5lLWhlaWdodDoxNXB4Owp9CgouZXh0LXN0cmljdCAuZXh0LWllNyAueC1wcm9ncmVzcy10ZXh0LWJhY2t7CiAgICB3aWR0aDogMTAwJTsKfQoueC1saXN0LWhlYWRlcnsKCWJhY2tncm91bmQ6IHJlcGVhdC14IDAgYm90dG9tOwoJY3Vyc29yOmRlZmF1bHQ7CiAgICB6b29tOjE7CiAgICBoZWlnaHQ6MjJweDsKfQoKLngtbGlzdC1oZWFkZXItaW5uZXIgZGl2IHsKICAgIGRpc3BsYXk6YmxvY2s7CiAgICBmbG9hdDpsZWZ0OwogICAgb3ZlcmZsb3c6aGlkZGVuOwoJLW8tdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7Cgl0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7Cn0KCi54LWxpc3QtaGVhZGVyLWlubmVyIGRpdiBlbSB7CiAgICBkaXNwbGF5OmJsb2NrOwogICAgYm9yZGVyLWxlZnQ6MXB4IHNvbGlkOwogICAgcGFkZGluZzo0cHggNHB4OwogICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgLW1vei11c2VyLXNlbGVjdDogbm9uZTsKICAgIC1raHRtbC11c2VyLXNlbGVjdDogbm9uZTsKICAgIGxpbmUtaGVpZ2h0OjE0cHg7Cn0KCi54LWxpc3QtYm9keSB7CiAgICBvdmVyZmxvdzphdXRvOwogICAgb3ZlcmZsb3cteDpoaWRkZW47CiAgICBvdmVyZmxvdy15OmF1dG87CiAgICB6b29tOjE7CiAgICBmbG9hdDogbGVmdDsKICAgIHdpZHRoOiAxMDAlOwp9CgoueC1saXN0LWJvZHkgZGwgewogICAgem9vbToxOwp9CgoueC1saXN0LWJvZHkgZHQgewogICAgZGlzcGxheTpibG9jazsKICAgIGZsb2F0OmxlZnQ7CiAgICBvdmVyZmxvdzpoaWRkZW47Cgktby10ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKCXRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwogICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsKICAgIGN1cnNvcjpwb2ludGVyOwogICAgem9vbToxOwp9CgoueC1saXN0LWJvZHkgZHQgZW0gewogICAgZGlzcGxheTpibG9jazsKICAgIHBhZGRpbmc6M3B4IDRweDsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIC1tb3otdXNlci1zZWxlY3Q6IG5vbmU7CiAgICAta2h0bWwtdXNlci1zZWxlY3Q6IG5vbmU7Cn0KCi54LWxpc3QtcmVzaXplciB7CiAgICBib3JkZXItbGVmdDoxcHggc29saWQ7CiAgICBib3JkZXItcmlnaHQ6MXB4IHNvbGlkOwogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICBsZWZ0OjA7CiAgICB0b3A6MDsKfQoKLngtbGlzdC1oZWFkZXItaW5uZXIgZW0uc29ydC1hc2MgewogICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQgbm8tcmVwZWF0IGNlbnRlciAwOwogICAgYm9yZGVyLXN0eWxlOnNvbGlkOwogICAgYm9yZGVyLXdpZHRoOiAwIDFweCAxcHg7CiAgICBwYWRkaW5nLWJvdHRvbTozcHg7Cn0KCi54LWxpc3QtaGVhZGVyLWlubmVyIGVtLnNvcnQtZGVzYyB7CiAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudCBuby1yZXBlYXQgY2VudGVyIC0yM3B4OwogICAgYm9yZGVyLXN0eWxlOnNvbGlkOwogICAgYm9yZGVyLXdpZHRoOiAwIDFweCAxcHg7CiAgICBwYWRkaW5nLWJvdHRvbTozcHg7Cn0KCi8qIFNoYXJlZCBzdHlsZXMgKi8KLngtc2xpZGVyIHsKICAgIHpvb206MTsKfQoKLngtc2xpZGVyLWlubmVyIHsKICAgIHBvc2l0aW9uOnJlbGF0aXZlOwogICAgbGVmdDowOwogICAgdG9wOjA7CiAgICBvdmVyZmxvdzp2aXNpYmxlOwogICAgem9vbToxOwp9CgoueC1zbGlkZXItZm9jdXMgewoJcG9zaXRpb246YWJzb2x1dGU7CglsZWZ0OjA7Cgl0b3A6MDsKCXdpZHRoOjFweDsKCWhlaWdodDoxcHg7CiAgICBsaW5lLWhlaWdodDoxcHg7CiAgICBmb250LXNpemU6MXB4OwogICAgLW1vei1vdXRsaW5lOjAgbm9uZTsKICAgIG91dGxpbmU6MCBub25lOwogICAgLW1vei11c2VyLXNlbGVjdDogbm9uZTsKICAgIC1raHRtbC11c2VyLXNlbGVjdDpub25lOwogICAgLXdlYmtpdC11c2VyLXNlbGVjdDppZ25vcmU7CglkaXNwbGF5OmJsb2NrOwoJb3ZlcmZsb3c6aGlkZGVuOyAgCn0KCi8qIEhvcml6b250YWwgc3R5bGVzICovCi54LXNsaWRlci1ob3J6IHsKICAgIHBhZGRpbmctbGVmdDo3cHg7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCAwIC0yMnB4Owp9CgoueC1zbGlkZXItaG9yeiAueC1zbGlkZXItZW5kIHsKICAgIHBhZGRpbmctcmlnaHQ6N3B4OwogICAgem9vbToxOwogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQgcmlnaHQgLTQ0cHg7Cn0KCi54LXNsaWRlci1ob3J6IC54LXNsaWRlci1pbm5lciB7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IHJlcGVhdC14IDAgMDsKICAgIGhlaWdodDoyMnB4Owp9CgoueC1zbGlkZXItaG9yeiAueC1zbGlkZXItdGh1bWIgewogICAgd2lkdGg6MTRweDsKICAgIGhlaWdodDoxNXB4OwogICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICBsZWZ0OjA7CiAgICB0b3A6M3B4OwogICAgYmFja2dyb3VuZDp0cmFuc3BhcmVudCBuby1yZXBlYXQgMCAwOwp9CgoueC1zbGlkZXItaG9yeiAueC1zbGlkZXItdGh1bWItb3ZlciB7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uOiAtMTRweCAtMTVweDsKfQoKLngtc2xpZGVyLWhvcnogLngtc2xpZGVyLXRodW1iLWRyYWcgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogLTI4cHggLTMwcHg7Cn0KCi8qIFZlcnRpY2FsIHN0eWxlcyAqLwoueC1zbGlkZXItdmVydCB7CiAgICBwYWRkaW5nLXRvcDo3cHg7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCAtNDRweCAwOwogICAgd2lkdGg6MjJweDsKfQoKLngtc2xpZGVyLXZlcnQgLngtc2xpZGVyLWVuZCB7CiAgICBwYWRkaW5nLWJvdHRvbTo3cHg7CiAgICB6b29tOjE7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCAtMjJweCBib3R0b207Cn0KCi54LXNsaWRlci12ZXJ0IC54LXNsaWRlci1pbm5lciB7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IHJlcGVhdC15IDAgMDsKfQoKLngtc2xpZGVyLXZlcnQgLngtc2xpZGVyLXRodW1iIHsKICAgIHdpZHRoOjE1cHg7CiAgICBoZWlnaHQ6MTRweDsKICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgbGVmdDozcHg7CiAgICBib3R0b206MDsKICAgIGJhY2tncm91bmQ6dHJhbnNwYXJlbnQgbm8tcmVwZWF0IDAgMDsKfQoKLngtc2xpZGVyLXZlcnQgLngtc2xpZGVyLXRodW1iLW92ZXIgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogLTE1cHggLTE0cHg7Cn0KCi54LXNsaWRlci12ZXJ0IC54LXNsaWRlci10aHVtYi1kcmFnIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IC0zMHB4IC0yOHB4Owp9Lngtd2luZG93LWRsZyAueC13aW5kb3ctYm9keSB7CiAgICBib3JkZXI6MCBub25lICFpbXBvcnRhbnQ7CiAgICBwYWRkaW5nOjVweCAxMHB4OwogICAgb3ZlcmZsb3c6aGlkZGVuICFpbXBvcnRhbnQ7Cn0KCi54LXdpbmRvdy1kbGcgLngtd2luZG93LW1jIHsKICAgIGJvcmRlcjowIG5vbmUgIWltcG9ydGFudDsKfQoKLngtd2luZG93LWRsZyAuZXh0LW1iLWlucHV0IHsKICAgIG1hcmdpbi10b3A6NHB4OwogICAgd2lkdGg6OTUlOwp9CgoueC13aW5kb3ctZGxnIC5leHQtbWItdGV4dGFyZWEgewogICAgbWFyZ2luLXRvcDo0cHg7Cn0KCi54LXdpbmRvdy1kbGcgLngtcHJvZ3Jlc3Mtd3JhcCB7CiAgICBtYXJnaW4tdG9wOjRweDsKfQoKLmV4dC1pZSAueC13aW5kb3ctZGxnIC54LXByb2dyZXNzLXdyYXAgewogICAgbWFyZ2luLXRvcDo2cHg7Cn0KCi54LXdpbmRvdy1kbGcgLngtbXNnLWJveC13YWl0IHsKICAgIGJhY2tncm91bmQ6dHJhbnNwYXJlbnQgbm8tcmVwZWF0IGxlZnQ7CiAgICBkaXNwbGF5OmJsb2NrOwogICAgd2lkdGg6MzAwcHg7CiAgICBwYWRkaW5nLWxlZnQ6MThweDsKICAgIGxpbmUtaGVpZ2h0OjE4cHg7Cn0KCi54LXdpbmRvdy1kbGcgLmV4dC1tYi1pY29uIHsKICAgIGZsb2F0OmxlZnQ7CiAgICB3aWR0aDo0N3B4OwogICAgaGVpZ2h0OjMycHg7Cn0KCi54LXdpbmRvdy1kbGcgLngtZGxnLWljb24gLmV4dC1tYi1jb250ZW50ewogICAgem9vbTogMTsgCiAgICBtYXJnaW4tbGVmdDogNDdweDsKfQoKLngtd2luZG93LWRsZyAuZXh0LW1iLWluZm8sIC54LXdpbmRvdy1kbGcgLmV4dC1tYi13YXJuaW5nLCAueC13aW5kb3ctZGxnIC5leHQtbWItcXVlc3Rpb24sIC54LXdpbmRvdy1kbGcgLmV4dC1tYi1lcnJvciB7CiAgICBiYWNrZ3JvdW5kOnRyYW5zcGFyZW50IG5vLXJlcGVhdCB0b3AgbGVmdDsKfQoKLmV4dC1nZWNrbzIgLmV4dC1tYi1maXgtY3Vyc29yIHsKICAgIG92ZXJmbG93OmF1dG87Cn0uZXh0LWVsLW1hc2sgewogICAgYmFja2dyb3VuZC1jb2xvcjogI2NjYzsKfQoKLmV4dC1lbC1tYXNrLW1zZyB7CiAgICBib3JkZXItY29sb3I6IzY1OTNjZjsKICAgIGJhY2tncm91bmQtY29sb3I6I2MzZGFmOTsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2JveC90Yi1ibHVlLmdpZik7Cn0KLmV4dC1lbC1tYXNrLW1zZyBkaXYgewogICAgYmFja2dyb3VuZC1jb2xvcjogI2VlZTsKICAgIGJvcmRlci1jb2xvcjojYTNiYWQ5OwogICAgY29sb3I6IzIyMjsKICAgIGZvbnQ6bm9ybWFsIDExcHggdGFob21hLCBhcmlhbCwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmOwp9CgoueC1tYXNrLWxvYWRpbmcgZGl2IHsKICAgIGJhY2tncm91bmQtY29sb3I6I2ZiZmJmYjsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvbG9hZGluZy5naWYpOwp9CgoueC1pdGVtLWRpc2FibGVkIHsKICAgIGNvbG9yOiBncmF5Owp9CgoueC1pdGVtLWRpc2FibGVkICogewogICAgY29sb3I6IGdyYXkgIWltcG9ydGFudDsKfQoKLngtc3BsaXRiYXItcHJveHkgewogICAgYmFja2dyb3VuZC1jb2xvcjogI2FhYTsKfQoKLngtY29sb3ItcGFsZXR0ZSBhIHsKICAgIGJvcmRlci1jb2xvcjojZmZmOwp9CgoueC1jb2xvci1wYWxldHRlIGE6aG92ZXIsIC54LWNvbG9yLXBhbGV0dGUgYS54LWNvbG9yLXBhbGV0dGUtc2VsIHsKICAgIGJvcmRlci1jb2xvcjojOGJiOGYzOwogICAgYmFja2dyb3VuZC1jb2xvcjogI2RlZWNmZDsKfQoKLyoKLngtY29sb3ItcGFsZXR0ZSBlbTpob3ZlciwgLngtY29sb3ItcGFsZXR0ZSBzcGFuOmhvdmVyeyAgIAogICAgYmFja2dyb3VuZC1jb2xvcjogI2RlZWNmZDsKfQoqLwoKLngtY29sb3ItcGFsZXR0ZSBlbSB7CiAgICBib3JkZXItY29sb3I6I2FjYTg5OTsKfQoKLngtaWUtc2hhZG93IHsKICAgIGJhY2tncm91bmQtY29sb3I6Izc3NzsKfQoKLngtc2hhZG93IC54c21jIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9zaGFkb3ctYy5wbmcpOwp9CgoueC1zaGFkb3cgLnhzbWwsIC54LXNoYWRvdyAueHNtciB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvc2hhZG93LWxyLnBuZyk7Cn0KCi54LXNoYWRvdyAueHN0bCwgLngtc2hhZG93IC54c3RjLCAgLngtc2hhZG93IC54c3RyLCAueC1zaGFkb3cgLnhzYmwsIC54LXNoYWRvdyAueHNiYywgLngtc2hhZG93IC54c2JyewogICAgYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3NoYWRvdy5wbmcpOwp9CgoubG9hZGluZy1pbmRpY2F0b3IgewogICAgZm9udC1zaXplOiAxMXB4OwogICAgYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvbG9hZGluZy5naWYpOwp9CgoueC1zcG90bGlnaHQgewogICAgYmFja2dyb3VuZC1jb2xvcjogI2NjYzsKfQoueC10YWItcGFuZWwtaGVhZGVyLCAueC10YWItcGFuZWwtZm9vdGVyIHsKCWJhY2tncm91bmQtY29sb3I6ICNkZWVjZmQ7Cglib3JkZXItY29sb3I6IzhkYjJlMzsKICAgIG92ZXJmbG93OmhpZGRlbjsKICAgIHpvb206MTsKfQoKLngtdGFiLXBhbmVsLWhlYWRlciwgLngtdGFiLXBhbmVsLWZvb3RlciB7Cglib3JkZXItY29sb3I6IzhkYjJlMzsKfQoKdWwueC10YWItc3RyaXAtdG9wewogICAgYmFja2dyb3VuZC1jb2xvcjojY2VkZmY1OwoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RhYnMvdGFiLXN0cmlwLWJnLmdpZik7Cglib3JkZXItYm90dG9tLWNvbG9yOiM4ZGIyZTM7Cn0KCnVsLngtdGFiLXN0cmlwLWJvdHRvbXsKICAgIGJhY2tncm91bmQtY29sb3I6I2NlZGZmNTsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC90YWJzL3RhYi1zdHJpcC1idG0tYmcuZ2lmKTsKCWJvcmRlci10b3AtY29sb3I6IzhkYjJlMzsKfQoKLngtdGFiLXBhbmVsLWhlYWRlci1wbGFpbiAueC10YWItc3RyaXAtc3BhY2VyLAoueC10YWItcGFuZWwtZm9vdGVyLXBsYWluIC54LXRhYi1zdHJpcC1zcGFjZXIgewogICAgYm9yZGVyLWNvbG9yOiM4ZGIyZTM7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZGVlY2ZkOwp9CgoueC10YWItc3RyaXAgc3Bhbi54LXRhYi1zdHJpcC10ZXh0IHsKCWZvbnQ6bm9ybWFsIDExcHggdGFob21hLGFyaWFsLGhlbHZldGljYTsKCWNvbG9yOiM0MTZhYTM7Cn0KCi54LXRhYi1zdHJpcC1vdmVyIHNwYW4ueC10YWItc3RyaXAtdGV4dCB7Cgljb2xvcjojMTU0MjhiOwp9CgoueC10YWItc3RyaXAtYWN0aXZlIHNwYW4ueC10YWItc3RyaXAtdGV4dCB7Cgljb2xvcjojMTU0MjhiOwogICAgZm9udC13ZWlnaHQ6Ym9sZDsKfQoKLngtdGFiLXN0cmlwLWRpc2FibGVkIC54LXRhYnMtdGV4dCB7Cgljb2xvcjojYWFhYWFhOwp9CgoueC10YWItc3RyaXAtdG9wIC54LXRhYi1yaWdodCwgLngtdGFiLXN0cmlwLXRvcCAueC10YWItbGVmdCwgLngtdGFiLXN0cmlwLXRvcCAueC10YWItc3RyaXAtaW5uZXJ7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdGFicy90YWJzLXNwcml0ZS5naWYpOwp9CgoueC10YWItc3RyaXAtYm90dG9tIC54LXRhYi1yaWdodCB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdGFicy90YWItYnRtLWluYWN0aXZlLXJpZ2h0LWJnLmdpZik7Cn0KCi54LXRhYi1zdHJpcC1ib3R0b20gLngtdGFiLWxlZnQgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RhYnMvdGFiLWJ0bS1pbmFjdGl2ZS1sZWZ0LWJnLmdpZik7Cn0KCi54LXRhYi1zdHJpcC1ib3R0b20gLngtdGFiLXN0cmlwLW92ZXIgLngtdGFiLXJpZ2h0IHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC90YWJzL3RhYi1idG0tb3Zlci1yaWdodC1iZy5naWYpOwp9CgoueC10YWItc3RyaXAtYm90dG9tIC54LXRhYi1zdHJpcC1vdmVyIC54LXRhYi1sZWZ0IHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC90YWJzL3RhYi1idG0tb3Zlci1sZWZ0LWJnLmdpZik7Cn0KCi54LXRhYi1zdHJpcC1ib3R0b20gLngtdGFiLXN0cmlwLWFjdGl2ZSAueC10YWItcmlnaHQgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RhYnMvdGFiLWJ0bS1yaWdodC1iZy5naWYpOwp9CgoueC10YWItc3RyaXAtYm90dG9tIC54LXRhYi1zdHJpcC1hY3RpdmUgLngtdGFiLWxlZnQgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RhYnMvdGFiLWJ0bS1sZWZ0LWJnLmdpZik7Cn0KCi54LXRhYi1zdHJpcCAueC10YWItc3RyaXAtY2xvc2FibGUgYS54LXRhYi1zdHJpcC1jbG9zZSB7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90YWJzL3RhYi1jbG9zZS5naWYpOwp9CgoueC10YWItc3RyaXAgLngtdGFiLXN0cmlwLWNsb3NhYmxlIGEueC10YWItc3RyaXAtY2xvc2U6aG92ZXJ7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90YWJzL3RhYi1jbG9zZS5naWYpOwp9CgoueC10YWItcGFuZWwtYm9keSB7CiAgICBib3JkZXItY29sb3I6IzhkYjJlMzsKICAgIGJhY2tncm91bmQtY29sb3I6I2ZmZjsKfQoKLngtdGFiLXBhbmVsLWJvZHktdG9wIHsKICAgIGJvcmRlci10b3A6IDAgbm9uZTsKfQoKLngtdGFiLXBhbmVsLWJvZHktYm90dG9tIHsKICAgIGJvcmRlci1ib3R0b206IDAgbm9uZTsKfQoKLngtdGFiLXNjcm9sbGVyLWxlZnQgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdGFicy9zY3JvbGwtbGVmdC5naWYpOwogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjojOGRiMmUzOwp9CgoueC10YWItc2Nyb2xsZXItbGVmdC1vdmVyIHsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IDAgMDsKfQoKLngtdGFiLXNjcm9sbGVyLWxlZnQtZGlzYWJsZWQgewogICAgYmFja2dyb3VuZC1wb3NpdGlvbjogLTE4cHggMDsKICAgIG9wYWNpdHk6LjU7CiAgICAtbW96LW9wYWNpdHk6LjU7CiAgICBmaWx0ZXI6YWxwaGEob3BhY2l0eT01MCk7CiAgICBjdXJzb3I6ZGVmYXVsdDsKfQoKLngtdGFiLXNjcm9sbGVyLXJpZ2h0IHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RhYnMvc2Nyb2xsLXJpZ2h0LmdpZik7CiAgICBib3JkZXItYm90dG9tLWNvbG9yOiM4ZGIyZTM7Cn0KCi54LXRhYi1wYW5lbC1iYmFyIC54LXRvb2xiYXIsIC54LXRhYi1wYW5lbC10YmFyIC54LXRvb2xiYXIgewogICAgYm9yZGVyLWNvbG9yOiM5OWJiZTg7Cn0ueC1mb3JtLWZpZWxkIHsKICAgIGZvbnQ6bm9ybWFsIDEycHggdGFob21hLCBhcmlhbCwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmOwp9CgoueC1mb3JtLXRleHQsIHRleHRhcmVhLngtZm9ybS1maWVsZCB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNmZmY7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9mb3JtL3RleHQtYmcuZ2lmKTsKICAgIGJvcmRlci1jb2xvcjojYjViOGM4Owp9CgoueC1mb3JtLXNlbGVjdC1vbmUgewogICAgYmFja2dyb3VuZC1jb2xvcjojZmZmOwogICAgYm9yZGVyLWNvbG9yOiNiNWI4Yzg7Cn0KCi54LWZvcm0tY2hlY2stZ3JvdXAtbGFiZWwgewogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkICM5OWJiZTg7CiAgICBjb2xvcjogIzE1NDI4YjsKfQoKLngtZWRpdG9yIC54LWZvcm0tY2hlY2std3JhcCB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNmZmY7Cn0KCi54LWZvcm0tZmllbGQtd3JhcCAueC1mb3JtLXRyaWdnZXIgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZm9ybS90cmlnZ2VyLmdpZik7CiAgICBib3JkZXItYm90dG9tLWNvbG9yOiNiNWI4Yzg7Cn0KCi54LWZvcm0tZmllbGQtd3JhcCAueC1mb3JtLWRhdGUtdHJpZ2dlciB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZm9ybS9kYXRlLXRyaWdnZXIuZ2lmKTsKfQoKLngtZm9ybS1maWVsZC13cmFwIC54LWZvcm0tY2xlYXItdHJpZ2dlciB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZm9ybS9jbGVhci10cmlnZ2VyLmdpZik7Cn0KCi54LWZvcm0tZmllbGQtd3JhcCAueC1mb3JtLXNlYXJjaC10cmlnZ2VyIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9mb3JtL3NlYXJjaC10cmlnZ2VyLmdpZik7Cn0KCi54LXRyaWdnZXItd3JhcC1mb2N1cyAueC1mb3JtLXRyaWdnZXIgewogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjojN2VhZGQ5Owp9CgoueC1pdGVtLWRpc2FibGVkIC54LWZvcm0tdHJpZ2dlci1vdmVyIHsKICAgIGJvcmRlci1ib3R0b20tY29sb3I6I2I1YjhjODsKfQoKLngtaXRlbS1kaXNhYmxlZCAueC1mb3JtLXRyaWdnZXItY2xpY2sgewogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjojYjViOGM4Owp9CgoueC1mb3JtLWZvY3VzLCB0ZXh0YXJlYS54LWZvcm0tZm9jdXMgewoJYm9yZGVyLWNvbG9yOiM3ZWFkZDk7Cn0KCi54LWZvcm0taW52YWxpZCwgdGV4dGFyZWEueC1mb3JtLWludmFsaWQgewogICAgYmFja2dyb3VuZC1jb2xvcjojZmZmOwoJYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9pbnZhbGlkX2xpbmUuZ2lmKTsKCWJvcmRlci1jb2xvcjojYzMwOwp9CgoueC1mb3JtLWludmFsaWQueC1mb3JtLWNvbXBvc2l0ZSB7CiAgICBib3JkZXI6IG5vbmU7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiBub25lOwp9CgoueC1mb3JtLWludmFsaWQueC1mb3JtLWNvbXBvc2l0ZSAueC1mb3JtLWludmFsaWQgewogICAgYmFja2dyb3VuZC1jb2xvcjojZmZmOwoJYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9pbnZhbGlkX2xpbmUuZ2lmKTsKCWJvcmRlci1jb2xvcjojYzMwOwp9CgoueC1mb3JtLWlubmVyLWludmFsaWQsIHRleHRhcmVhLngtZm9ybS1pbm5lci1pbnZhbGlkIHsKICAgIGJhY2tncm91bmQtY29sb3I6I2ZmZjsKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvaW52YWxpZF9saW5lLmdpZik7Cn0KCi54LWZvcm0tZ3Jvdy1zaXplciB7Cglmb250Om5vcm1hbCAxMnB4IHRhaG9tYSwgYXJpYWwsIGhlbHZldGljYSwgc2Fucy1zZXJpZjsKfQoKLngtZm9ybS1pdGVtIHsKICAgIGZvbnQ6bm9ybWFsIDEycHggdGFob21hLCBhcmlhbCwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmOwp9CgoueC1mb3JtLWludmFsaWQtbXNnIHsKICAgIGNvbG9yOiNjMDI3MmI7CiAgICBmb250Om5vcm1hbCAxMXB4IHRhaG9tYSwgYXJpYWwsIGhlbHZldGljYSwgc2Fucy1zZXJpZjsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3NoYXJlZC93YXJuaW5nLmdpZik7Cn0KCi54LWZvcm0tZW1wdHktZmllbGQgewogICAgY29sb3I6Z3JheTsKfQoKLngtc21hbGwtZWRpdG9yIC54LWZvcm0tZmllbGQgewogICAgZm9udDpub3JtYWwgMTFweCBhcmlhbCwgdGFob21hLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWY7Cn0KCi5leHQtd2Via2l0IC54LXNtYWxsLWVkaXRvciAueC1mb3JtLWZpZWxkIHsKICAgIGZvbnQ6bm9ybWFsIDExcHggYXJpYWwsIHRhaG9tYSwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmOwp9CgoueC1mb3JtLWludmFsaWQtaWNvbiB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9mb3JtL2V4Y2xhbWF0aW9uLmdpZik7Cn0KCi54LWZpZWxkc2V0IHsKICAgIGJvcmRlci1jb2xvcjojYjViOGM4Owp9CgoueC1maWVsZHNldCBsZWdlbmQgewogICAgZm9udDpib2xkIDExcHggdGFob21hLCBhcmlhbCwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmOwogICAgY29sb3I6IzE1NDI4YjsKfQoueC1idG57Cglmb250Om5vcm1hbCAxMXB4IHRhaG9tYSwgdmVyZGFuYSwgaGVsdmV0aWNhOwp9CgoueC1idG4gYnV0dG9uewogICAgZm9udDpub3JtYWwgMTFweCBhcmlhbCx0YWhvbWEsdmVyZGFuYSxoZWx2ZXRpY2E7CiAgICBjb2xvcjojMzMzOwp9CgoueC1idG4gZW0gewogICAgZm9udC1zdHlsZTpub3JtYWw7CiAgICBmb250LXdlaWdodDpub3JtYWw7Cn0KCi54LWJ0bi10bCwgLngtYnRuLXRyLCAueC1idG4tdGMsIC54LWJ0bi1tbCwgLngtYnRuLW1yLCAueC1idG4tbWMsIC54LWJ0bi1ibCwgLngtYnRuLWJyLCAueC1idG4tYmN7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9idXR0b24vYnRuLmdpZik7Cn0KCi54LWJ0bi1jbGljayAueC1idG4tdGV4dCwgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi10ZXh0LCAueC1idG4tcHJlc3NlZCAueC1idG4tdGV4dHsKICAgIGNvbG9yOiMwMDA7Cn0KCi54LWJ0bi1kaXNhYmxlZCAqewoJY29sb3I6Z3JheSAhaW1wb3J0YW50Owp9CgoueC1idG4tbWMgZW0ueC1idG4tYXJyb3cgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvYnV0dG9uL2Fycm93LmdpZik7Cn0KCi54LWJ0bi1tYyBlbS54LWJ0bi1zcGxpdCB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9idXR0b24vcy1hcnJvdy5naWYpOwp9CgoueC1idG4tb3ZlciAueC1idG4tbWMgZW0ueC1idG4tc3BsaXQsIC54LWJ0bi1jbGljayAueC1idG4tbWMgZW0ueC1idG4tc3BsaXQsIC54LWJ0bi1tZW51LWFjdGl2ZSAueC1idG4tbWMgZW0ueC1idG4tc3BsaXQsIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi1tYyBlbS54LWJ0bi1zcGxpdCB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9idXR0b24vcy1hcnJvdy1vLmdpZik7Cn0KCi54LWJ0bi1tYyBlbS54LWJ0bi1hcnJvdy1ib3R0b20gewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvYnV0dG9uL3MtYXJyb3ctYi1ub2xpbmUuZ2lmKTsKfQoKLngtYnRuLW1jIGVtLngtYnRuLXNwbGl0LWJvdHRvbSB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9idXR0b24vcy1hcnJvdy1iLmdpZik7Cn0KCi54LWJ0bi1vdmVyIC54LWJ0bi1tYyBlbS54LWJ0bi1zcGxpdC1ib3R0b20sIC54LWJ0bi1jbGljayAueC1idG4tbWMgZW0ueC1idG4tc3BsaXQtYm90dG9tLCAueC1idG4tbWVudS1hY3RpdmUgLngtYnRuLW1jIGVtLngtYnRuLXNwbGl0LWJvdHRvbSwgLngtYnRuLXByZXNzZWQgLngtYnRuLW1jIGVtLngtYnRuLXNwbGl0LWJvdHRvbSB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9idXR0b24vcy1hcnJvdy1iby5naWYpOwp9CgoueC1idG4tZ3JvdXAtaGVhZGVyIHsKICAgIGNvbG9yOiAjM2U2YWFhOwp9CgoueC1idG4tZ3JvdXAtdGMgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2J1dHRvbi9ncm91cC10Yi5naWYpOwp9CgoueC1idG4tZ3JvdXAtdGwgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2J1dHRvbi9ncm91cC1jcy5naWYpOwp9CgoueC1idG4tZ3JvdXAtdHIgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2J1dHRvbi9ncm91cC1jcy5naWYpOwp9CgoueC1idG4tZ3JvdXAtYmMgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2J1dHRvbi9ncm91cC10Yi5naWYpOwp9CgoueC1idG4tZ3JvdXAtYmwgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2J1dHRvbi9ncm91cC1jcy5naWYpOwp9CgoueC1idG4tZ3JvdXAtYnIgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2J1dHRvbi9ncm91cC1jcy5naWYpOwp9CgoueC1idG4tZ3JvdXAtbWwgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2J1dHRvbi9ncm91cC1sci5naWYpOwp9Ci54LWJ0bi1ncm91cC1tciB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvYnV0dG9uL2dyb3VwLWxyLmdpZik7Cn0KCi54LWJ0bi1ncm91cC1ub3RpdGxlIC54LWJ0bi1ncm91cC10YyB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvYnV0dG9uL2dyb3VwLXRiLmdpZik7Cn0ueC10b29sYmFyewoJYm9yZGVyLWNvbG9yOiNhOWJmZDM7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNkMGRlZjA7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90b29sYmFyL2JnLmdpZik7Cn0KCi54LXRvb2xiYXIgdGQsLngtdG9vbGJhciBzcGFuLC54LXRvb2xiYXIgaW5wdXQsLngtdG9vbGJhciBkaXYsLngtdG9vbGJhciBzZWxlY3QsLngtdG9vbGJhciBsYWJlbHsKICAgIGZvbnQ6bm9ybWFsIDExcHggYXJpYWwsdGFob21hLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWY7Cn0KCi54LXRvb2xiYXIgLngtaXRlbS1kaXNhYmxlZCB7Cgljb2xvcjpncmF5Owp9CgoueC10b29sYmFyIC54LWl0ZW0tZGlzYWJsZWQgKiB7Cgljb2xvcjpncmF5Owp9CgoueC10b29sYmFyIC54LWJ0bi1tYyBlbS54LWJ0bi1zcGxpdCB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9idXR0b24vcy1hcnJvdy1ub2xpbmUuZ2lmKTsKfQoKLngtdG9vbGJhciAueC1idG4tb3ZlciAueC1idG4tbWMgZW0ueC1idG4tc3BsaXQsIC54LXRvb2xiYXIgLngtYnRuLWNsaWNrIC54LWJ0bi1tYyBlbS54LWJ0bi1zcGxpdCwKLngtdG9vbGJhciAueC1idG4tbWVudS1hY3RpdmUgLngtYnRuLW1jIGVtLngtYnRuLXNwbGl0LCAueC10b29sYmFyIC54LWJ0bi1wcmVzc2VkIC54LWJ0bi1tYyBlbS54LWJ0bi1zcGxpdAp7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9idXR0b24vcy1hcnJvdy1vLmdpZik7Cn0KCi54LXRvb2xiYXIgLngtYnRuLW1jIGVtLngtYnRuLXNwbGl0LWJvdHRvbSB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9idXR0b24vcy1hcnJvdy1iLW5vbGluZS5naWYpOwp9CgoueC10b29sYmFyIC54LWJ0bi1vdmVyIC54LWJ0bi1tYyBlbS54LWJ0bi1zcGxpdC1ib3R0b20sIC54LXRvb2xiYXIgLngtYnRuLWNsaWNrIC54LWJ0bi1tYyBlbS54LWJ0bi1zcGxpdC1ib3R0b20sCi54LXRvb2xiYXIgLngtYnRuLW1lbnUtYWN0aXZlIC54LWJ0bi1tYyBlbS54LWJ0bi1zcGxpdC1ib3R0b20sIC54LXRvb2xiYXIgLngtYnRuLXByZXNzZWQgLngtYnRuLW1jIGVtLngtYnRuLXNwbGl0LWJvdHRvbQp7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9idXR0b24vcy1hcnJvdy1iby5naWYpOwp9CgoueC10b29sYmFyIC54dGItc2VwIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL2dyaWQtYmx1ZS1zcGxpdC5naWYpOwp9CgoueC10YmFyLXBhZ2UtZmlyc3R7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9wYWdlLWZpcnN0LmdpZikgIWltcG9ydGFudDsKfQoKLngtdGJhci1sb2FkaW5newoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvcmVmcmVzaC5naWYpICFpbXBvcnRhbnQ7Cn0KCi54LXRiYXItcGFnZS1sYXN0ewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvcGFnZS1sYXN0LmdpZikgIWltcG9ydGFudDsKfQoKLngtdGJhci1wYWdlLW5leHR7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9wYWdlLW5leHQuZ2lmKSAhaW1wb3J0YW50Owp9CgoueC10YmFyLXBhZ2UtcHJldnsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL3BhZ2UtcHJldi5naWYpICFpbXBvcnRhbnQ7Cn0KCi54LWl0ZW0tZGlzYWJsZWQgLngtdGJhci1sb2FkaW5newoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvcmVmcmVzaC1kaXNhYmxlZC5naWYpICFpbXBvcnRhbnQ7Cn0KCi54LWl0ZW0tZGlzYWJsZWQgLngtdGJhci1wYWdlLWZpcnN0ewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvcGFnZS1maXJzdC1kaXNhYmxlZC5naWYpICFpbXBvcnRhbnQ7Cn0KCi54LWl0ZW0tZGlzYWJsZWQgLngtdGJhci1wYWdlLWxhc3R7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9wYWdlLWxhc3QtZGlzYWJsZWQuZ2lmKSAhaW1wb3J0YW50Owp9CgoueC1pdGVtLWRpc2FibGVkIC54LXRiYXItcGFnZS1uZXh0ewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvcGFnZS1uZXh0LWRpc2FibGVkLmdpZikgIWltcG9ydGFudDsKfQoKLngtaXRlbS1kaXNhYmxlZCAueC10YmFyLXBhZ2UtcHJldnsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL3BhZ2UtcHJldi1kaXNhYmxlZC5naWYpICFpbXBvcnRhbnQ7Cn0KCi54LXBhZ2luZy1pbmZvIHsKICAgIGNvbG9yOiM0NDQ7Cn0KCi54LXRvb2xiYXItbW9yZS1pY29uIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC90b29sYmFyL21vcmUuZ2lmKSAhaW1wb3J0YW50Owp9LngtcmVzaXphYmxlLWhhbmRsZSB7CgliYWNrZ3JvdW5kLWNvbG9yOiNmZmY7Cn0KCi54LXJlc2l6YWJsZS1vdmVyIC54LXJlc2l6YWJsZS1oYW5kbGUtZWFzdCwgLngtcmVzaXphYmxlLXBpbm5lZCAueC1yZXNpemFibGUtaGFuZGxlLWVhc3QsCi54LXJlc2l6YWJsZS1vdmVyIC54LXJlc2l6YWJsZS1oYW5kbGUtd2VzdCwgLngtcmVzaXphYmxlLXBpbm5lZCAueC1yZXNpemFibGUtaGFuZGxlLXdlc3QKewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvc2l6ZXIvZS1oYW5kbGUuZ2lmKTsKfQoKLngtcmVzaXphYmxlLW92ZXIgLngtcmVzaXphYmxlLWhhbmRsZS1zb3V0aCwgLngtcmVzaXphYmxlLXBpbm5lZCAueC1yZXNpemFibGUtaGFuZGxlLXNvdXRoLAoueC1yZXNpemFibGUtb3ZlciAueC1yZXNpemFibGUtaGFuZGxlLW5vcnRoLCAueC1yZXNpemFibGUtcGlubmVkIC54LXJlc2l6YWJsZS1oYW5kbGUtbm9ydGgKewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvc2l6ZXIvcy1oYW5kbGUuZ2lmKTsKfQoKLngtcmVzaXphYmxlLW92ZXIgLngtcmVzaXphYmxlLWhhbmRsZS1ub3J0aCwgLngtcmVzaXphYmxlLXBpbm5lZCAueC1yZXNpemFibGUtaGFuZGxlLW5vcnRoewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvc2l6ZXIvcy1oYW5kbGUuZ2lmKTsKfQoueC1yZXNpemFibGUtb3ZlciAueC1yZXNpemFibGUtaGFuZGxlLXNvdXRoZWFzdCwgLngtcmVzaXphYmxlLXBpbm5lZCAueC1yZXNpemFibGUtaGFuZGxlLXNvdXRoZWFzdHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3NpemVyL3NlLWhhbmRsZS5naWYpOwp9Ci54LXJlc2l6YWJsZS1vdmVyIC54LXJlc2l6YWJsZS1oYW5kbGUtbm9ydGh3ZXN0LCAueC1yZXNpemFibGUtcGlubmVkIC54LXJlc2l6YWJsZS1oYW5kbGUtbm9ydGh3ZXN0ewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvc2l6ZXIvbnctaGFuZGxlLmdpZik7Cn0KLngtcmVzaXphYmxlLW92ZXIgLngtcmVzaXphYmxlLWhhbmRsZS1ub3J0aGVhc3QsIC54LXJlc2l6YWJsZS1waW5uZWQgLngtcmVzaXphYmxlLWhhbmRsZS1ub3J0aGVhc3R7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9zaXplci9uZS1oYW5kbGUuZ2lmKTsKfQoueC1yZXNpemFibGUtb3ZlciAueC1yZXNpemFibGUtaGFuZGxlLXNvdXRod2VzdCwgLngtcmVzaXphYmxlLXBpbm5lZCAueC1yZXNpemFibGUtaGFuZGxlLXNvdXRod2VzdHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3NpemVyL3N3LWhhbmRsZS5naWYpOwp9Ci54LXJlc2l6YWJsZS1wcm94eXsKICAgIGJvcmRlci1jb2xvcjojM2I1YTgyOwp9Ci54LXJlc2l6YWJsZS1vdmVybGF5ewogICAgYmFja2dyb3VuZC1jb2xvcjojZmZmOwp9Ci54LWdyaWQzIHsKICAgIGJhY2tncm91bmQtY29sb3I6I2ZmZjsKfQoKLngtZ3JpZC1wYW5lbCAueC1wYW5lbC1tYyAueC1wYW5lbC1ib2R5IHsKICAgIGJvcmRlci1jb2xvcjojOTliYmU4Owp9CgoueC1ncmlkMy1yb3cgdGQsIC54LWdyaWQzLXN1bW1hcnktcm93IHRkewoJZm9udDpub3JtYWwgMTFweC8xM3B4IGFyaWFsLCB0YWhvbWEsIGhlbHZldGljYSwgc2Fucy1zZXJpZjsKfQoKLngtZ3JpZDMtaGQtcm93IHRkIHsKCWZvbnQ6bm9ybWFsIDExcHgvMTVweCBhcmlhbCwgdGFob21hLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWY7Cn0KCgoueC1ncmlkMy1oZC1yb3cgdGQgewogICAgYm9yZGVyLWxlZnQtY29sb3I6I2VlZTsKICAgIGJvcmRlci1yaWdodC1jb2xvcjojZDBkMGQwOwp9CgoueC1ncmlkLXJvdy1sb2FkaW5nIHsKICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmY7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9zaGFyZWQvbG9hZGluZy1iYWxscy5naWYpOwp9CgoueC1ncmlkMy1yb3cgewogICAgYm9yZGVyLWNvbG9yOiNlZGVkZWQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiNmZmY7Cn0KCi54LWdyaWQzLXJvdy1hbHR7CgliYWNrZ3JvdW5kLWNvbG9yOiNmYWZhZmE7Cn0KCi54LWdyaWQzLXJvdy1vdmVyIHsKCWJvcmRlci1jb2xvcjojZGRkOwogICAgYmFja2dyb3VuZC1jb2xvcjojZWZlZmVmOwogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9yb3ctb3Zlci5naWYpOwp9CgoueC1ncmlkMy1yZXNpemUtcHJveHkgewogICAgYmFja2dyb3VuZC1jb2xvcjojNzc3Owp9CgoueC1ncmlkMy1yZXNpemUtbWFya2VyIHsKICAgIGJhY2tncm91bmQtY29sb3I6Izc3NzsKfQoKLngtZ3JpZDMtaGVhZGVyewogICAgYmFja2dyb3VuZC1jb2xvcjojZjlmOWY5OwoJYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9ncmlkMy1ocm93LmdpZik7Cn0KCi54LWdyaWQzLWhlYWRlci1wb3AgewogICAgYm9yZGVyLWxlZnQtY29sb3I6I2QwZDBkMDsKfQoKLngtZ3JpZDMtaGVhZGVyLXBvcC1pbm5lciB7CiAgICBib3JkZXItbGVmdC1jb2xvcjojZWVlOwogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9oZC1wb3AuZ2lmKTsKfQoKdGQueC1ncmlkMy1oZC1vdmVyLCB0ZC5zb3J0LWRlc2MsIHRkLnNvcnQtYXNjLCB0ZC54LWdyaWQzLWhkLW1lbnUtb3BlbiB7CiAgICBib3JkZXItbGVmdC1jb2xvcjojYWFjY2Y2OwogICAgYm9yZGVyLXJpZ2h0LWNvbG9yOiNhYWNjZjY7Cn0KCnRkLngtZ3JpZDMtaGQtb3ZlciAueC1ncmlkMy1oZC1pbm5lciwgdGQuc29ydC1kZXNjIC54LWdyaWQzLWhkLWlubmVyLCB0ZC5zb3J0LWFzYyAueC1ncmlkMy1oZC1pbm5lciwgdGQueC1ncmlkMy1oZC1tZW51LW9wZW4gLngtZ3JpZDMtaGQtaW5uZXIgewogICAgYmFja2dyb3VuZC1jb2xvcjojZWJmM2ZkOwogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9ncmlkMy1ocm93LW92ZXIuZ2lmKTsKCn0KCi5zb3J0LWFzYyAueC1ncmlkMy1zb3J0LWljb24gewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvc29ydF9hc2MuZ2lmKTsKfQoKLnNvcnQtZGVzYyAueC1ncmlkMy1zb3J0LWljb24gewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvc29ydF9kZXNjLmdpZik7Cn0KCi54LWdyaWQzLWNlbGwtdGV4dCwgLngtZ3JpZDMtaGQtdGV4dCB7Cgljb2xvcjojMDAwOwp9CgoueC1ncmlkMy1zcGxpdCB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9ncmlkLXNwbGl0LmdpZik7Cn0KCi54LWdyaWQzLWhkLXRleHQgewoJY29sb3I6IzE1NDI4YjsKfQoKLngtZGQtZHJhZy1wcm94eSAueC1ncmlkMy1oZC1pbm5lcnsKICAgIGJhY2tncm91bmQtY29sb3I6I2ViZjNmZDsKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvZ3JpZDMtaHJvdy1vdmVyLmdpZik7Cglib3JkZXItY29sb3I6I2FhY2NmNjsKfQoKLmNvbC1tb3ZlLXRvcHsKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvY29sLW1vdmUtdG9wLmdpZik7Cn0KCi5jb2wtbW92ZS1ib3R0b217CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL2NvbC1tb3ZlLWJvdHRvbS5naWYpOwp9Cgp0ZC5ncmlkLWhkLWdyb3VwLWNlbGwgewogICAgYmFja2dyb3VuZDogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvZ3JpZDMtaHJvdy5naWYpIHJlcGVhdC14IGJvdHRvbTsKfQoKLngtZ3JpZDMtcm93LXNlbGVjdGVkIHsKCWJhY2tncm91bmQtY29sb3I6ICNkZmU4ZjYgIWltcG9ydGFudDsKCWJhY2tncm91bmQtaW1hZ2U6IG5vbmU7Cglib3JkZXItY29sb3I6I2EzYmFlOTsKfQoKLngtZ3JpZDMtY2VsbC1zZWxlY3RlZHsKCWJhY2tncm91bmQtY29sb3I6ICNiOGNmZWUgIWltcG9ydGFudDsKCWNvbG9yOiMwMDA7Cn0KCi54LWdyaWQzLWNlbGwtc2VsZWN0ZWQgc3BhbnsKCWNvbG9yOiMwMDAgIWltcG9ydGFudDsKfQoKLngtZ3JpZDMtY2VsbC1zZWxlY3RlZCAueC1ncmlkMy1jZWxsLXRleHR7Cgljb2xvcjojMDAwOwp9CgoueC1ncmlkMy1sb2NrZWQgdGQueC1ncmlkMy1yb3ctbWFya2VyLCAueC1ncmlkMy1sb2NrZWQgLngtZ3JpZDMtcm93LXNlbGVjdGVkIHRkLngtZ3JpZDMtcm93LW1hcmtlcnsKICAgIGJhY2tncm91bmQtY29sb3I6I2ViZWFkYiAhaW1wb3J0YW50OwogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9ncmlkLWhyb3cuZ2lmKSAhaW1wb3J0YW50OwogICAgY29sb3I6IzAwMDsKICAgIGJvcmRlci10b3AtY29sb3I6I2ZmZjsKICAgIGJvcmRlci1yaWdodC1jb2xvcjojNmZhMGRmICFpbXBvcnRhbnQ7Cn0KCi54LWdyaWQzLWxvY2tlZCB0ZC54LWdyaWQzLXJvdy1tYXJrZXIgZGl2LCAueC1ncmlkMy1sb2NrZWQgLngtZ3JpZDMtcm93LXNlbGVjdGVkIHRkLngtZ3JpZDMtcm93LW1hcmtlciBkaXZ7CiAgICBjb2xvcjojMTU0MjhiICFpbXBvcnRhbnQ7Cn0KCi54LWdyaWQzLWRpcnR5LWNlbGwgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9kaXJ0eS5naWYpOwp9CgoueC1ncmlkMy10b3BiYXIsIC54LWdyaWQzLWJvdHRvbWJhcnsKCWZvbnQ6bm9ybWFsIDExcHggYXJpYWwsIHRhaG9tYSwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmOwp9CgoueC1ncmlkMy1ib3R0b21iYXIgLngtdG9vbGJhcnsKCWJvcmRlci10b3AtY29sb3I6I2E5YmZkMzsKfQoKLngtcHJvcHMtZ3JpZCAueC1ncmlkMy10ZC1uYW1lIC54LWdyaWQzLWNlbGwtaW5uZXJ7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL2dyaWQzLXNwZWNpYWwtY29sLWJnLmdpZikgIWltcG9ydGFudDsKICAgIGNvbG9yOiMwMDAgIWltcG9ydGFudDsKfQoKLngtcHJvcHMtZ3JpZCAueC1ncmlkMy1ib2R5IC54LWdyaWQzLXRkLW5hbWV7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNmZmYgIWltcG9ydGFudDsKICAgIGJvcmRlci1yaWdodC1jb2xvcjojZWVlOwp9CgoueGctaG1lbnUtc29ydC1hc2MgLngtbWVudS1pdGVtLWljb257CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9obWVudS1hc2MuZ2lmKTsKfQoKLnhnLWhtZW51LXNvcnQtZGVzYyAueC1tZW51LWl0ZW0taWNvbnsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL2htZW51LWRlc2MuZ2lmKTsKfQoKLnhnLWhtZW51LWxvY2sgLngtbWVudS1pdGVtLWljb257CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9obWVudS1sb2NrLmdpZik7Cn0KCi54Zy1obWVudS11bmxvY2sgLngtbWVudS1pdGVtLWljb257CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9obWVudS11bmxvY2suZ2lmKTsKfQoKLngtZ3JpZDMtaGQtYnRuIHsKICAgIGJhY2tncm91bmQtY29sb3I6I2MzZGFmOTsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvZ3JpZDMtaGQtYnRuLmdpZik7Cn0KCi54LWdyaWQzLWJvZHkgLngtZ3JpZDMtdGQtZXhwYW5kZXIgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9ncmlkMy1zcGVjaWFsLWNvbC1iZy5naWYpOwp9CgoueC1ncmlkMy1yb3ctZXhwYW5kZXIgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9yb3ctZXhwYW5kLXNwcml0ZS5naWYpOwp9CgoueC1ncmlkMy1ib2R5IC54LWdyaWQzLXRkLWNoZWNrZXIgewogICAgYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvZ3JpZDMtc3BlY2lhbC1jb2wtYmcuZ2lmKTsKfQoKLngtZ3JpZDMtcm93LWNoZWNrZXIsIC54LWdyaWQzLWhkLWNoZWNrZXIgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9yb3ctY2hlY2stc3ByaXRlLmdpZik7Cn0KCi54LWdyaWQzLWJvZHkgLngtZ3JpZDMtdGQtbnVtYmVyZXIgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9ncmlkMy1zcGVjaWFsLWNvbC1iZy5naWYpOwp9CgoueC1ncmlkMy1ib2R5IC54LWdyaWQzLXRkLW51bWJlcmVyIC54LWdyaWQzLWNlbGwtaW5uZXIgewoJY29sb3I6IzQ0NDsKfQoKLngtZ3JpZDMtYm9keSAueC1ncmlkMy10ZC1yb3ctaWNvbiB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL2dyaWQzLXNwZWNpYWwtY29sLWJnLmdpZik7Cn0KCi54LWdyaWQzLWJvZHkgLngtZ3JpZDMtcm93LXNlbGVjdGVkIC54LWdyaWQzLXRkLW51bWJlcmVyLAoueC1ncmlkMy1ib2R5IC54LWdyaWQzLXJvdy1zZWxlY3RlZCAueC1ncmlkMy10ZC1jaGVja2VyLAoueC1ncmlkMy1ib2R5IC54LWdyaWQzLXJvdy1zZWxlY3RlZCAueC1ncmlkMy10ZC1leHBhbmRlciB7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL2dyaWQzLXNwZWNpYWwtY29sLXNlbC1iZy5naWYpOwp9CgoueC1ncmlkMy1jaGVjay1jb2wgewoJYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvbWVudS91bmNoZWNrZWQuZ2lmKTsKfQoKLngtZ3JpZDMtY2hlY2stY29sLW9uIHsKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L21lbnUvY2hlY2tlZC5naWYpOwp9CgoueC1ncmlkLWdyb3VwLCAueC1ncmlkLWdyb3VwLWJvZHksIC54LWdyaWQtZ3JvdXAtaGQgewogICAgem9vbToxOwp9CgoueC1ncmlkLWdyb3VwLWhkIHsKICAgIGJvcmRlci1ib3R0b20tY29sb3I6Izk5YmJlODsKfQoKLngtZ3JpZC1ncm91cC1oZCBkaXYueC1ncmlkLWdyb3VwLXRpdGxlIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvZ3JvdXAtY29sbGFwc2UuZ2lmKTsKICAgIGNvbG9yOiMzNzY0YTA7CiAgICBmb250OmJvbGQgMTFweCB0YWhvbWEsIGFyaWFsLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWY7Cn0KCi54LWdyaWQtZ3JvdXAtY29sbGFwc2VkIC54LWdyaWQtZ3JvdXAtaGQgZGl2LngtZ3JpZC1ncm91cC10aXRsZSB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL2dyb3VwLWV4cGFuZC5naWYpOwp9CgoueC1ncm91cC1ieS1pY29uIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvZ3JvdXAtYnkuZ2lmKTsKfQoKLngtY29scy1pY29uIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvY29sdW1ucy5naWYpOwp9CgoueC1zaG93LWdyb3Vwcy1pY29uIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvZ3JvdXAtYnkuZ2lmKTsKfQoKLngtZ3JpZC1lbXB0eSB7CiAgICBjb2xvcjpncmF5OwogICAgZm9udDpub3JtYWwgMTFweCB0YWhvbWEsIGFyaWFsLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWY7Cn0KCi54LWdyaWQtd2l0aC1jb2wtbGluZXMgLngtZ3JpZDMtcm93IHRkLngtZ3JpZDMtY2VsbCB7CiAgICBib3JkZXItcmlnaHQtY29sb3I6I2VkZWRlZDsKfQoKLngtZ3JpZC13aXRoLWNvbC1saW5lcyAueC1ncmlkMy1yb3ctc2VsZWN0ZWQgewoJYm9yZGVyLXRvcC1jb2xvcjojYTNiYWU5Owp9LngtcGl2b3RncmlkIC54LWdyaWQzLWhlYWRlci1vZmZzZXQgdGFibGUgdGQgewogICAgYmFja2dyb3VuZDogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvZ3JpZDMtaHJvdy5naWYpIHJlcGVhdC14IDUwJSAxMDAlOwogICAgYm9yZGVyLWxlZnQ6IDFweCBzb2xpZDsKICAgIGJvcmRlci1yaWdodDogMXB4IHNvbGlkOwogICAgYm9yZGVyLWxlZnQtY29sb3I6ICNFRUU7CiAgICBib3JkZXItcmlnaHQtY29sb3I6ICNEMEQwRDA7Cn0KCi54LXBpdm90Z3JpZCAueC1ncmlkMy1yb3ctaGVhZGVycyB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZjlmOWY5Owp9CgoueC1waXZvdGdyaWQgLngtZ3JpZDMtcm93LWhlYWRlcnMgdGFibGUgdGQgewogICAgYmFja2dyb3VuZDogI0VFRSB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZ3JpZC9ncmlkMy1yb3doZWFkZXIuZ2lmKSByZXBlYXQteCBsZWZ0IHRvcDsKICAgIGJvcmRlci1sZWZ0OiAxcHggc29saWQ7CiAgICBib3JkZXItcmlnaHQ6IDFweCBzb2xpZDsKICAgIGJvcmRlci1sZWZ0LWNvbG9yOiAjRUVFOwogICAgYm9yZGVyLXJpZ2h0LWNvbG9yOiAjRDBEMEQwOwogICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkOwogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogI0QwRDBEMDsKICAgIGhlaWdodDogMThweDsKfQoueC1kZC1kcmFnLWdob3N0ewoJY29sb3I6IzAwMDsKCWZvbnQ6IG5vcm1hbCAxMXB4IGFyaWFsLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWY7CiAgICBib3JkZXItY29sb3I6ICNkZGQgI2JiYiAjYmJiICNkZGQ7CgliYWNrZ3JvdW5kLWNvbG9yOiNmZmY7Cn0KCi54LWRkLWRyb3Atbm9kcm9wIC54LWRkLWRyb3AtaWNvbnsKICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZGQvZHJvcC1uby5naWYpOwp9CgoueC1kZC1kcm9wLW9rIC54LWRkLWRyb3AtaWNvbnsKICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZGQvZHJvcC15ZXMuZ2lmKTsKfQoKLngtZGQtZHJvcC1vay1hZGQgLngtZGQtZHJvcC1pY29uewogIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9kZC9kcm9wLWFkZC5naWYpOwp9CgoueC12aWV3LXNlbGVjdG9yIHsKICAgIGJhY2tncm91bmQtY29sb3I6I2MzZGFmOTsKICAgIGJvcmRlci1jb2xvcjojMzM5OWJiOwp9LngtdHJlZS1ub2RlLWV4cGFuZGVkIC54LXRyZWUtbm9kZS1pY29uewoJYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdHJlZS9mb2xkZXItb3Blbi5naWYpOwp9CgoueC10cmVlLW5vZGUtbGVhZiAueC10cmVlLW5vZGUtaWNvbnsKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RyZWUvbGVhZi5naWYpOwp9CgoueC10cmVlLW5vZGUtY29sbGFwc2VkIC54LXRyZWUtbm9kZS1pY29uewoJYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdHJlZS9mb2xkZXIuZ2lmKTsKfQoKLngtdHJlZS1ub2RlLWxvYWRpbmcgLngtdHJlZS1ub2RlLWljb257CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90cmVlL2xvYWRpbmcuZ2lmKSAhaW1wb3J0YW50Owp9CgoueC10cmVlLW5vZGUgLngtdHJlZS1ub2RlLWlubGluZS1pY29uIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6IG5vbmU7Cn0KCi54LXRyZWUtbm9kZS1sb2FkaW5nIGEgc3BhbnsKCSBmb250LXN0eWxlOiBpdGFsaWM7CgkgY29sb3I6IzQ0NDQ0NDsKfQoKLngtdHJlZS1saW5lcyAueC10cmVlLWVsYm93ewoJYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdHJlZS9lbGJvdy5naWYpOwp9CgoueC10cmVlLWxpbmVzIC54LXRyZWUtZWxib3ctcGx1c3sKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RyZWUvZWxib3ctcGx1cy5naWYpOwp9CgoueC10cmVlLWxpbmVzIC54LXRyZWUtZWxib3ctbWludXN7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90cmVlL2VsYm93LW1pbnVzLmdpZik7Cn0KCi54LXRyZWUtbGluZXMgLngtdHJlZS1lbGJvdy1lbmR7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90cmVlL2VsYm93LWVuZC5naWYpOwp9CgoueC10cmVlLWxpbmVzIC54LXRyZWUtZWxib3ctZW5kLXBsdXN7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90cmVlL2VsYm93LWVuZC1wbHVzLmdpZik7Cn0KCi54LXRyZWUtbGluZXMgLngtdHJlZS1lbGJvdy1lbmQtbWludXN7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90cmVlL2VsYm93LWVuZC1taW51cy5naWYpOwp9CgoueC10cmVlLWxpbmVzIC54LXRyZWUtZWxib3ctbGluZXsKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RyZWUvZWxib3ctbGluZS5naWYpOwp9CgoueC10cmVlLW5vLWxpbmVzIC54LXRyZWUtZWxib3ctcGx1c3sKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RyZWUvZWxib3ctcGx1cy1ubC5naWYpOwp9CgoueC10cmVlLW5vLWxpbmVzIC54LXRyZWUtZWxib3ctbWludXN7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90cmVlL2VsYm93LW1pbnVzLW5sLmdpZik7Cn0KCi54LXRyZWUtbm8tbGluZXMgLngtdHJlZS1lbGJvdy1lbmQtcGx1c3sKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RyZWUvZWxib3ctZW5kLXBsdXMtbmwuZ2lmKTsKfQoKLngtdHJlZS1uby1saW5lcyAueC10cmVlLWVsYm93LWVuZC1taW51c3sKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RyZWUvZWxib3ctZW5kLW1pbnVzLW5sLmdpZik7Cn0KCi54LXRyZWUtYXJyb3dzIC54LXRyZWUtZWxib3ctcGx1c3sKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RyZWUvYXJyb3dzLmdpZik7Cn0KCi54LXRyZWUtYXJyb3dzIC54LXRyZWUtZWxib3ctbWludXN7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90cmVlL2Fycm93cy5naWYpOwp9CgoueC10cmVlLWFycm93cyAueC10cmVlLWVsYm93LWVuZC1wbHVzewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdHJlZS9hcnJvd3MuZ2lmKTsKfQoKLngtdHJlZS1hcnJvd3MgLngtdHJlZS1lbGJvdy1lbmQtbWludXN7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC90cmVlL2Fycm93cy5naWYpOwp9CgoueC10cmVlLW5vZGV7Cgljb2xvcjojMDAwOwoJZm9udDogbm9ybWFsIDExcHggYXJpYWwsIHRhaG9tYSwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmOwp9CgoueC10cmVlLW5vZGUgYSwgLngtZGQtZHJhZy1naG9zdCBhewoJY29sb3I6IzAwMDsKfQoKLngtdHJlZS1ub2RlIGEgc3BhbiwgLngtZGQtZHJhZy1naG9zdCBhIHNwYW57Cgljb2xvcjojMDAwOwp9CgoueC10cmVlLW5vZGUgLngtdHJlZS1ub2RlLWRpc2FibGVkIGEgc3BhbnsKCWNvbG9yOmdyYXkgIWltcG9ydGFudDsKfQoKLngtdHJlZS1ub2RlIGRpdi54LXRyZWUtZHJhZy1pbnNlcnQtYmVsb3d7CiAJIGJvcmRlci1ib3R0b20tY29sb3I6IzM2YzsKfQoKLngtdHJlZS1ub2RlIGRpdi54LXRyZWUtZHJhZy1pbnNlcnQtYWJvdmV7CgkgYm9yZGVyLXRvcC1jb2xvcjojMzZjOwp9CgoueC10cmVlLWRkLXVuZGVybGluZSAueC10cmVlLW5vZGUgZGl2LngtdHJlZS1kcmFnLWluc2VydC1iZWxvdyBhewogCSBib3JkZXItYm90dG9tLWNvbG9yOiMzNmM7Cn0KCi54LXRyZWUtZGQtdW5kZXJsaW5lIC54LXRyZWUtbm9kZSBkaXYueC10cmVlLWRyYWctaW5zZXJ0LWFib3ZlIGF7CgkgYm9yZGVyLXRvcC1jb2xvcjojMzZjOwp9CgoueC10cmVlLW5vZGUgLngtdHJlZS1kcmFnLWFwcGVuZCBhIHNwYW57CgkgYmFja2dyb3VuZC1jb2xvcjojZGRkOwoJIGJvcmRlci1jb2xvcjpncmF5Owp9CgoueC10cmVlLW5vZGUgLngtdHJlZS1ub2RlLW92ZXIgewoJYmFja2dyb3VuZC1jb2xvcjogI2VlZTsKfQoKLngtdHJlZS1ub2RlIC54LXRyZWUtc2VsZWN0ZWQgewoJYmFja2dyb3VuZC1jb2xvcjogI2Q5ZThmYjsKfQoKLngtdHJlZS1kcm9wLW9rLWFwcGVuZCAueC1kZC1kcm9wLWljb257CiAgYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3RyZWUvZHJvcC1hZGQuZ2lmKTsKfQoKLngtdHJlZS1kcm9wLW9rLWFib3ZlIC54LWRkLWRyb3AtaWNvbnsKICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdHJlZS9kcm9wLW92ZXIuZ2lmKTsKfQoKLngtdHJlZS1kcm9wLW9rLWJlbG93IC54LWRkLWRyb3AtaWNvbnsKICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdHJlZS9kcm9wLXVuZGVyLmdpZik7Cn0KCi54LXRyZWUtZHJvcC1vay1iZXR3ZWVuIC54LWRkLWRyb3AtaWNvbnsKICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvdHJlZS9kcm9wLWJldHdlZW4uZ2lmKTsKfS54LWRhdGUtcGlja2VyIHsKICAgIGJvcmRlci1jb2xvcjogIzFiMzc2YzsKICAgIGJhY2tncm91bmQtY29sb3I6I2ZmZjsKfQoKLngtZGF0ZS1taWRkbGUsLngtZGF0ZS1sZWZ0LC54LWRhdGUtcmlnaHQgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3NoYXJlZC9oZC1zcHJpdGUuZ2lmKTsKCWNvbG9yOiNmZmY7Cglmb250OmJvbGQgMTFweCAic2FucyBzZXJpZiIsIHRhaG9tYSwgdmVyZGFuYSwgaGVsdmV0aWNhOwp9CgoueC1kYXRlLW1pZGRsZSAueC1idG4gLngtYnRuLXRleHQgewogICAgY29sb3I6I2ZmZjsKfQoKLngtZGF0ZS1taWRkbGUgLngtYnRuLW1jIGVtLngtYnRuLWFycm93IHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3Rvb2xiYXIvYnRuLWFycm93LWxpZ2h0LmdpZik7Cn0KCi54LWRhdGUtcmlnaHQgYSB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvc2hhcmVkL3JpZ2h0LWJ0bi5naWYpOwp9CgoueC1kYXRlLWxlZnQgYXsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9zaGFyZWQvbGVmdC1idG4uZ2lmKTsKfQoKLngtZGF0ZS1pbm5lciB0aCB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNkZmVjZmI7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9zaGFyZWQvZ2xhc3MtYmcuZ2lmKTsKCWJvcmRlci1ib3R0b20tY29sb3I6I2EzYmFkOTsKICAgIGZvbnQ6bm9ybWFsIDEwcHggYXJpYWwsIGhlbHZldGljYSx0YWhvbWEsc2Fucy1zZXJpZjsKCWNvbG9yOiMyMzNkNmQ7Cn0KCi54LWRhdGUtaW5uZXIgdGQgewogICAgYm9yZGVyLWNvbG9yOiNmZmY7Cn0KCi54LWRhdGUtaW5uZXIgYSB7CiAgICBmb250Om5vcm1hbCAxMXB4IGFyaWFsLCBoZWx2ZXRpY2EsdGFob21hLHNhbnMtc2VyaWY7CiAgICBjb2xvcjojMDAwOwp9CgoueC1kYXRlLWlubmVyIC54LWRhdGUtYWN0aXZlewoJY29sb3I6IzAwMDsKfQoKLngtZGF0ZS1pbm5lciAueC1kYXRlLXNlbGVjdGVkIGF7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNkZmVjZmI7CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9zaGFyZWQvZ2xhc3MtYmcuZ2lmKTsKCWJvcmRlci1jb2xvcjojOGRiMmUzOwp9CgoueC1kYXRlLWlubmVyIC54LWRhdGUtdG9kYXkgYXsKCWJvcmRlci1jb2xvcjpkYXJrcmVkOwp9CgoueC1kYXRlLWlubmVyIC54LWRhdGUtc2VsZWN0ZWQgc3BhbnsKICAgIGZvbnQtd2VpZ2h0OmJvbGQ7Cn0KCi54LWRhdGUtaW5uZXIgLngtZGF0ZS1wcmV2ZGF5IGEsLngtZGF0ZS1pbm5lciAueC1kYXRlLW5leHRkYXkgYSB7Cgljb2xvcjojYWFhOwp9CgoueC1kYXRlLWJvdHRvbSB7CiAgICBib3JkZXItdG9wLWNvbG9yOiNhM2JhZDk7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNkZmVjZmI7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9zaGFyZWQvZ2xhc3MtYmcuZ2lmKTsKfQoKLngtZGF0ZS1pbm5lciBhOmhvdmVyLCAueC1kYXRlLWlubmVyIC54LWRhdGUtZGlzYWJsZWQgYTpob3ZlcnsKICAgIGNvbG9yOiMwMDA7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNkZGVjZmU7Cn0KCi54LWRhdGUtaW5uZXIgLngtZGF0ZS1kaXNhYmxlZCBhIHsKCWJhY2tncm91bmQtY29sb3I6I2VlZTsKCWNvbG9yOiNiYmI7Cn0KCi54LWRhdGUtbW1lbnV7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNlZWUgIWltcG9ydGFudDsKfQoKLngtZGF0ZS1tbWVudSAueC1tZW51LWl0ZW0gewoJZm9udC1zaXplOjEwcHg7Cgljb2xvcjojMDAwOwp9CgoueC1kYXRlLW1wIHsKCWJhY2tncm91bmQtY29sb3I6I2ZmZjsKfQoKLngtZGF0ZS1tcCB0ZCB7Cglmb250Om5vcm1hbCAxMXB4IGFyaWFsLCBoZWx2ZXRpY2EsdGFob21hLHNhbnMtc2VyaWY7Cn0KCi54LWRhdGUtbXAtYnRucyBidXR0b24gewoJYmFja2dyb3VuZC1jb2xvcjojMDgzNzcyOwoJY29sb3I6I2ZmZjsKCWJvcmRlci1jb2xvcjogIzMzNjZjYyAjMDAwMDU1ICMwMDAwNTUgIzMzNjZjYzsKCWZvbnQ6bm9ybWFsIDExcHggYXJpYWwsIGhlbHZldGljYSx0YWhvbWEsc2Fucy1zZXJpZjsKfQoKLngtZGF0ZS1tcC1idG5zIHsKICAgIGJhY2tncm91bmQtY29sb3I6ICNkZmVjZmI7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvc2hhcmVkL2dsYXNzLWJnLmdpZik7Cn0KCi54LWRhdGUtbXAtYnRucyB0ZCB7Cglib3JkZXItdG9wLWNvbG9yOiAjYzVkMmRmOwp9Cgp0ZC54LWRhdGUtbXAtbW9udGggYSx0ZC54LWRhdGUtbXAteWVhciBhIHsKCWNvbG9yOiMxNTQyOGI7Cn0KCnRkLngtZGF0ZS1tcC1tb250aCBhOmhvdmVyLHRkLngtZGF0ZS1tcC15ZWFyIGE6aG92ZXIgewoJY29sb3I6IzE1NDI4YjsKCWJhY2tncm91bmQtY29sb3I6ICNkZGVjZmU7Cn0KCnRkLngtZGF0ZS1tcC1zZWwgYSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjZGZlY2ZiOwoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3NoYXJlZC9nbGFzcy1iZy5naWYpOwoJYm9yZGVyLWNvbG9yOiM4ZGIyZTM7Cn0KCi54LWRhdGUtbXAteWJ0biBhIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3BhbmVsL3Rvb2wtc3ByaXRlcy5naWYpOwp9Cgp0ZC54LWRhdGUtbXAtc2VwIHsKICAgYm9yZGVyLXJpZ2h0LWNvbG9yOiNjNWQyZGY7Cn0ueC10aXAgLngtdGlwLWNsb3NlewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3F0aXAvY2xvc2UuZ2lmKTsKfQoKLngtdGlwIC54LXRpcC10YywgLngtdGlwIC54LXRpcC10bCwgLngtdGlwIC54LXRpcC10ciwgLngtdGlwIC54LXRpcC1iYywgLngtdGlwIC54LXRpcC1ibCwgLngtdGlwIC54LXRpcC1iciwgLngtdGlwIC54LXRpcC1tbCwgLngtdGlwIC54LXRpcC1tciB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvcXRpcC90aXAtc3ByaXRlLmdpZik7Cn0KCi54LXRpcCAueC10aXAtbWMgewogICAgZm9udDogbm9ybWFsIDExcHggdGFob21hLGFyaWFsLGhlbHZldGljYSxzYW5zLXNlcmlmOwp9Ci54LXRpcCAueC10aXAtbWwgewoJYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsKfQoKLngtdGlwIC54LXRpcC1oZWFkZXItdGV4dCB7CiAgICBmb250OiBib2xkIDExcHggdGFob21hLGFyaWFsLGhlbHZldGljYSxzYW5zLXNlcmlmOwogICAgY29sb3I6IzQ0NDsKfQoKLngtdGlwIC54LXRpcC1ib2R5IHsKICAgIGZvbnQ6IG5vcm1hbCAxMXB4IHRhaG9tYSxhcmlhbCxoZWx2ZXRpY2Esc2Fucy1zZXJpZjsKICAgIGNvbG9yOiM0NDQ7Cn0KCi54LWZvcm0taW52YWxpZC10aXAgLngtdGlwLXRjLCAueC1mb3JtLWludmFsaWQtdGlwIC54LXRpcC10bCwgLngtZm9ybS1pbnZhbGlkLXRpcCAueC10aXAtdHIsIC54LWZvcm0taW52YWxpZC10aXAgLngtdGlwLWJjLAoueC1mb3JtLWludmFsaWQtdGlwIC54LXRpcC1ibCwgLngtZm9ybS1pbnZhbGlkLXRpcCAueC10aXAtYnIsIC54LWZvcm0taW52YWxpZC10aXAgLngtdGlwLW1sLCAueC1mb3JtLWludmFsaWQtdGlwIC54LXRpcC1tcgp7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvZm9ybS9lcnJvci10aXAtY29ybmVycy5naWYpOwp9CgoueC1mb3JtLWludmFsaWQtdGlwIC54LXRpcC1ib2R5IHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2Zvcm0vZXhjbGFtYXRpb24uZ2lmKTsKfQoKLngtdGlwLWFuY2hvciB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9xdGlwL3RpcC1hbmNob3Itc3ByaXRlLmdpZik7Cn0ueC1tZW51IHsKICAgIGJhY2tncm91bmQtY29sb3I6I2YwZjBmMDsKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L21lbnUvbWVudS5naWYpOwp9CgoueC1tZW51LWZsb2F0aW5newogICAgYm9yZGVyLWNvbG9yOiM3MThiYjc7Cn0KCi54LW1lbnUtbm9zZXAgewoJYmFja2dyb3VuZC1pbWFnZTpub25lOwp9CgoueC1tZW51LWxpc3QtaXRlbXsKCWZvbnQ6bm9ybWFsIDExcHggYXJpYWwsdGFob21hLHNhbnMtc2VyaWY7Cn0KCi54LW1lbnUtaXRlbS1hcnJvd3sKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L21lbnUvbWVudS1wYXJlbnQuZ2lmKTsKfQoKLngtbWVudS1zZXAgewogICAgYmFja2dyb3VuZC1jb2xvcjojZTBlMGUwOwoJYm9yZGVyLWJvdHRvbS1jb2xvcjojZmZmOwp9CgphLngtbWVudS1pdGVtIHsKCWNvbG9yOiMyMjI7Cn0KCi54LW1lbnUtaXRlbS1hY3RpdmUgewogICAgYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L21lbnUvaXRlbS1vdmVyLmdpZik7CgliYWNrZ3JvdW5kLWNvbG9yOiAjZGJlY2Y0OwogICAgYm9yZGVyLWNvbG9yOiNhYWNjZjY7Cn0KCi54LW1lbnUtaXRlbS1hY3RpdmUgYS54LW1lbnUtaXRlbSB7Cglib3JkZXItY29sb3I6I2FhY2NmNjsKfQoKLngtbWVudS1jaGVjay1pdGVtIC54LW1lbnUtaXRlbS1pY29uewoJYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvbWVudS91bmNoZWNrZWQuZ2lmKTsKfQoKLngtbWVudS1pdGVtLWNoZWNrZWQgLngtbWVudS1pdGVtLWljb257CgliYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9tZW51L2NoZWNrZWQuZ2lmKTsKfQoKLngtbWVudS1pdGVtLWNoZWNrZWQgLngtbWVudS1ncm91cC1pdGVtIC54LW1lbnUtaXRlbS1pY29uewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvbWVudS9ncm91cC1jaGVja2VkLmdpZik7Cn0KCi54LW1lbnUtZ3JvdXAtaXRlbSAueC1tZW51LWl0ZW0taWNvbnsKICAgIGJhY2tncm91bmQtaW1hZ2U6bm9uZTsKfQoKLngtbWVudS1wbGFpbiB7CgliYWNrZ3JvdW5kLWNvbG9yOiNmMGYwZjAgIWltcG9ydGFudDsKICAgIGJhY2tncm91bmQtaW1hZ2U6IG5vbmU7Cn0KCi54LWRhdGUtbWVudSwgLngtY29sb3ItbWVudXsKICAgIGJhY2tncm91bmQtY29sb3I6ICNmZmYgIWltcG9ydGFudDsKfQoKLngtbWVudSAueC1kYXRlLXBpY2tlcnsKICAgIGJvcmRlci1jb2xvcjojYTNiYWQ5Owp9CgoueC1jeWNsZS1tZW51IC54LW1lbnUtaXRlbS1jaGVja2VkIHsKICAgIGJvcmRlci1jb2xvcjojYTNiYWU5ICFpbXBvcnRhbnQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNkZWY4ZjY7Cn0KCi54LW1lbnUtc2Nyb2xsZXItdG9wIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2xheW91dC9taW5pLXRvcC5naWYpOwp9CgoueC1tZW51LXNjcm9sbGVyLWJvdHRvbSB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9sYXlvdXQvbWluaS1ib3R0b20uZ2lmKTsKfQoueC1ib3gtdGwgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2JveC9jb3JuZXJzLmdpZik7Cn0KCi54LWJveC10YyB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvYm94L3RiLmdpZik7Cn0KCi54LWJveC10ciB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvYm94L2Nvcm5lcnMuZ2lmKTsKfQoKLngtYm94LW1sIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9ib3gvbC5naWYpOwp9CgoueC1ib3gtbWMgewoJYmFja2dyb3VuZC1jb2xvcjogI2VlZTsKICAgIGJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9ib3gvdGIuZ2lmKTsKCWZvbnQtZmFtaWx5OiAiTXlyaWFkIFBybyIsIk15cmlhZCBXZWIiLCJUYWhvbWEiLCJIZWx2ZXRpY2EiLCJBcmlhbCIsc2Fucy1zZXJpZjsKCWNvbG9yOiAjMzkzOTM5OwoJZm9udC1zaXplOiAxMnB4Owp9CgoueC1ib3gtbWMgaDMgewoJZm9udC1zaXplOiAxNHB4OwoJZm9udC13ZWlnaHQ6IGJvbGQ7Cn0KCi54LWJveC1tciB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvYm94L3IuZ2lmKTsKfQoKLngtYm94LWJsIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9ib3gvY29ybmVycy5naWYpOwp9CgoueC1ib3gtYmMgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2JveC90Yi5naWYpOwp9CgoueC1ib3gtYnIgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2JveC9jb3JuZXJzLmdpZik7Cn0KCi54LWJveC1ibHVlIC54LWJveC1ibCwgLngtYm94LWJsdWUgLngtYm94LWJyLCAueC1ib3gtYmx1ZSAueC1ib3gtdGwsIC54LWJveC1ibHVlIC54LWJveC10ciB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvYm94L2Nvcm5lcnMtYmx1ZS5naWYpOwp9CgoueC1ib3gtYmx1ZSAueC1ib3gtYmMsIC54LWJveC1ibHVlIC54LWJveC1tYywgLngtYm94LWJsdWUgLngtYm94LXRjIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9ib3gvdGItYmx1ZS5naWYpOwp9CgoueC1ib3gtYmx1ZSAueC1ib3gtbWMgewoJYmFja2dyb3VuZC1jb2xvcjogI2MzZGFmOTsKfQoKLngtYm94LWJsdWUgLngtYm94LW1jIGgzIHsKCWNvbG9yOiAjMTczODViOwp9CgoueC1ib3gtYmx1ZSAueC1ib3gtbWwgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L2JveC9sLWJsdWUuZ2lmKTsKfQoKLngtYm94LWJsdWUgLngtYm94LW1yIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9ib3gvci1ibHVlLmdpZik7Cn0ueC1jb21iby1saXN0IHsKICAgIGJvcmRlci1jb2xvcjojOThjMGY0OwogICAgYmFja2dyb3VuZC1jb2xvcjojZGRlY2ZlOwogICAgZm9udDpub3JtYWwgMTJweCB0YWhvbWEsIGFyaWFsLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWY7Cn0KCi54LWNvbWJvLWxpc3QtaW5uZXIgewogICAgYmFja2dyb3VuZC1jb2xvcjojZmZmOwp9CgoueC1jb21iby1saXN0LWhkIHsKICAgIGZvbnQ6Ym9sZCAxMXB4IHRhaG9tYSwgYXJpYWwsIGhlbHZldGljYSwgc2Fucy1zZXJpZjsKICAgIGNvbG9yOiMxNTQyOGI7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvbGF5b3V0L3BhbmVsLXRpdGxlLWxpZ2h0LWJnLmdpZik7CiAgICBib3JkZXItYm90dG9tLWNvbG9yOiM5OGMwZjQ7Cn0KCi54LXJlc2l6YWJsZS1waW5uZWQgLngtY29tYm8tbGlzdC1pbm5lciB7CiAgICBib3JkZXItYm90dG9tLWNvbG9yOiM5OGMwZjQ7Cn0KCi54LWNvbWJvLWxpc3QtaXRlbSB7CiAgICBib3JkZXItY29sb3I6I2ZmZjsKfQoKLngtY29tYm8tbGlzdCAueC1jb21iby1zZWxlY3RlZHsKCWJvcmRlci1jb2xvcjojYTNiYWU5ICFpbXBvcnRhbnQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNkZmU4ZjY7Cn0KCi54LWNvbWJvLWxpc3QgLngtdG9vbGJhciB7CiAgICBib3JkZXItdG9wLWNvbG9yOiM5OGMwZjQ7Cn0KCi54LWNvbWJvLWxpc3Qtc21hbGwgewogICAgZm9udDpub3JtYWwgMTFweCB0YWhvbWEsIGFyaWFsLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWY7Cn0ueC1wYW5lbCB7CiAgICBib3JkZXItY29sb3I6ICM5OWJiZTg7Cn0KCi54LXBhbmVsLWhlYWRlciB7CiAgICBjb2xvcjojMTU0MjhiOwoJZm9udC13ZWlnaHQ6Ym9sZDsgCiAgICBmb250LXNpemU6IDExcHg7CiAgICBmb250LWZhbWlseTogdGFob21hLGFyaWFsLHZlcmRhbmEsc2Fucy1zZXJpZjsKICAgIGJvcmRlci1jb2xvcjojOTliYmU4OwogICAgYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3BhbmVsL3doaXRlLXRvcC1ib3R0b20uZ2lmKTsKfQoKLngtcGFuZWwtYm9keSB7CiAgICBib3JkZXItY29sb3I6Izk5YmJlODsKICAgIGJhY2tncm91bmQtY29sb3I6I2ZmZjsKfQoKLngtcGFuZWwtYmJhciAueC10b29sYmFyLCAueC1wYW5lbC10YmFyIC54LXRvb2xiYXIgewogICAgYm9yZGVyLWNvbG9yOiM5OWJiZTg7Cn0KCi54LXBhbmVsLXRiYXItbm9oZWFkZXIgLngtdG9vbGJhciwgLngtcGFuZWwtbWMgLngtcGFuZWwtdGJhciAueC10b29sYmFyIHsKICAgIGJvcmRlci10b3AtY29sb3I6Izk5YmJlODsKfQoKLngtcGFuZWwtYm9keS1ub2hlYWRlciwgLngtcGFuZWwtbWMgLngtcGFuZWwtYm9keSB7CiAgICBib3JkZXItdG9wLWNvbG9yOiM5OWJiZTg7Cn0KCi54LXBhbmVsLXRsIC54LXBhbmVsLWhlYWRlciB7CiAgICBjb2xvcjojMTU0MjhiOwoJZm9udDpib2xkIDExcHggdGFob21hLGFyaWFsLHZlcmRhbmEsc2Fucy1zZXJpZjsKfQoKLngtcGFuZWwtdGMgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3BhbmVsL3RvcC1ib3R0b20uZ2lmKTsKfQoKLngtcGFuZWwtdGwsIC54LXBhbmVsLXRyLCAueC1wYW5lbC1ibCwgIC54LXBhbmVsLWJyewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3BhbmVsL2Nvcm5lcnMtc3ByaXRlLmdpZik7CiAgICBib3JkZXItYm90dG9tLWNvbG9yOiM5OWJiZTg7Cn0KCi54LXBhbmVsLWJjIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC9wYW5lbC90b3AtYm90dG9tLmdpZik7Cn0KCi54LXBhbmVsLW1jIHsKICAgIGZvbnQ6IG5vcm1hbCAxMXB4IHRhaG9tYSxhcmlhbCxoZWx2ZXRpY2Esc2Fucy1zZXJpZjsKICAgIGJhY2tncm91bmQtY29sb3I6I2RmZThmNjsKfQoKLngtcGFuZWwtbWwgewoJYmFja2dyb3VuZC1jb2xvcjogI2ZmZjsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L3BhbmVsL2xlZnQtcmlnaHQuZ2lmKTsKfQoKLngtcGFuZWwtbXIgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3BhbmVsL2xlZnQtcmlnaHQuZ2lmKTsKfQoKLngtdG9vbCB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9wYW5lbC90b29sLXNwcml0ZXMuZ2lmKTsKfQoKLngtcGFuZWwtZ2hvc3QgewogICAgYmFja2dyb3VuZC1jb2xvcjojY2JkZGYzOwp9CgoueC1wYW5lbC1naG9zdCB1bCB7CiAgICBib3JkZXItY29sb3I6Izk5YmJlODsKfQoKLngtcGFuZWwtZGQtc3BhY2VyIHsKICAgIGJvcmRlci1jb2xvcjojOTliYmU4Owp9CgoueC1wYW5lbC1mYmFyIHRkLC54LXBhbmVsLWZiYXIgc3BhbiwueC1wYW5lbC1mYmFyIGlucHV0LC54LXBhbmVsLWZiYXIgZGl2LC54LXBhbmVsLWZiYXIgc2VsZWN0LC54LXBhbmVsLWZiYXIgbGFiZWx7CiAgICBmb250Om5vcm1hbCAxMXB4IGFyaWFsLHRhaG9tYSwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmOwp9Ci54LXdpbmRvdy1wcm94eSB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNjN2RmZmM7CiAgICBib3JkZXItY29sb3I6Izk5YmJlODsKfQoKLngtd2luZG93LXRsIC54LXdpbmRvdy1oZWFkZXIgewogICAgY29sb3I6IzE1NDI4YjsKCWZvbnQ6Ym9sZCAxMXB4IHRhaG9tYSxhcmlhbCx2ZXJkYW5hLHNhbnMtc2VyaWY7Cn0KCi54LXdpbmRvdy10YyB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvd2luZG93L3RvcC1ib3R0b20ucG5nKTsKfQoKLngtd2luZG93LXRsIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC93aW5kb3cvbGVmdC1jb3JuZXJzLnBuZyk7Cn0KCi54LXdpbmRvdy10ciB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvd2luZG93L3JpZ2h0LWNvcm5lcnMucG5nKTsKfQoKLngtd2luZG93LWJjIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC93aW5kb3cvdG9wLWJvdHRvbS5wbmcpOwp9CgoueC13aW5kb3ctYmwgewoJYmFja2dyb3VuZC1pbWFnZTogdXJsKC4uL2ltYWdlcy9kZWZhdWx0L3dpbmRvdy9sZWZ0LWNvcm5lcnMucG5nKTsKfQoKLngtd2luZG93LWJyIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC93aW5kb3cvcmlnaHQtY29ybmVycy5wbmcpOwp9CgoueC13aW5kb3ctbWMgewogICAgYm9yZGVyLWNvbG9yOiM5OWJiZTg7CiAgICBmb250OiBub3JtYWwgMTFweCB0YWhvbWEsYXJpYWwsaGVsdmV0aWNhLHNhbnMtc2VyaWY7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNkZmU4ZjY7Cn0KCi54LXdpbmRvdy1tbCB7CgliYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvd2luZG93L2xlZnQtcmlnaHQucG5nKTsKfQoKLngtd2luZG93LW1yIHsKCWJhY2tncm91bmQtaW1hZ2U6IHVybCguLi9pbWFnZXMvZGVmYXVsdC93aW5kb3cvbGVmdC1yaWdodC5wbmcpOwp9CgoueC13aW5kb3ctbWF4aW1pemVkIC54LXdpbmRvdy10YyB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNmZmY7Cn0KCi54LXdpbmRvdy1iYmFyIC54LXRvb2xiYXIgewogICAgYm9yZGVyLXRvcC1jb2xvcjojOTliYmU4Owp9CgoueC1wYW5lbC1naG9zdCAueC13aW5kb3ctdGwgewogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjojOTliYmU4Owp9CgoueC1wYW5lbC1jb2xsYXBzZWQgLngtd2luZG93LXRsIHsKICAgIGJvcmRlci1ib3R0b20tY29sb3I6Izg0YTBjNDsKfQoKLngtZGxnLW1hc2t7CiAgIGJhY2tncm91bmQtY29sb3I6I2NjYzsKfQoKLngtd2luZG93LXBsYWluIC54LXdpbmRvdy1tYyB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjY2NkOWU4OwogICAgYm9yZGVyLWNvbG9yOiAjYTNiYWU5ICNkZmU4ZjYgI2RmZThmNiAjYTNiYWU5Owp9CgoueC13aW5kb3ctcGxhaW4gLngtd2luZG93LWJvZHkgewogICAgYm9yZGVyLWNvbG9yOiAjZGZlOGY2ICNhM2JhZTkgI2EzYmFlOSAjZGZlOGY2Owp9Cgpib2R5LngtYm9keS1tYXNrZWQgLngtd2luZG93LXBsYWluIC54LXdpbmRvdy1tYyB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjY2NkOWU4Owp9LngtaHRtbC1lZGl0b3Itd3JhcCB7CiAgICBib3JkZXItY29sb3I6I2E5YmZkMzsKICAgIGJhY2tncm91bmQtY29sb3I6I2ZmZjsKfQoueC1odG1sLWVkaXRvci10YiAueC1idG4tdGV4dCB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9lZGl0b3IvdGItc3ByaXRlLmdpZik7Cn0ueC1wYW5lbC1ub2JvcmRlciAueC1wYW5lbC1oZWFkZXItbm9ib3JkZXIgewogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjojOTliYmU4Owp9CgoueC1wYW5lbC1ub2JvcmRlciAueC1wYW5lbC10YmFyLW5vYm9yZGVyIC54LXRvb2xiYXIgewogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjojOTliYmU4Owp9CgoueC1wYW5lbC1ub2JvcmRlciAueC1wYW5lbC1iYmFyLW5vYm9yZGVyIC54LXRvb2xiYXIgewogICAgYm9yZGVyLXRvcC1jb2xvcjojOTliYmU4Owp9CgoueC10YWItcGFuZWwtYmJhci1ub2JvcmRlciAueC10b29sYmFyIHsKICAgIGJvcmRlci10b3AtY29sb3I6Izk5YmJlODsKfQoKLngtdGFiLXBhbmVsLXRiYXItbm9ib3JkZXIgLngtdG9vbGJhciB7CiAgICBib3JkZXItYm90dG9tLWNvbG9yOiM5OWJiZTg7Cn0ueC1ib3JkZXItbGF5b3V0LWN0IHsKICAgIGJhY2tncm91bmQtY29sb3I6I2RmZThmNjsKfQoKLngtYWNjb3JkaW9uLWhkIHsKCWNvbG9yOiMyMjI7CiAgICBmb250LXdlaWdodDpub3JtYWw7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvcGFuZWwvbGlnaHQtaGQuZ2lmKTsKfQoKLngtbGF5b3V0LWNvbGxhcHNlZHsKICAgIGJhY2tncm91bmQtY29sb3I6I2QyZTBmMjsKCWJvcmRlci1jb2xvcjojOThjMGY0Owp9CgoueC1sYXlvdXQtY29sbGFwc2VkLW92ZXJ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNkOWU4ZmI7Cn0KCi54LWxheW91dC1zcGxpdC13ZXN0IC54LWxheW91dC1taW5pIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2xheW91dC9taW5pLWxlZnQuZ2lmKTsKfQoueC1sYXlvdXQtc3BsaXQtZWFzdCAueC1sYXlvdXQtbWluaSB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9sYXlvdXQvbWluaS1yaWdodC5naWYpOwp9Ci54LWxheW91dC1zcGxpdC1ub3J0aCAueC1sYXlvdXQtbWluaSB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9sYXlvdXQvbWluaS10b3AuZ2lmKTsKfQoueC1sYXlvdXQtc3BsaXQtc291dGggLngtbGF5b3V0LW1pbmkgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvbGF5b3V0L21pbmktYm90dG9tLmdpZik7Cn0KCi54LWxheW91dC1jbWluaS13ZXN0IC54LWxheW91dC1taW5pIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2xheW91dC9taW5pLXJpZ2h0LmdpZik7Cn0KCi54LWxheW91dC1jbWluaS1lYXN0IC54LWxheW91dC1taW5pIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2xheW91dC9taW5pLWxlZnQuZ2lmKTsKfQoKLngtbGF5b3V0LWNtaW5pLW5vcnRoIC54LWxheW91dC1taW5pIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2xheW91dC9taW5pLWJvdHRvbS5naWYpOwp9CgoueC1sYXlvdXQtY21pbmktc291dGggLngtbGF5b3V0LW1pbmkgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvbGF5b3V0L21pbmktdG9wLmdpZik7Cn0ueC1wcm9ncmVzcy13cmFwIHsKICAgIGJvcmRlci1jb2xvcjojNjU5M2NmOwp9CgoueC1wcm9ncmVzcy1pbm5lciB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNlMGU4ZjM7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9xdGlwL2JnLmdpZik7Cn0KCi54LXByb2dyZXNzLWJhciB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiM5Y2JmZWU7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9wcm9ncmVzcy9wcm9ncmVzcy1iZy5naWYpOwogICAgYm9yZGVyLXRvcC1jb2xvcjojZDFlNGZkOwogICAgYm9yZGVyLWJvdHRvbS1jb2xvcjojN2ZhOWU0OwogICAgYm9yZGVyLXJpZ2h0LWNvbG9yOiM3ZmE5ZTQ7Cn0KCi54LXByb2dyZXNzLXRleHQgewogICAgZm9udC1zaXplOjExcHg7CiAgICBmb250LXdlaWdodDpib2xkOwogICAgY29sb3I6I2ZmZjsKfQoKLngtcHJvZ3Jlc3MtdGV4dC1iYWNrIHsKICAgIGNvbG9yOiMzOTYwOTU7Cn0ueC1saXN0LWhlYWRlcnsKICAgIGJhY2tncm91bmQtY29sb3I6I2Y5ZjlmOTsKCWJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvZ3JpZDMtaHJvdy5naWYpOwp9CgoueC1saXN0LWhlYWRlci1pbm5lciBkaXYgZW0gewogICAgYm9yZGVyLWxlZnQtY29sb3I6I2RkZDsKICAgIGZvbnQ6bm9ybWFsIDExcHggYXJpYWwsIHRhaG9tYSwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmOwp9CgoueC1saXN0LWJvZHkgZHQgZW0gewogICAgZm9udDpub3JtYWwgMTFweCBhcmlhbCwgdGFob21hLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWY7Cn0KCi54LWxpc3Qtb3ZlciB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiNlZWU7Cn0KCi54LWxpc3Qtc2VsZWN0ZWQgewogICAgYmFja2dyb3VuZC1jb2xvcjojZGZlOGY2Owp9CgoueC1saXN0LXJlc2l6ZXIgewogICAgYm9yZGVyLWxlZnQtY29sb3I6IzU1NTsKICAgIGJvcmRlci1yaWdodC1jb2xvcjojNTU1Owp9CgoueC1saXN0LWhlYWRlci1pbm5lciBlbS5zb3J0LWFzYywgLngtbGlzdC1oZWFkZXItaW5uZXIgZW0uc29ydC1kZXNjIHsKICAgIGJhY2tncm91bmQtaW1hZ2U6dXJsKC4uL2ltYWdlcy9kZWZhdWx0L2dyaWQvc29ydC1oZC5naWYpOwogICAgYm9yZGVyLWNvbG9yOiAjOTliYmU4Owp9Lngtc2xpZGVyLWhvcnosIC54LXNsaWRlci1ob3J6IC54LXNsaWRlci1lbmQsIC54LXNsaWRlci1ob3J6IC54LXNsaWRlci1pbm5lciB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9zbGlkZXIvc2xpZGVyLWJnLnBuZyk7Cn0KCi54LXNsaWRlci1ob3J6IC54LXNsaWRlci10aHVtYiB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9zbGlkZXIvc2xpZGVyLXRodW1iLnBuZyk7Cn0KCi54LXNsaWRlci12ZXJ0LCAueC1zbGlkZXItdmVydCAueC1zbGlkZXItZW5kLCAueC1zbGlkZXItdmVydCAueC1zbGlkZXItaW5uZXIgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvc2xpZGVyL3NsaWRlci12LWJnLnBuZyk7Cn0KCi54LXNsaWRlci12ZXJ0IC54LXNsaWRlci10aHVtYiB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9zbGlkZXIvc2xpZGVyLXYtdGh1bWIucG5nKTsKfS54LXdpbmRvdy1kbGcgLmV4dC1tYi10ZXh0LAoueC13aW5kb3ctZGxnIC54LXdpbmRvdy1oZWFkZXItdGV4dCB7CiAgICBmb250LXNpemU6MTJweDsKfQoKLngtd2luZG93LWRsZyAuZXh0LW1iLXRleHRhcmVhIHsKICAgIGZvbnQ6bm9ybWFsIDEycHggdGFob21hLGFyaWFsLGhlbHZldGljYSxzYW5zLXNlcmlmOwp9CgoueC13aW5kb3ctZGxnIC54LW1zZy1ib3gtd2FpdCB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC9ncmlkL2xvYWRpbmcuZ2lmKTsKfQoKLngtd2luZG93LWRsZyAuZXh0LW1iLWluZm8gewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvd2luZG93L2ljb24taW5mby5naWYpOwp9CgoueC13aW5kb3ctZGxnIC5leHQtbWItd2FybmluZyB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC93aW5kb3cvaWNvbi13YXJuaW5nLmdpZik7Cn0KCi54LXdpbmRvdy1kbGcgLmV4dC1tYi1xdWVzdGlvbiB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOnVybCguLi9pbWFnZXMvZGVmYXVsdC93aW5kb3cvaWNvbi1xdWVzdGlvbi5naWYpOwp9CgoueC13aW5kb3ctZGxnIC5leHQtbWItZXJyb3IgewogICAgYmFja2dyb3VuZC1pbWFnZTp1cmwoLi4vaW1hZ2VzL2RlZmF1bHQvd2luZG93L2ljb24tZXJyb3IuZ2lmKTsKfQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPBody>
      </HTTPResponse>
    </HTTPTask>
    <HTTPTask id="21" hostname="demo.borland.com" path="/InsuranceWebExtJS/ext/adapter/ext/ext-base-debug.js" url="http://demo.borland.com/InsuranceWebExtJS/ext/adapter/ext/ext-base-debug.js" ip="143.186.120.171" port="80" client_ip="192.168.0.123" client_port="15235" connectionId="1788" origin="HTML" encodingType="ANSI" ordinal="2" startDateTime="2019-02-27T16:49:29.185+05:30" startTime="3826" endTime="4538" blockedTime="0" dnsTime="0" connectTime="0" sendTime="0" waitTime="0" receiveTime="0" sslNegotiateTime="0" responseBodySize="0">
      <HTTPRequest method="GET">
        <HTTPHeaders>
          <HTTPHeaderEntity name="Referer" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>aHR0cDovL2RlbW8uYm9ybGFuZC5jb20vSW5zdXJhbmNlV2ViRXh0SlMvYWdlbnRfbG9va3VwLmpzZg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="User-Agent" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzcyLjAuMzYyNi4xMTkgU2FmYXJpLzUzNy4zNg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Encoding" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Z3ppcCwgZGVmbGF0ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Language" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZW4tVVMsZW47cT0wLjk=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ki8q</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Connection" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>S2VlcC1BbGl2ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Host" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZGVtby5ib3JsYW5kLmNvbQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Cookie" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFC</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>R0VUIC9JbnN1cmFuY2VXZWJFeHRKUy9leHQvYWRhcHRlci9leHQvZXh0LWJhc2UtZGVidWcuanMgSFRUUC8xLjENClJlZmVyZXI6IGh0dHA6Ly9kZW1vLmJvcmxhbmQuY29tL0luc3VyYW5jZVdlYkV4dEpTL2FnZW50X2xvb2t1cC5qc2YNClVzZXItQWdlbnQ6IE1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS83Mi4wLjM2MjYuMTE5IFNhZmFyaS81MzcuMzYNCkFjY2VwdC1FbmNvZGluZzogZ3ppcCwgZGVmbGF0ZQ0KQWNjZXB0LUxhbmd1YWdlOiBlbi1VUyxlbjtxPTAuOQ0KQWNjZXB0OiAqLyoNCkNvbm5lY3Rpb246IEtlZXAtQWxpdmUNCkhvc3Q6IGRlbW8uYm9ybGFuZC5jb20NCkNvb2tpZTogSlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFCDQoNCg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
          <HTTPCookies>
            <HTTPHeaderEntity name="JSESSIONID" index="0">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
            <HTTPHeaderEntity name="UserSessionFilter.sessionId" index="1">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
          </HTTPCookies>
        </HTTPHeaders>
      </HTTPRequest>
      <HTTPResponse>
        <contentLenght>97907</contentLenght>
        <HTTPHeaders>
          <HTTPHeaderEntity name="Content-Length" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>OTc5MDc=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Content-Type" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>YXBwbGljYXRpb24vamF2YXNjcmlwdA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Last-Modified" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>V2VkLCAzMCBKYW4gMjAxMyAxMjoxNDoxNCBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Ranges" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ynl0ZXM=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="ETag" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Vy8iOTc5MDctMTM1OTU0ODA1NDAwMCI=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Server" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TWljcm9zb2Z0LUlJUy83LjU=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-Powered-By" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>QVNQLk5FVA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-FRAME-OPTIONS" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>U0FNRU9SSUdJTg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Date" index="8">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>V2VkLCAyNyBGZWIgMjAxOSAxMToxODo1NyBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTc5MDcNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KTGFzdC1Nb2RpZmllZDogV2VkLCAzMCBKYW4gMjAxMyAxMjoxNDoxNCBHTVQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpFVGFnOiBXLyI5NzkwNy0xMzU5NTQ4MDU0MDAwIg0KU2VydmVyOiBNaWNyb3NvZnQtSUlTLzcuNQ0KWC1Qb3dlcmVkLUJ5OiBBU1AuTkVUDQpYLUZSQU1FLU9QVElPTlM6IFNBTUVPUklHSU4NCkRhdGU6IFdlZCwgMjcgRmViIDIwMTkgMTE6MTg6NTcgR01UDQoNCg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
        </HTTPHeaders>
        <HTTPBody>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>LyohCiAqIEV4dCBKUyBMaWJyYXJ5IDMuNC4wCiAqIENvcHlyaWdodChjKSAyMDA2LTIwMTEgU2VuY2hhIEluYy4KICogbGljZW5zaW5nQHNlbmNoYS5jb20KICogaHR0cDovL3d3dy5zZW5jaGEuY29tL2xpY2Vuc2UKICovCi8vIGZvciBvbGQgYnJvd3NlcnMKd2luZG93LnVuZGVmaW5lZCA9IHdpbmRvdy51bmRlZmluZWQ7CgovKioKICogQGNsYXNzIEV4dAogKiBFeHQgY29yZSB1dGlsaXRpZXMgYW5kIGZ1bmN0aW9ucy4KICogQHNpbmdsZXRvbgogKi8KCkV4dCA9IHsKICAgIC8qKgogICAgICogVGhlIHZlcnNpb24gb2YgdGhlIGZyYW1ld29yawogICAgICogQHR5cGUgU3RyaW5nCiAgICAgKi8KICAgIHZlcnNpb24gOiAnMy40LjAnLAogICAgdmVyc2lvbkRldGFpbCA6IHsKICAgICAgICBtYWpvciA6IDMsCiAgICAgICAgbWlub3IgOiA0LAogICAgICAgIHBhdGNoIDogMAogICAgfQp9OwoKLyoqCiAqIENvcGllcyBhbGwgdGhlIHByb3BlcnRpZXMgb2YgY29uZmlnIHRvIG9iai4KICogQHBhcmFtIHtPYmplY3R9IG9iaiBUaGUgcmVjZWl2ZXIgb2YgdGhlIHByb3BlcnRpZXMKICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgc291cmNlIG9mIHRoZSBwcm9wZXJ0aWVzCiAqIEBwYXJhbSB7T2JqZWN0fSBkZWZhdWx0cyBBIGRpZmZlcmVudCBvYmplY3QgdGhhdCB3aWxsIGFsc28gYmUgYXBwbGllZCBmb3IgZGVmYXVsdCB2YWx1ZXMKICogQHJldHVybiB7T2JqZWN0fSByZXR1cm5zIG9iagogKiBAbWVtYmVyIEV4dCBhcHBseQogKi8KRXh0LmFwcGx5ID0gZnVuY3Rpb24obywgYywgZGVmYXVsdHMpewogICAgLy8gbm8gInRoaXMiIHJlZmVyZW5jZSBmb3IgZnJpZW5kbHkgb3V0IG9mIHNjb3BlIGNhbGxzCiAgICBpZihkZWZhdWx0cyl7CiAgICAgICAgRXh0LmFwcGx5KG8sIGRlZmF1bHRzKTsKICAgIH0KICAgIGlmKG8gJiYgYyAmJiB0eXBlb2YgYyA9PSAnb2JqZWN0Jyl7CiAgICAgICAgZm9yKHZhciBwIGluIGMpewogICAgICAgICAgICBvW3BdID0gY1twXTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gbzsKfTsKCihmdW5jdGlvbigpewogICAgdmFyIGlkU2VlZCA9IDAsCiAgICAgICAgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgICAgIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLAogICAgICAgIGNoZWNrID0gZnVuY3Rpb24ocil7CiAgICAgICAgICAgIHJldHVybiByLnRlc3QodWEpOwogICAgICAgIH0sCiAgICAgICAgRE9DID0gZG9jdW1lbnQsCiAgICAgICAgZG9jTW9kZSA9IERPQy5kb2N1bWVudE1vZGUsCiAgICAgICAgaXNTdHJpY3QgPSBET0MuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIsCiAgICAgICAgaXNPcGVyYSA9IGNoZWNrKC9vcGVyYS8pLAogICAgICAgIGlzQ2hyb21lID0gY2hlY2soL1xiY2hyb21lXGIvKSwKICAgICAgICBpc1dlYktpdCA9IGNoZWNrKC93ZWJraXQvKSwKICAgICAgICBpc1NhZmFyaSA9ICFpc0Nocm9tZSAmJiBjaGVjaygvc2FmYXJpLyksCiAgICAgICAgaXNTYWZhcmkyID0gaXNTYWZhcmkgJiYgY2hlY2soL2FwcGxld2Via2l0XC80LyksIC8vIHVuaXF1ZSB0byBTYWZhcmkgMgogICAgICAgIGlzU2FmYXJpMyA9IGlzU2FmYXJpICYmIGNoZWNrKC92ZXJzaW9uXC8zLyksCiAgICAgICAgaXNTYWZhcmk0ID0gaXNTYWZhcmkgJiYgY2hlY2soL3ZlcnNpb25cLzQvKSwKICAgICAgICBpc0lFID0gIWlzT3BlcmEgJiYgY2hlY2soL21zaWUvKSwKICAgICAgICBpc0lFNyA9IGlzSUUgJiYgKGNoZWNrKC9tc2llIDcvKSB8fCBkb2NNb2RlID09IDcpLAogICAgICAgIGlzSUU4ID0gaXNJRSAmJiAoY2hlY2soL21zaWUgOC8pICYmIGRvY01vZGUgIT0gNyksCiAgICAgICAgaXNJRTkgPSBpc0lFICYmIGNoZWNrKC9tc2llIDkvKSwKICAgICAgICBpc0lFNiA9IGlzSUUgJiYgIWlzSUU3ICYmICFpc0lFOCAmJiAhaXNJRTksCiAgICAgICAgaXNHZWNrbyA9ICFpc1dlYktpdCAmJiBjaGVjaygvZ2Vja28vKSwKICAgICAgICBpc0dlY2tvMiA9IGlzR2Vja28gJiYgY2hlY2soL3J2OjFcLjgvKSwKICAgICAgICBpc0dlY2tvMyA9IGlzR2Vja28gJiYgY2hlY2soL3J2OjFcLjkvKSwKICAgICAgICBpc0JvcmRlckJveCA9IGlzSUUgJiYgIWlzU3RyaWN0LAogICAgICAgIGlzV2luZG93cyA9IGNoZWNrKC93aW5kb3dzfHdpbjMyLyksCiAgICAgICAgaXNNYWMgPSBjaGVjaygvbWFjaW50b3NofG1hYyBvcyB4LyksCiAgICAgICAgaXNBaXIgPSBjaGVjaygvYWRvYmVhaXIvKSwKICAgICAgICBpc0xpbnV4ID0gY2hlY2soL2xpbnV4LyksCiAgICAgICAgaXNTZWN1cmUgPSAvXmh0dHBzL2kudGVzdCh3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wpOwoKICAgIC8vIHJlbW92ZSBjc3MgaW1hZ2UgZmxpY2tlcgogICAgaWYoaXNJRTYpewogICAgICAgIHRyeXsKICAgICAgICAgICAgRE9DLmV4ZWNDb21tYW5kKCJCYWNrZ3JvdW5kSW1hZ2VDYWNoZSIsIGZhbHNlLCB0cnVlKTsKICAgICAgICB9Y2F0Y2goZSl7fQogICAgfQoKICAgIEV4dC5hcHBseShFeHQsIHsKICAgICAgICAvKioKICAgICAgICAgKiBVUkwgdG8gYSBibGFuayBmaWxlIHVzZWQgYnkgRXh0IHdoZW4gaW4gc2VjdXJlIG1vZGUgZm9yIGlmcmFtZSBzcmMgYW5kIG9uUmVhZHkgc3JjIHRvIHByZXZlbnQKICAgICAgICAgKiB0aGUgSUUgaW5zZWN1cmUgY29udGVudCB3YXJuaW5nICg8dHQ+J2Fib3V0OmJsYW5rJzwvdHQ+LCBleGNlcHQgZm9yIElFIGluIHNlY3VyZSBtb2RlLCB3aGljaCBpcyA8dHQ+J2phdmFzY3JpcHQ6IiInPC90dD4pLgogICAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgICAqLwogICAgICAgIFNTTF9TRUNVUkVfVVJMIDogaXNTZWN1cmUgJiYgaXNJRSA/ICdqYXZhc2NyaXB0OiIiJyA6ICdhYm91dDpibGFuaycsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgYnJvd3NlciBpcyBpbiBzdHJpY3QgKHN0YW5kYXJkcy1jb21wbGlhbnQpIG1vZGUsIGFzIG9wcG9zZWQgdG8gcXVpcmtzIG1vZGUKICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNTdHJpY3QgOiBpc1N0cmljdCwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBwYWdlIGlzIHJ1bm5pbmcgb3ZlciBTU0wKICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNTZWN1cmUgOiBpc1NlY3VyZSwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIHdoZW4gdGhlIGRvY3VtZW50IGlzIGZ1bGx5IGluaXRpYWxpemVkIGFuZCByZWFkeSBmb3IgYWN0aW9uCiAgICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgICAqLwogICAgICAgIGlzUmVhZHkgOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUge0BsaW5rIEV4dC5GeH0gQ2xhc3MgaXMgYXZhaWxhYmxlCiAgICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgICAqIEBwcm9wZXJ0eSBlbmFibGVGeAogICAgICAgICAqLwoKICAgICAgICAvKioKICAgICAgICAgKiBISUdITFkgRVhQRVJJTUVOVEFMCiAgICAgICAgICogVHJ1ZSB0byBmb3JjZSBjc3MgYmFzZWQgYm9yZGVyLWJveCBtb2RlbCBvdmVycmlkZSBhbmQgdHVybmluZyBvZmYgamF2YXNjcmlwdCBiYXNlZCBhZGp1c3RtZW50cy4gVGhpcyBpcyBhCiAgICAgICAgICogcnVudGltZSBjb25maWd1cmF0aW9uIGFuZCBtdXN0IGJlIHNldCBiZWZvcmUgb25SZWFkeS4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgZW5hYmxlRm9yY2VkQm94TW9kZWwgOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSB0byBhdXRvbWF0aWNhbGx5IHVuY2FjaGUgb3JwaGFuZWQgRXh0LkVsZW1lbnRzIHBlcmlvZGljYWxseSAoZGVmYXVsdHMgdG8gdHJ1ZSkKICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgZW5hYmxlR2FyYmFnZUNvbGxlY3RvciA6IHRydWUsCgogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgdG8gYXV0b21hdGljYWxseSBwdXJnZSBldmVudCBsaXN0ZW5lcnMgZHVyaW5nIGdhcmJhZ2VDb2xsZWN0aW9uIChkZWZhdWx0cyB0byBmYWxzZSkuCiAgICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgICAqLwogICAgICAgIGVuYWJsZUxpc3RlbmVyQ29sbGVjdGlvbiA6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBFWFBFUklNRU5UQUwgLSBUcnVlIHRvIGNhc2NhZGUgbGlzdGVuZXIgcmVtb3ZhbCB0byBjaGlsZCBlbGVtZW50cyB3aGVuIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZC4KICAgICAgICAgKiBDdXJyZW50bHkgbm90IG9wdGltaXplZCBmb3IgcGVyZm9ybWFuY2UuCiAgICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgICAqLwogICAgICAgIGVuYWJsZU5lc3RlZExpc3RlbmVyUmVtb3ZhbCA6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBJbmRpY2F0ZXMgd2hldGhlciB0byB1c2UgbmF0aXZlIGJyb3dzZXIgcGFyc2luZyBmb3IgSlNPTiBtZXRob2RzLgogICAgICAgICAqIFRoaXMgb3B0aW9uIGlzIGlnbm9yZWQgaWYgdGhlIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBuYXRpdmUgSlNPTiBtZXRob2RzLgogICAgICAgICAqIDxiPk5vdGU6IE5hdGl2ZSBKU09OIG1ldGhvZHMgd2lsbCBub3Qgd29yayB3aXRoIG9iamVjdHMgdGhhdCBoYXZlIGZ1bmN0aW9ucy4KICAgICAgICAgKiBBbHNvLCBwcm9wZXJ0eSBuYW1lcyBtdXN0IGJlIHF1b3RlZCwgb3RoZXJ3aXNlIHRoZSBkYXRhIHdpbGwgbm90IHBhcnNlLjwvYj4gKERlZmF1bHRzIHRvIGZhbHNlKQogICAgICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAgICAgKi8KICAgICAgICBVU0VfTkFUSVZFX0pTT04gOiBmYWxzZSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29waWVzIGFsbCB0aGUgcHJvcGVydGllcyBvZiBjb25maWcgdG8gb2JqIGlmIHRoZXkgZG9uJ3QgYWxyZWFkeSBleGlzdC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqIFRoZSByZWNlaXZlciBvZiB0aGUgcHJvcGVydGllcwogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb25maWcgVGhlIHNvdXJjZSBvZiB0aGUgcHJvcGVydGllcwogICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gcmV0dXJucyBvYmoKICAgICAgICAgKi8KICAgICAgICBhcHBseUlmIDogZnVuY3Rpb24obywgYyl7CiAgICAgICAgICAgIGlmKG8pewogICAgICAgICAgICAgICAgZm9yKHZhciBwIGluIGMpewogICAgICAgICAgICAgICAgICAgIGlmKCFFeHQuaXNEZWZpbmVkKG9bcF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgb1twXSA9IGNbcF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEdlbmVyYXRlcyB1bmlxdWUgaWRzLiBJZiB0aGUgZWxlbWVudCBhbHJlYWR5IGhhcyBhbiBpZCwgaXQgaXMgdW5jaGFuZ2VkCiAgICAgICAgICogQHBhcmFtIHtNaXhlZH0gZWwgKG9wdGlvbmFsKSBUaGUgZWxlbWVudCB0byBnZW5lcmF0ZSBhbiBpZCBmb3IKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcHJlZml4IChvcHRpb25hbCkgSWQgcHJlZml4IChkZWZhdWx0cyAiZXh0LWdlbiIpCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfSBUaGUgZ2VuZXJhdGVkIElkLgogICAgICAgICAqLwogICAgICAgIGlkIDogZnVuY3Rpb24oZWwsIHByZWZpeCl7CiAgICAgICAgICAgIGVsID0gRXh0LmdldERvbShlbCwgdHJ1ZSkgfHwge307CiAgICAgICAgICAgIGlmICghZWwuaWQpIHsKICAgICAgICAgICAgICAgIGVsLmlkID0gKHByZWZpeCB8fCAiZXh0LWdlbiIpICsgKCsraWRTZWVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWwuaWQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogPHA+RXh0ZW5kcyBvbmUgY2xhc3MgdG8gY3JlYXRlIGEgc3ViY2xhc3MgYW5kIG9wdGlvbmFsbHkgb3ZlcnJpZGVzIG1lbWJlcnMgd2l0aCB0aGUgcGFzc2VkIGxpdGVyYWwuIFRoaXMgbWV0aG9kCiAgICAgICAgICogYWxzbyBhZGRzIHRoZSBmdW5jdGlvbiAib3ZlcnJpZGUoKSIgdG8gdGhlIHN1YmNsYXNzIHRoYXQgY2FuIGJlIHVzZWQgdG8gb3ZlcnJpZGUgbWVtYmVycyBvZiB0aGUgY2xhc3MuPC9wPgogICAgICAgICAqIEZvciBleGFtcGxlLCB0byBjcmVhdGUgYSBzdWJjbGFzcyBvZiBFeHQgR3JpZFBhbmVsOgogICAgICAgICAqIDxwcmU+PGNvZGU+Ck15R3JpZFBhbmVsID0gRXh0LmV4dGVuZChFeHQuZ3JpZC5HcmlkUGFuZWwsIHsKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb25maWcpIHsKCi8vICAgICAgQ3JlYXRlIGNvbmZpZ3VyYXRpb24gZm9yIHRoaXMgR3JpZC4KICAgICAgICB2YXIgc3RvcmUgPSBuZXcgRXh0LmRhdGEuU3RvcmUoey4uLn0pOwogICAgICAgIHZhciBjb2xNb2RlbCA9IG5ldyBFeHQuZ3JpZC5Db2x1bW5Nb2RlbCh7Li4ufSk7CgovLyAgICAgIENyZWF0ZSBhIG5ldyBjb25maWcgb2JqZWN0IGNvbnRhaW5pbmcgb3VyIGNvbXB1dGVkIHByb3BlcnRpZXMKLy8gICAgICAqcGx1cyogd2hhdGV2ZXIgd2FzIGluIHRoZSBjb25maWcgcGFyYW1ldGVyLgogICAgICAgIGNvbmZpZyA9IEV4dC5hcHBseSh7CiAgICAgICAgICAgIHN0b3JlOiBzdG9yZSwKICAgICAgICAgICAgY29sTW9kZWw6IGNvbE1vZGVsCiAgICAgICAgfSwgY29uZmlnKTsKCiAgICAgICAgTXlHcmlkUGFuZWwuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGNvbmZpZyk7CgovLyAgICAgIFlvdXIgcG9zdHByb2Nlc3NpbmcgaGVyZQogICAgfSwKCiAgICB5b3VyTWV0aG9kOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBldGMuCiAgICB9Cn0pOwo8L2NvZGU+PC9wcmU+CiAgICAgICAgICoKICAgICAgICAgKiA8cD5UaGlzIGZ1bmN0aW9uIGFsc28gc3VwcG9ydHMgYSAzLWFyZ3VtZW50IGNhbGwgaW4gd2hpY2ggdGhlIHN1YmNsYXNzJ3MgY29uc3RydWN0b3IgaXMKICAgICAgICAgKiBwYXNzZWQgYXMgYW4gYXJndW1lbnQuIEluIHRoaXMgZm9ybSwgdGhlIHBhcmFtZXRlcnMgYXJlIGFzIGZvbGxvd3M6PC9wPgogICAgICAgICAqIDxkaXYgY2xhc3M9Im1kZXRhaWwtcGFyYW1zIj48dWw+CiAgICAgICAgICogPGxpPjxjb2RlPnN1YmNsYXNzPC9jb2RlPiA6IEZ1bmN0aW9uIDxkaXYgY2xhc3M9InN1Yi1kZXNjIj5UaGUgc3ViY2xhc3MgY29uc3RydWN0b3IuPC9kaXY+PC9saT4KICAgICAgICAgKiA8bGk+PGNvZGU+c3VwZXJjbGFzczwvY29kZT4gOiBGdW5jdGlvbiA8ZGl2IGNsYXNzPSJzdWItZGVzYyI+VGhlIGNvbnN0cnVjdG9yIG9mIGNsYXNzIGJlaW5nIGV4dGVuZGVkPC9kaXY+PC9saT4KICAgICAgICAgKiA8bGk+PGNvZGU+b3ZlcnJpZGVzPC9jb2RlPiA6IE9iamVjdCA8ZGl2IGNsYXNzPSJzdWItZGVzYyI+QSBsaXRlcmFsIHdpdGggbWVtYmVycyB3aGljaCBhcmUgY29waWVkIGludG8gdGhlIHN1YmNsYXNzJ3MKICAgICAgICAgKiBwcm90b3R5cGUsIGFuZCBhcmUgdGhlcmVmb3JlIHNoYXJlZCBhbW9uZyBhbGwgaW5zdGFuY2VzIG9mIHRoZSBuZXcgY2xhc3MuPC9kaXY+PC9saT4KICAgICAgICAgKiA8L3VsPjwvZGl2PgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gc3VwZXJjbGFzcyBUaGUgY29uc3RydWN0b3Igb2YgY2xhc3MgYmVpbmcgZXh0ZW5kZWQuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG92ZXJyaWRlcyA8cD5BIGxpdGVyYWwgd2l0aCBtZW1iZXJzIHdoaWNoIGFyZSBjb3BpZWQgaW50byB0aGUgc3ViY2xhc3MncwogICAgICAgICAqIHByb3RvdHlwZSwgYW5kIGFyZSB0aGVyZWZvcmUgc2hhcmVkIGJldHdlZW4gYWxsIGluc3RhbmNlcyBvZiB0aGUgbmV3IGNsYXNzLjwvcD4KICAgICAgICAgKiA8cD5UaGlzIG1heSBjb250YWluIGEgc3BlY2lhbCBtZW1iZXIgbmFtZWQgPHR0PjxiPmNvbnN0cnVjdG9yPC9iPjwvdHQ+LiBUaGlzIGlzIHVzZWQKICAgICAgICAgKiB0byBkZWZpbmUgdGhlIGNvbnN0cnVjdG9yIG9mIHRoZSBuZXcgY2xhc3MsIGFuZCBpcyByZXR1cm5lZC4gSWYgdGhpcyBwcm9wZXJ0eSBpcwogICAgICAgICAqIDxpPm5vdDwvaT4gc3BlY2lmaWVkLCBhIGNvbnN0cnVjdG9yIGlzIGdlbmVyYXRlZCBhbmQgcmV0dXJuZWQgd2hpY2gganVzdCBjYWxscyB0aGUKICAgICAgICAgKiBzdXBlcmNsYXNzJ3MgY29uc3RydWN0b3IgcGFzc2luZyBvbiBpdHMgcGFyYW1ldGVycy48L3A+CiAgICAgICAgICogPHA+PGI+SXQgaXMgZXNzZW50aWFsIHRoYXQgeW91IGNhbGwgdGhlIHN1cGVyY2xhc3MgY29uc3RydWN0b3IgaW4gYW55IHByb3ZpZGVkIGNvbnN0cnVjdG9yLiBTZWUgZXhhbXBsZSBjb2RlLjwvYj48L3A+CiAgICAgICAgICogQHJldHVybiB7RnVuY3Rpb259IFRoZSBzdWJjbGFzcyBjb25zdHJ1Y3RvciBmcm9tIHRoZSA8Y29kZT5vdmVycmlkZXM8L2NvZGU+IHBhcmFtZXRlciwgb3IgYSBnZW5lcmF0ZWQgb25lIGlmIG5vdCBwcm92aWRlZC4KICAgICAgICAgKi8KICAgICAgICBleHRlbmQgOiBmdW5jdGlvbigpewogICAgICAgICAgICAvLyBpbmxpbmUgb3ZlcnJpZGVzCiAgICAgICAgICAgIHZhciBpbyA9IGZ1bmN0aW9uKG8pewogICAgICAgICAgICAgICAgZm9yKHZhciBtIGluIG8pewogICAgICAgICAgICAgICAgICAgIHRoaXNbbV0gPSBvW21dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgb2MgPSBPYmplY3QucHJvdG90eXBlLmNvbnN0cnVjdG9yOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNiLCBzcCwgb3ZlcnJpZGVzKXsKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBzcCA9PSAnb2JqZWN0Jyl7CiAgICAgICAgICAgICAgICAgICAgb3ZlcnJpZGVzID0gc3A7CiAgICAgICAgICAgICAgICAgICAgc3AgPSBzYjsKICAgICAgICAgICAgICAgICAgICBzYiA9IG92ZXJyaWRlcy5jb25zdHJ1Y3RvciAhPSBvYyA/IG92ZXJyaWRlcy5jb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKCl7c3AuYXBwbHkodGhpcywgYXJndW1lbnRzKTt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIEYgPSBmdW5jdGlvbigpe30sCiAgICAgICAgICAgICAgICAgICAgc2JwLAogICAgICAgICAgICAgICAgICAgIHNwcCA9IHNwLnByb3RvdHlwZTsKCiAgICAgICAgICAgICAgICBGLnByb3RvdHlwZSA9IHNwcDsKICAgICAgICAgICAgICAgIHNicCA9IHNiLnByb3RvdHlwZSA9IG5ldyBGKCk7CiAgICAgICAgICAgICAgICBzYnAuY29uc3RydWN0b3I9c2I7CiAgICAgICAgICAgICAgICBzYi5zdXBlcmNsYXNzPXNwcDsKICAgICAgICAgICAgICAgIGlmKHNwcC5jb25zdHJ1Y3RvciA9PSBvYyl7CiAgICAgICAgICAgICAgICAgICAgc3BwLmNvbnN0cnVjdG9yPXNwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2Iub3ZlcnJpZGUgPSBmdW5jdGlvbihvKXsKICAgICAgICAgICAgICAgICAgICBFeHQub3ZlcnJpZGUoc2IsIG8pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHNicC5zdXBlcmNsYXNzID0gc2JwLnN1cHIgPSAoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3BwOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBzYnAub3ZlcnJpZGUgPSBpbzsKICAgICAgICAgICAgICAgIEV4dC5vdmVycmlkZShzYiwgb3ZlcnJpZGVzKTsKICAgICAgICAgICAgICAgIHNiLmV4dGVuZCA9IGZ1bmN0aW9uKG8pe3JldHVybiBFeHQuZXh0ZW5kKHNiLCBvKTt9OwogICAgICAgICAgICAgICAgcmV0dXJuIHNiOwogICAgICAgICAgICB9OwogICAgICAgIH0oKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQWRkcyBhIGxpc3Qgb2YgZnVuY3Rpb25zIHRvIHRoZSBwcm90b3R5cGUgb2YgYW4gZXhpc3RpbmcgY2xhc3MsIG92ZXJ3cml0aW5nIGFueSBleGlzdGluZyBtZXRob2RzIHdpdGggdGhlIHNhbWUgbmFtZS4KICAgICAgICAgKiBVc2FnZTo8cHJlPjxjb2RlPgpFeHQub3ZlcnJpZGUoTXlDbGFzcywgewogICAgbmV3TWV0aG9kMTogZnVuY3Rpb24oKXsKICAgICAgICAvLyBldGMuCiAgICB9LAogICAgbmV3TWV0aG9kMjogZnVuY3Rpb24oZm9vKXsKICAgICAgICAvLyBldGMuCiAgICB9Cn0pOwo8L2NvZGU+PC9wcmU+CiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9yaWdjbGFzcyBUaGUgY2xhc3MgdG8gb3ZlcnJpZGUKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3ZlcnJpZGVzIFRoZSBsaXN0IG9mIGZ1bmN0aW9ucyB0byBhZGQgdG8gb3JpZ0NsYXNzLiAgVGhpcyBzaG91bGQgYmUgc3BlY2lmaWVkIGFzIGFuIG9iamVjdCBsaXRlcmFsCiAgICAgICAgICogY29udGFpbmluZyBvbmUgb3IgbW9yZSBtZXRob2RzLgogICAgICAgICAqIEBtZXRob2Qgb3ZlcnJpZGUKICAgICAgICAgKi8KICAgICAgICBvdmVycmlkZSA6IGZ1bmN0aW9uKG9yaWdjbGFzcywgb3ZlcnJpZGVzKXsKICAgICAgICAgICAgaWYob3ZlcnJpZGVzKXsKICAgICAgICAgICAgICAgIHZhciBwID0gb3JpZ2NsYXNzLnByb3RvdHlwZTsKICAgICAgICAgICAgICAgIEV4dC5hcHBseShwLCBvdmVycmlkZXMpOwogICAgICAgICAgICAgICAgaWYoRXh0LmlzSUUgJiYgb3ZlcnJpZGVzLmhhc093blByb3BlcnR5KCd0b1N0cmluZycpKXsKICAgICAgICAgICAgICAgICAgICBwLnRvU3RyaW5nID0gb3ZlcnJpZGVzLnRvU3RyaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ3JlYXRlcyBuYW1lc3BhY2VzIHRvIGJlIHVzZWQgZm9yIHNjb3BpbmcgdmFyaWFibGVzIGFuZCBjbGFzc2VzIHNvIHRoYXQgdGhleSBhcmUgbm90IGdsb2JhbC4KICAgICAgICAgKiBTcGVjaWZ5aW5nIHRoZSBsYXN0IG5vZGUgb2YgYSBuYW1lc3BhY2UgaW1wbGljaXRseSBjcmVhdGVzIGFsbCBvdGhlciBub2Rlcy4gVXNhZ2U6CiAgICAgICAgICogPHByZT48Y29kZT4KRXh0Lm5hbWVzcGFjZSgnQ29tcGFueScsICdDb21wYW55LmRhdGEnKTsKRXh0Lm5hbWVzcGFjZSgnQ29tcGFueS5kYXRhJyk7IC8vIGVxdWl2YWxlbnQgYW5kIHByZWZlcmFibGUgdG8gYWJvdmUgc3ludGF4CkNvbXBhbnkuV2lkZ2V0ID0gZnVuY3Rpb24oKSB7IC4uLiB9CkNvbXBhbnkuZGF0YS5DdXN0b21TdG9yZSA9IGZ1bmN0aW9uKGNvbmZpZykgeyAuLi4gfQo8L2NvZGU+PC9wcmU+CiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZTEKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZXNwYWNlMgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldGMKICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSBuYW1lc3BhY2Ugb2JqZWN0LiAoSWYgbXVsdGlwbGUgYXJndW1lbnRzIGFyZSBwYXNzZWQsIHRoaXMgd2lsbCBiZSB0aGUgbGFzdCBuYW1lc3BhY2UgY3JlYXRlZCkKICAgICAgICAgKiBAbWV0aG9kIG5hbWVzcGFjZQogICAgICAgICAqLwogICAgICAgIG5hbWVzcGFjZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBsZW4xID0gYXJndW1lbnRzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgbGVuMiwKICAgICAgICAgICAgICAgIGosCiAgICAgICAgICAgICAgICBtYWluLAogICAgICAgICAgICAgICAgbnMsCiAgICAgICAgICAgICAgICBzdWIsCiAgICAgICAgICAgICAgICBjdXJyZW50OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGZvcig7IGkgPCBsZW4xOyArK2kpIHsKICAgICAgICAgICAgICAgIG1haW4gPSBhcmd1bWVudHNbaV07CiAgICAgICAgICAgICAgICBucyA9IGFyZ3VtZW50c1tpXS5zcGxpdCgnLicpOwogICAgICAgICAgICAgICAgY3VycmVudCA9IHdpbmRvd1tuc1swXV07CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHdpbmRvd1tuc1swXV0gPSB7fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN1YiA9IG5zLnNsaWNlKDEpOwogICAgICAgICAgICAgICAgbGVuMiA9IHN1Yi5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IoaiA9IDA7IGogPCBsZW4yOyArK2opIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudFtzdWJbal1dID0gY3VycmVudFtzdWJbal1dIHx8IHt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRha2VzIGFuIG9iamVjdCBhbmQgY29udmVydHMgaXQgdG8gYW4gZW5jb2RlZCBVUkwuIGUuZy4gRXh0LnVybEVuY29kZSh7Zm9vOiAxLCBiYXI6IDJ9KTsgd291bGQgcmV0dXJuICJmb289MSZiYXI9MiIuICBPcHRpb25hbGx5LCBwcm9wZXJ0eSB2YWx1ZXMgY2FuIGJlIGFycmF5cywgaW5zdGVhZCBvZiBrZXlzIGFuZCB0aGUgcmVzdWx0aW5nIHN0cmluZyB0aGF0J3MgcmV0dXJuZWQgd2lsbCBjb250YWluIGEgbmFtZS92YWx1ZSBwYWlyIGZvciBlYWNoIGFycmF5IHZhbHVlLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHByZSAob3B0aW9uYWwpIEEgcHJlZml4IHRvIGFkZCB0byB0aGUgdXJsIGVuY29kZWQgc3RyaW5nCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIHVybEVuY29kZSA6IGZ1bmN0aW9uKG8sIHByZSl7CiAgICAgICAgICAgIHZhciBlbXB0eSwKICAgICAgICAgICAgICAgIGJ1ZiA9IFtdLAogICAgICAgICAgICAgICAgZSA9IGVuY29kZVVSSUNvbXBvbmVudDsKCiAgICAgICAgICAgIEV4dC5pdGVyYXRlKG8sIGZ1bmN0aW9uKGtleSwgaXRlbSl7CiAgICAgICAgICAgICAgICBlbXB0eSA9IEV4dC5pc0VtcHR5KGl0ZW0pOwogICAgICAgICAgICAgICAgRXh0LmVhY2goZW1wdHkgPyBrZXkgOiBpdGVtLCBmdW5jdGlvbih2YWwpewogICAgICAgICAgICAgICAgICAgIGJ1Zi5wdXNoKCcmJywgZShrZXkpLCAnPScsICghRXh0LmlzRW1wdHkodmFsKSAmJiAodmFsICE9IGtleSB8fCAhZW1wdHkpKSA/IChFeHQuaXNEYXRlKHZhbCkgPyBFeHQuZW5jb2RlKHZhbCkucmVwbGFjZSgvIi9nLCAnJykgOiBlKHZhbCkpIDogJycpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZighcHJlKXsKICAgICAgICAgICAgICAgIGJ1Zi5zaGlmdCgpOwogICAgICAgICAgICAgICAgcHJlID0gJyc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByZSArIGJ1Zi5qb2luKCcnKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUYWtlcyBhbiBlbmNvZGVkIFVSTCBhbmQgYW5kIGNvbnZlcnRzIGl0IHRvIGFuIG9iamVjdC4gRXhhbXBsZTogPHByZT48Y29kZT4KRXh0LnVybERlY29kZSgiZm9vPTEmYmFyPTIiKTsgLy8gcmV0dXJucyB7Zm9vOiAiMSIsIGJhcjogIjIifQpFeHQudXJsRGVjb2RlKCJmb289MSZiYXI9MiZiYXI9MyZiYXI9NCIsIGZhbHNlKTsgLy8gcmV0dXJucyB7Zm9vOiAiMSIsIGJhcjogWyIyIiwgIjMiLCAiNCJdfQo8L2NvZGU+PC9wcmU+CiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHN0cmluZwogICAgICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gb3ZlcndyaXRlIChvcHRpb25hbCkgSXRlbXMgb2YgdGhlIHNhbWUgbmFtZSB3aWxsIG92ZXJ3cml0ZSBwcmV2aW91cyB2YWx1ZXMgaW5zdGVhZCBvZiBjcmVhdGluZyBhbiBhbiBhcnJheSAoRGVmYXVsdHMgdG8gZmFsc2UpLgogICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gQSBsaXRlcmFsIHdpdGggbWVtYmVycwogICAgICAgICAqLwogICAgICAgIHVybERlY29kZSA6IGZ1bmN0aW9uKHN0cmluZywgb3ZlcndyaXRlKXsKICAgICAgICAgICAgaWYoRXh0LmlzRW1wdHkoc3RyaW5nKSl7CiAgICAgICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG9iaiA9IHt9LAogICAgICAgICAgICAgICAgcGFpcnMgPSBzdHJpbmcuc3BsaXQoJyYnKSwKICAgICAgICAgICAgICAgIGQgPSBkZWNvZGVVUklDb21wb25lbnQsCiAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgdmFsdWU7CiAgICAgICAgICAgIEV4dC5lYWNoKHBhaXJzLCBmdW5jdGlvbihwYWlyKSB7CiAgICAgICAgICAgICAgICBwYWlyID0gcGFpci5zcGxpdCgnPScpOwogICAgICAgICAgICAgICAgbmFtZSA9IGQocGFpclswXSk7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGQocGFpclsxXSk7CiAgICAgICAgICAgICAgICBvYmpbbmFtZV0gPSBvdmVyd3JpdGUgfHwgIW9ialtuYW1lXSA/IHZhbHVlIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtdLmNvbmNhdChvYmpbbmFtZV0pLmNvbmNhdCh2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEFwcGVuZHMgY29udGVudCB0byB0aGUgcXVlcnkgc3RyaW5nIG9mIGEgVVJMLCBoYW5kbGluZyBsb2dpYyBmb3Igd2hldGhlciB0byBwbGFjZQogICAgICAgICAqIGEgcXVlc3Rpb24gbWFyayBvciBhbXBlcnNhbmQuCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgVVJMIHRvIGFwcGVuZCB0by4KICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcyBUaGUgY29udGVudCB0byBhcHBlbmQgdG8gdGhlIFVSTC4KICAgICAgICAgKiBAcmV0dXJuIChTdHJpbmcpIFRoZSByZXN1bHRpbmcgVVJMCiAgICAgICAgICovCiAgICAgICAgdXJsQXBwZW5kIDogZnVuY3Rpb24odXJsLCBzKXsKICAgICAgICAgICAgaWYoIUV4dC5pc0VtcHR5KHMpKXsKICAgICAgICAgICAgICAgIHJldHVybiB1cmwgKyAodXJsLmluZGV4T2YoJz8nKSA9PT0gLTEgPyAnPycgOiAnJicpICsgczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXJsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIENvbnZlcnRzIGFueSBpdGVyYWJsZSAobnVtZXJpYyBpbmRpY2VzIGFuZCBhIGxlbmd0aCBwcm9wZXJ0eSkgaW50byBhIHRydWUgYXJyYXkKICAgICAgICAgKiBEb24ndCB1c2UgdGhpcyBvbiBzdHJpbmdzLiBJRSBkb2Vzbid0IHN1cHBvcnQgImFiYyJbMF0gd2hpY2ggdGhpcyBpbXBsZW1lbnRhdGlvbiBkZXBlbmRzIG9uLgogICAgICAgICAqIEZvciBzdHJpbmdzLCB1c2UgdGhpcyBpbnN0ZWFkOiAiYWJjIi5tYXRjaCgvLi9nKSA9PiBbYSxiLGNdOwogICAgICAgICAqIEBwYXJhbSB7SXRlcmFibGV9IHRoZSBpdGVyYWJsZSBvYmplY3QgdG8gYmUgdHVybmVkIGludG8gYSB0cnVlIEFycmF5LgogICAgICAgICAqIEByZXR1cm4gKEFycmF5KSBhcnJheQogICAgICAgICAqLwogICAgICAgICB0b0FycmF5IDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgIHJldHVybiBpc0lFID8KICAgICAgICAgICAgICAgICBmdW5jdGlvbihhLCBpLCBqLCByZXMpewogICAgICAgICAgICAgICAgICAgICByZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciB4ID0gMCwgbGVuID0gYS5sZW5ndGg7IHggPCBsZW47IHgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnB1c2goYVt4XSk7CiAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcy5zbGljZShpIHx8IDAsIGogfHwgcmVzLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgfSA6CiAgICAgICAgICAgICAgICAgZnVuY3Rpb24oYSwgaSwgail7CiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhLCBpIHx8IDAsIGogfHwgYS5sZW5ndGgpOwogICAgICAgICAgICAgICAgIH07CiAgICAgICAgIH0oKSwKCiAgICAgICAgaXNJdGVyYWJsZSA6IGZ1bmN0aW9uKHYpewogICAgICAgICAgICAvL2NoZWNrIGZvciBhcnJheSBvciBhcmd1bWVudHMKICAgICAgICAgICAgaWYoRXh0LmlzQXJyYXkodikgfHwgdi5jYWxsZWUpewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9jaGVjayBmb3Igbm9kZSBsaXN0IHR5cGUKICAgICAgICAgICAgaWYoL05vZGVMaXN0fEhUTUxDb2xsZWN0aW9uLy50ZXN0KHRvU3RyaW5nLmNhbGwodikpKXsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vTm9kZUxpc3QgaGFzIGFuIGl0ZW0gYW5kIGxlbmd0aCBwcm9wZXJ0eQogICAgICAgICAgICAvL0lYTUxET01Ob2RlTGlzdCBoYXMgbmV4dE5vZGUgbWV0aG9kLCBuZWVkcyB0byBiZSBjaGVja2VkIGZpcnN0LgogICAgICAgICAgICByZXR1cm4gKCh0eXBlb2Ygdi5uZXh0Tm9kZSAhPSAndW5kZWZpbmVkJyB8fCB2Lml0ZW0pICYmIEV4dC5pc051bWJlcih2Lmxlbmd0aCkpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEl0ZXJhdGVzIGFuIGFycmF5IGNhbGxpbmcgdGhlIHN1cHBsaWVkIGZ1bmN0aW9uLgogICAgICAgICAqIEBwYXJhbSB7QXJyYXkvTm9kZUxpc3QvTWl4ZWR9IGFycmF5IFRoZSBhcnJheSB0byBiZSBpdGVyYXRlZC4gSWYgdGhpcwogICAgICAgICAqIGFyZ3VtZW50IGlzIG5vdCByZWFsbHkgYW4gYXJyYXksIHRoZSBzdXBwbGllZCBmdW5jdGlvbiBpcyBjYWxsZWQgb25jZS4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdpdGggZWFjaCBpdGVtLiBJZiB0aGUKICAgICAgICAgKiBzdXBwbGllZCBmdW5jdGlvbiByZXR1cm5zIGZhbHNlLCBpdGVyYXRpb24gc3RvcHMgYW5kIHRoaXMgbWV0aG9kIHJldHVybnMKICAgICAgICAgKiB0aGUgY3VycmVudCA8Y29kZT5pbmRleDwvY29kZT4uIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHdpdGgKICAgICAgICAgKiB0aGUgZm9sbG93aW5nIGFyZ3VtZW50czoKICAgICAgICAgKiA8ZGl2IGNsYXNzPSJtZGV0YWlsLXBhcmFtcyI+PHVsPgogICAgICAgICAqIDxsaT48Y29kZT5pdGVtPC9jb2RlPiA6IDxpPk1peGVkPC9pPgogICAgICAgICAqIDxkaXYgY2xhc3M9InN1Yi1kZXNjIj5UaGUgaXRlbSBhdCB0aGUgY3VycmVudCA8Y29kZT5pbmRleDwvY29kZT4KICAgICAgICAgKiBpbiB0aGUgcGFzc2VkIDxjb2RlPmFycmF5PC9jb2RlPjwvZGl2PjwvbGk+CiAgICAgICAgICogPGxpPjxjb2RlPmluZGV4PC9jb2RlPiA6IDxpPk51bWJlcjwvaT4KICAgICAgICAgKiA8ZGl2IGNsYXNzPSJzdWItZGVzYyI+VGhlIGN1cnJlbnQgaW5kZXggd2l0aGluIHRoZSBhcnJheTwvZGl2PjwvbGk+CiAgICAgICAgICogPGxpPjxjb2RlPmFsbEl0ZW1zPC9jb2RlPiA6IDxpPkFycmF5PC9pPgogICAgICAgICAqIDxkaXYgY2xhc3M9InN1Yi1kZXNjIj5UaGUgPGNvZGU+YXJyYXk8L2NvZGU+IHBhc3NlZCBhcyB0aGUgZmlyc3QKICAgICAgICAgKiBhcmd1bWVudCB0byA8Y29kZT5FeHQuZWFjaDwvY29kZT4uPC9kaXY+PC9saT4KICAgICAgICAgKiA8L3VsPjwvZGl2PgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY29wZSBUaGUgc2NvcGUgKDxjb2RlPnRoaXM8L2NvZGU+IHJlZmVyZW5jZSkgaW4gd2hpY2ggdGhlIHNwZWNpZmllZCBmdW5jdGlvbiBpcyBleGVjdXRlZC4KICAgICAgICAgKiBEZWZhdWx0cyB0byB0aGUgPGNvZGU+aXRlbTwvY29kZT4gYXQgdGhlIGN1cnJlbnQgPGNvZGU+aW5kZXg8L2NvZGU+CiAgICAgICAgICogd2l0aGluIHRoZSBwYXNzZWQgPGNvZGU+YXJyYXk8L2NvZGU+LgogICAgICAgICAqIEByZXR1cm4gU2VlIGRlc2NyaXB0aW9uIGZvciB0aGUgZm4gcGFyYW1ldGVyLgogICAgICAgICAqLwogICAgICAgIGVhY2ggOiBmdW5jdGlvbihhcnJheSwgZm4sIHNjb3BlKXsKICAgICAgICAgICAgaWYoRXh0LmlzRW1wdHkoYXJyYXksIHRydWUpKXsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighRXh0LmlzSXRlcmFibGUoYXJyYXkpIHx8IEV4dC5pc1ByaW1pdGl2ZShhcnJheSkpewogICAgICAgICAgICAgICAgYXJyYXkgPSBbYXJyYXldOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIGlmKGZuLmNhbGwoc2NvcGUgfHwgYXJyYXlbaV0sIGFycmF5W2ldLCBpLCBhcnJheSkgPT09IGZhbHNlKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBJdGVyYXRlcyBlaXRoZXIgdGhlIGVsZW1lbnRzIGluIGFuIGFycmF5LCBvciBlYWNoIG9mIHRoZSBwcm9wZXJ0aWVzIGluIGFuIG9iamVjdC4KICAgICAgICAgKiA8Yj5Ob3RlPC9iPjogSWYgeW91IGFyZSBvbmx5IGl0ZXJhdGluZyBhcnJheXMsIGl0IGlzIGJldHRlciB0byBjYWxsIHtAbGluayAjZWFjaH0uCiAgICAgICAgICogQHBhcmFtIHtPYmplY3QvQXJyYXl9IG9iamVjdCBUaGUgb2JqZWN0IG9yIGFycmF5IHRvIGJlIGl0ZXJhdGVkCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBmb3IgZWFjaCBpdGVyYXRpb24uCiAgICAgICAgICogVGhlIGl0ZXJhdGlvbiB3aWxsIHN0b3AgaWYgdGhlIHN1cHBsaWVkIGZ1bmN0aW9uIHJldHVybnMgZmFsc2UsIG9yCiAgICAgICAgICogYWxsIGFycmF5IGVsZW1lbnRzIC8gb2JqZWN0IHByb3BlcnRpZXMgaGF2ZSBiZWVuIGNvdmVyZWQuIFRoZSBzaWduYXR1cmUKICAgICAgICAgKiB2YXJpZXMgZGVwZW5kaW5nIG9uIHRoZSB0eXBlIG9mIG9iamVjdCBiZWluZyBpbnRlcmF0ZWQ6CiAgICAgICAgICogPGRpdiBjbGFzcz0ibWRldGFpbC1wYXJhbXMiPjx1bD4KICAgICAgICAgKiA8bGk+QXJyYXlzIDogPHR0PihPYmplY3QgaXRlbSwgTnVtYmVyIGluZGV4LCBBcnJheSBhbGxJdGVtcyk8L3R0PgogICAgICAgICAqIDxkaXYgY2xhc3M9InN1Yi1kZXNjIj4KICAgICAgICAgKiBXaGVuIGl0ZXJhdGluZyBhbiBhcnJheSwgdGhlIHN1cHBsaWVkIGZ1bmN0aW9uIGlzIGNhbGxlZCB3aXRoIGVhY2ggaXRlbS48L2Rpdj48L2xpPgogICAgICAgICAqIDxsaT5PYmplY3RzIDogPHR0PihTdHJpbmcga2V5LCBPYmplY3QgdmFsdWUsIE9iamVjdCk8L3R0PgogICAgICAgICAqIDxkaXYgY2xhc3M9InN1Yi1kZXNjIj4KICAgICAgICAgKiBXaGVuIGl0ZXJhdGluZyBhbiBvYmplY3QsIHRoZSBzdXBwbGllZCBmdW5jdGlvbiBpcyBjYWxsZWQgd2l0aCBlYWNoIGtleS12YWx1ZSBwYWlyIGluCiAgICAgICAgICogdGhlIG9iamVjdCwgYW5kIHRoZSBpdGVyYXRlZCBvYmplY3Q8L2Rpdj48L2xpPgogICAgICAgICAqIDwvdWw+PC9kaXY+CiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIFRoZSBzY29wZSAoPGNvZGU+dGhpczwvY29kZT4gcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUgc3BlY2lmaWVkIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLiBEZWZhdWx0cyB0bwogICAgICAgICAqIHRoZSA8Y29kZT5vYmplY3Q8L2NvZGU+IGJlaW5nIGl0ZXJhdGVkLgogICAgICAgICAqLwogICAgICAgIGl0ZXJhdGUgOiBmdW5jdGlvbihvYmosIGZuLCBzY29wZSl7CiAgICAgICAgICAgIGlmKEV4dC5pc0VtcHR5KG9iaikpewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKEV4dC5pc0l0ZXJhYmxlKG9iaikpewogICAgICAgICAgICAgICAgRXh0LmVhY2gob2JqLCBmbiwgc2NvcGUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2Ygb2JqID09ICdvYmplY3QnKXsKICAgICAgICAgICAgICAgIGZvcih2YXIgcHJvcCBpbiBvYmopewogICAgICAgICAgICAgICAgICAgIGlmKG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGZuLmNhbGwoc2NvcGUgfHwgb2JqLCBwcm9wLCBvYmpbcHJvcF0sIG9iaikgPT09IGZhbHNlKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm4gdGhlIGRvbSBub2RlIGZvciB0aGUgcGFzc2VkIFN0cmluZyAoaWQpLCBkb20gbm9kZSwgb3IgRXh0LkVsZW1lbnQuCiAgICAgICAgICogT3B0aW9uYWwgJ3N0cmljdCcgZmxhZyBpcyBuZWVkZWQgZm9yIElFIHNpbmNlIGl0IGNhbiByZXR1cm4gJ25hbWUnIGFuZAogICAgICAgICAqICdpZCcgZWxlbWVudHMgYnkgdXNpbmcgZ2V0RWxlbWVudEJ5SWQuCiAgICAgICAgICogSGVyZSBhcmUgc29tZSBleGFtcGxlczoKICAgICAgICAgKiA8cHJlPjxjb2RlPgovLyBnZXRzIGRvbSBub2RlIGJhc2VkIG9uIGlkCnZhciBlbERvbSA9IEV4dC5nZXREb20oJ2VsSWQnKTsKLy8gZ2V0cyBkb20gbm9kZSBiYXNlZCBvbiB0aGUgZG9tIG5vZGUKdmFyIGVsRG9tMSA9IEV4dC5nZXREb20oZWxEb20pOwoKLy8gSWYgd2UgZG9uJiMzOTt0IGtub3cgaWYgd2UgYXJlIHdvcmtpbmcgd2l0aCBhbgovLyBFeHQuRWxlbWVudCBvciBhIGRvbSBub2RlIHVzZSBFeHQuZ2V0RG9tCmZ1bmN0aW9uKGVsKXsKICAgIHZhciBkb20gPSBFeHQuZ2V0RG9tKGVsKTsKICAgIC8vIGRvIHNvbWV0aGluZyB3aXRoIHRoZSBkb20gbm9kZQp9CiAgICAgICAgICogPC9jb2RlPjwvcHJlPgogICAgICAgICAqIDxiPk5vdGU8L2I+OiB0aGUgZG9tIG5vZGUgdG8gYmUgZm91bmQgYWN0dWFsbHkgbmVlZHMgdG8gZXhpc3QgKGJlIHJlbmRlcmVkLCBldGMpCiAgICAgICAgICogd2hlbiB0aGlzIG1ldGhvZCBpcyBjYWxsZWQgdG8gYmUgc3VjY2Vzc2Z1bC4KICAgICAgICAgKiBAcGFyYW0ge01peGVkfSBlbAogICAgICAgICAqIEByZXR1cm4gSFRNTEVsZW1lbnQKICAgICAgICAgKi8KICAgICAgICBnZXREb20gOiBmdW5jdGlvbihlbCwgc3RyaWN0KXsKICAgICAgICAgICAgaWYoIWVsIHx8ICFET0MpewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVsLmRvbSl7CiAgICAgICAgICAgICAgICByZXR1cm4gZWwuZG9tOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlbCA9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHZhciBlID0gRE9DLmdldEVsZW1lbnRCeUlkKGVsKTsKICAgICAgICAgICAgICAgICAgICAvLyBJRSByZXR1cm5zIGVsZW1lbnRzIHdpdGggdGhlICduYW1lJyBhbmQgJ2lkJyBhdHRyaWJ1dGUuCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgZG8gYSBzdHJpY3QgY2hlY2sgdG8gcmV0dXJuIHRoZSBlbGVtZW50IHdpdGggb25seSB0aGUgaWQgYXR0cmlidXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKGUgJiYgaXNJRSAmJiBzdHJpY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsID09IGUuZ2V0QXR0cmlidXRlKCdpZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGRvY3VtZW50IGJvZHkgYXMgYW4ge0BsaW5rIEV4dC5FbGVtZW50fS4KICAgICAgICAgKiBAcmV0dXJuIEV4dC5FbGVtZW50IFRoZSBkb2N1bWVudCBib2R5CiAgICAgICAgICovCiAgICAgICAgZ2V0Qm9keSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBFeHQuZ2V0KERPQy5ib2R5IHx8IERPQy5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBkb2N1bWVudCBib2R5IGFzIGFuIHtAbGluayBFeHQuRWxlbWVudH0uCiAgICAgICAgICogQHJldHVybiBFeHQuRWxlbWVudCBUaGUgZG9jdW1lbnQgYm9keQogICAgICAgICAqLwogICAgICAgIGdldEhlYWQgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGhlYWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoaGVhZCA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBoZWFkID0gRXh0LmdldChET0MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBoZWFkOwogICAgICAgICAgICB9OwogICAgICAgIH0oKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlcyBhIERPTSBub2RlIGZyb20gdGhlIGRvY3VtZW50LgogICAgICAgICAqLwogICAgICAgIC8qKgogICAgICAgICAqIDxwPlJlbW92ZXMgdGhpcyBlbGVtZW50IGZyb20gdGhlIGRvY3VtZW50LCByZW1vdmVzIGFsbCBET00gZXZlbnQgbGlzdGVuZXJzLCBhbmQgZGVsZXRlcyB0aGUgY2FjaGUgcmVmZXJlbmNlLgogICAgICAgICAqIEFsbCBET00gZXZlbnQgbGlzdGVuZXJzIGFyZSByZW1vdmVkIGZyb20gdGhpcyBlbGVtZW50LiBJZiB7QGxpbmsgRXh0I2VuYWJsZU5lc3RlZExpc3RlbmVyUmVtb3ZhbH0gaXMKICAgICAgICAgKiA8Y29kZT50cnVlPC9jb2RlPiwgdGhlbiBET00gZXZlbnQgbGlzdGVuZXJzIGFyZSBhbHNvIHJlbW92ZWQgZnJvbSBhbGwgY2hpbGQgbm9kZXMuIFRoZSBib2R5IG5vZGUKICAgICAgICAgKiB3aWxsIGJlIGlnbm9yZWQgaWYgcGFzc2VkIGluLjwvcD4KICAgICAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBub2RlIFRoZSBub2RlIHRvIHJlbW92ZQogICAgICAgICAqLwogICAgICAgIHJlbW92ZU5vZGUgOiBpc0lFICYmICFpc0lFOCA/IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBkOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obil7CiAgICAgICAgICAgICAgICBpZihuICYmIG4udGFnTmFtZSAhPSAnQk9EWScpewogICAgICAgICAgICAgICAgICAgIChFeHQuZW5hYmxlTmVzdGVkTGlzdGVuZXJSZW1vdmFsKSA/IEV4dC5FdmVudE1hbmFnZXIucHVyZ2VFbGVtZW50KG4sIHRydWUpIDogRXh0LkV2ZW50TWFuYWdlci5yZW1vdmVBbGwobik7CiAgICAgICAgICAgICAgICAgICAgZCA9IGQgfHwgRE9DLmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgICAgIGQuYXBwZW5kQ2hpbGQobik7CiAgICAgICAgICAgICAgICAgICAgZC5pbm5lckhUTUwgPSAnJzsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgRXh0LmVsQ2FjaGVbbi5pZF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSgpIDogZnVuY3Rpb24obil7CiAgICAgICAgICAgIGlmKG4gJiYgbi5wYXJlbnROb2RlICYmIG4udGFnTmFtZSAhPSAnQk9EWScpewogICAgICAgICAgICAgICAgKEV4dC5lbmFibGVOZXN0ZWRMaXN0ZW5lclJlbW92YWwpID8gRXh0LkV2ZW50TWFuYWdlci5wdXJnZUVsZW1lbnQobiwgdHJ1ZSkgOiBFeHQuRXZlbnRNYW5hZ2VyLnJlbW92ZUFsbChuKTsKICAgICAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBFeHQuZWxDYWNoZVtuLmlkXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIDxwPlJldHVybnMgdHJ1ZSBpZiB0aGUgcGFzc2VkIHZhbHVlIGlzIGVtcHR5LjwvcD4KICAgICAgICAgKiA8cD5UaGUgdmFsdWUgaXMgZGVlbWVkIHRvIGJlIGVtcHR5IGlmIGl0IGlzPGRpdiBjbGFzcz0ibWRldGFpbC1wYXJhbXMiPjx1bD4KICAgICAgICAgKiA8bGk+bnVsbDwvbGk+CiAgICAgICAgICogPGxpPnVuZGVmaW5lZDwvbGk+CiAgICAgICAgICogPGxpPmFuIGVtcHR5IGFycmF5PC9saT4KICAgICAgICAgKiA8bGk+YSB6ZXJvIGxlbmd0aCBzdHJpbmcgKFVubGVzcyB0aGUgPHR0PmFsbG93Qmxhbms8L3R0PiBwYXJhbWV0ZXIgaXMgPHR0PnRydWU8L3R0Pik8L2xpPgogICAgICAgICAqIDwvdWw+PC9kaXY+CiAgICAgICAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHRlc3QKICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGFsbG93QmxhbmsgKG9wdGlvbmFsKSB0cnVlIHRvIGFsbG93IGVtcHR5IHN0cmluZ3MgKGRlZmF1bHRzIHRvIGZhbHNlKQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNFbXB0eSA6IGZ1bmN0aW9uKHYsIGFsbG93QmxhbmspewogICAgICAgICAgICByZXR1cm4gdiA9PT0gbnVsbCB8fCB2ID09PSB1bmRlZmluZWQgfHwgKChFeHQuaXNBcnJheSh2KSAmJiAhdi5sZW5ndGgpKSB8fCAoIWFsbG93QmxhbmsgPyB2ID09PSAnJyA6IGZhbHNlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHBhc3NlZCB2YWx1ZSBpcyBhIEphdmFTY3JpcHQgYXJyYXksIG90aGVyd2lzZSBmYWxzZS4KICAgICAgICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdGVzdAogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNBcnJheSA6IGZ1bmN0aW9uKHYpewogICAgICAgICAgICByZXR1cm4gdG9TdHJpbmcuYXBwbHkodikgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgb2JqZWN0IGlzIGEgSmF2YVNjcmlwdCBkYXRlIG9iamVjdCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byB0ZXN0CiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc0RhdGUgOiBmdW5jdGlvbih2KXsKICAgICAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KHYpID09PSAnW29iamVjdCBEYXRlXSc7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgdmFsdWUgaXMgYSBKYXZhU2NyaXB0IE9iamVjdCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgICAgICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byB0ZXN0CiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc09iamVjdCA6IGZ1bmN0aW9uKHYpewogICAgICAgICAgICByZXR1cm4gISF2ICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2KSA9PT0gJ1tvYmplY3QgT2JqZWN0XSc7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgdmFsdWUgaXMgYSBKYXZhU2NyaXB0ICdwcmltaXRpdmUnLCBhIHN0cmluZywgbnVtYmVyIG9yIGJvb2xlYW4uCiAgICAgICAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHRlc3QKICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzUHJpbWl0aXZlIDogZnVuY3Rpb24odil7CiAgICAgICAgICAgIHJldHVybiBFeHQuaXNTdHJpbmcodikgfHwgRXh0LmlzTnVtYmVyKHYpIHx8IEV4dC5pc0Jvb2xlYW4odik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgdmFsdWUgaXMgYSBKYXZhU2NyaXB0IEZ1bmN0aW9uLCBvdGhlcndpc2UgZmFsc2UuCiAgICAgICAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHRlc3QKICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzRnVuY3Rpb24gOiBmdW5jdGlvbih2KXsKICAgICAgICAgICAgcmV0dXJuIHRvU3RyaW5nLmFwcGx5KHYpID09PSAnW29iamVjdCBGdW5jdGlvbl0nOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgcGFzc2VkIHZhbHVlIGlzIGEgbnVtYmVyLiBSZXR1cm5zIGZhbHNlIGZvciBub24tZmluaXRlIG51bWJlcnMuCiAgICAgICAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHRlc3QKICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzTnVtYmVyIDogZnVuY3Rpb24odil7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdiA9PT0gJ251bWJlcicgJiYgaXNGaW5pdGUodik7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgdmFsdWUgaXMgYSBzdHJpbmcuCiAgICAgICAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHRlc3QKICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAqLwogICAgICAgIGlzU3RyaW5nIDogZnVuY3Rpb24odil7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdiA9PT0gJ3N0cmluZyc7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgdmFsdWUgaXMgYSBib29sZWFuLgogICAgICAgICAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIFRoZSB2YWx1ZSB0byB0ZXN0CiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBpc0Jvb2xlYW4gOiBmdW5jdGlvbih2KXsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiB2ID09PSAnYm9vbGVhbic7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgdmFsdWUgaXMgYW4gSFRNTEVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdGVzdAogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNFbGVtZW50IDogZnVuY3Rpb24odikgewogICAgICAgICAgICByZXR1cm4gdiA/ICEhdi50YWdOYW1lIDogZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwYXNzZWQgdmFsdWUgaXMgbm90IHVuZGVmaW5lZC4KICAgICAgICAgKiBAcGFyYW0ge01peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdGVzdAogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgaXNEZWZpbmVkIDogZnVuY3Rpb24odil7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdiAhPT0gJ3VuZGVmaW5lZCc7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgZGV0ZWN0ZWQgYnJvd3NlciBpcyBPcGVyYS4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNPcGVyYSA6IGlzT3BlcmEsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgZGV0ZWN0ZWQgYnJvd3NlciB1c2VzIFdlYktpdC4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNXZWJLaXQgOiBpc1dlYktpdCwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIENocm9tZS4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNDaHJvbWUgOiBpc0Nocm9tZSwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIFNhZmFyaS4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNTYWZhcmkgOiBpc1NhZmFyaSwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIFNhZmFyaSAzLnguCiAgICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgICAqLwogICAgICAgIGlzU2FmYXJpMyA6IGlzU2FmYXJpMywKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIFNhZmFyaSA0LnguCiAgICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgICAqLwogICAgICAgIGlzU2FmYXJpNCA6IGlzU2FmYXJpNCwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIFNhZmFyaSAyLnguCiAgICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgICAqLwogICAgICAgIGlzU2FmYXJpMiA6IGlzU2FmYXJpMiwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIEludGVybmV0IEV4cGxvcmVyLgogICAgICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAgICAgKi8KICAgICAgICBpc0lFIDogaXNJRSwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIEludGVybmV0IEV4cGxvcmVyIDYueC4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNJRTYgOiBpc0lFNiwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIEludGVybmV0IEV4cGxvcmVyIDcueC4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNJRTcgOiBpc0lFNywKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIEludGVybmV0IEV4cGxvcmVyIDgueC4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNJRTggOiBpc0lFOCwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIEludGVybmV0IEV4cGxvcmVyIDkueC4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNJRTkgOiBpc0lFOSwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIHVzZXMgdGhlIEdlY2tvIGxheW91dCBlbmdpbmUgKGUuZy4gTW96aWxsYSwgRmlyZWZveCkuCiAgICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgICAqLwogICAgICAgIGlzR2Vja28gOiBpc0dlY2tvLAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIGRldGVjdGVkIGJyb3dzZXIgdXNlcyBhIHByZS1HZWNrbyAxLjkgbGF5b3V0IGVuZ2luZSAoZS5nLiBGaXJlZm94IDIueCkuCiAgICAgICAgICogQHR5cGUgQm9vbGVhbgogICAgICAgICAqLwogICAgICAgIGlzR2Vja28yIDogaXNHZWNrbzIsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgZGV0ZWN0ZWQgYnJvd3NlciB1c2VzIGEgR2Vja28gMS45KyBsYXlvdXQgZW5naW5lIChlLmcuIEZpcmVmb3ggMy54KS4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNHZWNrbzMgOiBpc0dlY2tvMywKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBicm93c2VyIGlzIEludGVybmV0IEV4cGxvcmVyIHJ1bm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLgogICAgICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAgICAgKi8KICAgICAgICBpc0JvcmRlckJveCA6IGlzQm9yZGVyQm94LAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIGRldGVjdGVkIHBsYXRmb3JtIGlzIExpbnV4LgogICAgICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAgICAgKi8KICAgICAgICBpc0xpbnV4IDogaXNMaW51eCwKICAgICAgICAvKioKICAgICAgICAgKiBUcnVlIGlmIHRoZSBkZXRlY3RlZCBwbGF0Zm9ybSBpcyBXaW5kb3dzLgogICAgICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAgICAgKi8KICAgICAgICBpc1dpbmRvd3MgOiBpc1dpbmRvd3MsCiAgICAgICAgLyoqCiAgICAgICAgICogVHJ1ZSBpZiB0aGUgZGV0ZWN0ZWQgcGxhdGZvcm0gaXMgTWFjIE9TLgogICAgICAgICAqIEB0eXBlIEJvb2xlYW4KICAgICAgICAgKi8KICAgICAgICBpc01hYyA6IGlzTWFjLAogICAgICAgIC8qKgogICAgICAgICAqIFRydWUgaWYgdGhlIGRldGVjdGVkIHBsYXRmb3JtIGlzIEFkb2JlIEFpci4KICAgICAgICAgKiBAdHlwZSBCb29sZWFuCiAgICAgICAgICovCiAgICAgICAgaXNBaXIgOiBpc0FpcgogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIG5hbWVzcGFjZXMgdG8gYmUgdXNlZCBmb3Igc2NvcGluZyB2YXJpYWJsZXMgYW5kIGNsYXNzZXMgc28gdGhhdCB0aGV5IGFyZSBub3QgZ2xvYmFsLgogICAgICogU3BlY2lmeWluZyB0aGUgbGFzdCBub2RlIG9mIGEgbmFtZXNwYWNlIGltcGxpY2l0bHkgY3JlYXRlcyBhbGwgb3RoZXIgbm9kZXMuIFVzYWdlOgogICAgICogPHByZT48Y29kZT4KRXh0Lm5hbWVzcGFjZSgnQ29tcGFueScsICdDb21wYW55LmRhdGEnKTsKRXh0Lm5hbWVzcGFjZSgnQ29tcGFueS5kYXRhJyk7IC8vIGVxdWl2YWxlbnQgYW5kIHByZWZlcmFibGUgdG8gYWJvdmUgc3ludGF4CkNvbXBhbnkuV2lkZ2V0ID0gZnVuY3Rpb24oKSB7IC4uLiB9CkNvbXBhbnkuZGF0YS5DdXN0b21TdG9yZSA9IGZ1bmN0aW9uKGNvbmZpZykgeyAuLi4gfQo8L2NvZGU+PC9wcmU+CiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZXNwYWNlMQogICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZTIKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldGMKICAgICAqIEByZXR1cm4ge09iamVjdH0gVGhlIG5hbWVzcGFjZSBvYmplY3QuIChJZiBtdWx0aXBsZSBhcmd1bWVudHMgYXJlIHBhc3NlZCwgdGhpcyB3aWxsIGJlIHRoZSBsYXN0IG5hbWVzcGFjZSBjcmVhdGVkKQogICAgICogQG1ldGhvZCBucwogICAgICovCiAgICBFeHQubnMgPSBFeHQubmFtZXNwYWNlOwp9KSgpOwoKRXh0Lm5zKCdFeHQudXRpbCcsICdFeHQubGliJywgJ0V4dC5kYXRhJywgJ0V4dC5zdXBwb3J0cycpOwoKRXh0LmVsQ2FjaGUgPSB7fTsKCi8qKgogKiBAY2xhc3MgRnVuY3Rpb24KICogVGhlc2UgZnVuY3Rpb25zIGFyZSBhdmFpbGFibGUgb24gZXZlcnkgRnVuY3Rpb24gb2JqZWN0IChhbnkgSmF2YVNjcmlwdCBmdW5jdGlvbikuCiAqLwpFeHQuYXBwbHkoRnVuY3Rpb24ucHJvdG90eXBlLCB7CiAgICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGludGVyY2VwdG9yIGZ1bmN0aW9uLiBUaGUgcGFzc2VkIGZ1bmN0aW9uIGlzIGNhbGxlZCBiZWZvcmUgdGhlIG9yaWdpbmFsIG9uZS4gSWYgaXQgcmV0dXJucyBmYWxzZSwKICAgICAqIHRoZSBvcmlnaW5hbCBvbmUgaXMgbm90IGNhbGxlZC4gVGhlIHJlc3VsdGluZyBmdW5jdGlvbiByZXR1cm5zIHRoZSByZXN1bHRzIG9mIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICAgICAqIFRoZSBwYXNzZWQgZnVuY3Rpb24gaXMgY2FsbGVkIHdpdGggdGhlIHBhcmFtZXRlcnMgb2YgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLiBFeGFtcGxlIHVzYWdlOgogICAgICogPHByZT48Y29kZT4KdmFyIHNheUhpID0gZnVuY3Rpb24obmFtZSl7CiAgICBhbGVydCgnSGksICcgKyBuYW1lKTsKfQoKc2F5SGkoJ0ZyZWQnKTsgLy8gYWxlcnRzICJIaSwgRnJlZCIKCi8vIGNyZWF0ZSBhIG5ldyBmdW5jdGlvbiB0aGF0IHZhbGlkYXRlcyBpbnB1dCB3aXRob3V0Ci8vIGRpcmVjdGx5IG1vZGlmeWluZyB0aGUgb3JpZ2luYWwgZnVuY3Rpb246CnZhciBzYXlIaVRvRnJpZW5kID0gc2F5SGkuY3JlYXRlSW50ZXJjZXB0b3IoZnVuY3Rpb24obmFtZSl7CiAgICByZXR1cm4gbmFtZSA9PSAnQnJpYW4nOwp9KTsKCnNheUhpVG9GcmllbmQoJ0ZyZWQnKTsgIC8vIG5vIGFsZXJ0CnNheUhpVG9GcmllbmQoJ0JyaWFuJyk7IC8vIGFsZXJ0cyAiSGksIEJyaWFuIgo8L2NvZGU+PC9wcmU+CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmY24gVGhlIGZ1bmN0aW9uIHRvIGNhbGwgYmVmb3JlIHRoZSBvcmlnaW5hbAogICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIChvcHRpb25hbCkgVGhlIHNjb3BlICg8Y29kZT48Yj50aGlzPC9iPjwvY29kZT4gcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUgcGFzc2VkIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICogPGI+SWYgb21pdHRlZCwgZGVmYXVsdHMgdG8gdGhlIHNjb3BlIGluIHdoaWNoIHRoZSBvcmlnaW5hbCBmdW5jdGlvbiBpcyBjYWxsZWQgb3IgdGhlIGJyb3dzZXIgd2luZG93LjwvYj4KICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBUaGUgbmV3IGZ1bmN0aW9uCiAgICAgKi8KICAgIGNyZWF0ZUludGVyY2VwdG9yIDogZnVuY3Rpb24oZmNuLCBzY29wZSl7CiAgICAgICAgdmFyIG1ldGhvZCA9IHRoaXM7CiAgICAgICAgcmV0dXJuICFFeHQuaXNGdW5jdGlvbihmY24pID8KICAgICAgICAgICAgICAgIHRoaXMgOgogICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgICAgICAgICBmY24udGFyZ2V0ID0gbWU7CiAgICAgICAgICAgICAgICAgICAgZmNuLm1ldGhvZCA9IG1ldGhvZDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGZjbi5hcHBseShzY29wZSB8fCBtZSB8fCB3aW5kb3csIGFyZ3MpICE9PSBmYWxzZSkgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kLmFwcGx5KG1lIHx8IHdpbmRvdywgYXJncykgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbnVsbDsKICAgICAgICAgICAgICAgIH07CiAgICB9LAoKICAgICAvKioKICAgICAqIENyZWF0ZXMgYSBjYWxsYmFjayB0aGF0IHBhc3NlcyBhcmd1bWVudHNbMF0sIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCAuLi4KICAgICAqIENhbGwgZGlyZWN0bHkgb24gYW55IGZ1bmN0aW9uLiBFeGFtcGxlOiA8Y29kZT5teUZ1bmN0aW9uLmNyZWF0ZUNhbGxiYWNrKGFyZzEsIGFyZzIpPC9jb2RlPgogICAgICogV2lsbCBjcmVhdGUgYSBmdW5jdGlvbiB0aGF0IGlzIGJvdW5kIHRvIHRob3NlIDIgYXJncy4gPGI+SWYgYSBzcGVjaWZpYyBzY29wZSBpcyByZXF1aXJlZCBpbiB0aGUKICAgICAqIGNhbGxiYWNrLCB1c2Uge0BsaW5rICNjcmVhdGVEZWxlZ2F0ZX0gaW5zdGVhZC48L2I+IFRoZSBmdW5jdGlvbiByZXR1cm5lZCBieSBjcmVhdGVDYWxsYmFjayBhbHdheXMKICAgICAqIGV4ZWN1dGVzIGluIHRoZSB3aW5kb3cgc2NvcGUuCiAgICAgKiA8cD5UaGlzIG1ldGhvZCBpcyByZXF1aXJlZCB3aGVuIHlvdSB3YW50IHRvIHBhc3MgYXJndW1lbnRzIHRvIGEgY2FsbGJhY2sgZnVuY3Rpb24uICBJZiBubyBhcmd1bWVudHMKICAgICAqIGFyZSBuZWVkZWQsIHlvdSBjYW4gc2ltcGx5IHBhc3MgYSByZWZlcmVuY2UgdG8gdGhlIGZ1bmN0aW9uIGFzIGEgY2FsbGJhY2sgKGUuZy4sIGNhbGxiYWNrOiBteUZuKS4KICAgICAqIEhvd2V2ZXIsIGlmIHlvdSB0cmllZCB0byBwYXNzIGEgZnVuY3Rpb24gd2l0aCBhcmd1bWVudHMgKGUuZy4sIGNhbGxiYWNrOiBteUZuKGFyZzEsIGFyZzIpKSB0aGUgZnVuY3Rpb24KICAgICAqIHdvdWxkIHNpbXBseSBleGVjdXRlIGltbWVkaWF0ZWx5IHdoZW4gdGhlIGNvZGUgaXMgcGFyc2VkLiBFeGFtcGxlIHVzYWdlOgogICAgICogPHByZT48Y29kZT4KdmFyIHNheUhpID0gZnVuY3Rpb24obmFtZSl7CiAgICBhbGVydCgnSGksICcgKyBuYW1lKTsKfQoKLy8gY2xpY2tpbmcgdGhlIGJ1dHRvbiBhbGVydHMgIkhpLCBGcmVkIgpuZXcgRXh0LkJ1dHRvbih7CiAgICB0ZXh0OiAnU2F5IEhpJywKICAgIHJlbmRlclRvOiBFeHQuZ2V0Qm9keSgpLAogICAgaGFuZGxlcjogc2F5SGkuY3JlYXRlQ2FsbGJhY2soJ0ZyZWQnKQp9KTsKPC9jb2RlPjwvcHJlPgogICAgICogQHJldHVybiB7RnVuY3Rpb259IFRoZSBuZXcgZnVuY3Rpb24KICAgICovCiAgICBjcmVhdGVDYWxsYmFjayA6IGZ1bmN0aW9uKC8qYXJncy4uLiovKXsKICAgICAgICAvLyBtYWtlIGFyZ3MgYXZhaWxhYmxlLCBpbiBmdW5jdGlvbiBiZWxvdwogICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICBtZXRob2QgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh3aW5kb3csIGFyZ3MpOwogICAgICAgIH07CiAgICB9LAoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGRlbGVnYXRlIChjYWxsYmFjaykgdGhhdCBzZXRzIHRoZSBzY29wZSB0byBvYmouCiAgICAgKiBDYWxsIGRpcmVjdGx5IG9uIGFueSBmdW5jdGlvbi4gRXhhbXBsZTogPGNvZGU+dGhpcy5teUZ1bmN0aW9uLmNyZWF0ZURlbGVnYXRlKHRoaXMsIFthcmcxLCBhcmcyXSk8L2NvZGU+CiAgICAgKiBXaWxsIGNyZWF0ZSBhIGZ1bmN0aW9uIHRoYXQgaXMgYXV0b21hdGljYWxseSBzY29wZWQgdG8gb2JqIHNvIHRoYXQgdGhlIDx0dD50aGlzPC90dD4gdmFyaWFibGUgaW5zaWRlIHRoZQogICAgICogY2FsbGJhY2sgcG9pbnRzIHRvIG9iai4gRXhhbXBsZSB1c2FnZToKICAgICAqIDxwcmU+PGNvZGU+CnZhciBzYXlIaSA9IGZ1bmN0aW9uKG5hbWUpewogICAgLy8gTm90ZSB0aGlzIHVzZSBvZiAidGhpcy50ZXh0IiBoZXJlLiAgVGhpcyBmdW5jdGlvbiBleHBlY3RzIHRvCiAgICAvLyBleGVjdXRlIHdpdGhpbiBhIHNjb3BlIHRoYXQgY29udGFpbnMgYSB0ZXh0IHByb3BlcnR5LiAgSW4gdGhpcwogICAgLy8gZXhhbXBsZSwgdGhlICJ0aGlzIiB2YXJpYWJsZSBpcyBwb2ludGluZyB0byB0aGUgYnRuIG9iamVjdCB0aGF0CiAgICAvLyB3YXMgcGFzc2VkIGluIGNyZWF0ZURlbGVnYXRlIGJlbG93LgogICAgYWxlcnQoJ0hpLCAnICsgbmFtZSArICcuIFlvdSBjbGlja2VkIHRoZSAiJyArIHRoaXMudGV4dCArICciIGJ1dHRvbi4nKTsKfQoKdmFyIGJ0biA9IG5ldyBFeHQuQnV0dG9uKHsKICAgIHRleHQ6ICdTYXkgSGknLAogICAgcmVuZGVyVG86IEV4dC5nZXRCb2R5KCkKfSk7CgovLyBUaGlzIGNhbGxiYWNrIHdpbGwgZXhlY3V0ZSBpbiB0aGUgc2NvcGUgb2YgdGhlCi8vIGJ1dHRvbiBpbnN0YW5jZS4gQ2xpY2tpbmcgdGhlIGJ1dHRvbiBhbGVydHMKLy8gIkhpLCBGcmVkLiBZb3UgY2xpY2tlZCB0aGUgIlNheSBIaSIgYnV0dG9uLiIKYnRuLm9uKCdjbGljaycsIHNheUhpLmNyZWF0ZURlbGVnYXRlKGJ0biwgWydGcmVkJ10pKTsKPC9jb2RlPjwvcHJlPgogICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIChvcHRpb25hbCkgVGhlIHNjb3BlICg8Y29kZT48Yj50aGlzPC9iPjwvY29kZT4gcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAgICAgKiA8Yj5JZiBvbWl0dGVkLCBkZWZhdWx0cyB0byB0aGUgYnJvd3NlciB3aW5kb3cuPC9iPgogICAgICogQHBhcmFtIHtBcnJheX0gYXJncyAob3B0aW9uYWwpIE92ZXJyaWRlcyBhcmd1bWVudHMgZm9yIHRoZSBjYWxsLiAoRGVmYXVsdHMgdG8gdGhlIGFyZ3VtZW50cyBwYXNzZWQgYnkgdGhlIGNhbGxlcikKICAgICAqIEBwYXJhbSB7Qm9vbGVhbi9OdW1iZXJ9IGFwcGVuZEFyZ3MgKG9wdGlvbmFsKSBpZiBUcnVlIGFyZ3MgYXJlIGFwcGVuZGVkIHRvIGNhbGwgYXJncyBpbnN0ZWFkIG9mIG92ZXJyaWRpbmcsCiAgICAgKiBpZiBhIG51bWJlciB0aGUgYXJncyBhcmUgaW5zZXJ0ZWQgYXQgdGhlIHNwZWNpZmllZCBwb3NpdGlvbgogICAgICogQHJldHVybiB7RnVuY3Rpb259IFRoZSBuZXcgZnVuY3Rpb24KICAgICAqLwogICAgY3JlYXRlRGVsZWdhdGUgOiBmdW5jdGlvbihvYmosIGFyZ3MsIGFwcGVuZEFyZ3MpewogICAgICAgIHZhciBtZXRob2QgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNhbGxBcmdzID0gYXJncyB8fCBhcmd1bWVudHM7CiAgICAgICAgICAgIGlmIChhcHBlbmRBcmdzID09PSB0cnVlKXsKICAgICAgICAgICAgICAgIGNhbGxBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKICAgICAgICAgICAgICAgIGNhbGxBcmdzID0gY2FsbEFyZ3MuY29uY2F0KGFyZ3MpOwogICAgICAgICAgICB9ZWxzZSBpZiAoRXh0LmlzTnVtYmVyKGFwcGVuZEFyZ3MpKXsKICAgICAgICAgICAgICAgIGNhbGxBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsgLy8gY29weSBhcmd1bWVudHMgZmlyc3QKICAgICAgICAgICAgICAgIHZhciBhcHBseUFyZ3MgPSBbYXBwZW5kQXJncywgMF0uY29uY2F0KGFyZ3MpOyAvLyBjcmVhdGUgbWV0aG9kIGNhbGwgcGFyYW1zCiAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmFwcGx5KGNhbGxBcmdzLCBhcHBseUFyZ3MpOyAvLyBzcGxpY2UgdGhlbSBpbgogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkob2JqIHx8IHdpbmRvdywgY2FsbEFyZ3MpOwogICAgICAgIH07CiAgICB9LAoKICAgIC8qKgogICAgICogQ2FsbHMgdGhpcyBmdW5jdGlvbiBhZnRlciB0aGUgbnVtYmVyIG9mIG1pbGxzZWNvbmRzIHNwZWNpZmllZCwgb3B0aW9uYWxseSBpbiBhIHNwZWNpZmljIHNjb3BlLiBFeGFtcGxlIHVzYWdlOgogICAgICogPHByZT48Y29kZT4KdmFyIHNheUhpID0gZnVuY3Rpb24obmFtZSl7CiAgICBhbGVydCgnSGksICcgKyBuYW1lKTsKfQoKLy8gZXhlY3V0ZXMgaW1tZWRpYXRlbHk6CnNheUhpKCdGcmVkJyk7CgovLyBleGVjdXRlcyBhZnRlciAyIHNlY29uZHM6CnNheUhpLmRlZmVyKDIwMDAsIHRoaXMsIFsnRnJlZCddKTsKCi8vIHRoaXMgc3ludGF4IGlzIHNvbWV0aW1lcyB1c2VmdWwgZm9yIGRlZmVycmluZwovLyBleGVjdXRpb24gb2YgYW4gYW5vbnltb3VzIGZ1bmN0aW9uOgooZnVuY3Rpb24oKXsKICAgIGFsZXJ0KCdBbm9ueW1vdXMnKTsKfSkuZGVmZXIoMTAwKTsKPC9jb2RlPjwvcHJlPgogICAgICogQHBhcmFtIHtOdW1iZXJ9IG1pbGxpcyBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBmb3IgdGhlIHNldFRpbWVvdXQgY2FsbCAoaWYgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIDAgdGhlIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkIGltbWVkaWF0ZWx5KQogICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIChvcHRpb25hbCkgVGhlIHNjb3BlICg8Y29kZT48Yj50aGlzPC9iPjwvY29kZT4gcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAgICAgKiA8Yj5JZiBvbWl0dGVkLCBkZWZhdWx0cyB0byB0aGUgYnJvd3NlciB3aW5kb3cuPC9iPgogICAgICogQHBhcmFtIHtBcnJheX0gYXJncyAob3B0aW9uYWwpIE92ZXJyaWRlcyBhcmd1bWVudHMgZm9yIHRoZSBjYWxsLiAoRGVmYXVsdHMgdG8gdGhlIGFyZ3VtZW50cyBwYXNzZWQgYnkgdGhlIGNhbGxlcikKICAgICAqIEBwYXJhbSB7Qm9vbGVhbi9OdW1iZXJ9IGFwcGVuZEFyZ3MgKG9wdGlvbmFsKSBpZiBUcnVlIGFyZ3MgYXJlIGFwcGVuZGVkIHRvIGNhbGwgYXJncyBpbnN0ZWFkIG9mIG92ZXJyaWRpbmcsCiAgICAgKiBpZiBhIG51bWJlciB0aGUgYXJncyBhcmUgaW5zZXJ0ZWQgYXQgdGhlIHNwZWNpZmllZCBwb3NpdGlvbgogICAgICogQHJldHVybiB7TnVtYmVyfSBUaGUgdGltZW91dCBpZCB0aGF0IGNhbiBiZSB1c2VkIHdpdGggY2xlYXJUaW1lb3V0CiAgICAgKi8KICAgIGRlZmVyIDogZnVuY3Rpb24obWlsbGlzLCBvYmosIGFyZ3MsIGFwcGVuZEFyZ3MpewogICAgICAgIHZhciBmbiA9IHRoaXMuY3JlYXRlRGVsZWdhdGUob2JqLCBhcmdzLCBhcHBlbmRBcmdzKTsKICAgICAgICBpZihtaWxsaXMgPiAwKXsKICAgICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZm4sIG1pbGxpcyk7CiAgICAgICAgfQogICAgICAgIGZuKCk7CiAgICAgICAgcmV0dXJuIDA7CiAgICB9Cn0pOwoKLyoqCiAqIEBjbGFzcyBTdHJpbmcKICogVGhlc2UgZnVuY3Rpb25zIGFyZSBhdmFpbGFibGUgb24gZXZlcnkgU3RyaW5nIG9iamVjdC4KICovCkV4dC5hcHBseUlmKFN0cmluZywgewogICAgLyoqCiAgICAgKiBBbGxvd3MgeW91IHRvIGRlZmluZSBhIHRva2VuaXplZCBzdHJpbmcgYW5kIHBhc3MgYW4gYXJiaXRyYXJ5IG51bWJlciBvZiBhcmd1bWVudHMgdG8gcmVwbGFjZSB0aGUgdG9rZW5zLiAgRWFjaAogICAgICogdG9rZW4gbXVzdCBiZSB1bmlxdWUsIGFuZCBtdXN0IGluY3JlbWVudCBpbiB0aGUgZm9ybWF0IHswfSwgezF9LCBldGMuICBFeGFtcGxlIHVzYWdlOgogICAgICogPHByZT48Y29kZT4KdmFyIGNscyA9ICdteS1jbGFzcycsIHRleHQgPSAnU29tZSB0ZXh0JzsKdmFyIHMgPSBTdHJpbmcuZm9ybWF0KCcmbHQ7ZGl2IGNsYXNzPSJ7MH0iPnsxfSZsdDsvZGl2PicsIGNscywgdGV4dCk7Ci8vIHMgbm93IGNvbnRhaW5zIHRoZSBzdHJpbmc6ICcmbHQ7ZGl2IGNsYXNzPSJteS1jbGFzcyI+U29tZSB0ZXh0Jmx0Oy9kaXY+JwogICAgICogPC9jb2RlPjwvcHJlPgogICAgICogQHBhcmFtIHtTdHJpbmd9IHN0cmluZyBUaGUgdG9rZW5pemVkIHN0cmluZyB0byBiZSBmb3JtYXR0ZWQKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZTEgVGhlIHZhbHVlIHRvIHJlcGxhY2UgdG9rZW4gezB9CiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUyIEV0Yy4uLgogICAgICogQHJldHVybiB7U3RyaW5nfSBUaGUgZm9ybWF0dGVkIHN0cmluZwogICAgICogQHN0YXRpYwogICAgICovCiAgICBmb3JtYXQgOiBmdW5jdGlvbihmb3JtYXQpewogICAgICAgIHZhciBhcmdzID0gRXh0LnRvQXJyYXkoYXJndW1lbnRzLCAxKTsKICAgICAgICByZXR1cm4gZm9ybWF0LnJlcGxhY2UoL1x7KFxkKylcfS9nLCBmdW5jdGlvbihtLCBpKXsKICAgICAgICAgICAgcmV0dXJuIGFyZ3NbaV07CiAgICAgICAgfSk7CiAgICB9Cn0pOwoKLyoqCiAqIEBjbGFzcyBBcnJheQogKi8KRXh0LmFwcGx5SWYoQXJyYXkucHJvdG90eXBlLCB7CiAgICAvKioKICAgICAqIENoZWNrcyB3aGV0aGVyIG9yIG5vdCB0aGUgc3BlY2lmaWVkIG9iamVjdCBleGlzdHMgaW4gdGhlIGFycmF5LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byBjaGVjayBmb3IKICAgICAqIEBwYXJhbSB7TnVtYmVyfSBmcm9tIChPcHRpb25hbCkgVGhlIGluZGV4IGF0IHdoaWNoIHRvIGJlZ2luIHRoZSBzZWFyY2gKICAgICAqIEByZXR1cm4ge051bWJlcn0gVGhlIGluZGV4IG9mIG8gaW4gdGhlIGFycmF5IChvciAtMSBpZiBpdCBpcyBub3QgZm91bmQpCiAgICAgKi8KICAgIGluZGV4T2YgOiBmdW5jdGlvbihvLCBmcm9tKXsKICAgICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgICAgZnJvbSA9IGZyb20gfHwgMDsKICAgICAgICBmcm9tICs9IChmcm9tIDwgMCkgPyBsZW4gOiAwOwogICAgICAgIGZvciAoOyBmcm9tIDwgbGVuOyArK2Zyb20pewogICAgICAgICAgICBpZih0aGlzW2Zyb21dID09PSBvKXsKICAgICAgICAgICAgICAgIHJldHVybiBmcm9tOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZW1vdmVzIHRoZSBzcGVjaWZpZWQgb2JqZWN0IGZyb20gdGhlIGFycmF5LiAgSWYgdGhlIG9iamVjdCBpcyBub3QgZm91bmQgbm90aGluZyBoYXBwZW5zLgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB0byByZW1vdmUKICAgICAqIEByZXR1cm4ge0FycmF5fSB0aGlzIGFycmF5CiAgICAgKi8KICAgIHJlbW92ZSA6IGZ1bmN0aW9uKG8pewogICAgICAgIHZhciBpbmRleCA9IHRoaXMuaW5kZXhPZihvKTsKICAgICAgICBpZihpbmRleCAhPSAtMSl7CiAgICAgICAgICAgIHRoaXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Cn0pOwovKioKICogQGNsYXNzIEV4dC51dGlsLlRhc2tSdW5uZXIKICogUHJvdmlkZXMgdGhlIGFiaWxpdHkgdG8gZXhlY3V0ZSBvbmUgb3IgbW9yZSBhcmJpdHJhcnkgdGFza3MgaW4gYSBtdWx0aXRocmVhZGVkCiAqIG1hbm5lci4gIEdlbmVyYWxseSwgeW91IGNhbiB1c2UgdGhlIHNpbmdsZXRvbiB7QGxpbmsgRXh0LlRhc2tNZ3J9IGluc3RlYWQsIGJ1dAogKiBpZiBuZWVkZWQsIHlvdSBjYW4gY3JlYXRlIHNlcGFyYXRlIGluc3RhbmNlcyBvZiBUYXNrUnVubmVyLiAgQW55IG51bWJlciBvZgogKiBzZXBhcmF0ZSB0YXNrcyBjYW4gYmUgc3RhcnRlZCBhdCBhbnkgdGltZSBhbmQgd2lsbCBydW4gaW5kZXBlbmRlbnRseSBvZiBlYWNoCiAqIG90aGVyLiBFeGFtcGxlIHVzYWdlOgogKiA8cHJlPjxjb2RlPgovLyBTdGFydCBhIHNpbXBsZSBjbG9jayB0YXNrIHRoYXQgdXBkYXRlcyBhIGRpdiBvbmNlIHBlciBzZWNvbmQKdmFyIHVwZGF0ZUNsb2NrID0gZnVuY3Rpb24oKXsKICAgIEV4dC5mbHkoJ2Nsb2NrJykudXBkYXRlKG5ldyBEYXRlKCkuZm9ybWF0KCdnOmk6cyBBJykpOwp9IAp2YXIgdGFzayA9IHsKICAgIHJ1bjogdXBkYXRlQ2xvY2ssCiAgICBpbnRlcnZhbDogMTAwMCAvLzEgc2Vjb25kCn0KdmFyIHJ1bm5lciA9IG5ldyBFeHQudXRpbC5UYXNrUnVubmVyKCk7CnJ1bm5lci5zdGFydCh0YXNrKTsKCi8vIGVxdWl2YWxlbnQgdXNpbmcgVGFza01ncgpFeHQuVGFza01nci5zdGFydCh7CiAgICBydW46IHVwZGF0ZUNsb2NrLAogICAgaW50ZXJ2YWw6IDEwMDAKfSk7CgogKiA8L2NvZGU+PC9wcmU+CiAqIDxwPlNlZSB0aGUge0BsaW5rICNzdGFydH0gbWV0aG9kIGZvciBkZXRhaWxzIGFib3V0IGhvdyB0byBjb25maWd1cmUgYSB0YXNrIG9iamVjdC48L3A+CiAqIEFsc28gc2VlIHtAbGluayBFeHQudXRpbC5EZWxheWVkVGFza30uIAogKiAKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB7TnVtYmVyfSBpbnRlcnZhbCAob3B0aW9uYWwpIFRoZSBtaW5pbXVtIHByZWNpc2lvbiBpbiBtaWxsaXNlY29uZHMgc3VwcG9ydGVkIGJ5IHRoaXMgVGFza1J1bm5lciBpbnN0YW5jZQogKiAoZGVmYXVsdHMgdG8gMTApCiAqLwpFeHQudXRpbC5UYXNrUnVubmVyID0gZnVuY3Rpb24oaW50ZXJ2YWwpewogICAgaW50ZXJ2YWwgPSBpbnRlcnZhbCB8fCAxMDsKICAgIHZhciB0YXNrcyA9IFtdLCAKICAgIAlyZW1vdmVRdWV1ZSA9IFtdLAogICAgCWlkID0gMCwKICAgIAlydW5uaW5nID0gZmFsc2UsCgogICAgCS8vIHByaXZhdGUKICAgIAlzdG9wVGhyZWFkID0gZnVuY3Rpb24oKXsKCSAgICAgICAgcnVubmluZyA9IGZhbHNlOwoJICAgICAgICBjbGVhckludGVydmFsKGlkKTsKCSAgICAgICAgaWQgPSAwOwoJICAgIH0sCgogICAgCS8vIHByaXZhdGUKICAgIAlzdGFydFRocmVhZCA9IGZ1bmN0aW9uKCl7CgkgICAgICAgIGlmKCFydW5uaW5nKXsKCSAgICAgICAgICAgIHJ1bm5pbmcgPSB0cnVlOwoJICAgICAgICAgICAgaWQgPSBzZXRJbnRlcnZhbChydW5UYXNrcywgaW50ZXJ2YWwpOwoJICAgICAgICB9CgkgICAgfSwKCiAgICAJLy8gcHJpdmF0ZQogICAgCXJlbW92ZVRhc2sgPSBmdW5jdGlvbih0KXsKCSAgICAgICAgcmVtb3ZlUXVldWUucHVzaCh0KTsKCSAgICAgICAgaWYodC5vblN0b3ApewoJICAgICAgICAgICAgdC5vblN0b3AuYXBwbHkodC5zY29wZSB8fCB0KTsKCSAgICAgICAgfQoJICAgIH0sCgkgICAgCiAgICAJLy8gcHJpdmF0ZQogICAgCXJ1blRhc2tzID0gZnVuY3Rpb24oKXsKCSAgICAJdmFyIHJxTGVuID0gcmVtb3ZlUXVldWUubGVuZ3RoLAoJICAgIAkJbm93ID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CSAgICAJCQkgICAgCQkKCSAgICAKCSAgICAgICAgaWYocnFMZW4gPiAwKXsKCSAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBycUxlbjsgaSsrKXsKCSAgICAgICAgICAgICAgICB0YXNrcy5yZW1vdmUocmVtb3ZlUXVldWVbaV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmVtb3ZlUXVldWUgPSBbXTsKCSAgICAgICAgICAgIGlmKHRhc2tzLmxlbmd0aCA8IDEpewoJICAgICAgICAgICAgICAgIHN0b3BUaHJlYWQoKTsKCSAgICAgICAgICAgICAgICByZXR1cm47CgkgICAgICAgICAgICB9CgkgICAgICAgIH0JICAgICAgICAKCSAgICAgICAgZm9yKHZhciBpID0gMCwgdCwgaXRpbWUsIHJ0LCBsZW4gPSB0YXNrcy5sZW5ndGg7IGkgPCBsZW47ICsraSl7CgkgICAgICAgICAgICB0ID0gdGFza3NbaV07CgkgICAgICAgICAgICBpdGltZSA9IG5vdyAtIHQudGFza1J1blRpbWU7CgkgICAgICAgICAgICBpZih0LmludGVydmFsIDw9IGl0aW1lKXsKCSAgICAgICAgICAgICAgICBydCA9IHQucnVuLmFwcGx5KHQuc2NvcGUgfHwgdCwgdC5hcmdzIHx8IFsrK3QudGFza1J1bkNvdW50XSk7CgkgICAgICAgICAgICAgICAgdC50YXNrUnVuVGltZSA9IG5vdzsKCSAgICAgICAgICAgICAgICBpZihydCA9PT0gZmFsc2UgfHwgdC50YXNrUnVuQ291bnQgPT09IHQucmVwZWF0KXsKCSAgICAgICAgICAgICAgICAgICAgcmVtb3ZlVGFzayh0KTsKCSAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGlmKHQuZHVyYXRpb24gJiYgdC5kdXJhdGlvbiA8PSAobm93IC0gdC50YXNrU3RhcnRUaW1lKSl7CgkgICAgICAgICAgICAgICAgcmVtb3ZlVGFzayh0KTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgIH07CgogICAgLyoqCiAgICAgKiBTdGFydHMgYSBuZXcgdGFzay4KICAgICAqIEBtZXRob2Qgc3RhcnQKICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0YXNrIDxwPkEgY29uZmlnIG9iamVjdCB0aGF0IHN1cHBvcnRzIHRoZSBmb2xsb3dpbmcgcHJvcGVydGllczo8dWw+CiAgICAgKiA8bGk+PGNvZGU+cnVuPC9jb2RlPiA6IEZ1bmN0aW9uPGRpdiBjbGFzcz0ic3ViLWRlc2MiPjxwPlRoZSBmdW5jdGlvbiB0byBleGVjdXRlIGVhY2ggdGltZSB0aGUgdGFzayBpcyBpbnZva2VkLiBUaGUKICAgICAqIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIGF0IGVhY2ggaW50ZXJ2YWwgYW5kIHBhc3NlZCB0aGUgPGNvZGU+YXJnczwvY29kZT4gYXJndW1lbnQgaWYgc3BlY2lmaWVkLCBhbmQgdGhlCiAgICAgKiBjdXJyZW50IGludm9jYXRpb24gY291bnQgaWYgbm90LjwvcD4KICAgICAqIDxwPklmIGEgcGFydGljdWxhciBzY29wZSAoPGNvZGU+dGhpczwvY29kZT4gcmVmZXJlbmNlKSBpcyByZXF1aXJlZCwgYmUgc3VyZSB0byBzcGVjaWZ5IGl0IHVzaW5nIHRoZSA8Y29kZT5zY29wZTwvY29kZT4gYXJndW1lbnQuPC9wPgogICAgICogPHA+UmV0dXJuIDxjb2RlPmZhbHNlPC9jb2RlPiBmcm9tIHRoaXMgZnVuY3Rpb24gdG8gdGVybWluYXRlIHRoZSB0YXNrLjwvcD48L2Rpdj48L2xpPgogICAgICogPGxpPjxjb2RlPmludGVydmFsPC9jb2RlPiA6IE51bWJlcjxkaXYgY2xhc3M9InN1Yi1kZXNjIj5UaGUgZnJlcXVlbmN5IGluIG1pbGxpc2Vjb25kcyB3aXRoIHdoaWNoIHRoZSB0YXNrCiAgICAgKiBzaG91bGQgYmUgaW52b2tlZC48L2Rpdj48L2xpPgogICAgICogPGxpPjxjb2RlPmFyZ3M8L2NvZGU+IDogQXJyYXk8ZGl2IGNsYXNzPSJzdWItZGVzYyI+KG9wdGlvbmFsKSBBbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gYmUgcGFzc2VkIHRvIHRoZSBmdW5jdGlvbgogICAgICogc3BlY2lmaWVkIGJ5IDxjb2RlPnJ1bjwvY29kZT4uIElmIG5vdCBzcGVjaWZpZWQsIHRoZSBjdXJyZW50IGludm9jYXRpb24gY291bnQgaXMgcGFzc2VkLjwvZGl2PjwvbGk+CiAgICAgKiA8bGk+PGNvZGU+c2NvcGU8L2NvZGU+IDogT2JqZWN0PGRpdiBjbGFzcz0ic3ViLWRlc2MiPihvcHRpb25hbCkgVGhlIHNjb3BlICg8dHQ+dGhpczwvdHQ+IHJlZmVyZW5jZSkgaW4gd2hpY2ggdG8gZXhlY3V0ZSB0aGUKICAgICAqIDxjb2RlPnJ1bjwvY29kZT4gZnVuY3Rpb24uIERlZmF1bHRzIHRvIHRoZSB0YXNrIGNvbmZpZyBvYmplY3QuPC9kaXY+PC9saT4KICAgICAqIDxsaT48Y29kZT5kdXJhdGlvbjwvY29kZT4gOiBOdW1iZXI8ZGl2IGNsYXNzPSJzdWItZGVzYyI+KG9wdGlvbmFsKSBUaGUgbGVuZ3RoIG9mIHRpbWUgaW4gbWlsbGlzZWNvbmRzIHRvIGludm9rZQogICAgICogdGhlIHRhc2sgYmVmb3JlIHN0b3BwaW5nIGF1dG9tYXRpY2FsbHkgKGRlZmF1bHRzIHRvIGluZGVmaW5pdGUpLjwvZGl2PjwvbGk+CiAgICAgKiA8bGk+PGNvZGU+cmVwZWF0PC9jb2RlPiA6IE51bWJlcjxkaXYgY2xhc3M9InN1Yi1kZXNjIj4ob3B0aW9uYWwpIFRoZSBudW1iZXIgb2YgdGltZXMgdG8gaW52b2tlIHRoZSB0YXNrIGJlZm9yZQogICAgICogc3RvcHBpbmcgYXV0b21hdGljYWxseSAoZGVmYXVsdHMgdG8gaW5kZWZpbml0ZSkuPC9kaXY+PC9saT4KICAgICAqIDwvdWw+PC9wPgogICAgICogPHA+QmVmb3JlIGVhY2ggaW52b2NhdGlvbiwgRXh0IGluamVjdHMgdGhlIHByb3BlcnR5IDxjb2RlPnRhc2tSdW5Db3VudDwvY29kZT4gaW50byB0aGUgdGFzayBvYmplY3Qgc28KICAgICAqIHRoYXQgY2FsY3VsYXRpb25zIGJhc2VkIG9uIHRoZSByZXBlYXQgY291bnQgY2FuIGJlIHBlcmZvcm1lZC48L3A+CiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSB0YXNrCiAgICAgKi8KICAgIHRoaXMuc3RhcnQgPSBmdW5jdGlvbih0YXNrKXsKICAgICAgICB0YXNrcy5wdXNoKHRhc2spOwogICAgICAgIHRhc2sudGFza1N0YXJ0VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgIHRhc2sudGFza1J1blRpbWUgPSAwOwogICAgICAgIHRhc2sudGFza1J1bkNvdW50ID0gMDsKICAgICAgICBzdGFydFRocmVhZCgpOwogICAgICAgIHJldHVybiB0YXNrOwogICAgfTsKCiAgICAvKioKICAgICAqIFN0b3BzIGFuIGV4aXN0aW5nIHJ1bm5pbmcgdGFzay4KICAgICAqIEBtZXRob2Qgc3RvcAogICAgICogQHBhcmFtIHtPYmplY3R9IHRhc2sgVGhlIHRhc2sgdG8gc3RvcAogICAgICogQHJldHVybiB7T2JqZWN0fSBUaGUgdGFzawogICAgICovCiAgICB0aGlzLnN0b3AgPSBmdW5jdGlvbih0YXNrKXsKICAgICAgICByZW1vdmVUYXNrKHRhc2spOwogICAgICAgIHJldHVybiB0YXNrOwogICAgfTsKCiAgICAvKioKICAgICAqIFN0b3BzIGFsbCB0YXNrcyB0aGF0IGFyZSBjdXJyZW50bHkgcnVubmluZy4KICAgICAqIEBtZXRob2Qgc3RvcEFsbAogICAgICovCiAgICB0aGlzLnN0b3BBbGwgPSBmdW5jdGlvbigpewogICAgICAgIHN0b3BUaHJlYWQoKTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSB0YXNrcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGlmKHRhc2tzW2ldLm9uU3RvcCl7CiAgICAgICAgICAgICAgICB0YXNrc1tpXS5vblN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0YXNrcyA9IFtdOwogICAgICAgIHJlbW92ZVF1ZXVlID0gW107CiAgICB9Owp9OwoKLyoqCiAqIEBjbGFzcyBFeHQuVGFza01ncgogKiBAZXh0ZW5kcyBFeHQudXRpbC5UYXNrUnVubmVyCiAqIEEgc3RhdGljIHtAbGluayBFeHQudXRpbC5UYXNrUnVubmVyfSBpbnN0YW5jZSB0aGF0IGNhbiBiZSB1c2VkIHRvIHN0YXJ0IGFuZCBzdG9wIGFyYml0cmFyeSB0YXNrcy4gIFNlZQogKiB7QGxpbmsgRXh0LnV0aWwuVGFza1J1bm5lcn0gZm9yIHN1cHBvcnRlZCBtZXRob2RzIGFuZCB0YXNrIGNvbmZpZyBwcm9wZXJ0aWVzLgogKiA8cHJlPjxjb2RlPgovLyBTdGFydCBhIHNpbXBsZSBjbG9jayB0YXNrIHRoYXQgdXBkYXRlcyBhIGRpdiBvbmNlIHBlciBzZWNvbmQKdmFyIHRhc2sgPSB7CiAgICBydW46IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmZseSgnY2xvY2snKS51cGRhdGUobmV3IERhdGUoKS5mb3JtYXQoJ2c6aTpzIEEnKSk7CiAgICB9LAogICAgaW50ZXJ2YWw6IDEwMDAgLy8xIHNlY29uZAp9CkV4dC5UYXNrTWdyLnN0YXJ0KHRhc2spOwo8L2NvZGU+PC9wcmU+CiAqIDxwPlNlZSB0aGUge0BsaW5rICNzdGFydH0gbWV0aG9kIGZvciBkZXRhaWxzIGFib3V0IGhvdyB0byBjb25maWd1cmUgYSB0YXNrIG9iamVjdC48L3A+CiAqIEBzaW5nbGV0b24KICovCkV4dC5UYXNrTWdyID0gbmV3IEV4dC51dGlsLlRhc2tSdW5uZXIoKTsoZnVuY3Rpb24oKXsKCXZhciBsaWJGbHl3ZWlnaHQ7CgkKCWZ1bmN0aW9uIGZseShlbCkgewogICAgICAgIGlmICghbGliRmx5d2VpZ2h0KSB7CiAgICAgICAgICAgIGxpYkZseXdlaWdodCA9IG5ldyBFeHQuRWxlbWVudC5GbHl3ZWlnaHQoKTsKICAgICAgICB9CiAgICAgICAgbGliRmx5d2VpZ2h0LmRvbSA9IGVsOwogICAgICAgIHJldHVybiBsaWJGbHl3ZWlnaHQ7CiAgICB9CiAgICAKICAgIChmdW5jdGlvbigpewoJdmFyIGRvYyA9IGRvY3VtZW50LAoJCWlzQ1NTMSA9IGRvYy5jb21wYXRNb2RlID09ICJDU1MxQ29tcGF0IiwKCQlNQVggPSBNYXRoLm1heCwJCQogICAgICAgIFJPVU5EID0gTWF0aC5yb3VuZCwKCQlQQVJTRUlOVCA9IHBhcnNlSW50OwoJCQoJRXh0LmxpYi5Eb20gPSB7CgkgICAgaXNBbmNlc3RvciA6IGZ1bmN0aW9uKHAsIGMpIHsKCQkgICAgdmFyIHJldCA9IGZhbHNlOwoJCQkKCQkJcCA9IEV4dC5nZXREb20ocCk7CgkJCWMgPSBFeHQuZ2V0RG9tKGMpOwoJCQlpZiAocCAmJiBjKSB7CgkJCQlpZiAocC5jb250YWlucykgewoJCQkJCXJldHVybiBwLmNvbnRhaW5zKGMpOwoJCQkJfSBlbHNlIGlmIChwLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSB7CgkJCQkJcmV0dXJuICEhKHAuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYykgJiAxNik7CgkJCQl9IGVsc2UgewoJCQkJCXdoaWxlIChjID0gYy5wYXJlbnROb2RlKSB7CgkJCQkJCXJldCA9IGMgPT0gcCB8fCByZXQ7CSAgICAgICAgCQkJCgkJCQkJfQoJCQkJfQkgICAgICAgICAgICAKCQkJfQkKCQkJcmV0dXJuIHJldDsKCQl9LAoJCQogICAgICAgIGdldFZpZXdXaWR0aCA6IGZ1bmN0aW9uKGZ1bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bGwgPyB0aGlzLmdldERvY3VtZW50V2lkdGgoKSA6IHRoaXMuZ2V0Vmlld3BvcnRXaWR0aCgpOwogICAgICAgIH0sCgogICAgICAgIGdldFZpZXdIZWlnaHQgOiBmdW5jdGlvbihmdWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmdWxsID8gdGhpcy5nZXREb2N1bWVudEhlaWdodCgpIDogdGhpcy5nZXRWaWV3cG9ydEhlaWdodCgpOwogICAgICAgIH0sCgogICAgICAgIGdldERvY3VtZW50SGVpZ2h0OiBmdW5jdGlvbigpIHsgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIE1BWCghaXNDU1MxID8gZG9jLmJvZHkuc2Nyb2xsSGVpZ2h0IDogZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxIZWlnaHQsIHRoaXMuZ2V0Vmlld3BvcnRIZWlnaHQoKSk7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0RG9jdW1lbnRXaWR0aDogZnVuY3Rpb24oKSB7ICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBNQVgoIWlzQ1NTMSA/IGRvYy5ib2R5LnNjcm9sbFdpZHRoIDogZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxXaWR0aCwgdGhpcy5nZXRWaWV3cG9ydFdpZHRoKCkpOwogICAgICAgIH0sCgogICAgICAgIGdldFZpZXdwb3J0SGVpZ2h0OiBmdW5jdGlvbigpewoJICAgICAgICByZXR1cm4gRXh0LmlzSUUgPyAKCSAgICAgICAgCSAgIChFeHQuaXNTdHJpY3QgPyBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCA6IGRvYy5ib2R5LmNsaWVudEhlaWdodCkgOgoJICAgICAgICAJICAgc2VsZi5pbm5lckhlaWdodDsKICAgICAgICB9LAoKICAgICAgICBnZXRWaWV3cG9ydFdpZHRoIDogZnVuY3Rpb24oKSB7CgkgICAgICAgIHJldHVybiAhRXh0LmlzU3RyaWN0ICYmICFFeHQuaXNPcGVyYSA/IGRvYy5ib2R5LmNsaWVudFdpZHRoIDoKCSAgICAgICAgCSAgIEV4dC5pc0lFID8gZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCA6IHNlbGYuaW5uZXJXaWR0aDsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIGdldFkgOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRYWShlbClbMV07CiAgICAgICAgfSwKCiAgICAgICAgZ2V0WCA6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFhZKGVsKVswXTsKICAgICAgICB9LAoKICAgICAgICBnZXRYWSA6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHZhciBwLCAKICAgICAgICAgICAgCXBlLCAKICAgICAgICAgICAgCWIsCiAgICAgICAgICAgIAlidCwgCiAgICAgICAgICAgIAlibCwgICAgIAogICAgICAgICAgICAJZGJkLCAgICAgICAJCiAgICAgICAgICAgIAl4ID0gMCwKICAgICAgICAgICAgCXkgPSAwLCAKICAgICAgICAgICAgCXNjcm9sbCwKICAgICAgICAgICAgCWhhc0Fic29sdXRlLCAKICAgICAgICAgICAgCWJkID0gKGRvYy5ib2R5IHx8IGRvYy5kb2N1bWVudEVsZW1lbnQpLAogICAgICAgICAgICAJcmV0ID0gWzAsMF07CiAgICAgICAgICAgIAkKICAgICAgICAgICAgZWwgPSBFeHQuZ2V0RG9tKGVsKTsKCiAgICAgICAgICAgIGlmKGVsICE9IGJkKXsKCSAgICAgICAgICAgIGlmIChlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QpIHsKCSAgICAgICAgICAgICAgICBiID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgkgICAgICAgICAgICAgICAgc2Nyb2xsID0gZmx5KGRvY3VtZW50KS5nZXRTY3JvbGwoKTsKCSAgICAgICAgICAgICAgICByZXQgPSBbUk9VTkQoYi5sZWZ0ICsgc2Nyb2xsLmxlZnQpLCBST1VORChiLnRvcCArIHNjcm9sbC50b3ApXTsKCSAgICAgICAgICAgIH0gZWxzZSB7ICAKCQkgICAgICAgICAgICBwID0gZWw7CQkKCQkgICAgICAgICAgICBoYXNBYnNvbHV0ZSA9IGZseShlbCkuaXNTdHlsZSgicG9zaXRpb24iLCAiYWJzb2x1dGUiKTsKCQkKCQkgICAgICAgICAgICB3aGlsZSAocCkgewoJCQkgICAgICAgICAgICBwZSA9IGZseShwKTsJCQoJCSAgICAgICAgICAgICAgICB4ICs9IHAub2Zmc2V0TGVmdDsKCQkgICAgICAgICAgICAgICAgeSArPSBwLm9mZnNldFRvcDsKCQkKCQkgICAgICAgICAgICAgICAgaGFzQWJzb2x1dGUgPSBoYXNBYnNvbHV0ZSB8fCBwZS5pc1N0eWxlKCJwb3NpdGlvbiIsICJhYnNvbHV0ZSIpOwoJCSAgICAgICAgICAgICAgICAJCQoJCSAgICAgICAgICAgICAgICBpZiAoRXh0LmlzR2Vja28pIHsJCSAgICAgICAgICAgICAgICAgICAgCgkJICAgICAgICAgICAgICAgICAgICB5ICs9IGJ0ID0gUEFSU0VJTlQocGUuZ2V0U3R5bGUoImJvcmRlclRvcFdpZHRoIiksIDEwKSB8fCAwOwoJCSAgICAgICAgICAgICAgICAgICAgeCArPSBibCA9IFBBUlNFSU5UKHBlLmdldFN0eWxlKCJib3JkZXJMZWZ0V2lkdGgiKSwgMTApIHx8IDA7CQoJCQoJCSAgICAgICAgICAgICAgICAgICAgaWYgKHAgIT0gZWwgJiYgIXBlLmlzU3R5bGUoJ292ZXJmbG93JywndmlzaWJsZScpKSB7CgkJICAgICAgICAgICAgICAgICAgICAgICAgeCArPSBibDsKCQkgICAgICAgICAgICAgICAgICAgICAgICB5ICs9IGJ0OwoJCSAgICAgICAgICAgICAgICAgICAgfQoJCSAgICAgICAgICAgICAgICB9CgkJICAgICAgICAgICAgICAgIHAgPSBwLm9mZnNldFBhcmVudDsKCQkgICAgICAgICAgICB9CgkJCgkJICAgICAgICAgICAgaWYgKEV4dC5pc1NhZmFyaSAmJiBoYXNBYnNvbHV0ZSkgewoJCSAgICAgICAgICAgICAgICB4IC09IGJkLm9mZnNldExlZnQ7CgkJICAgICAgICAgICAgICAgIHkgLT0gYmQub2Zmc2V0VG9wOwoJCSAgICAgICAgICAgIH0KCQkKCQkgICAgICAgICAgICBpZiAoRXh0LmlzR2Vja28gJiYgIWhhc0Fic29sdXRlKSB7CgkJICAgICAgICAgICAgICAgIGRiZCA9IGZseShiZCk7CgkJICAgICAgICAgICAgICAgIHggKz0gUEFSU0VJTlQoZGJkLmdldFN0eWxlKCJib3JkZXJMZWZ0V2lkdGgiKSwgMTApIHx8IDA7CgkJICAgICAgICAgICAgICAgIHkgKz0gUEFSU0VJTlQoZGJkLmdldFN0eWxlKCJib3JkZXJUb3BXaWR0aCIpLCAxMCkgfHwgMDsKCQkgICAgICAgICAgICB9CgkJCgkJICAgICAgICAgICAgcCA9IGVsLnBhcmVudE5vZGU7CgkJICAgICAgICAgICAgd2hpbGUgKHAgJiYgcCAhPSBiZCkgewoJCSAgICAgICAgICAgICAgICBpZiAoIUV4dC5pc09wZXJhIHx8IChwLnRhZ05hbWUgIT0gJ1RSJyAmJiAhZmx5KHApLmlzU3R5bGUoImRpc3BsYXkiLCAiaW5saW5lIikpKSB7CgkJICAgICAgICAgICAgICAgICAgICB4IC09IHAuc2Nyb2xsTGVmdDsKCQkgICAgICAgICAgICAgICAgICAgIHkgLT0gcC5zY3JvbGxUb3A7CgkJICAgICAgICAgICAgICAgIH0KCQkgICAgICAgICAgICAgICAgcCA9IHAucGFyZW50Tm9kZTsKCQkgICAgICAgICAgICB9CgkJICAgICAgICAgICAgcmV0ID0gW3gseV07CgkgICAgICAgICAgICB9CiAgICAgICAgIAl9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgc2V0WFkgOiBmdW5jdGlvbihlbCwgeHkpIHsKICAgICAgICAgICAgKGVsID0gRXh0LmZseShlbCwgJ19zZXRYWScpKS5wb3NpdGlvbigpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHB0cyA9IGVsLnRyYW5zbGF0ZVBvaW50cyh4eSksCiAgICAgICAgICAgIAlzdHlsZSA9IGVsLmRvbS5zdHlsZSwKICAgICAgICAgICAgCXBvczsgICAgICAgICAgICAJCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKHBvcyBpbiBwdHMpIHsJICAgICAgICAgICAgCgkgICAgICAgICAgICBpZiAoIWlzTmFOKHB0c1twb3NdKSkgewoJICAgICAgICAgICAgICAgIHN0eWxlW3Bvc10gPSBwdHNbcG9zXSArICJweCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBzZXRYIDogZnVuY3Rpb24oZWwsIHgpIHsKICAgICAgICAgICAgdGhpcy5zZXRYWShlbCwgW3gsIGZhbHNlXSk7CiAgICAgICAgfSwKCiAgICAgICAgc2V0WSA6IGZ1bmN0aW9uKGVsLCB5KSB7CiAgICAgICAgICAgIHRoaXMuc2V0WFkoZWwsIFtmYWxzZSwgeV0pOwogICAgICAgIH0KICAgIH07Cn0pKCk7RXh0LmxpYi5FdmVudCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGxvYWRDb21wbGV0ZSA9IGZhbHNlLAogICAgICAgIHVubG9hZExpc3RlbmVycyA9IHt9LAogICAgICAgIHJldHJ5Q291bnQgPSAwLAogICAgICAgIG9uQXZhaWxTdGFjayA9IFtdLAogICAgICAgIF9pbnRlcnZhbCwKICAgICAgICBsb2NrZWQgPSBmYWxzZSwKICAgICAgICB3aW4gPSB3aW5kb3csCiAgICAgICAgZG9jID0gZG9jdW1lbnQsCgogICAgICAgIC8vIGNvbnN0YW50cwogICAgICAgIFBPTExfUkVUUllTID0gMjAwLAogICAgICAgIFBPTExfSU5URVJWQUwgPSAyMCwKICAgICAgICBUWVBFID0gMCwKICAgICAgICBGTiA9IDEsCiAgICAgICAgT0JKID0gMiwKICAgICAgICBBREpfU0NPUEUgPSAzLAogICAgICAgIFNDUk9MTExFRlQgPSAnc2Nyb2xsTGVmdCcsCiAgICAgICAgU0NST0xMVE9QID0gJ3Njcm9sbFRvcCcsCiAgICAgICAgVU5MT0FEID0gJ3VubG9hZCcsCiAgICAgICAgTU9VU0VPVkVSID0gJ21vdXNlb3ZlcicsCiAgICAgICAgTU9VU0VPVVQgPSAnbW91c2VvdXQnLAogICAgICAgIC8vIHByaXZhdGUKICAgICAgICBkb0FkZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcmV0OwogICAgICAgICAgICBpZiAod2luLmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIHJldCA9IGZ1bmN0aW9uKGVsLCBldmVudE5hbWUsIGZuLCBjYXB0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50TmFtZSA9PSAnbW91c2VlbnRlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm4gPSBmbi5jcmVhdGVJbnRlcmNlcHRvcihjaGVja1JlbGF0ZWRUYXJnZXQpOwogICAgICAgICAgICAgICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKE1PVVNFT1ZFUiwgZm4sIChjYXB0dXJlKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudE5hbWUgPT0gJ21vdXNlbGVhdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuID0gZm4uY3JlYXRlSW50ZXJjZXB0b3IoY2hlY2tSZWxhdGVkVGFyZ2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcihNT1VTRU9VVCwgZm4sIChjYXB0dXJlKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGZuLCAoY2FwdHVyZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgaWYgKHdpbi5hdHRhY2hFdmVudCkgewogICAgICAgICAgICAgICAgcmV0ID0gZnVuY3Rpb24oZWwsIGV2ZW50TmFtZSwgZm4sIGNhcHR1cmUpIHsKICAgICAgICAgICAgICAgICAgICBlbC5hdHRhY2hFdmVudCgib24iICsgZXZlbnROYW1lLCBmbik7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldCA9IGZ1bmN0aW9uKCl7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0oKSwKICAgICAgICAvLyBwcml2YXRlCiAgICAgICAgZG9SZW1vdmUgPSBmdW5jdGlvbigpewogICAgICAgICAgICB2YXIgcmV0OwogICAgICAgICAgICBpZiAod2luLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIHJldCA9IGZ1bmN0aW9uIChlbCwgZXZlbnROYW1lLCBmbiwgY2FwdHVyZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChldmVudE5hbWUgPT0gJ21vdXNlZW50ZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZSA9IE1PVVNFT1ZFUjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50TmFtZSA9PSAnbW91c2VsZWF2ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnROYW1lID0gTU9VU0VPVVQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBmbiwgKGNhcHR1cmUpKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0gZWxzZSBpZiAod2luLmRldGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXQgPSBmdW5jdGlvbiAoZWwsIGV2ZW50TmFtZSwgZm4pIHsKICAgICAgICAgICAgICAgICAgICBlbC5kZXRhY2hFdmVudCgib24iICsgZXZlbnROYW1lLCBmbik7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0ID0gZnVuY3Rpb24oKXt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSgpOwoKICAgIGZ1bmN0aW9uIGNoZWNrUmVsYXRlZFRhcmdldChlKSB7CiAgICAgICAgcmV0dXJuICFlbENvbnRhaW5zKGUuY3VycmVudFRhcmdldCwgcHViLmdldFJlbGF0ZWRUYXJnZXQoZSkpOwogICAgfQoKICAgIGZ1bmN0aW9uIGVsQ29udGFpbnMocGFyZW50LCBjaGlsZCkgewogICAgICAgaWYocGFyZW50ICYmIHBhcmVudC5maXJzdENoaWxkKXsKICAgICAgICAgd2hpbGUoY2hpbGQpIHsKICAgICAgICAgICAgaWYoY2hpbGQgPT09IHBhcmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5wYXJlbnROb2RlOwogICAgICAgICAgICBpZihjaGlsZCAmJiAoY2hpbGQubm9kZVR5cGUgIT0gMSkpIHsKICAgICAgICAgICAgICAgIGNoaWxkID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gcHJpdmF0ZQogICAgZnVuY3Rpb24gX3RyeVByZWxvYWRBdHRhY2goKSB7CiAgICAgICAgdmFyIHJldCA9IGZhbHNlLAogICAgICAgICAgICBub3RBdmFpbCA9IFtdLAogICAgICAgICAgICBlbGVtZW50LCBpLCB2LCBvdmVycmlkZSwKICAgICAgICAgICAgdHJ5QWdhaW4gPSAhbG9hZENvbXBsZXRlIHx8IChyZXRyeUNvdW50ID4gMCk7CgogICAgICAgIGlmKCFsb2NrZWQpewogICAgICAgICAgICBsb2NrZWQgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgb25BdmFpbFN0YWNrLmxlbmd0aDsgKytpKXsKICAgICAgICAgICAgICAgIHYgPSBvbkF2YWlsU3RhY2tbaV07CiAgICAgICAgICAgICAgICBpZih2ICYmIChlbGVtZW50ID0gZG9jLmdldEVsZW1lbnRCeUlkKHYuaWQpKSl7CiAgICAgICAgICAgICAgICAgICAgaWYoIXYuY2hlY2tSZWFkeSB8fCBsb2FkQ29tcGxldGUgfHwgZWxlbWVudC5uZXh0U2libGluZyB8fCAoZG9jICYmIGRvYy5ib2R5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBvdmVycmlkZSA9IHYub3ZlcnJpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBvdmVycmlkZSA/IChvdmVycmlkZSA9PT0gdHJ1ZSA/IHYub2JqIDogb3ZlcnJpZGUpIDogZWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgdi5mbi5jYWxsKGVsZW1lbnQsIHYub2JqKTsKICAgICAgICAgICAgICAgICAgICAgICAgb25BdmFpbFN0YWNrLnJlbW92ZSh2KTsKICAgICAgICAgICAgICAgICAgICAgICAgLS1pOwogICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICBub3RBdmFpbC5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0cnlDb3VudCA9IChub3RBdmFpbC5sZW5ndGggPT09IDApID8gMCA6IHJldHJ5Q291bnQgLSAxOwoKICAgICAgICAgICAgaWYgKHRyeUFnYWluKSB7CiAgICAgICAgICAgICAgICBzdGFydEludGVydmFsKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKF9pbnRlcnZhbCk7CiAgICAgICAgICAgICAgICBfaW50ZXJ2YWwgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldCA9ICEobG9ja2VkID0gZmFsc2UpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIC8vIHByaXZhdGUKICAgIGZ1bmN0aW9uIHN0YXJ0SW50ZXJ2YWwoKSB7CiAgICAgICAgaWYoIV9pbnRlcnZhbCl7CiAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgX3RyeVByZWxvYWRBdHRhY2goKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgX2ludGVydmFsID0gc2V0SW50ZXJ2YWwoY2FsbGJhY2ssIFBPTExfSU5URVJWQUwpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBwcml2YXRlCiAgICBmdW5jdGlvbiBnZXRTY3JvbGwoKSB7CiAgICAgICAgdmFyIGRkID0gZG9jLmRvY3VtZW50RWxlbWVudCwKICAgICAgICAgICAgZGIgPSBkb2MuYm9keTsKICAgICAgICBpZihkZCAmJiAoZGRbU0NST0xMVE9QXSB8fCBkZFtTQ1JPTExMRUZUXSkpewogICAgICAgICAgICByZXR1cm4gW2RkW1NDUk9MTExFRlRdLCBkZFtTQ1JPTExUT1BdXTsKICAgICAgICB9ZWxzZSBpZihkYil7CiAgICAgICAgICAgIHJldHVybiBbZGJbU0NST0xMTEVGVF0sIGRiW1NDUk9MTFRPUF1dOwogICAgICAgIH1lbHNlewogICAgICAgICAgICByZXR1cm4gWzAsIDBdOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBwcml2YXRlCiAgICBmdW5jdGlvbiBnZXRQYWdlQ29vcmQgKGV2LCB4eSkgewogICAgICAgIGV2ID0gZXYuYnJvd3NlckV2ZW50IHx8IGV2OwogICAgICAgIHZhciBjb29yZCAgPSBldlsncGFnZScgKyB4eV07CiAgICAgICAgaWYgKCFjb29yZCAmJiBjb29yZCAhPT0gMCkgewogICAgICAgICAgICBjb29yZCA9IGV2WydjbGllbnQnICsgeHldIHx8IDA7CgogICAgICAgICAgICBpZiAoRXh0LmlzSUUpIHsKICAgICAgICAgICAgICAgIGNvb3JkICs9IGdldFNjcm9sbCgpW3h5ID09ICJYIiA/IDAgOiAxXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNvb3JkOwogICAgfQoKICAgIHZhciBwdWIgPSAgewogICAgICAgIGV4dEFkYXB0ZXI6IHRydWUsCiAgICAgICAgb25BdmFpbGFibGUgOiBmdW5jdGlvbihwX2lkLCBwX2ZuLCBwX29iaiwgcF9vdmVycmlkZSkgewogICAgICAgICAgICBvbkF2YWlsU3RhY2sucHVzaCh7CiAgICAgICAgICAgICAgICBpZDogICAgICAgICBwX2lkLAogICAgICAgICAgICAgICAgZm46ICAgICAgICAgcF9mbiwKICAgICAgICAgICAgICAgIG9iajogICAgICAgIHBfb2JqLAogICAgICAgICAgICAgICAgb3ZlcnJpZGU6ICAgcF9vdmVycmlkZSwKICAgICAgICAgICAgICAgIGNoZWNrUmVhZHk6IGZhbHNlIH0pOwoKICAgICAgICAgICAgcmV0cnlDb3VudCA9IFBPTExfUkVUUllTOwogICAgICAgICAgICBzdGFydEludGVydmFsKCk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gVGhpcyBmdW5jdGlvbiBzaG91bGQgQUxXQVlTIGJlIGNhbGxlZCBmcm9tIEV4dC5FdmVudE1hbmFnZXIKICAgICAgICBhZGRMaXN0ZW5lcjogZnVuY3Rpb24oZWwsIGV2ZW50TmFtZSwgZm4pIHsKICAgICAgICAgICAgZWwgPSBFeHQuZ2V0RG9tKGVsKTsKICAgICAgICAgICAgaWYgKGVsICYmIGZuKSB7CiAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lID09IFVOTE9BRCkgewogICAgICAgICAgICAgICAgICAgIGlmICh1bmxvYWRMaXN0ZW5lcnNbZWwuaWRdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdW5sb2FkTGlzdGVuZXJzW2VsLmlkXSA9IFtdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB1bmxvYWRMaXN0ZW5lcnNbZWwuaWRdLnB1c2goW2V2ZW50TmFtZSwgZm5dKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZG9BZGQoZWwsIGV2ZW50TmFtZSwgZm4sIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgLy8gVGhpcyBmdW5jdGlvbiBzaG91bGQgQUxXQVlTIGJlIGNhbGxlZCBmcm9tIEV4dC5FdmVudE1hbmFnZXIKICAgICAgICByZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24oZWwsIGV2ZW50TmFtZSwgZm4pIHsKICAgICAgICAgICAgZWwgPSBFeHQuZ2V0RG9tKGVsKTsKICAgICAgICAgICAgdmFyIGksIGxlbiwgbGksIGxpczsKICAgICAgICAgICAgaWYgKGVsICYmIGZuKSB7CiAgICAgICAgICAgICAgICBpZihldmVudE5hbWUgPT0gVU5MT0FEKXsKICAgICAgICAgICAgICAgICAgICBpZigobGlzID0gdW5sb2FkTGlzdGVuZXJzW2VsLmlkXSkgIT09IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihpID0gMCwgbGVuID0gbGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKChsaSA9IGxpc1tpXSkgJiYgbGlbVFlQRV0gPT0gZXZlbnROYW1lICYmIGxpW0ZOXSA9PSBmbil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5sb2FkTGlzdGVuZXJzW2VsLmlkXS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZG9SZW1vdmUoZWwsIGV2ZW50TmFtZSwgZm4sIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGdldFRhcmdldCA6IGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgICAgIGV2ID0gZXYuYnJvd3NlckV2ZW50IHx8IGV2OwogICAgICAgICAgICByZXR1cm4gdGhpcy5yZXNvbHZlVGV4dE5vZGUoZXYudGFyZ2V0IHx8IGV2LnNyY0VsZW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIHJlc29sdmVUZXh0Tm9kZSA6IEV4dC5pc0dlY2tvID8gZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgIGlmKCFub2RlKXsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyB3b3JrIGFyb3VuZCBmaXJlZm94IGJ1ZywgaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9MTAxMTk3CiAgICAgICAgICAgIHZhciBzID0gSFRNTEVsZW1lbnQucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobm9kZSk7CiAgICAgICAgICAgIGlmKHMgPT0gJ1t4cGNvbm5lY3Qgd3JhcHBlZCBuYXRpdmUgcHJvdG90eXBlXScgfHwgcyA9PSAnW29iamVjdCBYVUxFbGVtZW50XScpewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09IDMgPyBub2RlLnBhcmVudE5vZGUgOiBub2RlOwogICAgICAgIH0gOiBmdW5jdGlvbihub2RlKXsKICAgICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5ub2RlVHlwZSA9PSAzID8gbm9kZS5wYXJlbnROb2RlIDogbm9kZTsKICAgICAgICB9LAoKICAgICAgICBnZXRSZWxhdGVkVGFyZ2V0IDogZnVuY3Rpb24oZXYpIHsKICAgICAgICAgICAgZXYgPSBldi5icm93c2VyRXZlbnQgfHwgZXY7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc29sdmVUZXh0Tm9kZShldi5yZWxhdGVkVGFyZ2V0IHx8CiAgICAgICAgICAgICAgICAoLyhtb3VzZW91dHxtb3VzZWxlYXZlKS8udGVzdChldi50eXBlKSA/IGV2LnRvRWxlbWVudCA6CiAgICAgICAgICAgICAgICAgLyhtb3VzZW92ZXJ8bW91c2VlbnRlcikvLnRlc3QoZXYudHlwZSkgPyBldi5mcm9tRWxlbWVudCA6IG51bGwpKTsKICAgICAgICB9LAoKICAgICAgICBnZXRQYWdlWCA6IGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgICAgIHJldHVybiBnZXRQYWdlQ29vcmQoZXYsICJYIik7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0UGFnZVkgOiBmdW5jdGlvbihldikgewogICAgICAgICAgICByZXR1cm4gZ2V0UGFnZUNvb3JkKGV2LCAiWSIpOwogICAgICAgIH0sCgoKICAgICAgICBnZXRYWSA6IGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgICAgIHJldHVybiBbdGhpcy5nZXRQYWdlWChldiksIHRoaXMuZ2V0UGFnZVkoZXYpXTsKICAgICAgICB9LAoKICAgICAgICBzdG9wRXZlbnQgOiBmdW5jdGlvbihldikgewogICAgICAgICAgICB0aGlzLnN0b3BQcm9wYWdhdGlvbihldik7CiAgICAgICAgICAgIHRoaXMucHJldmVudERlZmF1bHQoZXYpOwogICAgICAgIH0sCgogICAgICAgIHN0b3BQcm9wYWdhdGlvbiA6IGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgICAgIGV2ID0gZXYuYnJvd3NlckV2ZW50IHx8IGV2OwogICAgICAgICAgICBpZiAoZXYuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV2LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBwcmV2ZW50RGVmYXVsdCA6IGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgICAgIGV2ID0gZXYuYnJvd3NlckV2ZW50IHx8IGV2OwogICAgICAgICAgICBpZiAoZXYucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoZXYua2V5Q29kZSkgewogICAgICAgICAgICAgICAgICAgIGV2LmtleUNvZGUgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXYucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGdldEV2ZW50IDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBlID0gZSB8fCB3aW4uZXZlbnQ7CiAgICAgICAgICAgIGlmICghZSkgewogICAgICAgICAgICAgICAgdmFyIGMgPSB0aGlzLmdldEV2ZW50LmNhbGxlcjsKICAgICAgICAgICAgICAgIHdoaWxlIChjKSB7CiAgICAgICAgICAgICAgICAgICAgZSA9IGMuYXJndW1lbnRzWzBdOwogICAgICAgICAgICAgICAgICAgIGlmIChlICYmIEV2ZW50ID09IGUuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGMgPSBjLmNhbGxlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZTsKICAgICAgICB9LAoKICAgICAgICBnZXRDaGFyQ29kZSA6IGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgICAgIGV2ID0gZXYuYnJvd3NlckV2ZW50IHx8IGV2OwogICAgICAgICAgICByZXR1cm4gZXYuY2hhckNvZGUgfHwgZXYua2V5Q29kZSB8fCAwOwogICAgICAgIH0sCgogICAgICAgIC8vY2xlYXJDYWNoZTogZnVuY3Rpb24oKSB7fSwKICAgICAgICAvLyBkZXByZWNhdGVkLCBjYWxsIGZyb20gRXZlbnRNYW5hZ2VyCiAgICAgICAgZ2V0TGlzdGVuZXJzIDogZnVuY3Rpb24oZWwsIGV2ZW50TmFtZSkgewogICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLmdldExpc3RlbmVycyhlbCwgZXZlbnROYW1lKTsKICAgICAgICB9LAoKICAgICAgICAvLyBkZXByZWNhdGVkLCBjYWxsIGZyb20gRXZlbnRNYW5hZ2VyCiAgICAgICAgcHVyZ2VFbGVtZW50IDogZnVuY3Rpb24oZWwsIHJlY3Vyc2UsIGV2ZW50TmFtZSkgewogICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLnB1cmdlRWxlbWVudChlbCwgcmVjdXJzZSwgZXZlbnROYW1lKTsKICAgICAgICB9LAoKICAgICAgICBfbG9hZCA6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgbG9hZENvbXBsZXRlID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChFeHQuaXNJRSAmJiBlICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAvLyBJRTggY29tcGxhaW5zIHRoYXQgX2xvYWQgaXMgbnVsbCBvciBub3QgYW4gb2JqZWN0CiAgICAgICAgICAgICAgICAvLyBzbyBsZXRzIHJlbW92ZSBzZWxmIHZpYSBhcmd1bWVudHMuY2FsbGVlCiAgICAgICAgICAgICAgICBkb1JlbW92ZSh3aW4sICJsb2FkIiwgYXJndW1lbnRzLmNhbGxlZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBfdW5sb2FkIDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgdmFyIEVVID0gRXh0LmxpYi5FdmVudCwKICAgICAgICAgICAgICAgIGksIHYsIHVsLCBpZCwgbGVuLCBzY29wZTsKCiAgICAgICAgICAgIGZvciAoaWQgaW4gdW5sb2FkTGlzdGVuZXJzKSB7CiAgICAgICAgICAgICAgICB1bCA9IHVubG9hZExpc3RlbmVyc1tpZF07CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSB1bC5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHYgPSB1bFtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHZbQURKX1NDT1BFXSA/ICh2W0FESl9TQ09QRV0gPT09IHRydWUgPyB2W09CSl0gOiB2W0FESl9TQ09QRV0pIDogIHdpbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZbRk5dLmNhbGwoc2NvcGUsIEVVLmdldEV2ZW50KGUpLCB2W09CSl0pOwogICAgICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZXgpe30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLl91bmxvYWQoKTsKCiAgICAgICAgICAgIGRvUmVtb3ZlKHdpbiwgVU5MT0FELCBFVS5fdW5sb2FkKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIEluaXRpYWxpemUgc3R1ZmYuCiAgICBwdWIub24gPSBwdWIuYWRkTGlzdGVuZXI7CiAgICBwdWIudW4gPSBwdWIucmVtb3ZlTGlzdGVuZXI7CiAgICBpZiAoZG9jICYmIGRvYy5ib2R5KSB7CiAgICAgICAgcHViLl9sb2FkKHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgICBkb0FkZCh3aW4sICJsb2FkIiwgcHViLl9sb2FkKTsKICAgIH0KICAgIGRvQWRkKHdpbiwgVU5MT0FELCBwdWIuX3VubG9hZCk7CiAgICBfdHJ5UHJlbG9hZEF0dGFjaCgpOwoKICAgIHJldHVybiBwdWI7Cn0oKTsKLyoKKiBQb3J0aW9ucyBvZiB0aGlzIGZpbGUgYXJlIGJhc2VkIG9uIHBpZWNlcyBvZiBZYWhvbyBVc2VyIEludGVyZmFjZSBMaWJyYXJ5CiogQ29weXJpZ2h0IChjKSAyMDA3LCBZYWhvbyEgSW5jLiBBbGwgcmlnaHRzIHJlc2VydmVkLgoqIFlVSSBsaWNlbnNlZCB1bmRlciB0aGUgQlNEIExpY2Vuc2U6CiogaHR0cDovL2RldmVsb3Blci55YWhvby5uZXQveXVpL2xpY2Vuc2UudHh0CiovCkV4dC5saWIuQWpheCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGFjdGl2ZVggPSBbJ01zeG1sMi5YTUxIVFRQLjYuMCcsCiAgICAgICAgICAgICAgICAgICAnTXN4bWwyLlhNTEhUVFAuMy4wJywKICAgICAgICAgICAgICAgICAgICdNc3htbDIuWE1MSFRUUCddLAogICAgICAgIENPTlRFTlRUWVBFID0gJ0NvbnRlbnQtVHlwZSc7CgogICAgLy8gcHJpdmF0ZQogICAgZnVuY3Rpb24gc2V0SGVhZGVyKG8pIHsKICAgICAgICB2YXIgY29ubiA9IG8uY29ubiwKICAgICAgICAgICAgcHJvcCwKICAgICAgICAgICAgaGVhZGVycyA9IHt9OwoKICAgICAgICBmdW5jdGlvbiBzZXRUaGVIZWFkZXJzKGNvbm4sIGhlYWRlcnMpewogICAgICAgICAgICBmb3IgKHByb3AgaW4gaGVhZGVycykgewogICAgICAgICAgICAgICAgaWYgKGhlYWRlcnMuaGFzT3duUHJvcGVydHkocHJvcCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25uLnNldFJlcXVlc3RIZWFkZXIocHJvcCwgaGVhZGVyc1twcm9wXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIEV4dC5hcHBseShoZWFkZXJzLCBwdWIuaGVhZGVycywgcHViLmRlZmF1bHRIZWFkZXJzKTsKICAgICAgICBzZXRUaGVIZWFkZXJzKGNvbm4sIGhlYWRlcnMpOwogICAgICAgIGRlbGV0ZSBwdWIuaGVhZGVyczsKICAgIH0KCiAgICAvLyBwcml2YXRlCiAgICBmdW5jdGlvbiBjcmVhdGVFeGNlcHRpb25PYmplY3QodElkLCBjYWxsYmFja0FyZywgaXNBYm9ydCwgaXNUaW1lb3V0LCBodHRwU3RhdHVzKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdElkIDogdElkLAogICAgICAgICAgICBzdGF0dXMgOiBpc0Fib3J0ID8gLTEgOiAwLAogICAgICAgICAgICBzdGF0dXNUZXh0IDogaXNBYm9ydCA/ICd0cmFuc2FjdGlvbiBhYm9ydGVkJyA6ICgnY29tbXVuaWNhdGlvbiBmYWlsdXJlLCBodHRwU3RhdHVzPScgKyBodHRwU3RhdHVzKSwKICAgICAgICAgICAgaXNBYm9ydDogaXNBYm9ydCwKICAgICAgICAgICAgaXNUaW1lb3V0OiBpc1RpbWVvdXQsCiAgICAgICAgICAgIGFyZ3VtZW50IDogY2FsbGJhY2tBcmcKICAgICAgICB9OwogICAgfQoKICAgIC8vIHByaXZhdGUKICAgIGZ1bmN0aW9uIGluaXRIZWFkZXIobGFiZWwsIHZhbHVlKSB7CiAgICAgICAgKHB1Yi5oZWFkZXJzID0gcHViLmhlYWRlcnMgfHwge30pW2xhYmVsXSA9IHZhbHVlOwogICAgfQoKICAgIC8vIHByaXZhdGUKICAgIGZ1bmN0aW9uIGNyZWF0ZVJlc3BvbnNlT2JqZWN0KG8sIGNhbGxiYWNrQXJnKSB7CiAgICAgICAgdmFyIGhlYWRlck9iaiA9IHt9LAogICAgICAgICAgICBoZWFkZXJTdHIsCiAgICAgICAgICAgIGNvbm4gPSBvLmNvbm4sCiAgICAgICAgICAgIHQsCiAgICAgICAgICAgIHMsCiAgICAgICAgICAgIC8vIHNlZTogaHR0cHM6Ly9wcm90b3R5cGUubGlnaHRob3VzZWFwcC5jb20vcHJvamVjdHMvODg4Ni90aWNrZXRzLzEyOS1pZS1tYW5nbGVzLWh0dHAtcmVzcG9uc2Utc3RhdHVzLWNvZGUtMjA0LXRvLTEyMjMKICAgICAgICAgICAgaXNCcm9rZW5TdGF0dXMgPSBjb25uLnN0YXR1cyA9PSAxMjIzOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBoZWFkZXJTdHIgPSBvLmNvbm4uZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CiAgICAgICAgICAgIEV4dC5lYWNoKGhlYWRlclN0ci5yZXBsYWNlKC9cclxuL2csICdcbicpLnNwbGl0KCdcbicpLCBmdW5jdGlvbih2KXsKICAgICAgICAgICAgICAgIHQgPSB2LmluZGV4T2YoJzonKTsKICAgICAgICAgICAgICAgIGlmKHQgPj0gMCl7CiAgICAgICAgICAgICAgICAgICAgcyA9IHYuc3Vic3RyKDAsIHQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYodi5jaGFyQXQodCArIDEpID09ICcgJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICsrdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGVhZGVyT2JqW3NdID0gdi5zdWJzdHIodCArIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9IGNhdGNoKGUpIHt9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHRJZCA6IG8udElkLAogICAgICAgICAgICAvLyBOb3JtYWxpemUgdGhlIHN0YXR1cyBhbmQgc3RhdHVzVGV4dCB3aGVuIElFIHJldHVybnMgMTIyMywgc2VlIHRoZSBhYm92ZSBsaW5rLgogICAgICAgICAgICBzdGF0dXMgOiBpc0Jyb2tlblN0YXR1cyA/IDIwNCA6IGNvbm4uc3RhdHVzLAogICAgICAgICAgICBzdGF0dXNUZXh0IDogaXNCcm9rZW5TdGF0dXMgPyAnTm8gQ29udGVudCcgOiBjb25uLnN0YXR1c1RleHQsCiAgICAgICAgICAgIGdldFJlc3BvbnNlSGVhZGVyIDogZnVuY3Rpb24oaGVhZGVyKXtyZXR1cm4gaGVhZGVyT2JqW2hlYWRlci50b0xvd2VyQ2FzZSgpXTt9LAogICAgICAgICAgICBnZXRBbGxSZXNwb25zZUhlYWRlcnMgOiBmdW5jdGlvbigpe3JldHVybiBoZWFkZXJTdHI7fSwKICAgICAgICAgICAgcmVzcG9uc2VUZXh0IDogY29ubi5yZXNwb25zZVRleHQsCiAgICAgICAgICAgIHJlc3BvbnNlWE1MIDogY29ubi5yZXNwb25zZVhNTCwKICAgICAgICAgICAgYXJndW1lbnQgOiBjYWxsYmFja0FyZwogICAgICAgIH07CiAgICB9CgogICAgLy8gcHJpdmF0ZQogICAgZnVuY3Rpb24gcmVsZWFzZU9iamVjdChvKSB7CiAgICAgICAgaWYgKG8udElkKSB7CiAgICAgICAgICAgIHB1Yi5jb25uW28udElkXSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIG8uY29ubiA9IG51bGw7CiAgICAgICAgbyA9IG51bGw7CiAgICB9CgogICAgLy8gcHJpdmF0ZQogICAgZnVuY3Rpb24gaGFuZGxlVHJhbnNhY3Rpb25SZXNwb25zZShvLCBjYWxsYmFjaywgaXNBYm9ydCwgaXNUaW1lb3V0KSB7CiAgICAgICAgaWYgKCFjYWxsYmFjaykgewogICAgICAgICAgICByZWxlYXNlT2JqZWN0KG8pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgaHR0cFN0YXR1cywgcmVzcG9uc2VPYmplY3Q7CgogICAgICAgIHRyeSB7CiAgICAgICAgCWlmICghbykgewogICAgICAgIAkJaHR0cFN0YXR1cyA9IDEzMDMwNDsKICAgICAgICAJfSBlbHNlIGlmKCFvLmNvbm4pIHsKICAgICAgICAJCWh0dHBTdGF0dXMgPSAxMzAzMDU7CiAgICAgICAgCQkvL2RvY3VtZW50LmJvZHkuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gIiMwMDAiOyAvLyB2aXN1YWxpemUgdGhlIGVycm9yIGluIHRoZSBJbnN1cmFuY2UgV2ViIEFwcAogICAgICAgIAkJcmV0dXJuOyAvLyBpZ25vcmUgdGhpcyBJRT8gZXJyb3IKICAgICAgICAJfSBlbHNlIGlmIChvLmNvbm4uc3RhdHVzICE9PSB1bmRlZmluZWQgJiYgby5jb25uLnN0YXR1cyAhPSAwKSB7CiAgICAgICAgICAgICAgICBodHRwU3RhdHVzID0gby5jb25uLnN0YXR1czsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgCWlmIChvLmNvbm4uc3RhdHVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgCQlodHRwU3RhdHVzID0gMTMwMzAxOwkKICAgICAgICAgICAgCX0gZWxzZSB7CiAgICAgICAgICAgIAkJaHR0cFN0YXR1cyA9IDEzMDMwMzsKICAgICAgICAgICAgCX0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoKGUpIHsKICAgICAgICAgICAgaHR0cFN0YXR1cyA9IDEzMDMwMjsKICAgICAgICB9CgogICAgICAgIGlmICgoaHR0cFN0YXR1cyA+PSAyMDAgJiYgaHR0cFN0YXR1cyA8IDMwMCkgfHwgKEV4dC5pc0lFICYmIGh0dHBTdGF0dXMgPT0gMTIyMykpIHsKICAgICAgICAgICAgcmVzcG9uc2VPYmplY3QgPSBjcmVhdGVSZXNwb25zZU9iamVjdChvLCBjYWxsYmFjay5hcmd1bWVudCk7CiAgICAgICAgICAgIGlmIChjYWxsYmFjay5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBpZiAoIWNhbGxiYWNrLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suc3VjY2VzcyhyZXNwb25zZU9iamVjdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5zdWNjZXNzLmFwcGx5KGNhbGxiYWNrLnNjb3BlLCBbcmVzcG9uc2VPYmplY3RdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgc3dpdGNoIChodHRwU3RhdHVzKSB7CiAgICAgICAgICAgICAgICBjYXNlIDEyMDAyOgogICAgICAgICAgICAgICAgY2FzZSAxMjAyOToKICAgICAgICAgICAgICAgIGNhc2UgMTIwMzA6CiAgICAgICAgICAgICAgICBjYXNlIDEyMDMxOgogICAgICAgICAgICAgICAgY2FzZSAxMjE1MjoKICAgICAgICAgICAgICAgIGNhc2UgMTMwMzA6CiAgICAgICAgICAgICAgICBjYXNlIDEzMDMwMToKICAgICAgICAgICAgICAgIGNhc2UgMTMwMzAyOgogICAgICAgICAgICAgICAgY2FzZSAxMzAzMDM6CiAgICAgICAgICAgICAgICBjYXNlIDEzMDMwNDoKICAgICAgICAgICAgICAgIGNhc2UgMTMwMzA1OgogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gY3JlYXRlRXhjZXB0aW9uT2JqZWN0KG8udElkLCBjYWxsYmFjay5hcmd1bWVudCwgKGlzQWJvcnQgPyBpc0Fib3J0IDogZmFsc2UpLCBpc1RpbWVvdXQsIGh0dHBTdGF0dXMpOwogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjay5mYWlsdXJlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY2FsbGJhY2suc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmZhaWx1cmUocmVzcG9uc2VPYmplY3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suZmFpbHVyZS5hcHBseShjYWxsYmFjay5zY29wZSwgW3Jlc3BvbnNlT2JqZWN0XSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gY3JlYXRlUmVzcG9uc2VPYmplY3QobywgY2FsbGJhY2suYXJndW1lbnQpOwogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjay5mYWlsdXJlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY2FsbGJhY2suc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmZhaWx1cmUocmVzcG9uc2VPYmplY3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suZmFpbHVyZS5hcHBseShjYWxsYmFjay5zY29wZSwgW3Jlc3BvbnNlT2JqZWN0XSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJlbGVhc2VPYmplY3Qobyk7CiAgICAgICAgcmVzcG9uc2VPYmplY3QgPSBudWxsOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBjaGVja1Jlc3BvbnNlKG8sIGNhbGxiYWNrLCBjb25uLCB0SWQsIHBvbGwsIGNiVGltZW91dCl7CiAgICAgICAgaWYgKGNvbm4gJiYgY29ubi5yZWFkeVN0YXRlID09IDQpIHsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChwb2xsW3RJZF0pOwogICAgICAgICAgICBwb2xsW3RJZF0gPSBudWxsOwoKICAgICAgICAgICAgaWYgKGNiVGltZW91dCkgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHB1Yi50aW1lb3V0W3RJZF0pOwogICAgICAgICAgICAgICAgcHViLnRpbWVvdXRbdElkXSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGFuZGxlVHJhbnNhY3Rpb25SZXNwb25zZShvLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgfQogICAgCiAgICBmdW5jdGlvbiBjaGVja1RpbWVvdXQobywgY2FsbGJhY2spewogICAgICAgIHB1Yi5hYm9ydChvLCBjYWxsYmFjaywgdHJ1ZSk7CiAgICB9CiAgICAKCiAgICAvLyBwcml2YXRlCiAgICBmdW5jdGlvbiBoYW5kbGVSZWFkeVN0YXRlKG8sIGNhbGxiYWNrKXsKICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IHt9OwogICAgICAgIHZhciBjb25uID0gby5jb25uLAogICAgICAgICAgICB0SWQgPSBvLnRJZCwKICAgICAgICAgICAgcG9sbCA9IHB1Yi5wb2xsLAogICAgICAgICAgICBjYlRpbWVvdXQgPSBjYWxsYmFjay50aW1lb3V0IHx8IG51bGw7CgogICAgICAgIGlmIChjYlRpbWVvdXQpIHsKICAgICAgICAgICAgcHViLmNvbm5bdElkXSA9IGNvbm47CiAgICAgICAgICAgIHB1Yi50aW1lb3V0W3RJZF0gPSBzZXRUaW1lb3V0KGNoZWNrVGltZW91dC5jcmVhdGVDYWxsYmFjayhvLCBjYWxsYmFjayksIGNiVGltZW91dCk7CiAgICAgICAgfQogICAgICAgIHBvbGxbdElkXSA9IHNldEludGVydmFsKGNoZWNrUmVzcG9uc2UuY3JlYXRlQ2FsbGJhY2sobywgY2FsbGJhY2ssIGNvbm4sIHRJZCwgcG9sbCwgY2JUaW1lb3V0KSwgcHViLnBvbGxJbnRlcnZhbCk7CiAgICB9CgogICAgLy8gcHJpdmF0ZQogICAgZnVuY3Rpb24gYXN5bmNSZXF1ZXN0KG1ldGhvZCwgdXJpLCBjYWxsYmFjaywgcG9zdERhdGEpIHsKICAgICAgICB2YXIgbyA9IGdldENvbm5lY3Rpb25PYmplY3QoKSB8fCBudWxsOwoKICAgICAgICBpZiAobykgewogICAgICAgICAgICBvLmNvbm4ub3BlbihtZXRob2QsIHVyaSwgdHJ1ZSk7CgogICAgICAgICAgICBpZiAocHViLnVzZURlZmF1bHRYaHJIZWFkZXIpIHsKICAgICAgICAgICAgICAgIGluaXRIZWFkZXIoJ1gtUmVxdWVzdGVkLVdpdGgnLCBwdWIuZGVmYXVsdFhockhlYWRlcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKHBvc3REYXRhICYmIHB1Yi51c2VEZWZhdWx0SGVhZGVyICYmICghcHViLmhlYWRlcnMgfHwgIXB1Yi5oZWFkZXJzW0NPTlRFTlRUWVBFXSkpewogICAgICAgICAgICAgICAgaW5pdEhlYWRlcihDT05URU5UVFlQRSwgcHViLmRlZmF1bHRQb3N0SGVhZGVyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHB1Yi5kZWZhdWx0SGVhZGVycyB8fCBwdWIuaGVhZGVycykgewogICAgICAgICAgICAgICAgc2V0SGVhZGVyKG8pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBoYW5kbGVSZWFkeVN0YXRlKG8sIGNhbGxiYWNrKTsKICAgICAgICAgICAgby5jb25uLnNlbmQocG9zdERhdGEgfHwgbnVsbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvOwogICAgfQoKICAgIC8vIHByaXZhdGUKICAgIGZ1bmN0aW9uIGdldENvbm5lY3Rpb25PYmplY3QoKSB7CiAgICAgICAgdmFyIG87CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChvID0gY3JlYXRlWGhyT2JqZWN0KHB1Yi50cmFuc2FjdGlvbklkKSkgewogICAgICAgICAgICAgICAgcHViLnRyYW5zYWN0aW9uSWQrKzsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBwcml2YXRlCiAgICBmdW5jdGlvbiBjcmVhdGVYaHJPYmplY3QodHJhbnNhY3Rpb25JZCkgewogICAgICAgIHZhciBodHRwOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBodHRwID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBFeHQuaXNJRTYgPyAxIDogMDsgaSA8IGFjdGl2ZVgubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaHR0cCA9IG5ldyBBY3RpdmVYT2JqZWN0KGFjdGl2ZVhbaV0pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICAgICAgICB9CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmV0dXJuIHtjb25uIDogaHR0cCwgdElkIDogdHJhbnNhY3Rpb25JZH07CiAgICAgICAgfQogICAgfQoKICAgIHZhciBwdWIgPSB7CiAgICAgICAgcmVxdWVzdCA6IGZ1bmN0aW9uKG1ldGhvZCwgdXJpLCBjYiwgZGF0YSwgb3B0aW9ucykgewogICAgICAgICAgICBpZihvcHRpb25zKXsKICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgeG1sRGF0YSA9IG9wdGlvbnMueG1sRGF0YSwKICAgICAgICAgICAgICAgICAgICBqc29uRGF0YSA9IG9wdGlvbnMuanNvbkRhdGEsCiAgICAgICAgICAgICAgICAgICAgaHM7CgogICAgICAgICAgICAgICAgRXh0LmFwcGx5SWYobWUsIG9wdGlvbnMpOwoKICAgICAgICAgICAgICAgIGlmKHhtbERhdGEgfHwganNvbkRhdGEpewogICAgICAgICAgICAgICAgICAgIGhzID0gbWUuaGVhZGVyczsKICAgICAgICAgICAgICAgICAgICBpZighaHMgfHwgIWhzW0NPTlRFTlRUWVBFXSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRIZWFkZXIoQ09OVEVOVFRZUEUsIHhtbERhdGEgPyAndGV4dC94bWwnIDogJ2FwcGxpY2F0aW9uL2pzb24nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IHhtbERhdGEgfHwgKCFFeHQuaXNQcmltaXRpdmUoanNvbkRhdGEpID8gRXh0LmVuY29kZShqc29uRGF0YSkgOiBqc29uRGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzeW5jUmVxdWVzdChtZXRob2QgfHwgb3B0aW9ucy5tZXRob2QgfHwgIlBPU1QiLCB1cmksIGNiLCBkYXRhKTsKICAgICAgICB9LAoKICAgICAgICBzZXJpYWxpemVGb3JtIDogZnVuY3Rpb24oZm9ybSkgewogICAgICAgICAgICB2YXIgZkVsZW1lbnRzID0gZm9ybS5lbGVtZW50cyB8fCAoZG9jdW1lbnQuZm9ybXNbZm9ybV0gfHwgRXh0LmdldERvbShmb3JtKSkuZWxlbWVudHMsIAogICAgICAgICAgICAgICAgaGFzU3VibWl0ID0gZmFsc2UsIAogICAgICAgICAgICAgICAgZW5jb2RlciA9IGVuY29kZVVSSUNvbXBvbmVudCwgCiAgICAgICAgICAgICAgICBuYW1lLCAKICAgICAgICAgICAgICAgIGRhdGEgPSAnJywgCiAgICAgICAgICAgICAgICB0eXBlLCAKICAgICAgICAgICAgICAgIGhhc1ZhbHVlOwogICAgCiAgICAgICAgICAgIEV4dC5lYWNoKGZFbGVtZW50cywgZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgICAgICAgICAgICBuYW1lID0gZWxlbWVudC5uYW1lOwogICAgICAgICAgICAgICAgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghZWxlbWVudC5kaXNhYmxlZCAmJiBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKC9zZWxlY3QtKG9uZXxtdWx0aXBsZSkvaS50ZXN0KHR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEV4dC5lYWNoKGVsZW1lbnQub3B0aW9ucywgZnVuY3Rpb24ob3B0KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHQuc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNWYWx1ZSA9IG9wdC5oYXNBdHRyaWJ1dGUgPyBvcHQuaGFzQXR0cmlidXRlKCd2YWx1ZScpIDogb3B0LmdldEF0dHJpYnV0ZU5vZGUoJ3ZhbHVlJykuc3BlY2lmaWVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gU3RyaW5nLmZvcm1hdCgiezB9PXsxfSYiLCBlbmNvZGVyKG5hbWUpLCBlbmNvZGVyKGhhc1ZhbHVlID8gb3B0LnZhbHVlIDogb3B0LnRleHQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghKC9maWxlfHVuZGVmaW5lZHxyZXNldHxidXR0b24vaS50ZXN0KHR5cGUpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISgvcmFkaW98Y2hlY2tib3gvaS50ZXN0KHR5cGUpICYmICFlbGVtZW50LmNoZWNrZWQpICYmICEodHlwZSA9PSAnc3VibWl0JyAmJiBoYXNTdWJtaXQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhICs9IGVuY29kZXIobmFtZSkgKyAnPScgKyBlbmNvZGVyKGVsZW1lbnQudmFsdWUpICsgJyYnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzU3VibWl0ID0gL3N1Ym1pdC9pLnRlc3QodHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gZGF0YS5zdWJzdHIoMCwgZGF0YS5sZW5ndGggLSAxKTsKICAgICAgICB9LAoKICAgICAgICB1c2VEZWZhdWx0SGVhZGVyIDogdHJ1ZSwKICAgICAgICBkZWZhdWx0UG9zdEhlYWRlciA6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgnLAogICAgICAgIHVzZURlZmF1bHRYaHJIZWFkZXIgOiB0cnVlLAogICAgICAgIGRlZmF1bHRYaHJIZWFkZXIgOiAnWE1MSHR0cFJlcXVlc3QnLAogICAgICAgIHBvbGwgOiB7fSwKICAgICAgICB0aW1lb3V0IDoge30sCiAgICAgICAgY29ubjoge30sCiAgICAgICAgcG9sbEludGVydmFsIDogNTAsCiAgICAgICAgdHJhbnNhY3Rpb25JZCA6IDAsCgovLyAgVGhpcyBpcyBuZXZlciBjYWxsZWQgLSBJcyBpdCB3b3J0aCBleHBvc2luZyB0aGlzPwovLyAgICAgICAgICBzZXRQcm9nSWQgOiBmdW5jdGlvbihpZCkgewovLyAgICAgICAgICAgICAgYWN0aXZlWC51bnNoaWZ0KGlkKTsKLy8gICAgICAgICAgfSwKCi8vICBUaGlzIGlzIG5ldmVyIGNhbGxlZCAtIElzIGl0IHdvcnRoIGV4cG9zaW5nIHRoaXM/Ci8vICAgICAgICAgIHNldERlZmF1bHRQb3N0SGVhZGVyIDogZnVuY3Rpb24oYikgewovLyAgICAgICAgICAgICAgdGhpcy51c2VEZWZhdWx0SGVhZGVyID0gYjsKLy8gICAgICAgICAgfSwKCi8vICBUaGlzIGlzIG5ldmVyIGNhbGxlZCAtIElzIGl0IHdvcnRoIGV4cG9zaW5nIHRoaXM/Ci8vICAgICAgICAgIHNldERlZmF1bHRYaHJIZWFkZXIgOiBmdW5jdGlvbihiKSB7Ci8vICAgICAgICAgICAgICB0aGlzLnVzZURlZmF1bHRYaHJIZWFkZXIgPSBiOwovLyAgICAgICAgICB9LAoKLy8gIFRoaXMgaXMgbmV2ZXIgY2FsbGVkIC0gSXMgaXQgd29ydGggZXhwb3NpbmcgdGhpcz8KLy8gICAgICAgICAgc2V0UG9sbGluZ0ludGVydmFsIDogZnVuY3Rpb24oaSkgewovLyAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpID09ICdudW1iZXInICYmIGlzRmluaXRlKGkpKSB7Ci8vICAgICAgICAgICAgICAgICAgdGhpcy5wb2xsSW50ZXJ2YWwgPSBpOwovLyAgICAgICAgICAgICAgfQovLyAgICAgICAgICB9LAoKLy8gIFRoaXMgaXMgbmV2ZXIgY2FsbGVkIC0gSXMgaXQgd29ydGggZXhwb3NpbmcgdGhpcz8KLy8gICAgICAgICAgcmVzZXREZWZhdWx0SGVhZGVycyA6IGZ1bmN0aW9uKCkgewovLyAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0SGVhZGVycyA9IG51bGw7Ci8vICAgICAgICAgIH0sCgogICAgICAgIGFib3J0IDogZnVuY3Rpb24obywgY2FsbGJhY2ssIGlzVGltZW91dCkgewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgdElkID0gby50SWQsCiAgICAgICAgICAgICAgICBpc0Fib3J0ID0gZmFsc2U7CgogICAgICAgICAgICBpZiAobWUuaXNDYWxsSW5Qcm9ncmVzcyhvKSkgewogICAgICAgICAgICAgICAgby5jb25uLmFib3J0KCk7CiAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKG1lLnBvbGxbdElkXSk7CiAgICAgICAgICAgICAgICBtZS5wb2xsW3RJZF0gPSBudWxsOwogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHB1Yi50aW1lb3V0W3RJZF0pOwogICAgICAgICAgICAgICAgbWUudGltZW91dFt0SWRdID0gbnVsbDsKCiAgICAgICAgICAgICAgICBoYW5kbGVUcmFuc2FjdGlvblJlc3BvbnNlKG8sIGNhbGxiYWNrLCAoaXNBYm9ydCA9IHRydWUpLCBpc1RpbWVvdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc0Fib3J0OwogICAgICAgIH0sCgogICAgICAgIGlzQ2FsbEluUHJvZ3Jlc3MgOiBmdW5jdGlvbihvKSB7CiAgICAgICAgICAgIC8vIGlmIHRoZXJlIGlzIGEgY29ubmVjdGlvbiBhbmQgcmVhZHlTdGF0ZSBpcyBub3QgMCBvciA0CiAgICAgICAgICAgIHJldHVybiBvLmNvbm4gJiYgIXswOnRydWUsNDp0cnVlfVtvLmNvbm4ucmVhZHlTdGF0ZV07CiAgICAgICAgfQogICAgfTsKICAgIHJldHVybiBwdWI7Cn0oKTsoZnVuY3Rpb24oKXsKICAgIHZhciBFWFRMSUIgPSBFeHQubGliLAogICAgICAgIG5vTmVnYXRpdmVzID0gL3dpZHRofGhlaWdodHxvcGFjaXR5fHBhZGRpbmcvaSwKICAgICAgICBvZmZzZXRBdHRyaWJ1dGUgPSAvXigod2lkdGh8aGVpZ2h0KXwodG9wfGxlZnQpKSQvLAogICAgICAgIGRlZmF1bHRVbml0ID0gL3dpZHRofGhlaWdodHx0b3AkfGJvdHRvbSR8bGVmdCR8cmlnaHQkL2ksCiAgICAgICAgb2Zmc2V0VW5pdCA9ICAvXGQrKGVtfCV8ZW58ZXh8cHR8aW58Y218bW18cGMpJC9pLAogICAgICAgIGlzc2V0ID0gZnVuY3Rpb24odil7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdiAhPT0gJ3VuZGVmaW5lZCc7CiAgICAgICAgfSwKICAgICAgICBub3cgPSBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoKTsKICAgICAgICB9OwoKICAgIEVYVExJQi5BbmltID0gewogICAgICAgIG1vdGlvbiA6IGZ1bmN0aW9uKGVsLCBhcmdzLCBkdXJhdGlvbiwgZWFzaW5nLCBjYiwgc2NvcGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVuKGVsLCBhcmdzLCBkdXJhdGlvbiwgZWFzaW5nLCBjYiwgc2NvcGUsIEV4dC5saWIuTW90aW9uKTsKICAgICAgICB9LAoKICAgICAgICBydW4gOiBmdW5jdGlvbihlbCwgYXJncywgZHVyYXRpb24sIGVhc2luZywgY2IsIHNjb3BlLCB0eXBlKSB7CiAgICAgICAgICAgIHR5cGUgPSB0eXBlIHx8IEV4dC5saWIuQW5pbUJhc2U7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZWFzaW5nID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBlYXNpbmcgPSBFeHQubGliLkVhc2luZ1tlYXNpbmddOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmltID0gbmV3IHR5cGUoZWwsIGFyZ3MsIGR1cmF0aW9uLCBlYXNpbmcpOwogICAgICAgICAgICBhbmltLmFuaW1hdGVYKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYoRXh0LmlzRnVuY3Rpb24oY2IpKXsKICAgICAgICAgICAgICAgICAgICBjYi5jYWxsKHNjb3BlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBhbmltOwogICAgICAgIH0KICAgIH07CgogICAgRVhUTElCLkFuaW1CYXNlID0gZnVuY3Rpb24oZWwsIGF0dHJpYnV0ZXMsIGR1cmF0aW9uLCBtZXRob2QpIHsKICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgdGhpcy5pbml0KGVsLCBhdHRyaWJ1dGVzLCBkdXJhdGlvbiwgbWV0aG9kKTsKICAgICAgICB9CiAgICB9OwoKICAgIEVYVExJQi5BbmltQmFzZS5wcm90b3R5cGUgPSB7CiAgICAgICAgZG9NZXRob2Q6IGZ1bmN0aW9uKGF0dHIsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIG1lLm1ldGhvZChtZS5jdXJGcmFtZSwgc3RhcnQsIGVuZCAtIHN0YXJ0LCBtZS50b3RhbEZyYW1lcyk7CiAgICAgICAgfSwKCgogICAgICAgIHNldEF0dHI6IGZ1bmN0aW9uKGF0dHIsIHZhbCwgdW5pdCkgewogICAgICAgICAgICBpZiAobm9OZWdhdGl2ZXMudGVzdChhdHRyKSAmJiB2YWwgPCAwKSB7CiAgICAgICAgICAgICAgICB2YWwgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEV4dC5mbHkodGhpcy5lbCwgJ19hbmltJykuc2V0U3R5bGUoYXR0ciwgdmFsICsgdW5pdCk7CiAgICAgICAgfSwKCgogICAgICAgIGdldEF0dHI6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgICAgICAgdmFyIGVsID0gRXh0LmZseSh0aGlzLmVsKSwKICAgICAgICAgICAgICAgIHZhbCA9IGVsLmdldFN0eWxlKGF0dHIpLAogICAgICAgICAgICAgICAgYSA9IG9mZnNldEF0dHJpYnV0ZS5leGVjKGF0dHIpIHx8IFtdOwoKICAgICAgICAgICAgaWYgKHZhbCAhPT0gJ2F1dG8nICYmICFvZmZzZXRVbml0LnRlc3QodmFsKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQodmFsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuICghIShhWzJdKSB8fCAoZWwuZ2V0U3R5bGUoJ3Bvc2l0aW9uJykgPT0gJ2Fic29sdXRlJyAmJiAhIShhWzNdKSkpID8gZWwuZG9tWydvZmZzZXQnICsgYVswXS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGFbMF0uc3Vic3RyKDEpXSA6IDA7CiAgICAgICAgfSwKCgogICAgICAgIGdldERlZmF1bHRVbml0OiBmdW5jdGlvbihhdHRyKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VW5pdC50ZXN0KGF0dHIpID8gJ3B4JyA6ICcnOwogICAgICAgIH0sCgogICAgICAgIGFuaW1hdGVYIDogZnVuY3Rpb24oY2FsbGJhY2ssIHNjb3BlKSB7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgICAgICBmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBtZS5vbkNvbXBsZXRlLnJlbW92ZUxpc3RlbmVyKGYpOwogICAgICAgICAgICAgICAgaWYgKEV4dC5pc0Z1bmN0aW9uKGNhbGxiYWNrKSkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwoc2NvcGUgfHwgbWUsIG1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgbWUub25Db21wbGV0ZS5hZGRMaXN0ZW5lcihmLCBtZSk7CiAgICAgICAgICAgIG1lLmFuaW1hdGUoKTsKICAgICAgICB9LAoKCiAgICAgICAgc2V0UnVuQXR0cjogZnVuY3Rpb24oYXR0cikgewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgYSA9IHRoaXMuYXR0cmlidXRlc1thdHRyXSwKICAgICAgICAgICAgICAgIHRvID0gYS50bywKICAgICAgICAgICAgICAgIGJ5ID0gYS5ieSwKICAgICAgICAgICAgICAgIGZyb20gPSBhLmZyb20sCiAgICAgICAgICAgICAgICB1bml0ID0gYS51bml0LAogICAgICAgICAgICAgICAgcmEgPSAodGhpcy5ydW5BdHRyc1thdHRyXSA9IHt9KSwKICAgICAgICAgICAgICAgIGVuZDsKCiAgICAgICAgICAgIGlmICghaXNzZXQodG8pICYmICFpc3NldChieSkpewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgc3RhcnQgPSBpc3NldChmcm9tKSA/IGZyb20gOiBtZS5nZXRBdHRyKGF0dHIpOwogICAgICAgICAgICBpZiAoaXNzZXQodG8pKSB7CiAgICAgICAgICAgICAgICBlbmQgPSB0bzsKICAgICAgICAgICAgfWVsc2UgaWYoaXNzZXQoYnkpKSB7CiAgICAgICAgICAgICAgICBpZiAoRXh0LmlzQXJyYXkoc3RhcnQpKXsKICAgICAgICAgICAgICAgICAgICBlbmQgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGk9MCxsZW49c3RhcnQubGVuZ3RoOyBpPGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVuZFtpXSA9IHN0YXJ0W2ldICsgYnlbaV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gc3RhcnQgKyBieTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgRXh0LmFwcGx5KHJhLCB7CiAgICAgICAgICAgICAgICBzdGFydDogc3RhcnQsCiAgICAgICAgICAgICAgICBlbmQ6IGVuZCwKICAgICAgICAgICAgICAgIHVuaXQ6IGlzc2V0KHVuaXQpID8gdW5pdCA6IG1lLmdldERlZmF1bHRVbml0KGF0dHIpCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgoKICAgICAgICBpbml0OiBmdW5jdGlvbihlbCwgYXR0cmlidXRlcywgZHVyYXRpb24sIG1ldGhvZCkgewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgYWN0dWFsRnJhbWVzID0gMCwKICAgICAgICAgICAgICAgIG1nciA9IEVYVExJQi5BbmltTWdyOwoKICAgICAgICAgICAgRXh0LmFwcGx5KG1lLCB7CiAgICAgICAgICAgICAgICBpc0FuaW1hdGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIHN0YXJ0VGltZTogbnVsbCwKICAgICAgICAgICAgICAgIGVsOiBFeHQuZ2V0RG9tKGVsKSwKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IGF0dHJpYnV0ZXMgfHwge30sCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogZHVyYXRpb24gfHwgMSwKICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kIHx8IEVYVExJQi5FYXNpbmcuZWFzZU5vbmUsCiAgICAgICAgICAgICAgICB1c2VTZWM6IHRydWUsCiAgICAgICAgICAgICAgICBjdXJGcmFtZTogMCwKICAgICAgICAgICAgICAgIHRvdGFsRnJhbWVzOiBtZ3IuZnBzLAogICAgICAgICAgICAgICAgcnVuQXR0cnM6IHt9LAogICAgICAgICAgICAgICAgYW5pbWF0ZTogZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBkID0gbWUuZHVyYXRpb247CgogICAgICAgICAgICAgICAgICAgIGlmKG1lLmlzQW5pbWF0ZWQpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBtZS5jdXJGcmFtZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgbWUudG90YWxGcmFtZXMgPSBtZS51c2VTZWMgPyBNYXRoLmNlaWwobWdyLmZwcyAqIGQpIDogZDsKICAgICAgICAgICAgICAgICAgICBtZ3IucmVnaXN0ZXJFbGVtZW50KG1lKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgc3RvcDogZnVuY3Rpb24oZmluaXNoKXsKICAgICAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICBpZihmaW5pc2gpewogICAgICAgICAgICAgICAgICAgICAgICBtZS5jdXJGcmFtZSA9IG1lLnRvdGFsRnJhbWVzOwogICAgICAgICAgICAgICAgICAgICAgICBtZS5fb25Ud2Vlbi5maXJlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG1nci5zdG9wKG1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgb25TdGFydCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIGF0dHI7CgogICAgICAgICAgICAgICAgbWUub25TdGFydC5maXJlKCk7CiAgICAgICAgICAgICAgICBtZS5ydW5BdHRycyA9IHt9OwogICAgICAgICAgICAgICAgZm9yKGF0dHIgaW4gdGhpcy5hdHRyaWJ1dGVzKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFJ1bkF0dHIoYXR0cik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbWUuaXNBbmltYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBtZS5zdGFydFRpbWUgPSBub3coKTsKICAgICAgICAgICAgICAgIGFjdHVhbEZyYW1lcyA9IDA7CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgdmFyIG9uVHdlZW4gPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpczsKCiAgICAgICAgICAgICAgICBtZS5vblR3ZWVuLmZpcmUoewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBub3coKSAtIG1lLnN0YXJ0VGltZSwKICAgICAgICAgICAgICAgICAgICBjdXJGcmFtZTogbWUuY3VyRnJhbWUKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHZhciByYSA9IG1lLnJ1bkF0dHJzOwogICAgICAgICAgICAgICAgZm9yICh2YXIgYXR0ciBpbiByYSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0QXR0cihhdHRyLCBtZS5kb01ldGhvZChhdHRyLCByYVthdHRyXS5zdGFydCwgcmFbYXR0cl0uZW5kKSwgcmFbYXR0cl0udW5pdCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgKythY3R1YWxGcmFtZXM7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBhY3R1YWwgPSAobm93KCkgLSBtZS5zdGFydFRpbWUpIC8gMTAwMCwKICAgICAgICAgICAgICAgICAgICBkYXRhID0gewogICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogYWN0dWFsLAogICAgICAgICAgICAgICAgICAgICAgICBmcmFtZXM6IGFjdHVhbEZyYW1lcywKICAgICAgICAgICAgICAgICAgICAgICAgZnBzOiBhY3R1YWxGcmFtZXMgLyBhY3R1YWwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIG1lLmlzQW5pbWF0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGFjdHVhbEZyYW1lcyA9IDA7CiAgICAgICAgICAgICAgICBtZS5vbkNvbXBsZXRlLmZpcmUoZGF0YSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBtZS5vblN0YXJ0ID0gbmV3IEV4dC51dGlsLkV2ZW50KG1lKTsKICAgICAgICAgICAgbWUub25Ud2VlbiA9IG5ldyBFeHQudXRpbC5FdmVudChtZSk7CiAgICAgICAgICAgIG1lLm9uQ29tcGxldGUgPSBuZXcgRXh0LnV0aWwuRXZlbnQobWUpOwogICAgICAgICAgICAobWUuX29uU3RhcnQgPSBuZXcgRXh0LnV0aWwuRXZlbnQobWUpKS5hZGRMaXN0ZW5lcihvblN0YXJ0KTsKICAgICAgICAgICAgKG1lLl9vblR3ZWVuID0gbmV3IEV4dC51dGlsLkV2ZW50KG1lKSkuYWRkTGlzdGVuZXIob25Ud2Vlbik7CiAgICAgICAgICAgIChtZS5fb25Db21wbGV0ZSA9IG5ldyBFeHQudXRpbC5FdmVudChtZSkpLmFkZExpc3RlbmVyKG9uQ29tcGxldGUpOwogICAgICAgIH0KICAgIH07CgoKICAgIEV4dC5saWIuQW5pbU1nciA9IG5ldyBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICB0aHJlYWQgPSBudWxsLAogICAgICAgICAgICBxdWV1ZSA9IFtdLAogICAgICAgICAgICB0d2VlbkNvdW50ID0gMDsKCgogICAgICAgIEV4dC5hcHBseShtZSwgewogICAgICAgICAgICBmcHM6IDEwMDAsCiAgICAgICAgICAgIGRlbGF5OiAxLAogICAgICAgICAgICByZWdpc3RlckVsZW1lbnQ6IGZ1bmN0aW9uKHR3ZWVuKXsKICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2godHdlZW4pOwogICAgICAgICAgICAgICAgKyt0d2VlbkNvdW50OwogICAgICAgICAgICAgICAgdHdlZW4uX29uU3RhcnQuZmlyZSgpOwogICAgICAgICAgICAgICAgbWUuc3RhcnQoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHVuUmVnaXN0ZXI6IGZ1bmN0aW9uKHR3ZWVuLCBpbmRleCl7CiAgICAgICAgICAgICAgICB0d2Vlbi5fb25Db21wbGV0ZS5maXJlKCk7CiAgICAgICAgICAgICAgICBpbmRleCA9IGluZGV4IHx8IGdldEluZGV4KHR3ZWVuKTsKICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgIHF1ZXVlLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKC0tdHdlZW5Db3VudCA8PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgbWUuc3RvcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBpZih0aHJlYWQgPT09IG51bGwpewogICAgICAgICAgICAgICAgICAgIHRocmVhZCA9IHNldEludGVydmFsKG1lLnJ1biwgbWUuZGVsYXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc3RvcDogZnVuY3Rpb24odHdlZW4pewogICAgICAgICAgICAgICAgaWYoIXR3ZWVuKXsKICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRocmVhZCk7CiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gcXVldWUubGVuZ3RoOyBpIDwgbGVuOyArK2kpewogICAgICAgICAgICAgICAgICAgICAgICBpZihxdWV1ZVswXS5pc0FuaW1hdGVkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnVuUmVnaXN0ZXIocXVldWVbMF0sIDApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBxdWV1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIHRocmVhZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgdHdlZW5Db3VudCA9IDA7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICBtZS51blJlZ2lzdGVyKHR3ZWVuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJ1bjogZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIHZhciB0ZiwgaSwgbGVuLCB0d2VlbjsKICAgICAgICAgICAgICAgIGZvcihpID0gMCwgbGVuID0gcXVldWUubGVuZ3RoOyBpPGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdHdlZW4gPSBxdWV1ZVtpXTsKICAgICAgICAgICAgICAgICAgICBpZih0d2VlbiAmJiB0d2Vlbi5pc0FuaW1hdGVkKXsKICAgICAgICAgICAgICAgICAgICAgICAgdGYgPSB0d2Vlbi50b3RhbEZyYW1lczsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodHdlZW4uY3VyRnJhbWUgPCB0ZiB8fCB0ZiA9PT0gbnVsbCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICArK3R3ZWVuLmN1ckZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYodHdlZW4udXNlU2VjKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3JyZWN0RnJhbWUodHdlZW4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHdlZW4uX29uVHdlZW4uZmlyZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lLnN0b3AodHdlZW4pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHZhciBnZXRJbmRleCA9IGZ1bmN0aW9uKGFuaW0pIHsKICAgICAgICAgICAgdmFyIGksIGxlbjsKICAgICAgICAgICAgZm9yKGkgPSAwLCBsZW4gPSBxdWV1ZS5sZW5ndGg7IGk8bGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmKHF1ZXVlW2ldID09PSBhbmltKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH07CgogICAgICAgIHZhciBjb3JyZWN0RnJhbWUgPSBmdW5jdGlvbih0d2VlbikgewogICAgICAgICAgICB2YXIgZnJhbWVzID0gdHdlZW4udG90YWxGcmFtZXMsCiAgICAgICAgICAgICAgICBmcmFtZSA9IHR3ZWVuLmN1ckZyYW1lLAogICAgICAgICAgICAgICAgZHVyYXRpb24gPSB0d2Vlbi5kdXJhdGlvbiwKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gKGZyYW1lICogZHVyYXRpb24gKiAxMDAwIC8gZnJhbWVzKSwKICAgICAgICAgICAgICAgIGVsYXBzZWQgPSAobm93KCkgLSB0d2Vlbi5zdGFydFRpbWUpLAogICAgICAgICAgICAgICAgdHdlYWsgPSAwOwoKICAgICAgICAgICAgaWYoZWxhcHNlZCA8IGR1cmF0aW9uICogMTAwMCl7CiAgICAgICAgICAgICAgICB0d2VhayA9IE1hdGgucm91bmQoKGVsYXBzZWQgLyBleHBlY3RlZCAtIDEpICogZnJhbWUpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHR3ZWFrID0gZnJhbWVzIC0gKGZyYW1lICsgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHdlYWsgPiAwICYmIGlzRmluaXRlKHR3ZWFrKSl7CiAgICAgICAgICAgICAgICBpZih0d2Vlbi5jdXJGcmFtZSArIHR3ZWFrID49IGZyYW1lcyl7CiAgICAgICAgICAgICAgICAgICAgdHdlYWsgPSBmcmFtZXMgLSAoZnJhbWUgKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHR3ZWVuLmN1ckZyYW1lICs9IHR3ZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH07CgogICAgRVhUTElCLkJlemllciA9IG5ldyBmdW5jdGlvbigpIHsKCiAgICAgICAgdGhpcy5nZXRQb3NpdGlvbiA9IGZ1bmN0aW9uKHBvaW50cywgdCkgewogICAgICAgICAgICB2YXIgbiA9IHBvaW50cy5sZW5ndGgsCiAgICAgICAgICAgICAgICB0bXAgPSBbXSwKICAgICAgICAgICAgICAgIGMgPSAxIC0gdCwKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICBqOwoKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgewogICAgICAgICAgICAgICAgdG1wW2ldID0gW3BvaW50c1tpXVswXSwgcG9pbnRzW2ldWzFdXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChqID0gMTsgaiA8IG47ICsraikgewogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG4gLSBqOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICB0bXBbaV1bMF0gPSBjICogdG1wW2ldWzBdICsgdCAqIHRtcFtwYXJzZUludChpICsgMSwgMTApXVswXTsKICAgICAgICAgICAgICAgICAgICB0bXBbaV1bMV0gPSBjICogdG1wW2ldWzFdICsgdCAqIHRtcFtwYXJzZUludChpICsgMSwgMTApXVsxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIFsgdG1wWzBdWzBdLCB0bXBbMF1bMV0gXTsKCiAgICAgICAgfTsKICAgIH07CgoKICAgIEVYVExJQi5FYXNpbmcgPSB7CiAgICAgICAgZWFzZU5vbmU6IGZ1bmN0aW9uICh0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjICogdCAvIGQgKyBiOwogICAgICAgIH0sCgoKICAgICAgICBlYXNlSW46IGZ1bmN0aW9uICh0LCBiLCBjLCBkKSB7CiAgICAgICAgICAgIHJldHVybiBjICogKHQgLz0gZCkgKiB0ICsgYjsKICAgICAgICB9LAoKCiAgICAgICAgZWFzZU91dDogZnVuY3Rpb24gKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuIC1jICogKHQgLz0gZCkgKiAodCAtIDIpICsgYjsKICAgICAgICB9CiAgICB9OwoKICAgIChmdW5jdGlvbigpIHsKICAgICAgICBFWFRMSUIuTW90aW9uID0gZnVuY3Rpb24oZWwsIGF0dHJpYnV0ZXMsIGR1cmF0aW9uLCBtZXRob2QpIHsKICAgICAgICAgICAgaWYgKGVsKSB7CiAgICAgICAgICAgICAgICBFWFRMSUIuTW90aW9uLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBlbCwgYXR0cmlidXRlcywgZHVyYXRpb24sIG1ldGhvZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBFeHQuZXh0ZW5kKEVYVExJQi5Nb3Rpb24sIEV4dC5saWIuQW5pbUJhc2UpOwoKICAgICAgICB2YXIgc3VwZXJjbGFzcyA9IEVYVExJQi5Nb3Rpb24uc3VwZXJjbGFzcywKICAgICAgICAgICAgcG9pbnRzUmUgPSAvXnBvaW50cyQvaTsKCiAgICAgICAgRXh0LmFwcGx5KEVYVExJQi5Nb3Rpb24ucHJvdG90eXBlLCB7CiAgICAgICAgICAgIHNldEF0dHI6IGZ1bmN0aW9uKGF0dHIsIHZhbCwgdW5pdCl7CiAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIHNldEF0dHIgPSBzdXBlcmNsYXNzLnNldEF0dHI7CgogICAgICAgICAgICAgICAgaWYgKHBvaW50c1JlLnRlc3QoYXR0cikpIHsKICAgICAgICAgICAgICAgICAgICB1bml0ID0gdW5pdCB8fCAncHgnOwogICAgICAgICAgICAgICAgICAgIHNldEF0dHIuY2FsbChtZSwgJ2xlZnQnLCB2YWxbMF0sIHVuaXQpOwogICAgICAgICAgICAgICAgICAgIHNldEF0dHIuY2FsbChtZSwgJ3RvcCcsIHZhbFsxXSwgdW5pdCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHNldEF0dHIuY2FsbChtZSwgYXR0ciwgdmFsLCB1bml0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGdldEF0dHI6IGZ1bmN0aW9uKGF0dHIpewogICAgICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBnZXRBdHRyID0gc3VwZXJjbGFzcy5nZXRBdHRyOwoKICAgICAgICAgICAgICAgIHJldHVybiBwb2ludHNSZS50ZXN0KGF0dHIpID8gW2dldEF0dHIuY2FsbChtZSwgJ2xlZnQnKSwgZ2V0QXR0ci5jYWxsKG1lLCAndG9wJyldIDogZ2V0QXR0ci5jYWxsKG1lLCBhdHRyKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGRvTWV0aG9kOiBmdW5jdGlvbihhdHRyLCBzdGFydCwgZW5kKXsKICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7CgogICAgICAgICAgICAgICAgcmV0dXJuIHBvaW50c1JlLnRlc3QoYXR0cikKICAgICAgICAgICAgICAgICAgICAgICAgPyBFWFRMSUIuQmV6aWVyLmdldFBvc2l0aW9uKG1lLnJ1bkF0dHJzW2F0dHJdLCBtZS5tZXRob2QobWUuY3VyRnJhbWUsIDAsIDEwMCwgbWUudG90YWxGcmFtZXMpIC8gMTAwKQogICAgICAgICAgICAgICAgICAgICAgICA6IHN1cGVyY2xhc3MuZG9NZXRob2QuY2FsbChtZSwgYXR0ciwgc3RhcnQsIGVuZCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzZXRSdW5BdHRyOiBmdW5jdGlvbihhdHRyKXsKICAgICAgICAgICAgICAgIGlmKHBvaW50c1JlLnRlc3QoYXR0cikpewoKICAgICAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBlbCA9IHRoaXMuZWwsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50cyA9IHRoaXMuYXR0cmlidXRlcy5wb2ludHMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSBwb2ludHMuY29udHJvbCB8fCBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSA9IHBvaW50cy5mcm9tLAogICAgICAgICAgICAgICAgICAgICAgICB0byA9IHBvaW50cy50bywKICAgICAgICAgICAgICAgICAgICAgICAgYnkgPSBwb2ludHMuYnksCiAgICAgICAgICAgICAgICAgICAgICAgIERPTSA9IEVYVExJQi5Eb20sCiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgICAgICAgICBlbmQsCiAgICAgICAgICAgICAgICAgICAgICAgIGxlbiwKICAgICAgICAgICAgICAgICAgICAgICAgcmE7CgoKICAgICAgICAgICAgICAgICAgICBpZihjb250cm9sLmxlbmd0aCA+IDAgJiYgIUV4dC5pc0FycmF5KGNvbnRyb2xbMF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbCA9IFtjb250cm9sXTsKICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLGxlbiA9IGNvbnRyb2wubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRtcFtpXSA9IGNvbnRyb2xbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHRtcDsKICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIEV4dC5mbHkoZWwsICdfYW5pbScpLnBvc2l0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgRE9NLnNldFhZKGVsLCBpc3NldChmcm9tKSA/IGZyb20gOiBET00uZ2V0WFkoZWwpKTsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IG1lLmdldEF0dHIoJ3BvaW50cycpOwoKCiAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQodG8pKXsKICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gdHJhbnNsYXRlVmFsdWVzLmNhbGwobWUsIHRvLCBzdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsbGVuID0gY29udHJvbC5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbFtpXSA9IHRyYW5zbGF0ZVZhbHVlcy5jYWxsKG1lLCBjb250cm9sW2ldLCBzdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzc2V0KGJ5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBbc3RhcnRbMF0gKyBieVswXSwgc3RhcnRbMV0gKyBieVsxXV07CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLGxlbiA9IGNvbnRyb2wubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xbaV0gPSBbIHN0YXJ0WzBdICsgY29udHJvbFtpXVswXSwgc3RhcnRbMV0gKyBjb250cm9sW2ldWzFdIF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJhID0gdGhpcy5ydW5BdHRyc1thdHRyXSA9IFtzdGFydF07CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRyb2wubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByYSA9IHJhLmNvbmNhdChjb250cm9sKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJhW3JhLmxlbmd0aF0gPSBlbmQ7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICBzdXBlcmNsYXNzLnNldFJ1bkF0dHIuY2FsbCh0aGlzLCBhdHRyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB2YXIgdHJhbnNsYXRlVmFsdWVzID0gZnVuY3Rpb24odmFsLCBzdGFydCkgewogICAgICAgICAgICB2YXIgcGFnZVhZID0gRVhUTElCLkRvbS5nZXRYWSh0aGlzLmVsKTsKICAgICAgICAgICAgcmV0dXJuIFt2YWxbMF0gLSBwYWdlWFlbMF0gKyBzdGFydFswXSwgdmFsWzFdIC0gcGFnZVhZWzFdICsgc3RhcnRbMV1dOwogICAgICAgIH07CiAgICB9KSgpOwp9KSgpOy8vIEVhc2luZyBmdW5jdGlvbnMKKGZ1bmN0aW9uKCl7CiAgICAvLyBzaG9ydGN1dHMgdG8gYWlkIGNvbXByZXNzaW9uCiAgICB2YXIgYWJzID0gTWF0aC5hYnMsCiAgICAgICAgcGkgPSBNYXRoLlBJLAogICAgICAgIGFzaW4gPSBNYXRoLmFzaW4sCiAgICAgICAgcG93ID0gTWF0aC5wb3csCiAgICAgICAgc2luID0gTWF0aC5zaW4sCiAgICAgICAgRVhUTElCID0gRXh0LmxpYjsKCiAgICBFeHQuYXBwbHkoRVhUTElCLkVhc2luZywgewoKICAgICAgICBlYXNlQm90aDogZnVuY3Rpb24gKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuICgodCAvPSBkIC8gMikgPCAxKSAgPyAgYyAvIDIgKiB0ICogdCArIGIgIDogIC1jIC8gMiAqICgoLS10KSAqICh0IC0gMikgLSAxKSArIGI7CiAgICAgICAgfSwKCiAgICAgICAgZWFzZUluU3Ryb25nOiBmdW5jdGlvbiAodCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAqICh0IC89IGQpICogdCAqIHQgKiB0ICsgYjsKICAgICAgICB9LAoKICAgICAgICBlYXNlT3V0U3Ryb25nOiBmdW5jdGlvbiAodCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gLWMgKiAoKHQgPSB0IC8gZCAtIDEpICogdCAqIHQgKiB0IC0gMSkgKyBiOwogICAgICAgIH0sCgogICAgICAgIGVhc2VCb3RoU3Ryb25nOiBmdW5jdGlvbiAodCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gKCh0IC89IGQgLyAyKSA8IDEpICA/ICBjIC8gMiAqIHQgKiB0ICogdCAqIHQgKyBiICA6ICAtYyAvIDIgKiAoKHQgLT0gMikgKiB0ICogdCAqIHQgLSAyKSArIGI7CiAgICAgICAgfSwKCiAgICAgICAgZWxhc3RpY0luOiBmdW5jdGlvbiAodCwgYiwgYywgZCwgYSwgcCkgewogICAgICAgICAgICBpZiAodCA9PSAwIHx8ICh0IC89IGQpID09IDEpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0ID09IDAgPyBiIDogYiArIGM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcCA9IHAgfHwgKGQgKiAuMyk7CgogICAgICAgICAgICB2YXIgczsKICAgICAgICAgICAgaWYgKGEgPj0gYWJzKGMpKSB7CiAgICAgICAgICAgICAgICBzID0gcCAvICgyICogcGkpICogYXNpbihjIC8gYSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhID0gYzsKICAgICAgICAgICAgICAgIHMgPSBwIC8gNDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIC0oYSAqIHBvdygyLCAxMCAqICh0IC09IDEpKSAqIHNpbigodCAqIGQgLSBzKSAqICgyICogcGkpIC8gcCkpICsgYjsKCiAgICAgICAgfSwKCiAgICAgICAgZWxhc3RpY091dDogZnVuY3Rpb24gKHQsIGIsIGMsIGQsIGEsIHApIHsKICAgICAgICAgICAgaWYgKHQgPT0gMCB8fCAodCAvPSBkKSA9PSAxKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdCA9PSAwID8gYiA6IGIgKyBjOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHAgPSBwIHx8IChkICogLjMpOwoKICAgICAgICAgICAgdmFyIHM7CiAgICAgICAgICAgIGlmIChhID49IGFicyhjKSkgewogICAgICAgICAgICAgICAgcyA9IHAgLyAoMiAqIHBpKSAqIGFzaW4oYyAvIGEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICBzID0gcCAvIDQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBhICogcG93KDIsIC0xMCAqIHQpICogc2luKCh0ICogZCAtIHMpICogKDIgKiBwaSkgLyBwKSArIGMgKyBiOwogICAgICAgIH0sCgogICAgICAgIGVsYXN0aWNCb3RoOiBmdW5jdGlvbiAodCwgYiwgYywgZCwgYSwgcCkgewogICAgICAgICAgICBpZiAodCA9PSAwIHx8ICh0IC89IGQgLyAyKSA9PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdCA9PSAwID8gYiA6IGIgKyBjOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwID0gcCB8fCAoZCAqICguMyAqIDEuNSkpOwoKICAgICAgICAgICAgdmFyIHM7CiAgICAgICAgICAgIGlmIChhID49IGFicyhjKSkgewogICAgICAgICAgICAgICAgcyA9IHAgLyAoMiAqIHBpKSAqIGFzaW4oYyAvIGEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYSA9IGM7CiAgICAgICAgICAgICAgICBzID0gcCAvIDQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0IDwgMSA/CiAgICAgICAgICAgICAgICAgICAgLS41ICogKGEgKiBwb3coMiwgMTAgKiAodCAtPSAxKSkgKiBzaW4oKHQgKiBkIC0gcykgKiAoMiAqIHBpKSAvIHApKSArIGIgOgogICAgICAgICAgICAgICAgICAgIGEgKiBwb3coMiwgLTEwICogKHQgLT0gMSkpICogc2luKCh0ICogZCAtIHMpICogKDIgKiBwaSkgLyBwKSAqIC41ICsgYyArIGI7CiAgICAgICAgfSwKCiAgICAgICAgYmFja0luOiBmdW5jdGlvbiAodCwgYiwgYywgZCwgcykgewogICAgICAgICAgICBzID0gcyB8fCAgMS43MDE1ODsKICAgICAgICAgICAgcmV0dXJuIGMgKiAodCAvPSBkKSAqIHQgKiAoKHMgKyAxKSAqIHQgLSBzKSArIGI7CiAgICAgICAgfSwKCgogICAgICAgIGJhY2tPdXQ6IGZ1bmN0aW9uICh0LCBiLCBjLCBkLCBzKSB7CiAgICAgICAgICAgIGlmICghcykgewogICAgICAgICAgICAgICAgcyA9IDEuNzAxNTg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGMgKiAoKHQgPSB0IC8gZCAtIDEpICogdCAqICgocyArIDEpICogdCArIHMpICsgMSkgKyBiOwogICAgICAgIH0sCgoKICAgICAgICBiYWNrQm90aDogZnVuY3Rpb24gKHQsIGIsIGMsIGQsIHMpIHsKICAgICAgICAgICAgcyA9IHMgfHwgMS43MDE1ODsKCiAgICAgICAgICAgIHJldHVybiAoKHQgLz0gZCAvIDIgKSA8IDEpID8KICAgICAgICAgICAgICAgICAgICBjIC8gMiAqICh0ICogdCAqICgoKHMgKj0gKDEuNTI1KSkgKyAxKSAqIHQgLSBzKSkgKyBiIDoKICAgICAgICAgICAgICAgICAgICBjIC8gMiAqICgodCAtPSAyKSAqIHQgKiAoKChzICo9ICgxLjUyNSkpICsgMSkgKiB0ICsgcykgKyAyKSArIGI7CiAgICAgICAgfSwKCgogICAgICAgIGJvdW5jZUluOiBmdW5jdGlvbiAodCwgYiwgYywgZCkgewogICAgICAgICAgICByZXR1cm4gYyAtIEVYVExJQi5FYXNpbmcuYm91bmNlT3V0KGQgLSB0LCAwLCBjLCBkKSArIGI7CiAgICAgICAgfSwKCgogICAgICAgIGJvdW5jZU91dDogZnVuY3Rpb24gKHQsIGIsIGMsIGQpIHsKICAgICAgICBpZiAoKHQgLz0gZCkgPCAoMSAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiB0ICogdCkgKyBiOwogICAgICAgICAgICB9IGVsc2UgaWYgKHQgPCAoMiAvIDIuNzUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYyAqICg3LjU2MjUgKiAodCAtPSAoMS41IC8gMi43NSkpICogdCArIC43NSkgKyBiOwogICAgICAgICAgICB9IGVsc2UgaWYgKHQgPCAoMi41IC8gMi43NSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjICogKDcuNTYyNSAqICh0IC09ICgyLjI1IC8gMi43NSkpICogdCArIC45Mzc1KSArIGI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGMgKiAoNy41NjI1ICogKHQgLT0gKDIuNjI1IC8gMi43NSkpICogdCArIC45ODQzNzUpICsgYjsKICAgICAgICB9LAoKCiAgICAgICAgYm91bmNlQm90aDogZnVuY3Rpb24gKHQsIGIsIGMsIGQpIHsKICAgICAgICAgICAgcmV0dXJuICh0IDwgZCAvIDIpID8KICAgICAgICAgICAgICAgICAgICBFWFRMSUIuRWFzaW5nLmJvdW5jZUluKHQgKiAyLCAwLCBjLCBkKSAqIC41ICsgYiA6CiAgICAgICAgICAgICAgICAgICAgRVhUTElCLkVhc2luZy5ib3VuY2VPdXQodCAqIDIgLSBkLCAwLCBjLCBkKSAqIC41ICsgYyAqIC41ICsgYjsKICAgICAgICB9CiAgICB9KTsKfSkoKTsKCihmdW5jdGlvbigpIHsKICAgIHZhciBFWFRMSUIgPSBFeHQubGliOwogICAgLy8gQ29sb3IgQW5pbWF0aW9uCiAgICBFWFRMSUIuQW5pbS5jb2xvciA9IGZ1bmN0aW9uKGVsLCBhcmdzLCBkdXJhdGlvbiwgZWFzaW5nLCBjYiwgc2NvcGUpIHsKICAgICAgICByZXR1cm4gRVhUTElCLkFuaW0ucnVuKGVsLCBhcmdzLCBkdXJhdGlvbiwgZWFzaW5nLCBjYiwgc2NvcGUsIEVYVExJQi5Db2xvckFuaW0pOwogICAgfTsKCiAgICBFWFRMSUIuQ29sb3JBbmltID0gZnVuY3Rpb24oZWwsIGF0dHJpYnV0ZXMsIGR1cmF0aW9uLCBtZXRob2QpIHsKICAgICAgICBFWFRMSUIuQ29sb3JBbmltLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBlbCwgYXR0cmlidXRlcywgZHVyYXRpb24sIG1ldGhvZCk7CiAgICB9OwoKICAgIEV4dC5leHRlbmQoRVhUTElCLkNvbG9yQW5pbSwgRVhUTElCLkFuaW1CYXNlKTsKCiAgICB2YXIgc3VwZXJjbGFzcyA9IEVYVExJQi5Db2xvckFuaW0uc3VwZXJjbGFzcywKICAgICAgICBjb2xvclJFID0gL2NvbG9yJC9pLAogICAgICAgIHRyYW5zcGFyZW50UkUgPSAvXnRyYW5zcGFyZW50fHJnYmFcKDAsIDAsIDAsIDBcKSQvLAogICAgICAgIHJnYlJFID0gL15yZ2JcKChbMC05XSspXHMqLFxzKihbMC05XSspXHMqLFxzKihbMC05XSspXCkkL2ksCiAgICAgICAgaGV4UkU9IC9eIz8oWzAtOUEtRl17Mn0pKFswLTlBLUZdezJ9KShbMC05QS1GXXsyfSkkL2ksCiAgICAgICAgaGV4M1JFID0gL14jPyhbMC05QS1GXXsxfSkoWzAtOUEtRl17MX0pKFswLTlBLUZdezF9KSQvaSwKICAgICAgICBpc3NldCA9IGZ1bmN0aW9uKHYpewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIHYgIT09ICd1bmRlZmluZWQnOwogICAgICAgIH07CgogICAgLy8gcHJpdmF0ZQogICAgZnVuY3Rpb24gcGFyc2VDb2xvcihzKSB7CiAgICAgICAgdmFyIHBpID0gcGFyc2VJbnQsCiAgICAgICAgICAgIGJhc2UsCiAgICAgICAgICAgIG91dCA9IG51bGwsCiAgICAgICAgICAgIGM7CgogICAgICAgIGlmIChzLmxlbmd0aCA9PSAzKSB7CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0KCiAgICAgICAgRXh0LmVhY2goW2hleFJFLCByZ2JSRSwgaGV4M1JFXSwgZnVuY3Rpb24ocmUsIGlkeCl7CiAgICAgICAgICAgIGJhc2UgPSAoaWR4ICUgMiA9PSAwKSA/IDE2IDogMTA7CiAgICAgICAgICAgIGMgPSByZS5leGVjKHMpOwogICAgICAgICAgICBpZihjICYmIGMubGVuZ3RoID09IDQpewogICAgICAgICAgICAgICAgb3V0ID0gW3BpKGNbMV0sIGJhc2UpLCBwaShjWzJdLCBiYXNlKSwgcGkoY1szXSwgYmFzZSldOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG91dDsKICAgIH0KCiAgICBFeHQuYXBwbHkoRVhUTElCLkNvbG9yQW5pbS5wcm90b3R5cGUsIHsKICAgICAgICBnZXRBdHRyIDogZnVuY3Rpb24oYXR0cikgewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgZWwgPSBtZS5lbCwKICAgICAgICAgICAgICAgIHZhbDsKICAgICAgICAgICAgaWYoY29sb3JSRS50ZXN0KGF0dHIpKXsKICAgICAgICAgICAgICAgIHdoaWxlKGVsICYmIHRyYW5zcGFyZW50UkUudGVzdCh2YWwgPSBFeHQuZmx5KGVsKS5nZXRTdHlsZShhdHRyKSkpewogICAgICAgICAgICAgICAgICAgIGVsID0gZWwucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICB2YWwgPSAiZmZmIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICB2YWwgPSBzdXBlcmNsYXNzLmdldEF0dHIuY2FsbChtZSwgYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9LAoKICAgICAgICBkb01ldGhvZCA6IGZ1bmN0aW9uKGF0dHIsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIHZhbCwKICAgICAgICAgICAgICAgIGZsb29yID0gTWF0aC5mbG9vciwKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICBsZW4sCiAgICAgICAgICAgICAgICB2OwoKICAgICAgICAgICAgaWYoY29sb3JSRS50ZXN0KGF0dHIpKXsKICAgICAgICAgICAgICAgIHZhbCA9IFtdOwogICAgICAgICAgICAgICAgZW5kID0gZW5kIHx8IFtdOwoKICAgICAgICAgICAgICAgIGZvcihpID0gMCwgbGVuID0gc3RhcnQubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2ID0gc3RhcnRbaV07CiAgICAgICAgICAgICAgICAgICAgdmFsW2ldID0gc3VwZXJjbGFzcy5kb01ldGhvZC5jYWxsKG1lLCBhdHRyLCB2LCBlbmRbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFsID0gJ3JnYignICsgZmxvb3IodmFsWzBdKSArICcsJyArIGZsb29yKHZhbFsxXSkgKyAnLCcgKyBmbG9vcih2YWxbMl0pICsgJyknOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHZhbCA9IHN1cGVyY2xhc3MuZG9NZXRob2QuY2FsbChtZSwgYXR0ciwgc3RhcnQsIGVuZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9LAoKICAgICAgICBzZXRSdW5BdHRyIDogZnVuY3Rpb24oYXR0cikgewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgYSA9IG1lLmF0dHJpYnV0ZXNbYXR0cl0sCiAgICAgICAgICAgICAgICB0byA9IGEudG8sCiAgICAgICAgICAgICAgICBieSA9IGEuYnksCiAgICAgICAgICAgICAgICByYTsKCiAgICAgICAgICAgIHN1cGVyY2xhc3Muc2V0UnVuQXR0ci5jYWxsKG1lLCBhdHRyKTsKICAgICAgICAgICAgcmEgPSBtZS5ydW5BdHRyc1thdHRyXTsKICAgICAgICAgICAgaWYoY29sb3JSRS50ZXN0KGF0dHIpKXsKICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IHBhcnNlQ29sb3IocmEuc3RhcnQpLAogICAgICAgICAgICAgICAgICAgIGVuZCA9IHBhcnNlQ29sb3IocmEuZW5kKTsKCiAgICAgICAgICAgICAgICBpZighaXNzZXQodG8pICYmIGlzc2V0KGJ5KSl7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gcGFyc2VDb2xvcihieSk7CiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpPTAsbGVuPXN0YXJ0Lmxlbmd0aDsgaTxsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBlbmRbaV0gPSBzdGFydFtpXSArIGVuZFtpXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByYS5zdGFydCA9IHN0YXJ0OwogICAgICAgICAgICAgICAgcmEuZW5kID0gZW5kOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7Cn0pKCk7CgoKKGZ1bmN0aW9uKCkgewogICAgLy8gU2Nyb2xsIEFuaW1hdGlvbgogICAgdmFyIEVYVExJQiA9IEV4dC5saWI7CiAgICBFWFRMSUIuQW5pbS5zY3JvbGwgPSBmdW5jdGlvbihlbCwgYXJncywgZHVyYXRpb24sIGVhc2luZywgY2IsIHNjb3BlKSB7CiAgICAgICAgcmV0dXJuIEVYVExJQi5BbmltLnJ1bihlbCwgYXJncywgZHVyYXRpb24sIGVhc2luZywgY2IsIHNjb3BlLCBFWFRMSUIuU2Nyb2xsKTsKICAgIH07CgogICAgRVhUTElCLlNjcm9sbCA9IGZ1bmN0aW9uKGVsLCBhdHRyaWJ1dGVzLCBkdXJhdGlvbiwgbWV0aG9kKSB7CiAgICAgICAgaWYoZWwpewogICAgICAgICAgICBFWFRMSUIuU2Nyb2xsLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBlbCwgYXR0cmlidXRlcywgZHVyYXRpb24sIG1ldGhvZCk7CiAgICAgICAgfQogICAgfTsKCiAgICBFeHQuZXh0ZW5kKEVYVExJQi5TY3JvbGwsIEVYVExJQi5Db2xvckFuaW0pOwoKICAgIHZhciBzdXBlcmNsYXNzID0gRVhUTElCLlNjcm9sbC5zdXBlcmNsYXNzLAogICAgICAgIFNDUk9MTCA9ICdzY3JvbGwnOwoKICAgIEV4dC5hcHBseShFWFRMSUIuU2Nyb2xsLnByb3RvdHlwZSwgewoKICAgICAgICBkb01ldGhvZCA6IGZ1bmN0aW9uKGF0dHIsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgdmFyIHZhbCwKICAgICAgICAgICAgICAgIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIGN1ckZyYW1lID0gbWUuY3VyRnJhbWUsCiAgICAgICAgICAgICAgICB0b3RhbEZyYW1lcyA9IG1lLnRvdGFsRnJhbWVzOwoKICAgICAgICAgICAgaWYoYXR0ciA9PSBTQ1JPTEwpewogICAgICAgICAgICAgICAgdmFsID0gW21lLm1ldGhvZChjdXJGcmFtZSwgc3RhcnRbMF0sIGVuZFswXSAtIHN0YXJ0WzBdLCB0b3RhbEZyYW1lcyksCiAgICAgICAgICAgICAgICAgICAgICAgbWUubWV0aG9kKGN1ckZyYW1lLCBzdGFydFsxXSwgZW5kWzFdIC0gc3RhcnRbMV0sIHRvdGFsRnJhbWVzKV07CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdmFsID0gc3VwZXJjbGFzcy5kb01ldGhvZC5jYWxsKG1lLCBhdHRyLCBzdGFydCwgZW5kKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0sCgogICAgICAgIGdldEF0dHIgOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7CgogICAgICAgICAgICBpZiAoYXR0ciA9PSBTQ1JPTEwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbbWUuZWwuc2Nyb2xsTGVmdCwgbWUuZWwuc2Nyb2xsVG9wXTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICByZXR1cm4gc3VwZXJjbGFzcy5nZXRBdHRyLmNhbGwobWUsIGF0dHIpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc2V0QXR0ciA6IGZ1bmN0aW9uKGF0dHIsIHZhbCwgdW5pdCkgewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgICAgICAgaWYoYXR0ciA9PSBTQ1JPTEwpewogICAgICAgICAgICAgICAgbWUuZWwuc2Nyb2xsTGVmdCA9IHZhbFswXTsKICAgICAgICAgICAgICAgIG1lLmVsLnNjcm9sbFRvcCA9IHZhbFsxXTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBzdXBlcmNsYXNzLnNldEF0dHIuY2FsbChtZSwgYXR0ciwgdmFsLCB1bml0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwp9KSgpOwkKCWlmIChFeHQuaXNJRSkgewogICAgICAgIGZ1bmN0aW9uIGZuQ2xlYW5VcCgpIHsKICAgICAgICAgICAgdmFyIHAgPSBGdW5jdGlvbi5wcm90b3R5cGU7CiAgICAgICAgICAgIGRlbGV0ZSBwLmNyZWF0ZVNlcXVlbmNlOwogICAgICAgICAgICBkZWxldGUgcC5kZWZlcjsKICAgICAgICAgICAgZGVsZXRlIHAuY3JlYXRlRGVsZWdhdGU7CiAgICAgICAgICAgIGRlbGV0ZSBwLmNyZWF0ZUNhbGxiYWNrOwogICAgICAgICAgICBkZWxldGUgcC5jcmVhdGVJbnRlcmNlcHRvcjsKCiAgICAgICAgICAgIHdpbmRvdy5kZXRhY2hFdmVudCgib251bmxvYWQiLCBmbkNsZWFuVXApOwogICAgICAgIH0KICAgICAgICB3aW5kb3cuYXR0YWNoRXZlbnQoIm9udW5sb2FkIiwgZm5DbGVhblVwKTsKICAgIH0KfSkoKTs=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPBody>
      </HTTPResponse>
    </HTTPTask>
    <HTTPTask id="22" hostname="demo.borland.com" path="/InsuranceWebExtJS/ext/ext-all-debug.js" url="http://demo.borland.com/InsuranceWebExtJS/ext/ext-all-debug.js" ip="143.186.120.171" port="80" client_ip="192.168.0.123" client_port="15236" connectionId="1816" origin="HTML" encodingType="ANSI" ordinal="3" startDateTime="2019-02-27T16:49:29.185+05:30" startTime="3826" endTime="5089" blockedTime="0" dnsTime="0" connectTime="0" sendTime="0" waitTime="0" receiveTime="0" sslNegotiateTime="0" responseBodySize="0">
      <HTTPRequest method="GET">
        <HTTPHeaders>
          <HTTPHeaderEntity name="Referer" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>aHR0cDovL2RlbW8uYm9ybGFuZC5jb20vSW5zdXJhbmNlV2ViRXh0SlMvYWdlbnRfbG9va3VwLmpzZg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="User-Agent" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzcyLjAuMzYyNi4xMTkgU2FmYXJpLzUzNy4zNg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Encoding" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Z3ppcCwgZGVmbGF0ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Language" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZW4tVVMsZW47cT0wLjk=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ki8q</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Connection" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>S2VlcC1BbGl2ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Host" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZGVtby5ib3JsYW5kLmNvbQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Cookie" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFC</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>R0VUIC9JbnN1cmFuY2VXZWJFeHRKUy9leHQvZXh0LWFsbC1kZWJ1Zy5qcyBIVFRQLzEuMQ0KUmVmZXJlcjogaHR0cDovL2RlbW8uYm9ybGFuZC5jb20vSW5zdXJhbmNlV2ViRXh0SlMvYWdlbnRfbG9va3VwLmpzZg0KVXNlci1BZ2VudDogTW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzcyLjAuMzYyNi4xMTkgU2FmYXJpLzUzNy4zNg0KQWNjZXB0LUVuY29kaW5nOiBnemlwLCBkZWZsYXRlDQpBY2NlcHQtTGFuZ3VhZ2U6IGVuLVVTLGVuO3E9MC45DQpBY2NlcHQ6ICovKg0KQ29ubmVjdGlvbjogS2VlcC1BbGl2ZQ0KSG9zdDogZGVtby5ib3JsYW5kLmNvbQ0KQ29va2llOiBKU0VTU0lPTklEPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFCOyBVc2VyU2Vzc2lvbkZpbHRlci5zZXNzaW9uSWQ9RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUINCg0K</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
          <HTTPCookies>
            <HTTPHeaderEntity name="JSESSIONID" index="0">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
            <HTTPHeaderEntity name="UserSessionFilter.sessionId" index="1">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
          </HTTPCookies>
        </HTTPHeaders>
      </HTTPRequest>
      <HTTPResponse>
        <contentLenght>1408181</contentLenght>
        <HTTPHeaders>
          <HTTPHeaderEntity name="Content-Length" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>MTQwODE4MQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Content-Type" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>YXBwbGljYXRpb24vamF2YXNjcmlwdA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Last-Modified" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TW9uLCAyMSBKYW4gMjAxMyAxMjozMDo0NCBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Ranges" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ynl0ZXM=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="ETag" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Vy8iMTQwODE4MS0xMzU4NzcxNDQ0MDAwIg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Server" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TWljcm9zb2Z0LUlJUy83LjU=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-Powered-By" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>QVNQLk5FVA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-FRAME-OPTIONS" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>U0FNRU9SSUdJTg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Date" index="8">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>V2VkLCAyNyBGZWIgMjAxOSAxMToxODo1NyBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTQwODE4MQ0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpMYXN0LU1vZGlmaWVkOiBNb24sIDIxIEphbiAyMDEzIDEyOjMwOjQ0IEdNVA0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkVUYWc6IFcvIjE0MDgxODEtMTM1ODc3MTQ0NDAwMCINClNlcnZlcjogTWljcm9zb2Z0LUlJUy83LjUNClgtUG93ZXJlZC1CeTogQVNQLk5FVA0KWC1GUkFNRS1PUFRJT05TOiBTQU1FT1JJR0lODQpEYXRlOiBXZWQsIDI3IEZlYiAyMDE5IDExOjE4OjU3IEdNVA0KDQo=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
        </HTTPHeaders>
        <HTTPBody>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>CihmdW5jdGlvbigpewoKdmFyIEVYVFVUSUwgPSBFeHQudXRpbCwKICAgIEVBQ0ggPSBFeHQuZWFjaCwKICAgIFRSVUUgPSB0cnVlLAogICAgRkFMU0UgPSBmYWxzZTsKCkVYVFVUSUwuT2JzZXJ2YWJsZSA9IGZ1bmN0aW9uKCl7CiAgICAKICAgIHZhciBtZSA9IHRoaXMsIGUgPSBtZS5ldmVudHM7CiAgICBpZihtZS5saXN0ZW5lcnMpewogICAgICAgIG1lLm9uKG1lLmxpc3RlbmVycyk7CiAgICAgICAgZGVsZXRlIG1lLmxpc3RlbmVyczsKICAgIH0KICAgIG1lLmV2ZW50cyA9IGUgfHwge307Cn07CgpFWFRVVElMLk9ic2VydmFibGUucHJvdG90eXBlID0gewogICAgCiAgICBmaWx0ZXJPcHRSZSA6IC9eKD86c2NvcGV8ZGVsYXl8YnVmZmVyfHNpbmdsZSkkLywKCiAgICAKICAgIGZpcmVFdmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGEgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApLAogICAgICAgICAgICBlbmFtZSA9IGFbMF0udG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgbWUgPSB0aGlzLAogICAgICAgICAgICByZXQgPSBUUlVFLAogICAgICAgICAgICBjZSA9IG1lLmV2ZW50c1tlbmFtZV0sCiAgICAgICAgICAgIGNjLAogICAgICAgICAgICBxLAogICAgICAgICAgICBjOwogICAgICAgIGlmIChtZS5ldmVudHNTdXNwZW5kZWQgPT09IFRSVUUpIHsKICAgICAgICAgICAgaWYgKHEgPSBtZS5ldmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgICBxLnB1c2goYSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZih0eXBlb2YgY2UgPT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgaWYgKGNlLmJ1YmJsZSl7CiAgICAgICAgICAgICAgICBpZihjZS5maXJlLmFwcGx5KGNlLCBhLnNsaWNlKDEpKSA9PT0gRkFMU0UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRkFMU0U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjID0gbWUuZ2V0QnViYmxlVGFyZ2V0ICYmIG1lLmdldEJ1YmJsZVRhcmdldCgpOwogICAgICAgICAgICAgICAgaWYoYyAmJiBjLmVuYWJsZUJ1YmJsZSkgewogICAgICAgICAgICAgICAgICAgIGNjID0gYy5ldmVudHNbZW5hbWVdOwogICAgICAgICAgICAgICAgICAgIGlmKCFjYyB8fCB0eXBlb2YgY2MgIT0gJ29iamVjdCcgfHwgIWNjLmJ1YmJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjLmVuYWJsZUJ1YmJsZShlbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBjLmZpcmVFdmVudC5hcHBseShjLCBhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGEuc2hpZnQoKTsKICAgICAgICAgICAgICAgIHJldCA9IGNlLmZpcmUuYXBwbHkoY2UsIGEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQ7CiAgICB9LAoKICAgIAogICAgYWRkTGlzdGVuZXIgOiBmdW5jdGlvbihldmVudE5hbWUsIGZuLCBzY29wZSwgbyl7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgZSwKICAgICAgICAgICAgb2UsCiAgICAgICAgICAgIGNlOwogICAgICAgICAgICAKICAgICAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSA9PSAnb2JqZWN0JykgewogICAgICAgICAgICBvID0gZXZlbnROYW1lOwogICAgICAgICAgICBmb3IgKGUgaW4gbykgewogICAgICAgICAgICAgICAgb2UgPSBvW2VdOwogICAgICAgICAgICAgICAgaWYgKCFtZS5maWx0ZXJPcHRSZS50ZXN0KGUpKSB7CiAgICAgICAgICAgICAgICAgICAgbWUuYWRkTGlzdGVuZXIoZSwgb2UuZm4gfHwgb2UsIG9lLnNjb3BlIHx8IG8uc2NvcGUsIG9lLmZuID8gb2UgOiBvKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBjZSA9IG1lLmV2ZW50c1tldmVudE5hbWVdIHx8IFRSVUU7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2UgPT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgICAgICBtZS5ldmVudHNbZXZlbnROYW1lXSA9IGNlID0gbmV3IEVYVFVUSUwuRXZlbnQobWUsIGV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2UuYWRkTGlzdGVuZXIoZm4sIHNjb3BlLCB0eXBlb2YgbyA9PSAnb2JqZWN0JyA/IG8gOiB7fSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHJlbW92ZUxpc3RlbmVyIDogZnVuY3Rpb24oZXZlbnROYW1lLCBmbiwgc2NvcGUpewogICAgICAgIHZhciBjZSA9IHRoaXMuZXZlbnRzW2V2ZW50TmFtZS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICBpZiAodHlwZW9mIGNlID09ICdvYmplY3QnKSB7CiAgICAgICAgICAgIGNlLnJlbW92ZUxpc3RlbmVyKGZuLCBzY29wZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHB1cmdlTGlzdGVuZXJzIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgZXZlbnRzID0gdGhpcy5ldmVudHMsCiAgICAgICAgICAgIGV2dCwKICAgICAgICAgICAga2V5OwogICAgICAgIGZvcihrZXkgaW4gZXZlbnRzKXsKICAgICAgICAgICAgZXZ0ID0gZXZlbnRzW2tleV07CiAgICAgICAgICAgIGlmKHR5cGVvZiBldnQgPT0gJ29iamVjdCcpewogICAgICAgICAgICAgICAgZXZ0LmNsZWFyTGlzdGVuZXJzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYWRkRXZlbnRzIDogZnVuY3Rpb24obyl7CiAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICBtZS5ldmVudHMgPSBtZS5ldmVudHMgfHwge307CiAgICAgICAgaWYgKHR5cGVvZiBvID09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHZhciBhID0gYXJndW1lbnRzLAogICAgICAgICAgICAgICAgaSA9IGEubGVuZ3RoOwogICAgICAgICAgICB3aGlsZShpLS0pIHsKICAgICAgICAgICAgICAgIG1lLmV2ZW50c1thW2ldXSA9IG1lLmV2ZW50c1thW2ldXSB8fCBUUlVFOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgRXh0LmFwcGx5SWYobWUuZXZlbnRzLCBvKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaGFzTGlzdGVuZXIgOiBmdW5jdGlvbihldmVudE5hbWUpewogICAgICAgIHZhciBlID0gdGhpcy5ldmVudHNbZXZlbnROYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgIHJldHVybiB0eXBlb2YgZSA9PSAnb2JqZWN0JyAmJiBlLmxpc3RlbmVycy5sZW5ndGggPiAwOwogICAgfSwKCiAgICAKICAgIHN1c3BlbmRFdmVudHMgOiBmdW5jdGlvbihxdWV1ZVN1c3BlbmRlZCl7CiAgICAgICAgdGhpcy5ldmVudHNTdXNwZW5kZWQgPSBUUlVFOwogICAgICAgIGlmKHF1ZXVlU3VzcGVuZGVkICYmICF0aGlzLmV2ZW50UXVldWUpewogICAgICAgICAgICB0aGlzLmV2ZW50UXVldWUgPSBbXTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVzdW1lRXZlbnRzIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBxdWV1ZWQgPSBtZS5ldmVudFF1ZXVlIHx8IFtdOwogICAgICAgIG1lLmV2ZW50c1N1c3BlbmRlZCA9IEZBTFNFOwogICAgICAgIGRlbGV0ZSBtZS5ldmVudFF1ZXVlOwogICAgICAgIEVBQ0gocXVldWVkLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIG1lLmZpcmVFdmVudC5hcHBseShtZSwgZSk7CiAgICAgICAgfSk7CiAgICB9Cn07Cgp2YXIgT0JTRVJWQUJMRSA9IEVYVFVUSUwuT2JzZXJ2YWJsZS5wcm90b3R5cGU7CgpPQlNFUlZBQkxFLm9uID0gT0JTRVJWQUJMRS5hZGRMaXN0ZW5lcjsKCk9CU0VSVkFCTEUudW4gPSBPQlNFUlZBQkxFLnJlbW92ZUxpc3RlbmVyOwoKCkVYVFVUSUwuT2JzZXJ2YWJsZS5yZWxlYXNlQ2FwdHVyZSA9IGZ1bmN0aW9uKG8pewogICAgby5maXJlRXZlbnQgPSBPQlNFUlZBQkxFLmZpcmVFdmVudDsKfTsKCmZ1bmN0aW9uIGNyZWF0ZVRhcmdldGVkKGgsIG8sIHNjb3BlKXsKICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgIGlmKG8udGFyZ2V0ID09IGFyZ3VtZW50c1swXSl7CiAgICAgICAgICAgIGguYXBwbHkoc2NvcGUsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpOwogICAgICAgIH0KICAgIH07Cn07CgpmdW5jdGlvbiBjcmVhdGVCdWZmZXJlZChoLCBvLCBsLCBzY29wZSl7CiAgICBsLnRhc2sgPSBuZXcgRVhUVVRJTC5EZWxheWVkVGFzaygpOwogICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgICAgbC50YXNrLmRlbGF5KG8uYnVmZmVyLCBoLCBzY29wZSwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7CiAgICB9Owp9OwoKZnVuY3Rpb24gY3JlYXRlU2luZ2xlKGgsIGUsIGZuLCBzY29wZSl7CiAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgICBlLnJlbW92ZUxpc3RlbmVyKGZuLCBzY29wZSk7CiAgICAgICAgcmV0dXJuIGguYXBwbHkoc2NvcGUsIGFyZ3VtZW50cyk7CiAgICB9Owp9OwoKZnVuY3Rpb24gY3JlYXRlRGVsYXllZChoLCBvLCBsLCBzY29wZSl7CiAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdGFzayA9IG5ldyBFWFRVVElMLkRlbGF5ZWRUYXNrKCksCiAgICAgICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgIGlmKCFsLnRhc2tzKSB7CiAgICAgICAgICAgIGwudGFza3MgPSBbXTsKICAgICAgICB9CiAgICAgICAgbC50YXNrcy5wdXNoKHRhc2spOwogICAgICAgIHRhc2suZGVsYXkoby5kZWxheSB8fCAxMCwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgbC50YXNrcy5yZW1vdmUodGFzayk7CiAgICAgICAgICAgIGguYXBwbHkoc2NvcGUsIGFyZ3MpOwogICAgICAgIH0sIHNjb3BlKTsKICAgIH07Cn07CgpFWFRVVElMLkV2ZW50ID0gZnVuY3Rpb24ob2JqLCBuYW1lKXsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB0aGlzLm9iaiA9IG9iajsKICAgIHRoaXMubGlzdGVuZXJzID0gW107Cn07CgpFWFRVVElMLkV2ZW50LnByb3RvdHlwZSA9IHsKICAgIGFkZExpc3RlbmVyIDogZnVuY3Rpb24oZm4sIHNjb3BlLCBvcHRpb25zKXsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBsOwogICAgICAgIHNjb3BlID0gc2NvcGUgfHwgbWUub2JqOwogICAgICAgIGlmKCFtZS5pc0xpc3RlbmluZyhmbiwgc2NvcGUpKXsKICAgICAgICAgICAgbCA9IG1lLmNyZWF0ZUxpc3RlbmVyKGZuLCBzY29wZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmKG1lLmZpcmluZyl7IAogICAgICAgICAgICAgICAgbWUubGlzdGVuZXJzID0gbWUubGlzdGVuZXJzLnNsaWNlKDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1lLmxpc3RlbmVycy5wdXNoKGwpOwogICAgICAgIH0KICAgIH0sCgogICAgY3JlYXRlTGlzdGVuZXI6IGZ1bmN0aW9uKGZuLCBzY29wZSwgbyl7CiAgICAgICAgbyA9IG8gfHwge307CiAgICAgICAgc2NvcGUgPSBzY29wZSB8fCB0aGlzLm9iajsKICAgICAgICB2YXIgbCA9IHsKICAgICAgICAgICAgZm46IGZuLAogICAgICAgICAgICBzY29wZTogc2NvcGUsCiAgICAgICAgICAgIG9wdGlvbnM6IG8KICAgICAgICB9LCBoID0gZm47CiAgICAgICAgaWYoby50YXJnZXQpewogICAgICAgICAgICBoID0gY3JlYXRlVGFyZ2V0ZWQoaCwgbywgc2NvcGUpOwogICAgICAgIH0KICAgICAgICBpZihvLmRlbGF5KXsKICAgICAgICAgICAgaCA9IGNyZWF0ZURlbGF5ZWQoaCwgbywgbCwgc2NvcGUpOwogICAgICAgIH0KICAgICAgICBpZihvLnNpbmdsZSl7CiAgICAgICAgICAgIGggPSBjcmVhdGVTaW5nbGUoaCwgdGhpcywgZm4sIHNjb3BlKTsKICAgICAgICB9CiAgICAgICAgaWYoby5idWZmZXIpewogICAgICAgICAgICBoID0gY3JlYXRlQnVmZmVyZWQoaCwgbywgbCwgc2NvcGUpOwogICAgICAgIH0KICAgICAgICBsLmZpcmVGbiA9IGg7CiAgICAgICAgcmV0dXJuIGw7CiAgICB9LAoKICAgIGZpbmRMaXN0ZW5lciA6IGZ1bmN0aW9uKGZuLCBzY29wZSl7CiAgICAgICAgdmFyIGxpc3QgPSB0aGlzLmxpc3RlbmVycywKICAgICAgICAgICAgaSA9IGxpc3QubGVuZ3RoLAogICAgICAgICAgICBsOwoKICAgICAgICBzY29wZSA9IHNjb3BlIHx8IHRoaXMub2JqOwogICAgICAgIHdoaWxlKGktLSl7CiAgICAgICAgICAgIGwgPSBsaXN0W2ldOwogICAgICAgICAgICBpZihsKXsKICAgICAgICAgICAgICAgIGlmKGwuZm4gPT0gZm4gJiYgbC5zY29wZSA9PSBzY29wZSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIC0xOwogICAgfSwKCiAgICBpc0xpc3RlbmluZyA6IGZ1bmN0aW9uKGZuLCBzY29wZSl7CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZExpc3RlbmVyKGZuLCBzY29wZSkgIT0gLTE7CiAgICB9LAoKICAgIHJlbW92ZUxpc3RlbmVyIDogZnVuY3Rpb24oZm4sIHNjb3BlKXsKICAgICAgICB2YXIgaW5kZXgsCiAgICAgICAgICAgIGwsCiAgICAgICAgICAgIGssCiAgICAgICAgICAgIG1lID0gdGhpcywKICAgICAgICAgICAgcmV0ID0gRkFMU0U7CiAgICAgICAgaWYoKGluZGV4ID0gbWUuZmluZExpc3RlbmVyKGZuLCBzY29wZSkpICE9IC0xKXsKICAgICAgICAgICAgaWYgKG1lLmZpcmluZykgewogICAgICAgICAgICAgICAgbWUubGlzdGVuZXJzID0gbWUubGlzdGVuZXJzLnNsaWNlKDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGwgPSBtZS5saXN0ZW5lcnNbaW5kZXhdOwogICAgICAgICAgICBpZihsLnRhc2spIHsKICAgICAgICAgICAgICAgIGwudGFzay5jYW5jZWwoKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBsLnRhc2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgayA9IGwudGFza3MgJiYgbC50YXNrcy5sZW5ndGg7CiAgICAgICAgICAgIGlmKGspIHsKICAgICAgICAgICAgICAgIHdoaWxlKGstLSkgewogICAgICAgICAgICAgICAgICAgIGwudGFza3Nba10uY2FuY2VsKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWxldGUgbC50YXNrczsKICAgICAgICAgICAgfQogICAgICAgICAgICBtZS5saXN0ZW5lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgcmV0ID0gVFJVRTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0sCgogICAgCiAgICBjbGVhckxpc3RlbmVycyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgbCA9IG1lLmxpc3RlbmVycywKICAgICAgICAgICAgaSA9IGwubGVuZ3RoOwogICAgICAgIHdoaWxlKGktLSkgewogICAgICAgICAgICBtZS5yZW1vdmVMaXN0ZW5lcihsW2ldLmZuLCBsW2ldLnNjb3BlKTsKICAgICAgICB9CiAgICB9LAoKICAgIGZpcmUgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgIGxpc3RlbmVycyA9IG1lLmxpc3RlbmVycywKICAgICAgICAgICAgbGVuID0gbGlzdGVuZXJzLmxlbmd0aCwKICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgIGw7CgogICAgICAgIGlmKGxlbiA+IDApewogICAgICAgICAgICBtZS5maXJpbmcgPSBUUlVFOwogICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGwgPSBsaXN0ZW5lcnNbaV07CiAgICAgICAgICAgICAgICBpZihsICYmIGwuZmlyZUZuLmFwcGx5KGwuc2NvcGUgfHwgbWUub2JqIHx8IHdpbmRvdywgYXJncykgPT09IEZBTFNFKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChtZS5maXJpbmcgPSBGQUxTRSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbWUuZmlyaW5nID0gRkFMU0U7CiAgICAgICAgcmV0dXJuIFRSVUU7CiAgICB9Cgp9Owp9KSgpOwoKRXh0LkRvbUhlbHBlciA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgdGVtcFRhYmxlRWwgPSBudWxsLAogICAgICAgIGVtcHR5VGFncyA9IC9eKD86YnJ8ZnJhbWV8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxyYW5nZXxzcGFjZXJ8d2JyfGFyZWF8cGFyYW18Y29sKSQvaSwKICAgICAgICB0YWJsZVJlID0gL150YWJsZXx0Ym9keXx0cnx0ZCQvaSwKICAgICAgICBjb25mUmUgPSAvdGFnfGNoaWxkcmVufGNufGh0bWwkL2ksCiAgICAgICAgdGFibGVFbFJlID0gL3RkfHRyfHRib2R5L2ksCiAgICAgICAgY3NzUmUgPSAvKFthLXowLTktXSspXHMqOlxzKihbXjtcc10rKD86XHMqW147XHNdKykqKTs/L2dpLAogICAgICAgIGVuZFJlID0gL2VuZC9pLAogICAgICAgIHB1YiwKICAgICAgICAKICAgICAgICBhZnRlcmJlZ2luID0gJ2FmdGVyYmVnaW4nLAogICAgICAgIGFmdGVyZW5kID0gJ2FmdGVyZW5kJywKICAgICAgICBiZWZvcmViZWdpbiA9ICdiZWZvcmViZWdpbicsCiAgICAgICAgYmVmb3JlZW5kID0gJ2JlZm9yZWVuZCcsCiAgICAgICAgdHMgPSAnPHRhYmxlPicsCiAgICAgICAgdGUgPSAnPC90YWJsZT4nLAogICAgICAgIHRicyA9IHRzKyc8dGJvZHk+JywKICAgICAgICB0YmUgPSAnPC90Ym9keT4nK3RlLAogICAgICAgIHRycyA9IHRicyArICc8dHI+JywKICAgICAgICB0cmUgPSAnPC90cj4nK3RiZTsKCiAgICAKICAgIGZ1bmN0aW9uIGRvSW5zZXJ0KGVsLCBvLCByZXR1cm5FbGVtZW50LCBwb3MsIHNpYmxpbmcsIGFwcGVuZCl7CiAgICAgICAgdmFyIG5ld05vZGUgPSBwdWIuaW5zZXJ0SHRtbChwb3MsIEV4dC5nZXREb20oZWwpLCBjcmVhdGVIdG1sKG8pKTsKICAgICAgICByZXR1cm4gcmV0dXJuRWxlbWVudCA/IEV4dC5nZXQobmV3Tm9kZSwgdHJ1ZSkgOiBuZXdOb2RlOwogICAgfQoKICAgIAogICAgZnVuY3Rpb24gY3JlYXRlSHRtbChvKXsKICAgICAgICB2YXIgYiA9ICcnLAogICAgICAgICAgICBhdHRyLAogICAgICAgICAgICB2YWwsCiAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgY247CgogICAgICAgIGlmKHR5cGVvZiBvID09ICJzdHJpbmciKXsKICAgICAgICAgICAgYiA9IG87CiAgICAgICAgfSBlbHNlIGlmIChFeHQuaXNBcnJheShvKSkgewogICAgICAgICAgICBmb3IgKHZhciBpPTA7IGkgPCBvLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZihvW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgYiArPSBjcmVhdGVIdG1sKG9baV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGIgKz0gJzwnICsgKG8udGFnID0gby50YWcgfHwgJ2RpdicpOwogICAgICAgICAgICBmb3IgKGF0dHIgaW4gbykgewogICAgICAgICAgICAgICAgdmFsID0gb1thdHRyXTsKICAgICAgICAgICAgICAgIGlmKCFjb25mUmUudGVzdChhdHRyKSl7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYiArPSAnICcgKyBhdHRyICsgJz0iJzsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiICs9IGtleSArICc6JyArIHZhbFtrZXldICsgJzsnOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBiICs9ICciJzsKICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgYiArPSAnICcgKyAoe2NscyA6ICdjbGFzcycsIGh0bWxGb3IgOiAnZm9yJ31bYXR0cl0gfHwgYXR0cikgKyAnPSInICsgdmFsICsgJyInOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChlbXB0eVRhZ3MudGVzdChvLnRhZykpIHsKICAgICAgICAgICAgICAgIGIgKz0gJy8+JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGIgKz0gJz4nOwogICAgICAgICAgICAgICAgaWYgKChjbiA9IG8uY2hpbGRyZW4gfHwgby5jbikpIHsKICAgICAgICAgICAgICAgICAgICBiICs9IGNyZWF0ZUh0bWwoY24pOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKG8uaHRtbCl7CiAgICAgICAgICAgICAgICAgICAgYiArPSBvLmh0bWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBiICs9ICc8LycgKyBvLnRhZyArICc+JzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYjsKICAgIH0KCiAgICBmdW5jdGlvbiBpZVRhYmxlKGRlcHRoLCBzLCBoLCBlKXsKICAgICAgICB0ZW1wVGFibGVFbC5pbm5lckhUTUwgPSBbcywgaCwgZV0uam9pbignJyk7CiAgICAgICAgdmFyIGkgPSAtMSwKICAgICAgICAgICAgZWwgPSB0ZW1wVGFibGVFbCwKICAgICAgICAgICAgbnM7CiAgICAgICAgd2hpbGUoKytpIDwgZGVwdGgpewogICAgICAgICAgICBlbCA9IGVsLmZpcnN0Q2hpbGQ7CiAgICAgICAgfQoKICAgICAgICBpZihucyA9IGVsLm5leHRTaWJsaW5nKXsKICAgICAgICAgICAgdmFyIGRmID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgICB3aGlsZShlbCl7CiAgICAgICAgICAgICAgICBucyA9IGVsLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgZGYuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICAgICAgZWwgPSBuczsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbCA9IGRmOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZWw7CiAgICB9CgogICAgCiAgICBmdW5jdGlvbiBpbnNlcnRJbnRvVGFibGUodGFnLCB3aGVyZSwgZWwsIGh0bWwpIHsKICAgICAgICB2YXIgbm9kZSwKICAgICAgICAgICAgYmVmb3JlOwoKICAgICAgICB0ZW1wVGFibGVFbCA9IHRlbXBUYWJsZUVsIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKICAgICAgICBpZih0YWcgPT0gJ3RkJyAmJiAod2hlcmUgPT0gYWZ0ZXJiZWdpbiB8fCB3aGVyZSA9PSBiZWZvcmVlbmQpIHx8CiAgICAgICAgICAgIXRhYmxlRWxSZS50ZXN0KHRhZykgJiYgKHdoZXJlID09IGJlZm9yZWJlZ2luIHx8IHdoZXJlID09IGFmdGVyZW5kKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGJlZm9yZSA9IHdoZXJlID09IGJlZm9yZWJlZ2luID8gZWwgOgogICAgICAgICAgICAgICAgIHdoZXJlID09IGFmdGVyZW5kID8gZWwubmV4dFNpYmxpbmcgOgogICAgICAgICAgICAgICAgIHdoZXJlID09IGFmdGVyYmVnaW4gPyBlbC5maXJzdENoaWxkIDogbnVsbDsKCiAgICAgICAgaWYgKHdoZXJlID09IGJlZm9yZWJlZ2luIHx8IHdoZXJlID09IGFmdGVyZW5kKSB7CiAgICAgICAgICAgIGVsID0gZWwucGFyZW50Tm9kZTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWcgPT0gJ3RkJyB8fCAodGFnID09ICd0cicgJiYgKHdoZXJlID09IGJlZm9yZWVuZCB8fCB3aGVyZSA9PSBhZnRlcmJlZ2luKSkpIHsKICAgICAgICAgICAgbm9kZSA9IGllVGFibGUoNCwgdHJzLCBodG1sLCB0cmUpOwogICAgICAgIH0gZWxzZSBpZiAoKHRhZyA9PSAndGJvZHknICYmICh3aGVyZSA9PSBiZWZvcmVlbmQgfHwgd2hlcmUgPT0gYWZ0ZXJiZWdpbikpIHx8CiAgICAgICAgICAgICAgICAgICAodGFnID09ICd0cicgJiYgKHdoZXJlID09IGJlZm9yZWJlZ2luIHx8IHdoZXJlID09IGFmdGVyZW5kKSkpIHsKICAgICAgICAgICAgbm9kZSA9IGllVGFibGUoMywgdGJzLCBodG1sLCB0YmUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5vZGUgPSBpZVRhYmxlKDIsIHRzLCBodG1sLCB0ZSk7CiAgICAgICAgfQogICAgICAgIGVsLmluc2VydEJlZm9yZShub2RlLCBiZWZvcmUpOwogICAgICAgIHJldHVybiBub2RlOwogICAgfQoKICAgICAgIAogICAgZnVuY3Rpb24gY3JlYXRlQ29udGV4dHVhbEZyYWdtZW50KGh0bWwpewogICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwKICAgICAgICAgICAgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICBsZW5ndGgsIGNoaWxkTm9kZXM7CiAgICAgICAgCiAgICAgICAgZGl2LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgY2hpbGROb2RlcyA9IGRpdi5jaGlsZE5vZGVzOwogICAgICAgIGxlbmd0aCA9IGNoaWxkTm9kZXMubGVuZ3RoOwogICAgICAgIAogICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoY2hpbGROb2Rlc1tpXS5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gZnJhZ21lbnQ7CiAgICB9CiAgICAKICAgIHB1YiA9IHsKICAgICAgICAKICAgICAgICBtYXJrdXAgOiBmdW5jdGlvbihvKXsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUh0bWwobyk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgYXBwbHlTdHlsZXMgOiBmdW5jdGlvbihlbCwgc3R5bGVzKXsKICAgICAgICAgICAgaWYgKHN0eWxlcykgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoZXM7CgogICAgICAgICAgICAgICAgZWwgPSBFeHQuZmx5KGVsKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc3R5bGVzID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBzdHlsZXMgPSBzdHlsZXMuY2FsbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzdHlsZXMgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjc3NSZS5sYXN0SW5kZXggPSAwOwogICAgICAgICAgICAgICAgICAgIHdoaWxlICgobWF0Y2hlcyA9IGNzc1JlLmV4ZWMoc3R5bGVzKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0U3R5bGUobWF0Y2hlc1sxXSwgbWF0Y2hlc1syXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3R5bGVzID09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgZWwuc2V0U3R5bGUoc3R5bGVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgaW5zZXJ0SHRtbCA6IGZ1bmN0aW9uKHdoZXJlLCBlbCwgaHRtbCl7CiAgICAgICAgICAgIHZhciBoYXNoID0ge30sCiAgICAgICAgICAgICAgICBoYXNoVmFsLAogICAgICAgICAgICAgICAgcmFuZ2UsCiAgICAgICAgICAgICAgICByYW5nZUVsLAogICAgICAgICAgICAgICAgc2V0U3RhcnQsCiAgICAgICAgICAgICAgICBmcmFnLAogICAgICAgICAgICAgICAgcnM7CgogICAgICAgICAgICB3aGVyZSA9IHdoZXJlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBoYXNoW2JlZm9yZWJlZ2luXSA9IFsnQmVmb3JlQmVnaW4nLCAncHJldmlvdXNTaWJsaW5nJ107CiAgICAgICAgICAgIGhhc2hbYWZ0ZXJlbmRdID0gWydBZnRlckVuZCcsICduZXh0U2libGluZyddOwoKICAgICAgICAgICAgaWYgKGVsLmluc2VydEFkamFjZW50SFRNTCkgewogICAgICAgICAgICAgICAgaWYodGFibGVSZS50ZXN0KGVsLnRhZ05hbWUpICYmIChycyA9IGluc2VydEludG9UYWJsZShlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCksIHdoZXJlLCBlbCwgaHRtbCkpKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcnM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhhc2hbYWZ0ZXJiZWdpbl0gPSBbJ0FmdGVyQmVnaW4nLCAnZmlyc3RDaGlsZCddOwogICAgICAgICAgICAgICAgaGFzaFtiZWZvcmVlbmRdID0gWydCZWZvcmVFbmQnLCAnbGFzdENoaWxkJ107CiAgICAgICAgICAgICAgICBpZiAoKGhhc2hWYWwgPSBoYXNoW3doZXJlXSkpIHsKICAgICAgICAgICAgICAgICAgICBlbC5pbnNlcnRBZGphY2VudEhUTUwoaGFzaFZhbFswXSwgaHRtbCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsW2hhc2hWYWxbMV1dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmFuZ2UgPSBlbC5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICAgICAgICBzZXRTdGFydCA9ICdzZXRTdGFydCcgKyAoZW5kUmUudGVzdCh3aGVyZSkgPyAnQWZ0ZXInIDogJ0JlZm9yZScpOwogICAgICAgICAgICAgICAgaWYgKGhhc2hbd2hlcmVdKSB7CiAgICAgICAgICAgICAgICAgICAgcmFuZ2Vbc2V0U3RhcnRdKGVsKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXJhbmdlLmNyZWF0ZUNvbnRleHR1YWxGcmFnbWVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBmcmFnID0gY3JlYXRlQ29udGV4dHVhbEZyYWdtZW50KGh0bWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJhZyA9IHJhbmdlLmNyZWF0ZUNvbnRleHR1YWxGcmFnbWVudChodG1sKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWwucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZnJhZywgd2hlcmUgPT0gYmVmb3JlYmVnaW4gPyBlbCA6IGVsLm5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxbKHdoZXJlID09IGJlZm9yZWJlZ2luID8gJ3ByZXZpb3VzJyA6ICduZXh0JykgKyAnU2libGluZyddOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByYW5nZUVsID0gKHdoZXJlID09IGFmdGVyYmVnaW4gPyAnZmlyc3QnIDogJ2xhc3QnKSArICdDaGlsZCc7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Vbc2V0U3RhcnRdKGVsW3JhbmdlRWxdKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyYW5nZS5jcmVhdGVDb250ZXh0dWFsRnJhZ21lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWcgPSBjcmVhdGVDb250ZXh0dWFsRnJhZ21lbnQoaHRtbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnID0gcmFuZ2UuY3JlYXRlQ29udGV4dHVhbEZyYWdtZW50KGh0bWwpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHdoZXJlID09IGFmdGVyYmVnaW4pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuaW5zZXJ0QmVmb3JlKGZyYWcsIGVsLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKGZyYWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWwuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsW3JhbmdlRWxdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93ICdJbGxlZ2FsIGluc2VydGlvbiBwb2ludCAtPiAiJyArIHdoZXJlICsgJyInOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGluc2VydEJlZm9yZSA6IGZ1bmN0aW9uKGVsLCBvLCByZXR1cm5FbGVtZW50KXsKICAgICAgICAgICAgcmV0dXJuIGRvSW5zZXJ0KGVsLCBvLCByZXR1cm5FbGVtZW50LCBiZWZvcmViZWdpbik7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaW5zZXJ0QWZ0ZXIgOiBmdW5jdGlvbihlbCwgbywgcmV0dXJuRWxlbWVudCl7CiAgICAgICAgICAgIHJldHVybiBkb0luc2VydChlbCwgbywgcmV0dXJuRWxlbWVudCwgYWZ0ZXJlbmQsICduZXh0U2libGluZycpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGluc2VydEZpcnN0IDogZnVuY3Rpb24oZWwsIG8sIHJldHVybkVsZW1lbnQpewogICAgICAgICAgICByZXR1cm4gZG9JbnNlcnQoZWwsIG8sIHJldHVybkVsZW1lbnQsIGFmdGVyYmVnaW4sICdmaXJzdENoaWxkJyk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgYXBwZW5kIDogZnVuY3Rpb24oZWwsIG8sIHJldHVybkVsZW1lbnQpewogICAgICAgICAgICByZXR1cm4gZG9JbnNlcnQoZWwsIG8sIHJldHVybkVsZW1lbnQsIGJlZm9yZWVuZCwgJycsIHRydWUpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIG92ZXJ3cml0ZSA6IGZ1bmN0aW9uKGVsLCBvLCByZXR1cm5FbGVtZW50KXsKICAgICAgICAgICAgZWwgPSBFeHQuZ2V0RG9tKGVsKTsKICAgICAgICAgICAgZWwuaW5uZXJIVE1MID0gY3JlYXRlSHRtbChvKTsKICAgICAgICAgICAgcmV0dXJuIHJldHVybkVsZW1lbnQgPyBFeHQuZ2V0KGVsLmZpcnN0Q2hpbGQpIDogZWwuZmlyc3RDaGlsZDsKICAgICAgICB9LAoKICAgICAgICBjcmVhdGVIdG1sIDogY3JlYXRlSHRtbAogICAgfTsKICAgIHJldHVybiBwdWI7Cn0oKTsKCkV4dC5UZW1wbGF0ZSA9IGZ1bmN0aW9uKGh0bWwpewogICAgdmFyIG1lID0gdGhpcywKICAgICAgICBhID0gYXJndW1lbnRzLAogICAgICAgIGJ1ZiA9IFtdLAogICAgICAgIHY7CgogICAgaWYgKEV4dC5pc0FycmF5KGh0bWwpKSB7CiAgICAgICAgaHRtbCA9IGh0bWwuam9pbigiIik7CiAgICB9IGVsc2UgaWYgKGEubGVuZ3RoID4gMSkgewogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGEubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICB2ID0gYVtpXTsKICAgICAgICAgICAgaWYodHlwZW9mIHYgPT0gJ29iamVjdCcpewogICAgICAgICAgICAgICAgRXh0LmFwcGx5KG1lLCB2KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJ1Zi5wdXNoKHYpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBodG1sID0gYnVmLmpvaW4oJycpOwogICAgfQoKICAgIAogICAgbWUuaHRtbCA9IGh0bWw7CiAgICAKICAgIGlmIChtZS5jb21waWxlZCkgewogICAgICAgIG1lLmNvbXBpbGUoKTsKICAgIH0KfTsKRXh0LlRlbXBsYXRlLnByb3RvdHlwZSA9IHsKICAgIAogICAgcmUgOiAvXHsoW1x3XC1dKylcfS9nLAogICAgCgogICAgCiAgICBhcHBseVRlbXBsYXRlIDogZnVuY3Rpb24odmFsdWVzKXsKICAgICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgICByZXR1cm4gbWUuY29tcGlsZWQgPwogICAgICAgICAgICAgICAgbWUuY29tcGlsZWQodmFsdWVzKSA6CiAgICAgICAgICAgICAgICBtZS5odG1sLnJlcGxhY2UobWUucmUsIGZ1bmN0aW9uKG0sIG5hbWUpewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZXNbbmFtZV0gIT09IHVuZGVmaW5lZCA/IHZhbHVlc1tuYW1lXSA6ICIiOwogICAgICAgICAgICAgICAgfSk7CiAgICB9LAoKICAgIAogICAgc2V0IDogZnVuY3Rpb24oaHRtbCwgY29tcGlsZSl7CiAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICBtZS5odG1sID0gaHRtbDsKICAgICAgICBtZS5jb21waWxlZCA9IG51bGw7CiAgICAgICAgcmV0dXJuIGNvbXBpbGUgPyBtZS5jb21waWxlKCkgOiBtZTsKICAgIH0sCgogICAgCiAgICBjb21waWxlIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBzZXAgPSBFeHQuaXNHZWNrbyA/ICIrIiA6ICIsIjsKCiAgICAgICAgZnVuY3Rpb24gZm4obSwgbmFtZSl7CiAgICAgICAgICAgIG5hbWUgPSAidmFsdWVzWyciICsgbmFtZSArICInXSI7CiAgICAgICAgICAgIHJldHVybiAiJyIrIHNlcCArICcoJyArIG5hbWUgKyAiID09IHVuZGVmaW5lZCA/ICcnIDogIiArIG5hbWUgKyAnKScgKyBzZXAgKyAiJyI7CiAgICAgICAgfQoKICAgICAgICBldmFsKCJ0aGlzLmNvbXBpbGVkID0gZnVuY3Rpb24odmFsdWVzKXsgcmV0dXJuICIgKyAoRXh0LmlzR2Vja28gPyAiJyIgOiAiWyciKSArCiAgICAgICAgICAgICBtZS5odG1sLnJlcGxhY2UoL1xcL2csICdcXFxcJykucmVwbGFjZSgvKFxyXG58XG4pL2csICdcXG4nKS5yZXBsYWNlKC8nL2csICJcXCciKS5yZXBsYWNlKHRoaXMucmUsIGZuKSArCiAgICAgICAgICAgICAoRXh0LmlzR2Vja28gPyAgIic7fTsiIDogIiddLmpvaW4oJycpO307IikpOwogICAgICAgIHJldHVybiBtZTsKICAgIH0sCgogICAgCiAgICBpbnNlcnRGaXJzdDogZnVuY3Rpb24oZWwsIHZhbHVlcywgcmV0dXJuRWxlbWVudCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZG9JbnNlcnQoJ2FmdGVyQmVnaW4nLCBlbCwgdmFsdWVzLCByZXR1cm5FbGVtZW50KTsKICAgIH0sCgogICAgCiAgICBpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKGVsLCB2YWx1ZXMsIHJldHVybkVsZW1lbnQpewogICAgICAgIHJldHVybiB0aGlzLmRvSW5zZXJ0KCdiZWZvcmVCZWdpbicsIGVsLCB2YWx1ZXMsIHJldHVybkVsZW1lbnQpOwogICAgfSwKCiAgICAKICAgIGluc2VydEFmdGVyIDogZnVuY3Rpb24oZWwsIHZhbHVlcywgcmV0dXJuRWxlbWVudCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZG9JbnNlcnQoJ2FmdGVyRW5kJywgZWwsIHZhbHVlcywgcmV0dXJuRWxlbWVudCk7CiAgICB9LAoKICAgIAogICAgYXBwZW5kIDogZnVuY3Rpb24oZWwsIHZhbHVlcywgcmV0dXJuRWxlbWVudCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZG9JbnNlcnQoJ2JlZm9yZUVuZCcsIGVsLCB2YWx1ZXMsIHJldHVybkVsZW1lbnQpOwogICAgfSwKCiAgICBkb0luc2VydCA6IGZ1bmN0aW9uKHdoZXJlLCBlbCwgdmFsdWVzLCByZXR1cm5FbCl7CiAgICAgICAgZWwgPSBFeHQuZ2V0RG9tKGVsKTsKICAgICAgICB2YXIgbmV3Tm9kZSA9IEV4dC5Eb21IZWxwZXIuaW5zZXJ0SHRtbCh3aGVyZSwgZWwsIHRoaXMuYXBwbHlUZW1wbGF0ZSh2YWx1ZXMpKTsKICAgICAgICByZXR1cm4gcmV0dXJuRWwgPyBFeHQuZ2V0KG5ld05vZGUsIHRydWUpIDogbmV3Tm9kZTsKICAgIH0sCgogICAgCiAgICBvdmVyd3JpdGUgOiBmdW5jdGlvbihlbCwgdmFsdWVzLCByZXR1cm5FbGVtZW50KXsKICAgICAgICBlbCA9IEV4dC5nZXREb20oZWwpOwogICAgICAgIGVsLmlubmVySFRNTCA9IHRoaXMuYXBwbHlUZW1wbGF0ZSh2YWx1ZXMpOwogICAgICAgIHJldHVybiByZXR1cm5FbGVtZW50ID8gRXh0LmdldChlbC5maXJzdENoaWxkLCB0cnVlKSA6IGVsLmZpcnN0Q2hpbGQ7CiAgICB9Cn07CgpFeHQuVGVtcGxhdGUucHJvdG90eXBlLmFwcGx5ID0gRXh0LlRlbXBsYXRlLnByb3RvdHlwZS5hcHBseVRlbXBsYXRlOwoKCkV4dC5UZW1wbGF0ZS5mcm9tID0gZnVuY3Rpb24oZWwsIGNvbmZpZyl7CiAgICBlbCA9IEV4dC5nZXREb20oZWwpOwogICAgcmV0dXJuIG5ldyBFeHQuVGVtcGxhdGUoZWwudmFsdWUgfHwgZWwuaW5uZXJIVE1MLCBjb25maWcgfHwgJycpOwp9OwoKCkV4dC5Eb21RdWVyeSA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgY2FjaGUgPSB7fSwgCiAgICAJc2ltcGxlQ2FjaGUgPSB7fSwgCiAgICAJdmFsdWVDYWNoZSA9IHt9LAogICAgCW5vblNwYWNlID0gL1xTLywKICAgIAl0cmltUmUgPSAvXlxzK3xccyskL2csCiAgICAJdHBsUmUgPSAvXHsoXGQrKVx9L2csCiAgICAJbW9kZVJlID0gL14oXHM/W1wvPit+XVxzP3xcc3wkKS8sCiAgICAJdGFnVG9rZW5SZSA9IC9eKCMpPyhbXHdcLVwqXSspLywKICAgIAludGhSZSA9IC8oXGQqKW5cKz8oXGQqKS8sIAogICAgCW50aFJlMiA9IC9cRC8sCiAgICAJCgkKCQoJaXNJRSA9IHdpbmRvdy5BY3RpdmVYT2JqZWN0ID8gdHJ1ZSA6IGZhbHNlLAoJa2V5ID0gMzA4MDM7CiAgICAKICAgIAogICAgCiAgICBldmFsKCJ2YXIgYmF0Y2ggPSAzMDgwMzsiKTsgICAgCQoKICAgIAogICAgCiAgICBmdW5jdGlvbiBjaGlsZChwYXJlbnQsIGluZGV4KXsKICAgICAgICB2YXIgaSA9IDAsCiAgICAgICAgICAgIG4gPSBwYXJlbnQuZmlyc3RDaGlsZDsKICAgICAgICB3aGlsZShuKXsKICAgICAgICAgICAgaWYobi5ub2RlVHlwZSA9PSAxKXsKICAgICAgICAgICAgICAgaWYoKytpID09IGluZGV4KXsKICAgICAgICAgICAgICAgICAgIHJldHVybiBuOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbiA9IG4ubmV4dFNpYmxpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIAogICAgZnVuY3Rpb24gbmV4dChuKXsJCiAgICAgICAgd2hpbGUoKG4gPSBuLm5leHRTaWJsaW5nKSAmJiBuLm5vZGVUeXBlICE9IDEpOwogICAgICAgIHJldHVybiBuOwogICAgfQoKICAgIAogICAgZnVuY3Rpb24gcHJldihuKXsKICAgICAgICB3aGlsZSgobiA9IG4ucHJldmlvdXNTaWJsaW5nKSAmJiBuLm5vZGVUeXBlICE9IDEpOwogICAgICAgIHJldHVybiBuOwogICAgfQoKICAgIAogICAgCiAgICBmdW5jdGlvbiBjaGlsZHJlbihwYXJlbnQpewogICAgICAgIHZhciBuID0gcGFyZW50LmZpcnN0Q2hpbGQsCgkgICAgbm9kZUluZGV4ID0gLTEsCgkgICAgbmV4dE5vZGU7Cgl3aGlsZShuKXsKCSAgICBuZXh0Tm9kZSA9IG4ubmV4dFNpYmxpbmc7CgkgICAgCgkgICAgaWYobi5ub2RlVHlwZSA9PSAzICYmICFub25TcGFjZS50ZXN0KG4ubm9kZVZhbHVlKSl7CgkJcGFyZW50LnJlbW92ZUNoaWxkKG4pOwoJICAgIH1lbHNlewoJCQoJCW4ubm9kZUluZGV4ID0gKytub2RlSW5kZXg7CgkgICAgfQoJICAgIG4gPSBuZXh0Tm9kZTsKCX0KCXJldHVybiB0aGlzOwogICAgfQoKCiAgICAKICAgIAogICAgZnVuY3Rpb24gYnlDbGFzc05hbWUobm9kZVNldCwgY2xzKXsKICAgICAgICBpZighY2xzKXsKICAgICAgICAgICAgcmV0dXJuIG5vZGVTZXQ7CiAgICAgICAgfQogICAgICAgIHZhciByZXN1bHQgPSBbXSwgcmkgPSAtMTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBjaTsgY2kgPSBub2RlU2V0W2ldOyBpKyspewogICAgICAgICAgICBpZigoJyAnK2NpLmNsYXNzTmFtZSsnICcpLmluZGV4T2YoY2xzKSAhPSAtMSl7CiAgICAgICAgICAgICAgICByZXN1bHRbKytyaV0gPSBjaTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKCiAgICBmdW5jdGlvbiBhdHRyVmFsdWUobiwgYXR0cil7CgkKICAgICAgICBpZighbi50YWdOYW1lICYmIHR5cGVvZiBuLmxlbmd0aCAhPSAidW5kZWZpbmVkIil7CiAgICAgICAgICAgIG4gPSBuWzBdOwogICAgICAgIH0KICAgICAgICBpZighbil7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYoYXR0ciA9PSAiZm9yIil7CiAgICAgICAgICAgIHJldHVybiBuLmh0bWxGb3I7CiAgICAgICAgfQogICAgICAgIGlmKGF0dHIgPT0gImNsYXNzIiB8fCBhdHRyID09ICJjbGFzc05hbWUiKXsKICAgICAgICAgICAgcmV0dXJuIG4uY2xhc3NOYW1lOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbi5nZXRBdHRyaWJ1dGUoYXR0cikgfHwgblthdHRyXTsKCiAgICB9OwoKCiAgICAKICAgIAogICAgCiAgICBmdW5jdGlvbiBnZXROb2RlcyhucywgbW9kZSwgdGFnTmFtZSl7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdLCByaSA9IC0xLCBjczsKICAgICAgICBpZighbnMpewogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICB0YWdOYW1lID0gdGFnTmFtZSB8fCAiKiI7CgkKICAgICAgICBpZih0eXBlb2YgbnMuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT0gInVuZGVmaW5lZCIpewogICAgICAgICAgICBucyA9IFtuc107CiAgICAgICAgfQoJCgkKCQogICAgICAgIGlmKCFtb2RlKXsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbmk7IG5pID0gbnNbaV07IGkrKyl7CiAgICAgICAgICAgICAgICBjcyA9IG5pLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZ05hbWUpOwogICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMCwgY2k7IGNpID0gY3Nbal07IGorKyl7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0WysrcmldID0gY2k7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCQoJCiAgICAgICAgfSBlbHNlIGlmKG1vZGUgPT0gIi8iIHx8IG1vZGUgPT0gIj4iKXsKICAgICAgICAgICAgdmFyIHV0YWcgPSB0YWdOYW1lLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIG5pLCBjbjsgbmkgPSBuc1tpXTsgaSsrKXsKICAgICAgICAgICAgICAgIGNuID0gbmkuY2hpbGROb2RlczsKICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDAsIGNqOyBjaiA9IGNuW2pdOyBqKyspewogICAgICAgICAgICAgICAgICAgIGlmKGNqLm5vZGVOYW1lID09IHV0YWcgfHwgY2oubm9kZU5hbWUgPT0gdGFnTmFtZSAgfHwgdGFnTmFtZSA9PSAnKicpewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbKytyaV0gPSBjajsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCQoJCiAgICAgICAgfWVsc2UgaWYobW9kZSA9PSAiKyIpewogICAgICAgICAgICB2YXIgdXRhZyA9IHRhZ05hbWUudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbjsgbiA9IG5zW2ldOyBpKyspewogICAgICAgICAgICAgICAgd2hpbGUoKG4gPSBuLm5leHRTaWJsaW5nKSAmJiBuLm5vZGVUeXBlICE9IDEpOwogICAgICAgICAgICAgICAgaWYobiAmJiAobi5ub2RlTmFtZSA9PSB1dGFnIHx8IG4ubm9kZU5hbWUgPT0gdGFnTmFtZSB8fCB0YWdOYW1lID09ICcqJykpewogICAgICAgICAgICAgICAgICAgIHJlc3VsdFsrK3JpXSA9IG47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCQoJCiAgICAgICAgfWVsc2UgaWYobW9kZSA9PSAifiIpewogICAgICAgICAgICB2YXIgdXRhZyA9IHRhZ05hbWUudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbjsgbiA9IG5zW2ldOyBpKyspewogICAgICAgICAgICAgICAgd2hpbGUoKG4gPSBuLm5leHRTaWJsaW5nKSl7CiAgICAgICAgICAgICAgICAgICAgaWYgKG4ubm9kZU5hbWUgPT0gdXRhZyB8fCBuLm5vZGVOYW1lID09IHRhZ05hbWUgfHwgdGFnTmFtZSA9PSAnKicpewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbKytyaV0gPSBuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIGZ1bmN0aW9uIGNvbmNhdChhLCBiKXsKICAgICAgICBpZihiLnNsaWNlKXsKICAgICAgICAgICAgcmV0dXJuIGEuY29uY2F0KGIpOwogICAgICAgIH0KICAgICAgICBmb3IodmFyIGkgPSAwLCBsID0gYi5sZW5ndGg7IGkgPCBsOyBpKyspewogICAgICAgICAgICBhW2EubGVuZ3RoXSA9IGJbaV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBhOwogICAgfQoKICAgIGZ1bmN0aW9uIGJ5VGFnKGNzLCB0YWdOYW1lKXsKICAgICAgICBpZihjcy50YWdOYW1lIHx8IGNzID09IGRvY3VtZW50KXsKICAgICAgICAgICAgY3MgPSBbY3NdOwogICAgICAgIH0KICAgICAgICBpZighdGFnTmFtZSl7CiAgICAgICAgICAgIHJldHVybiBjczsKICAgICAgICB9CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdLCByaSA9IC0xOwogICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgZm9yKHZhciBpID0gMCwgY2k7IGNpID0gY3NbaV07IGkrKyl7CiAgICAgICAgICAgIGlmKGNpLm5vZGVUeXBlID09IDEgJiYgY2kudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09IHRhZ05hbWUpewogICAgICAgICAgICAgICAgcmVzdWx0WysrcmldID0gY2k7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBmdW5jdGlvbiBieUlkKGNzLCBpZCl7CiAgICAgICAgaWYoY3MudGFnTmFtZSB8fCBjcyA9PSBkb2N1bWVudCl7CiAgICAgICAgICAgIGNzID0gW2NzXTsKICAgICAgICB9CiAgICAgICAgaWYoIWlkKXsKICAgICAgICAgICAgcmV0dXJuIGNzOwogICAgICAgIH0KICAgICAgICB2YXIgcmVzdWx0ID0gW10sIHJpID0gLTE7CiAgICAgICAgZm9yKHZhciBpID0gMCwgY2k7IGNpID0gY3NbaV07IGkrKyl7CiAgICAgICAgICAgIGlmKGNpICYmIGNpLmlkID09IGlkKXsKICAgICAgICAgICAgICAgIHJlc3VsdFsrK3JpXSA9IGNpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIAogICAgCiAgICBmdW5jdGlvbiBieUF0dHJpYnV0ZShjcywgYXR0ciwgdmFsdWUsIG9wLCBjdXN0b20pewogICAgICAgIHZhciByZXN1bHQgPSBbXSwgCiAgICAgICAgICAgIHJpID0gLTEsIAogICAgICAgICAgICB1c2VHZXRTdHlsZSA9IGN1c3RvbSA9PSAieyIsCSAgICAKICAgICAgICAgICAgZm4gPSBFeHQuRG9tUXVlcnkub3BlcmF0b3JzW29wXSwJICAgIAogICAgICAgICAgICBhLAogICAgICAgICAgICB4bWwsCiAgICAgICAgICAgIGhhc1htbDsKICAgICAgICAgICAgCiAgICAgICAgZm9yKHZhciBpID0gMCwgY2k7IGNpID0gY3NbaV07IGkrKyl7CgkgICAgCiAgICAgICAgICAgIGlmKGNpLm5vZGVUeXBlICE9IDEpewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKCFoYXNYbWwpewogICAgICAgICAgICAgICAgeG1sID0gRXh0LkRvbVF1ZXJ5LmlzWG1sKGNpKTsKICAgICAgICAgICAgICAgIGhhc1htbCA9IHRydWU7CiAgICAgICAgICAgIH0KCSAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKCF4bWwpewogICAgICAgICAgICAgICAgaWYodXNlR2V0U3R5bGUpewogICAgICAgICAgICAgICAgICAgIGEgPSBFeHQuRG9tUXVlcnkuZ2V0U3R5bGUoY2ksIGF0dHIpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdHRyID09ICJjbGFzcyIgfHwgYXR0ciA9PSAiY2xhc3NOYW1lIil7CiAgICAgICAgICAgICAgICAgICAgYSA9IGNpLmNsYXNzTmFtZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0ciA9PSAiZm9yIil7CiAgICAgICAgICAgICAgICAgICAgYSA9IGNpLmh0bWxGb3I7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF0dHIgPT0gImhyZWYiKXsKCQkgICAgCgkJICAgIAogICAgICAgICAgICAgICAgICAgIGEgPSBjaS5nZXRBdHRyaWJ1dGUoImhyZWYiLCAyKTsKICAgICAgICAgICAgICAgIH0gZWxzZXsKICAgICAgICAgICAgICAgICAgICBhID0gY2kuZ2V0QXR0cmlidXRlKGF0dHIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGEgPSBjaS5nZXRBdHRyaWJ1dGUoYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoKGZuICYmIGZuKGEsIHZhbHVlKSkgfHwgKCFmbiAmJiBhKSl7CiAgICAgICAgICAgICAgICByZXN1bHRbKytyaV0gPSBjaTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIGZ1bmN0aW9uIGJ5UHNldWRvKGNzLCBuYW1lLCB2YWx1ZSl7CiAgICAgICAgcmV0dXJuIEV4dC5Eb21RdWVyeS5wc2V1ZG9zW25hbWVdKGNzLCB2YWx1ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gbm9kdXBJRVhtbChjcyl7CiAgICAgICAgdmFyIGQgPSArK2tleSwgCiAgICAgICAgICAgIHI7CiAgICAgICAgY3NbMF0uc2V0QXR0cmlidXRlKCJfbm9kdXAiLCBkKTsKICAgICAgICByID0gW2NzWzBdXTsKICAgICAgICBmb3IodmFyIGkgPSAxLCBsZW4gPSBjcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIHZhciBjID0gY3NbaV07CiAgICAgICAgICAgIGlmKCFjLmdldEF0dHJpYnV0ZSgiX25vZHVwIikgIT0gZCl7CiAgICAgICAgICAgICAgICBjLnNldEF0dHJpYnV0ZSgiX25vZHVwIiwgZCk7CiAgICAgICAgICAgICAgICByW3IubGVuZ3RoXSA9IGM7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gY3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICBjc1tpXS5yZW1vdmVBdHRyaWJ1dGUoIl9ub2R1cCIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcjsKICAgIH0KCiAgICBmdW5jdGlvbiBub2R1cChjcyl7CiAgICAgICAgaWYoIWNzKXsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgICAgICB2YXIgbGVuID0gY3MubGVuZ3RoLCBjLCBpLCByID0gY3MsIGNqLCByaSA9IC0xOwogICAgICAgIGlmKCFsZW4gfHwgdHlwZW9mIGNzLm5vZGVUeXBlICE9ICJ1bmRlZmluZWQiIHx8IGxlbiA9PSAxKXsKICAgICAgICAgICAgcmV0dXJuIGNzOwogICAgICAgIH0KICAgICAgICBpZihpc0lFICYmIHR5cGVvZiBjc1swXS5zZWxlY3RTaW5nbGVOb2RlICE9ICJ1bmRlZmluZWQiKXsKICAgICAgICAgICAgcmV0dXJuIG5vZHVwSUVYbWwoY3MpOwogICAgICAgIH0KICAgICAgICB2YXIgZCA9ICsra2V5OwogICAgICAgIGNzWzBdLl9ub2R1cCA9IGQ7CiAgICAgICAgZm9yKGkgPSAxOyBjID0gY3NbaV07IGkrKyl7CiAgICAgICAgICAgIGlmKGMuX25vZHVwICE9IGQpewogICAgICAgICAgICAgICAgYy5fbm9kdXAgPSBkOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHIgPSBbXTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBpOyBqKyspewogICAgICAgICAgICAgICAgICAgIHJbKytyaV0gPSBjc1tqXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcihqID0gaSsxOyBjaiA9IGNzW2pdOyBqKyspewogICAgICAgICAgICAgICAgICAgIGlmKGNqLl9ub2R1cCAhPSBkKXsKICAgICAgICAgICAgICAgICAgICAgICAgY2ouX25vZHVwID0gZDsKICAgICAgICAgICAgICAgICAgICAgICAgclsrK3JpXSA9IGNqOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByOwogICAgfQoKICAgIGZ1bmN0aW9uIHF1aWNrRGlmZklFWG1sKGMxLCBjMil7CiAgICAgICAgdmFyIGQgPSArK2tleSwKICAgICAgICAgICAgciA9IFtdOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGMxLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgYzFbaV0uc2V0QXR0cmlidXRlKCJfcWRpZmYiLCBkKTsKICAgICAgICB9ICAgICAgICAKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBjMi5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGlmKGMyW2ldLmdldEF0dHJpYnV0ZSgiX3FkaWZmIikgIT0gZCl7CiAgICAgICAgICAgICAgICByW3IubGVuZ3RoXSA9IGMyW2ldOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGMxLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICBjMVtpXS5yZW1vdmVBdHRyaWJ1dGUoIl9xZGlmZiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcjsKICAgIH0KCiAgICBmdW5jdGlvbiBxdWlja0RpZmYoYzEsIGMyKXsKICAgICAgICB2YXIgbGVuMSA9IGMxLmxlbmd0aCwKICAgICAgICAJZCA9ICsra2V5LAogICAgICAgIAlyID0gW107CiAgICAgICAgaWYoIWxlbjEpewogICAgICAgICAgICByZXR1cm4gYzI7CiAgICAgICAgfQogICAgICAgIGlmKGlzSUUgJiYgdHlwZW9mIGMxWzBdLnNlbGVjdFNpbmdsZU5vZGUgIT0gInVuZGVmaW5lZCIpewogICAgICAgICAgICByZXR1cm4gcXVpY2tEaWZmSUVYbWwoYzEsIGMyKTsKICAgICAgICB9ICAgICAgICAKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbGVuMTsgaSsrKXsKICAgICAgICAgICAgYzFbaV0uX3FkaWZmID0gZDsKICAgICAgICB9ICAgICAgICAKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBjMi5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGlmKGMyW2ldLl9xZGlmZiAhPSBkKXsKICAgICAgICAgICAgICAgIHJbci5sZW5ndGhdID0gYzJbaV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHI7CiAgICB9CgogICAgZnVuY3Rpb24gcXVpY2tJZChucywgbW9kZSwgcm9vdCwgaWQpewogICAgICAgIGlmKG5zID09IHJvb3QpewogICAgICAgICAgIHZhciBkID0gcm9vdC5vd25lckRvY3VtZW50IHx8IHJvb3Q7CiAgICAgICAgICAgcmV0dXJuIGQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgIH0KICAgICAgICBucyA9IGdldE5vZGVzKG5zLCBtb2RlLCAiKiIpOwogICAgICAgIHJldHVybiBieUlkKG5zLCBpZCk7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICBnZXRTdHlsZSA6IGZ1bmN0aW9uKGVsLCBuYW1lKXsKICAgICAgICAgICAgcmV0dXJuIEV4dC5mbHkoZWwpLmdldFN0eWxlKG5hbWUpOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgY29tcGlsZSA6IGZ1bmN0aW9uKHBhdGgsIHR5cGUpewogICAgICAgICAgICB0eXBlID0gdHlwZSB8fCAic2VsZWN0IjsKCiAgICAJICAgIAogICAgICAgICAgICB2YXIgZm4gPSBbInZhciBmID0gZnVuY3Rpb24ocm9vdCl7XG4gdmFyIG1vZGU7ICsrYmF0Y2g7IHZhciBuID0gcm9vdCB8fCBkb2N1bWVudDtcbiJdLAogICAgICAgIAkJbW9kZSwJCQogICAgICAgIAkJbGFzdFBhdGgsCiAgICAgICAgICAgIAltYXRjaGVycyA9IEV4dC5Eb21RdWVyeS5tYXRjaGVycywKICAgICAgICAgICAgCW1hdGNoZXJzTG4gPSBtYXRjaGVycy5sZW5ndGgsCiAgICAgICAgICAgIAltb2RlTWF0Y2gsCiAgICAgICAgICAgIAkKICAgICAgICAgICAgCWxtb2RlID0gcGF0aC5tYXRjaChtb2RlUmUpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYobG1vZGUgJiYgbG1vZGVbMV0pewogICAgICAgICAgICAgICAgZm5bZm4ubGVuZ3RoXSA9ICdtb2RlPSInK2xtb2RlWzFdLnJlcGxhY2UodHJpbVJlLCAiIikrJyI7JzsKICAgICAgICAgICAgICAgIHBhdGggPSBwYXRoLnJlcGxhY2UobG1vZGVbMV0sICIiKTsKICAgICAgICAgICAgfQoJICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgd2hpbGUocGF0aC5zdWJzdHIoMCwgMSk9PSIvIil7CiAgICAgICAgICAgICAgICBwYXRoID0gcGF0aC5zdWJzdHIoMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaWxlKHBhdGggJiYgbGFzdFBhdGggIT0gcGF0aCl7CiAgICAgICAgICAgICAgICBsYXN0UGF0aCA9IHBhdGg7CiAgICAgICAgICAgICAgICB2YXIgdG9rZW5NYXRjaCA9IHBhdGgubWF0Y2godGFnVG9rZW5SZSk7CiAgICAgICAgICAgICAgICBpZih0eXBlID09ICJzZWxlY3QiKXsKICAgICAgICAgICAgICAgICAgICBpZih0b2tlbk1hdGNoKXsKCQkJCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRva2VuTWF0Y2hbMV0gPT0gIiMiKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuW2ZuLmxlbmd0aF0gPSAnbiA9IHF1aWNrSWQobiwgbW9kZSwgcm9vdCwgIicrdG9rZW5NYXRjaFsyXSsnIik7JzsJCQkKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbltmbi5sZW5ndGhdID0gJ24gPSBnZXROb2RlcyhuLCBtb2RlLCAiJyt0b2tlbk1hdGNoWzJdKyciKTsnOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHBhdGggPSBwYXRoLnJlcGxhY2UodG9rZW5NYXRjaFswXSwgIiIpOwogICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHBhdGguc3Vic3RyKDAsIDEpICE9ICdAJyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuW2ZuLmxlbmd0aF0gPSAnbiA9IGdldE5vZGVzKG4sIG1vZGUsICIqIik7JzsKICAgICAgICAgICAgICAgICAgICB9CgkJCiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICBpZih0b2tlbk1hdGNoKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodG9rZW5NYXRjaFsxXSA9PSAiIyIpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm5bZm4ubGVuZ3RoXSA9ICduID0gYnlJZChuLCAiJyt0b2tlbk1hdGNoWzJdKyciKTsnOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuW2ZuLmxlbmd0aF0gPSAnbiA9IGJ5VGFnKG4sICInK3Rva2VuTWF0Y2hbMl0rJyIpOyc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGF0aCA9IHBhdGgucmVwbGFjZSh0b2tlbk1hdGNoWzBdLCAiIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUoIShtb2RlTWF0Y2ggPSBwYXRoLm1hdGNoKG1vZGVSZSkpKXsKICAgICAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBtYXRjaGVyc0xuOyBqKyspewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IG1hdGNoZXJzW2pdOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IHBhdGgubWF0Y2godC5yZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm5bZm4ubGVuZ3RoXSA9IHQuc2VsZWN0LnJlcGxhY2UodHBsUmUsIGZ1bmN0aW9uKHgsIGkpewoJCQkJcmV0dXJuIG1baV07CgkJCSAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdGggPSBwYXRoLnJlcGxhY2UobVswXSwgIiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZighbWF0Y2hlZCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICdFcnJvciBwYXJzaW5nIHNlbGVjdG9yLCBwYXJzaW5nIGZhaWxlZCBhdCAiJyArIHBhdGggKyAnIic7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYobW9kZU1hdGNoWzFdKXsKICAgICAgICAgICAgICAgICAgICBmbltmbi5sZW5ndGhdID0gJ21vZGU9IicrbW9kZU1hdGNoWzFdLnJlcGxhY2UodHJpbVJlLCAiIikrJyI7JzsKICAgICAgICAgICAgICAgICAgICBwYXRoID0gcGF0aC5yZXBsYWNlKG1vZGVNYXRjaFsxXSwgIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgkgICAgCiAgICAgICAgICAgIGZuW2ZuLmxlbmd0aF0gPSAicmV0dXJuIG5vZHVwKG4pO1xufSI7CgkgICAgCgkgICAgCiAgICAgICAgICAgIGV2YWwoZm4uam9pbigiIikpOwogICAgICAgICAgICByZXR1cm4gZjsKICAgICAgICB9LAoKICAgICAgICAKCWpzU2VsZWN0OiBmdW5jdGlvbihwYXRoLCByb290LCB0eXBlKXsKCSAgICAKCSAgICByb290ID0gcm9vdCB8fCBkb2N1bWVudDsKCSAgICAKICAgICAgICAgICAgaWYodHlwZW9mIHJvb3QgPT0gInN0cmluZyIpewogICAgICAgICAgICAgICAgcm9vdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwYXRocyA9IHBhdGguc3BsaXQoIiwiKSwKICAgICAgICAgICAgCXJlc3VsdHMgPSBbXTsKCQkKCSAgICAKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gcGF0aHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewkJCiAgICAgICAgICAgICAgICB2YXIgc3ViUGF0aCA9IHBhdGhzW2ldLnJlcGxhY2UodHJpbVJlLCAiIik7CgkJCiAgICAgICAgICAgICAgICBpZighY2FjaGVbc3ViUGF0aF0pewogICAgICAgICAgICAgICAgICAgIGNhY2hlW3N1YlBhdGhdID0gRXh0LkRvbVF1ZXJ5LmNvbXBpbGUoc3ViUGF0aCk7CiAgICAgICAgICAgICAgICAgICAgaWYoIWNhY2hlW3N1YlBhdGhdKXsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgc3ViUGF0aCArICIgaXMgbm90IGEgdmFsaWQgc2VsZWN0b3IiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBjYWNoZVtzdWJQYXRoXShyb290KTsKICAgICAgICAgICAgICAgIGlmKHJlc3VsdCAmJiByZXN1bHQgIT0gZG9jdW1lbnQpewogICAgICAgICAgICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmNvbmNhdChyZXN1bHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgkgICAgCgkgICAgCgkgICAgCiAgICAgICAgICAgIGlmKHBhdGhzLmxlbmd0aCA+IDEpewogICAgICAgICAgICAgICAgcmV0dXJuIG5vZHVwKHJlc3VsdHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgIH0sCglpc1htbDogZnVuY3Rpb24oZWwpIHsKCSAgICB2YXIgZG9jRWwgPSAoZWwgPyBlbC5vd25lckRvY3VtZW50IHx8IGVsIDogMCkuZG9jdW1lbnRFbGVtZW50OwoJICAgIHJldHVybiBkb2NFbCA/IGRvY0VsLm5vZGVOYW1lICE9PSAiSFRNTCIgOiBmYWxzZTsKCX0sCiAgICAgICAgc2VsZWN0IDogZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCA/IGZ1bmN0aW9uKHBhdGgsIHJvb3QsIHR5cGUpIHsKCSAgICByb290ID0gcm9vdCB8fCBkb2N1bWVudDsKCSAgICBpZiAoIUV4dC5Eb21RdWVyeS5pc1htbChyb290KSkgewoJCXRyeSB7CgkJICAgIHZhciBjcyA9IHJvb3QucXVlcnlTZWxlY3RvckFsbChwYXRoKTsKCQkgICAgcmV0dXJuIEV4dC50b0FycmF5KGNzKTsKCQl9CgkJY2F0Y2ggKGV4KSB7fQkJCgkgICAgfQkgICAgCgkgICAgcmV0dXJuIEV4dC5Eb21RdWVyeS5qc1NlbGVjdC5jYWxsKHRoaXMsIHBhdGgsIHJvb3QsIHR5cGUpOwoJfSA6IGZ1bmN0aW9uKHBhdGgsIHJvb3QsIHR5cGUpIHsKCSAgICByZXR1cm4gRXh0LkRvbVF1ZXJ5LmpzU2VsZWN0LmNhbGwodGhpcywgcGF0aCwgcm9vdCwgdHlwZSk7Cgl9LAoKICAgICAgICAKICAgICAgICBzZWxlY3ROb2RlIDogZnVuY3Rpb24ocGF0aCwgcm9vdCl7CiAgICAgICAgICAgIHJldHVybiBFeHQuRG9tUXVlcnkuc2VsZWN0KHBhdGgsIHJvb3QpWzBdOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHNlbGVjdFZhbHVlIDogZnVuY3Rpb24ocGF0aCwgcm9vdCwgZGVmYXVsdFZhbHVlKXsKICAgICAgICAgICAgcGF0aCA9IHBhdGgucmVwbGFjZSh0cmltUmUsICIiKTsKICAgICAgICAgICAgaWYoIXZhbHVlQ2FjaGVbcGF0aF0pewogICAgICAgICAgICAgICAgdmFsdWVDYWNoZVtwYXRoXSA9IEV4dC5Eb21RdWVyeS5jb21waWxlKHBhdGgsICJzZWxlY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbiA9IHZhbHVlQ2FjaGVbcGF0aF0ocm9vdCksIHY7CiAgICAgICAgICAgIG4gPSBuWzBdID8gblswXSA6IG47CiAgICAgICAgICAgIAkgICAgCgkgICAgCgkgICAgCgkgICAgCgkgICAgCiAgICAgICAgICAgIGlmICh0eXBlb2Ygbi5ub3JtYWxpemUgPT0gJ2Z1bmN0aW9uJykgbi5ub3JtYWxpemUoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHYgPSAobiAmJiBuLmZpcnN0Q2hpbGQgPyBuLmZpcnN0Q2hpbGQubm9kZVZhbHVlIDogbnVsbCk7CiAgICAgICAgICAgIHJldHVybiAoKHYgPT09IG51bGx8fHYgPT09IHVuZGVmaW5lZHx8dj09PScnKSA/IGRlZmF1bHRWYWx1ZSA6IHYpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHNlbGVjdE51bWJlciA6IGZ1bmN0aW9uKHBhdGgsIHJvb3QsIGRlZmF1bHRWYWx1ZSl7CiAgICAgICAgICAgIHZhciB2ID0gRXh0LkRvbVF1ZXJ5LnNlbGVjdFZhbHVlKHBhdGgsIHJvb3QsIGRlZmF1bHRWYWx1ZSB8fCAwKTsKICAgICAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQodik7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaXMgOiBmdW5jdGlvbihlbCwgc3MpewogICAgICAgICAgICBpZih0eXBlb2YgZWwgPT0gInN0cmluZyIpewogICAgICAgICAgICAgICAgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzQXJyYXkgPSBFeHQuaXNBcnJheShlbCksCiAgICAgICAgICAgIAlyZXN1bHQgPSBFeHQuRG9tUXVlcnkuZmlsdGVyKGlzQXJyYXkgPyBlbCA6IFtlbF0sIHNzKTsKICAgICAgICAgICAgcmV0dXJuIGlzQXJyYXkgPyAocmVzdWx0Lmxlbmd0aCA9PSBlbC5sZW5ndGgpIDogKHJlc3VsdC5sZW5ndGggPiAwKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBmaWx0ZXIgOiBmdW5jdGlvbihlbHMsIHNzLCBub25NYXRjaGVzKXsKICAgICAgICAgICAgc3MgPSBzcy5yZXBsYWNlKHRyaW1SZSwgIiIpOwogICAgICAgICAgICBpZighc2ltcGxlQ2FjaGVbc3NdKXsKICAgICAgICAgICAgICAgIHNpbXBsZUNhY2hlW3NzXSA9IEV4dC5Eb21RdWVyeS5jb21waWxlKHNzLCAic2ltcGxlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHNpbXBsZUNhY2hlW3NzXShlbHMpOwogICAgICAgICAgICByZXR1cm4gbm9uTWF0Y2hlcyA/IHF1aWNrRGlmZihyZXN1bHQsIGVscykgOiByZXN1bHQ7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgbWF0Y2hlcnMgOiBbewogICAgICAgICAgICAgICAgcmU6IC9eXC4oW1x3XC1dKykvLAogICAgICAgICAgICAgICAgc2VsZWN0OiAnbiA9IGJ5Q2xhc3NOYW1lKG4sICIgezF9ICIpOycKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgcmU6IC9eXDooW1x3XC1dKykoPzpcKCgoPzpbXlxzPlwvXSp8Lio/KSlcKSk/LywKICAgICAgICAgICAgICAgIHNlbGVjdDogJ24gPSBieVBzZXVkbyhuLCAiezF9IiwgInsyfSIpOycKICAgICAgICAgICAgfSx7CiAgICAgICAgICAgICAgICByZTogL14oPzooW1xbXHtdKSg/OkApPyhbXHdcLV0rKVxzPyg/Oig9fC49KVxzPyhbIiddPykoLio/KVw0KT9bXF1cfV0pLywKICAgICAgICAgICAgICAgIHNlbGVjdDogJ24gPSBieUF0dHJpYnV0ZShuLCAiezJ9IiwgIns1fSIsICJ7M30iLCAiezF9Iik7JwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICByZTogL14jKFtcd1wtXSspLywKICAgICAgICAgICAgICAgIHNlbGVjdDogJ24gPSBieUlkKG4sICJ7MX0iKTsnCiAgICAgICAgICAgIH0sewogICAgICAgICAgICAgICAgcmU6IC9eQChbXHdcLV0rKS8sCiAgICAgICAgICAgICAgICBzZWxlY3Q6ICdyZXR1cm4ge2ZpcnN0Q2hpbGQ6e25vZGVWYWx1ZTphdHRyVmFsdWUobiwgInsxfSIpfX07JwogICAgICAgICAgICB9CiAgICAgICAgXSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29sbGVjdGlvbiBvZiBvcGVyYXRvciBjb21wYXJpc29uIGZ1bmN0aW9ucy4gVGhlIGRlZmF1bHQgb3BlcmF0b3JzIGFyZSA9LCAhPSwgXj0sICQ9LCAqPSwgJT0sIHw9IGFuZCB+PS4KICAgICAgICAgKiBOZXcgb3BlcmF0b3JzIGNhbiBiZSBhZGRlZCBhcyBsb25nIGFzIHRoZSBtYXRjaCB0aGUgZm9ybWF0IDxpPmM8L2k+PSB3aGVyZSA8aT5jPC9pPiBpcyBhbnkgY2hhcmFjdGVyIG90aGVyIHRoYW4gc3BhY2UsICZndDsgJmx0Oy4KICAgICAgICAgKi8KICAgICAgICBvcGVyYXRvcnMgOiB7CiAgICAgICAgICAgICI9IiA6IGZ1bmN0aW9uKGEsIHYpewogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gdjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIiE9IiA6IGZ1bmN0aW9uKGEsIHYpewogICAgICAgICAgICAgICAgcmV0dXJuIGEgIT0gdjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIl49IiA6IGZ1bmN0aW9uKGEsIHYpewogICAgICAgICAgICAgICAgcmV0dXJuIGEgJiYgYS5zdWJzdHIoMCwgdi5sZW5ndGgpID09IHY7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICIkPSIgOiBmdW5jdGlvbihhLCB2KXsKICAgICAgICAgICAgICAgIHJldHVybiBhICYmIGEuc3Vic3RyKGEubGVuZ3RoLXYubGVuZ3RoKSA9PSB2OwogICAgICAgICAgICB9LAogICAgICAgICAgICAiKj0iIDogZnVuY3Rpb24oYSwgdil7CiAgICAgICAgICAgICAgICByZXR1cm4gYSAmJiBhLmluZGV4T2YodikgIT09IC0xOwogICAgICAgICAgICB9LAogICAgICAgICAgICAiJT0iIDogZnVuY3Rpb24oYSwgdil7CiAgICAgICAgICAgICAgICByZXR1cm4gKGEgJSB2KSA9PSAwOwogICAgICAgICAgICB9LAogICAgICAgICAgICAifD0iIDogZnVuY3Rpb24oYSwgdil7CiAgICAgICAgICAgICAgICByZXR1cm4gYSAmJiAoYSA9PSB2IHx8IGEuc3Vic3RyKDAsIHYubGVuZ3RoKzEpID09IHYrJy0nKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgIn49IiA6IGZ1bmN0aW9uKGEsIHYpewogICAgICAgICAgICAgICAgcmV0dXJuIGEgJiYgKCcgJythKycgJykuaW5kZXhPZignICcrdisnICcpICE9IC0xOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogPHA+T2JqZWN0IGhhc2ggb2YgInBzZXVkbyBjbGFzcyIgZmlsdGVyIGZ1bmN0aW9ucyB3aGljaCBhcmUgdXNlZCB3aGVuIGZpbHRlcmluZyBzZWxlY3Rpb25zLiBFYWNoIGZ1bmN0aW9uIGlzIHBhc3NlZAogICAgICAgICAqIHR3byBwYXJhbWV0ZXJzOjwvcD48ZGl2IGNsYXNzPSJtZGV0YWlsLXBhcmFtcyI+PHVsPgogICAgICAgICAqIDxsaT48Yj5jPC9iPiA6IEFycmF5PGRpdiBjbGFzcz0ic3ViLWRlc2MiPkFuIEFycmF5IG9mIERPTSBlbGVtZW50cyB0byBmaWx0ZXIuPC9kaXY+PC9saT4KICAgICAgICAgKiA8bGk+PGI+djwvYj4gOiBTdHJpbmc8ZGl2IGNsYXNzPSJzdWItZGVzYyI+VGhlIGFyZ3VtZW50IChpZiBhbnkpIHN1cHBsaWVkIGluIHRoZSBzZWxlY3Rvci48L2Rpdj48L2xpPgogICAgICAgICAqIDwvdWw+PC9kaXY+CiAgICAgICAgICogPHA+QSBmaWx0ZXIgZnVuY3Rpb24gcmV0dXJucyBhbiBBcnJheSBvZiBET00gZWxlbWVudHMgd2hpY2ggY29uZm9ybSB0byB0aGUgcHNldWRvIGNsYXNzLjwvcD4KICAgICAgICAgKiA8cD5JbiBhZGRpdGlvbiB0byB0aGUgcHJvdmlkZWQgcHNldWRvIGNsYXNzZXMgbGlzdGVkIGFib3ZlIHN1Y2ggYXMgPGNvZGU+Zmlyc3QtY2hpbGQ8L2NvZGU+IGFuZCA8Y29kZT5udGgtY2hpbGQ8L2NvZGU+LAogICAgICAgICAqIGRldmVsb3BlcnMgbWF5IGFkZCBhZGRpdGlvbmFsLCBjdXN0b20gcHN1ZWRvIGNsYXNzIGZpbHRlcnMgdG8gc2VsZWN0IGVsZW1lbnRzIGFjY29yZGluZyB0byBhcHBsaWNhdGlvbi1zcGVjaWZpYyByZXF1aXJlbWVudHMuPC9wPgogICAgICAgICAqIDxwPkZvciBleGFtcGxlLCB0byBmaWx0ZXIgPGNvZGU+Jmx0O2E+PC9jb2RlPiBlbGVtZW50cyB0byBvbmx5IHJldHVybiBsaW5rcyB0byA8aT5leHRlcm5hbDwvaT4gcmVzb3VyY2VzOjwvcD4KICAgICAgICAgKiA8Y29kZT48cHJlPgpFeHQuRG9tUXVlcnkucHNldWRvcy5leHRlcm5hbCA9IGZ1bmN0aW9uKGMsIHYpewogICAgdmFyIHIgPSBbXSwgcmkgPSAtMTsKICAgIGZvcih2YXIgaSA9IDAsIGNpOyBjaSA9IGNbaV07IGkrKyl7Ci8vICAgICAgSW5jbHVkZSBpbiByZXN1bHQgc2V0IG9ubHkgaWYgaXQncyBhIGxpbmsgdG8gYW4gZXh0ZXJuYWwgcmVzb3VyY2UKICAgICAgICBpZihjaS5ob3N0bmFtZSAhPSBsb2NhdGlvbi5ob3N0bmFtZSl7CiAgICAgICAgICAgIHJbKytyaV0gPSBjaTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcjsKfTs8L3ByZT48L2NvZGU+CiAgICAgICAgICogVGhlbiBleHRlcm5hbCBsaW5rcyBjb3VsZCBiZSBnYXRoZXJlZCB3aXRoIHRoZSBmb2xsb3dpbmcgc3RhdGVtZW50Ojxjb2RlPjxwcmU+CnZhciBleHRlcm5hbExpbmtzID0gRXh0LnNlbGVjdCgiYTpleHRlcm5hbCIpOwo8L2NvZGU+PC9wcmU+CiAgICAgICAgICovCiAgICAgICAgcHNldWRvcyA6IHsKICAgICAgICAgICAgImZpcnN0LWNoaWxkIiA6IGZ1bmN0aW9uKGMpewogICAgICAgICAgICAgICAgdmFyIHIgPSBbXSwgcmkgPSAtMSwgbjsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGNpOyBjaSA9IG4gPSBjW2ldOyBpKyspewogICAgICAgICAgICAgICAgICAgIHdoaWxlKChuID0gbi5wcmV2aW91c1NpYmxpbmcpICYmIG4ubm9kZVR5cGUgIT0gMSk7CiAgICAgICAgICAgICAgICAgICAgaWYoIW4pewogICAgICAgICAgICAgICAgICAgICAgICByWysrcmldID0gY2k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAibGFzdC1jaGlsZCIgOiBmdW5jdGlvbihjKXsKICAgICAgICAgICAgICAgIHZhciByID0gW10sIHJpID0gLTEsIG47CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBjaTsgY2kgPSBuID0gY1tpXTsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB3aGlsZSgobiA9IG4ubmV4dFNpYmxpbmcpICYmIG4ubm9kZVR5cGUgIT0gMSk7CiAgICAgICAgICAgICAgICAgICAgaWYoIW4pewogICAgICAgICAgICAgICAgICAgICAgICByWysrcmldID0gY2k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAibnRoLWNoaWxkIiA6IGZ1bmN0aW9uKGMsIGEpIHsKICAgICAgICAgICAgICAgIHZhciByID0gW10sIHJpID0gLTEsCiAgICAgICAgICAgICAgICAJbSA9IG50aFJlLmV4ZWMoYSA9PSAiZXZlbiIgJiYgIjJuIiB8fCBhID09ICJvZGQiICYmICIybisxIiB8fCAhbnRoUmUyLnRlc3QoYSkgJiYgIm4rIiArIGEgfHwgYSksCiAgICAgICAgICAgICAgICAJZiA9IChtWzFdIHx8IDEpIC0gMCwgbCA9IG1bMl0gLSAwOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbjsgbiA9IGNbaV07IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBuID0gbi5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChiYXRjaCAhPSBwbi5fYmF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGogPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGNuID0gcG4uZmlyc3RDaGlsZDsgY247IGNuID0gY24ubmV4dFNpYmxpbmcpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoY24ubm9kZVR5cGUgPT0gMSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbi5ub2RlSW5kZXggPSArK2o7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcG4uX2JhdGNoID0gYmF0Y2g7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChmID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGwgPT0gMCB8fCBuLm5vZGVJbmRleCA9PSBsKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJbKytyaV0gPSBuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgobi5ub2RlSW5kZXggKyBsKSAlIGYgPT0gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJbKytyaV0gPSBuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJvbmx5LWNoaWxkIiA6IGZ1bmN0aW9uKGMpewogICAgICAgICAgICAgICAgdmFyIHIgPSBbXSwgcmkgPSAtMTs7CiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBjaTsgY2kgPSBjW2ldOyBpKyspewogICAgICAgICAgICAgICAgICAgIGlmKCFwcmV2KGNpKSAmJiAhbmV4dChjaSkpewogICAgICAgICAgICAgICAgICAgICAgICByWysrcmldID0gY2k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiZW1wdHkiIDogZnVuY3Rpb24oYyl7CiAgICAgICAgICAgICAgICB2YXIgciA9IFtdLCByaSA9IC0xOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgY2k7IGNpID0gY1tpXTsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB2YXIgY25zID0gY2kuY2hpbGROb2RlcywgaiA9IDAsIGNuLCBlbXB0eSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY24gPSBjbnNbal0pewogICAgICAgICAgICAgICAgICAgICAgICArK2o7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGNuLm5vZGVUeXBlID09IDEgfHwgY24ubm9kZVR5cGUgPT0gMyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbXB0eSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYoZW1wdHkpewogICAgICAgICAgICAgICAgICAgICAgICByWysrcmldID0gY2k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiY29udGFpbnMiIDogZnVuY3Rpb24oYywgdil7CiAgICAgICAgICAgICAgICB2YXIgciA9IFtdLCByaSA9IC0xOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgY2k7IGNpID0gY1tpXTsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBpZigoY2kudGV4dENvbnRlbnR8fGNpLmlubmVyVGV4dHx8JycpLmluZGV4T2YodikgIT0gLTEpewogICAgICAgICAgICAgICAgICAgICAgICByWysrcmldID0gY2k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAibm9kZVZhbHVlIiA6IGZ1bmN0aW9uKGMsIHYpewogICAgICAgICAgICAgICAgdmFyIHIgPSBbXSwgcmkgPSAtMTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGNpOyBjaSA9IGNbaV07IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgaWYoY2kuZmlyc3RDaGlsZCAmJiBjaS5maXJzdENoaWxkLm5vZGVWYWx1ZSA9PSB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgclsrK3JpXSA9IGNpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImNoZWNrZWQiIDogZnVuY3Rpb24oYyl7CiAgICAgICAgICAgICAgICB2YXIgciA9IFtdLCByaSA9IC0xOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgY2k7IGNpID0gY1tpXTsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBpZihjaS5jaGVja2VkID09IHRydWUpewogICAgICAgICAgICAgICAgICAgICAgICByWysrcmldID0gY2k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAibm90IiA6IGZ1bmN0aW9uKGMsIHNzKXsKICAgICAgICAgICAgICAgIHJldHVybiBFeHQuRG9tUXVlcnkuZmlsdGVyKGMsIHNzLCB0cnVlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJhbnkiIDogZnVuY3Rpb24oYywgc2VsZWN0b3JzKXsKICAgICAgICAgICAgICAgIHZhciBzcyA9IHNlbGVjdG9ycy5zcGxpdCgnfCcpLAogICAgICAgICAgICAgICAgCXIgPSBbXSwgcmkgPSAtMSwgczsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGNpOyBjaSA9IGNbaV07IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMDsgcyA9IHNzW2pdOyBqKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZihFeHQuRG9tUXVlcnkuaXMoY2ksIHMpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJbKytyaV0gPSBjaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAib2RkIiA6IGZ1bmN0aW9uKGMpewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbIm50aC1jaGlsZCJdKGMsICJvZGQiKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJldmVuIiA6IGZ1bmN0aW9uKGMpewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbIm50aC1jaGlsZCJdKGMsICJldmVuIik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAibnRoIiA6IGZ1bmN0aW9uKGMsIGEpewogICAgICAgICAgICAgICAgcmV0dXJuIGNbYS0xXSB8fCBbXTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJmaXJzdCIgOiBmdW5jdGlvbihjKXsKICAgICAgICAgICAgICAgIHJldHVybiBjWzBdIHx8IFtdOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImxhc3QiIDogZnVuY3Rpb24oYyl7CiAgICAgICAgICAgICAgICByZXR1cm4gY1tjLmxlbmd0aC0xXSB8fCBbXTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJoYXMiIDogZnVuY3Rpb24oYywgc3MpewogICAgICAgICAgICAgICAgdmFyIHMgPSBFeHQuRG9tUXVlcnkuc2VsZWN0LAogICAgICAgICAgICAgICAgCXIgPSBbXSwgcmkgPSAtMTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGNpOyBjaSA9IGNbaV07IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgaWYocyhzcywgY2kpLmxlbmd0aCA+IDApewogICAgICAgICAgICAgICAgICAgICAgICByWysrcmldID0gY2k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAibmV4dCIgOiBmdW5jdGlvbihjLCBzcyl7CiAgICAgICAgICAgICAgICB2YXIgaXMgPSBFeHQuRG9tUXVlcnkuaXMsCiAgICAgICAgICAgICAgICAJciA9IFtdLCByaSA9IC0xOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgY2k7IGNpID0gY1tpXTsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IG5leHQoY2kpOwogICAgICAgICAgICAgICAgICAgIGlmKG4gJiYgaXMobiwgc3MpKXsKICAgICAgICAgICAgICAgICAgICAgICAgclsrK3JpXSA9IGNpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgInByZXYiIDogZnVuY3Rpb24oYywgc3MpewogICAgICAgICAgICAgICAgdmFyIGlzID0gRXh0LkRvbVF1ZXJ5LmlzLAogICAgICAgICAgICAgICAgCXIgPSBbXSwgcmkgPSAtMTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGNpOyBjaSA9IGNbaV07IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBwcmV2KGNpKTsKICAgICAgICAgICAgICAgICAgICBpZihuICYmIGlzKG4sIHNzKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJbKytyaV0gPSBjaTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0oKTsKCi8qKgogKiBTZWxlY3RzIGFuIGFycmF5IG9mIERPTSBub2RlcyBieSBDU1MvWFBhdGggc2VsZWN0b3IuIFNob3J0aGFuZCBvZiB7QGxpbmsgRXh0LkRvbVF1ZXJ5I3NlbGVjdH0KICogQHBhcmFtIHtTdHJpbmd9IHBhdGggVGhlIHNlbGVjdG9yL3hwYXRoIHF1ZXJ5CiAqIEBwYXJhbSB7Tm9kZX0gcm9vdCAob3B0aW9uYWwpIFRoZSBzdGFydCBvZiB0aGUgcXVlcnkgKGRlZmF1bHRzIHRvIGRvY3VtZW50KS4KICogQHJldHVybiB7QXJyYXl9CiAqIEBtZW1iZXIgRXh0CiAqIEBtZXRob2QgcXVlcnkKICovCkV4dC5xdWVyeSA9IEV4dC5Eb21RdWVyeS5zZWxlY3Q7Ci8qKgogKiBAY2xhc3MgRXh0LnV0aWwuRGVsYXllZFRhc2sKICogPHA+IFRoZSBEZWxheWVkVGFzayBjbGFzcyBwcm92aWRlcyBhIGNvbnZlbmllbnQgd2F5IHRvICJidWZmZXIiIHRoZSBleGVjdXRpb24gb2YgYSBtZXRob2QsCiAqIHBlcmZvcm1pbmcgc2V0VGltZW91dCB3aGVyZSBhIG5ldyB0aW1lb3V0IGNhbmNlbHMgdGhlIG9sZCB0aW1lb3V0LiBXaGVuIGNhbGxlZCwgdGhlCiAqIHRhc2sgd2lsbCB3YWl0IHRoZSBzcGVjaWZpZWQgdGltZSBwZXJpb2QgYmVmb3JlIGV4ZWN1dGluZy4gSWYgZHVybmcgdGhhdCB0aW1lIHBlcmlvZCwKICogdGhlIHRhc2sgaXMgY2FsbGVkIGFnYWluLCB0aGUgb3JpZ2luYWwgY2FsbCB3aWxsIGJlIGNhbmNlbGxlZC4gVGhpcyBjb250aW51ZXMgc28gdGhhdAogKiB0aGUgZnVuY3Rpb24gaXMgb25seSBjYWxsZWQgYSBzaW5nbGUgdGltZSBmb3IgZWFjaCBpdGVyYXRpb24uPC9wPgogKiA8cD5UaGlzIG1ldGhvZCBpcyBlc3BlY2lhbGx5IHVzZWZ1bCBmb3IgdGhpbmdzIGxpa2UgZGV0ZWN0aW5nIHdoZXRoZXIgYSB1c2VyIGhhcyBmaW5pc2hlZAogKiB0eXBpbmcgaW4gYSB0ZXh0IGZpZWxkLiBBbiBleGFtcGxlIHdvdWxkIGJlIHBlcmZvcm1pbmcgdmFsaWRhdGlvbiBvbiBhIGtleXByZXNzLiBZb3UgY2FuCiAqIHVzZSB0aGlzIGNsYXNzIHRvIGJ1ZmZlciB0aGUga2V5cHJlc3MgZXZlbnRzIGZvciBhIGNlcnRhaW4gbnVtYmVyIG9mIG1pbGxpc2Vjb25kcywgYW5kCiAqIHBlcmZvcm0gb25seSBpZiB0aGV5IHN0b3AgZm9yIHRoYXQgYW1vdW50IG9mIHRpbWUuICBVc2FnZTo8L3A+PHByZT48Y29kZT4KdmFyIHRhc2sgPSBuZXcgRXh0LnV0aWwuRGVsYXllZFRhc2soZnVuY3Rpb24oKXsKICAgIGFsZXJ0KEV4dC5nZXREb20oJ215SW5wdXRGaWVsZCcpLnZhbHVlLmxlbmd0aCk7Cn0pOwovLyBXYWl0IDUwMG1zIGJlZm9yZSBjYWxsaW5nIG91ciBmdW5jdGlvbi4gSWYgdGhlIHVzZXIgcHJlc3NlcyBhbm90aGVyIGtleSAKLy8gZHVyaW5nIHRoYXQgNTAwbXMsIGl0IHdpbGwgYmUgY2FuY2VsbGVkIGFuZCB3ZSdsbCB3YWl0IGFub3RoZXIgNTAwbXMuCkV4dC5nZXQoJ215SW5wdXRGaWVsZCcpLm9uKCdrZXlwcmVzcycsIGZ1bmN0aW9uKCl7CiAgICB0YXNrLntAbGluayAjZGVsYXl9KDUwMCk7IAp9KTsKICogPC9jb2RlPjwvcHJlPiAKICogPHA+Tm90ZSB0aGF0IHdlIGFyZSB1c2luZyBhIERlbGF5ZWRUYXNrIGhlcmUgdG8gaWxsdXN0cmF0ZSBhIHBvaW50LiBUaGUgY29uZmlndXJhdGlvbgogKiBvcHRpb24gPHR0PmJ1ZmZlcjwvdHQ+IGZvciB7QGxpbmsgRXh0LnV0aWwuT2JzZXJ2YWJsZSNhZGRMaXN0ZW5lciBhZGRMaXN0ZW5lci9vbn0gd2lsbAogKiBhbHNvIHNldHVwIGEgZGVsYXllZCB0YXNrIGZvciB5b3UgdG8gYnVmZmVyIGV2ZW50cy48L3A+IAogKiBAY29uc3RydWN0b3IgVGhlIHBhcmFtZXRlcnMgdG8gdGhpcyBjb25zdHJ1Y3RvciBzZXJ2ZSBhcyBkZWZhdWx0cyBhbmQgYXJlIG5vdCByZXF1aXJlZC4KICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gKG9wdGlvbmFsKSBUaGUgZGVmYXVsdCBmdW5jdGlvbiB0byBjYWxsLgogKiBAcGFyYW0ge09iamVjdH0gc2NvcGUgVGhlIGRlZmF1bHQgc2NvcGUgKFRoZSA8Y29kZT48Yj50aGlzPC9iPjwvY29kZT4gcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUKICogZnVuY3Rpb24gaXMgY2FsbGVkLiBJZiBub3Qgc3BlY2lmaWVkLCA8Y29kZT50aGlzPC9jb2RlPiB3aWxsIHJlZmVyIHRvIHRoZSBicm93c2VyIHdpbmRvdy4KICogQHBhcmFtIHtBcnJheX0gYXJncyAob3B0aW9uYWwpIFRoZSBkZWZhdWx0IEFycmF5IG9mIGFyZ3VtZW50cy4KICovCkV4dC51dGlsLkRlbGF5ZWRUYXNrID0gZnVuY3Rpb24oZm4sIHNjb3BlLCBhcmdzKXsKICAgIHZhciBtZSA9IHRoaXMsCiAgICAJaWQsICAgIAkKICAgIAljYWxsID0gZnVuY3Rpb24oKXsKICAgIAkJY2xlYXJJbnRlcnZhbChpZCk7CgkgICAgICAgIGlkID0gbnVsbDsKCSAgICAgICAgZm4uYXBwbHkoc2NvcGUsIGFyZ3MgfHwgW10pOwoJICAgIH07CgkgICAgCiAgICAvKioKICAgICAqIENhbmNlbHMgYW55IHBlbmRpbmcgdGltZW91dCBhbmQgcXVldWVzIGEgbmV3IG9uZQogICAgICogQHBhcmFtIHtOdW1iZXJ9IGRlbGF5IFRoZSBtaWxsaXNlY29uZHMgdG8gZGVsYXkKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IG5ld0ZuIChvcHRpb25hbCkgT3ZlcnJpZGVzIGZ1bmN0aW9uIHBhc3NlZCB0byBjb25zdHJ1Y3RvcgogICAgICogQHBhcmFtIHtPYmplY3R9IG5ld1Njb3BlIChvcHRpb25hbCkgT3ZlcnJpZGVzIHNjb3BlIHBhc3NlZCB0byBjb25zdHJ1Y3Rvci4gUmVtZW1iZXIgdGhhdCBpZiBubyBzY29wZQogICAgICogaXMgc3BlY2lmaWVkLCA8Y29kZT50aGlzPC9jb2RlPiB3aWxsIHJlZmVyIHRvIHRoZSBicm93c2VyIHdpbmRvdy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IG5ld0FyZ3MgKG9wdGlvbmFsKSBPdmVycmlkZXMgYXJncyBwYXNzZWQgdG8gY29uc3RydWN0b3IKICAgICAqLwogICAgbWUuZGVsYXkgPSBmdW5jdGlvbihkZWxheSwgbmV3Rm4sIG5ld1Njb3BlLCBuZXdBcmdzKXsKICAgICAgICBtZS5jYW5jZWwoKTsKICAgICAgICBmbiA9IG5ld0ZuIHx8IGZuOwogICAgICAgIHNjb3BlID0gbmV3U2NvcGUgfHwgc2NvcGU7CiAgICAgICAgYXJncyA9IG5ld0FyZ3MgfHwgYXJnczsKICAgICAgICBpZCA9IHNldEludGVydmFsKGNhbGwsIGRlbGF5KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDYW5jZWwgdGhlIGxhc3QgcXVldWVkIHRpbWVvdXQKICAgICAqLwogICAgbWUuY2FuY2VsID0gZnVuY3Rpb24oKXsKICAgICAgICBpZihpZCl7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaWQpOwogICAgICAgICAgICBpZCA9IG51bGw7CiAgICAgICAgfQogICAgfTsKfTsvKioKICogQGNsYXNzIEV4dC5FbGVtZW50CiAqIDxwPkVuY2Fwc3VsYXRlcyBhIERPTSBlbGVtZW50LCBhZGRpbmcgc2ltcGxlIERPTSBtYW5pcHVsYXRpb24gZmFjaWxpdGllcywgbm9ybWFsaXppbmcgZm9yIGJyb3dzZXIgZGlmZmVyZW5jZXMuPC9wPgogKiA8cD5BbGwgaW5zdGFuY2VzIG9mIHRoaXMgY2xhc3MgaW5oZXJpdCB0aGUgbWV0aG9kcyBvZiB7QGxpbmsgRXh0LkZ4fSBtYWtpbmcgdmlzdWFsIGVmZmVjdHMgZWFzaWx5IGF2YWlsYWJsZSB0byBhbGwgRE9NIGVsZW1lbnRzLjwvcD4KICogPHA+Tm90ZSB0aGF0IHRoZSBldmVudHMgZG9jdW1lbnRlZCBpbiB0aGlzIGNsYXNzIGFyZSBub3QgRXh0IGV2ZW50cywgdGhleSBlbmNhcHN1bGF0ZSBicm93c2VyIGV2ZW50cy4gVG8KICogYWNjZXNzIHRoZSB1bmRlcmx5aW5nIGJyb3dzZXIgZXZlbnQsIHNlZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0I2Jyb3dzZXJFdmVudH0uIFNvbWUgb2xkZXIKICogYnJvd3NlcnMgbWF5IG5vdCBzdXBwb3J0IHRoZSBmdWxsIHJhbmdlIG9mIGV2ZW50cy4gV2hpY2ggZXZlbnRzIGFyZSBzdXBwb3J0ZWQgaXMgYmV5b25kIHRoZSBjb250cm9sIG9mIEV4dEpzLjwvcD4KICogVXNhZ2U6PGJyPgo8cHJlPjxjb2RlPgovLyBieSBpZAp2YXIgZWwgPSBFeHQuZ2V0KCJteS1kaXYiKTsKCi8vIGJ5IERPTSBlbGVtZW50IHJlZmVyZW5jZQp2YXIgZWwgPSBFeHQuZ2V0KG15RGl2RWxlbWVudCk7CjwvY29kZT48L3ByZT4KICogPGI+QW5pbWF0aW9uczwvYj48YnIgLz4KICogPHA+V2hlbiBhbiBlbGVtZW50IGlzIG1hbmlwdWxhdGVkLCBieSBkZWZhdWx0IHRoZXJlIGlzIG5vIGFuaW1hdGlvbi48L3A+CiAqIDxwcmU+PGNvZGU+CnZhciBlbCA9IEV4dC5nZXQoIm15LWRpdiIpOwoKLy8gbm8gYW5pbWF0aW9uCmVsLnNldFdpZHRoKDEwMCk7CiAqIDwvY29kZT48L3ByZT4KICogPHA+TWFueSBvZiB0aGUgZnVuY3Rpb25zIGZvciBtYW5pcHVsYXRpbmcgYW4gZWxlbWVudCBoYXZlIGFuIG9wdGlvbmFsICJhbmltYXRlIiBwYXJhbWV0ZXIuICBUaGlzCiAqIHBhcmFtZXRlciBjYW4gYmUgc3BlY2lmaWVkIGFzIGJvb2xlYW4gKDx0dD50cnVlPC90dD4pIGZvciBkZWZhdWx0IGFuaW1hdGlvbiBlZmZlY3RzLjwvcD4KICogPHByZT48Y29kZT4KLy8gZGVmYXVsdCBhbmltYXRpb24KZWwuc2V0V2lkdGgoMTAwLCB0cnVlKTsKICogPC9jb2RlPjwvcHJlPgogKgogKiA8cD5UbyBjb25maWd1cmUgdGhlIGVmZmVjdHMsIGFuIG9iamVjdCBsaXRlcmFsIHdpdGggYW5pbWF0aW9uIG9wdGlvbnMgdG8gdXNlIGFzIHRoZSBFbGVtZW50IGFuaW1hdGlvbgogKiBjb25maWd1cmF0aW9uIG9iamVjdCBjYW4gYWxzbyBiZSBzcGVjaWZpZWQuIE5vdGUgdGhhdCB0aGUgc3VwcG9ydGVkIEVsZW1lbnQgYW5pbWF0aW9uIGNvbmZpZ3VyYXRpb24KICogb3B0aW9ucyBhcmUgYSBzdWJzZXQgb2YgdGhlIHtAbGluayBFeHQuRnh9IGFuaW1hdGlvbiBvcHRpb25zIHNwZWNpZmljIHRvIEZ4IGVmZmVjdHMuICBUaGUgc3VwcG9ydGVkCiAqIEVsZW1lbnQgYW5pbWF0aW9uIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBhcmU6PC9wPgo8cHJlPgpPcHRpb24gICAgRGVmYXVsdCAgIERlc2NyaXB0aW9uCi0tLS0tLS0tLSAtLS0tLS0tLSAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCntAbGluayBFeHQuRngjZHVyYXRpb24gZHVyYXRpb259ICAuMzUgICAgICAgVGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb24gaW4gc2Vjb25kcwp7QGxpbmsgRXh0LkZ4I2Vhc2luZyBlYXNpbmd9ICAgIGVhc2VPdXQgICBUaGUgZWFzaW5nIG1ldGhvZAp7QGxpbmsgRXh0LkZ4I2NhbGxiYWNrIGNhbGxiYWNrfSAgbm9uZSAgICAgIEEgZnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIHRoZSBhbmltIGNvbXBsZXRlcwp7QGxpbmsgRXh0LkZ4I3Njb3BlIHNjb3BlfSAgICAgdGhpcyAgICAgIFRoZSBzY29wZSAodGhpcykgb2YgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uCjwvcHJlPgogKgogKiA8cHJlPjxjb2RlPgovLyBFbGVtZW50IGFuaW1hdGlvbiBvcHRpb25zIG9iamVjdAp2YXIgb3B0ID0gewogICAge0BsaW5rIEV4dC5GeCNkdXJhdGlvbiBkdXJhdGlvbn06IDEsCiAgICB7QGxpbmsgRXh0LkZ4I2Vhc2luZyBlYXNpbmd9OiAnZWxhc3RpY0luJywKICAgIHtAbGluayBFeHQuRngjY2FsbGJhY2sgY2FsbGJhY2t9OiB0aGlzLmZvbywKICAgIHtAbGluayBFeHQuRngjc2NvcGUgc2NvcGV9OiB0aGlzCn07Ci8vIGFuaW1hdGlvbiB3aXRoIHNvbWUgb3B0aW9ucyBzZXQKZWwuc2V0V2lkdGgoMTAwLCBvcHQpOwogKiA8L2NvZGU+PC9wcmU+CiAqIDxwPlRoZSBFbGVtZW50IGFuaW1hdGlvbiBvYmplY3QgYmVpbmcgdXNlZCBmb3IgdGhlIGFuaW1hdGlvbiB3aWxsIGJlIHNldCBvbiB0aGUgb3B0aW9ucwogKiBvYmplY3QgYXMgImFuaW0iLCB3aGljaCBhbGxvd3MgeW91IHRvIHN0b3Agb3IgbWFuaXB1bGF0ZSB0aGUgYW5pbWF0aW9uLiBIZXJlIGlzIGFuIGV4YW1wbGU6PC9wPgogKiA8cHJlPjxjb2RlPgovLyB1c2luZyB0aGUgImFuaW0iIHByb3BlcnR5IHRvIGdldCB0aGUgQW5pbSBvYmplY3QKaWYob3B0LmFuaW0uaXNBbmltYXRlZCgpKXsKICAgIG9wdC5hbmltLnN0b3AoKTsKfQogKiA8L2NvZGU+PC9wcmU+CiAqIDxwPkFsc28gc2VlIHRoZSA8dHQ+e0BsaW5rICNhbmltYXRlfTwvdHQ+IG1ldGhvZCBmb3IgYW5vdGhlciBhbmltYXRpb24gdGVjaG5pcXVlLjwvcD4KICogPHA+PGI+IENvbXBvc2l0ZSAoQ29sbGVjdGlvbnMgb2YpIEVsZW1lbnRzPC9iPjwvcD4KICogPHA+Rm9yIHdvcmtpbmcgd2l0aCBjb2xsZWN0aW9ucyBvZiBFbGVtZW50cywgc2VlIHtAbGluayBFeHQuQ29tcG9zaXRlRWxlbWVudH08L3A+CiAqIEBjb25zdHJ1Y3RvciBDcmVhdGUgYSBuZXcgRWxlbWVudCBkaXJlY3RseS4KICogQHBhcmFtIHtTdHJpbmcvSFRNTEVsZW1lbnR9IGVsZW1lbnQKICogQHBhcmFtIHtCb29sZWFufSBmb3JjZU5ldyAob3B0aW9uYWwpIEJ5IGRlZmF1bHQgdGhlIGNvbnN0cnVjdG9yIGNoZWNrcyB0byBzZWUgaWYgdGhlcmUgaXMgYWxyZWFkeSBhbiBpbnN0YW5jZSBvZiB0aGlzIGVsZW1lbnQgaW4gdGhlIGNhY2hlIGFuZCBpZiB0aGVyZSBpcyBpdCByZXR1cm5zIHRoZSBzYW1lIGluc3RhbmNlLiBUaGlzIHdpbGwgc2tpcCB0aGF0IGNoZWNrICh1c2VmdWwgZm9yIGV4dGVuZGluZyB0aGlzIGNsYXNzKS4KICovCihmdW5jdGlvbigpewp2YXIgRE9DID0gZG9jdW1lbnQ7CgpFeHQuRWxlbWVudCA9IGZ1bmN0aW9uKGVsZW1lbnQsIGZvcmNlTmV3KXsKICAgIHZhciBkb20gPSB0eXBlb2YgZWxlbWVudCA9PSAic3RyaW5nIiA/CiAgICAgICAgICAgICAgRE9DLmdldEVsZW1lbnRCeUlkKGVsZW1lbnQpIDogZWxlbWVudCwKICAgICAgICBpZDsKCiAgICBpZighZG9tKSByZXR1cm4gbnVsbDsKCiAgICBpZCA9IGRvbS5pZDsKCiAgICBpZighZm9yY2VOZXcgJiYgaWQgJiYgRXh0LmVsQ2FjaGVbaWRdKXsgLy8gZWxlbWVudCBvYmplY3QgYWxyZWFkeSBleGlzdHMKICAgICAgICByZXR1cm4gRXh0LmVsQ2FjaGVbaWRdLmVsOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIERPTSBlbGVtZW50CiAgICAgKiBAdHlwZSBIVE1MRWxlbWVudAogICAgICovCiAgICB0aGlzLmRvbSA9IGRvbTsKCiAgICAvKioKICAgICAqIFRoZSBET00gZWxlbWVudCBJRAogICAgICogQHR5cGUgU3RyaW5nCiAgICAgKi8KICAgIHRoaXMuaWQgPSBpZCB8fCBFeHQuaWQoZG9tKTsKfTsKCnZhciBESCA9IEV4dC5Eb21IZWxwZXIsCiAgICBFbCA9IEV4dC5FbGVtZW50LAogICAgRUMgPSBFeHQuZWxDYWNoZTsKCkVsLnByb3RvdHlwZSA9IHsKICAgIC8qKgogICAgICogU2V0cyB0aGUgcGFzc2VkIGF0dHJpYnV0ZXMgYXMgYXR0cmlidXRlcyBvZiB0aGlzIGVsZW1lbnQgKGEgc3R5bGUgYXR0cmlidXRlIGNhbiBiZSBhIHN0cmluZywgb2JqZWN0IG9yIGZ1bmN0aW9uKQogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9iamVjdCB3aXRoIHRoZSBhdHRyaWJ1dGVzCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IHVzZVNldCAob3B0aW9uYWwpIGZhbHNlIHRvIG92ZXJyaWRlIHRoZSBkZWZhdWx0IHNldEF0dHJpYnV0ZSB0byB1c2UgZXhwYW5kb3MuCiAgICAgKiBAcmV0dXJuIHtFeHQuRWxlbWVudH0gdGhpcwogICAgICovCiAgICBzZXQgOiBmdW5jdGlvbihvLCB1c2VTZXQpewogICAgICAgIHZhciBlbCA9IHRoaXMuZG9tLAogICAgICAgICAgICBhdHRyLAogICAgICAgICAgICB2YWwsCiAgICAgICAgICAgIHVzZVNldCA9ICh1c2VTZXQgIT09IGZhbHNlKSAmJiAhIWVsLnNldEF0dHJpYnV0ZTsKCiAgICAgICAgZm9yIChhdHRyIGluIG8pIHsKICAgICAgICAgICAgaWYgKG8uaGFzT3duUHJvcGVydHkoYXR0cikpIHsKICAgICAgICAgICAgICAgIHZhbCA9IG9bYXR0cl07CiAgICAgICAgICAgICAgICBpZiAoYXR0ciA9PSAnc3R5bGUnKSB7CiAgICAgICAgICAgICAgICAgICAgREguYXBwbHlTdHlsZXMoZWwsIHZhbCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF0dHIgPT0gJ2NscycpIHsKICAgICAgICAgICAgICAgICAgICBlbC5jbGFzc05hbWUgPSB2YWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVzZVNldCkgewogICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShhdHRyLCB2YWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlbFthdHRyXSA9IHZhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgovLyAgTW91c2UgZXZlbnRzCiAgICAvKioKICAgICAqIEBldmVudCBjbGljawogICAgICogRmlyZXMgd2hlbiBhIG1vdXNlIGNsaWNrIGlzIGRldGVjdGVkIHdpdGhpbiB0aGUgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KICAgIC8qKgogICAgICogQGV2ZW50IGNvbnRleHRtZW51CiAgICAgKiBGaXJlcyB3aGVuIGEgcmlnaHQgY2xpY2sgaXMgZGV0ZWN0ZWQgd2l0aGluIHRoZSBlbGVtZW50LgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgZGJsY2xpY2sKICAgICAqIEZpcmVzIHdoZW4gYSBtb3VzZSBkb3VibGUgY2xpY2sgaXMgZGV0ZWN0ZWQgd2l0aGluIHRoZSBlbGVtZW50LgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgbW91c2Vkb3duCiAgICAgKiBGaXJlcyB3aGVuIGEgbW91c2Vkb3duIGlzIGRldGVjdGVkIHdpdGhpbiB0aGUgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KICAgIC8qKgogICAgICogQGV2ZW50IG1vdXNldXAKICAgICAqIEZpcmVzIHdoZW4gYSBtb3VzZXVwIGlzIGRldGVjdGVkIHdpdGhpbiB0aGUgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KICAgIC8qKgogICAgICogQGV2ZW50IG1vdXNlb3ZlcgogICAgICogRmlyZXMgd2hlbiBhIG1vdXNlb3ZlciBpcyBkZXRlY3RlZCB3aXRoaW4gdGhlIGVsZW1lbnQuCiAgICAgKiBAcGFyYW0ge0V4dC5FdmVudE9iamVjdH0gZSBUaGUge0BsaW5rIEV4dC5FdmVudE9iamVjdH0gZW5jYXBzdWxhdGluZyB0aGUgRE9NIGV2ZW50LgogICAgICogQHBhcmFtIHtIdG1sRWxlbWVudH0gdCBUaGUgdGFyZ2V0IG9mIHRoZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvcHRpb25zIGNvbmZpZ3VyYXRpb24gcGFzc2VkIHRvIHRoZSB7QGxpbmsgI2FkZExpc3RlbmVyfSBjYWxsLgogICAgICovCiAgICAvKioKICAgICAqIEBldmVudCBtb3VzZW1vdmUKICAgICAqIEZpcmVzIHdoZW4gYSBtb3VzZW1vdmUgaXMgZGV0ZWN0ZWQgd2l0aCB0aGUgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KICAgIC8qKgogICAgICogQGV2ZW50IG1vdXNlb3V0CiAgICAgKiBGaXJlcyB3aGVuIGEgbW91c2VvdXQgaXMgZGV0ZWN0ZWQgd2l0aCB0aGUgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KICAgIC8qKgogICAgICogQGV2ZW50IG1vdXNlZW50ZXIKICAgICAqIEZpcmVzIHdoZW4gdGhlIG1vdXNlIGVudGVycyB0aGUgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KICAgIC8qKgogICAgICogQGV2ZW50IG1vdXNlbGVhdmUKICAgICAqIEZpcmVzIHdoZW4gdGhlIG1vdXNlIGxlYXZlcyB0aGUgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KCi8vICBLZXlib2FyZCBldmVudHMKICAgIC8qKgogICAgICogQGV2ZW50IGtleXByZXNzCiAgICAgKiBGaXJlcyB3aGVuIGEga2V5cHJlc3MgaXMgZGV0ZWN0ZWQgd2l0aGluIHRoZSBlbGVtZW50LgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQga2V5ZG93bgogICAgICogRmlyZXMgd2hlbiBhIGtleWRvd24gaXMgZGV0ZWN0ZWQgd2l0aGluIHRoZSBlbGVtZW50LgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQga2V5dXAKICAgICAqIEZpcmVzIHdoZW4gYSBrZXl1cCBpcyBkZXRlY3RlZCB3aXRoaW4gdGhlIGVsZW1lbnQuCiAgICAgKiBAcGFyYW0ge0V4dC5FdmVudE9iamVjdH0gZSBUaGUge0BsaW5rIEV4dC5FdmVudE9iamVjdH0gZW5jYXBzdWxhdGluZyB0aGUgRE9NIGV2ZW50LgogICAgICogQHBhcmFtIHtIdG1sRWxlbWVudH0gdCBUaGUgdGFyZ2V0IG9mIHRoZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvcHRpb25zIGNvbmZpZ3VyYXRpb24gcGFzc2VkIHRvIHRoZSB7QGxpbmsgI2FkZExpc3RlbmVyfSBjYWxsLgogICAgICovCgoKLy8gIEhUTUwgZnJhbWUvb2JqZWN0IGV2ZW50cwogICAgLyoqCiAgICAgKiBAZXZlbnQgbG9hZAogICAgICogRmlyZXMgd2hlbiB0aGUgdXNlciBhZ2VudCBmaW5pc2hlcyBsb2FkaW5nIGFsbCBjb250ZW50IHdpdGhpbiB0aGUgZWxlbWVudC4gT25seSBzdXBwb3J0ZWQgYnkgd2luZG93LCBmcmFtZXMsIG9iamVjdHMgYW5kIGltYWdlcy4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KICAgIC8qKgogICAgICogQGV2ZW50IHVubG9hZAogICAgICogRmlyZXMgd2hlbiB0aGUgdXNlciBhZ2VudCByZW1vdmVzIGFsbCBjb250ZW50IGZyb20gYSB3aW5kb3cgb3IgZnJhbWUuIEZvciBlbGVtZW50cywgaXQgZmlyZXMgd2hlbiB0aGUgdGFyZ2V0IGVsZW1lbnQgb3IgYW55IG9mIGl0cyBjb250ZW50IGhhcyBiZWVuIHJlbW92ZWQuCiAgICAgKiBAcGFyYW0ge0V4dC5FdmVudE9iamVjdH0gZSBUaGUge0BsaW5rIEV4dC5FdmVudE9iamVjdH0gZW5jYXBzdWxhdGluZyB0aGUgRE9NIGV2ZW50LgogICAgICogQHBhcmFtIHtIdG1sRWxlbWVudH0gdCBUaGUgdGFyZ2V0IG9mIHRoZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvcHRpb25zIGNvbmZpZ3VyYXRpb24gcGFzc2VkIHRvIHRoZSB7QGxpbmsgI2FkZExpc3RlbmVyfSBjYWxsLgogICAgICovCiAgICAvKioKICAgICAqIEBldmVudCBhYm9ydAogICAgICogRmlyZXMgd2hlbiBhbiBvYmplY3QvaW1hZ2UgaXMgc3RvcHBlZCBmcm9tIGxvYWRpbmcgYmVmb3JlIGNvbXBsZXRlbHkgbG9hZGVkLgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgZXJyb3IKICAgICAqIEZpcmVzIHdoZW4gYW4gb2JqZWN0L2ltYWdlL2ZyYW1lIGNhbm5vdCBiZSBsb2FkZWQgcHJvcGVybHkuCiAgICAgKiBAcGFyYW0ge0V4dC5FdmVudE9iamVjdH0gZSBUaGUge0BsaW5rIEV4dC5FdmVudE9iamVjdH0gZW5jYXBzdWxhdGluZyB0aGUgRE9NIGV2ZW50LgogICAgICogQHBhcmFtIHtIdG1sRWxlbWVudH0gdCBUaGUgdGFyZ2V0IG9mIHRoZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvcHRpb25zIGNvbmZpZ3VyYXRpb24gcGFzc2VkIHRvIHRoZSB7QGxpbmsgI2FkZExpc3RlbmVyfSBjYWxsLgogICAgICovCiAgICAvKioKICAgICAqIEBldmVudCByZXNpemUKICAgICAqIEZpcmVzIHdoZW4gYSBkb2N1bWVudCB2aWV3IGlzIHJlc2l6ZWQuCiAgICAgKiBAcGFyYW0ge0V4dC5FdmVudE9iamVjdH0gZSBUaGUge0BsaW5rIEV4dC5FdmVudE9iamVjdH0gZW5jYXBzdWxhdGluZyB0aGUgRE9NIGV2ZW50LgogICAgICogQHBhcmFtIHtIdG1sRWxlbWVudH0gdCBUaGUgdGFyZ2V0IG9mIHRoZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvcHRpb25zIGNvbmZpZ3VyYXRpb24gcGFzc2VkIHRvIHRoZSB7QGxpbmsgI2FkZExpc3RlbmVyfSBjYWxsLgogICAgICovCiAgICAvKioKICAgICAqIEBldmVudCBzY3JvbGwKICAgICAqIEZpcmVzIHdoZW4gYSBkb2N1bWVudCB2aWV3IGlzIHNjcm9sbGVkLgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwoKLy8gIEZvcm0gZXZlbnRzCiAgICAvKioKICAgICAqIEBldmVudCBzZWxlY3QKICAgICAqIEZpcmVzIHdoZW4gYSB1c2VyIHNlbGVjdHMgc29tZSB0ZXh0IGluIGEgdGV4dCBmaWVsZCwgaW5jbHVkaW5nIGlucHV0IGFuZCB0ZXh0YXJlYS4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KICAgIC8qKgogICAgICogQGV2ZW50IGNoYW5nZQogICAgICogRmlyZXMgd2hlbiBhIGNvbnRyb2wgbG9zZXMgdGhlIGlucHV0IGZvY3VzIGFuZCBpdHMgdmFsdWUgaGFzIGJlZW4gbW9kaWZpZWQgc2luY2UgZ2FpbmluZyBmb2N1cy4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KICAgIC8qKgogICAgICogQGV2ZW50IHN1Ym1pdAogICAgICogRmlyZXMgd2hlbiBhIGZvcm0gaXMgc3VibWl0dGVkLgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgcmVzZXQKICAgICAqIEZpcmVzIHdoZW4gYSBmb3JtIGlzIHJlc2V0LgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgZm9jdXMKICAgICAqIEZpcmVzIHdoZW4gYW4gZWxlbWVudCByZWNlaXZlcyBmb2N1cyBlaXRoZXIgdmlhIHRoZSBwb2ludGluZyBkZXZpY2Ugb3IgYnkgdGFiIG5hdmlnYXRpb24uCiAgICAgKiBAcGFyYW0ge0V4dC5FdmVudE9iamVjdH0gZSBUaGUge0BsaW5rIEV4dC5FdmVudE9iamVjdH0gZW5jYXBzdWxhdGluZyB0aGUgRE9NIGV2ZW50LgogICAgICogQHBhcmFtIHtIdG1sRWxlbWVudH0gdCBUaGUgdGFyZ2V0IG9mIHRoZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvcHRpb25zIGNvbmZpZ3VyYXRpb24gcGFzc2VkIHRvIHRoZSB7QGxpbmsgI2FkZExpc3RlbmVyfSBjYWxsLgogICAgICovCiAgICAvKioKICAgICAqIEBldmVudCBibHVyCiAgICAgKiBGaXJlcyB3aGVuIGFuIGVsZW1lbnQgbG9zZXMgZm9jdXMgZWl0aGVyIHZpYSB0aGUgcG9pbnRpbmcgZGV2aWNlIG9yIGJ5IHRhYmJpbmcgbmF2aWdhdGlvbi4KICAgICAqIEBwYXJhbSB7RXh0LkV2ZW50T2JqZWN0fSBlIFRoZSB7QGxpbmsgRXh0LkV2ZW50T2JqZWN0fSBlbmNhcHN1bGF0aW5nIHRoZSBET00gZXZlbnQuCiAgICAgKiBAcGFyYW0ge0h0bWxFbGVtZW50fSB0IFRoZSB0YXJnZXQgb2YgdGhlIGV2ZW50LgogICAgICogQHBhcmFtIHtPYmplY3R9IG8gVGhlIG9wdGlvbnMgY29uZmlndXJhdGlvbiBwYXNzZWQgdG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuCiAgICAgKi8KCi8vICBVc2VyIEludGVyZmFjZSBldmVudHMKICAgIC8qKgogICAgICogQGV2ZW50IERPTUZvY3VzSW4KICAgICAqIFdoZXJlIHN1cHBvcnRlZC4gU2ltaWxhciB0byBIVE1MIGZvY3VzIGV2ZW50LCBidXQgY2FuIGJlIGFwcGxpZWQgdG8gYW55IGZvY3VzYWJsZSBlbGVtZW50LgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgRE9NRm9jdXNPdXQKICAgICAqIFdoZXJlIHN1cHBvcnRlZC4gU2ltaWxhciB0byBIVE1MIGJsdXIgZXZlbnQsIGJ1dCBjYW4gYmUgYXBwbGllZCB0byBhbnkgZm9jdXNhYmxlIGVsZW1lbnQuCiAgICAgKiBAcGFyYW0ge0V4dC5FdmVudE9iamVjdH0gZSBUaGUge0BsaW5rIEV4dC5FdmVudE9iamVjdH0gZW5jYXBzdWxhdGluZyB0aGUgRE9NIGV2ZW50LgogICAgICogQHBhcmFtIHtIdG1sRWxlbWVudH0gdCBUaGUgdGFyZ2V0IG9mIHRoZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvcHRpb25zIGNvbmZpZ3VyYXRpb24gcGFzc2VkIHRvIHRoZSB7QGxpbmsgI2FkZExpc3RlbmVyfSBjYWxsLgogICAgICovCiAgICAvKioKICAgICAqIEBldmVudCBET01BY3RpdmF0ZQogICAgICogV2hlcmUgc3VwcG9ydGVkLiBGaXJlcyB3aGVuIGFuIGVsZW1lbnQgaXMgYWN0aXZhdGVkLCBmb3IgaW5zdGFuY2UsIHRocm91Z2ggYSBtb3VzZSBjbGljayBvciBhIGtleXByZXNzLgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwoKLy8gIERPTSBNdXRhdGlvbiBldmVudHMKICAgIC8qKgogICAgICogQGV2ZW50IERPTVN1YnRyZWVNb2RpZmllZAogICAgICogV2hlcmUgc3VwcG9ydGVkLiBGaXJlcyB3aGVuIHRoZSBzdWJ0cmVlIGlzIG1vZGlmaWVkLgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgRE9NTm9kZUluc2VydGVkCiAgICAgKiBXaGVyZSBzdXBwb3J0ZWQuIEZpcmVzIHdoZW4gYSBub2RlIGhhcyBiZWVuIGFkZGVkIGFzIGEgY2hpbGQgb2YgYW5vdGhlciBub2RlLgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgRE9NTm9kZVJlbW92ZWQKICAgICAqIFdoZXJlIHN1cHBvcnRlZC4gRmlyZXMgd2hlbiBhIGRlc2NlbmRhbnQgbm9kZSBvZiB0aGUgZWxlbWVudCBpcyByZW1vdmVkLgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgRE9NTm9kZVJlbW92ZWRGcm9tRG9jdW1lbnQKICAgICAqIFdoZXJlIHN1cHBvcnRlZC4gRmlyZXMgd2hlbiBhIG5vZGUgaXMgYmVpbmcgcmVtb3ZlZCBmcm9tIGEgZG9jdW1lbnQuCiAgICAgKiBAcGFyYW0ge0V4dC5FdmVudE9iamVjdH0gZSBUaGUge0BsaW5rIEV4dC5FdmVudE9iamVjdH0gZW5jYXBzdWxhdGluZyB0aGUgRE9NIGV2ZW50LgogICAgICogQHBhcmFtIHtIdG1sRWxlbWVudH0gdCBUaGUgdGFyZ2V0IG9mIHRoZSBldmVudC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBvcHRpb25zIGNvbmZpZ3VyYXRpb24gcGFzc2VkIHRvIHRoZSB7QGxpbmsgI2FkZExpc3RlbmVyfSBjYWxsLgogICAgICovCiAgICAvKioKICAgICAqIEBldmVudCBET01Ob2RlSW5zZXJ0ZWRJbnRvRG9jdW1lbnQKICAgICAqIFdoZXJlIHN1cHBvcnRlZC4gRmlyZXMgd2hlbiBhIG5vZGUgaXMgYmVpbmcgaW5zZXJ0ZWQgaW50byBhIGRvY3VtZW50LgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgRE9NQXR0ck1vZGlmaWVkCiAgICAgKiBXaGVyZSBzdXBwb3J0ZWQuIEZpcmVzIHdoZW4gYW4gYXR0cmlidXRlIGhhcyBiZWVuIG1vZGlmaWVkLgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwogICAgLyoqCiAgICAgKiBAZXZlbnQgRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkCiAgICAgKiBXaGVyZSBzdXBwb3J0ZWQuIEZpcmVzIHdoZW4gdGhlIGNoYXJhY3RlciBkYXRhIGhhcyBiZWVuIG1vZGlmaWVkLgogICAgICogQHBhcmFtIHtFeHQuRXZlbnRPYmplY3R9IGUgVGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3R9IGVuY2Fwc3VsYXRpbmcgdGhlIERPTSBldmVudC4KICAgICAqIEBwYXJhbSB7SHRtbEVsZW1lbnR9IHQgVGhlIHRhcmdldCBvZiB0aGUgZXZlbnQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbyBUaGUgb3B0aW9ucyBjb25maWd1cmF0aW9uIHBhc3NlZCB0byB0aGUge0BsaW5rICNhZGRMaXN0ZW5lcn0gY2FsbC4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGRlZmF1bHQgdW5pdCB0byBhcHBlbmQgdG8gQ1NTIHZhbHVlcyB3aGVyZSBhIHVuaXQgaXNuJ3QgcHJvdmlkZWQgKGRlZmF1bHRzIHRvIHB4KS4KICAgICAqIEB0eXBlIFN0cmluZwogICAgICovCiAgICBkZWZhdWx0VW5pdCA6ICJweCIsCgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhpcyBlbGVtZW50IG1hdGNoZXMgdGhlIHBhc3NlZCBzaW1wbGUgc2VsZWN0b3IgKGUuZy4gZGl2LnNvbWUtY2xhc3Mgb3Igc3BhbjpmaXJzdC1jaGlsZCkKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvciBUaGUgc2ltcGxlIHNlbGVjdG9yIHRvIHRlc3QKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IFRydWUgaWYgdGhpcyBlbGVtZW50IG1hdGNoZXMgdGhlIHNlbGVjdG9yLCBlbHNlIGZhbHNlCiAgICAgKi8KICAgIGlzIDogZnVuY3Rpb24oc2ltcGxlU2VsZWN0b3IpewogICAgICAgIHJldHVybiBFeHQuRG9tUXVlcnkuaXModGhpcy5kb20sIHNpbXBsZVNlbGVjdG9yKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBUcmllcyB0byBmb2N1cyB0aGUgZWxlbWVudC4gQW55IGV4Y2VwdGlvbnMgYXJlIGNhdWdodCBhbmQgaWdub3JlZC4KICAgICAqIEBwYXJhbSB7TnVtYmVyfSBkZWZlciAob3B0aW9uYWwpIE1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZm9jdXMKICAgICAqIEByZXR1cm4ge0V4dC5FbGVtZW50fSB0aGlzCiAgICAgKi8KICAgIGZvY3VzIDogZnVuY3Rpb24oZGVmZXIsIC8qIHByaXZhdGUgKi8gZG9tKSB7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgZG9tID0gZG9tIHx8IG1lLmRvbTsKICAgICAgICB0cnl7CiAgICAgICAgICAgIGlmKE51bWJlcihkZWZlcikpewogICAgICAgICAgICAgICAgbWUuZm9jdXMuZGVmZXIoZGVmZXIsIG51bGwsIFtudWxsLCBkb21dKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBkb20uZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgIH1jYXRjaChlKXt9CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKCiAgICAvKioKICAgICAqIFRyaWVzIHRvIGJsdXIgdGhlIGVsZW1lbnQuIEFueSBleGNlcHRpb25zIGFyZSBjYXVnaHQgYW5kIGlnbm9yZWQuCiAgICAgKiBAcmV0dXJuIHtFeHQuRWxlbWVudH0gdGhpcwogICAgICovCiAgICBibHVyIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdHJ5ewogICAgICAgICAgICB0aGlzLmRvbS5ibHVyKCk7CiAgICAgICAgfWNhdGNoKGUpe30KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgInZhbHVlIiBhdHRyaWJ1dGUKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gYXNOdW1iZXIgdHJ1ZSB0byBwYXJzZSB0aGUgdmFsdWUgYXMgYSBudW1iZXIKICAgICAqIEByZXR1cm4ge1N0cmluZy9OdW1iZXJ9CiAgICAgKi8KICAgIGdldFZhbHVlIDogZnVuY3Rpb24oYXNOdW1iZXIpewogICAgICAgIHZhciB2YWwgPSB0aGlzLmRvbS52YWx1ZTsKICAgICAgICByZXR1cm4gYXNOdW1iZXIgPyBwYXJzZUludCh2YWwsIDEwKSA6IHZhbDsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBcHBlbmRzIGFuIGV2ZW50IGhhbmRsZXIgdG8gdGhpcyBlbGVtZW50LiAgVGhlIHNob3J0aGFuZCB2ZXJzaW9uIHtAbGluayAjb259IGlzIGVxdWl2YWxlbnQuCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnROYW1lIFRoZSBuYW1lIG9mIGV2ZW50IHRvIGhhbmRsZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBoYW5kbGVyIGZ1bmN0aW9uIHRoZSBldmVudCBpbnZva2VzLiBUaGlzIGZ1bmN0aW9uIGlzIHBhc3NlZAogICAgICogdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOjx1bD4KICAgICAqIDxsaT48Yj5ldnQ8L2I+IDogRXZlbnRPYmplY3Q8ZGl2IGNsYXNzPSJzdWItZGVzYyI+VGhlIHtAbGluayBFeHQuRXZlbnRPYmplY3QgRXZlbnRPYmplY3R9IGRlc2NyaWJpbmcgdGhlIGV2ZW50LjwvZGl2PjwvbGk+CiAgICAgKiA8bGk+PGI+ZWw8L2I+IDogSHRtbEVsZW1lbnQ8ZGl2IGNsYXNzPSJzdWItZGVzYyI+VGhlIERPTSBlbGVtZW50IHdoaWNoIHdhcyB0aGUgdGFyZ2V0IG9mIHRoZSBldmVudC4KICAgICAqIE5vdGUgdGhhdCB0aGlzIG1heSBiZSBmaWx0ZXJlZCBieSB1c2luZyB0aGUgPHR0PmRlbGVnYXRlPC90dD4gb3B0aW9uLjwvZGl2PjwvbGk+CiAgICAgKiA8bGk+PGI+bzwvYj4gOiBPYmplY3Q8ZGl2IGNsYXNzPSJzdWItZGVzYyI+VGhlIG9wdGlvbnMgb2JqZWN0IGZyb20gdGhlIGFkZExpc3RlbmVyIGNhbGwuPC9kaXY+PC9saT4KICAgICAqIDwvdWw+CiAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NvcGUgKG9wdGlvbmFsKSBUaGUgc2NvcGUgKDxjb2RlPjxiPnRoaXM8L2I+PC9jb2RlPiByZWZlcmVuY2UpIGluIHdoaWNoIHRoZSBoYW5kbGVyIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICogPGI+SWYgb21pdHRlZCwgZGVmYXVsdHMgdG8gdGhpcyBFbGVtZW50LjwvYj4uCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAob3B0aW9uYWwpIEFuIG9iamVjdCBjb250YWluaW5nIGhhbmRsZXIgY29uZmlndXJhdGlvbiBwcm9wZXJ0aWVzLgogICAgICogVGhpcyBtYXkgY29udGFpbiBhbnkgb2YgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOjx1bD4KICAgICAqIDxsaT48Yj5zY29wZTwvYj4gT2JqZWN0IDogPGRpdiBjbGFzcz0ic3ViLWRlc2MiPlRoZSBzY29wZSAoPGNvZGU+PGI+dGhpczwvYj48L2NvZGU+IHJlZmVyZW5jZSkgaW4gd2hpY2ggdGhlIGhhbmRsZXIgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAgICAgKiA8Yj5JZiBvbWl0dGVkLCBkZWZhdWx0cyB0byB0aGlzIEVsZW1lbnQuPC9iPjwvZGl2PjwvbGk+CiAgICAgKiA8bGk+PGI+ZGVsZWdhdGU8L2I+IFN0cmluZzogPGRpdiBjbGFzcz0ic3ViLWRlc2MiPkEgc2ltcGxlIHNlbGVjdG9yIHRvIGZpbHRlciB0aGUgdGFyZ2V0IG9yIGxvb2sgZm9yIGEgZGVzY2VuZGFudCBvZiB0aGUgdGFyZ2V0LiBTZWUgYmVsb3cgZm9yIGFkZGl0aW9uYWwgZGV0YWlscy48L2Rpdj48L2xpPgogICAgICogPGxpPjxiPnN0b3BFdmVudDwvYj4gQm9vbGVhbjogPGRpdiBjbGFzcz0ic3ViLWRlc2MiPlRydWUgdG8gc3RvcCB0aGUgZXZlbnQuIFRoYXQgaXMgc3RvcCBwcm9wYWdhdGlvbiwgYW5kIHByZXZlbnQgdGhlIGRlZmF1bHQgYWN0aW9uLjwvZGl2PjwvbGk+CiAgICAgKiA8bGk+PGI+cHJldmVudERlZmF1bHQ8L2I+IEJvb2xlYW46IDxkaXYgY2xhc3M9InN1Yi1kZXNjIj5UcnVlIHRvIHByZXZlbnQgdGhlIGRlZmF1bHQgYWN0aW9uPC9kaXY+PC9saT4KICAgICAqIDxsaT48Yj5zdG9wUHJvcGFnYXRpb248L2I+IEJvb2xlYW46IDxkaXYgY2xhc3M9InN1Yi1kZXNjIj5UcnVlIHRvIHByZXZlbnQgZXZlbnQgcHJvcGFnYXRpb248L2Rpdj48L2xpPgogICAgICogPGxpPjxiPm5vcm1hbGl6ZWQ8L2I+IEJvb2xlYW46IDxkaXYgY2xhc3M9InN1Yi1kZXNjIj5GYWxzZSB0byBwYXNzIGEgYnJvd3NlciBldmVudCB0byB0aGUgaGFuZGxlciBmdW5jdGlvbiBpbnN0ZWFkIG9mIGFuIEV4dC5FdmVudE9iamVjdDwvZGl2PjwvbGk+CiAgICAgKiA8bGk+PGI+dGFyZ2V0PC9iPiBFeHQuRWxlbWVudDogPGRpdiBjbGFzcz0ic3ViLWRlc2MiPk9ubHkgY2FsbCB0aGUgaGFuZGxlciBpZiB0aGUgZXZlbnQgd2FzIGZpcmVkIG9uIHRoZSB0YXJnZXQgRWxlbWVudCwgPGk+bm90PC9pPiBpZiB0aGUgZXZlbnQgd2FzIGJ1YmJsZWQgdXAgZnJvbSBhIGNoaWxkIG5vZGUuPC9kaXY+PC9saT4KICAgICAqIDxsaT48Yj5kZWxheTwvYj4gTnVtYmVyOiA8ZGl2IGNsYXNzPSJzdWItZGVzYyI+VGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkgdGhlIGludm9jYXRpb24gb2YgdGhlIGhhbmRsZXIgYWZ0ZXIgdGhlIGV2ZW50IGZpcmVzLjwvZGl2PjwvbGk+CiAgICAgKiA8bGk+PGI+c2luZ2xlPC9iPiBCb29sZWFuOiA8ZGl2IGNsYXNzPSJzdWItZGVzYyI+VHJ1ZSB0byBhZGQgYSBoYW5kbGVyIHRvIGhhbmRsZSBqdXN0IHRoZSBuZXh0IGZpcmluZyBvZiB0aGUgZXZlbnQsIGFuZCB0aGVuIHJlbW92ZSBpdHNlbGYuPC9kaXY+PC9saT4KICAgICAqIDxsaT48Yj5idWZmZXI8L2I+IE51bWJlcjogPGRpdiBjbGFzcz0ic3ViLWRlc2MiPkNhdXNlcyB0aGUgaGFuZGxlciB0byBiZSBzY2hlZHVsZWQgdG8gcnVuIGluIGFuIHtAbGluayBFeHQudXRpbC5EZWxheWVkVGFza30gZGVsYXllZAogICAgICogYnkgdGhlIHNwZWNpZmllZCBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLiBJZiB0aGUgZXZlbnQgZmlyZXMgYWdhaW4gd2l0aGluIHRoYXQgdGltZSwgdGhlIG9yaWdpbmFsCiAgICAgKiBoYW5kbGVyIGlzIDxlbT5ub3Q8L2VtPiBpbnZva2VkLCBidXQgdGhlIG5ldyBoYW5kbGVyIGlzIHNjaGVkdWxlZCBpbiBpdHMgcGxhY2UuPC9kaXY+PC9saT4KICAgICAqIDwvdWw+PGJyPgogICAgICogPHA+CiAgICAgKiA8Yj5Db21iaW5pbmcgT3B0aW9uczwvYj48YnI+CiAgICAgKiBJbiB0aGUgZm9sbG93aW5nIGV4YW1wbGVzLCB0aGUgc2hvcnRoYW5kIGZvcm0ge0BsaW5rICNvbn0gaXMgdXNlZCByYXRoZXIgdGhhbiB0aGUgbW9yZSB2ZXJib3NlCiAgICAgKiBhZGRMaXN0ZW5lci4gIFRoZSB0d28gYXJlIGVxdWl2YWxlbnQuICBVc2luZyB0aGUgb3B0aW9ucyBhcmd1bWVudCwgaXQgaXMgcG9zc2libGUgdG8gY29tYmluZSBkaWZmZXJlbnQKICAgICAqIHR5cGVzIG9mIGxpc3RlbmVyczo8YnI+CiAgICAgKiA8YnI+CiAgICAgKiBBIGRlbGF5ZWQsIG9uZS10aW1lIGxpc3RlbmVyIHRoYXQgYXV0byBzdG9wcyB0aGUgZXZlbnQgYW5kIGFkZHMgYSBjdXN0b20gYXJndW1lbnQgKGZvcnVtSWQpIHRvIHRoZQogICAgICogb3B0aW9ucyBvYmplY3QuIFRoZSBvcHRpb25zIG9iamVjdCBpcyBhdmFpbGFibGUgYXMgdGhlIHRoaXJkIHBhcmFtZXRlciBpbiB0aGUgaGFuZGxlciBmdW5jdGlvbi48ZGl2IHN0eWxlPSJtYXJnaW46IDVweCAyMHB4IDIwcHg7Ij4KICAgICAqIENvZGU6PHByZT48Y29kZT4KZWwub24oJ2NsaWNrJywgdGhpcy5vbkNsaWNrLCB0aGlzLCB7CiAgICBzaW5nbGU6IHRydWUsCiAgICBkZWxheTogMTAwLAogICAgc3RvcEV2ZW50IDogdHJ1ZSwKICAgIGZvcnVtSWQ6IDQKfSk7PC9jb2RlPjwvcHJlPjwvcD4KICAgICAqIDxwPgogICAgICogPGI+QXR0YWNoaW5nIG11bHRpcGxlIGhhbmRsZXJzIGluIDEgY2FsbDwvYj48YnI+CiAgICAgKiBUaGUgbWV0aG9kIGFsc28gYWxsb3dzIGZvciBhIHNpbmdsZSBhcmd1bWVudCB0byBiZSBwYXNzZWQgd2hpY2ggaXMgYSBjb25maWcgb2JqZWN0IGNvbnRhaW5pbmcgcHJvcGVydGllcwogICAgICogd2hpY2ggc3BlY2lmeSBtdWx0aXBsZSBoYW5kbGVycy48L3A+CiAgICAgKiA8cD4KICAgICAqIENvZGU6PHByZT48Y29kZT4KZWwub24oewogICAgJ2NsaWNrJyA6IHsKICAgICAgICBmbjogdGhpcy5vbkNsaWNrLAogICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgIGRlbGF5OiAxMDAKICAgIH0sCiAgICAnbW91c2VvdmVyJyA6IHsKICAgICAgICBmbjogdGhpcy5vbk1vdXNlT3ZlciwKICAgICAgICBzY29wZTogdGhpcwogICAgfSwKICAgICdtb3VzZW91dCcgOiB7CiAgICAgICAgZm46IHRoaXMub25Nb3VzZU91dCwKICAgICAgICBzY29wZTogdGhpcwogICAgfQp9KTs8L2NvZGU+PC9wcmU+CiAgICAgKiA8cD4KICAgICAqIE9yIGEgc2hvcnRoYW5kIHN5bnRheDo8YnI+CiAgICAgKiBDb2RlOjxwcmU+PGNvZGU+PC9wPgplbC5vbih7CiAgICAnY2xpY2snIDogdGhpcy5vbkNsaWNrLAogICAgJ21vdXNlb3ZlcicgOiB0aGlzLm9uTW91c2VPdmVyLAogICAgJ21vdXNlb3V0JyA6IHRoaXMub25Nb3VzZU91dCwKICAgIHNjb3BlOiB0aGlzCn0pOwogICAgICogPC9jb2RlPjwvcHJlPjwvcD4KICAgICAqIDxwPjxiPmRlbGVnYXRlPC9iPjwvcD4KICAgICAqIDxwPlRoaXMgaXMgYSBjb25maWd1cmF0aW9uIG9wdGlvbiB0aGF0IHlvdSBjYW4gcGFzcyBhbG9uZyB3aGVuIHJlZ2lzdGVyaW5nIGEgaGFuZGxlciBmb3IKICAgICAqIGFuIGV2ZW50IHRvIGFzc2lzdCB3aXRoIGV2ZW50IGRlbGVnYXRpb24uIEV2ZW50IGRlbGVnYXRpb24gaXMgYSB0ZWNobmlxdWUgdGhhdCBpcyB1c2VkIHRvCiAgICAgKiByZWR1Y2UgbWVtb3J5IGNvbnN1bXB0aW9uIGFuZCBwcmV2ZW50IGV4cG9zdXJlIHRvIG1lbW9yeS1sZWFrcy4gQnkgcmVnaXN0ZXJpbmcgYW4gZXZlbnQKICAgICAqIGZvciBhIGNvbnRhaW5lciBlbGVtZW50IGFzIG9wcG9zZWQgdG8gZWFjaCBlbGVtZW50IHdpdGhpbiBhIGNvbnRhaW5lci4gQnkgc2V0dGluZyB0aGlzCiAgICAgKiBjb25maWd1cmF0aW9uIG9wdGlvbiB0byBhIHNpbXBsZSBzZWxlY3RvciwgdGhlIHRhcmdldCBlbGVtZW50IHdpbGwgYmUgZmlsdGVyZWQgdG8gbG9vayBmb3IKICAgICAqIGEgZGVzY2VuZGFudCBvZiB0aGUgdGFyZ2V0LgogICAgICogRm9yIGV4YW1wbGU6PHByZT48Y29kZT4KLy8gdXNpbmcgdGhpcyBtYXJrdXA6CiZsdDtkaXYgaWQ9J2VsSWQnPgogICAgJmx0O3AgaWQ9J3AxJz5wYXJhZ3JhcGggb25lJmx0Oy9wPgogICAgJmx0O3AgaWQ9J3AyJyBjbGFzcz0nY2xpY2thYmxlJz5wYXJhZ3JhcGggdHdvJmx0Oy9wPgogICAgJmx0O3AgaWQ9J3AzJz5wYXJhZ3JhcGggdGhyZWUmbHQ7L3A+CiZsdDsvZGl2PgovLyB1dGlsaXplIGV2ZW50IGRlbGVnYXRpb24gdG8gcmVnaXN0ZXJpbmcganVzdCBvbmUgaGFuZGxlciBvbiB0aGUgY29udGFpbmVyIGVsZW1lbnQ6CmVsID0gRXh0LmdldCgnZWxJZCcpOwplbC5vbigKICAgICdjbGljaycsCiAgICBmdW5jdGlvbihlLHQpIHsKICAgICAgICAvLyBoYW5kbGUgY2xpY2sKICAgICAgICBjb25zb2xlLmluZm8odC5pZCk7IC8vICdwMicKICAgIH0sCiAgICB0aGlzLAogICAgewogICAgICAgIC8vIGZpbHRlciB0aGUgdGFyZ2V0IGVsZW1lbnQgdG8gYmUgYSBkZXNjZW5kYW50IHdpdGggdGhlIGNsYXNzICdjbGlja2FibGUnCiAgICAgICAgZGVsZWdhdGU6ICcuY2xpY2thYmxlJwogICAgfQopOwogICAgICogPC9jb2RlPjwvcHJlPjwvcD4KICAgICAqIEByZXR1cm4ge0V4dC5FbGVtZW50fSB0aGlzCiAgICAgKi8KICAgIGFkZExpc3RlbmVyIDogZnVuY3Rpb24oZXZlbnROYW1lLCBmbiwgc2NvcGUsIG9wdGlvbnMpewogICAgICAgIEV4dC5FdmVudE1hbmFnZXIub24odGhpcy5kb20sICBldmVudE5hbWUsIGZuLCBzY29wZSB8fCB0aGlzLCBvcHRpb25zKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZW1vdmVzIGFuIGV2ZW50IGhhbmRsZXIgZnJvbSB0aGlzIGVsZW1lbnQuICBUaGUgc2hvcnRoYW5kIHZlcnNpb24ge0BsaW5rICN1bn0gaXMgZXF1aXZhbGVudC4KICAgICAqIDxiPk5vdGU8L2I+OiBpZiBhIDxpPnNjb3BlPC9pPiB3YXMgZXhwbGljaXRseSBzcGVjaWZpZWQgd2hlbiB7QGxpbmsgI2FkZExpc3RlbmVyIGFkZGluZ30gdGhlCiAgICAgKiBsaXN0ZW5lciwgdGhlIHNhbWUgc2NvcGUgbXVzdCBiZSBzcGVjaWZpZWQgaGVyZS4KICAgICAqIEV4YW1wbGU6CiAgICAgKiA8cHJlPjxjb2RlPgplbC5yZW1vdmVMaXN0ZW5lcignY2xpY2snLCB0aGlzLmhhbmRsZXJGbik7Ci8vIG9yCmVsLnVuKCdjbGljaycsIHRoaXMuaGFuZGxlckZuKTsKPC9jb2RlPjwvcHJlPgogICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50TmFtZSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQgZnJvbSB3aGljaCB0byByZW1vdmUgdGhlIGhhbmRsZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgaGFuZGxlciBmdW5jdGlvbiB0byByZW1vdmUuIDxiPlRoaXMgbXVzdCBiZSBhIHJlZmVyZW5jZSB0byB0aGUgZnVuY3Rpb24gcGFzc2VkIGludG8gdGhlIHtAbGluayAjYWRkTGlzdGVuZXJ9IGNhbGwuPC9iPgogICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIElmIGEgc2NvcGUgKDxiPjxjb2RlPnRoaXM8L2NvZGU+PC9iPiByZWZlcmVuY2UpIHdhcyBzcGVjaWZpZWQgd2hlbiB0aGUgbGlzdGVuZXIgd2FzIGFkZGVkLAogICAgICogdGhlbiB0aGlzIG11c3QgcmVmZXIgdG8gdGhlIHNhbWUgb2JqZWN0LgogICAgICogQHJldHVybiB7RXh0LkVsZW1lbnR9IHRoaXMKICAgICAqLwogICAgcmVtb3ZlTGlzdGVuZXIgOiBmdW5jdGlvbihldmVudE5hbWUsIGZuLCBzY29wZSl7CiAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5yZW1vdmVMaXN0ZW5lcih0aGlzLmRvbSwgIGV2ZW50TmFtZSwgZm4sIHNjb3BlIHx8IHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKioKICAgICAqIFJlbW92ZXMgYWxsIHByZXZpb3VzIGFkZGVkIGxpc3RlbmVycyBmcm9tIHRoaXMgZWxlbWVudAogICAgICogQHJldHVybiB7RXh0LkVsZW1lbnR9IHRoaXMKICAgICAqLwogICAgcmVtb3ZlQWxsTGlzdGVuZXJzIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLnJlbW92ZUFsbCh0aGlzLmRvbSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgICogUmVjdXJzaXZlbHkgcmVtb3ZlcyBhbGwgcHJldmlvdXMgYWRkZWQgbGlzdGVuZXJzIGZyb20gdGhpcyBlbGVtZW50IGFuZCBpdHMgY2hpbGRyZW4KICAgICAqIEByZXR1cm4ge0V4dC5FbGVtZW50fSB0aGlzCiAgICAgKi8KICAgIHB1cmdlQWxsTGlzdGVuZXJzIDogZnVuY3Rpb24oKSB7CiAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5wdXJnZUVsZW1lbnQodGhpcywgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgLyoqCiAgICAgKiBAcHJpdmF0ZSBUZXN0IGlmIHNpemUgaGFzIGEgdW5pdCwgb3RoZXJ3aXNlIGFwcGVuZHMgdGhlIGRlZmF1bHQKICAgICAqLwogICAgYWRkVW5pdHMgOiBmdW5jdGlvbihzaXplKXsKICAgICAgICBpZihzaXplID09PSAiIiB8fCBzaXplID09ICJhdXRvIiB8fCBzaXplID09PSB1bmRlZmluZWQpewogICAgICAgICAgICBzaXplID0gc2l6ZSB8fCAnJzsKICAgICAgICB9IGVsc2UgaWYoIWlzTmFOKHNpemUpIHx8ICF1bml0UGF0dGVybi50ZXN0KHNpemUpKXsKICAgICAgICAgICAgc2l6ZSA9IHNpemUgKyAodGhpcy5kZWZhdWx0VW5pdCB8fCAncHgnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNpemU7CiAgICB9LAoKICAgIC8qKgogICAgICogPHA+VXBkYXRlcyB0aGUgPGEgaHJlZj0iaHR0cDoKICAgICAqIGZyb20gYSBzcGVjaWZpZWQgVVJMLiBOb3RlIHRoYXQgdGhpcyBpcyBzdWJqZWN0IHRvIHRoZSA8YSBocmVmPSJodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1NhbWVfb3JpZ2luX3BvbGljeSI+U2FtZSBPcmlnaW4gUG9saWN5PC9hPjwvcD4KICAgICAqIDxwPlVwZGF0aW5nIGlubmVySFRNTCBvZiBhbiBlbGVtZW50IHdpbGwgPGI+bm90PC9iPiBleGVjdXRlIGVtYmVkZGVkIDx0dD4mbHQ7c2NyaXB0PjwvdHQ+IGVsZW1lbnRzLiBUaGlzIGlzIGEgYnJvd3NlciByZXN0cmljdGlvbi48L3A+CiAgICAgKiBAcGFyYW0ge01peGVkfSBvcHRpb25zLiBFaXRoZXIgYSBzcmluZyBjb250YWluaW5nIHRoZSBVUkwgZnJvbSB3aGljaCB0byBsb2FkIHRoZSBIVE1MLCBvciBhbiB7QGxpbmsgRXh0LkFqYXgjcmVxdWVzdH0gb3B0aW9ucyBvYmplY3Qgc3BlY2lmeWluZwogICAgICogZXhhY3RseSBob3cgdG8gcmVxdWVzdCB0aGUgSFRNTC4KICAgICAqIEByZXR1cm4ge0V4dC5FbGVtZW50fSB0aGlzCiAgICAgKi8KICAgIGxvYWQgOiBmdW5jdGlvbih1cmwsIHBhcmFtcywgY2IpewogICAgICAgIEV4dC5BamF4LnJlcXVlc3QoRXh0LmFwcGx5KHsKICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMsCiAgICAgICAgICAgIHVybDogdXJsLnVybCB8fCB1cmwsCiAgICAgICAgICAgIGNhbGxiYWNrOiBjYiwKICAgICAgICAgICAgZWw6IHRoaXMuZG9tLAogICAgICAgICAgICBpbmRpY2F0b3JUZXh0OiB1cmwuaW5kaWNhdG9yVGV4dCB8fCAnJwogICAgICAgIH0sIEV4dC5pc09iamVjdCh1cmwpID8gdXJsIDoge30pKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBpc0JvcmRlckJveCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIEV4dC5pc0JvcmRlckJveCB8fCBFeHQuaXNGb3JjZWRCb3JkZXJCb3ggfHwgbm9Cb3hBZGp1c3RbKHRoaXMuZG9tLnRhZ05hbWUgfHwgIiIpLnRvTG93ZXJDYXNlKCldOwogICAgfSwKCiAgICAKICAgIHJlbW92ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgZG9tID0gbWUuZG9tOwoKICAgICAgICBpZiAoZG9tKSB7CiAgICAgICAgICAgIGRlbGV0ZSBtZS5kb207CiAgICAgICAgICAgIEV4dC5yZW1vdmVOb2RlKGRvbSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGhvdmVyIDogZnVuY3Rpb24ob3ZlckZuLCBvdXRGbiwgc2NvcGUsIG9wdGlvbnMpewogICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgbWUub24oJ21vdXNlZW50ZXInLCBvdmVyRm4sIHNjb3BlIHx8IG1lLmRvbSwgb3B0aW9ucyk7CiAgICAgICAgbWUub24oJ21vdXNlbGVhdmUnLCBvdXRGbiwgc2NvcGUgfHwgbWUuZG9tLCBvcHRpb25zKTsKICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgIAogICAgY29udGFpbnMgOiBmdW5jdGlvbihlbCl7CiAgICAgICAgcmV0dXJuICFlbCA/IGZhbHNlIDogRXh0LmxpYi5Eb20uaXNBbmNlc3Rvcih0aGlzLmRvbSwgZWwuZG9tID8gZWwuZG9tIDogZWwpOwogICAgfSwKCiAgICAKICAgIGdldEF0dHJpYnV0ZU5TIDogZnVuY3Rpb24obnMsIG5hbWUpewogICAgICAgIHJldHVybiB0aGlzLmdldEF0dHJpYnV0ZShuYW1lLCBucyk7CiAgICB9LAoKICAgIAogICAgZ2V0QXR0cmlidXRlOiAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdGVzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyksCiAgICAgICAgICAgIGlzQnJva2VuT25UYWJsZSA9IGZhbHNlLAogICAgICAgICAgICBoYXNHZXRBdHRyaWJ1dGUgPSAnZ2V0QXR0cmlidXRlJyBpbiB0ZXN0LAogICAgICAgICAgICB1bmtub3duUmUgPSAvdW5kZWZpbmVkfHVua25vd24vOwogICAgICAgICAgICAKICAgICAgICBpZiAoaGFzR2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGVzdC5nZXRBdHRyaWJ1dGUoJ2V4dDpxdGlwJyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGlzQnJva2VuT25UYWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihuYW1lLCBucykgewogICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpcy5kb20sCiAgICAgICAgICAgICAgICAgICAgdmFsdWU7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChlbC5nZXRBdHRyaWJ1dGVOUykgewogICAgICAgICAgICAgICAgICAgIHZhbHVlICA9IGVsLmdldEF0dHJpYnV0ZU5TKG5zLCBuYW1lKSB8fCBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Jyb2tlbk9uVGFibGUgJiYgZWwudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09ICdUQUJMRScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBlbC5nZXRBdHRyaWJ1dGUobnMgKyAnOicgKyBuYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBlbC5nZXRBdHRyaWJ1dGUobnMgKyAnOicgKyBuYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZWwuZ2V0QXR0cmlidXRlKG5hbWUpIHx8IGVsW25hbWVdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSB8fCAnJzsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obmFtZSwgbnMpIHsKICAgICAgICAgICAgICAgIHZhciBlbCA9IHRoaXMub20sCiAgICAgICAgICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgYXR0cmlidXRlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAobnMpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgPSBlbFtucyArICc6JyArIG5hbWVdOwogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdW5rbm93blJlLnRlc3QodHlwZW9mIGF0dHJpYnV0ZSkgPyB1bmRlZmluZWQgOiBhdHRyaWJ1dGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gZWxbbmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgfHwgJyc7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHRlc3QgPSBudWxsOwogICAgfSkoKSwKICAgICAgICAKICAgIAogICAgdXBkYXRlIDogZnVuY3Rpb24oaHRtbCkgewogICAgICAgIGlmICh0aGlzLmRvbSkgewogICAgICAgICAgICB0aGlzLmRvbS5pbm5lckhUTUwgPSBodG1sOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KfTsKCnZhciBlcCA9IEVsLnByb3RvdHlwZTsKCkVsLmFkZE1ldGhvZHMgPSBmdW5jdGlvbihvKXsKICAgRXh0LmFwcGx5KGVwLCBvKTsKfTsKCgplcC5vbiA9IGVwLmFkZExpc3RlbmVyOwoKCmVwLnVuID0gZXAucmVtb3ZlTGlzdGVuZXI7CgoKZXAuYXV0b0JveEFkanVzdCA9IHRydWU7CgoKdmFyIHVuaXRQYXR0ZXJuID0gL1xkKyhweHxlbXwlfGVufGV4fHB0fGlufGNtfG1tfHBjKSQvaSwKICAgIGRvY0VsOwoKCgoKRWwuZ2V0ID0gZnVuY3Rpb24oZWwpewogICAgdmFyIGV4LAogICAgICAgIGVsbSwKICAgICAgICBpZDsKICAgIGlmKCFlbCl7IHJldHVybiBudWxsOyB9CiAgICBpZiAodHlwZW9mIGVsID09ICJzdHJpbmciKSB7IAogICAgICAgIGlmICghKGVsbSA9IERPQy5nZXRFbGVtZW50QnlJZChlbCkpKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAoRUNbZWxdICYmIEVDW2VsXS5lbCkgewogICAgICAgICAgICBleCA9IEVDW2VsXS5lbDsKICAgICAgICAgICAgZXguZG9tID0gZWxtOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4ID0gRWwuYWRkVG9DYWNoZShuZXcgRWwoZWxtKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBleDsKICAgIH0gZWxzZSBpZiAoZWwudGFnTmFtZSkgeyAKICAgICAgICBpZighKGlkID0gZWwuaWQpKXsKICAgICAgICAgICAgaWQgPSBFeHQuaWQoZWwpOwogICAgICAgIH0KICAgICAgICBpZiAoRUNbaWRdICYmIEVDW2lkXS5lbCkgewogICAgICAgICAgICBleCA9IEVDW2lkXS5lbDsKICAgICAgICAgICAgZXguZG9tID0gZWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXggPSBFbC5hZGRUb0NhY2hlKG5ldyBFbChlbCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXg7CiAgICB9IGVsc2UgaWYgKGVsIGluc3RhbmNlb2YgRWwpIHsKICAgICAgICBpZihlbCAhPSBkb2NFbCl7CiAgICAgICAgICAgIAogICAgICAgICAgICAKCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRXh0LmlzSUUgJiYgKGVsLmlkID09IHVuZGVmaW5lZCB8fCBlbC5pZCA9PSAnJykpIHsKICAgICAgICAgICAgICAgIGVsLmRvbSA9IGVsLmRvbTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVsLmRvbSA9IERPQy5nZXRFbGVtZW50QnlJZChlbC5pZCkgfHwgZWwuZG9tOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbDsKICAgIH0gZWxzZSBpZihlbC5pc0NvbXBvc2l0ZSkgewogICAgICAgIHJldHVybiBlbDsKICAgIH0gZWxzZSBpZihFeHQuaXNBcnJheShlbCkpIHsKICAgICAgICByZXR1cm4gRWwuc2VsZWN0KGVsKTsKICAgIH0gZWxzZSBpZihlbCA9PSBET0MpIHsKICAgICAgICAKICAgICAgICBpZighZG9jRWwpewogICAgICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKCl7fTsKICAgICAgICAgICAgZi5wcm90b3R5cGUgPSBFbC5wcm90b3R5cGU7CiAgICAgICAgICAgIGRvY0VsID0gbmV3IGYoKTsKICAgICAgICAgICAgZG9jRWwuZG9tID0gRE9DOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZG9jRWw7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKfTsKCkVsLmFkZFRvQ2FjaGUgPSBmdW5jdGlvbihlbCwgaWQpewogICAgaWQgPSBpZCB8fCBlbC5pZDsKICAgIEVDW2lkXSA9IHsKICAgICAgICBlbDogIGVsLAogICAgICAgIGRhdGE6IHt9LAogICAgICAgIGV2ZW50czoge30KICAgIH07CiAgICByZXR1cm4gZWw7Cn07CgoKRWwuZGF0YSA9IGZ1bmN0aW9uKGVsLCBrZXksIHZhbHVlKXsKICAgIGVsID0gRWwuZ2V0KGVsKTsKICAgIGlmICghZWwpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBjID0gRUNbZWwuaWRdLmRhdGE7CiAgICBpZihhcmd1bWVudHMubGVuZ3RoID09IDIpewogICAgICAgIHJldHVybiBjW2tleV07CiAgICB9ZWxzZXsKICAgICAgICByZXR1cm4gKGNba2V5XSA9IHZhbHVlKTsKICAgIH0KfTsKCgoKCmZ1bmN0aW9uIGdhcmJhZ2VDb2xsZWN0KCl7CiAgICBpZighRXh0LmVuYWJsZUdhcmJhZ2VDb2xsZWN0b3IpewogICAgICAgIGNsZWFySW50ZXJ2YWwoRWwuY29sbGVjdG9yVGhyZWFkSWQpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgZWlkLAogICAgICAgICAgICBlbCwKICAgICAgICAgICAgZCwKICAgICAgICAgICAgbzsKCiAgICAgICAgZm9yKGVpZCBpbiBFQyl7CiAgICAgICAgICAgIG8gPSBFQ1tlaWRdOwogICAgICAgICAgICBpZihvLnNraXBHQyl7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbCA9IG8uZWw7CiAgICAgICAgICAgIGQgPSBlbC5kb207CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYoIWQgfHwgIWQucGFyZW50Tm9kZSB8fCAoIWQub2Zmc2V0UGFyZW50ICYmICFET0MuZ2V0RWxlbWVudEJ5SWQoZWlkKSkpewogICAgICAgICAgICAgICAgaWYoRXh0LmVuYWJsZUxpc3RlbmVyQ29sbGVjdGlvbil7CiAgICAgICAgICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5yZW1vdmVBbGwoZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWxldGUgRUNbZWlkXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoRXh0LmlzSUUpIHsKICAgICAgICAgICAgdmFyIHQgPSB7fTsKICAgICAgICAgICAgZm9yIChlaWQgaW4gRUMpIHsKICAgICAgICAgICAgICAgIHRbZWlkXSA9IEVDW2VpZF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRUMgPSBFeHQuZWxDYWNoZSA9IHQ7CiAgICAgICAgfQogICAgfQp9CkVsLmNvbGxlY3RvclRocmVhZElkID0gc2V0SW50ZXJ2YWwoZ2FyYmFnZUNvbGxlY3QsIDMwMDAwKTsKCnZhciBmbHlGbiA9IGZ1bmN0aW9uKCl7fTsKZmx5Rm4ucHJvdG90eXBlID0gRWwucHJvdG90eXBlOwoKCkVsLkZseXdlaWdodCA9IGZ1bmN0aW9uKGRvbSl7CiAgICB0aGlzLmRvbSA9IGRvbTsKfTsKCkVsLkZseXdlaWdodC5wcm90b3R5cGUgPSBuZXcgZmx5Rm4oKTsKRWwuRmx5d2VpZ2h0LnByb3RvdHlwZS5pc0ZseXdlaWdodCA9IHRydWU7CkVsLl9mbHl3ZWlnaHRzID0ge307CgoKRWwuZmx5ID0gZnVuY3Rpb24oZWwsIG5hbWVkKXsKICAgIHZhciByZXQgPSBudWxsOwogICAgbmFtZWQgPSBuYW1lZCB8fCAnX2dsb2JhbCc7CgogICAgaWYgKGVsID0gRXh0LmdldERvbShlbCkpIHsKICAgICAgICAoRWwuX2ZseXdlaWdodHNbbmFtZWRdID0gRWwuX2ZseXdlaWdodHNbbmFtZWRdIHx8IG5ldyBFbC5GbHl3ZWlnaHQoKSkuZG9tID0gZWw7CiAgICAgICAgcmV0ID0gRWwuX2ZseXdlaWdodHNbbmFtZWRdOwogICAgfQogICAgcmV0dXJuIHJldDsKfTsKCgpFeHQuZ2V0ID0gRWwuZ2V0OwoKCkV4dC5mbHkgPSBFbC5mbHk7CgoKdmFyIG5vQm94QWRqdXN0ID0gRXh0LmlzU3RyaWN0ID8gewogICAgc2VsZWN0OjEKfSA6IHsKICAgIGlucHV0OjEsIHNlbGVjdDoxLCB0ZXh0YXJlYToxCn07CmlmKEV4dC5pc0lFIHx8IEV4dC5pc0dlY2tvKXsKICAgIG5vQm94QWRqdXN0WydidXR0b24nXSA9IDE7Cn0KCn0pKCk7CgpFeHQuRWxlbWVudC5hZGRNZXRob2RzKGZ1bmN0aW9uKCl7Cgl2YXIgUEFSRU5UTk9ERSA9ICdwYXJlbnROb2RlJywKCQlORVhUU0lCTElORyA9ICduZXh0U2libGluZycsCgkJUFJFVklPVVNTSUJMSU5HID0gJ3ByZXZpb3VzU2libGluZycsCgkJRFEgPSBFeHQuRG9tUXVlcnksCgkJR0VUID0gRXh0LmdldDsKCQoJcmV0dXJuIHsKCQkKCSAgICBmaW5kUGFyZW50IDogZnVuY3Rpb24oc2ltcGxlU2VsZWN0b3IsIG1heERlcHRoLCByZXR1cm5FbCl7CgkgICAgICAgIHZhciBwID0gdGhpcy5kb20sCgkgICAgICAgIAliID0gZG9jdW1lbnQuYm9keSwgCgkgICAgICAgIAlkZXB0aCA9IDAsIAkgICAgICAgIAkKCSAgICAgICAgCXN0b3BFbDsJICAgICAgICAKICAgICAgICAgICAgaWYoRXh0LmlzR2Vja28gJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHApID09ICdbb2JqZWN0IFhVTEVsZW1lbnRdJykgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KCSAgICAgICAgbWF4RGVwdGggPSBtYXhEZXB0aCB8fCA1MDsKCSAgICAgICAgaWYgKGlzTmFOKG1heERlcHRoKSkgewoJICAgICAgICAgICAgc3RvcEVsID0gRXh0LmdldERvbShtYXhEZXB0aCk7CgkgICAgICAgICAgICBtYXhEZXB0aCA9IE51bWJlci5NQVhfVkFMVUU7CgkgICAgICAgIH0KCSAgICAgICAgd2hpbGUocCAmJiBwLm5vZGVUeXBlID09IDEgJiYgZGVwdGggPCBtYXhEZXB0aCAmJiBwICE9IGIgJiYgcCAhPSBzdG9wRWwpewoJICAgICAgICAgICAgaWYoRFEuaXMocCwgc2ltcGxlU2VsZWN0b3IpKXsKCSAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuRWwgPyBHRVQocCkgOiBwOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZGVwdGgrKzsKCSAgICAgICAgICAgIHAgPSBwLnBhcmVudE5vZGU7CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgfSwKCQoJICAgIAoJICAgIGZpbmRQYXJlbnROb2RlIDogZnVuY3Rpb24oc2ltcGxlU2VsZWN0b3IsIG1heERlcHRoLCByZXR1cm5FbCl7CgkgICAgICAgIHZhciBwID0gRXh0LmZseSh0aGlzLmRvbS5wYXJlbnROb2RlLCAnX2ludGVybmFsJyk7CgkgICAgICAgIHJldHVybiBwID8gcC5maW5kUGFyZW50KHNpbXBsZVNlbGVjdG9yLCBtYXhEZXB0aCwgcmV0dXJuRWwpIDogbnVsbDsKCSAgICB9LAoJCgkgICAgCgkgICAgdXAgOiBmdW5jdGlvbihzaW1wbGVTZWxlY3RvciwgbWF4RGVwdGgpewoJICAgICAgICByZXR1cm4gdGhpcy5maW5kUGFyZW50Tm9kZShzaW1wbGVTZWxlY3RvciwgbWF4RGVwdGgsIHRydWUpOwoJICAgIH0sCgkKCSAgICAKCSAgICBzZWxlY3QgOiBmdW5jdGlvbihzZWxlY3Rvcil7CgkgICAgICAgIHJldHVybiBFeHQuRWxlbWVudC5zZWxlY3Qoc2VsZWN0b3IsIHRoaXMuZG9tKTsKCSAgICB9LAoJCgkgICAgCgkgICAgcXVlcnkgOiBmdW5jdGlvbihzZWxlY3Rvcil7CgkgICAgICAgIHJldHVybiBEUS5zZWxlY3Qoc2VsZWN0b3IsIHRoaXMuZG9tKTsKCSAgICB9LAoJCgkgICAgCgkgICAgY2hpbGQgOiBmdW5jdGlvbihzZWxlY3RvciwgcmV0dXJuRG9tKXsKCSAgICAgICAgdmFyIG4gPSBEUS5zZWxlY3ROb2RlKHNlbGVjdG9yLCB0aGlzLmRvbSk7CgkgICAgICAgIHJldHVybiByZXR1cm5Eb20gPyBuIDogR0VUKG4pOwoJICAgIH0sCgkKCSAgICAKCSAgICBkb3duIDogZnVuY3Rpb24oc2VsZWN0b3IsIHJldHVybkRvbSl7CgkgICAgICAgIHZhciBuID0gRFEuc2VsZWN0Tm9kZSgiID4gIiArIHNlbGVjdG9yLCB0aGlzLmRvbSk7CgkgICAgICAgIHJldHVybiByZXR1cm5Eb20gPyBuIDogR0VUKG4pOwoJICAgIH0sCgkKCQkgCgkgICAgcGFyZW50IDogZnVuY3Rpb24oc2VsZWN0b3IsIHJldHVybkRvbSl7CgkgICAgICAgIHJldHVybiB0aGlzLm1hdGNoTm9kZShQQVJFTlROT0RFLCBQQVJFTlROT0RFLCBzZWxlY3RvciwgcmV0dXJuRG9tKTsKCSAgICB9LAoJCgkgICAgIAoJICAgIG5leHQgOiBmdW5jdGlvbihzZWxlY3RvciwgcmV0dXJuRG9tKXsKCSAgICAgICAgcmV0dXJuIHRoaXMubWF0Y2hOb2RlKE5FWFRTSUJMSU5HLCBORVhUU0lCTElORywgc2VsZWN0b3IsIHJldHVybkRvbSk7CgkgICAgfSwKCQoJICAgIAoJICAgIHByZXYgOiBmdW5jdGlvbihzZWxlY3RvciwgcmV0dXJuRG9tKXsKCSAgICAgICAgcmV0dXJuIHRoaXMubWF0Y2hOb2RlKFBSRVZJT1VTU0lCTElORywgUFJFVklPVVNTSUJMSU5HLCBzZWxlY3RvciwgcmV0dXJuRG9tKTsKCSAgICB9LAoJCgkKCSAgICAKCSAgICBmaXJzdCA6IGZ1bmN0aW9uKHNlbGVjdG9yLCByZXR1cm5Eb20pewoJICAgICAgICByZXR1cm4gdGhpcy5tYXRjaE5vZGUoTkVYVFNJQkxJTkcsICdmaXJzdENoaWxkJywgc2VsZWN0b3IsIHJldHVybkRvbSk7CgkgICAgfSwKCQoJICAgIAoJICAgIGxhc3QgOiBmdW5jdGlvbihzZWxlY3RvciwgcmV0dXJuRG9tKXsKCSAgICAgICAgcmV0dXJuIHRoaXMubWF0Y2hOb2RlKFBSRVZJT1VTU0lCTElORywgJ2xhc3RDaGlsZCcsIHNlbGVjdG9yLCByZXR1cm5Eb20pOwoJICAgIH0sCgkgICAgCgkgICAgbWF0Y2hOb2RlIDogZnVuY3Rpb24oZGlyLCBzdGFydCwgc2VsZWN0b3IsIHJldHVybkRvbSl7CgkgICAgICAgIHZhciBuID0gdGhpcy5kb21bc3RhcnRdOwoJICAgICAgICB3aGlsZShuKXsKCSAgICAgICAgICAgIGlmKG4ubm9kZVR5cGUgPT0gMSAmJiAoIXNlbGVjdG9yIHx8IERRLmlzKG4sIHNlbGVjdG9yKSkpewoJICAgICAgICAgICAgICAgIHJldHVybiAhcmV0dXJuRG9tID8gR0VUKG4pIDogbjsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIG4gPSBuW2Rpcl07CgkgICAgICAgIH0KCSAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQkKICAgIH07Cn0oKSk7CkV4dC5FbGVtZW50LmFkZE1ldGhvZHMoCmZ1bmN0aW9uKCkgewoJdmFyIEdFVERPTSA9IEV4dC5nZXREb20sCgkJR0VUID0gRXh0LmdldCwKCQlESCA9IEV4dC5Eb21IZWxwZXI7CgkKCXJldHVybiB7CgkgICAgCgkgICAgYXBwZW5kQ2hpbGQ6IGZ1bmN0aW9uKGVsKXsgICAgICAgIAoJICAgICAgICByZXR1cm4gR0VUKGVsKS5hcHBlbmRUbyh0aGlzKTsgICAgICAgIAoJICAgIH0sCgkKCSAgICAKCSAgICBhcHBlbmRUbzogZnVuY3Rpb24oZWwpeyAgICAgICAgCgkgICAgICAgIEdFVERPTShlbCkuYXBwZW5kQ2hpbGQodGhpcy5kb20pOyAgICAgICAgCgkgICAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgkKCSAgICAKCSAgICBpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKGVsKXsgIAkgICAgICAgICAgCgkgICAgICAgIChlbCA9IEdFVERPTShlbCkpLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMuZG9tLCBlbCk7CgkgICAgICAgIHJldHVybiB0aGlzOwoJICAgIH0sCgkKCSAgICAKCSAgICBpbnNlcnRBZnRlcjogZnVuY3Rpb24oZWwpewoJICAgICAgICAoZWwgPSBHRVRET00oZWwpKS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0aGlzLmRvbSwgZWwubmV4dFNpYmxpbmcpOwoJICAgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoJCgkgICAgCgkgICAgaW5zZXJ0Rmlyc3Q6IGZ1bmN0aW9uKGVsLCByZXR1cm5Eb20pewogICAgICAgICAgICBlbCA9IGVsIHx8IHt9OwogICAgICAgICAgICBpZihlbC5ub2RlVHlwZSB8fCBlbC5kb20gfHwgdHlwZW9mIGVsID09ICdzdHJpbmcnKXsgCiAgICAgICAgICAgICAgICBlbCA9IEdFVERPTShlbCk7CiAgICAgICAgICAgICAgICB0aGlzLmRvbS5pbnNlcnRCZWZvcmUoZWwsIHRoaXMuZG9tLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgcmV0dXJuICFyZXR1cm5Eb20gPyBHRVQoZWwpIDogZWw7CiAgICAgICAgICAgIH1lbHNleyAKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUNoaWxkKGVsLCB0aGlzLmRvbS5maXJzdENoaWxkLCByZXR1cm5Eb20pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCQoJICAgIAoJICAgIHJlcGxhY2U6IGZ1bmN0aW9uKGVsKXsKCSAgICAgICAgZWwgPSBHRVQoZWwpOwoJICAgICAgICB0aGlzLmluc2VydEJlZm9yZShlbCk7CgkgICAgICAgIGVsLnJlbW92ZSgpOwoJICAgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoJCgkgICAgCgkgICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKGVsKXsKCQkgICAgdmFyIG1lID0gdGhpczsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZihlbC5ub2RlVHlwZSB8fCBlbC5kb20gfHwgdHlwZW9mIGVsID09ICdzdHJpbmcnKXsKICAgICAgICAgICAgICAgIGVsID0gR0VURE9NKGVsKTsKICAgICAgICAgICAgICAgIG1lLmRvbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShlbCwgbWUuZG9tKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBlbCA9IERILmluc2VydEJlZm9yZShtZS5kb20sIGVsKTsKICAgICAgICAgICAgfQoJICAgICAgICAKCSAgICAgICAgZGVsZXRlIEV4dC5lbENhY2hlW21lLmlkXTsKCSAgICAgICAgRXh0LnJlbW92ZU5vZGUobWUuZG9tKTsgICAgICAKCSAgICAgICAgbWUuaWQgPSBFeHQuaWQobWUuZG9tID0gZWwpOwoJICAgICAgICBFeHQuRWxlbWVudC5hZGRUb0NhY2hlKG1lLmlzRmx5d2VpZ2h0ID8gbmV3IEV4dC5FbGVtZW50KG1lLmRvbSkgOiBtZSk7ICAgICAKICAgICAgICAgICAgcmV0dXJuIG1lOwoJICAgIH0sCgkgICAgCgkJCgkJY3JlYXRlQ2hpbGQ6IGZ1bmN0aW9uKGNvbmZpZywgaW5zZXJ0QmVmb3JlLCByZXR1cm5Eb20pewoJCSAgICBjb25maWcgPSBjb25maWcgfHwge3RhZzonZGl2J307CgkJICAgIHJldHVybiBpbnNlcnRCZWZvcmUgPyAKCQkgICAgCSAgIERILmluc2VydEJlZm9yZShpbnNlcnRCZWZvcmUsIGNvbmZpZywgcmV0dXJuRG9tICE9PSB0cnVlKSA6CQoJCSAgICAJICAgREhbIXRoaXMuZG9tLmZpcnN0Q2hpbGQgPyAnb3ZlcndyaXRlJyA6ICdhcHBlbmQnXSh0aGlzLmRvbSwgY29uZmlnLCAgcmV0dXJuRG9tICE9PSB0cnVlKTsKCQl9LAoJCQoJCQoJCXdyYXA6IGZ1bmN0aW9uKGNvbmZpZywgcmV0dXJuRG9tKXsgICAgICAgIAoJCSAgICB2YXIgbmV3RWwgPSBESC5pbnNlcnRCZWZvcmUodGhpcy5kb20sIGNvbmZpZyB8fCB7dGFnOiAiZGl2In0sICFyZXR1cm5Eb20pOwoJCSAgICBuZXdFbC5kb20gPyBuZXdFbC5kb20uYXBwZW5kQ2hpbGQodGhpcy5kb20pIDogbmV3RWwuYXBwZW5kQ2hpbGQodGhpcy5kb20pOwoJCSAgICByZXR1cm4gbmV3RWw7CgkJfSwKCQkKCQkKCQlpbnNlcnRIdG1sIDogZnVuY3Rpb24od2hlcmUsIGh0bWwsIHJldHVybkVsKXsKCQkgICAgdmFyIGVsID0gREguaW5zZXJ0SHRtbCh3aGVyZSwgdGhpcy5kb20sIGh0bWwpOwoJCSAgICByZXR1cm4gcmV0dXJuRWwgPyBFeHQuZ2V0KGVsKSA6IGVsOwoJCX0KCX07Cn0oKSk7CkV4dC5FbGVtZW50LmFkZE1ldGhvZHMoZnVuY3Rpb24oKXsKICAgIAogICAgdmFyIHN1cHBvcnRzID0gRXh0LnN1cHBvcnRzLAogICAgICAgIHByb3BDYWNoZSA9IHt9LAogICAgICAgIGNhbWVsUmUgPSAvKC1bYS16XSkvZ2ksCiAgICAgICAgdmlldyA9IGRvY3VtZW50LmRlZmF1bHRWaWV3LAogICAgICAgIG9wYWNpdHlSZSA9IC9hbHBoYVwob3BhY2l0eT0oLiopXCkvaSwKICAgICAgICB0cmltUmUgPSAvXlxzK3xccyskL2csCiAgICAgICAgRUwgPSBFeHQuRWxlbWVudCwKICAgICAgICBzcGFjZXNSZSA9IC9ccysvLAogICAgICAgIHdvcmRzUmUgPSAvXHcvZywKICAgICAgICBQQURESU5HID0gInBhZGRpbmciLAogICAgICAgIE1BUkdJTiA9ICJtYXJnaW4iLAogICAgICAgIEJPUkRFUiA9ICJib3JkZXIiLAogICAgICAgIExFRlQgPSAiLWxlZnQiLAogICAgICAgIFJJR0hUID0gIi1yaWdodCIsCiAgICAgICAgVE9QID0gIi10b3AiLAogICAgICAgIEJPVFRPTSA9ICItYm90dG9tIiwKICAgICAgICBXSURUSCA9ICItd2lkdGgiLAogICAgICAgIE1BVEggPSBNYXRoLAogICAgICAgIEhJRERFTiA9ICdoaWRkZW4nLAogICAgICAgIElTQ0xJUFBFRCA9ICdpc0NsaXBwZWQnLAogICAgICAgIE9WRVJGTE9XID0gJ292ZXJmbG93JywKICAgICAgICBPVkVSRkxPV1ggPSAnb3ZlcmZsb3cteCcsCiAgICAgICAgT1ZFUkZMT1dZID0gJ292ZXJmbG93LXknLAogICAgICAgIE9SSUdJTkFMQ0xJUCA9ICdvcmlnaW5hbENsaXAnLAogICAgICAgIAogICAgICAgIGJvcmRlcnMgPSB7bDogQk9SREVSICsgTEVGVCArIFdJRFRILCByOiBCT1JERVIgKyBSSUdIVCArIFdJRFRILCB0OiBCT1JERVIgKyBUT1AgKyBXSURUSCwgYjogQk9SREVSICsgQk9UVE9NICsgV0lEVEh9LAogICAgICAgIHBhZGRpbmdzID0ge2w6IFBBRERJTkcgKyBMRUZULCByOiBQQURESU5HICsgUklHSFQsIHQ6IFBBRERJTkcgKyBUT1AsIGI6IFBBRERJTkcgKyBCT1RUT019LAogICAgICAgIG1hcmdpbnMgPSB7bDogTUFSR0lOICsgTEVGVCwgcjogTUFSR0lOICsgUklHSFQsIHQ6IE1BUkdJTiArIFRPUCwgYjogTUFSR0lOICsgQk9UVE9NfSwKICAgICAgICBkYXRhID0gRXh0LkVsZW1lbnQuZGF0YTsKCgogICAgCiAgICBmdW5jdGlvbiBjYW1lbEZuKG0sIGEpIHsKICAgICAgICByZXR1cm4gYS5jaGFyQXQoMSkudG9VcHBlckNhc2UoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGtDYWNoZShwcm9wKSB7CiAgICAgICAgcmV0dXJuIHByb3BDYWNoZVtwcm9wXSB8fCAocHJvcENhY2hlW3Byb3BdID0gcHJvcCA9PSAnZmxvYXQnID8gKHN1cHBvcnRzLmNzc0Zsb2F0ID8gJ2Nzc0Zsb2F0JyA6ICdzdHlsZUZsb2F0JykgOiBwcm9wLnJlcGxhY2UoY2FtZWxSZSwgY2FtZWxGbikpOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgCiAgICAgICAgYWRqdXN0V2lkdGggOiBmdW5jdGlvbih3aWR0aCkgewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgICAgICB2YXIgaXNOdW0gPSAodHlwZW9mIHdpZHRoID09ICJudW1iZXIiKTsKICAgICAgICAgICAgaWYoaXNOdW0gJiYgbWUuYXV0b0JveEFkanVzdCAmJiAhbWUuaXNCb3JkZXJCb3goKSl7CiAgICAgICAgICAgICAgIHdpZHRoIC09IChtZS5nZXRCb3JkZXJXaWR0aCgibHIiKSArIG1lLmdldFBhZGRpbmcoImxyIikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAoaXNOdW0gJiYgd2lkdGggPCAwKSA/IDAgOiB3aWR0aDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBhZGp1c3RIZWlnaHQgOiBmdW5jdGlvbihoZWlnaHQpIHsKICAgICAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICAgICAgdmFyIGlzTnVtID0gKHR5cGVvZiBoZWlnaHQgPT0gIm51bWJlciIpOwogICAgICAgICAgICBpZihpc051bSAmJiBtZS5hdXRvQm94QWRqdXN0ICYmICFtZS5pc0JvcmRlckJveCgpKXsKICAgICAgICAgICAgICAgaGVpZ2h0IC09IChtZS5nZXRCb3JkZXJXaWR0aCgidGIiKSArIG1lLmdldFBhZGRpbmcoInRiIikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAoaXNOdW0gJiYgaGVpZ2h0IDwgMCkgPyAwIDogaGVpZ2h0OwogICAgICAgIH0sCgoKICAgICAgICAKICAgICAgICBhZGRDbGFzcyA6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgbGVuLAogICAgICAgICAgICAgICAgdiwKICAgICAgICAgICAgICAgIGNscyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFFeHQuaXNBcnJheShjbGFzc05hbWUpKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNsYXNzTmFtZSA9PSAnc3RyaW5nJyAmJiAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbWUuZG9tLmNsYXNzTmFtZSArPSAiICIgKyBjbGFzc05hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBjbGFzc05hbWUubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2ID0gY2xhc3NOYW1lW2ldOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PSAnc3RyaW5nJyAmJiAoJyAnICsgbWUuZG9tLmNsYXNzTmFtZSArICcgJykuaW5kZXhPZignICcgKyB2ICsgJyAnKSA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBjbHMucHVzaCh2KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY2xzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIG1lLmRvbS5jbGFzc05hbWUgKz0gIiAiICsgY2xzLmpvaW4oIiAiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWU7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihjbGFzc05hbWUpewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIGlkeCwKICAgICAgICAgICAgICAgIGxlbiwKICAgICAgICAgICAgICAgIGNscywKICAgICAgICAgICAgICAgIGVsQ2xhc3NlczsKICAgICAgICAgICAgaWYgKCFFeHQuaXNBcnJheShjbGFzc05hbWUpKXsKICAgICAgICAgICAgICAgIGNsYXNzTmFtZSA9IFtjbGFzc05hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtZS5kb20gJiYgbWUuZG9tLmNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgZWxDbGFzc2VzID0gbWUuZG9tLmNsYXNzTmFtZS5yZXBsYWNlKHRyaW1SZSwgJycpLnNwbGl0KHNwYWNlc1JlKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGNsYXNzTmFtZS5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNscyA9IGNsYXNzTmFtZVtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNscyA9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBjbHMgPSBjbHMucmVwbGFjZSh0cmltUmUsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWR4ID0gZWxDbGFzc2VzLmluZGV4T2YoY2xzKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkeCAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxDbGFzc2VzLnNwbGljZShpZHgsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbWUuZG9tLmNsYXNzTmFtZSA9IGVsQ2xhc3Nlcy5qb2luKCIgIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1lOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHJhZGlvQ2xhc3MgOiBmdW5jdGlvbihjbGFzc05hbWUpewogICAgICAgICAgICB2YXIgY24gPSB0aGlzLmRvbS5wYXJlbnROb2RlLmNoaWxkTm9kZXMsCiAgICAgICAgICAgICAgICB2LAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIGxlbjsKICAgICAgICAgICAgY2xhc3NOYW1lID0gRXh0LmlzQXJyYXkoY2xhc3NOYW1lKSA/IGNsYXNzTmFtZSA6IFtjbGFzc05hbWVdOwogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBjbi5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgdiA9IGNuW2ldOwogICAgICAgICAgICAgICAgaWYgKHYgJiYgdi5ub2RlVHlwZSA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgRXh0LmZseSh2LCAnX2ludGVybmFsJykucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICB0b2dnbGVDbGFzcyA6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmhhc0NsYXNzKGNsYXNzTmFtZSkgPyB0aGlzLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSkgOiB0aGlzLmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaGFzQ2xhc3MgOiBmdW5jdGlvbihjbGFzc05hbWUpewogICAgICAgICAgICByZXR1cm4gY2xhc3NOYW1lICYmICgnICcrdGhpcy5kb20uY2xhc3NOYW1lKycgJykuaW5kZXhPZignICcrY2xhc3NOYW1lKycgJykgIT0gLTE7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcmVwbGFjZUNsYXNzIDogZnVuY3Rpb24ob2xkQ2xhc3NOYW1lLCBuZXdDbGFzc05hbWUpewogICAgICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmVDbGFzcyhvbGRDbGFzc05hbWUpLmFkZENsYXNzKG5ld0NsYXNzTmFtZSk7CiAgICAgICAgfSwKCiAgICAgICAgaXNTdHlsZSA6IGZ1bmN0aW9uKHN0eWxlLCB2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U3R5bGUoc3R5bGUpID09IHZhbDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRTdHlsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB2aWV3ICYmIHZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSA/CiAgICAgICAgICAgICAgICBmdW5jdGlvbihwcm9wKXsKICAgICAgICAgICAgICAgICAgICB2YXIgZWwgPSB0aGlzLmRvbSwKICAgICAgICAgICAgICAgICAgICAgICAgdiwKICAgICAgICAgICAgICAgICAgICAgICAgY3MsCiAgICAgICAgICAgICAgICAgICAgICAgIG91dCwKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTsKCiAgICAgICAgICAgICAgICAgICAgaWYoZWwgPT0gZG9jdW1lbnQpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcHJvcCA9IGNoa0NhY2hlKHByb3ApOwogICAgICAgICAgICAgICAgICAgIG91dCA9ICh2ID0gZWwuc3R5bGVbcHJvcF0pID8gdiA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgIChjcyA9IHZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgIiIpKSA/IGNzW3Byb3BdIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYocHJvcCA9PSAnbWFyZ2luUmlnaHQnICYmIG91dCAhPSAnMHB4JyAmJiAhc3VwcG9ydHMuY29ycmVjdFJpZ2h0TWFyZ2luKXsKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheSA9IGVsLnN0eWxlLmRpc3BsYXk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnaW5saW5lLWJsb2NrJzsKICAgICAgICAgICAgICAgICAgICAgICAgb3V0ID0gdmlldy5nZXRDb21wdXRlZFN0eWxlKGVsLCAnJykubWFyZ2luUmlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZihwcm9wID09ICdiYWNrZ3JvdW5kQ29sb3InICYmIG91dCA9PSAncmdiYSgwLCAwLCAwLCAwKScgJiYgIXN1cHBvcnRzLmNvcnJlY3RUcmFuc3BhcmVudENvbG9yKXsKICAgICAgICAgICAgICAgICAgICAgICAgb3V0ID0gJ3RyYW5zcGFyZW50JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dDsKICAgICAgICAgICAgICAgIH0gOgogICAgICAgICAgICAgICAgZnVuY3Rpb24ocHJvcCl7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpcy5kb20sCiAgICAgICAgICAgICAgICAgICAgICAgIG0sCiAgICAgICAgICAgICAgICAgICAgICAgIGNzOwoKICAgICAgICAgICAgICAgICAgICBpZihlbCA9PSBkb2N1bWVudCkgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByb3AgPT0gJ29wYWNpdHknKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbC5zdHlsZS5maWx0ZXIubWF0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0gPSBlbC5zdHlsZS5maWx0ZXIubWF0Y2gob3BhY2l0eVJlKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZ2ID0gcGFyc2VGbG9hdChtWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighaXNOYU4oZnYpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ2ID8gZnYgLyAxMDAgOiAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcHJvcCA9IGNoa0NhY2hlKHByb3ApOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbC5zdHlsZVtwcm9wXSB8fCAoKGNzID0gZWwuY3VycmVudFN0eWxlKSA/IGNzW3Byb3BdIDogbnVsbCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgIH0oKSwKCiAgICAgICAgCiAgICAgICAgZ2V0Q29sb3IgOiBmdW5jdGlvbihhdHRyLCBkZWZhdWx0VmFsdWUsIHByZWZpeCl7CiAgICAgICAgICAgIHZhciB2ID0gdGhpcy5nZXRTdHlsZShhdHRyKSwKICAgICAgICAgICAgICAgIGNvbG9yID0gKHR5cGVvZiBwcmVmaXggIT0gJ3VuZGVmaW5lZCcpID8gcHJlZml4IDogJyMnLAogICAgICAgICAgICAgICAgaDsKCiAgICAgICAgICAgIGlmKCF2IHx8ICgvdHJhbnNwYXJlbnR8aW5oZXJpdC8udGVzdCh2KSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoL15yLy50ZXN0KHYpKXsKICAgICAgICAgICAgICAgIEV4dC5lYWNoKHYuc2xpY2UoNCwgdi5sZW5ndGggLTEpLnNwbGl0KCcsJyksIGZ1bmN0aW9uKHMpewogICAgICAgICAgICAgICAgICAgIGggPSBwYXJzZUludChzLCAxMCk7CiAgICAgICAgICAgICAgICAgICAgY29sb3IgKz0gKGggPCAxNiA/ICcwJyA6ICcnKSArIGgudG9TdHJpbmcoMTYpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdiA9IHYucmVwbGFjZSgnIycsICcnKTsKICAgICAgICAgICAgICAgIGNvbG9yICs9IHYubGVuZ3RoID09IDMgPyB2LnJlcGxhY2UoL14oXHcpKFx3KShcdykkLywgJyQxJDEkMiQyJDMkMycpIDogdjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4oY29sb3IubGVuZ3RoID4gNSA/IGNvbG9yLnRvTG93ZXJDYXNlKCkgOiBkZWZhdWx0VmFsdWUpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHNldFN0eWxlIDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewogICAgICAgICAgICB2YXIgdG1wLCBzdHlsZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcCAhPSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgdG1wID0ge307CiAgICAgICAgICAgICAgICB0bXBbcHJvcF0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHByb3AgPSB0bXA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChzdHlsZSBpbiBwcm9wKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHByb3Bbc3R5bGVdOwogICAgICAgICAgICAgICAgc3R5bGUgPT0gJ29wYWNpdHknID8KICAgICAgICAgICAgICAgICAgICB0aGlzLnNldE9wYWNpdHkodmFsdWUpIDoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRvbS5zdHlsZVtjaGtDYWNoZShzdHlsZSldID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgIHNldE9wYWNpdHkgOiBmdW5jdGlvbihvcGFjaXR5LCBhbmltYXRlKXsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIHMgPSBtZS5kb20uc3R5bGU7CgogICAgICAgICAgICBpZighYW5pbWF0ZSB8fCAhbWUuYW5pbSl7CiAgICAgICAgICAgICAgICBpZihFeHQuaXNJRSl7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9wYWMgPSBvcGFjaXR5IDwgMSA/ICdhbHBoYShvcGFjaXR5PScgKyBvcGFjaXR5ICogMTAwICsgJyknIDogJycsCiAgICAgICAgICAgICAgICAgICAgdmFsID0gcy5maWx0ZXIucmVwbGFjZShvcGFjaXR5UmUsICcnKS5yZXBsYWNlKHRyaW1SZSwgJycpOwoKICAgICAgICAgICAgICAgICAgICBzLnpvb20gPSAxOwogICAgICAgICAgICAgICAgICAgIHMuZmlsdGVyID0gdmFsICsgKHZhbC5sZW5ndGggPiAwID8gJyAnIDogJycpICsgb3BhYzsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIHMub3BhY2l0eSA9IG9wYWNpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgbWUuYW5pbSh7b3BhY2l0eToge3RvOiBvcGFjaXR5fX0sIG1lLnByZWFuaW0oYXJndW1lbnRzLCAxKSwgbnVsbCwgLjM1LCAnZWFzZUluJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1lOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGNsZWFyT3BhY2l0eSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBzdHlsZSA9IHRoaXMuZG9tLnN0eWxlOwogICAgICAgICAgICBpZihFeHQuaXNJRSl7CiAgICAgICAgICAgICAgICBpZighRXh0LmlzRW1wdHkoc3R5bGUuZmlsdGVyKSl7CiAgICAgICAgICAgICAgICAgICAgc3R5bGUuZmlsdGVyID0gc3R5bGUuZmlsdGVyLnJlcGxhY2Uob3BhY2l0eVJlLCAnJykucmVwbGFjZSh0cmltUmUsICcnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBzdHlsZS5vcGFjaXR5ID0gc3R5bGVbJy1tb3otb3BhY2l0eSddID0gc3R5bGVbJy1raHRtbC1vcGFjaXR5J10gPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRIZWlnaHQgOiBmdW5jdGlvbihjb250ZW50SGVpZ2h0KXsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIGRvbSA9IG1lLmRvbSwKICAgICAgICAgICAgICAgIGhpZGRlbiA9IEV4dC5pc0lFICYmIG1lLmlzU3R5bGUoJ2Rpc3BsYXknLCAnbm9uZScpLAogICAgICAgICAgICAgICAgaCA9IE1BVEgubWF4KGRvbS5vZmZzZXRIZWlnaHQsIGhpZGRlbiA/IDAgOiBkb20uY2xpZW50SGVpZ2h0KSB8fCAwOwoKICAgICAgICAgICAgaCA9ICFjb250ZW50SGVpZ2h0ID8gaCA6IGggLSBtZS5nZXRCb3JkZXJXaWR0aCgidGIiKSAtIG1lLmdldFBhZGRpbmcoInRiIik7CiAgICAgICAgICAgIHJldHVybiBoIDwgMCA/IDAgOiBoOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldFdpZHRoIDogZnVuY3Rpb24oY29udGVudFdpZHRoKXsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIGRvbSA9IG1lLmRvbSwKICAgICAgICAgICAgICAgIGhpZGRlbiA9IEV4dC5pc0lFICYmIG1lLmlzU3R5bGUoJ2Rpc3BsYXknLCAnbm9uZScpLAogICAgICAgICAgICAgICAgdyA9IE1BVEgubWF4KGRvbS5vZmZzZXRXaWR0aCwgaGlkZGVuID8gMCA6IGRvbS5jbGllbnRXaWR0aCkgfHwgMDsKICAgICAgICAgICAgdyA9ICFjb250ZW50V2lkdGggPyB3IDogdyAtIG1lLmdldEJvcmRlcldpZHRoKCJsciIpIC0gbWUuZ2V0UGFkZGluZygibHIiKTsKICAgICAgICAgICAgcmV0dXJuIHcgPCAwID8gMCA6IHc7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgc2V0V2lkdGggOiBmdW5jdGlvbih3aWR0aCwgYW5pbWF0ZSl7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgICAgIHdpZHRoID0gbWUuYWRqdXN0V2lkdGgod2lkdGgpOwogICAgICAgICAgICAhYW5pbWF0ZSB8fCAhbWUuYW5pbSA/CiAgICAgICAgICAgICAgICBtZS5kb20uc3R5bGUud2lkdGggPSBtZS5hZGRVbml0cyh3aWR0aCkgOgogICAgICAgICAgICAgICAgbWUuYW5pbSh7d2lkdGggOiB7dG8gOiB3aWR0aH19LCBtZS5wcmVhbmltKGFyZ3VtZW50cywgMSkpOwogICAgICAgICAgICByZXR1cm4gbWU7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgIHNldEhlaWdodCA6IGZ1bmN0aW9uKGhlaWdodCwgYW5pbWF0ZSl7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgICAgIGhlaWdodCA9IG1lLmFkanVzdEhlaWdodChoZWlnaHQpOwogICAgICAgICAgICAhYW5pbWF0ZSB8fCAhbWUuYW5pbSA/CiAgICAgICAgICAgICAgICBtZS5kb20uc3R5bGUuaGVpZ2h0ID0gbWUuYWRkVW5pdHMoaGVpZ2h0KSA6CiAgICAgICAgICAgICAgICBtZS5hbmltKHtoZWlnaHQgOiB7dG8gOiBoZWlnaHR9fSwgbWUucHJlYW5pbShhcmd1bWVudHMsIDEpKTsKICAgICAgICAgICAgcmV0dXJuIG1lOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldEJvcmRlcldpZHRoIDogZnVuY3Rpb24oc2lkZSl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZFN0eWxlcyhzaWRlLCBib3JkZXJzKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRQYWRkaW5nIDogZnVuY3Rpb24oc2lkZSl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZFN0eWxlcyhzaWRlLCBwYWRkaW5ncyk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgY2xpcCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgICAgICBkb20gPSBtZS5kb207CgogICAgICAgICAgICBpZighZGF0YShkb20sIElTQ0xJUFBFRCkpewogICAgICAgICAgICAgICAgZGF0YShkb20sIElTQ0xJUFBFRCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBkYXRhKGRvbSwgT1JJR0lOQUxDTElQLCB7CiAgICAgICAgICAgICAgICAgICAgbzogbWUuZ2V0U3R5bGUoT1ZFUkZMT1cpLAogICAgICAgICAgICAgICAgICAgIHg6IG1lLmdldFN0eWxlKE9WRVJGTE9XWCksCiAgICAgICAgICAgICAgICAgICAgeTogbWUuZ2V0U3R5bGUoT1ZFUkZMT1dZKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBtZS5zZXRTdHlsZShPVkVSRkxPVywgSElEREVOKTsKICAgICAgICAgICAgICAgIG1lLnNldFN0eWxlKE9WRVJGTE9XWCwgSElEREVOKTsKICAgICAgICAgICAgICAgIG1lLnNldFN0eWxlKE9WRVJGTE9XWSwgSElEREVOKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWU7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgdW5jbGlwIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIGRvbSA9IG1lLmRvbTsKCiAgICAgICAgICAgIGlmKGRhdGEoZG9tLCBJU0NMSVBQRUQpKXsKICAgICAgICAgICAgICAgIGRhdGEoZG9tLCBJU0NMSVBQRUQsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHZhciBvID0gZGF0YShkb20sIE9SSUdJTkFMQ0xJUCk7CiAgICAgICAgICAgICAgICBpZihvLm8pewogICAgICAgICAgICAgICAgICAgIG1lLnNldFN0eWxlKE9WRVJGTE9XLCBvLm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoby54KXsKICAgICAgICAgICAgICAgICAgICBtZS5zZXRTdHlsZShPVkVSRkxPV1gsIG8ueCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihvLnkpewogICAgICAgICAgICAgICAgICAgIG1lLnNldFN0eWxlKE9WRVJGTE9XWSwgby55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWU7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgYWRkU3R5bGVzIDogZnVuY3Rpb24oc2lkZXMsIHN0eWxlcyl7CiAgICAgICAgICAgIHZhciB0dGxTaXplID0gMCwKICAgICAgICAgICAgICAgIHNpZGVzQXJyID0gc2lkZXMubWF0Y2god29yZHNSZSksCiAgICAgICAgICAgICAgICBzaWRlLAogICAgICAgICAgICAgICAgc2l6ZSwKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICBsZW4gPSBzaWRlc0Fyci5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgc2lkZSA9IHNpZGVzQXJyW2ldOwogICAgICAgICAgICAgICAgc2l6ZSA9IHNpZGUgJiYgcGFyc2VJbnQodGhpcy5nZXRTdHlsZShzdHlsZXNbc2lkZV0pLCAxMCk7CiAgICAgICAgICAgICAgICBpZiAoc2l6ZSkgewogICAgICAgICAgICAgICAgICAgIHR0bFNpemUgKz0gTUFUSC5hYnMoc2l6ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHR0bFNpemU7CiAgICAgICAgfSwKCiAgICAgICAgbWFyZ2lucyA6IG1hcmdpbnMKICAgIH07Cn0oKQopOwoKKGZ1bmN0aW9uKCl7CnZhciBEID0gRXh0LmxpYi5Eb20sCiAgICAgICAgTEVGVCA9ICJsZWZ0IiwKICAgICAgICBSSUdIVCA9ICJyaWdodCIsCiAgICAgICAgVE9QID0gInRvcCIsCiAgICAgICAgQk9UVE9NID0gImJvdHRvbSIsCiAgICAgICAgUE9TSVRJT04gPSAicG9zaXRpb24iLAogICAgICAgIFNUQVRJQyA9ICJzdGF0aWMiLAogICAgICAgIFJFTEFUSVZFID0gInJlbGF0aXZlIiwKICAgICAgICBBVVRPID0gImF1dG8iLAogICAgICAgIFpJTkRFWCA9ICJ6LWluZGV4IjsKCkV4dC5FbGVtZW50LmFkZE1ldGhvZHMoewoJCiAgICBnZXRYIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gRC5nZXRYKHRoaXMuZG9tKTsKICAgIH0sCgogICAgCiAgICBnZXRZIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gRC5nZXRZKHRoaXMuZG9tKTsKICAgIH0sCgogICAgCiAgICBnZXRYWSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIEQuZ2V0WFkodGhpcy5kb20pOwogICAgfSwKCiAgICAKICAgIGdldE9mZnNldHNUbyA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICB2YXIgbyA9IHRoaXMuZ2V0WFkoKSwKICAgICAgICAJZSA9IEV4dC5mbHkoZWwsICdfaW50ZXJuYWwnKS5nZXRYWSgpOwogICAgICAgIHJldHVybiBbb1swXS1lWzBdLG9bMV0tZVsxXV07CiAgICB9LAoKICAgIAogICAgc2V0WCA6IGZ1bmN0aW9uKHgsIGFuaW1hdGUpewkgICAgCgkgICAgcmV0dXJuIHRoaXMuc2V0WFkoW3gsIHRoaXMuZ2V0WSgpXSwgdGhpcy5hbmltVGVzdChhcmd1bWVudHMsIGFuaW1hdGUsIDEpKTsKICAgIH0sCgogICAgCiAgICBzZXRZIDogZnVuY3Rpb24oeSwgYW5pbWF0ZSl7CSAgICAKCSAgICByZXR1cm4gdGhpcy5zZXRYWShbdGhpcy5nZXRYKCksIHldLCB0aGlzLmFuaW1UZXN0KGFyZ3VtZW50cywgYW5pbWF0ZSwgMSkpOwogICAgfSwKCiAgICAKICAgIHNldExlZnQgOiBmdW5jdGlvbihsZWZ0KXsKICAgICAgICB0aGlzLnNldFN0eWxlKExFRlQsIHRoaXMuYWRkVW5pdHMobGVmdCkpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHNldFRvcCA6IGZ1bmN0aW9uKHRvcCl7CiAgICAgICAgdGhpcy5zZXRTdHlsZShUT1AsIHRoaXMuYWRkVW5pdHModG9wKSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgc2V0UmlnaHQgOiBmdW5jdGlvbihyaWdodCl7CiAgICAgICAgdGhpcy5zZXRTdHlsZShSSUdIVCwgdGhpcy5hZGRVbml0cyhyaWdodCkpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHNldEJvdHRvbSA6IGZ1bmN0aW9uKGJvdHRvbSl7CiAgICAgICAgdGhpcy5zZXRTdHlsZShCT1RUT00sIHRoaXMuYWRkVW5pdHMoYm90dG9tKSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgc2V0WFkgOiBmdW5jdGlvbihwb3MsIGFuaW1hdGUpewoJICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgaWYoIWFuaW1hdGUgfHwgIW1lLmFuaW0pewogICAgICAgICAgICBELnNldFhZKG1lLmRvbSwgcG9zKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgbWUuYW5pbSh7cG9pbnRzOiB7dG86IHBvc319LCBtZS5wcmVhbmltKGFyZ3VtZW50cywgMSksICdtb3Rpb24nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKCiAgICAKICAgIHNldExvY2F0aW9uIDogZnVuY3Rpb24oeCwgeSwgYW5pbWF0ZSl7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0WFkoW3gsIHldLCB0aGlzLmFuaW1UZXN0KGFyZ3VtZW50cywgYW5pbWF0ZSwgMikpOwogICAgfSwKCiAgICAKICAgIG1vdmVUbyA6IGZ1bmN0aW9uKHgsIHksIGFuaW1hdGUpewogICAgICAgIHJldHVybiB0aGlzLnNldFhZKFt4LCB5XSwgdGhpcy5hbmltVGVzdChhcmd1bWVudHMsIGFuaW1hdGUsIDIpKTsgICAgICAgIAogICAgfSwgICAgCiAgICAKICAgIAogICAgZ2V0TGVmdCA6IGZ1bmN0aW9uKGxvY2FsKXsKCSAgICByZXR1cm4gIWxvY2FsID8gdGhpcy5nZXRYKCkgOiBwYXJzZUludCh0aGlzLmdldFN0eWxlKExFRlQpLCAxMCkgfHwgMDsKICAgIH0sCgogICAgCiAgICBnZXRSaWdodCA6IGZ1bmN0aW9uKGxvY2FsKXsKCSAgICB2YXIgbWUgPSB0aGlzOwoJICAgIHJldHVybiAhbG9jYWwgPyBtZS5nZXRYKCkgKyBtZS5nZXRXaWR0aCgpIDogKG1lLmdldExlZnQodHJ1ZSkgKyBtZS5nZXRXaWR0aCgpKSB8fCAwOwogICAgfSwKCiAgICAKICAgIGdldFRvcCA6IGZ1bmN0aW9uKGxvY2FsKSB7CgkgICAgcmV0dXJuICFsb2NhbCA/IHRoaXMuZ2V0WSgpIDogcGFyc2VJbnQodGhpcy5nZXRTdHlsZShUT1ApLCAxMCkgfHwgMDsKICAgIH0sCgogICAgCiAgICBnZXRCb3R0b20gOiBmdW5jdGlvbihsb2NhbCl7CgkgICAgdmFyIG1lID0gdGhpczsKCSAgICByZXR1cm4gIWxvY2FsID8gbWUuZ2V0WSgpICsgbWUuZ2V0SGVpZ2h0KCkgOiAobWUuZ2V0VG9wKHRydWUpICsgbWUuZ2V0SGVpZ2h0KCkpIHx8IDA7CiAgICB9LAoKICAgIAogICAgcG9zaXRpb24gOiBmdW5jdGlvbihwb3MsIHpJbmRleCwgeCwgeSl7CgkgICAgdmFyIG1lID0gdGhpczsKCSAgICAKICAgICAgICBpZighcG9zICYmIG1lLmlzU3R5bGUoUE9TSVRJT04sIFNUQVRJQykpeyAgICAgICAgICAgCiAgICAgICAgICAgIG1lLnNldFN0eWxlKFBPU0lUSU9OLCBSRUxBVElWRSk7ICAgICAgICAgICAKICAgICAgICB9IGVsc2UgaWYocG9zKSB7CiAgICAgICAgICAgIG1lLnNldFN0eWxlKFBPU0lUSU9OLCBwb3MpOwogICAgICAgIH0KICAgICAgICBpZih6SW5kZXgpewogICAgICAgICAgICBtZS5zZXRTdHlsZShaSU5ERVgsIHpJbmRleCk7CiAgICAgICAgfQogICAgICAgIGlmKHggfHwgeSkgbWUuc2V0WFkoW3ggfHwgZmFsc2UsIHkgfHwgZmFsc2VdKTsKICAgIH0sCgogICAgCiAgICBjbGVhclBvc2l0aW9uaW5nIDogZnVuY3Rpb24odmFsdWUpewogICAgICAgIHZhbHVlID0gdmFsdWUgfHwgJyc7CiAgICAgICAgdGhpcy5zZXRTdHlsZSh7CiAgICAgICAgICAgIGxlZnQgOiB2YWx1ZSwKICAgICAgICAgICAgcmlnaHQgOiB2YWx1ZSwKICAgICAgICAgICAgdG9wIDogdmFsdWUsCiAgICAgICAgICAgIGJvdHRvbSA6IHZhbHVlLAogICAgICAgICAgICAiei1pbmRleCIgOiAiIiwKICAgICAgICAgICAgcG9zaXRpb24gOiBTVEFUSUMKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBnZXRQb3NpdGlvbmluZyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGwgPSB0aGlzLmdldFN0eWxlKExFRlQpOwogICAgICAgIHZhciB0ID0gdGhpcy5nZXRTdHlsZShUT1ApOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJwb3NpdGlvbiIgOiB0aGlzLmdldFN0eWxlKFBPU0lUSU9OKSwKICAgICAgICAgICAgImxlZnQiIDogbCwKICAgICAgICAgICAgInJpZ2h0IiA6IGwgPyAiIiA6IHRoaXMuZ2V0U3R5bGUoUklHSFQpLAogICAgICAgICAgICAidG9wIiA6IHQsCiAgICAgICAgICAgICJib3R0b20iIDogdCA/ICIiIDogdGhpcy5nZXRTdHlsZShCT1RUT00pLAogICAgICAgICAgICAiei1pbmRleCIgOiB0aGlzLmdldFN0eWxlKFpJTkRFWCkKICAgICAgICB9OwogICAgfSwKICAgIAogICAgCiAgICBzZXRQb3NpdGlvbmluZyA6IGZ1bmN0aW9uKHBjKXsKCSAgICB2YXIgbWUgPSB0aGlzLAoJICAgIAlzdHlsZSA9IG1lLmRvbS5zdHlsZTsKCSAgICAJCiAgICAgICAgbWUuc2V0U3R5bGUocGMpOwogICAgICAgIAogICAgICAgIGlmKHBjLnJpZ2h0ID09IEFVVE8pewogICAgICAgICAgICBzdHlsZS5yaWdodCA9ICIiOwogICAgICAgIH0KICAgICAgICBpZihwYy5ib3R0b20gPT0gQVVUTyl7CiAgICAgICAgICAgIHN0eWxlLmJvdHRvbSA9ICIiOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gbWU7CiAgICB9LCAgICAKCQogICAgCiAgICB0cmFuc2xhdGVQb2ludHMgOiBmdW5jdGlvbih4LCB5KXsgICAgICAgIAkgICAgIAoJICAgIHkgPSBpc05hTih4WzFdKSA/IHkgOiB4WzFdOwogICAgICAgIHggPSBpc05hTih4WzBdKSA/IHggOiB4WzBdOwogICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgCXJlbGF0aXZlID0gbWUuaXNTdHlsZShQT1NJVElPTiwgUkVMQVRJVkUpLAogICAgICAgIAlvID0gbWUuZ2V0WFkoKSwKICAgICAgICAJbCA9IHBhcnNlSW50KG1lLmdldFN0eWxlKExFRlQpLCAxMCksCiAgICAgICAgCXQgPSBwYXJzZUludChtZS5nZXRTdHlsZShUT1ApLCAxMCk7CiAgICAgICAgCiAgICAgICAgbCA9ICFpc05hTihsKSA/IGwgOiAocmVsYXRpdmUgPyAwIDogbWUuZG9tLm9mZnNldExlZnQpOwogICAgICAgIHQgPSAhaXNOYU4odCkgPyB0IDogKHJlbGF0aXZlID8gMCA6IG1lLmRvbS5vZmZzZXRUb3ApOyAgICAgICAgCgogICAgICAgIHJldHVybiB7bGVmdDogKHggLSBvWzBdICsgbCksIHRvcDogKHkgLSBvWzFdICsgdCl9OyAKICAgIH0sCiAgICAKICAgIGFuaW1UZXN0IDogZnVuY3Rpb24oYXJncywgYW5pbWF0ZSwgaSkgewogICAgICAgIHJldHVybiAhIWFuaW1hdGUgJiYgdGhpcy5wcmVhbmltID8gdGhpcy5wcmVhbmltKGFyZ3MsIGkpIDogZmFsc2U7CiAgICB9Cn0pOwp9KSgpOwpFeHQuRWxlbWVudC5hZGRNZXRob2RzKHsKICAgIAogICAgaXNTY3JvbGxhYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgZG9tID0gdGhpcy5kb207CiAgICAgICAgcmV0dXJuIGRvbS5zY3JvbGxIZWlnaHQgPiBkb20uY2xpZW50SGVpZ2h0IHx8IGRvbS5zY3JvbGxXaWR0aCA+IGRvbS5jbGllbnRXaWR0aDsKICAgIH0sCgogICAgCiAgICBzY3JvbGxUbyA6IGZ1bmN0aW9uKHNpZGUsIHZhbHVlKXsKICAgICAgICB0aGlzLmRvbVsic2Nyb2xsIiArICgvdG9wL2kudGVzdChzaWRlKSA/ICJUb3AiIDogIkxlZnQiKV0gPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBnZXRTY3JvbGwgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBkID0gdGhpcy5kb20sIAogICAgICAgICAgICBkb2MgPSBkb2N1bWVudCwKICAgICAgICAgICAgYm9keSA9IGRvYy5ib2R5LAogICAgICAgICAgICBkb2NFbGVtZW50ID0gZG9jLmRvY3VtZW50RWxlbWVudCwKICAgICAgICAgICAgbCwKICAgICAgICAgICAgdCwKICAgICAgICAgICAgcmV0OwoKICAgICAgICBpZihkID09IGRvYyB8fCBkID09IGJvZHkpewogICAgICAgICAgICBpZihFeHQuaXNJRSAmJiBFeHQuaXNTdHJpY3QpewogICAgICAgICAgICAgICAgbCA9IGRvY0VsZW1lbnQuc2Nyb2xsTGVmdDsgCiAgICAgICAgICAgICAgICB0ID0gZG9jRWxlbWVudC5zY3JvbGxUb3A7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgbCA9IHdpbmRvdy5wYWdlWE9mZnNldDsKICAgICAgICAgICAgICAgIHQgPSB3aW5kb3cucGFnZVlPZmZzZXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0ID0ge2xlZnQ6IGwgfHwgKGJvZHkgPyBib2R5LnNjcm9sbExlZnQgOiAwKSwgdG9wOiB0IHx8IChib2R5ID8gYm9keS5zY3JvbGxUb3AgOiAwKX07CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHJldCA9IHtsZWZ0OiBkLnNjcm9sbExlZnQsIHRvcDogZC5zY3JvbGxUb3B9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfQp9KTsKCkV4dC5FbGVtZW50LlZJU0lCSUxJVFkgPSAxOwoKRXh0LkVsZW1lbnQuRElTUExBWSA9IDI7CgoKRXh0LkVsZW1lbnQuT0ZGU0VUUyA9IDM7CgoKRXh0LkVsZW1lbnQuQVNDTEFTUyA9IDQ7CgoKRXh0LkVsZW1lbnQudmlzaWJpbGl0eUNscyA9ICd4LWhpZGUtbm9zaXplJzsKCkV4dC5FbGVtZW50LmFkZE1ldGhvZHMoZnVuY3Rpb24oKXsKICAgIHZhciBFbCA9IEV4dC5FbGVtZW50LAogICAgICAgIE9QQUNJVFkgPSAib3BhY2l0eSIsCiAgICAgICAgVklTSUJJTElUWSA9ICJ2aXNpYmlsaXR5IiwKICAgICAgICBESVNQTEFZID0gImRpc3BsYXkiLAogICAgICAgIEhJRERFTiA9ICJoaWRkZW4iLAogICAgICAgIE9GRlNFVFMgPSAib2Zmc2V0cyIsCiAgICAgICAgQVNDTEFTUyA9ICJhc2NsYXNzIiwKICAgICAgICBOT05FID0gIm5vbmUiLAogICAgICAgIE5PU0laRSA9ICdub3NpemUnLAogICAgICAgIE9SSUdJTkFMRElTUExBWSA9ICdvcmlnaW5hbERpc3BsYXknLAogICAgICAgIFZJU01PREUgPSAndmlzaWJpbGl0eU1vZGUnLAogICAgICAgIElTVklTSUJMRSA9ICdpc1Zpc2libGUnLAogICAgICAgIGRhdGEgPSBFbC5kYXRhLAogICAgICAgIGdldERpc3BsYXkgPSBmdW5jdGlvbihkb20pewogICAgICAgICAgICB2YXIgZCA9IGRhdGEoZG9tLCBPUklHSU5BTERJU1BMQVkpOwogICAgICAgICAgICBpZihkID09PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgZGF0YShkb20sIE9SSUdJTkFMRElTUExBWSwgZCA9ICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZDsKICAgICAgICB9LAogICAgICAgIGdldFZpc01vZGUgPSBmdW5jdGlvbihkb20pewogICAgICAgICAgICB2YXIgbSA9IGRhdGEoZG9tLCBWSVNNT0RFKTsKICAgICAgICAgICAgaWYobSA9PT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIGRhdGEoZG9tLCBWSVNNT0RFLCBtID0gMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG07CiAgICAgICAgfTsKCiAgICByZXR1cm4gewogICAgICAgIAogICAgICAgIG9yaWdpbmFsRGlzcGxheSA6ICIiLAogICAgICAgIHZpc2liaWxpdHlNb2RlIDogMSwKCiAgICAgICAgCiAgICAgICAgc2V0VmlzaWJpbGl0eU1vZGUgOiBmdW5jdGlvbih2aXNNb2RlKXsKICAgICAgICAgICAgZGF0YSh0aGlzLmRvbSwgVklTTU9ERSwgdmlzTW9kZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGFuaW1hdGUgOiBmdW5jdGlvbihhcmdzLCBkdXJhdGlvbiwgb25Db21wbGV0ZSwgZWFzaW5nLCBhbmltVHlwZSl7CiAgICAgICAgICAgIHRoaXMuYW5pbShhcmdzLCB7ZHVyYXRpb246IGR1cmF0aW9uLCBjYWxsYmFjazogb25Db21wbGV0ZSwgZWFzaW5nOiBlYXNpbmd9LCBhbmltVHlwZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGFuaW0gOiBmdW5jdGlvbihhcmdzLCBvcHQsIGFuaW1UeXBlLCBkZWZhdWx0RHVyLCBkZWZhdWx0RWFzZSwgY2IpewogICAgICAgICAgICBhbmltVHlwZSA9IGFuaW1UeXBlIHx8ICdydW4nOwogICAgICAgICAgICBvcHQgPSBvcHQgfHwge307CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgICAgICBhbmltID0gRXh0LmxpYi5BbmltW2FuaW1UeXBlXSgKICAgICAgICAgICAgICAgICAgICBtZS5kb20sCiAgICAgICAgICAgICAgICAgICAgYXJncywKICAgICAgICAgICAgICAgICAgICAob3B0LmR1cmF0aW9uIHx8IGRlZmF1bHREdXIpIHx8IC4zNSwKICAgICAgICAgICAgICAgICAgICAob3B0LmVhc2luZyB8fCBkZWZhdWx0RWFzZSkgfHwgJ2Vhc2VPdXQnLAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGNiKSBjYi5jYWxsKG1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYob3B0LmNhbGxiYWNrKSBvcHQuY2FsbGJhY2suY2FsbChvcHQuc2NvcGUgfHwgbWUsIG1lLCBvcHQpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgbWUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIG9wdC5hbmltID0gYW5pbTsKICAgICAgICAgICAgcmV0dXJuIGFuaW07CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcHJlYW5pbSA6IGZ1bmN0aW9uKGEsIGkpewogICAgICAgICAgICByZXR1cm4gIWFbaV0gPyBmYWxzZSA6ICh0eXBlb2YgYVtpXSA9PSAnb2JqZWN0JyA/IGFbaV06IHtkdXJhdGlvbjogYVtpKzFdLCBjYWxsYmFjazogYVtpKzJdLCBlYXNpbmc6IGFbaSszXX0pOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGlzVmlzaWJsZSA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgZG9tID0gbWUuZG9tLAogICAgICAgICAgICAgICAgdmlzaWJsZSA9IGRhdGEoZG9tLCBJU1ZJU0lCTEUpOwoKICAgICAgICAgICAgaWYodHlwZW9mIHZpc2libGUgPT0gJ2Jvb2xlYW4nKXsgCiAgICAgICAgICAgICAgICByZXR1cm4gdmlzaWJsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdmlzaWJsZSA9ICFtZS5pc1N0eWxlKFZJU0lCSUxJVFksIEhJRERFTikgJiYKICAgICAgICAgICAgICAgICAgICAgICFtZS5pc1N0eWxlKERJU1BMQVksIE5PTkUpICYmCiAgICAgICAgICAgICAgICAgICAgICAhKChnZXRWaXNNb2RlKGRvbSkgPT0gRWwuQVNDTEFTUykgJiYgbWUuaGFzQ2xhc3MobWUudmlzaWJpbGl0eUNscyB8fCBFbC52aXNpYmlsaXR5Q2xzKSk7CgogICAgICAgICAgICBkYXRhKGRvbSwgSVNWSVNJQkxFLCB2aXNpYmxlKTsKICAgICAgICAgICAgcmV0dXJuIHZpc2libGU7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgc2V0VmlzaWJsZSA6IGZ1bmN0aW9uKHZpc2libGUsIGFuaW1hdGUpewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzLCBpc0Rpc3BsYXksIGlzVmlzaWJpbGl0eSwgaXNPZmZzZXRzLCBpc05vc2l6ZSwKICAgICAgICAgICAgICAgIGRvbSA9IG1lLmRvbSwKICAgICAgICAgICAgICAgIHZpc01vZGUgPSBnZXRWaXNNb2RlKGRvbSk7CgoKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0eXBlb2YgYW5pbWF0ZSA9PSAnc3RyaW5nJyl7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGFuaW1hdGUpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIERJU1BMQVk6CiAgICAgICAgICAgICAgICAgICAgICAgIHZpc01vZGUgPSBFbC5ESVNQTEFZOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIFZJU0lCSUxJVFk6CiAgICAgICAgICAgICAgICAgICAgICAgIHZpc01vZGUgPSBFbC5WSVNJQklMSVRZOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIE9GRlNFVFM6CiAgICAgICAgICAgICAgICAgICAgICAgIHZpc01vZGUgPSBFbC5PRkZTRVRTOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIE5PU0laRToKICAgICAgICAgICAgICAgICAgICBjYXNlIEFTQ0xBU1M6CiAgICAgICAgICAgICAgICAgICAgICAgIHZpc01vZGUgPSBFbC5BU0NMQVNTOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1lLnNldFZpc2liaWxpdHlNb2RlKHZpc01vZGUpOwogICAgICAgICAgICAgICAgYW5pbWF0ZSA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFuaW1hdGUgfHwgIW1lLmFuaW0pIHsKICAgICAgICAgICAgICAgIGlmKHZpc01vZGUgPT0gRWwuQVNDTEFTUyApewoKICAgICAgICAgICAgICAgICAgICBtZVt2aXNpYmxlPydyZW1vdmVDbGFzcyc6J2FkZENsYXNzJ10obWUudmlzaWJpbGl0eUNscyB8fCBFbC52aXNpYmlsaXR5Q2xzKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZpc01vZGUgPT0gRWwuRElTUExBWSl7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBtZS5zZXREaXNwbGF5ZWQodmlzaWJsZSk7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh2aXNNb2RlID09IEVsLk9GRlNFVFMpewoKICAgICAgICAgICAgICAgICAgICBpZiAoIXZpc2libGUpewogICAgICAgICAgICAgICAgICAgICAgICBtZS5oaWRlTW9kZVN0eWxlcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBtZS5nZXRTdHlsZSgncG9zaXRpb24nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogbWUuZ2V0U3R5bGUoJ3RvcCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogbWUuZ2V0U3R5bGUoJ2xlZnQnKQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBtZS5hcHBseVN0eWxlcyh7cG9zaXRpb246ICdhYnNvbHV0ZScsIHRvcDogJy0xMDAwMHB4JywgbGVmdDogJy0xMDAwMHB4J30pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lLmFwcGx5U3R5bGVzKG1lLmhpZGVNb2RlU3R5bGVzIHx8IHtwb3NpdGlvbjogJycsIHRvcDogJycsIGxlZnQ6ICcnfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBtZS5oaWRlTW9kZVN0eWxlczsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgbWUuZml4RGlzcGxheSgpOwogICAgICAgICAgICAgICAgICAgIGRvbS5zdHlsZS52aXNpYmlsaXR5ID0gdmlzaWJsZSA/ICJ2aXNpYmxlIiA6IEhJRERFTjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmKHZpc2libGUpewogICAgICAgICAgICAgICAgICAgIG1lLnNldE9wYWNpdHkoLjAxKTsKICAgICAgICAgICAgICAgICAgICBtZS5zZXRWaXNpYmxlKHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbWUuYW5pbSh7b3BhY2l0eTogeyB0bzogKHZpc2libGU/MTowKSB9fSwKICAgICAgICAgICAgICAgICAgICAgICAgbWUucHJlYW5pbShhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAuMzUsCiAgICAgICAgICAgICAgICAgICAgICAgICdlYXNlSW4nLAogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJsZSB8fCBtZS5zZXRWaXNpYmxlKGZhbHNlKS5zZXRPcGFjaXR5KDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkYXRhKGRvbSwgSVNWSVNJQkxFLCB2aXNpYmxlKTsgIAogICAgICAgICAgICByZXR1cm4gbWU7CiAgICAgICAgfSwKCgogICAgICAgIAogICAgICAgIGhhc01ldHJpY3MgIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXMuZG9tOwogICAgICAgICAgICByZXR1cm4gdGhpcy5pc1Zpc2libGUoKSB8fCAoZ2V0VmlzTW9kZShkb20pID09IEVsLlZJU0lCSUxJVFkpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHRvZ2dsZSA6IGZ1bmN0aW9uKGFuaW1hdGUpewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgICAgICBtZS5zZXRWaXNpYmxlKCFtZS5pc1Zpc2libGUoKSwgbWUucHJlYW5pbShhcmd1bWVudHMsIDApKTsKICAgICAgICAgICAgcmV0dXJuIG1lOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHNldERpc3BsYXllZCA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGlmKHR5cGVvZiB2YWx1ZSA9PSAiYm9vbGVhbiIpewogICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlID8gZ2V0RGlzcGxheSh0aGlzLmRvbSkgOiBOT05FOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoRElTUExBWSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBmaXhEaXNwbGF5IDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICAgICAgaWYobWUuaXNTdHlsZShESVNQTEFZLCBOT05FKSl7CiAgICAgICAgICAgICAgICBtZS5zZXRTdHlsZShWSVNJQklMSVRZLCBISURERU4pOwogICAgICAgICAgICAgICAgbWUuc2V0U3R5bGUoRElTUExBWSwgZ2V0RGlzcGxheSh0aGlzLmRvbSkpOyAKICAgICAgICAgICAgICAgIGlmKG1lLmlzU3R5bGUoRElTUExBWSwgTk9ORSkpeyAKICAgICAgICAgICAgICAgICAgICBtZS5zZXRTdHlsZShESVNQTEFZLCAiYmxvY2siKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGhpZGUgOiBmdW5jdGlvbihhbmltYXRlKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0eXBlb2YgYW5pbWF0ZSA9PSAnc3RyaW5nJyl7CiAgICAgICAgICAgICAgICB0aGlzLnNldFZpc2libGUoZmFsc2UsIGFuaW1hdGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZXRWaXNpYmxlKGZhbHNlLCB0aGlzLnByZWFuaW0oYXJndW1lbnRzLCAwKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHNob3cgOiBmdW5jdGlvbihhbmltYXRlKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0eXBlb2YgYW5pbWF0ZSA9PSAnc3RyaW5nJyl7CiAgICAgICAgICAgICAgICB0aGlzLnNldFZpc2libGUodHJ1ZSwgYW5pbWF0ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNldFZpc2libGUodHJ1ZSwgdGhpcy5wcmVhbmltKGFyZ3VtZW50cywgMCkpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICB9Owp9KCkpOyhmdW5jdGlvbigpewogICAgCiAgICB2YXIgTlVMTCA9IG51bGwsCiAgICAgICAgVU5ERUZJTkVEID0gdW5kZWZpbmVkLAogICAgICAgIFRSVUUgPSB0cnVlLAogICAgICAgIEZBTFNFID0gZmFsc2UsCiAgICAgICAgU0VUWCA9ICJzZXRYIiwKICAgICAgICBTRVRZID0gInNldFkiLAogICAgICAgIFNFVFhZID0gInNldFhZIiwKICAgICAgICBMRUZUID0gImxlZnQiLAogICAgICAgIEJPVFRPTSA9ICJib3R0b20iLAogICAgICAgIFRPUCA9ICJ0b3AiLAogICAgICAgIFJJR0hUID0gInJpZ2h0IiwKICAgICAgICBIRUlHSFQgPSAiaGVpZ2h0IiwKICAgICAgICBXSURUSCA9ICJ3aWR0aCIsCiAgICAgICAgUE9JTlRTID0gInBvaW50cyIsCiAgICAgICAgSElEREVOID0gImhpZGRlbiIsCiAgICAgICAgQUJTT0xVVEUgPSAiYWJzb2x1dGUiLAogICAgICAgIFZJU0lCTEUgPSAidmlzaWJsZSIsCiAgICAgICAgTU9USU9OID0gIm1vdGlvbiIsCiAgICAgICAgUE9TSVRJT04gPSAicG9zaXRpb24iLAogICAgICAgIEVBU0VPVVQgPSAiZWFzZU91dCIsCiAgICAgICAgCiAgICAgICAgZmx5RWwgPSBuZXcgRXh0LkVsZW1lbnQuRmx5d2VpZ2h0KCksCiAgICAgICAgcXVldWVzID0ge30sCiAgICAgICAgZ2V0T2JqZWN0ID0gZnVuY3Rpb24obyl7CiAgICAgICAgICAgIHJldHVybiBvIHx8IHt9OwogICAgICAgIH0sCiAgICAgICAgZmx5ID0gZnVuY3Rpb24oZG9tKXsKICAgICAgICAgICAgZmx5RWwuZG9tID0gZG9tOwogICAgICAgICAgICBmbHlFbC5pZCA9IEV4dC5pZChkb20pOwogICAgICAgICAgICByZXR1cm4gZmx5RWw7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICBnZXRRdWV1ZSA9IGZ1bmN0aW9uKGlkKXsKICAgICAgICAgICAgaWYoIXF1ZXVlc1tpZF0pewogICAgICAgICAgICAgICAgcXVldWVzW2lkXSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBxdWV1ZXNbaWRdOwogICAgICAgIH0sCiAgICAgICAgc2V0UXVldWUgPSBmdW5jdGlvbihpZCwgdmFsdWUpewogICAgICAgICAgICBxdWV1ZXNbaWRdID0gdmFsdWU7CiAgICAgICAgfTsKICAgICAgICAKCkV4dC5lbmFibGVGeCA9IFRSVUU7CgoKRXh0LkZ4ID0gewogICAgCiAgICAKICAgIAogICAgc3dpdGNoU3RhdGVtZW50cyA6IGZ1bmN0aW9uKGtleSwgZm4sIGFyZ0hhc2gpewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmdIYXNoW2tleV0pOwogICAgfSwKICAgIAogICAgCiAgICBzbGlkZUluIDogZnVuY3Rpb24oYW5jaG9yLCBvKXsgCiAgICAgICAgbyA9IGdldE9iamVjdChvKTsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBkb20gPSBtZS5kb20sCiAgICAgICAgICAgIHN0ID0gZG9tLnN0eWxlLAogICAgICAgICAgICB4eSwKICAgICAgICAgICAgciwKICAgICAgICAgICAgYiwgICAgICAgICAgICAgIAogICAgICAgICAgICB3cmFwLCAgICAgICAgICAgICAgIAogICAgICAgICAgICBhZnRlciwKICAgICAgICAgICAgc3QsCiAgICAgICAgICAgIGFyZ3MsIAogICAgICAgICAgICBwdCwKICAgICAgICAgICAgYncsCiAgICAgICAgICAgIGJoOwogICAgICAgICAgICAKICAgICAgICBhbmNob3IgPSBhbmNob3IgfHwgInQiOwoKICAgICAgICBtZS5xdWV1ZUZ4KG8sIGZ1bmN0aW9uKCl7ICAgICAgICAgICAgCiAgICAgICAgICAgIHh5ID0gZmx5KGRvbSkuZ2V0WFkoKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZseShkb20pLmZpeERpc3BsYXkoKTsgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICByID0gZmx5KGRvbSkuZ2V0RnhSZXN0b3JlKCk7ICAgICAgCiAgICAgICAgICAgIGIgPSB7eDogeHlbMF0sIHk6IHh5WzFdLCAwOiB4eVswXSwgMTogeHlbMV0sIHdpZHRoOiBkb20ub2Zmc2V0V2lkdGgsIGhlaWdodDogZG9tLm9mZnNldEhlaWdodH07CiAgICAgICAgICAgIGIucmlnaHQgPSBiLnggKyBiLndpZHRoOwogICAgICAgICAgICBiLmJvdHRvbSA9IGIueSArIGIuaGVpZ2h0OwogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGZseShkb20pLnNldFdpZHRoKGIud2lkdGgpLnNldEhlaWdodChiLmhlaWdodCk7ICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgd3JhcCA9IGZseShkb20pLmZ4V3JhcChyLnBvcywgbywgSElEREVOKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHN0LnZpc2liaWxpdHkgPSBWSVNJQkxFOwogICAgICAgICAgICBzdC5wb3NpdGlvbiA9IEFCU09MVVRFOwogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyKCl7CiAgICAgICAgICAgICAgICAgZmx5KGRvbSkuZnhVbndyYXAod3JhcCwgci5wb3MsIG8pOwogICAgICAgICAgICAgICAgIHN0LndpZHRoID0gci53aWR0aDsKICAgICAgICAgICAgICAgICBzdC5oZWlnaHQgPSByLmhlaWdodDsKICAgICAgICAgICAgICAgICBmbHkoZG9tKS5hZnRlckZ4KG8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgcHQgPSB7dG86IFtiLngsIGIueV19OyAKICAgICAgICAgICAgYncgPSB7dG86IGIud2lkdGh9OwogICAgICAgICAgICBiaCA9IHt0bzogYi5oZWlnaHR9OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGZ1bmN0aW9uIGFyZ0NhbGMod3JhcCwgc3R5bGUsIHd3LCB3aCwgc1hZLCBzWFl2YWwsIHMxLCBzMiwgdywgaCwgcCl7ICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciByZXQgPSB7fTsKICAgICAgICAgICAgICAgIGZseSh3cmFwKS5zZXRXaWR0aCh3dykuc2V0SGVpZ2h0KHdoKTsKICAgICAgICAgICAgICAgIGlmKGZseSh3cmFwKVtzWFldKXsKICAgICAgICAgICAgICAgICAgICBmbHkod3JhcClbc1hZXShzWFl2YWwpOyAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3R5bGVbczFdID0gc3R5bGVbczJdID0gIjAiOyAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZih3KXsKICAgICAgICAgICAgICAgICAgICByZXQud2lkdGggPSB3OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoaCl7CiAgICAgICAgICAgICAgICAgICAgcmV0LmhlaWdodCA9IGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihwKXsKICAgICAgICAgICAgICAgICAgICByZXQucG9pbnRzID0gcDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBhcmdzID0gZmx5KGRvbSkuc3dpdGNoU3RhdGVtZW50cyhhbmNob3IudG9Mb3dlckNhc2UoKSwgYXJnQ2FsYywgewogICAgICAgICAgICAgICAgICAgIHQgIDogW3dyYXAsIHN0LCBiLndpZHRoLCAwLCBOVUxMLCBOVUxMLCBMRUZULCBCT1RUT00sIE5VTEwsIGJoLCBOVUxMXSwKICAgICAgICAgICAgICAgICAgICBsICA6IFt3cmFwLCBzdCwgMCwgYi5oZWlnaHQsIE5VTEwsIE5VTEwsIFJJR0hULCBUT1AsIGJ3LCBOVUxMLCBOVUxMXSwKICAgICAgICAgICAgICAgICAgICByICA6IFt3cmFwLCBzdCwgYi53aWR0aCwgYi5oZWlnaHQsIFNFVFgsIGIucmlnaHQsIExFRlQsIFRPUCwgTlVMTCwgTlVMTCwgcHRdLAogICAgICAgICAgICAgICAgICAgIGIgIDogW3dyYXAsIHN0LCBiLndpZHRoLCBiLmhlaWdodCwgU0VUWSwgYi5ib3R0b20sIExFRlQsIFRPUCwgTlVMTCwgYmgsIHB0XSwKICAgICAgICAgICAgICAgICAgICB0bCA6IFt3cmFwLCBzdCwgMCwgMCwgTlVMTCwgTlVMTCwgUklHSFQsIEJPVFRPTSwgYncsIGJoLCBwdF0sCiAgICAgICAgICAgICAgICAgICAgYmwgOiBbd3JhcCwgc3QsIDAsIDAsIFNFVFksIGIueSArIGIuaGVpZ2h0LCBSSUdIVCwgVE9QLCBidywgYmgsIHB0XSwKICAgICAgICAgICAgICAgICAgICBiciA6IFt3cmFwLCBzdCwgMCwgMCwgU0VUWFksIFtiLnJpZ2h0LCBiLmJvdHRvbV0sIExFRlQsIFRPUCwgYncsIGJoLCBwdF0sCiAgICAgICAgICAgICAgICAgICAgdHIgOiBbd3JhcCwgc3QsIDAsIDAsIFNFVFgsIGIueCArIGIud2lkdGgsIExFRlQsIEJPVFRPTSwgYncsIGJoLCBwdF0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgc3QudmlzaWJpbGl0eSA9IFZJU0lCTEU7CiAgICAgICAgICAgIGZseSh3cmFwKS5zaG93KCk7CgogICAgICAgICAgICBhcmd1bWVudHMuY2FsbGVlLmFuaW0gPSBmbHkod3JhcCkuZnhhbmltKGFyZ3MsCiAgICAgICAgICAgICAgICBvLAogICAgICAgICAgICAgICAgTU9USU9OLAogICAgICAgICAgICAgICAgLjUsCiAgICAgICAgICAgICAgICBFQVNFT1VULCAKICAgICAgICAgICAgICAgIGFmdGVyKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbWU7CiAgICB9LAogICAgCiAgICAKICAgIHNsaWRlT3V0IDogZnVuY3Rpb24oYW5jaG9yLCBvKXsKICAgICAgICBvID0gZ2V0T2JqZWN0KG8pOwogICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgIGRvbSA9IG1lLmRvbSwKICAgICAgICAgICAgc3QgPSBkb20uc3R5bGUsCiAgICAgICAgICAgIHh5ID0gbWUuZ2V0WFkoKSwKICAgICAgICAgICAgd3JhcCwKICAgICAgICAgICAgciwKICAgICAgICAgICAgYiwKICAgICAgICAgICAgYSwKICAgICAgICAgICAgemVybyA9IHt0bzogMH07IAogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGFuY2hvciA9IGFuY2hvciB8fCAidCI7CgogICAgICAgIG1lLnF1ZXVlRngobywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICByID0gZmx5KGRvbSkuZ2V0RnhSZXN0b3JlKCk7IAogICAgICAgICAgICBiID0ge3g6IHh5WzBdLCB5OiB4eVsxXSwgMDogeHlbMF0sIDE6IHh5WzFdLCB3aWR0aDogZG9tLm9mZnNldFdpZHRoLCBoZWlnaHQ6IGRvbS5vZmZzZXRIZWlnaHR9OwogICAgICAgICAgICBiLnJpZ2h0ID0gYi54ICsgYi53aWR0aDsKICAgICAgICAgICAgYi5ib3R0b20gPSBiLnkgKyBiLmhlaWdodDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgZmx5KGRvbSkuc2V0V2lkdGgoYi53aWR0aCkuc2V0SGVpZ2h0KGIuaGVpZ2h0KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICB3cmFwID0gZmx5KGRvbSkuZnhXcmFwKHIucG9zLCBvLCBWSVNJQkxFKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzdC52aXNpYmlsaXR5ID0gVklTSUJMRTsKICAgICAgICAgICAgc3QucG9zaXRpb24gPSBBQlNPTFVURTsKICAgICAgICAgICAgZmx5KHdyYXApLnNldFdpZHRoKGIud2lkdGgpLnNldEhlaWdodChiLmhlaWdodCk7ICAgICAgICAgICAgCgogICAgICAgICAgICBmdW5jdGlvbiBhZnRlcigpewogICAgICAgICAgICAgICAgby51c2VEaXNwbGF5ID8gZmx5KGRvbSkuc2V0RGlzcGxheWVkKEZBTFNFKSA6IGZseShkb20pLmhpZGUoKTsgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmbHkoZG9tKS5meFVud3JhcCh3cmFwLCByLnBvcywgbyk7CiAgICAgICAgICAgICAgICBzdC53aWR0aCA9IHIud2lkdGg7CiAgICAgICAgICAgICAgICBzdC5oZWlnaHQgPSByLmhlaWdodDsKICAgICAgICAgICAgICAgIGZseShkb20pLmFmdGVyRngobyk7CiAgICAgICAgICAgIH0gICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGZ1bmN0aW9uIGFyZ0NhbGMoc3R5bGUsIHMxLCBzMiwgcDEsIHYxLCBwMiwgdjIsIHAzLCB2Myl7ICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciByZXQgPSB7fTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc3R5bGVbczFdID0gc3R5bGVbczJdID0gIjAiOwogICAgICAgICAgICAgICAgcmV0W3AxXSA9IHYxOyAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYocDIpewogICAgICAgICAgICAgICAgICAgIHJldFtwMl0gPSB2MjsgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKHAzKXsKICAgICAgICAgICAgICAgICAgICByZXRbcDNdID0gdjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICBhID0gZmx5KGRvbSkuc3dpdGNoU3RhdGVtZW50cyhhbmNob3IudG9Mb3dlckNhc2UoKSwgYXJnQ2FsYywgewogICAgICAgICAgICAgICAgdCAgOiBbc3QsIExFRlQsIEJPVFRPTSwgSEVJR0hULCB6ZXJvXSwKICAgICAgICAgICAgICAgIGwgIDogW3N0LCBSSUdIVCwgVE9QLCBXSURUSCwgemVyb10sCiAgICAgICAgICAgICAgICByICA6IFtzdCwgTEVGVCwgVE9QLCBXSURUSCwgemVybywgUE9JTlRTLCB7dG8gOiBbYi5yaWdodCwgYi55XX1dLAogICAgICAgICAgICAgICAgYiAgOiBbc3QsIExFRlQsIFRPUCwgSEVJR0hULCB6ZXJvLCBQT0lOVFMsIHt0byA6IFtiLngsIGIuYm90dG9tXX1dLAogICAgICAgICAgICAgICAgdGwgOiBbc3QsIFJJR0hULCBCT1RUT00sIFdJRFRILCB6ZXJvLCBIRUlHSFQsIHplcm9dLAogICAgICAgICAgICAgICAgYmwgOiBbc3QsIFJJR0hULCBUT1AsIFdJRFRILCB6ZXJvLCBIRUlHSFQsIHplcm8sIFBPSU5UUywge3RvIDogW2IueCwgYi5ib3R0b21dfV0sCiAgICAgICAgICAgICAgICBiciA6IFtzdCwgTEVGVCwgVE9QLCBXSURUSCwgemVybywgSEVJR0hULCB6ZXJvLCBQT0lOVFMsIHt0byA6IFtiLnggKyBiLndpZHRoLCBiLmJvdHRvbV19XSwKICAgICAgICAgICAgICAgIHRyIDogW3N0LCBMRUZULCBCT1RUT00sIFdJRFRILCB6ZXJvLCBIRUlHSFQsIHplcm8sIFBPSU5UUywge3RvIDogW2IucmlnaHQsIGIueV19XQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGFyZ3VtZW50cy5jYWxsZWUuYW5pbSA9IGZseSh3cmFwKS5meGFuaW0oYSwKICAgICAgICAgICAgICAgIG8sCiAgICAgICAgICAgICAgICBNT1RJT04sCiAgICAgICAgICAgICAgICAuNSwKICAgICAgICAgICAgICAgIEVBU0VPVVQsIAogICAgICAgICAgICAgICAgYWZ0ZXIpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBtZTsKICAgIH0sCgogICAgCiAgICBwdWZmIDogZnVuY3Rpb24obyl7CiAgICAgICAgbyA9IGdldE9iamVjdChvKTsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBkb20gPSBtZS5kb20sCiAgICAgICAgICAgIHN0ID0gZG9tLnN0eWxlLAogICAgICAgICAgICB3aWR0aCwKICAgICAgICAgICAgaGVpZ2h0LAogICAgICAgICAgICByOwoKICAgICAgICBtZS5xdWV1ZUZ4KG8sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHdpZHRoID0gZmx5KGRvbSkuZ2V0V2lkdGgoKTsKICAgICAgICAgICAgaGVpZ2h0ID0gZmx5KGRvbSkuZ2V0SGVpZ2h0KCk7CiAgICAgICAgICAgIGZseShkb20pLmNsZWFyT3BhY2l0eSgpOwogICAgICAgICAgICBmbHkoZG9tKS5zaG93KCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgciA9IGZseShkb20pLmdldEZ4UmVzdG9yZSgpOyAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyKCl7CiAgICAgICAgICAgICAgICBvLnVzZURpc3BsYXkgPyBmbHkoZG9tKS5zZXREaXNwbGF5ZWQoRkFMU0UpIDogZmx5KGRvbSkuaGlkZSgpOyAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZmx5KGRvbSkuY2xlYXJPcGFjaXR5KCk7ICAKICAgICAgICAgICAgICAgIGZseShkb20pLnNldFBvc2l0aW9uaW5nKHIucG9zKTsKICAgICAgICAgICAgICAgIHN0LndpZHRoID0gci53aWR0aDsKICAgICAgICAgICAgICAgIHN0LmhlaWdodCA9IHIuaGVpZ2h0OwogICAgICAgICAgICAgICAgc3QuZm9udFNpemUgPSAnJzsKICAgICAgICAgICAgICAgIGZseShkb20pLmFmdGVyRngobyk7CiAgICAgICAgICAgIH0gICAKCiAgICAgICAgICAgIGFyZ3VtZW50cy5jYWxsZWUuYW5pbSA9IGZseShkb20pLmZ4YW5pbSh7CiAgICAgICAgICAgICAgICAgICAgd2lkdGggOiB7dG8gOiBmbHkoZG9tKS5hZGp1c3RXaWR0aCh3aWR0aCAqIDIpfSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQgOiB7dG8gOiBmbHkoZG9tKS5hZGp1c3RIZWlnaHQoaGVpZ2h0ICogMil9LAogICAgICAgICAgICAgICAgICAgIHBvaW50cyA6IHtieSA6IFstd2lkdGggKiAuNSwgLWhlaWdodCAqIC41XX0sCiAgICAgICAgICAgICAgICAgICAgb3BhY2l0eSA6IHt0byA6IDB9LAogICAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiB7dG8gOiAyMDAsIHVuaXQ6ICIlIn0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBvLAogICAgICAgICAgICAgICAgTU9USU9OLAogICAgICAgICAgICAgICAgLjUsCiAgICAgICAgICAgICAgICBFQVNFT1VULAogICAgICAgICAgICAgICAgIGFmdGVyKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgIAogICAgc3dpdGNoT2ZmIDogZnVuY3Rpb24obyl7CiAgICAgICAgbyA9IGdldE9iamVjdChvKTsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBkb20gPSBtZS5kb20sCiAgICAgICAgICAgIHN0ID0gZG9tLnN0eWxlLAogICAgICAgICAgICByOwoKICAgICAgICBtZS5xdWV1ZUZ4KG8sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGZseShkb20pLmNsZWFyT3BhY2l0eSgpOwogICAgICAgICAgICBmbHkoZG9tKS5jbGlwKCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgciA9IGZseShkb20pLmdldEZ4UmVzdG9yZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyKCl7CiAgICAgICAgICAgICAgICBvLnVzZURpc3BsYXkgPyBmbHkoZG9tKS5zZXREaXNwbGF5ZWQoRkFMU0UpIDogZmx5KGRvbSkuaGlkZSgpOyAgCiAgICAgICAgICAgICAgICBmbHkoZG9tKS5jbGVhck9wYWNpdHkoKTsKICAgICAgICAgICAgICAgIGZseShkb20pLnNldFBvc2l0aW9uaW5nKHIucG9zKTsKICAgICAgICAgICAgICAgIHN0LndpZHRoID0gci53aWR0aDsKICAgICAgICAgICAgICAgIHN0LmhlaWdodCA9IHIuaGVpZ2h0OyAgIAogICAgICAgICAgICAgICAgZmx5KGRvbSkuYWZ0ZXJGeChvKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZseShkb20pLmZ4YW5pbSh7b3BhY2l0eSA6IHt0byA6IDAuM319LCAKICAgICAgICAgICAgICAgIE5VTEwsIAogICAgICAgICAgICAgICAgTlVMTCwgCiAgICAgICAgICAgICAgICAuMSwgCiAgICAgICAgICAgICAgICBOVUxMLCAKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCl7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZmx5KGRvbSkuY2xlYXJPcGFjaXR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbigpeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZseShkb20pLmZ4YW5pbSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0IDoge3RvIDogMX0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRzIDoge2J5IDogWzAsIGZseShkb20pLmdldEhlaWdodCgpICogLjVdfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1PVElPTiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLjMsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2Vhc2VJbicsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9KS5kZWZlcigxMDApOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKCiAgICAgCiAgICBoaWdobGlnaHQgOiBmdW5jdGlvbihjb2xvciwgbyl7CiAgICAgICAgbyA9IGdldE9iamVjdChvKTsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBkb20gPSBtZS5kb20sCiAgICAgICAgICAgIGF0dHIgPSBvLmF0dHIgfHwgImJhY2tncm91bmRDb2xvciIsCiAgICAgICAgICAgIGEgPSB7fSwKICAgICAgICAgICAgcmVzdG9yZTsKCiAgICAgICAgbWUucXVldWVGeChvLCBmdW5jdGlvbigpewogICAgICAgICAgICBmbHkoZG9tKS5jbGVhck9wYWNpdHkoKTsKICAgICAgICAgICAgZmx5KGRvbSkuc2hvdygpOwoKICAgICAgICAgICAgZnVuY3Rpb24gYWZ0ZXIoKXsKICAgICAgICAgICAgICAgIGRvbS5zdHlsZVthdHRyXSA9IHJlc3RvcmU7CiAgICAgICAgICAgICAgICBmbHkoZG9tKS5hZnRlckZ4KG8pOwogICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3RvcmUgPSBkb20uc3R5bGVbYXR0cl07CiAgICAgICAgICAgIGFbYXR0cl0gPSB7ZnJvbTogY29sb3IgfHwgImZmZmY5YyIsIHRvOiBvLmVuZENvbG9yIHx8IGZseShkb20pLmdldENvbG9yKGF0dHIpIHx8ICJmZmZmZmYifTsKICAgICAgICAgICAgYXJndW1lbnRzLmNhbGxlZS5hbmltID0gZmx5KGRvbSkuZnhhbmltKGEsCiAgICAgICAgICAgICAgICBvLAogICAgICAgICAgICAgICAgJ2NvbG9yJywKICAgICAgICAgICAgICAgIDEsCiAgICAgICAgICAgICAgICAnZWFzZUluJywgCiAgICAgICAgICAgICAgICBhZnRlcik7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKCiAgIAogICAgZnJhbWUgOiBmdW5jdGlvbihjb2xvciwgY291bnQsIG8pewogICAgICAgIG8gPSBnZXRPYmplY3Qobyk7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgZG9tID0gbWUuZG9tLAogICAgICAgICAgICBwcm94eSwKICAgICAgICAgICAgYWN0aXZlOwoKICAgICAgICBtZS5xdWV1ZUZ4KG8sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGNvbG9yID0gY29sb3IgfHwgJyNDM0RBRjknOwogICAgICAgICAgICBpZihjb2xvci5sZW5ndGggPT0gNil7CiAgICAgICAgICAgICAgICBjb2xvciA9ICcjJyArIGNvbG9yOwogICAgICAgICAgICB9ICAgICAgICAgICAgCiAgICAgICAgICAgIGNvdW50ID0gY291bnQgfHwgMTsKICAgICAgICAgICAgZmx5KGRvbSkuc2hvdygpOwoKICAgICAgICAgICAgdmFyIHh5ID0gZmx5KGRvbSkuZ2V0WFkoKSwKICAgICAgICAgICAgICAgIGIgPSB7eDogeHlbMF0sIHk6IHh5WzFdLCAwOiB4eVswXSwgMTogeHlbMV0sIHdpZHRoOiBkb20ub2Zmc2V0V2lkdGgsIGhlaWdodDogZG9tLm9mZnNldEhlaWdodH0sCiAgICAgICAgICAgICAgICBxdWV1ZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgcHJveHkgPSBmbHkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpLmNyZWF0ZUNoaWxkKHsKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gOiBBQlNPTFVURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd6LWluZGV4JzogMzUwMDAsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyIDogJzBweCBzb2xpZCAnICsgY29sb3IKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBwcm94eS5xdWV1ZUZ4KHt9LCBhbmltRm4pOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBhcmd1bWVudHMuY2FsbGVlLmFuaW0gPSB7CiAgICAgICAgICAgICAgICBpc0FuaW1hdGVkOiB0cnVlLAogICAgICAgICAgICAgICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIHByb3h5LnN0b3BGeCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgZnVuY3Rpb24gYW5pbUZuKCl7CiAgICAgICAgICAgICAgICB2YXIgc2NhbGUgPSBFeHQuaXNCb3JkZXJCb3ggPyAyIDogMTsKICAgICAgICAgICAgICAgIGFjdGl2ZSA9IHByb3h5LmFuaW0oewogICAgICAgICAgICAgICAgICAgIHRvcCA6IHtmcm9tIDogYi55LCB0byA6IGIueSAtIDIwfSwKICAgICAgICAgICAgICAgICAgICBsZWZ0IDoge2Zyb20gOiBiLngsIHRvIDogYi54IC0gMjB9LAogICAgICAgICAgICAgICAgICAgIGJvcmRlcldpZHRoIDoge2Zyb20gOiAwLCB0byA6IDEwfSwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5IDoge2Zyb20gOiAxLCB0byA6IDB9LAogICAgICAgICAgICAgICAgICAgIGhlaWdodCA6IHtmcm9tIDogYi5oZWlnaHQsIHRvIDogYi5oZWlnaHQgKyAyMCAqIHNjYWxlfSwKICAgICAgICAgICAgICAgICAgICB3aWR0aCA6IHtmcm9tIDogYi53aWR0aCwgdG8gOiBiLndpZHRoICsgMjAgKiBzY2FsZX0KICAgICAgICAgICAgICAgIH0sewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBvLmR1cmF0aW9uIHx8IDEsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBwcm94eS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgLS1jb3VudCA+IDAgPyBxdWV1ZSgpIDogZmx5KGRvbSkuYWZ0ZXJGeChvKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGFyZ3VtZW50cy5jYWxsZWUuYW5pbSA9IHsKICAgICAgICAgICAgICAgICAgICBpc0FuaW1hdGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHN0b3A6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZS5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcXVldWUoKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgCiAgICBwYXVzZSA6IGZ1bmN0aW9uKHNlY29uZHMpeyAgICAgICAgCiAgICAgICAgdmFyIGRvbSA9IHRoaXMuZG9tLAogICAgICAgICAgICB0OwoKICAgICAgICB0aGlzLnF1ZXVlRngoe30sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBmbHkoZG9tKS5hZnRlckZ4KHt9KTsKICAgICAgICAgICAgfSwgc2Vjb25kcyAqIDEwMDApOwogICAgICAgICAgICBhcmd1bWVudHMuY2FsbGVlLmFuaW0gPSB7CiAgICAgICAgICAgICAgICBpc0FuaW1hdGVkOiB0cnVlLAogICAgICAgICAgICAgICAgc3RvcDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodCk7CiAgICAgICAgICAgICAgICAgICAgZmx5KGRvbSkuYWZ0ZXJGeCh7fSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgCiAgICBmYWRlSW4gOiBmdW5jdGlvbihvKXsKICAgICAgICBvID0gZ2V0T2JqZWN0KG8pOwogICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgIGRvbSA9IG1lLmRvbSwKICAgICAgICAgICAgdG8gPSBvLmVuZE9wYWNpdHkgfHwgMTsKICAgICAgICAKICAgICAgICBtZS5xdWV1ZUZ4KG8sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGZseShkb20pLnNldE9wYWNpdHkoMCk7CiAgICAgICAgICAgIGZseShkb20pLmZpeERpc3BsYXkoKTsKICAgICAgICAgICAgZG9tLnN0eWxlLnZpc2liaWxpdHkgPSBWSVNJQkxFOwogICAgICAgICAgICBhcmd1bWVudHMuY2FsbGVlLmFuaW0gPSBmbHkoZG9tKS5meGFuaW0oe29wYWNpdHk6e3RvOnRvfX0sCiAgICAgICAgICAgICAgICBvLCBOVUxMLCAuNSwgRUFTRU9VVCwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIGlmKHRvID09IDEpewogICAgICAgICAgICAgICAgICAgIGZseShkb20pLmNsZWFyT3BhY2l0eSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZmx5KGRvbSkuYWZ0ZXJGeChvKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKCiAgIAogICAgZmFkZU91dCA6IGZ1bmN0aW9uKG8pewogICAgICAgIG8gPSBnZXRPYmplY3Qobyk7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgZG9tID0gbWUuZG9tLAogICAgICAgICAgICBzdHlsZSA9IGRvbS5zdHlsZSwKICAgICAgICAgICAgdG8gPSBvLmVuZE9wYWNpdHkgfHwgMDsgICAgICAgICAKICAgICAgICAKICAgICAgICBtZS5xdWV1ZUZ4KG8sIGZ1bmN0aW9uKCl7ICAKICAgICAgICAgICAgYXJndW1lbnRzLmNhbGxlZS5hbmltID0gZmx5KGRvbSkuZnhhbmltKHsgCiAgICAgICAgICAgICAgICBvcGFjaXR5IDoge3RvIDogdG99fSwKICAgICAgICAgICAgICAgIG8sIAogICAgICAgICAgICAgICAgTlVMTCwgCiAgICAgICAgICAgICAgICAuNSwgCiAgICAgICAgICAgICAgICBFQVNFT1VULCAKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYodG8gPT0gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgIEV4dC5FbGVtZW50LmRhdGEoZG9tLCAndmlzaWJpbGl0eU1vZGUnKSA9PSBFeHQuRWxlbWVudC5ESVNQTEFZIHx8IG8udXNlRGlzcGxheSA/IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGUuZGlzcGxheSA9ICJub25lIiA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZS52aXNpYmlsaXR5ID0gSElEREVOOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGZseShkb20pLmNsZWFyT3BhY2l0eSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmbHkoZG9tKS5hZnRlckZ4KG8pOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgCiAgICBzY2FsZSA6IGZ1bmN0aW9uKHcsIGgsIG8pewogICAgICAgIHRoaXMuc2hpZnQoRXh0LmFwcGx5KHt9LCBvLCB7CiAgICAgICAgICAgIHdpZHRoOiB3LAogICAgICAgICAgICBoZWlnaHQ6IGgKICAgICAgICB9KSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgCiAgICBzaGlmdCA6IGZ1bmN0aW9uKG8pewogICAgICAgIG8gPSBnZXRPYmplY3Qobyk7CiAgICAgICAgdmFyIGRvbSA9IHRoaXMuZG9tLAogICAgICAgICAgICBhID0ge307CiAgICAgICAgICAgICAgICAKICAgICAgICB0aGlzLnF1ZXVlRngobywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvKSB7CiAgICAgICAgICAgICAgICBpZiAob1twcm9wXSAhPSBVTkRFRklORUQpIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgYVtwcm9wXSA9IHt0byA6IG9bcHJvcF19OyAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSAKICAgICAgICAgICAgCiAgICAgICAgICAgIGEud2lkdGggPyBhLndpZHRoLnRvID0gZmx5KGRvbSkuYWRqdXN0V2lkdGgoby53aWR0aCkgOiBhOwogICAgICAgICAgICBhLmhlaWdodCA/IGEuaGVpZ2h0LnRvID0gZmx5KGRvbSkuYWRqdXN0V2lkdGgoby5oZWlnaHQpIDogYTsgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChhLnggfHwgYS55IHx8IGEueHkpIHsKICAgICAgICAgICAgICAgIGEucG9pbnRzID0gYS54eSB8fCAKICAgICAgICAgICAgICAgICAgICAgICAgICAge3RvIDogWyBhLnggPyBhLngudG8gOiBmbHkoZG9tKS5nZXRYKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS55ID8gYS55LnRvIDogZmx5KGRvbSkuZ2V0WSgpXX07ICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFyZ3VtZW50cy5jYWxsZWUuYW5pbSA9IGZseShkb20pLmZ4YW5pbShhLAogICAgICAgICAgICAgICAgbywgCiAgICAgICAgICAgICAgICBNT1RJT04sIAogICAgICAgICAgICAgICAgLjM1LCAKICAgICAgICAgICAgICAgIEVBU0VPVVQsIAogICAgICAgICAgICAgICAgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBmbHkoZG9tKS5hZnRlckZ4KG8pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZ2hvc3QgOiBmdW5jdGlvbihhbmNob3IsIG8pewogICAgICAgIG8gPSBnZXRPYmplY3Qobyk7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgZG9tID0gbWUuZG9tLAogICAgICAgICAgICBzdCA9IGRvbS5zdHlsZSwKICAgICAgICAgICAgYSA9IHtvcGFjaXR5OiB7dG86IDB9LCBwb2ludHM6IHt9fSwKICAgICAgICAgICAgcHQgPSBhLnBvaW50cywKICAgICAgICAgICAgciwKICAgICAgICAgICAgdywKICAgICAgICAgICAgaDsKICAgICAgICAgICAgCiAgICAgICAgYW5jaG9yID0gYW5jaG9yIHx8ICJiIjsKCiAgICAgICAgbWUucXVldWVGeChvLCBmdW5jdGlvbigpewogICAgICAgICAgICAKICAgICAgICAgICAgciA9IGZseShkb20pLmdldEZ4UmVzdG9yZSgpOwogICAgICAgICAgICB3ID0gZmx5KGRvbSkuZ2V0V2lkdGgoKTsKICAgICAgICAgICAgaCA9IGZseShkb20pLmdldEhlaWdodCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgZnVuY3Rpb24gYWZ0ZXIoKXsKICAgICAgICAgICAgICAgIG8udXNlRGlzcGxheSA/IGZseShkb20pLnNldERpc3BsYXllZChGQUxTRSkgOiBmbHkoZG9tKS5oaWRlKCk7ICAgCiAgICAgICAgICAgICAgICBmbHkoZG9tKS5jbGVhck9wYWNpdHkoKTsKICAgICAgICAgICAgICAgIGZseShkb20pLnNldFBvc2l0aW9uaW5nKHIucG9zKTsKICAgICAgICAgICAgICAgIHN0LndpZHRoID0gci53aWR0aDsKICAgICAgICAgICAgICAgIHN0LmhlaWdodCA9IHIuaGVpZ2h0OwogICAgICAgICAgICAgICAgZmx5KGRvbSkuYWZ0ZXJGeChvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHB0LmJ5ID0gZmx5KGRvbSkuc3dpdGNoU3RhdGVtZW50cyhhbmNob3IudG9Mb3dlckNhc2UoKSwgZnVuY3Rpb24odjEsdjIpeyByZXR1cm4gW3YxLCB2Ml07fSwgewogICAgICAgICAgICAgICB0ICA6IFswLCAtaF0sCiAgICAgICAgICAgICAgIGwgIDogWy13LCAwXSwKICAgICAgICAgICAgICAgciAgOiBbdywgMF0sCiAgICAgICAgICAgICAgIGIgIDogWzAsIGhdLAogICAgICAgICAgICAgICB0bCA6IFstdywgLWhdLAogICAgICAgICAgICAgICBibCA6IFstdywgaF0sCiAgICAgICAgICAgICAgIGJyIDogW3csIGhdLAogICAgICAgICAgICAgICB0ciA6IFt3LCAtaF0gCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGFyZ3VtZW50cy5jYWxsZWUuYW5pbSA9IGZseShkb20pLmZ4YW5pbShhLAogICAgICAgICAgICAgICAgbywKICAgICAgICAgICAgICAgIE1PVElPTiwKICAgICAgICAgICAgICAgIC41LAogICAgICAgICAgICAgICAgRUFTRU9VVCwgYWZ0ZXIpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBtZTsKICAgIH0sCgogICAgCiAgICBzeW5jRnggOiBmdW5jdGlvbigpewogICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgbWUuZnhEZWZhdWx0cyA9IEV4dC5hcHBseShtZS5meERlZmF1bHRzIHx8IHt9LCB7CiAgICAgICAgICAgIGJsb2NrIDogRkFMU0UsCiAgICAgICAgICAgIGNvbmN1cnJlbnQgOiBUUlVFLAogICAgICAgICAgICBzdG9wRnggOiBGQUxTRQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBtZTsKICAgIH0sCgogICAgCiAgICBzZXF1ZW5jZUZ4IDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgIG1lLmZ4RGVmYXVsdHMgPSBFeHQuYXBwbHkobWUuZnhEZWZhdWx0cyB8fCB7fSwgewogICAgICAgICAgICBibG9jayA6IEZBTFNFLAogICAgICAgICAgICBjb25jdXJyZW50IDogRkFMU0UsCiAgICAgICAgICAgIHN0b3BGeCA6IEZBTFNFCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKCiAgICAKICAgIG5leHRGeCA6IGZ1bmN0aW9uKCl7ICAgICAgICAKICAgICAgICB2YXIgZWYgPSBnZXRRdWV1ZSh0aGlzLmRvbS5pZClbMF07CiAgICAgICAgaWYoZWYpewogICAgICAgICAgICBlZi5jYWxsKHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBoYXNBY3RpdmVGeCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIGdldFF1ZXVlKHRoaXMuZG9tLmlkKVswXTsKICAgIH0sCgogICAgCiAgICBzdG9wRnggOiBmdW5jdGlvbihmaW5pc2gpewogICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgIGlkID0gbWUuZG9tLmlkOwogICAgICAgIGlmKG1lLmhhc0FjdGl2ZUZ4KCkpewogICAgICAgICAgICB2YXIgY3VyID0gZ2V0UXVldWUoaWQpWzBdOwogICAgICAgICAgICBpZihjdXIgJiYgY3VyLmFuaW0pewogICAgICAgICAgICAgICAgaWYoY3VyLmFuaW0uaXNBbmltYXRlZCl7CiAgICAgICAgICAgICAgICAgICAgc2V0UXVldWUoaWQsIFtjdXJdKTsgCiAgICAgICAgICAgICAgICAgICAgY3VyLmFuaW0uc3RvcChmaW5pc2ggIT09IHVuZGVmaW5lZCA/IGZpbmlzaCA6IFRSVUUpOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgc2V0UXVldWUoaWQsIFtdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgIAogICAgYmVmb3JlRnggOiBmdW5jdGlvbihvKXsKICAgICAgICBpZih0aGlzLmhhc0FjdGl2ZUZ4KCkgJiYgIW8uY29uY3VycmVudCl7CiAgICAgICAgICAgaWYoby5zdG9wRngpewogICAgICAgICAgICAgICB0aGlzLnN0b3BGeCgpOwogICAgICAgICAgICAgICByZXR1cm4gVFJVRTsKICAgICAgICAgICB9CiAgICAgICAgICAgcmV0dXJuIEZBTFNFOwogICAgICAgIH0KICAgICAgICByZXR1cm4gVFJVRTsKICAgIH0sCgogICAgCiAgICBoYXNGeEJsb2NrIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgcSA9IGdldFF1ZXVlKHRoaXMuZG9tLmlkKTsKICAgICAgICByZXR1cm4gcSAmJiBxWzBdICYmIHFbMF0uYmxvY2s7CiAgICB9LAoKICAgIAogICAgcXVldWVGeCA6IGZ1bmN0aW9uKG8sIGZuKXsKICAgICAgICB2YXIgbWUgPSBmbHkodGhpcy5kb20pOwogICAgICAgIGlmKCFtZS5oYXNGeEJsb2NrKCkpewogICAgICAgICAgICBFeHQuYXBwbHlJZihvLCBtZS5meERlZmF1bHRzKTsKICAgICAgICAgICAgaWYoIW8uY29uY3VycmVudCl7CiAgICAgICAgICAgICAgICB2YXIgcnVuID0gbWUuYmVmb3JlRngobyk7CiAgICAgICAgICAgICAgICBmbi5ibG9jayA9IG8uYmxvY2s7CiAgICAgICAgICAgICAgICBnZXRRdWV1ZShtZS5kb20uaWQpLnB1c2goZm4pOwogICAgICAgICAgICAgICAgaWYocnVuKXsKICAgICAgICAgICAgICAgICAgICBtZS5uZXh0RngoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBmbi5jYWxsKG1lKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgIAogICAgZnhXcmFwIDogZnVuY3Rpb24ocG9zLCBvLCB2aXMpeyAKICAgICAgICB2YXIgZG9tID0gdGhpcy5kb20sCiAgICAgICAgICAgIHdyYXAsCiAgICAgICAgICAgIHdyYXBYWTsKICAgICAgICBpZighby53cmFwIHx8ICEod3JhcCA9IEV4dC5nZXREb20oby53cmFwKSkpeyAgICAgICAgICAgIAogICAgICAgICAgICBpZihvLmZpeFBvc2l0aW9uKXsKICAgICAgICAgICAgICAgIHdyYXBYWSA9IGZseShkb20pLmdldFhZKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICBkaXYuc3R5bGUudmlzaWJpbGl0eSA9IHZpczsKICAgICAgICAgICAgd3JhcCA9IGRvbS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShkaXYsIGRvbSk7CiAgICAgICAgICAgIGZseSh3cmFwKS5zZXRQb3NpdGlvbmluZyhwb3MpOwogICAgICAgICAgICBpZihmbHkod3JhcCkuaXNTdHlsZShQT1NJVElPTiwgInN0YXRpYyIpKXsKICAgICAgICAgICAgICAgIGZseSh3cmFwKS5wb3NpdGlvbigicmVsYXRpdmUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbHkoZG9tKS5jbGVhclBvc2l0aW9uaW5nKCdhdXRvJyk7CiAgICAgICAgICAgIGZseSh3cmFwKS5jbGlwKCk7CiAgICAgICAgICAgIHdyYXAuYXBwZW5kQ2hpbGQoZG9tKTsKICAgICAgICAgICAgaWYod3JhcFhZKXsKICAgICAgICAgICAgICAgIGZseSh3cmFwKS5zZXRYWSh3cmFwWFkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB3cmFwOwogICAgfSwKCiAgICAKICAgIGZ4VW53cmFwIDogZnVuY3Rpb24od3JhcCwgcG9zLCBvKXsgICAgICAKICAgICAgICB2YXIgZG9tID0gdGhpcy5kb207CiAgICAgICAgZmx5KGRvbSkuY2xlYXJQb3NpdGlvbmluZygpOwogICAgICAgIGZseShkb20pLnNldFBvc2l0aW9uaW5nKHBvcyk7CiAgICAgICAgaWYoIW8ud3JhcCl7CiAgICAgICAgICAgIHZhciBwbiA9IGZseSh3cmFwKS5kb20ucGFyZW50Tm9kZTsKICAgICAgICAgICAgcG4uaW5zZXJ0QmVmb3JlKGRvbSwgd3JhcCk7IAogICAgICAgICAgICBmbHkod3JhcCkucmVtb3ZlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldEZ4UmVzdG9yZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHN0ID0gdGhpcy5kb20uc3R5bGU7CiAgICAgICAgcmV0dXJuIHtwb3M6IHRoaXMuZ2V0UG9zaXRpb25pbmcoKSwgd2lkdGg6IHN0LndpZHRoLCBoZWlnaHQgOiBzdC5oZWlnaHR9OwogICAgfSwKCiAgICAKICAgIGFmdGVyRnggOiBmdW5jdGlvbihvKXsKICAgICAgICB2YXIgZG9tID0gdGhpcy5kb20sCiAgICAgICAgICAgIGlkID0gZG9tLmlkOwogICAgICAgIGlmKG8uYWZ0ZXJTdHlsZSl7CiAgICAgICAgICAgIGZseShkb20pLnNldFN0eWxlKG8uYWZ0ZXJTdHlsZSk7ICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIGlmKG8uYWZ0ZXJDbHMpewogICAgICAgICAgICBmbHkoZG9tKS5hZGRDbGFzcyhvLmFmdGVyQ2xzKTsKICAgICAgICB9CiAgICAgICAgaWYoby5yZW1vdmUgPT0gVFJVRSl7CiAgICAgICAgICAgIGZseShkb20pLnJlbW92ZSgpOwogICAgICAgIH0KICAgICAgICBpZihvLmNhbGxiYWNrKXsKICAgICAgICAgICAgby5jYWxsYmFjay5jYWxsKG8uc2NvcGUsIGZseShkb20pKTsKICAgICAgICB9CiAgICAgICAgaWYoIW8uY29uY3VycmVudCl7CiAgICAgICAgICAgIGdldFF1ZXVlKGlkKS5zaGlmdCgpOwogICAgICAgICAgICBmbHkoZG9tKS5uZXh0RngoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZnhhbmltIDogZnVuY3Rpb24oYXJncywgb3B0LCBhbmltVHlwZSwgZGVmYXVsdER1ciwgZGVmYXVsdEVhc2UsIGNiKXsKICAgICAgICBhbmltVHlwZSA9IGFuaW1UeXBlIHx8ICdydW4nOwogICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKICAgICAgICB2YXIgYW5pbSA9IEV4dC5saWIuQW5pbVthbmltVHlwZV0oCiAgICAgICAgICAgICAgICB0aGlzLmRvbSwgCiAgICAgICAgICAgICAgICBhcmdzLAogICAgICAgICAgICAgICAgKG9wdC5kdXJhdGlvbiB8fCBkZWZhdWx0RHVyKSB8fCAuMzUsCiAgICAgICAgICAgICAgICAob3B0LmVhc2luZyB8fCBkZWZhdWx0RWFzZSkgfHwgRUFTRU9VVCwKICAgICAgICAgICAgICAgIGNiLCAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcwogICAgICAgICAgICApOwogICAgICAgIG9wdC5hbmltID0gYW5pbTsKICAgICAgICByZXR1cm4gYW5pbTsKICAgIH0KfTsKCgpFeHQuRngucmVzaXplID0gRXh0LkZ4LnNjYWxlOwoKCgpFeHQuRWxlbWVudC5hZGRNZXRob2RzKEV4dC5GeCk7Cn0pKCk7CgpFeHQuQ29tcG9zaXRlRWxlbWVudExpdGUgPSBmdW5jdGlvbihlbHMsIHJvb3QpewogICAgCiAgICB0aGlzLmVsZW1lbnRzID0gW107CiAgICB0aGlzLmFkZChlbHMsIHJvb3QpOwogICAgdGhpcy5lbCA9IG5ldyBFeHQuRWxlbWVudC5GbHl3ZWlnaHQoKTsKfTsKCkV4dC5Db21wb3NpdGVFbGVtZW50TGl0ZS5wcm90b3R5cGUgPSB7CiAgICBpc0NvbXBvc2l0ZTogdHJ1ZSwKCiAgICAKICAgIGdldEVsZW1lbnQgOiBmdW5jdGlvbihlbCl7CiAgICAgICAgCiAgICAgICAgdmFyIGUgPSB0aGlzLmVsOwogICAgICAgIGUuZG9tID0gZWw7CiAgICAgICAgZS5pZCA9IGVsLmlkOwogICAgICAgIHJldHVybiBlOwogICAgfSwKCiAgICAKICAgIHRyYW5zZm9ybUVsZW1lbnQgOiBmdW5jdGlvbihlbCl7CiAgICAgICAgcmV0dXJuIEV4dC5nZXREb20oZWwpOwogICAgfSwKCiAgICAKICAgIGdldENvdW50IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50cy5sZW5ndGg7CiAgICB9LAogICAgCiAgICBhZGQgOiBmdW5jdGlvbihlbHMsIHJvb3QpewogICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgIGVsZW1lbnRzID0gbWUuZWxlbWVudHM7CiAgICAgICAgaWYoIWVscyl7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBpZih0eXBlb2YgZWxzID09ICJzdHJpbmciKXsKICAgICAgICAgICAgZWxzID0gRXh0LkVsZW1lbnQuc2VsZWN0b3JGdW5jdGlvbihlbHMsIHJvb3QpOwogICAgICAgIH1lbHNlIGlmKGVscy5pc0NvbXBvc2l0ZSl7CiAgICAgICAgICAgIGVscyA9IGVscy5lbGVtZW50czsKICAgICAgICB9ZWxzZSBpZighRXh0LmlzSXRlcmFibGUoZWxzKSl7CiAgICAgICAgICAgIGVscyA9IFtlbHNdOwogICAgICAgIH0KCiAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gZWxzLmxlbmd0aDsgaSA8IGxlbjsgKytpKXsKICAgICAgICAgICAgZWxlbWVudHMucHVzaChtZS50cmFuc2Zvcm1FbGVtZW50KGVsc1tpXSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgIGludm9rZSA6IGZ1bmN0aW9uKGZuLCBhcmdzKXsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBlbHMgPSBtZS5lbGVtZW50cywKICAgICAgICAgICAgbGVuID0gZWxzLmxlbmd0aCwKICAgICAgICAgICAgZSwKICAgICAgICAgICAgaTsKCiAgICAgICAgZm9yKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgZSA9IGVsc1tpXTsKICAgICAgICAgICAgaWYoZSl7CiAgICAgICAgICAgICAgICBFeHQuRWxlbWVudC5wcm90b3R5cGVbZm5dLmFwcGx5KG1lLmdldEVsZW1lbnQoZSksIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZTsKICAgIH0sCiAgICAKICAgIGl0ZW0gOiBmdW5jdGlvbihpbmRleCl7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgZWwgPSBtZS5lbGVtZW50c1tpbmRleF0sCiAgICAgICAgICAgIG91dCA9IG51bGw7CgogICAgICAgIGlmKGVsKXsKICAgICAgICAgICAgb3V0ID0gbWUuZ2V0RWxlbWVudChlbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXQ7CiAgICB9LAoKICAgIAogICAgYWRkTGlzdGVuZXIgOiBmdW5jdGlvbihldmVudE5hbWUsIGhhbmRsZXIsIHNjb3BlLCBvcHQpewogICAgICAgIHZhciBlbHMgPSB0aGlzLmVsZW1lbnRzLAogICAgICAgICAgICBsZW4gPSBlbHMubGVuZ3RoLAogICAgICAgICAgICBpLCBlOwoKICAgICAgICBmb3IoaSA9IDA7IGk8bGVuOyBpKyspIHsKICAgICAgICAgICAgZSA9IGVsc1tpXTsKICAgICAgICAgICAgaWYoZSkgewogICAgICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5vbihlLCBldmVudE5hbWUsIGhhbmRsZXIsIHNjb3BlIHx8IGUsIG9wdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgCiAgICBlYWNoIDogZnVuY3Rpb24oZm4sIHNjb3BlKXsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBlbHMgPSBtZS5lbGVtZW50cywKICAgICAgICAgICAgbGVuID0gZWxzLmxlbmd0aCwKICAgICAgICAgICAgaSwgZTsKCiAgICAgICAgZm9yKGkgPSAwOyBpPGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGUgPSBlbHNbaV07CiAgICAgICAgICAgIGlmKGUpewogICAgICAgICAgICAgICAgZSA9IHRoaXMuZ2V0RWxlbWVudChlKTsKICAgICAgICAgICAgICAgIGlmKGZuLmNhbGwoc2NvcGUgfHwgZSwgZSwgbWUsIGkpID09PSBmYWxzZSl7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKCiAgICAKICAgIGZpbGwgOiBmdW5jdGlvbihlbHMpewogICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgbWUuZWxlbWVudHMgPSBbXTsKICAgICAgICBtZS5hZGQoZWxzKTsKICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgIAogICAgZmlsdGVyIDogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICAgIHZhciBlbHMgPSBbXSwKICAgICAgICAgICAgbWUgPSB0aGlzLAogICAgICAgICAgICBmbiA9IEV4dC5pc0Z1bmN0aW9uKHNlbGVjdG9yKSA/IHNlbGVjdG9yCiAgICAgICAgICAgICAgICA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWwuaXMoc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgbWUuZWFjaChmdW5jdGlvbihlbCwgc2VsZiwgaSkgewogICAgICAgICAgICBpZiAoZm4oZWwsIGkpICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgZWxzW2Vscy5sZW5ndGhdID0gbWUudHJhbnNmb3JtRWxlbWVudChlbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBtZS5lbGVtZW50cyA9IGVsczsKICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgIAogICAgaW5kZXhPZiA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50cy5pbmRleE9mKHRoaXMudHJhbnNmb3JtRWxlbWVudChlbCkpOwogICAgfSwKCiAgICAKICAgIHJlcGxhY2VFbGVtZW50IDogZnVuY3Rpb24oZWwsIHJlcGxhY2VtZW50LCBkb21SZXBsYWNlKXsKICAgICAgICB2YXIgaW5kZXggPSAhaXNOYU4oZWwpID8gZWwgOiB0aGlzLmluZGV4T2YoZWwpLAogICAgICAgICAgICBkOwogICAgICAgIGlmKGluZGV4ID4gLTEpewogICAgICAgICAgICByZXBsYWNlbWVudCA9IEV4dC5nZXREb20ocmVwbGFjZW1lbnQpOwogICAgICAgICAgICBpZihkb21SZXBsYWNlKXsKICAgICAgICAgICAgICAgIGQgPSB0aGlzLmVsZW1lbnRzW2luZGV4XTsKICAgICAgICAgICAgICAgIGQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocmVwbGFjZW1lbnQsIGQpOwogICAgICAgICAgICAgICAgRXh0LnJlbW92ZU5vZGUoZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5lbGVtZW50cy5zcGxpY2UoaW5kZXgsIDEsIHJlcGxhY2VtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgY2xlYXIgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZWxlbWVudHMgPSBbXTsKICAgIH0KfTsKCkV4dC5Db21wb3NpdGVFbGVtZW50TGl0ZS5wcm90b3R5cGUub24gPSBFeHQuQ29tcG9zaXRlRWxlbWVudExpdGUucHJvdG90eXBlLmFkZExpc3RlbmVyOwoKCkV4dC5Db21wb3NpdGVFbGVtZW50TGl0ZS5pbXBvcnRFbGVtZW50TWV0aG9kcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGZuTmFtZSwKICAgICAgICBFbFByb3RvID0gRXh0LkVsZW1lbnQucHJvdG90eXBlLAogICAgICAgIENlbFByb3RvID0gRXh0LkNvbXBvc2l0ZUVsZW1lbnRMaXRlLnByb3RvdHlwZTsKCiAgICBmb3IgKGZuTmFtZSBpbiBFbFByb3RvKSB7CiAgICAgICAgaWYgKHR5cGVvZiBFbFByb3RvW2ZuTmFtZV0gPT0gJ2Z1bmN0aW9uJyl7CiAgICAgICAgICAgIChmdW5jdGlvbihmbk5hbWUpIHsKICAgICAgICAgICAgICAgIENlbFByb3RvW2ZuTmFtZV0gPSBDZWxQcm90b1tmbk5hbWVdIHx8IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmludm9rZShmbk5hbWUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KS5jYWxsKENlbFByb3RvLCBmbk5hbWUpOwoKICAgICAgICB9CiAgICB9Cn07CgpFeHQuQ29tcG9zaXRlRWxlbWVudExpdGUuaW1wb3J0RWxlbWVudE1ldGhvZHMoKTsKCmlmKEV4dC5Eb21RdWVyeSl7CiAgICBFeHQuRWxlbWVudC5zZWxlY3RvckZ1bmN0aW9uID0gRXh0LkRvbVF1ZXJ5LnNlbGVjdDsKfQoKCkV4dC5FbGVtZW50LnNlbGVjdCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCByb290KXsKICAgIHZhciBlbHM7CiAgICBpZih0eXBlb2Ygc2VsZWN0b3IgPT0gInN0cmluZyIpewogICAgICAgIGVscyA9IEV4dC5FbGVtZW50LnNlbGVjdG9yRnVuY3Rpb24oc2VsZWN0b3IsIHJvb3QpOwogICAgfWVsc2UgaWYoc2VsZWN0b3IubGVuZ3RoICE9PSB1bmRlZmluZWQpewogICAgICAgIGVscyA9IHNlbGVjdG9yOwogICAgfWVsc2V7CiAgICAgICAgdGhyb3cgIkludmFsaWQgc2VsZWN0b3IiOwogICAgfQogICAgcmV0dXJuIG5ldyBFeHQuQ29tcG9zaXRlRWxlbWVudExpdGUoZWxzKTsKfTsKCkV4dC5zZWxlY3QgPSBFeHQuRWxlbWVudC5zZWxlY3Q7CihmdW5jdGlvbigpewogICAgdmFyIEJFRk9SRVJFUVVFU1QgPSAiYmVmb3JlcmVxdWVzdCIsCiAgICAgICAgUkVRVUVTVENPTVBMRVRFID0gInJlcXVlc3Rjb21wbGV0ZSIsCiAgICAgICAgUkVRVUVTVEVYQ0VQVElPTiA9ICJyZXF1ZXN0ZXhjZXB0aW9uIiwKICAgICAgICBVTkRFRklORUQgPSB1bmRlZmluZWQsCiAgICAgICAgTE9BRCA9ICdsb2FkJywKICAgICAgICBQT1NUID0gJ1BPU1QnLAogICAgICAgIEdFVCA9ICdHRVQnLAogICAgICAgIFdJTkRPVyA9IHdpbmRvdzsKCiAgICAKICAgIEV4dC5kYXRhLkNvbm5lY3Rpb24gPSBmdW5jdGlvbihjb25maWcpewogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgQkVGT1JFUkVRVUVTVCwKICAgICAgICAgICAgCiAgICAgICAgICAgIFJFUVVFU1RDT01QTEVURSwKICAgICAgICAgICAgCiAgICAgICAgICAgIFJFUVVFU1RFWENFUFRJT04KICAgICAgICApOwogICAgICAgIEV4dC5kYXRhLkNvbm5lY3Rpb24uc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMpOwogICAgfTsKCiAgICBFeHQuZXh0ZW5kKEV4dC5kYXRhLkNvbm5lY3Rpb24sIEV4dC51dGlsLk9ic2VydmFibGUsIHsKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICB0aW1lb3V0IDogMzAwMDAsCiAgICAgICAgCiAgICAgICAgYXV0b0Fib3J0OmZhbHNlLAoKICAgICAgICAKICAgICAgICBkaXNhYmxlQ2FjaGluZzogdHJ1ZSwKCiAgICAgICAgCiAgICAgICAgZGlzYWJsZUNhY2hpbmdQYXJhbTogJ19kYycsCgogICAgICAgIAogICAgICAgIHJlcXVlc3QgOiBmdW5jdGlvbihvKXsKICAgICAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICAgICAgaWYobWUuZmlyZUV2ZW50KEJFRk9SRVJFUVVFU1QsIG1lLCBvKSl7CiAgICAgICAgICAgICAgICBpZiAoby5lbCkgewogICAgICAgICAgICAgICAgICAgIGlmKCFFeHQuaXNFbXB0eShvLmluZGljYXRvclRleHQpKXsKICAgICAgICAgICAgICAgICAgICAgICAgbWUuaW5kaWNhdG9yVGV4dCA9ICc8ZGl2IGNsYXNzPSJsb2FkaW5nLWluZGljYXRvciI+JytvLmluZGljYXRvclRleHQrIjwvZGl2PiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmKG1lLmluZGljYXRvclRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgRXh0LmdldERvbShvLmVsKS5pbm5lckhUTUwgPSBtZS5pbmRpY2F0b3JUZXh0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBvLnN1Y2Nlc3MgPSAoRXh0LmlzRnVuY3Rpb24oby5zdWNjZXNzKSA/IG8uc3VjY2VzcyA6IGZ1bmN0aW9uKCl7fSkuY3JlYXRlSW50ZXJjZXB0b3IoZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgRXh0LmdldERvbShvLmVsKS5pbm5lckhUTUwgPSByZXNwb25zZS5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHAgPSBvLnBhcmFtcywKICAgICAgICAgICAgICAgICAgICB1cmwgPSBvLnVybCB8fCBtZS51cmwsCiAgICAgICAgICAgICAgICAgICAgbWV0aG9kLAogICAgICAgICAgICAgICAgICAgIGNiID0ge3N1Y2Nlc3M6IG1lLmhhbmRsZVJlc3BvbnNlLAogICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWx1cmU6IG1lLmhhbmRsZUZhaWx1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IG1lLAogICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50OiB7b3B0aW9uczogb30sCiAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZW91dCA6IEV4dC5udW0oby50aW1lb3V0LCBtZS50aW1lb3V0KQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZm9ybSwKICAgICAgICAgICAgICAgICAgICBzZXJGb3JtOwoKCiAgICAgICAgICAgICAgICBpZiAoRXh0LmlzRnVuY3Rpb24ocCkpIHsKICAgICAgICAgICAgICAgICAgICBwID0gcC5jYWxsKG8uc2NvcGV8fFdJTkRPVywgbyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcCA9IEV4dC51cmxFbmNvZGUobWUuZXh0cmFQYXJhbXMsIEV4dC5pc09iamVjdChwKSA/IEV4dC51cmxFbmNvZGUocCkgOiBwKTsKCiAgICAgICAgICAgICAgICBpZiAoRXh0LmlzRnVuY3Rpb24odXJsKSkgewogICAgICAgICAgICAgICAgICAgIHVybCA9IHVybC5jYWxsKG8uc2NvcGUgfHwgV0lORE9XLCBvKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZigoZm9ybSA9IEV4dC5nZXREb20oby5mb3JtKSkpewogICAgICAgICAgICAgICAgICAgIHVybCA9IHVybCB8fCBmb3JtLmFjdGlvbjsKICAgICAgICAgICAgICAgICAgICAgaWYoby5pc1VwbG9hZCB8fCAoL211bHRpcGFydFwvZm9ybS1kYXRhL2kudGVzdChmb3JtLmdldEF0dHJpYnV0ZSgiZW5jdHlwZSIpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtZS5kb0Zvcm1VcGxvYWQuY2FsbChtZSwgbywgcCwgdXJsKTsKICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNlckZvcm0gPSBFeHQubGliLkFqYXguc2VyaWFsaXplRm9ybShmb3JtKTsKICAgICAgICAgICAgICAgICAgICBwID0gcCA/IChwICsgJyYnICsgc2VyRm9ybSkgOiBzZXJGb3JtOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG1ldGhvZCA9IG8ubWV0aG9kIHx8IG1lLm1ldGhvZCB8fCAoKHAgfHwgby54bWxEYXRhIHx8IG8uanNvbkRhdGEpID8gUE9TVCA6IEdFVCk7CgogICAgICAgICAgICAgICAgaWYobWV0aG9kID09PSBHRVQgJiYgKG1lLmRpc2FibGVDYWNoaW5nICYmIG8uZGlzYWJsZUNhY2hpbmcgIT09IGZhbHNlKSB8fCBvLmRpc2FibGVDYWNoaW5nID09PSB0cnVlKXsKICAgICAgICAgICAgICAgICAgICB2YXIgZGNwID0gby5kaXNhYmxlQ2FjaGluZ1BhcmFtIHx8IG1lLmRpc2FibGVDYWNoaW5nUGFyYW07CiAgICAgICAgICAgICAgICAgICAgdXJsID0gRXh0LnVybEFwcGVuZCh1cmwsIGRjcCArICc9JyArIChuZXcgRGF0ZSgpLmdldFRpbWUoKSkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG8uaGVhZGVycyA9IEV4dC5hcHBseUlmKG8uaGVhZGVycyB8fCB7fSwgbWUuZGVmYXVsdEhlYWRlcnMgfHwge30pOwoKICAgICAgICAgICAgICAgIGlmKG8uYXV0b0Fib3J0ID09PSB0cnVlIHx8IG1lLmF1dG9BYm9ydCkgewogICAgICAgICAgICAgICAgICAgIG1lLmFib3J0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYoKG1ldGhvZCA9PSBHRVQgfHwgby54bWxEYXRhIHx8IG8uanNvbkRhdGEpICYmIHApewogICAgICAgICAgICAgICAgICAgIHVybCA9IEV4dC51cmxBcHBlbmQodXJsLCBwKTsKICAgICAgICAgICAgICAgICAgICBwID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gKG1lLnRyYW5zSWQgPSBFeHQubGliLkFqYXgucmVxdWVzdChtZXRob2QsIHVybCwgY2IsIHAsIG8pKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICByZXR1cm4gby5jYWxsYmFjayA/IG8uY2FsbGJhY2suYXBwbHkoby5zY29wZSwgW28sVU5ERUZJTkVELFVOREVGSU5FRF0pIDogbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGlzTG9hZGluZyA6IGZ1bmN0aW9uKHRyYW5zSWQpewogICAgICAgICAgICByZXR1cm4gdHJhbnNJZCA/IEV4dC5saWIuQWpheC5pc0NhbGxJblByb2dyZXNzKHRyYW5zSWQpIDogISEgdGhpcy50cmFuc0lkOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGFib3J0IDogZnVuY3Rpb24odHJhbnNJZCl7CiAgICAgICAgICAgIGlmKHRyYW5zSWQgfHwgdGhpcy5pc0xvYWRpbmcoKSl7CiAgICAgICAgICAgICAgICBFeHQubGliLkFqYXguYWJvcnQodHJhbnNJZCB8fCB0aGlzLnRyYW5zSWQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaGFuZGxlUmVzcG9uc2UgOiBmdW5jdGlvbihyZXNwb25zZSl7CiAgICAgICAgICAgIHRoaXMudHJhbnNJZCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHJlc3BvbnNlLmFyZ3VtZW50Lm9wdGlvbnM7CiAgICAgICAgICAgIHJlc3BvbnNlLmFyZ3VtZW50ID0gb3B0aW9ucyA/IG9wdGlvbnMuYXJndW1lbnQgOiBudWxsOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudChSRVFVRVNUQ09NUExFVEUsIHRoaXMsIHJlc3BvbnNlLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYob3B0aW9ucy5zdWNjZXNzKXsKICAgICAgICAgICAgICAgIG9wdGlvbnMuc3VjY2Vzcy5jYWxsKG9wdGlvbnMuc2NvcGUsIHJlc3BvbnNlLCBvcHRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLmNhbGxiYWNrKXsKICAgICAgICAgICAgICAgIG9wdGlvbnMuY2FsbGJhY2suY2FsbChvcHRpb25zLnNjb3BlLCBvcHRpb25zLCB0cnVlLCByZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBoYW5kbGVGYWlsdXJlIDogZnVuY3Rpb24ocmVzcG9uc2UsIGUpewogICAgICAgICAgICB0aGlzLnRyYW5zSWQgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSByZXNwb25zZS5hcmd1bWVudC5vcHRpb25zOwogICAgICAgICAgICByZXNwb25zZS5hcmd1bWVudCA9IG9wdGlvbnMgPyBvcHRpb25zLmFyZ3VtZW50IDogbnVsbDsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoUkVRVUVTVEVYQ0VQVElPTiwgdGhpcywgcmVzcG9uc2UsIG9wdGlvbnMsIGUpOwogICAgICAgICAgICBpZihvcHRpb25zLmZhaWx1cmUpewogICAgICAgICAgICAgICAgb3B0aW9ucy5mYWlsdXJlLmNhbGwob3B0aW9ucy5zY29wZSwgcmVzcG9uc2UsIG9wdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG9wdGlvbnMuY2FsbGJhY2spewogICAgICAgICAgICAgICAgb3B0aW9ucy5jYWxsYmFjay5jYWxsKG9wdGlvbnMuc2NvcGUsIG9wdGlvbnMsIGZhbHNlLCByZXNwb25zZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBkb0Zvcm1VcGxvYWQgOiBmdW5jdGlvbihvLCBwcywgdXJsKXsKICAgICAgICAgICAgdmFyIGlkID0gRXh0LmlkKCksCiAgICAgICAgICAgICAgICBkb2MgPSBkb2N1bWVudCwKICAgICAgICAgICAgICAgIGZyYW1lID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpLAogICAgICAgICAgICAgICAgZm9ybSA9IEV4dC5nZXREb20oby5mb3JtKSwKICAgICAgICAgICAgICAgIGhpZGRlbnMgPSBbXSwKICAgICAgICAgICAgICAgIGhkLAogICAgICAgICAgICAgICAgZW5jb2RpbmcgPSAnbXVsdGlwYXJ0L2Zvcm0tZGF0YScsCiAgICAgICAgICAgICAgICBidWYgPSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0OiBmb3JtLnRhcmdldCwKICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IGZvcm0ubWV0aG9kLAogICAgICAgICAgICAgICAgICAgIGVuY29kaW5nOiBmb3JtLmVuY29kaW5nLAogICAgICAgICAgICAgICAgICAgIGVuY3R5cGU6IGZvcm0uZW5jdHlwZSwKICAgICAgICAgICAgICAgICAgICBhY3Rpb246IGZvcm0uYWN0aW9uCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgCiAgICAgICAgICAgIEV4dC5mbHkoZnJhbWUpLnNldCh7CiAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICBuYW1lOiBpZCwKICAgICAgICAgICAgICAgIGNsczogJ3gtaGlkZGVuJywKICAgICAgICAgICAgICAgIHNyYzogRXh0LlNTTF9TRUNVUkVfVVJMCiAgICAgICAgICAgIH0pOyAKCiAgICAgICAgICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKGZyYW1lKTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBpZihFeHQuaXNJRSl7CiAgICAgICAgICAgICAgIGRvY3VtZW50LmZyYW1lc1tpZF0ubmFtZSA9IGlkOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgRXh0LmZseShmb3JtKS5zZXQoewogICAgICAgICAgICAgICAgdGFyZ2V0OiBpZCwKICAgICAgICAgICAgICAgIG1ldGhvZDogUE9TVCwKICAgICAgICAgICAgICAgIGVuY3R5cGU6IGVuY29kaW5nLAogICAgICAgICAgICAgICAgZW5jb2Rpbmc6IGVuY29kaW5nLAogICAgICAgICAgICAgICAgYWN0aW9uOiB1cmwgfHwgYnVmLmFjdGlvbgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBFeHQuaXRlcmF0ZShFeHQudXJsRGVjb2RlKHBzLCBmYWxzZSksIGZ1bmN0aW9uKGssIHYpewogICAgICAgICAgICAgICAgaGQgPSBkb2MuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsKICAgICAgICAgICAgICAgIEV4dC5mbHkoaGQpLnNldCh7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2hpZGRlbicsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHYsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogawogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBmb3JtLmFwcGVuZENoaWxkKGhkKTsKICAgICAgICAgICAgICAgIGhpZGRlbnMucHVzaChoZCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZnVuY3Rpb24gY2IoKXsKICAgICAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgciA9IHtyZXNwb25zZVRleHQgOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlWE1MIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50IDogby5hcmd1bWVudH0sCiAgICAgICAgICAgICAgICAgICAgZG9jLAogICAgICAgICAgICAgICAgICAgIGZpcnN0Q2hpbGQ7CgogICAgICAgICAgICAgICAgdHJ5ewogICAgICAgICAgICAgICAgICAgIGRvYyA9IGZyYW1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQgfHwgZnJhbWUuY29udGVudERvY3VtZW50IHx8IFdJTkRPVy5mcmFtZXNbaWRdLmRvY3VtZW50OwogICAgICAgICAgICAgICAgICAgIGlmKGRvYyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGRvYy5ib2R5KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKC90ZXh0YXJlYS9pLnRlc3QoKGZpcnN0Q2hpbGQgPSBkb2MuYm9keS5maXJzdENoaWxkIHx8IHt9KS50YWdOYW1lKSl7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIucmVzcG9uc2VUZXh0ID0gZmlyc3RDaGlsZC52YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIucmVzcG9uc2VUZXh0ID0gZG9jLmJvZHkuaW5uZXJIVE1MOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByLnJlc3BvbnNlWE1MID0gZG9jLlhNTERvY3VtZW50IHx8IGRvYzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaChlKSB7fQoKICAgICAgICAgICAgICAgIEV4dC5FdmVudE1hbmFnZXIucmVtb3ZlTGlzdGVuZXIoZnJhbWUsIExPQUQsIGNiLCBtZSk7CgogICAgICAgICAgICAgICAgbWUuZmlyZUV2ZW50KFJFUVVFU1RDT01QTEVURSwgbWUsIHIsIG8pOwoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJ1bkNhbGxiYWNrKGZuLCBzY29wZSwgYXJncyl7CiAgICAgICAgICAgICAgICAgICAgaWYoRXh0LmlzRnVuY3Rpb24oZm4pKXsKICAgICAgICAgICAgICAgICAgICAgICAgZm4uYXBwbHkoc2NvcGUsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBydW5DYWxsYmFjayhvLnN1Y2Nlc3MsIG8uc2NvcGUsIFtyLCBvXSk7CiAgICAgICAgICAgICAgICBydW5DYWxsYmFjayhvLmNhbGxiYWNrLCBvLnNjb3BlLCBbbywgdHJ1ZSwgcl0pOwoKICAgICAgICAgICAgICAgIGlmKCFtZS5kZWJ1Z1VwbG9hZHMpewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtFeHQucmVtb3ZlTm9kZShmcmFtZSk7fSwgMTAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5vbihmcmFtZSwgTE9BRCwgY2IsIHRoaXMpOwogICAgICAgICAgICBmb3JtLnN1Ym1pdCgpOwoKICAgICAgICAgICAgRXh0LmZseShmb3JtKS5zZXQoYnVmKTsKICAgICAgICAgICAgRXh0LmVhY2goaGlkZGVucywgZnVuY3Rpb24oaCkgewogICAgICAgICAgICAgICAgRXh0LnJlbW92ZU5vZGUoaCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwp9KSgpOwoKCkV4dC5BamF4ID0gbmV3IEV4dC5kYXRhLkNvbm5lY3Rpb24oewogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAoKICAgIAoKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKCiAgICAKICAgIGF1dG9BYm9ydCA6IGZhbHNlLAoKICAgIAogICAgc2VyaWFsaXplRm9ybSA6IGZ1bmN0aW9uKGZvcm0pewogICAgICAgIHJldHVybiBFeHQubGliLkFqYXguc2VyaWFsaXplRm9ybShmb3JtKTsKICAgIH0KfSk7CgpFeHQudXRpbC5KU09OID0gbmV3IChmdW5jdGlvbigpewogICAgdmFyIHVzZUhhc093biA9ICEhe30uaGFzT3duUHJvcGVydHksCiAgICAgICAgaXNOYXRpdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHVzZU5hdGl2ZSA9IG51bGw7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAodXNlTmF0aXZlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdXNlTmF0aXZlID0gRXh0LlVTRV9OQVRJVkVfSlNPTiAmJiB3aW5kb3cuSlNPTiAmJiBKU09OLnRvU3RyaW5nKCkgPT0gJ1tvYmplY3QgSlNPTl0nOwogICAgICAgICAgICAgICAgfQogICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIHVzZU5hdGl2ZTsKICAgICAgICAgICAgfTsKICAgICAgICB9KCksCiAgICAgICAgcGFkID0gZnVuY3Rpb24obikgewogICAgICAgICAgICByZXR1cm4gbiA8IDEwID8gIjAiICsgbiA6IG47CiAgICAgICAgfSwKICAgICAgICBkb0RlY29kZSA9IGZ1bmN0aW9uKGpzb24pewogICAgICAgICAgICByZXR1cm4ganNvbiA/IGV2YWwoIigiICsganNvbiArICIpIikgOiAiIjsgICAgCiAgICAgICAgfSwKICAgICAgICBkb0VuY29kZSA9IGZ1bmN0aW9uKG8pewogICAgICAgICAgICBpZighRXh0LmlzRGVmaW5lZChvKSB8fCBvID09PSBudWxsKXsKICAgICAgICAgICAgICAgIHJldHVybiAibnVsbCI7CiAgICAgICAgICAgIH1lbHNlIGlmKEV4dC5pc0FycmF5KG8pKXsKICAgICAgICAgICAgICAgIHJldHVybiBlbmNvZGVBcnJheShvKTsKICAgICAgICAgICAgfWVsc2UgaWYoRXh0LmlzRGF0ZShvKSl7CiAgICAgICAgICAgICAgICByZXR1cm4gRXh0LnV0aWwuSlNPTi5lbmNvZGVEYXRlKG8pOwogICAgICAgICAgICB9ZWxzZSBpZihFeHQuaXNTdHJpbmcobykpewogICAgICAgICAgICAgICAgcmV0dXJuIGVuY29kZVN0cmluZyhvKTsKICAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mIG8gPT0gIm51bWJlciIpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gaXNGaW5pdGUobykgPyBTdHJpbmcobykgOiAibnVsbCI7CiAgICAgICAgICAgIH1lbHNlIGlmKEV4dC5pc0Jvb2xlYW4obykpewogICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhvKTsKICAgICAgICAgICAgfWVsc2UgewogICAgICAgICAgICAgICAgdmFyIGEgPSBbInsiXSwgYiwgaSwgdjsKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBvKSB7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYoIW8uZ2V0RWxlbWVudHNCeVRhZ05hbWUpewogICAgICAgICAgICAgICAgICAgICAgICBpZighdXNlSGFzT3duIHx8IG8uaGFzT3duUHJvcGVydHkoaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSBvW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgdikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInVua25vd24iOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihiKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5wdXNoKCcsJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEucHVzaChkb0VuY29kZShpKSwgIjoiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9PT0gbnVsbCA/ICJudWxsIiA6IGRvRW5jb2RlKHYpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGEucHVzaCgifSIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGEuam9pbigiIik7CiAgICAgICAgICAgIH0gICAgCiAgICAgICAgfSwKICAgICAgICBtID0gewogICAgICAgICAgICAiXGIiOiAnXFxiJywKICAgICAgICAgICAgIlx0IjogJ1xcdCcsCiAgICAgICAgICAgICJcbiI6ICdcXG4nLAogICAgICAgICAgICAiXGYiOiAnXFxmJywKICAgICAgICAgICAgIlxyIjogJ1xccicsCiAgICAgICAgICAgICciJyA6ICdcXCInLAogICAgICAgICAgICAiXFwiOiAnXFxcXCcKICAgICAgICB9LAogICAgICAgIGVuY29kZVN0cmluZyA9IGZ1bmN0aW9uKHMpewogICAgICAgICAgICBpZiAoL1siXFxceDAwLVx4MWZdLy50ZXN0KHMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJyInICsgcy5yZXBsYWNlKC8oW1x4MDAtXHgxZlxcIl0pL2csIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IG1bYl07CiAgICAgICAgICAgICAgICAgICAgaWYoYyl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjID0gYi5jaGFyQ29kZUF0KCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJcXHUwMCIgKwogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLmZsb29yKGMgLyAxNikudG9TdHJpbmcoMTYpICsKICAgICAgICAgICAgICAgICAgICAgICAgKGMgJSAxNikudG9TdHJpbmcoMTYpOwogICAgICAgICAgICAgICAgfSkgKyAnIic7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICciJyArIHMgKyAnIic7CiAgICAgICAgfSwKICAgICAgICBlbmNvZGVBcnJheSA9IGZ1bmN0aW9uKG8pewogICAgICAgICAgICB2YXIgYSA9IFsiWyJdLCBiLCBpLCBsID0gby5sZW5ndGgsIHY7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdiA9IG9baV07CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgdikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJ1bmRlZmluZWQiOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInVua25vd24iOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEucHVzaCgnLCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5wdXNoKHYgPT09IG51bGwgPyAibnVsbCIgOiBFeHQudXRpbC5KU09OLmVuY29kZSh2KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhLnB1c2goIl0iKTsKICAgICAgICAgICAgICAgIHJldHVybiBhLmpvaW4oIiIpOwogICAgICAgIH07CgogICAgCiAgICB0aGlzLmVuY29kZURhdGUgPSBmdW5jdGlvbihvKXsKICAgICAgICByZXR1cm4gJyInICsgby5nZXRGdWxsWWVhcigpICsgIi0iICsKICAgICAgICAgICAgICAgIHBhZChvLmdldE1vbnRoKCkgKyAxKSArICItIiArCiAgICAgICAgICAgICAgICBwYWQoby5nZXREYXRlKCkpICsgIlQiICsKICAgICAgICAgICAgICAgIHBhZChvLmdldEhvdXJzKCkpICsgIjoiICsKICAgICAgICAgICAgICAgIHBhZChvLmdldE1pbnV0ZXMoKSkgKyAiOiIgKwogICAgICAgICAgICAgICAgcGFkKG8uZ2V0U2Vjb25kcygpKSArICciJzsKICAgIH07CgogICAgCiAgICB0aGlzLmVuY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBlYzsKICAgICAgICByZXR1cm4gZnVuY3Rpb24obykgewogICAgICAgICAgICBpZiAoIWVjKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVjID0gaXNOYXRpdmUoKSA/IEpTT04uc3RyaW5naWZ5IDogZG9FbmNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVjKG8pOwogICAgICAgIH07CiAgICB9KCk7CgoKICAgIAogICAgdGhpcy5kZWNvZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGM7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGpzb24pIHsKICAgICAgICAgICAgaWYgKCFkYykgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBkYyA9IGlzTmF0aXZlKCkgPyBKU09OLnBhcnNlIDogZG9EZWNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRjKGpzb24pOwogICAgICAgIH07CiAgICB9KCk7Cgp9KSgpOwoKRXh0LmVuY29kZSA9IEV4dC51dGlsLkpTT04uZW5jb2RlOwoKRXh0LmRlY29kZSA9IEV4dC51dGlsLkpTT04uZGVjb2RlOwoKRXh0LkV2ZW50TWFuYWdlciA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgZG9jUmVhZHlFdmVudCwKICAgICAgICBkb2NSZWFkeVByb2NJZCwKICAgICAgICBkb2NSZWFkeVN0YXRlID0gZmFsc2UsCiAgICAgICAgREVURUNUX05BVElWRSA9IEV4dC5pc0dlY2tvIHx8IEV4dC5pc1dlYktpdCB8fCBFeHQuaXNTYWZhcmksCiAgICAgICAgRSA9IEV4dC5saWIuRXZlbnQsCiAgICAgICAgRCA9IEV4dC5saWIuRG9tLAogICAgICAgIERPQyA9IGRvY3VtZW50LAogICAgICAgIFdJTkRPVyA9IHdpbmRvdywKICAgICAgICBET01DT05URU5UTE9BREVEID0gIkRPTUNvbnRlbnRMb2FkZWQiLAogICAgICAgIENPTVBMRVRFID0gJ2NvbXBsZXRlJywKICAgICAgICBwcm9wUmUgPSAvXig/OnNjb3BlfGRlbGF5fGJ1ZmZlcnxzaW5nbGV8c3RvcEV2ZW50fHByZXZlbnREZWZhdWx0fHN0b3BQcm9wYWdhdGlvbnxub3JtYWxpemVkfGFyZ3N8ZGVsZWdhdGUpJC8sCiAgICAgICAgCiAgICAgICAgc3BlY2lhbEVsQ2FjaGUgPSBbXTsKCiAgICAgZnVuY3Rpb24gZ2V0SWQoZWwpewogICAgICAgIHZhciBpZCA9IGZhbHNlLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gc3BlY2lhbEVsQ2FjaGUubGVuZ3RoLAogICAgICAgICAgICBza2lwID0gZmFsc2UsCiAgICAgICAgICAgIG87CiAgICAgICAgICAgIAogICAgICAgIGlmIChlbCkgewogICAgICAgICAgICBpZiAoZWwuZ2V0RWxlbWVudEJ5SWQgfHwgZWwubmF2aWdhdG9yKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvcig7IGkgPCBsZW47ICsraSl7CiAgICAgICAgICAgICAgICAgICAgbyA9IHNwZWNpYWxFbENhY2hlW2ldOwogICAgICAgICAgICAgICAgICAgIGlmKG8uZWwgPT09IGVsKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWQgPSBvLmlkOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZighaWQpewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlkID0gRXh0LmlkKGVsKTsKICAgICAgICAgICAgICAgICAgICBzcGVjaWFsRWxDYWNoZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgICAgICAgICAgICAgICBlbDogZWwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBza2lwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBpZCA9IEV4dC5pZChlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIUV4dC5lbENhY2hlW2lkXSl7CiAgICAgICAgICAgICAgICBFeHQuRWxlbWVudC5hZGRUb0NhY2hlKG5ldyBFeHQuRWxlbWVudChlbCksIGlkKTsKICAgICAgICAgICAgICAgIGlmKHNraXApewogICAgICAgICAgICAgICAgICAgIEV4dC5lbENhY2hlW2lkXS5za2lwR0MgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBpZDsKICAgICB9CgogICAgCiAgICBmdW5jdGlvbiBhZGRMaXN0ZW5lcihlbCwgZW5hbWUsIGZuLCB0YXNrLCB3cmFwLCBzY29wZSl7CiAgICAgICAgZWwgPSBFeHQuZ2V0RG9tKGVsKTsKICAgICAgICB2YXIgaWQgPSBnZXRJZChlbCksCiAgICAgICAgICAgIGVzID0gRXh0LmVsQ2FjaGVbaWRdLmV2ZW50cywKICAgICAgICAgICAgd2ZuOwoKICAgICAgICB3Zm4gPSBFLm9uKGVsLCBlbmFtZSwgd3JhcCk7CiAgICAgICAgZXNbZW5hbWVdID0gZXNbZW5hbWVdIHx8IFtdOwoKICAgICAgICAKICAgICAgICBlc1tlbmFtZV0ucHVzaChbZm4sIHdyYXAsIHNjb3BlLCB3Zm4sIHRhc2tdKTsKCiAgICAgICAgCiAgICAgICAgCgogICAgICAgIAogICAgICAgIGlmKGVsLmFkZEV2ZW50TGlzdGVuZXIgJiYgZW5hbWUgPT0gIm1vdXNld2hlZWwiKXsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbIkRPTU1vdXNlU2Nyb2xsIiwgd3JhcCwgZmFsc2VdOwogICAgICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyLmFwcGx5KGVsLCBhcmdzKTsKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5hZGRMaXN0ZW5lcihXSU5ET1csICd1bmxvYWQnLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lci5hcHBseShlbCwgYXJncyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYoZWwgPT0gRE9DICYmIGVuYW1lID09ICJtb3VzZWRvd24iKXsKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5zdG9wcGVkTW91c2VEb3duRXZlbnQuYWRkTGlzdGVuZXIod3JhcCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGRvU2Nyb2xsQ2hrKCl7CiAgICAgICAgCiAgICAgICAgaWYod2luZG93ICE9IHRvcCl7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRyeXsKICAgICAgICAgICAgRE9DLmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCgnbGVmdCcpOwogICAgICAgIH1jYXRjaChlKXsKICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGZpcmVEb2NSZWFkeSgpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgCiAgICBmdW5jdGlvbiBjaGVja1JlYWR5U3RhdGUoZSl7CgogICAgICAgIGlmKEV4dC5pc0lFICYmIGRvU2Nyb2xsQ2hrKCkpewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgaWYoRE9DLnJlYWR5U3RhdGUgPT0gQ09NUExFVEUpewogICAgICAgICAgICBmaXJlRG9jUmVhZHkoKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGRvY1JlYWR5U3RhdGUgfHwgKGRvY1JlYWR5UHJvY0lkID0gc2V0VGltZW91dChhcmd1bWVudHMuY2FsbGVlLCAyKSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciBzdHlsZXM7CiAgICBmdW5jdGlvbiBjaGVja1N0eWxlU2hlZXRzKGUpewogICAgICAgIHN0eWxlcyB8fCAoc3R5bGVzID0gRXh0LnF1ZXJ5KCdzdHlsZSwgbGlua1tyZWw9c3R5bGVzaGVldF0nKSk7CiAgICAgICAgaWYoc3R5bGVzLmxlbmd0aCA9PSBET0Muc3R5bGVTaGVldHMubGVuZ3RoKXsKICAgICAgICAgICAgZmlyZURvY1JlYWR5KCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBkb2NSZWFkeVN0YXRlIHx8IChkb2NSZWFkeVByb2NJZCA9IHNldFRpbWVvdXQoYXJndW1lbnRzLmNhbGxlZSwgMikpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBPcGVyYURPTUNvbnRlbnRMb2FkZWQoZSl7CiAgICAgICAgRE9DLnJlbW92ZUV2ZW50TGlzdGVuZXIoRE9NQ09OVEVOVExPQURFRCwgYXJndW1lbnRzLmNhbGxlZSwgZmFsc2UpOwogICAgICAgIGNoZWNrU3R5bGVTaGVldHMoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBmaXJlRG9jUmVhZHkoZSl7CiAgICAgICAgaWYoIWRvY1JlYWR5U3RhdGUpewogICAgICAgICAgICBkb2NSZWFkeVN0YXRlID0gdHJ1ZTsgCgogICAgICAgICAgICBpZihkb2NSZWFkeVByb2NJZCl7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoZG9jUmVhZHlQcm9jSWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKERFVEVDVF9OQVRJVkUpIHsKICAgICAgICAgICAgICAgIERPQy5yZW1vdmVFdmVudExpc3RlbmVyKERPTUNPTlRFTlRMT0FERUQsIGZpcmVEb2NSZWFkeSwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKEV4dC5pc0lFICYmIGNoZWNrUmVhZHlTdGF0ZS5iaW5kSUUpeyAgCiAgICAgICAgICAgICAgICBET0MuZGV0YWNoRXZlbnQoJ29ucmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrUmVhZHlTdGF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRS51bihXSU5ET1csICJsb2FkIiwgYXJndW1lbnRzLmNhbGxlZSk7CiAgICAgICAgfQogICAgICAgIGlmKGRvY1JlYWR5RXZlbnQgJiYgIUV4dC5pc1JlYWR5KXsKICAgICAgICAgICAgRXh0LmlzUmVhZHkgPSB0cnVlOwogICAgICAgICAgICBkb2NSZWFkeUV2ZW50LmZpcmUoKTsKICAgICAgICAgICAgZG9jUmVhZHlFdmVudC5saXN0ZW5lcnMgPSBbXTsKICAgICAgICB9CgogICAgfQoKICAgIGZ1bmN0aW9uIGluaXREb2NSZWFkeSgpewogICAgICAgIGRvY1JlYWR5RXZlbnQgfHwgKGRvY1JlYWR5RXZlbnQgPSBuZXcgRXh0LnV0aWwuRXZlbnQoKSk7CiAgICAgICAgaWYgKERFVEVDVF9OQVRJVkUpIHsKICAgICAgICAgICAgRE9DLmFkZEV2ZW50TGlzdGVuZXIoRE9NQ09OVEVOVExPQURFRCwgZmlyZURvY1JlYWR5LCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChFeHQuaXNJRSl7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYoIWNoZWNrUmVhZHlTdGF0ZSgpKXsKICAgICAgICAgICAgICAgIGNoZWNrUmVhZHlTdGF0ZS5iaW5kSUUgPSB0cnVlOwogICAgICAgICAgICAgICAgRE9DLmF0dGFjaEV2ZW50KCdvbnJlYWR5c3RhdGVjaGFuZ2UnLCBjaGVja1JlYWR5U3RhdGUpOwogICAgICAgICAgICB9CgogICAgICAgIH1lbHNlIGlmKEV4dC5pc09wZXJhICl7CiAgICAgICAgICAgIAoKICAgICAgICAgICAgCiAgICAgICAgICAgIChET0MucmVhZHlTdGF0ZSA9PSBDT01QTEVURSAmJiBjaGVja1N0eWxlU2hlZXRzKCkpIHx8CiAgICAgICAgICAgICAgICBET0MuYWRkRXZlbnRMaXN0ZW5lcihET01DT05URU5UTE9BREVELCBPcGVyYURPTUNvbnRlbnRMb2FkZWQsIGZhbHNlKTsKCiAgICAgICAgfWVsc2UgaWYgKEV4dC5pc1dlYktpdCl7CiAgICAgICAgICAgIAogICAgICAgICAgICBjaGVja1JlYWR5U3RhdGUoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgRS5vbihXSU5ET1csICJsb2FkIiwgZmlyZURvY1JlYWR5KTsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVUYXJnZXRlZChoLCBvKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBFeHQudG9BcnJheShhcmd1bWVudHMpOwogICAgICAgICAgICBpZihvLnRhcmdldCA9PSBFeHQuRXZlbnRPYmplY3Quc2V0RXZlbnQoYXJnc1swXSkudGFyZ2V0KXsKICAgICAgICAgICAgICAgIGguYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZUJ1ZmZlcmVkKGgsIG8sIHRhc2spewogICAgICAgIHJldHVybiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRhc2suZGVsYXkoby5idWZmZXIsIGgsIG51bGwsIFtuZXcgRXh0LkV2ZW50T2JqZWN0SW1wbChlKV0pOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlU2luZ2xlKGgsIGVsLCBlbmFtZSwgZm4sIHNjb3BlKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSl7CiAgICAgICAgICAgIEV4dC5FdmVudE1hbmFnZXIucmVtb3ZlTGlzdGVuZXIoZWwsIGVuYW1lLCBmbiwgc2NvcGUpOwogICAgICAgICAgICBoKGUpOwogICAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gY3JlYXRlRGVsYXllZChoLCBvLCBmbil7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpewogICAgICAgICAgICB2YXIgdGFzayA9IG5ldyBFeHQudXRpbC5EZWxheWVkVGFzayhoKTsKICAgICAgICAgICAgaWYoIWZuLnRhc2tzKSB7CiAgICAgICAgICAgICAgICBmbi50YXNrcyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZuLnRhc2tzLnB1c2godGFzayk7CiAgICAgICAgICAgIHRhc2suZGVsYXkoby5kZWxheSB8fCAxMCwgaCwgbnVsbCwgW25ldyBFeHQuRXZlbnRPYmplY3RJbXBsKGUpXSk7CiAgICAgICAgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBsaXN0ZW4oZWxlbWVudCwgZW5hbWUsIG9wdCwgZm4sIHNjb3BlKXsKICAgICAgICB2YXIgbyA9ICghb3B0IHx8IHR5cGVvZiBvcHQgPT0gImJvb2xlYW4iKSA/IHt9IDogb3B0LAogICAgICAgICAgICBlbCA9IEV4dC5nZXREb20oZWxlbWVudCksIHRhc2s7CgogICAgICAgIGZuID0gZm4gfHwgby5mbjsKICAgICAgICBzY29wZSA9IHNjb3BlIHx8IG8uc2NvcGU7CgogICAgICAgIGlmKCFlbCl7CiAgICAgICAgICAgIHRocm93ICJFcnJvciBsaXN0ZW5pbmcgZm9yIFwiIiArIGVuYW1lICsgJ1wiLiBFbGVtZW50ICInICsgZWxlbWVudCArICciIGRvZXNuXCd0IGV4aXN0Lic7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGgoZSl7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZighRXh0KXsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlID0gRXh0LkV2ZW50T2JqZWN0LnNldEV2ZW50KGUpOwogICAgICAgICAgICB2YXIgdDsKICAgICAgICAgICAgaWYgKG8uZGVsZWdhdGUpIHsKICAgICAgICAgICAgICAgIGlmKCEodCA9IGUuZ2V0VGFyZ2V0KG8uZGVsZWdhdGUsIGVsKSkpewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHQgPSBlLnRhcmdldDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoby5zdG9wRXZlbnQpIHsKICAgICAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG8ucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoby5ub3JtYWxpemVkID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgZSA9IGUuYnJvd3NlckV2ZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IGVsLCBlLCB0LCBvKTsKICAgICAgICB9CiAgICAgICAgaWYoby50YXJnZXQpewogICAgICAgICAgICBoID0gY3JlYXRlVGFyZ2V0ZWQoaCwgbyk7CiAgICAgICAgfQogICAgICAgIGlmKG8uZGVsYXkpewogICAgICAgICAgICBoID0gY3JlYXRlRGVsYXllZChoLCBvLCBmbik7CiAgICAgICAgfQogICAgICAgIGlmKG8uc2luZ2xlKXsKICAgICAgICAgICAgaCA9IGNyZWF0ZVNpbmdsZShoLCBlbCwgZW5hbWUsIGZuLCBzY29wZSk7CiAgICAgICAgfQogICAgICAgIGlmKG8uYnVmZmVyKXsKICAgICAgICAgICAgdGFzayA9IG5ldyBFeHQudXRpbC5EZWxheWVkVGFzayhoKTsKICAgICAgICAgICAgaCA9IGNyZWF0ZUJ1ZmZlcmVkKGgsIG8sIHRhc2spOwogICAgICAgIH0KCiAgICAgICAgYWRkTGlzdGVuZXIoZWwsIGVuYW1lLCBmbiwgdGFzaywgaCwgc2NvcGUpOwogICAgICAgIHJldHVybiBoOwogICAgfQoKICAgIHZhciBwdWIgPSB7CiAgICAgICAgCiAgICAgICAgYWRkTGlzdGVuZXIgOiBmdW5jdGlvbihlbGVtZW50LCBldmVudE5hbWUsIGZuLCBzY29wZSwgb3B0aW9ucyl7CiAgICAgICAgICAgIGlmKHR5cGVvZiBldmVudE5hbWUgPT0gJ29iamVjdCcpewogICAgICAgICAgICAgICAgdmFyIG8gPSBldmVudE5hbWUsIGUsIHZhbDsKICAgICAgICAgICAgICAgIGZvcihlIGluIG8pewogICAgICAgICAgICAgICAgICAgIHZhbCA9IG9bZV07CiAgICAgICAgICAgICAgICAgICAgaWYoIXByb3BSZS50ZXN0KGUpKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoRXh0LmlzRnVuY3Rpb24odmFsKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbihlbGVtZW50LCBlLCBvLCB2YWwsIG8uc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuKGVsZW1lbnQsIGUsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaXN0ZW4oZWxlbWVudCwgZXZlbnROYW1lLCBvcHRpb25zLCBmbiwgc2NvcGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcmVtb3ZlTGlzdGVuZXIgOiBmdW5jdGlvbihlbCwgZXZlbnROYW1lLCBmbiwgc2NvcGUpewogICAgICAgICAgICBlbCA9IEV4dC5nZXREb20oZWwpOwogICAgICAgICAgICB2YXIgaWQgPSBnZXRJZChlbCksCiAgICAgICAgICAgICAgICBmID0gZWwgJiYgKEV4dC5lbENhY2hlW2lkXS5ldmVudHMpW2V2ZW50TmFtZV0gfHwgW10sCiAgICAgICAgICAgICAgICB3cmFwLCBpLCBsLCBrLCBsZW4sIGZuYzsKCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGYubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChFeHQuaXNBcnJheShmbmMgPSBmW2ldKSAmJiBmbmNbMF0gPT0gZm4gJiYgKCFzY29wZSB8fCBmbmNbMl0gPT0gc2NvcGUpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoZm5jWzRdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuY1s0XS5jYW5jZWwoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgayA9IGZuLnRhc2tzICYmIGZuLnRhc2tzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBpZihrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGstLSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4udGFza3Nba10uY2FuY2VsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGZuLnRhc2tzOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB3cmFwID0gZm5jWzFdOwogICAgICAgICAgICAgICAgICAgIEUudW4oZWwsIGV2ZW50TmFtZSwgRS5leHRBZGFwdGVyID8gZm5jWzNdIDogd3JhcCk7CgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmKHdyYXAgJiYgZWwuYWRkRXZlbnRMaXN0ZW5lciAmJiBldmVudE5hbWUgPT0gIm1vdXNld2hlZWwiKXsKICAgICAgICAgICAgICAgICAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NTW91c2VTY3JvbGwiLCB3cmFwLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZih3cmFwICYmIGVsID09IERPQyAmJiBldmVudE5hbWUgPT0gIm1vdXNlZG93biIpewogICAgICAgICAgICAgICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLnN0b3BwZWRNb3VzZURvd25FdmVudC5yZW1vdmVMaXN0ZW5lcih3cmFwKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGYuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGlmIChmLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgRXh0LmVsQ2FjaGVbaWRdLmV2ZW50c1tldmVudE5hbWVdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3IgKGsgaW4gRXh0LmVsQ2FjaGVbaWRdLmV2ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIEV4dC5lbENhY2hlW2lkXS5ldmVudHMgPSB7fTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICByZW1vdmVBbGwgOiBmdW5jdGlvbihlbCl7CiAgICAgICAgICAgIGVsID0gRXh0LmdldERvbShlbCk7CiAgICAgICAgICAgIHZhciBpZCA9IGdldElkKGVsKSwKICAgICAgICAgICAgICAgIGVjID0gRXh0LmVsQ2FjaGVbaWRdIHx8IHt9LAogICAgICAgICAgICAgICAgZXMgPSBlYy5ldmVudHMgfHwge30sCiAgICAgICAgICAgICAgICBmLCBpLCBsZW4sIGVuYW1lLCBmbiwgaywgd3JhcDsKCiAgICAgICAgICAgIGZvcihlbmFtZSBpbiBlcyl7CiAgICAgICAgICAgICAgICBpZihlcy5oYXNPd25Qcm9wZXJ0eShlbmFtZSkpewogICAgICAgICAgICAgICAgICAgIGYgPSBlc1tlbmFtZV07CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbGVuID0gZi5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBmbiA9IGZbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGZuWzRdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbls0XS5jYW5jZWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZihmblswXS50YXNrcyAmJiAoayA9IGZuWzBdLnRhc2tzLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGstLSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuWzBdLnRhc2tzW2tdLmNhbmNlbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGZuLnRhc2tzOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdyYXAgPSAgZm5bMV07CiAgICAgICAgICAgICAgICAgICAgICAgIEUudW4oZWwsIGVuYW1lLCBFLmV4dEFkYXB0ZXIgPyBmblszXSA6IHdyYXApOwoKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGVsLmFkZEV2ZW50TGlzdGVuZXIgJiYgd3JhcCAmJiBlbmFtZSA9PSAibW91c2V3aGVlbCIpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NTW91c2VTY3JvbGwiLCB3cmFwLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZih3cmFwICYmIGVsID09IERPQyAmJiAgZW5hbWUgPT0gIm1vdXNlZG93biIpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5zdG9wcGVkTW91c2VEb3duRXZlbnQucmVtb3ZlTGlzdGVuZXIod3JhcCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEV4dC5lbENhY2hlW2lkXSkgewogICAgICAgICAgICAgICAgRXh0LmVsQ2FjaGVbaWRdLmV2ZW50cyA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZ2V0TGlzdGVuZXJzIDogZnVuY3Rpb24oZWwsIGV2ZW50TmFtZSkgewogICAgICAgICAgICBlbCA9IEV4dC5nZXREb20oZWwpOwogICAgICAgICAgICB2YXIgaWQgPSBnZXRJZChlbCksCiAgICAgICAgICAgICAgICBlYyA9IEV4dC5lbENhY2hlW2lkXSB8fCB7fSwKICAgICAgICAgICAgICAgIGVzID0gZWMuZXZlbnRzIHx8IHt9LAogICAgICAgICAgICAgICAgcmVzdWx0cyA9IFtdOwogICAgICAgICAgICBpZiAoZXMgJiYgZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVzW2V2ZW50TmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHB1cmdlRWxlbWVudCA6IGZ1bmN0aW9uKGVsLCByZWN1cnNlLCBldmVudE5hbWUpIHsKICAgICAgICAgICAgZWwgPSBFeHQuZ2V0RG9tKGVsKTsKICAgICAgICAgICAgdmFyIGlkID0gZ2V0SWQoZWwpLAogICAgICAgICAgICAgICAgZWMgPSBFeHQuZWxDYWNoZVtpZF0gfHwge30sCiAgICAgICAgICAgICAgICBlcyA9IGVjLmV2ZW50cyB8fCB7fSwKICAgICAgICAgICAgICAgIGksIGYsIGxlbjsKICAgICAgICAgICAgaWYgKGV2ZW50TmFtZSkgewogICAgICAgICAgICAgICAgaWYgKGVzICYmIGVzLmhhc093blByb3BlcnR5KGV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBmID0gZXNbZXZlbnROYW1lXTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBmLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEV4dC5FdmVudE1hbmFnZXIucmVtb3ZlTGlzdGVuZXIoZWwsIGV2ZW50TmFtZSwgZltpXVswXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5yZW1vdmVBbGwoZWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZWN1cnNlICYmIGVsICYmIGVsLmNoaWxkTm9kZXMpIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGVsLmNoaWxkTm9kZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLnB1cmdlRWxlbWVudChlbC5jaGlsZE5vZGVzW2ldLCByZWN1cnNlLCBldmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgX3VubG9hZCA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZWw7CiAgICAgICAgICAgIGZvciAoZWwgaW4gRXh0LmVsQ2FjaGUpIHsKICAgICAgICAgICAgICAgIEV4dC5FdmVudE1hbmFnZXIucmVtb3ZlQWxsKGVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGUgRXh0LmVsQ2FjaGU7CiAgICAgICAgICAgIGRlbGV0ZSBFeHQuRWxlbWVudC5fZmx5d2VpZ2h0czsKCiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgYywKICAgICAgICAgICAgICAgIGNvbm4sCiAgICAgICAgICAgICAgICB0aWQsCiAgICAgICAgICAgICAgICBhamF4ID0gRXh0LmxpYi5BamF4OwogICAgICAgICAgICAodHlwZW9mIGFqYXguY29ubiA9PSAnb2JqZWN0JykgPyBjb25uID0gYWpheC5jb25uIDogY29ubiA9IHt9OwogICAgICAgICAgICBmb3IgKHRpZCBpbiBjb25uKSB7CiAgICAgICAgICAgICAgICBjID0gY29ublt0aWRdOwogICAgICAgICAgICAgICAgaWYgKGMpIHsKICAgICAgICAgICAgICAgICAgICBhamF4LmFib3J0KHtjb25uOiBjLCB0SWQ6IHRpZH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICBvbkRvY3VtZW50UmVhZHkgOiBmdW5jdGlvbihmbiwgc2NvcGUsIG9wdGlvbnMpewogICAgICAgICAgICBpZiAoRXh0LmlzUmVhZHkpIHsgCiAgICAgICAgICAgICAgICBkb2NSZWFkeUV2ZW50IHx8IChkb2NSZWFkeUV2ZW50ID0gbmV3IEV4dC51dGlsLkV2ZW50KCkpOwogICAgICAgICAgICAgICAgZG9jUmVhZHlFdmVudC5hZGRMaXN0ZW5lcihmbiwgc2NvcGUsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgZG9jUmVhZHlFdmVudC5maXJlKCk7CiAgICAgICAgICAgICAgICBkb2NSZWFkeUV2ZW50Lmxpc3RlbmVycyA9IFtdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFkb2NSZWFkeUV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaW5pdERvY1JlYWR5KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICAgICAgICAgIG9wdGlvbnMuZGVsYXkgPSBvcHRpb25zLmRlbGF5IHx8IDE7CiAgICAgICAgICAgICAgICBkb2NSZWFkeUV2ZW50LmFkZExpc3RlbmVyKGZuLCBzY29wZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBmaXJlRG9jUmVhZHkgIDogZmlyZURvY1JlYWR5CiAgICB9OwogICAgIAogICAgcHViLm9uID0gcHViLmFkZExpc3RlbmVyOwogICAgCiAgICBwdWIudW4gPSBwdWIucmVtb3ZlTGlzdGVuZXI7CgogICAgcHViLnN0b3BwZWRNb3VzZURvd25FdmVudCA9IG5ldyBFeHQudXRpbC5FdmVudCgpOwogICAgcmV0dXJuIHB1YjsKfSgpOwoKRXh0Lm9uUmVhZHkgPSBFeHQuRXZlbnRNYW5hZ2VyLm9uRG9jdW1lbnRSZWFkeTsKCgoKKGZ1bmN0aW9uKCl7CiAgICB2YXIgaW5pdEV4dENzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIAogICAgICAgIHZhciBiZCA9IGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXTsKICAgICAgICBpZiAoIWJkKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBjbHMgPSBbJyAnLAogICAgICAgICAgICAgICAgRXh0LmlzSUUgPyAiZXh0LWllICIgKyAoRXh0LmlzSUU2ID8gJ2V4dC1pZTYnIDogKEV4dC5pc0lFNyA/ICdleHQtaWU3JyA6IChFeHQuaXNJRTggPyAnZXh0LWllOCcgOiAnZXh0LWllOScpKSkKICAgICAgICAgICAgICAgIDogRXh0LmlzR2Vja28gPyAiZXh0LWdlY2tvICIgKyAoRXh0LmlzR2Vja28yID8gJ2V4dC1nZWNrbzInIDogJ2V4dC1nZWNrbzMnKQogICAgICAgICAgICAgICAgOiBFeHQuaXNPcGVyYSA/ICJleHQtb3BlcmEiCiAgICAgICAgICAgICAgICA6IEV4dC5pc1dlYktpdCA/ICJleHQtd2Via2l0IiA6ICIiXTsKCiAgICAgICAgaWYgKEV4dC5pc1NhZmFyaSkgewogICAgICAgICAgICBjbHMucHVzaCgiZXh0LXNhZmFyaSAiICsgKEV4dC5pc1NhZmFyaTIgPyAnZXh0LXNhZmFyaTInIDogKEV4dC5pc1NhZmFyaTMgPyAnZXh0LXNhZmFyaTMnIDogJ2V4dC1zYWZhcmk0JykpKTsKICAgICAgICB9IGVsc2UgaWYoRXh0LmlzQ2hyb21lKSB7CiAgICAgICAgICAgIGNscy5wdXNoKCJleHQtY2hyb21lIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoRXh0LmlzTWFjKSB7CiAgICAgICAgICAgIGNscy5wdXNoKCJleHQtbWFjIik7CiAgICAgICAgfQogICAgICAgIGlmIChFeHQuaXNMaW51eCkgewogICAgICAgICAgICBjbHMucHVzaCgiZXh0LWxpbnV4Iik7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBpZiAoRXh0LmlzU3RyaWN0IHx8IEV4dC5pc0JvcmRlckJveCkgewogICAgICAgICAgICB2YXIgcCA9IGJkLnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICBpZiAoIUV4dC5pc1N0cmljdCkgewogICAgICAgICAgICAgICAgICAgIEV4dC5mbHkocCwgJ19pbnRlcm5hbCcpLmFkZENsYXNzKCd4LXF1aXJrcycpOwogICAgICAgICAgICAgICAgICAgIGlmIChFeHQuaXNJRSAmJiAhRXh0LmlzU3RyaWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEV4dC5pc0lFUXVpcmtzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBFeHQuZmx5KHAsICdfaW50ZXJuYWwnKS5hZGRDbGFzcygoKEV4dC5pc1N0cmljdCAmJiBFeHQuaXNJRSApIHx8ICghRXh0LmVuYWJsZUZvcmNlZEJveE1vZGVsICYmICFFeHQuaXNJRSkpID8gJyBleHQtc3RyaWN0JyA6ICcgZXh0LWJvcmRlci1ib3gnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAKICAgICAgICBpZiAoRXh0LmVuYWJsZUZvcmNlZEJveE1vZGVsICYmICFFeHQuaXNJRSkgewogICAgICAgICAgICBFeHQuaXNGb3JjZWRCb3JkZXJCb3ggPSB0cnVlOwogICAgICAgICAgICBjbHMucHVzaCgiZXh0LWZvcmNlZC1ib3JkZXItYm94Iik7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEV4dC5mbHkoYmQsICdfaW50ZXJuYWwnKS5hZGRDbGFzcyhjbHMpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfTsKICAgIAogICAgaWYgKCFpbml0RXh0Q3NzKCkpIHsKICAgICAgICBFeHQub25SZWFkeShpbml0RXh0Q3NzKTsKICAgIH0KfSkoKTsKCgooZnVuY3Rpb24oKXsKICAgIHZhciBzdXBwb3J0cyA9IEV4dC5hcHBseShFeHQuc3VwcG9ydHMsIHsKICAgICAgICAKICAgICAgICBjb3JyZWN0UmlnaHRNYXJnaW46IHRydWUsCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgY29ycmVjdFRyYW5zcGFyZW50Q29sb3I6IHRydWUsCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgY3NzRmxvYXQ6IHRydWUKICAgIH0pOwogICAgCiAgICB2YXIgc3VwcG9ydFRlc3RzID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgICAgICAgICAgICAgZG9jID0gZG9jdW1lbnQsCiAgICAgICAgICAgICAgICB2aWV3LAogICAgICAgICAgICAgICAgbGFzdDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gJzxkaXYgc3R5bGU9ImhlaWdodDozMHB4O3dpZHRoOjUwcHg7Ij48ZGl2IHN0eWxlPSJoZWlnaHQ6MjBweDt3aWR0aDoyMHB4OyI+PC9kaXY+PC9kaXY+PGRpdiBzdHlsZT0iZmxvYXQ6bGVmdDtiYWNrZ3JvdW5kLWNvbG9yOnRyYW5zcGFyZW50OyI+JzsKICAgICAgICAgICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgICAgICAgbGFzdCA9IGRpdi5sYXN0Q2hpbGQ7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZigodmlldyA9IGRvYy5kZWZhdWx0VmlldykpewogICAgICAgICAgICAgICAgaWYodmlldy5nZXRDb21wdXRlZFN0eWxlKGRpdi5maXJzdENoaWxkLmZpcnN0Q2hpbGQsIG51bGwpLm1hcmdpblJpZ2h0ICE9ICcwcHgnKXsKICAgICAgICAgICAgICAgICAgICBzdXBwb3J0cy5jb3JyZWN0UmlnaHRNYXJnaW4gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKHZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShsYXN0LCBudWxsKS5iYWNrZ3JvdW5kQ29sb3IgIT0gJ3RyYW5zcGFyZW50Jyl7CiAgICAgICAgICAgICAgICAgICAgc3VwcG9ydHMuY29ycmVjdFRyYW5zcGFyZW50Q29sb3IgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzdXBwb3J0cy5jc3NGbG9hdCA9ICEhbGFzdC5zdHlsZS5jc3NGbG9hdDsKICAgICAgICAgICAgZG9jLmJvZHkucmVtb3ZlQ2hpbGQoZGl2KTsKICAgIH07CiAgICAKICAgIGlmIChFeHQuaXNSZWFkeSkgewogICAgICAgIHN1cHBvcnRUZXN0cygpOyAgICAKICAgIH0gZWxzZSB7CiAgICAgICAgRXh0Lm9uUmVhZHkoc3VwcG9ydFRlc3RzKTsKICAgIH0KfSkoKTsKCgoKRXh0LkV2ZW50T2JqZWN0ID0gZnVuY3Rpb24oKXsKICAgIHZhciBFID0gRXh0LmxpYi5FdmVudCwKICAgICAgICBjbGlja1JlID0gLyhkYmwpP2NsaWNrLywKICAgICAgICAKICAgICAgICBzYWZhcmlLZXlzID0gewogICAgICAgICAgICAzIDogMTMsIAogICAgICAgICAgICA2MzIzNCA6IDM3LCAKICAgICAgICAgICAgNjMyMzUgOiAzOSwgCiAgICAgICAgICAgIDYzMjMyIDogMzgsIAogICAgICAgICAgICA2MzIzMyA6IDQwLCAKICAgICAgICAgICAgNjMyNzYgOiAzMywgCiAgICAgICAgICAgIDYzMjc3IDogMzQsIAogICAgICAgICAgICA2MzI3MiA6IDQ2LCAKICAgICAgICAgICAgNjMyNzMgOiAzNiwgCiAgICAgICAgICAgIDYzMjc1IDogMzUgIAogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgYnRuTWFwID0gRXh0LmlzSUUgPyB7MTowLDQ6MSwyOjJ9IDogezA6MCwxOjEsMjoyfTsKCiAgICBFeHQuRXZlbnRPYmplY3RJbXBsID0gZnVuY3Rpb24oZSl7CiAgICAgICAgaWYoZSl7CiAgICAgICAgICAgIHRoaXMuc2V0RXZlbnQoZS5icm93c2VyRXZlbnQgfHwgZSk7CiAgICAgICAgfQogICAgfTsKCiAgICBFeHQuRXZlbnRPYmplY3RJbXBsLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAKICAgICAgICBzZXRFdmVudCA6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgICAgICBpZihlID09IG1lIHx8IChlICYmIGUuYnJvd3NlckV2ZW50KSl7IAogICAgICAgICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWUuYnJvd3NlckV2ZW50ID0gZTsKICAgICAgICAgICAgaWYoZSl7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIG1lLmJ1dHRvbiA9IGUuYnV0dG9uID8gYnRuTWFwW2UuYnV0dG9uXSA6IChlLndoaWNoID8gZS53aGljaCAtIDEgOiAtMSk7CiAgICAgICAgICAgICAgICBpZihjbGlja1JlLnRlc3QoZS50eXBlKSAmJiBtZS5idXR0b24gPT0gLTEpewogICAgICAgICAgICAgICAgICAgIG1lLmJ1dHRvbiA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtZS50eXBlID0gZS50eXBlOwogICAgICAgICAgICAgICAgbWUuc2hpZnRLZXkgPSBlLnNoaWZ0S2V5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBtZS5jdHJsS2V5ID0gZS5jdHJsS2V5IHx8IGUubWV0YUtleSB8fCBmYWxzZTsKICAgICAgICAgICAgICAgIG1lLmFsdEtleSA9IGUuYWx0S2V5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBtZS5rZXlDb2RlID0gZS5rZXlDb2RlOwogICAgICAgICAgICAgICAgbWUuY2hhckNvZGUgPSBlLmNoYXJDb2RlOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBtZS50YXJnZXQgPSBFLmdldFRhcmdldChlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbWUueHkgPSBFLmdldFhZKGUpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIG1lLmJ1dHRvbiA9IC0xOwogICAgICAgICAgICAgICAgbWUuc2hpZnRLZXkgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lLmN0cmxLZXkgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG1lLmFsdEtleSA9IGZhbHNlOwogICAgICAgICAgICAgICAgbWUua2V5Q29kZSA9IDA7CiAgICAgICAgICAgICAgICBtZS5jaGFyQ29kZSA9IDA7CiAgICAgICAgICAgICAgICBtZS50YXJnZXQgPSBudWxsOwogICAgICAgICAgICAgICAgbWUueHkgPSBbMCwgMF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1lOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHN0b3BFdmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgICAgIGlmKG1lLmJyb3dzZXJFdmVudCl7CiAgICAgICAgICAgICAgICBpZihtZS5icm93c2VyRXZlbnQudHlwZSA9PSAnbW91c2Vkb3duJyl7CiAgICAgICAgICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5zdG9wcGVkTW91c2VEb3duRXZlbnQuZmlyZShtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBFLnN0b3BFdmVudChtZS5icm93c2VyRXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcHJldmVudERlZmF1bHQgOiBmdW5jdGlvbigpewogICAgICAgICAgICBpZih0aGlzLmJyb3dzZXJFdmVudCl7CiAgICAgICAgICAgICAgICBFLnByZXZlbnREZWZhdWx0KHRoaXMuYnJvd3NlckV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHN0b3BQcm9wYWdhdGlvbiA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgICAgIGlmKG1lLmJyb3dzZXJFdmVudCl7CiAgICAgICAgICAgICAgICBpZihtZS5icm93c2VyRXZlbnQudHlwZSA9PSAnbW91c2Vkb3duJyl7CiAgICAgICAgICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5zdG9wcGVkTW91c2VEb3duRXZlbnQuZmlyZShtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBFLnN0b3BQcm9wYWdhdGlvbihtZS5icm93c2VyRXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0Q2hhckNvZGUgOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gdGhpcy5jaGFyQ29kZSB8fCB0aGlzLmtleUNvZGU7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0S2V5IDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplS2V5KHRoaXMua2V5Q29kZSB8fCB0aGlzLmNoYXJDb2RlKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBub3JtYWxpemVLZXk6IGZ1bmN0aW9uKGspewogICAgICAgICAgICByZXR1cm4gRXh0LmlzU2FmYXJpID8gKHNhZmFyaUtleXNba10gfHwgaykgOiBrOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldFBhZ2VYIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMueHlbMF07CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0UGFnZVkgOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gdGhpcy54eVsxXTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRYWSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnh5OwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldFRhcmdldCA6IGZ1bmN0aW9uKHNlbGVjdG9yLCBtYXhEZXB0aCwgcmV0dXJuRWwpewogICAgICAgICAgICByZXR1cm4gc2VsZWN0b3IgPyBFeHQuZmx5KHRoaXMudGFyZ2V0KS5maW5kUGFyZW50KHNlbGVjdG9yLCBtYXhEZXB0aCwgcmV0dXJuRWwpIDogKHJldHVybkVsID8gRXh0LmdldCh0aGlzLnRhcmdldCkgOiB0aGlzLnRhcmdldCk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0UmVsYXRlZFRhcmdldCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmJyb3dzZXJFdmVudCA/IEUuZ2V0UmVsYXRlZFRhcmdldCh0aGlzLmJyb3dzZXJFdmVudCkgOiBudWxsOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldFdoZWVsRGVsdGEgOiBmdW5jdGlvbigpewogICAgICAgICAgICB2YXIgZSA9IHRoaXMuYnJvd3NlckV2ZW50OwogICAgICAgICAgICB2YXIgZGVsdGEgPSAwOwogICAgICAgICAgICBpZihlLndoZWVsRGVsdGEpeyAKICAgICAgICAgICAgICAgIGRlbHRhID0gZS53aGVlbERlbHRhLzEyMDsKICAgICAgICAgICAgfWVsc2UgaWYoZS5kZXRhaWwpeyAKICAgICAgICAgICAgICAgIGRlbHRhID0gLWUuZGV0YWlsLzM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHdpdGhpbiA6IGZ1bmN0aW9uKGVsLCByZWxhdGVkLCBhbGxvd0VsKXsKICAgICAgICAgICAgaWYoZWwpewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzW3JlbGF0ZWQgPyAiZ2V0UmVsYXRlZFRhcmdldCIgOiAiZ2V0VGFyZ2V0Il0oKTsKICAgICAgICAgICAgICAgIHJldHVybiB0ICYmICgoYWxsb3dFbCA/ICh0ID09IEV4dC5nZXREb20oZWwpKSA6IGZhbHNlKSB8fCBFeHQuZmx5KGVsKS5jb250YWlucyh0KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICB9OwoKICAgIHJldHVybiBuZXcgRXh0LkV2ZW50T2JqZWN0SW1wbCgpOwp9KCk7CkV4dC5Mb2FkZXIgPSBFeHQuYXBwbHkoe30sIHsKICAgIAogICAgbG9hZDogZnVuY3Rpb24oZmlsZUxpc3QsIGNhbGxiYWNrLCBzY29wZSwgcHJlc2VydmVPcmRlcikgewogICAgICAgIHZhciBzY29wZSAgICAgICA9IHNjb3BlIHx8IHRoaXMsCiAgICAgICAgICAgIGhlYWQgICAgICAgID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXSwKICAgICAgICAgICAgZnJhZ21lbnQgICAgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgICAgIG51bUZpbGVzICAgID0gZmlsZUxpc3QubGVuZ3RoLAogICAgICAgICAgICBsb2FkZWRGaWxlcyA9IDAsCiAgICAgICAgICAgIG1lICAgICAgICAgID0gdGhpczsKICAgICAgICAKICAgICAgICAKICAgICAgICB2YXIgbG9hZEZpbGVJbmRleCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgIGhlYWQuYXBwZW5kQ2hpbGQoCiAgICAgICAgICAgICAgICBtZS5idWlsZFNjcmlwdFRhZyhmaWxlTGlzdFtpbmRleF0sIG9uRmlsZUxvYWRlZCkKICAgICAgICAgICAgKTsKICAgICAgICB9OwogICAgICAgIAogICAgICAgIAogICAgICAgIHZhciBvbkZpbGVMb2FkZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbG9hZGVkRmlsZXMgKys7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG51bUZpbGVzID09IGxvYWRlZEZpbGVzICYmIHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKHNjb3BlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwcmVzZXJ2ZU9yZGVyID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgbG9hZEZpbGVJbmRleChsb2FkZWRGaWxlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIGlmIChwcmVzZXJ2ZU9yZGVyID09PSB0cnVlKSB7CiAgICAgICAgICAgIGxvYWRGaWxlSW5kZXguY2FsbCh0aGlzLCAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAKICAgICAgICAgICAgRXh0LmVhY2goZmlsZUxpc3QsIGZ1bmN0aW9uKGZpbGUsIGluZGV4KSB7CiAgICAgICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZCgKICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1aWxkU2NyaXB0VGFnKGZpbGUsIG9uRmlsZUxvYWRlZCkKICAgICAgICAgICAgICAgICk7ICAKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBoZWFkLmFwcGVuZENoaWxkKGZyYWdtZW50KTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIGJ1aWxkU2NyaXB0VGFnOiBmdW5jdGlvbihmaWxlbmFtZSwgY2FsbGJhY2spIHsKICAgICAgICB2YXIgc2NyaXB0ICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgICAgIHNjcmlwdC50eXBlID0gInRleHQvamF2YXNjcmlwdCI7CiAgICAgICAgc2NyaXB0LnNyYyAgPSBmaWxlbmFtZTsKICAgICAgICAKICAgICAgICAKICAgICAgICBpZiAoc2NyaXB0LnJlYWR5U3RhdGUpIHsKICAgICAgICAgICAgc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHNjcmlwdC5yZWFkeVN0YXRlID09ICJsb2FkZWQiIHx8IHNjcmlwdC5yZWFkeVN0YXRlID09ICJjb21wbGV0ZSIpIHsKICAgICAgICAgICAgICAgICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBjYWxsYmFjazsKICAgICAgICB9ICAgIAogICAgICAgIAogICAgICAgIHJldHVybiBzY3JpcHQ7CiAgICB9Cn0pOwoKCkV4dC5ucygiRXh0LmdyaWQiLCAiRXh0Lmxpc3QiLCAiRXh0LmRkIiwgIkV4dC50cmVlIiwgIkV4dC5mb3JtIiwgIkV4dC5tZW51IiwKICAgICAgICJFeHQuc3RhdGUiLCAiRXh0LmxheW91dC5ib3hPdmVyZmxvdyIsICJFeHQuYXBwIiwgIkV4dC51eCIsICJFeHQuY2hhcnQiLCAiRXh0LmRpcmVjdCIsICJFeHQuc2xpZGVyIik7CiAgICAKCkV4dC5hcHBseShFeHQsIGZ1bmN0aW9uKCl7CiAgICB2YXIgRSA9IEV4dCwKICAgICAgICBpZFNlZWQgPSAwLAogICAgICAgIHNjcm9sbFdpZHRoID0gbnVsbDsKCiAgICByZXR1cm4gewogICAgICAgIAogICAgICAgIGVtcHR5Rm4gOiBmdW5jdGlvbigpe30sCgogICAgICAgIAogICAgICAgIEJMQU5LX0lNQUdFX1VSTCA6IEV4dC5pc0lFNiB8fCBFeHQuaXNJRTcgfHwgRXh0LmlzQWlyID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICdodHRwOi8nICsgJy93d3cuZXh0anMuY29tL3MuZ2lmJyA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJRC9BTURBd0FBQUFDSDVCQUVBQUFBQUxBQUFBQUFCQUFFQUFBSUNSQUVBT3c9PScsCgogICAgICAgIGV4dGVuZFggOiBmdW5jdGlvbihzdXByLCBmbil7CiAgICAgICAgICAgIHJldHVybiBFeHQuZXh0ZW5kKHN1cHIsIGZuKHN1cHIucHJvdG90eXBlKSk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0RG9jIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIEV4dC5nZXQoZG9jdW1lbnQpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIG51bSA6IGZ1bmN0aW9uKHYsIGRlZmF1bHRWYWx1ZSl7CiAgICAgICAgICAgIHYgPSBOdW1iZXIoRXh0LmlzRW1wdHkodikgfHwgRXh0LmlzQXJyYXkodikgfHwgdHlwZW9mIHYgPT0gJ2Jvb2xlYW4nIHx8ICh0eXBlb2YgdiA9PSAnc3RyaW5nJyAmJiB2LnRyaW0oKS5sZW5ndGggPT0gMCkgPyBOYU4gOiB2KTsKICAgICAgICAgICAgcmV0dXJuIGlzTmFOKHYpID8gZGVmYXVsdFZhbHVlIDogdjsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICB2YWx1ZSA6IGZ1bmN0aW9uKHYsIGRlZmF1bHRWYWx1ZSwgYWxsb3dCbGFuayl7CiAgICAgICAgICAgIHJldHVybiBFeHQuaXNFbXB0eSh2LCBhbGxvd0JsYW5rKSA/IGRlZmF1bHRWYWx1ZSA6IHY7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZXNjYXBlUmUgOiBmdW5jdGlvbihzKSB7CiAgICAgICAgICAgIHJldHVybiBzLnJlcGxhY2UoLyhbLS4qKz9eJHt9KCl8W1xdXC9cXF0pL2csICJcXCQxIik7CiAgICAgICAgfSwKCiAgICAgICAgc2VxdWVuY2UgOiBmdW5jdGlvbihvLCBuYW1lLCBmbiwgc2NvcGUpewogICAgICAgICAgICBvW25hbWVdID0gb1tuYW1lXS5jcmVhdGVTZXF1ZW5jZShmbiwgc2NvcGUpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGFkZEJlaGF2aW9ycyA6IGZ1bmN0aW9uKG8pewogICAgICAgICAgICBpZighRXh0LmlzUmVhZHkpewogICAgICAgICAgICAgICAgRXh0Lm9uUmVhZHkoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBFeHQuYWRkQmVoYXZpb3JzKG8pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgY2FjaGUgPSB7fSwgCiAgICAgICAgICAgICAgICAgICAgcGFydHMsCiAgICAgICAgICAgICAgICAgICAgYiwKICAgICAgICAgICAgICAgICAgICBzOwogICAgICAgICAgICAgICAgZm9yIChiIGluIG8pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKHBhcnRzID0gYi5zcGxpdCgnQCcpKVsxXSkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHBhcnRzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICBpZighY2FjaGVbc10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGVbc10gPSBFeHQuc2VsZWN0KHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlW3NdLm9uKHBhcnRzWzFdLCBvW2JdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYWNoZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRTY3JvbGxCYXJXaWR0aDogZnVuY3Rpb24oZm9yY2UpewogICAgICAgICAgICBpZighRXh0LmlzUmVhZHkpewogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKGZvcmNlID09PSB0cnVlIHx8IHNjcm9sbFdpZHRoID09PSBudWxsKXsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciBkaXYgPSBFeHQuZ2V0Qm9keSgpLmNyZWF0ZUNoaWxkKCc8ZGl2IGNsYXNzPSJ4LWhpZGUtb2Zmc2V0cyIgc3R5bGU9IndpZHRoOjEwMHB4O2hlaWdodDo1MHB4O292ZXJmbG93OmhpZGRlbjsiPjxkaXYgc3R5bGU9ImhlaWdodDoyMDBweDsiPjwvZGl2PjwvZGl2PicpLAogICAgICAgICAgICAgICAgICAgIGNoaWxkID0gZGl2LmNoaWxkKCdkaXYnLCB0cnVlKTsKICAgICAgICAgICAgICAgIHZhciB3MSA9IGNoaWxkLm9mZnNldFdpZHRoOwogICAgICAgICAgICAgICAgZGl2LnNldFN0eWxlKCdvdmVyZmxvdycsIChFeHQuaXNXZWJLaXQgfHwgRXh0LmlzR2Vja28pID8gJ2F1dG8nIDogJ3Njcm9sbCcpOwogICAgICAgICAgICAgICAgdmFyIHcyID0gY2hpbGQub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgICAgICBkaXYucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNjcm9sbFdpZHRoID0gdzEgLSB3MiArIDI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNjcm9sbFdpZHRoOwogICAgICAgIH0sCgoKICAgICAgICAKICAgICAgICBjb21iaW5lIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIGFzID0gYXJndW1lbnRzLCBsID0gYXMubGVuZ3RoLCByID0gW107CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBsOyBpKyspewogICAgICAgICAgICAgICAgdmFyIGEgPSBhc1tpXTsKICAgICAgICAgICAgICAgIGlmKEV4dC5pc0FycmF5KGEpKXsKICAgICAgICAgICAgICAgICAgICByID0gci5jb25jYXQoYSk7CiAgICAgICAgICAgICAgICB9ZWxzZSBpZihhLmxlbmd0aCAhPT0gdW5kZWZpbmVkICYmICFhLnN1YnN0cil7CiAgICAgICAgICAgICAgICAgICAgciA9IHIuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGEsIDApKTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIHIucHVzaChhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBjb3B5VG8gOiBmdW5jdGlvbihkZXN0LCBzb3VyY2UsIG5hbWVzKXsKICAgICAgICAgICAgaWYodHlwZW9mIG5hbWVzID09ICdzdHJpbmcnKXsKICAgICAgICAgICAgICAgIG5hbWVzID0gbmFtZXMuc3BsaXQoL1ssO1xzXS8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEV4dC5lYWNoKG5hbWVzLCBmdW5jdGlvbihuYW1lKXsKICAgICAgICAgICAgICAgIGlmKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSl7CiAgICAgICAgICAgICAgICAgICAgZGVzdFtuYW1lXSA9IHNvdXJjZVtuYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIHJldHVybiBkZXN0OwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgICAgICBFeHQuZWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKGFyZyl7CiAgICAgICAgICAgICAgICBpZihhcmcpewogICAgICAgICAgICAgICAgICAgIGlmKEV4dC5pc0FycmF5KGFyZykpewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJnKTsKICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YgYXJnLmRlc3Ryb3kgPT0gJ2Z1bmN0aW9uJyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZy5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYoYXJnLmRvbSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZy5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGRlc3Ryb3lNZW1iZXJzIDogZnVuY3Rpb24obywgYXJnMSwgYXJnMiwgZXRjKXsKICAgICAgICAgICAgZm9yKHZhciBpID0gMSwgYSA9IGFyZ3VtZW50cywgbGVuID0gYS5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgRXh0LmRlc3Ryb3kob1thW2ldXSk7CiAgICAgICAgICAgICAgICBkZWxldGUgb1thW2ldXTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGNsZWFuIDogZnVuY3Rpb24oYXJyKXsKICAgICAgICAgICAgdmFyIHJldCA9IFtdOwogICAgICAgICAgICBFeHQuZWFjaChhcnIsIGZ1bmN0aW9uKHYpewogICAgICAgICAgICAgICAgaWYoISF2KXsKICAgICAgICAgICAgICAgICAgICByZXQucHVzaCh2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgdW5pcXVlIDogZnVuY3Rpb24oYXJyKXsKICAgICAgICAgICAgdmFyIHJldCA9IFtdLAogICAgICAgICAgICAgICAgY29sbGVjdCA9IHt9OwoKICAgICAgICAgICAgRXh0LmVhY2goYXJyLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgICBpZighY29sbGVjdFt2XSl7CiAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2godik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb2xsZWN0W3ZdID0gdHJ1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZmxhdHRlbiA6IGZ1bmN0aW9uKGFycil7CiAgICAgICAgICAgIHZhciB3b3JrZXIgPSBbXTsKICAgICAgICAgICAgZnVuY3Rpb24gckZsYXR0ZW4oYSkgewogICAgICAgICAgICAgICAgRXh0LmVhY2goYSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgICAgICAgIGlmKEV4dC5pc0FycmF5KHYpKXsKICAgICAgICAgICAgICAgICAgICAgICAgckZsYXR0ZW4odik7CiAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtlci5wdXNoKHYpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gckZsYXR0ZW4oYXJyKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBtaW4gOiBmdW5jdGlvbihhcnIsIGNvbXApewogICAgICAgICAgICB2YXIgcmV0ID0gYXJyWzBdOwogICAgICAgICAgICBjb21wID0gY29tcCB8fCBmdW5jdGlvbihhLGIpeyByZXR1cm4gYSA8IGIgPyAtMSA6IDE7IH07CiAgICAgICAgICAgIEV4dC5lYWNoKGFyciwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgICAgcmV0ID0gY29tcChyZXQsIHYpID09IC0xID8gcmV0IDogdjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgbWF4IDogZnVuY3Rpb24oYXJyLCBjb21wKXsKICAgICAgICAgICAgdmFyIHJldCA9IGFyclswXTsKICAgICAgICAgICAgY29tcCA9IGNvbXAgfHwgZnVuY3Rpb24oYSxiKXsgcmV0dXJuIGEgPiBiID8gMSA6IC0xOyB9OwogICAgICAgICAgICBFeHQuZWFjaChhcnIsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICAgIHJldCA9IGNvbXAocmV0LCB2KSA9PSAxID8gcmV0IDogdjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgbWVhbiA6IGZ1bmN0aW9uKGFycil7CiAgICAgICAgICAgcmV0dXJuIGFyci5sZW5ndGggPiAwID8gRXh0LnN1bShhcnIpIC8gYXJyLmxlbmd0aCA6IHVuZGVmaW5lZDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBzdW0gOiBmdW5jdGlvbihhcnIpewogICAgICAgICAgIHZhciByZXQgPSAwOwogICAgICAgICAgIEV4dC5lYWNoKGFyciwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgICByZXQgKz0gdjsKICAgICAgICAgICB9KTsKICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHBhcnRpdGlvbiA6IGZ1bmN0aW9uKGFyciwgdHJ1dGgpewogICAgICAgICAgICB2YXIgcmV0ID0gW1tdLFtdXTsKICAgICAgICAgICAgRXh0LmVhY2goYXJyLCBmdW5jdGlvbih2LCBpLCBhKSB7CiAgICAgICAgICAgICAgICByZXRbICh0cnV0aCAmJiB0cnV0aCh2LCBpLCBhKSkgfHwgKCF0cnV0aCAmJiB2KSA/IDAgOiAxXS5wdXNoKHYpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBpbnZva2UgOiBmdW5jdGlvbihhcnIsIG1ldGhvZE5hbWUpewogICAgICAgICAgICB2YXIgcmV0ID0gW10sCiAgICAgICAgICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgICAgICAgRXh0LmVhY2goYXJyLCBmdW5jdGlvbih2LGkpIHsKICAgICAgICAgICAgICAgIGlmICh2ICYmIHR5cGVvZiB2W21ldGhvZE5hbWVdID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICByZXQucHVzaCh2W21ldGhvZE5hbWVdLmFwcGx5KHYsIGFyZ3MpKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2godW5kZWZpbmVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcGx1Y2sgOiBmdW5jdGlvbihhcnIsIHByb3ApewogICAgICAgICAgICB2YXIgcmV0ID0gW107CiAgICAgICAgICAgIEV4dC5lYWNoKGFyciwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgICAgcmV0LnB1c2goIHZbcHJvcF0gKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgemlwIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIHBhcnRzID0gRXh0LnBhcnRpdGlvbihhcmd1bWVudHMsIGZ1bmN0aW9uKCB2YWwgKXsgcmV0dXJuIHR5cGVvZiB2YWwgIT0gJ2Z1bmN0aW9uJzsgfSksCiAgICAgICAgICAgICAgICBhcnJzID0gcGFydHNbMF0sCiAgICAgICAgICAgICAgICBmbiA9IHBhcnRzWzFdWzBdLAogICAgICAgICAgICAgICAgbGVuID0gRXh0Lm1heChFeHQucGx1Y2soYXJycywgImxlbmd0aCIpKSwKICAgICAgICAgICAgICAgIHJldCA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgcmV0W2ldID0gW107CiAgICAgICAgICAgICAgICBpZihmbil7CiAgICAgICAgICAgICAgICAgICAgcmV0W2ldID0gZm4uYXBwbHkoZm4sIEV4dC5wbHVjayhhcnJzLCBpKSk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgYUxlbiA9IGFycnMubGVuZ3RoOyBqIDwgYUxlbjsgaisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0W2ldLnB1c2goIGFycnNbal1baV0gKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRDbXAgOiBmdW5jdGlvbihpZCl7CiAgICAgICAgICAgIHJldHVybiBFeHQuQ29tcG9uZW50TWdyLmdldChpZCk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgdXNlU2hpbXM6IEUuaXNJRTYgfHwgKEUuaXNNYWMgJiYgRS5pc0dlY2tvMiksCgogICAgICAgIAogICAgICAgIAogICAgICAgIHR5cGUgOiBmdW5jdGlvbihvKXsKICAgICAgICAgICAgaWYobyA9PT0gdW5kZWZpbmVkIHx8IG8gPT09IG51bGwpewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG8uaHRtbEVsZW1lbnQpewogICAgICAgICAgICAgICAgcmV0dXJuICdlbGVtZW50JzsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdCA9IHR5cGVvZiBvOwogICAgICAgICAgICBpZih0ID09ICdvYmplY3QnICYmIG8ubm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgIHN3aXRjaChvLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOiByZXR1cm4gJ2VsZW1lbnQnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMzogcmV0dXJuICgvXFMvKS50ZXN0KG8ubm9kZVZhbHVlKSA/ICd0ZXh0bm9kZScgOiAnd2hpdGVzcGFjZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodCA9PSAnb2JqZWN0JyB8fCB0ID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIHN3aXRjaChvLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBBcnJheTogcmV0dXJuICdhcnJheSc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSZWdFeHA6IHJldHVybiAncmVnZXhwJzsKICAgICAgICAgICAgICAgICAgICBjYXNlIERhdGU6IHJldHVybiAnZGF0ZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZih0eXBlb2Ygby5sZW5ndGggPT0gJ251bWJlcicgJiYgdHlwZW9mIG8uaXRlbSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdub2RlbGlzdCc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHQ7CiAgICAgICAgfSwKCiAgICAgICAgaW50ZXJjZXB0IDogZnVuY3Rpb24obywgbmFtZSwgZm4sIHNjb3BlKXsKICAgICAgICAgICAgb1tuYW1lXSA9IG9bbmFtZV0uY3JlYXRlSW50ZXJjZXB0b3IoZm4sIHNjb3BlKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBjYWxsYmFjayA6IGZ1bmN0aW9uKGNiLCBzY29wZSwgYXJncywgZGVsYXkpewogICAgICAgICAgICBpZih0eXBlb2YgY2IgPT0gJ2Z1bmN0aW9uJyl7CiAgICAgICAgICAgICAgICBpZihkZWxheSl7CiAgICAgICAgICAgICAgICAgICAgY2IuZGVmZXIoZGVsYXksIHNjb3BlLCBhcmdzIHx8IFtdKTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIGNiLmFwcGx5KHNjb3BlLCBhcmdzIHx8IFtdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07Cn0oKSk7CgoKRXh0LmFwcGx5KEZ1bmN0aW9uLnByb3RvdHlwZSwgewogICAgCiAgICBjcmVhdGVTZXF1ZW5jZSA6IGZ1bmN0aW9uKGZjbiwgc2NvcGUpewogICAgICAgIHZhciBtZXRob2QgPSB0aGlzOwogICAgICAgIHJldHVybiAodHlwZW9mIGZjbiAhPSAnZnVuY3Rpb24nKSA/CiAgICAgICAgICAgICAgICB0aGlzIDoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJldHZhbCA9IG1ldGhvZC5hcHBseSh0aGlzIHx8IHdpbmRvdywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICBmY24uYXBwbHkoc2NvcGUgfHwgdGhpcyB8fCB3aW5kb3csIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldHZhbDsKICAgICAgICAgICAgICAgIH07CiAgICB9Cn0pOwoKCgpFeHQuYXBwbHlJZihTdHJpbmcsIHsKCiAgICAKICAgIGVzY2FwZSA6IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcucmVwbGFjZSgvKCd8XFwpL2csICJcXCQxIik7CiAgICB9LAoKICAgIAogICAgbGVmdFBhZCA6IGZ1bmN0aW9uICh2YWwsIHNpemUsIGNoKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFN0cmluZyh2YWwpOwogICAgICAgIGlmKCFjaCkgewogICAgICAgICAgICBjaCA9ICIgIjsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKHJlc3VsdC5sZW5ndGggPCBzaXplKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGNoICsgcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQp9KTsKCgpTdHJpbmcucHJvdG90eXBlLnRvZ2dsZSA9IGZ1bmN0aW9uKHZhbHVlLCBvdGhlcil7CiAgICByZXR1cm4gdGhpcyA9PSB2YWx1ZSA/IG90aGVyIDogdmFsdWU7Cn07CgoKU3RyaW5nLnByb3RvdHlwZS50cmltID0gZnVuY3Rpb24oKXsKICAgIHZhciByZSA9IC9eXHMrfFxzKyQvZzsKICAgIHJldHVybiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5yZXBsYWNlKHJlLCAiIik7IH07Cn0oKTsKCgoKRGF0ZS5wcm90b3R5cGUuZ2V0RWxhcHNlZCA9IGZ1bmN0aW9uKGRhdGUpIHsKICAgIHJldHVybiBNYXRoLmFicygoZGF0ZSB8fCBuZXcgRGF0ZSgpKS5nZXRUaW1lKCktdGhpcy5nZXRUaW1lKCkpOwp9OwoKCgpFeHQuYXBwbHlJZihOdW1iZXIucHJvdG90eXBlLCB7CiAgICAKICAgIGNvbnN0cmFpbiA6IGZ1bmN0aW9uKG1pbiwgbWF4KXsKICAgICAgICByZXR1cm4gTWF0aC5taW4oTWF0aC5tYXgodGhpcywgbWluKSwgbWF4KTsKICAgIH0KfSk7CkV4dC5saWIuRG9tLmdldFJlZ2lvbiA9IGZ1bmN0aW9uKGVsKSB7CiAgICByZXR1cm4gRXh0LmxpYi5SZWdpb24uZ2V0UmVnaW9uKGVsKTsKfTsJRXh0LmxpYi5SZWdpb24gPSBmdW5jdGlvbih0LCByLCBiLCBsKSB7CgkJdmFyIG1lID0gdGhpczsKICAgICAgICBtZS50b3AgPSB0OwogICAgICAgIG1lWzFdID0gdDsKICAgICAgICBtZS5yaWdodCA9IHI7CiAgICAgICAgbWUuYm90dG9tID0gYjsKICAgICAgICBtZS5sZWZ0ID0gbDsKICAgICAgICBtZVswXSA9IGw7CiAgICB9OwoKICAgIEV4dC5saWIuUmVnaW9uLnByb3RvdHlwZSA9IHsKICAgICAgICBjb250YWlucyA6IGZ1bmN0aW9uKHJlZ2lvbikgewoJICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgICAgICByZXR1cm4gKCByZWdpb24ubGVmdCA+PSBtZS5sZWZ0ICYmCiAgICAgICAgICAgICAgICAgICAgIHJlZ2lvbi5yaWdodCA8PSBtZS5yaWdodCAmJgogICAgICAgICAgICAgICAgICAgICByZWdpb24udG9wID49IG1lLnRvcCAmJgogICAgICAgICAgICAgICAgICAgICByZWdpb24uYm90dG9tIDw9IG1lLmJvdHRvbSApOwoKICAgICAgICB9LAoKICAgICAgICBnZXRBcmVhIDogZnVuY3Rpb24oKSB7CgkgICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiAoIChtZS5ib3R0b20gLSBtZS50b3ApICogKG1lLnJpZ2h0IC0gbWUubGVmdCkgKTsKICAgICAgICB9LAoKICAgICAgICBpbnRlcnNlY3QgOiBmdW5jdGlvbihyZWdpb24pIHsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgCXQgPSBNYXRoLm1heChtZS50b3AsIHJlZ2lvbi50b3ApLAogICAgICAgICAgICAJciA9IE1hdGgubWluKG1lLnJpZ2h0LCByZWdpb24ucmlnaHQpLAogICAgICAgICAgICAJYiA9IE1hdGgubWluKG1lLmJvdHRvbSwgcmVnaW9uLmJvdHRvbSksCiAgICAgICAgICAgIAlsID0gTWF0aC5tYXgobWUubGVmdCwgcmVnaW9uLmxlZnQpOwoKICAgICAgICAgICAgaWYgKGIgPj0gdCAmJiByID49IGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRXh0LmxpYi5SZWdpb24odCwgciwgYiwgbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIHVuaW9uIDogZnVuY3Rpb24ocmVnaW9uKSB7CgkgICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgIAl0ID0gTWF0aC5taW4obWUudG9wLCByZWdpb24udG9wKSwKICAgICAgICAgICAgCXIgPSBNYXRoLm1heChtZS5yaWdodCwgcmVnaW9uLnJpZ2h0KSwKICAgICAgICAgICAgCWIgPSBNYXRoLm1heChtZS5ib3R0b20sIHJlZ2lvbi5ib3R0b20pLAogICAgICAgICAgICAJbCA9IE1hdGgubWluKG1lLmxlZnQsIHJlZ2lvbi5sZWZ0KTsKCiAgICAgICAgICAgIHJldHVybiBuZXcgRXh0LmxpYi5SZWdpb24odCwgciwgYiwgbCk7CiAgICAgICAgfSwKCiAgICAgICAgY29uc3RyYWluVG8gOiBmdW5jdGlvbihyKSB7CgkgICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgICAgIG1lLnRvcCA9IG1lLnRvcC5jb25zdHJhaW4oci50b3AsIHIuYm90dG9tKTsKICAgICAgICAgICAgbWUuYm90dG9tID0gbWUuYm90dG9tLmNvbnN0cmFpbihyLnRvcCwgci5ib3R0b20pOwogICAgICAgICAgICBtZS5sZWZ0ID0gbWUubGVmdC5jb25zdHJhaW4oci5sZWZ0LCByLnJpZ2h0KTsKICAgICAgICAgICAgbWUucmlnaHQgPSBtZS5yaWdodC5jb25zdHJhaW4oci5sZWZ0LCByLnJpZ2h0KTsKICAgICAgICAgICAgcmV0dXJuIG1lOwogICAgICAgIH0sCgogICAgICAgIGFkanVzdCA6IGZ1bmN0aW9uKHQsIGwsIGIsIHIpIHsKCSAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICAgICAgbWUudG9wICs9IHQ7CiAgICAgICAgICAgIG1lLmxlZnQgKz0gbDsKICAgICAgICAgICAgbWUucmlnaHQgKz0gcjsKICAgICAgICAgICAgbWUuYm90dG9tICs9IGI7CiAgICAgICAgICAgIHJldHVybiBtZTsKICAgICAgICB9CiAgICB9OwoKICAgIEV4dC5saWIuUmVnaW9uLmdldFJlZ2lvbiA9IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgdmFyIHAgPSBFeHQubGliLkRvbS5nZXRYWShlbCksCiAgICAgICAgCXQgPSBwWzFdLAogICAgICAgIAlyID0gcFswXSArIGVsLm9mZnNldFdpZHRoLAogICAgICAgIAliID0gcFsxXSArIGVsLm9mZnNldEhlaWdodCwKICAgICAgICAJbCA9IHBbMF07CgogICAgICAgIHJldHVybiBuZXcgRXh0LmxpYi5SZWdpb24odCwgciwgYiwgbCk7CiAgICB9OwlFeHQubGliLlBvaW50ID0gZnVuY3Rpb24oeCwgeSkgewogICAgICAgIGlmIChFeHQuaXNBcnJheSh4KSkgewogICAgICAgICAgICB5ID0geFsxXTsKICAgICAgICAgICAgeCA9IHhbMF07CiAgICAgICAgfQogICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgbWUueCA9IG1lLnJpZ2h0ID0gbWUubGVmdCA9IG1lWzBdID0geDsKICAgICAgICBtZS55ID0gbWUudG9wID0gbWUuYm90dG9tID0gbWVbMV0gPSB5OwogICAgfTsKCiAgICBFeHQubGliLlBvaW50LnByb3RvdHlwZSA9IG5ldyBFeHQubGliLlJlZ2lvbigpOwoKRXh0LmFwcGx5KEV4dC5Eb21IZWxwZXIsCmZ1bmN0aW9uKCl7CiAgICB2YXIgcHViLAogICAgICAgIGFmdGVyYmVnaW4gPSAnYWZ0ZXJiZWdpbicsCiAgICAgICAgYWZ0ZXJlbmQgPSAnYWZ0ZXJlbmQnLAogICAgICAgIGJlZm9yZWJlZ2luID0gJ2JlZm9yZWJlZ2luJywKICAgICAgICBiZWZvcmVlbmQgPSAnYmVmb3JlZW5kJywKICAgICAgICBjb25mUmUgPSAvdGFnfGNoaWxkcmVufGNufGh0bWwkL2k7CgogICAgCiAgICBmdW5jdGlvbiBkb0luc2VydChlbCwgbywgcmV0dXJuRWxlbWVudCwgcG9zLCBzaWJsaW5nLCBhcHBlbmQpewogICAgICAgIGVsID0gRXh0LmdldERvbShlbCk7CiAgICAgICAgdmFyIG5ld05vZGU7CiAgICAgICAgaWYgKHB1Yi51c2VEb20pIHsKICAgICAgICAgICAgbmV3Tm9kZSA9IGNyZWF0ZURvbShvLCBudWxsKTsKICAgICAgICAgICAgaWYgKGFwcGVuZCkgewogICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQobmV3Tm9kZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAoc2libGluZyA9PSAnZmlyc3RDaGlsZCcgPyBlbCA6IGVsLnBhcmVudE5vZGUpLmluc2VydEJlZm9yZShuZXdOb2RlLCBlbFtzaWJsaW5nXSB8fCBlbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdOb2RlID0gRXh0LkRvbUhlbHBlci5pbnNlcnRIdG1sKHBvcywgZWwsIEV4dC5Eb21IZWxwZXIuY3JlYXRlSHRtbChvKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXR1cm5FbGVtZW50ID8gRXh0LmdldChuZXdOb2RlLCB0cnVlKSA6IG5ld05vZGU7CiAgICB9CgogICAgCiAgICAKICAgIGZ1bmN0aW9uIGNyZWF0ZURvbShvLCBwYXJlbnROb2RlKXsKICAgICAgICB2YXIgZWwsCiAgICAgICAgICAgIGRvYyA9IGRvY3VtZW50LAogICAgICAgICAgICB1c2VTZXQsCiAgICAgICAgICAgIGF0dHIsCiAgICAgICAgICAgIHZhbCwKICAgICAgICAgICAgY247CgogICAgICAgIGlmIChFeHQuaXNBcnJheShvKSkgeyAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsgCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gby5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGNyZWF0ZURvbShvW2ldLCBlbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvID09ICdzdHJpbmcnKSB7ICAgICAgICAgCiAgICAgICAgICAgIGVsID0gZG9jLmNyZWF0ZVRleHROb2RlKG8pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVsID0gZG9jLmNyZWF0ZUVsZW1lbnQoIG8udGFnIHx8ICdkaXYnICk7CiAgICAgICAgICAgIHVzZVNldCA9ICEhZWwuc2V0QXR0cmlidXRlOyAKICAgICAgICAgICAgZm9yICh2YXIgYXR0ciBpbiBvKSB7CiAgICAgICAgICAgICAgICBpZighY29uZlJlLnRlc3QoYXR0cikpewogICAgICAgICAgICAgICAgICAgIHZhbCA9IG9bYXR0cl07CiAgICAgICAgICAgICAgICAgICAgaWYoYXR0ciA9PSAnY2xzJyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmNsYXNzTmFtZSA9IHZhbDsKICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodXNlU2V0KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShhdHRyLCB2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsW2F0dHJdID0gdmFsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwbHlTdHlsZXMoZWwsIG8uc3R5bGUpOwoKICAgICAgICAgICAgaWYgKChjbiA9IG8uY2hpbGRyZW4gfHwgby5jbikpIHsKICAgICAgICAgICAgICAgIGNyZWF0ZURvbShjbiwgZWwpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG8uaHRtbCkgewogICAgICAgICAgICAgICAgZWwuaW5uZXJIVE1MID0gby5odG1sOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmKHBhcmVudE5vZGUpewogICAgICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZWw7CiAgICB9CgogICAgcHViID0gewogICAgICAgIAogICAgICAgIGNyZWF0ZVRlbXBsYXRlIDogZnVuY3Rpb24obyl7CiAgICAgICAgICAgIHZhciBodG1sID0gRXh0LkRvbUhlbHBlci5jcmVhdGVIdG1sKG8pOwogICAgICAgICAgICByZXR1cm4gbmV3IEV4dC5UZW1wbGF0ZShodG1sKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICB1c2VEb20gOiBmYWxzZSwKCiAgICAgICAgCiAgICAgICAgaW5zZXJ0QmVmb3JlIDogZnVuY3Rpb24oZWwsIG8sIHJldHVybkVsZW1lbnQpewogICAgICAgICAgICByZXR1cm4gZG9JbnNlcnQoZWwsIG8sIHJldHVybkVsZW1lbnQsIGJlZm9yZWJlZ2luKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBpbnNlcnRBZnRlciA6IGZ1bmN0aW9uKGVsLCBvLCByZXR1cm5FbGVtZW50KXsKICAgICAgICAgICAgcmV0dXJuIGRvSW5zZXJ0KGVsLCBvLCByZXR1cm5FbGVtZW50LCBhZnRlcmVuZCwgJ25leHRTaWJsaW5nJyk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaW5zZXJ0Rmlyc3QgOiBmdW5jdGlvbihlbCwgbywgcmV0dXJuRWxlbWVudCl7CiAgICAgICAgICAgIHJldHVybiBkb0luc2VydChlbCwgbywgcmV0dXJuRWxlbWVudCwgYWZ0ZXJiZWdpbiwgJ2ZpcnN0Q2hpbGQnKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBhcHBlbmQ6IGZ1bmN0aW9uKGVsLCBvLCByZXR1cm5FbGVtZW50KXsKICAgICAgICAgICAgcmV0dXJuIGRvSW5zZXJ0KGVsLCBvLCByZXR1cm5FbGVtZW50LCBiZWZvcmVlbmQsICcnLCB0cnVlKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBjcmVhdGVEb206IGNyZWF0ZURvbQogICAgfTsKICAgIHJldHVybiBwdWI7Cn0oKSk7CgpFeHQuYXBwbHkoRXh0LlRlbXBsYXRlLnByb3RvdHlwZSwgewogICAgCiAgICBkaXNhYmxlRm9ybWF0cyA6IGZhbHNlLAogICAgCgogICAgCiAgICByZSA6IC9ceyhbXHdcLV0rKSg/Olw6KFtcd1wuXSopKD86XCgoLio/KT9cKSk/KT9cfS9nLAogICAgYXJnc1JlIDogL15ccypbJyJdKC4qKVsiJ11ccyokLywKICAgIGNvbXBpbGVBUmUgOiAvXFwvZywKICAgIGNvbXBpbGVCUmUgOiAvKFxyXG58XG4pL2csCiAgICBjb21waWxlQ1JlIDogLycvZywKCiAgICAvKioKICAgICAqIFJldHVybnMgYW4gSFRNTCBmcmFnbWVudCBvZiB0aGlzIHRlbXBsYXRlIHdpdGggdGhlIHNwZWNpZmllZCB2YWx1ZXMgYXBwbGllZC4KICAgICAqIEBwYXJhbSB7T2JqZWN0L0FycmF5fSB2YWx1ZXMgVGhlIHRlbXBsYXRlIHZhbHVlcy4gQ2FuIGJlIGFuIGFycmF5IGlmIHlvdXIgcGFyYW1zIGFyZSBudW1lcmljIChpLmUuIHswfSkgb3IgYW4gb2JqZWN0IChpLmUuIHtmb286ICdiYXInfSkKICAgICAqIEByZXR1cm4ge1N0cmluZ30gVGhlIEhUTUwgZnJhZ21lbnQKICAgICAqIEBoaWRlIHJlcGVhdCBkb2MKICAgICAqLwogICAgYXBwbHlUZW1wbGF0ZSA6IGZ1bmN0aW9uKHZhbHVlcyl7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgdXNlRiA9IG1lLmRpc2FibGVGb3JtYXRzICE9PSB0cnVlLAogICAgICAgICAgICBmbSA9IEV4dC51dGlsLkZvcm1hdCwKICAgICAgICAgICAgdHBsID0gbWU7CgogICAgICAgIGlmKG1lLmNvbXBpbGVkKXsKICAgICAgICAgICAgcmV0dXJuIG1lLmNvbXBpbGVkKHZhbHVlcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZuKG0sIG5hbWUsIGZvcm1hdCwgYXJncyl7CiAgICAgICAgICAgIGlmIChmb3JtYXQgJiYgdXNlRikgewogICAgICAgICAgICAgICAgaWYgKGZvcm1hdC5zdWJzdHIoMCwgNSkgPT0gInRoaXMuIikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cGwuY2FsbChmb3JtYXQuc3Vic3RyKDUpLCB2YWx1ZXNbbmFtZV0sIHZhbHVlcyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHF1b3RlZCB2YWx1ZXMgYXJlIHJlcXVpcmVkIGZvciBzdHJpbmdzIGluIGNvbXBpbGVkIHRlbXBsYXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IGZvciBub24gY29tcGlsZWQgd2UgbmVlZCB0byBzdHJpcCB0aGVtCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHF1b3RlZCByZXZlcnNlZCBmb3IganNtaW4KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlID0gbWUuYXJnc1JlOwogICAgICAgICAgICAgICAgICAgICAgICBhcmdzID0gYXJncy5zcGxpdCgnLCcpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBhcmdzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3NbaV0gPSBhcmdzW2ldLnJlcGxhY2UocmUsICIkMSIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBbdmFsdWVzW25hbWVdXS5jb25jYXQoYXJncyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJncyA9IFt2YWx1ZXNbbmFtZV1dOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZm1bZm9ybWF0XS5hcHBseShmbSwgYXJncyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWVzW25hbWVdICE9PSB1bmRlZmluZWQgPyB2YWx1ZXNbbmFtZV0gOiAiIjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWUuaHRtbC5yZXBsYWNlKG1lLnJlLCBmbik7CiAgICB9LAoKICAgIC8qKgogICAgICogQ29tcGlsZXMgdGhlIHRlbXBsYXRlIGludG8gYW4gaW50ZXJuYWwgZnVuY3Rpb24sIGVsaW1pbmF0aW5nIHRoZSBSZWdFeCBvdmVyaGVhZC4KICAgICAqIEByZXR1cm4ge0V4dC5UZW1wbGF0ZX0gdGhpcwogICAgICogQGhpZGUgcmVwZWF0IGRvYwogICAgICovCiAgICBjb21waWxlIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBmbSA9IEV4dC51dGlsLkZvcm1hdCwKICAgICAgICAgICAgdXNlRiA9IG1lLmRpc2FibGVGb3JtYXRzICE9PSB0cnVlLAogICAgICAgICAgICBzZXAgPSBFeHQuaXNHZWNrbyA/ICIrIiA6ICIsIiwKICAgICAgICAgICAgYm9keTsKCiAgICAgICAgZnVuY3Rpb24gZm4obSwgbmFtZSwgZm9ybWF0LCBhcmdzKXsKICAgICAgICAgICAgaWYoZm9ybWF0ICYmIHVzZUYpewogICAgICAgICAgICAgICAgYXJncyA9IGFyZ3MgPyAnLCcgKyBhcmdzIDogIiI7CiAgICAgICAgICAgICAgICBpZihmb3JtYXQuc3Vic3RyKDAsIDUpICE9ICJ0aGlzLiIpewogICAgICAgICAgICAgICAgICAgIGZvcm1hdCA9ICJmbS4iICsgZm9ybWF0ICsgJygnOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gJ3RoaXMuY2FsbCgiJysgZm9ybWF0LnN1YnN0cig1KSArICciLCAnOwogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSAiLCB2YWx1ZXMiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGFyZ3M9ICcnOyBmb3JtYXQgPSAiKHZhbHVlc1snIiArIG5hbWUgKyAiJ10gPT0gdW5kZWZpbmVkID8gJycgOiAiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiJyIrIHNlcCArIGZvcm1hdCArICJ2YWx1ZXNbJyIgKyBuYW1lICsgIiddIiArIGFyZ3MgKyAiKSIrc2VwKyInIjsKICAgICAgICB9CgogICAgICAgIC8vIGJyYW5jaGVkIHRvIHVzZSArIGluIGdlY2tvIGFuZCBbXS5qb2luKCkgaW4gb3RoZXJzCiAgICAgICAgaWYoRXh0LmlzR2Vja28pewogICAgICAgICAgICBib2R5ID0gInRoaXMuY29tcGlsZWQgPSBmdW5jdGlvbih2YWx1ZXMpeyByZXR1cm4gJyIgKwogICAgICAgICAgICAgICAgICAgbWUuaHRtbC5yZXBsYWNlKG1lLmNvbXBpbGVBUmUsICdcXFxcJykucmVwbGFjZShtZS5jb21waWxlQlJlLCAnXFxuJykucmVwbGFjZShtZS5jb21waWxlQ1JlLCAiXFwnIikucmVwbGFjZShtZS5yZSwgZm4pICsKICAgICAgICAgICAgICAgICAgICAiJzt9OyI7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGJvZHkgPSBbInRoaXMuY29tcGlsZWQgPSBmdW5jdGlvbih2YWx1ZXMpeyByZXR1cm4gWyciXTsKICAgICAgICAgICAgYm9keS5wdXNoKG1lLmh0bWwucmVwbGFjZShtZS5jb21waWxlQVJlLCAnXFxcXCcpLnJlcGxhY2UobWUuY29tcGlsZUJSZSwgJ1xcbicpLnJlcGxhY2UobWUuY29tcGlsZUNSZSwgIlxcJyIpLnJlcGxhY2UobWUucmUsIGZuKSk7CiAgICAgICAgICAgIGJvZHkucHVzaCgiJ10uam9pbignJyk7fTsiKTsKICAgICAgICAgICAgYm9keSA9IGJvZHkuam9pbignJyk7CiAgICAgICAgfQogICAgICAgIGV2YWwoYm9keSk7CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKCiAgICAvLyBwcml2YXRlIGZ1bmN0aW9uIHVzZWQgdG8gY2FsbCBtZW1iZXJzCiAgICBjYWxsIDogZnVuY3Rpb24oZm5OYW1lLCB2YWx1ZSwgYWxsVmFsdWVzKXsKICAgICAgICByZXR1cm4gdGhpc1tmbk5hbWVdKHZhbHVlLCBhbGxWYWx1ZXMpOwogICAgfQp9KTsKRXh0LlRlbXBsYXRlLnByb3RvdHlwZS5hcHBseSA9IEV4dC5UZW1wbGF0ZS5wcm90b3R5cGUuYXBwbHlUZW1wbGF0ZTsKLyoqCiAqIEBjbGFzcyBFeHQudXRpbC5GdW5jdGlvbnMKICogQHNpbmdsZXRvbgogKi8KRXh0LnV0aWwuRnVuY3Rpb25zID0gewogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGludGVyY2VwdG9yIGZ1bmN0aW9uLiBUaGUgcGFzc2VkIGZ1bmN0aW9uIGlzIGNhbGxlZCBiZWZvcmUgdGhlIG9yaWdpbmFsIG9uZS4gSWYgaXQgcmV0dXJucyBmYWxzZSwKICAgICAqIHRoZSBvcmlnaW5hbCBvbmUgaXMgbm90IGNhbGxlZC4gVGhlIHJlc3VsdGluZyBmdW5jdGlvbiByZXR1cm5zIHRoZSByZXN1bHRzIG9mIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICAgICAqIFRoZSBwYXNzZWQgZnVuY3Rpb24gaXMgY2FsbGVkIHdpdGggdGhlIHBhcmFtZXRlcnMgb2YgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLiBFeGFtcGxlIHVzYWdlOgogICAgICogPHByZT48Y29kZT4KdmFyIHNheUhpID0gZnVuY3Rpb24obmFtZSl7CiAgICBhbGVydCgnSGksICcgKyBuYW1lKTsKfQoKc2F5SGkoJ0ZyZWQnKTsgLy8gYWxlcnRzICJIaSwgRnJlZCIKCi8vIGNyZWF0ZSBhIG5ldyBmdW5jdGlvbiB0aGF0IHZhbGlkYXRlcyBpbnB1dCB3aXRob3V0Ci8vIGRpcmVjdGx5IG1vZGlmeWluZyB0aGUgb3JpZ2luYWwgZnVuY3Rpb246CnZhciBzYXlIaVRvRnJpZW5kID0gRXh0LmNyZWF0ZUludGVyY2VwdG9yKHNheUhpLCBmdW5jdGlvbihuYW1lKXsKICAgIHJldHVybiBuYW1lID09ICdCcmlhbic7Cn0pOwoKc2F5SGlUb0ZyaWVuZCgnRnJlZCcpOyAgLy8gbm8gYWxlcnQKc2F5SGlUb0ZyaWVuZCgnQnJpYW4nKTsgLy8gYWxlcnRzICJIaSwgQnJpYW4iCiAgICAgICA8L2NvZGU+PC9wcmU+CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvcmlnRm4gVGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gbmV3Rm4gVGhlIGZ1bmN0aW9uIHRvIGNhbGwgYmVmb3JlIHRoZSBvcmlnaW5hbAogICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIChvcHRpb25hbCkgVGhlIHNjb3BlICg8Y29kZT48Yj50aGlzPC9iPjwvY29kZT4gcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUgcGFzc2VkIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICogPGI+SWYgb21pdHRlZCwgZGVmYXVsdHMgdG8gdGhlIHNjb3BlIGluIHdoaWNoIHRoZSBvcmlnaW5hbCBmdW5jdGlvbiBpcyBjYWxsZWQgb3IgdGhlIGJyb3dzZXIgd2luZG93LjwvYj4KICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBUaGUgbmV3IGZ1bmN0aW9uCiAgICAgKi8KICAgIGNyZWF0ZUludGVyY2VwdG9yOiBmdW5jdGlvbihvcmlnRm4sIG5ld0ZuLCBzY29wZSkgeyAKICAgICAgICB2YXIgbWV0aG9kID0gb3JpZ0ZuOwogICAgICAgIGlmICghRXh0LmlzRnVuY3Rpb24obmV3Rm4pKSB7CiAgICAgICAgICAgIHJldHVybiBvcmlnRm47CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgICAgICBuZXdGbi50YXJnZXQgPSBtZTsKICAgICAgICAgICAgICAgIG5ld0ZuLm1ldGhvZCA9IG9yaWdGbjsKICAgICAgICAgICAgICAgIHJldHVybiAobmV3Rm4uYXBwbHkoc2NvcGUgfHwgbWUgfHwgd2luZG93LCBhcmdzKSAhPT0gZmFsc2UpID8KICAgICAgICAgICAgICAgICAgICAgICAgb3JpZ0ZuLmFwcGx5KG1lIHx8IHdpbmRvdywgYXJncykgOgogICAgICAgICAgICAgICAgICAgICAgICBudWxsOwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZGVsZWdhdGUgKGNhbGxiYWNrKSB0aGF0IHNldHMgdGhlIHNjb3BlIHRvIG9iai4KICAgICAqIENhbGwgZGlyZWN0bHkgb24gYW55IGZ1bmN0aW9uLiBFeGFtcGxlOiA8Y29kZT5FeHQuY3JlYXRlRGVsZWdhdGUodGhpcy5teUZ1bmN0aW9uLCB0aGlzLCBbYXJnMSwgYXJnMl0pPC9jb2RlPgogICAgICogV2lsbCBjcmVhdGUgYSBmdW5jdGlvbiB0aGF0IGlzIGF1dG9tYXRpY2FsbHkgc2NvcGVkIHRvIG9iaiBzbyB0aGF0IHRoZSA8dHQ+dGhpczwvdHQ+IHZhcmlhYmxlIGluc2lkZSB0aGUKICAgICAqIGNhbGxiYWNrIHBvaW50cyB0byBvYmouIEV4YW1wbGUgdXNhZ2U6CiAgICAgKiA8cHJlPjxjb2RlPgp2YXIgc2F5SGkgPSBmdW5jdGlvbihuYW1lKXsKICAgIC8vIE5vdGUgdGhpcyB1c2Ugb2YgInRoaXMudGV4dCIgaGVyZS4gIFRoaXMgZnVuY3Rpb24gZXhwZWN0cyB0bwogICAgLy8gZXhlY3V0ZSB3aXRoaW4gYSBzY29wZSB0aGF0IGNvbnRhaW5zIGEgdGV4dCBwcm9wZXJ0eS4gIEluIHRoaXMKICAgIC8vIGV4YW1wbGUsIHRoZSAidGhpcyIgdmFyaWFibGUgaXMgcG9pbnRpbmcgdG8gdGhlIGJ0biBvYmplY3QgdGhhdAogICAgLy8gd2FzIHBhc3NlZCBpbiBjcmVhdGVEZWxlZ2F0ZSBiZWxvdy4KICAgIGFsZXJ0KCdIaSwgJyArIG5hbWUgKyAnLiBZb3UgY2xpY2tlZCB0aGUgIicgKyB0aGlzLnRleHQgKyAnIiBidXR0b24uJyk7Cn0KCnZhciBidG4gPSBuZXcgRXh0LkJ1dHRvbih7CiAgICB0ZXh0OiAnU2F5IEhpJywKICAgIHJlbmRlclRvOiBFeHQuZ2V0Qm9keSgpCn0pOwoKLy8gVGhpcyBjYWxsYmFjayB3aWxsIGV4ZWN1dGUgaW4gdGhlIHNjb3BlIG9mIHRoZQovLyBidXR0b24gaW5zdGFuY2UuIENsaWNraW5nIHRoZSBidXR0b24gYWxlcnRzCi8vICJIaSwgRnJlZC4gWW91IGNsaWNrZWQgdGhlICJTYXkgSGkiIGJ1dHRvbi4iCmJ0bi5vbignY2xpY2snLCBFeHQuY3JlYXRlRGVsZWdhdGUoc2F5SGksIGJ0biwgWydGcmVkJ10pKTsKICAgICAgIDwvY29kZT48L3ByZT4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBkZWxlZ2F0ZS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY29wZSAob3B0aW9uYWwpIFRoZSBzY29wZSAoPGNvZGU+PGI+dGhpczwvYj48L2NvZGU+IHJlZmVyZW5jZSkgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICogPGI+SWYgb21pdHRlZCwgZGVmYXVsdHMgdG8gdGhlIGJyb3dzZXIgd2luZG93LjwvYj4KICAgICAqIEBwYXJhbSB7QXJyYXl9IGFyZ3MgKG9wdGlvbmFsKSBPdmVycmlkZXMgYXJndW1lbnRzIGZvciB0aGUgY2FsbC4gKERlZmF1bHRzIHRvIHRoZSBhcmd1bWVudHMgcGFzc2VkIGJ5IHRoZSBjYWxsZXIpCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW4vTnVtYmVyfSBhcHBlbmRBcmdzIChvcHRpb25hbCkgaWYgVHJ1ZSBhcmdzIGFyZSBhcHBlbmRlZCB0byBjYWxsIGFyZ3MgaW5zdGVhZCBvZiBvdmVycmlkaW5nLAogICAgICogaWYgYSBudW1iZXIgdGhlIGFyZ3MgYXJlIGluc2VydGVkIGF0IHRoZSBzcGVjaWZpZWQgcG9zaXRpb24KICAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBUaGUgbmV3IGZ1bmN0aW9uCiAgICAgKi8KICAgIGNyZWF0ZURlbGVnYXRlOiBmdW5jdGlvbihmbiwgb2JqLCBhcmdzLCBhcHBlbmRBcmdzKSB7CiAgICAgICAgaWYgKCFFeHQuaXNGdW5jdGlvbihmbikpIHsKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjYWxsQXJncyA9IGFyZ3MgfHwgYXJndW1lbnRzOwogICAgICAgICAgICBpZiAoYXBwZW5kQXJncyA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgY2FsbEFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgICAgICAgICAgY2FsbEFyZ3MgPSBjYWxsQXJncy5jb25jYXQoYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoRXh0LmlzTnVtYmVyKGFwcGVuZEFyZ3MpKSB7CiAgICAgICAgICAgICAgICBjYWxsQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgICAgICAgICAgICAgICAvLyBjb3B5IGFyZ3VtZW50cyBmaXJzdAogICAgICAgICAgICAgICAgdmFyIGFwcGx5QXJncyA9IFthcHBlbmRBcmdzLCAwXS5jb25jYXQoYXJncyk7CiAgICAgICAgICAgICAgICAvLyBjcmVhdGUgbWV0aG9kIGNhbGwgcGFyYW1zCiAgICAgICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmFwcGx5KGNhbGxBcmdzLCBhcHBseUFyZ3MpOwogICAgICAgICAgICAgICAgLy8gc3BsaWNlIHRoZW0gaW4KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkob2JqIHx8IHdpbmRvdywgY2FsbEFyZ3MpOwogICAgICAgIH07CiAgICB9LAoKICAgIC8qKgogICAgICogQ2FsbHMgdGhpcyBmdW5jdGlvbiBhZnRlciB0aGUgbnVtYmVyIG9mIG1pbGxzZWNvbmRzIHNwZWNpZmllZCwgb3B0aW9uYWxseSBpbiBhIHNwZWNpZmljIHNjb3BlLiBFeGFtcGxlIHVzYWdlOgogICAgICogPHByZT48Y29kZT4KdmFyIHNheUhpID0gZnVuY3Rpb24obmFtZSl7CiAgICBhbGVydCgnSGksICcgKyBuYW1lKTsKfQoKLy8gZXhlY3V0ZXMgaW1tZWRpYXRlbHk6CnNheUhpKCdGcmVkJyk7CgovLyBleGVjdXRlcyBhZnRlciAyIHNlY29uZHM6CkV4dC5kZWZlcihzYXlIaSwgMjAwMCwgdGhpcywgWydGcmVkJ10pOwoKLy8gdGhpcyBzeW50YXggaXMgc29tZXRpbWVzIHVzZWZ1bCBmb3IgZGVmZXJyaW5nCi8vIGV4ZWN1dGlvbiBvZiBhbiBhbm9ueW1vdXMgZnVuY3Rpb246CkV4dC5kZWZlcihmdW5jdGlvbigpewogICAgYWxlcnQoJ0Fub255bW91cycpOwp9LCAxMDApOwogICAgICAgPC9jb2RlPjwvcHJlPgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIGRlZmVyLgogICAgICogQHBhcmFtIHtOdW1iZXJ9IG1pbGxpcyBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBmb3IgdGhlIHNldFRpbWVvdXQgY2FsbCAoaWYgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIDAgdGhlIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkIGltbWVkaWF0ZWx5KQogICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIChvcHRpb25hbCkgVGhlIHNjb3BlICg8Y29kZT48Yj50aGlzPC9iPjwvY29kZT4gcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAgICAgKiA8Yj5JZiBvbWl0dGVkLCBkZWZhdWx0cyB0byB0aGUgYnJvd3NlciB3aW5kb3cuPC9iPgogICAgICogQHBhcmFtIHtBcnJheX0gYXJncyAob3B0aW9uYWwpIE92ZXJyaWRlcyBhcmd1bWVudHMgZm9yIHRoZSBjYWxsLiAoRGVmYXVsdHMgdG8gdGhlIGFyZ3VtZW50cyBwYXNzZWQgYnkgdGhlIGNhbGxlcikKICAgICAqIEBwYXJhbSB7Qm9vbGVhbi9OdW1iZXJ9IGFwcGVuZEFyZ3MgKG9wdGlvbmFsKSBpZiBUcnVlIGFyZ3MgYXJlIGFwcGVuZGVkIHRvIGNhbGwgYXJncyBpbnN0ZWFkIG9mIG92ZXJyaWRpbmcsCiAgICAgKiBpZiBhIG51bWJlciB0aGUgYXJncyBhcmUgaW5zZXJ0ZWQgYXQgdGhlIHNwZWNpZmllZCBwb3NpdGlvbgogICAgICogQHJldHVybiB7TnVtYmVyfSBUaGUgdGltZW91dCBpZCB0aGF0IGNhbiBiZSB1c2VkIHdpdGggY2xlYXJUaW1lb3V0CiAgICAgKi8KICAgIGRlZmVyOiBmdW5jdGlvbihmbiwgbWlsbGlzLCBvYmosIGFyZ3MsIGFwcGVuZEFyZ3MpIHsKICAgICAgICBmbiA9IEV4dC51dGlsLkZ1bmN0aW9ucy5jcmVhdGVEZWxlZ2F0ZShmbiwgb2JqLCBhcmdzLCBhcHBlbmRBcmdzKTsKICAgICAgICBpZiAobWlsbGlzID4gMCkgewogICAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChmbiwgbWlsbGlzKTsKICAgICAgICB9CiAgICAgICAgZm4oKTsKICAgICAgICByZXR1cm4gMDsKICAgIH0sCgoKICAgIC8qKgogICAgICogQ3JlYXRlIGEgY29tYmluZWQgZnVuY3Rpb24gY2FsbCBzZXF1ZW5jZSBvZiB0aGUgb3JpZ2luYWwgZnVuY3Rpb24gKyB0aGUgcGFzc2VkIGZ1bmN0aW9uLgogICAgICogVGhlIHJlc3VsdGluZyBmdW5jdGlvbiByZXR1cm5zIHRoZSByZXN1bHRzIG9mIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICAgICAqIFRoZSBwYXNzZWQgZmNuIGlzIGNhbGxlZCB3aXRoIHRoZSBwYXJhbWV0ZXJzIG9mIHRoZSBvcmlnaW5hbCBmdW5jdGlvbi4gRXhhbXBsZSB1c2FnZToKICAgICAqIAoKdmFyIHNheUhpID0gZnVuY3Rpb24obmFtZSl7CiAgICBhbGVydCgnSGksICcgKyBuYW1lKTsKfQoKc2F5SGkoJ0ZyZWQnKTsgLy8gYWxlcnRzICJIaSwgRnJlZCIKCnZhciBzYXlHb29kYnllID0gRXh0LmNyZWF0ZVNlcXVlbmNlKHNheUhpLCBmdW5jdGlvbihuYW1lKXsKICAgIGFsZXJ0KCdCeWUsICcgKyBuYW1lKTsKfSk7CgpzYXlHb29kYnllKCdGcmVkJyk7IC8vIGJvdGggYWxlcnRzIHNob3cKCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBvcmlnRm4gVGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gbmV3Rm4gVGhlIGZ1bmN0aW9uIHRvIHNlcXVlbmNlCiAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NvcGUgKG9wdGlvbmFsKSBUaGUgc2NvcGUgKHRoaXMgcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUgcGFzc2VkIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICogSWYgb21pdHRlZCwgZGVmYXVsdHMgdG8gdGhlIHNjb3BlIGluIHdoaWNoIHRoZSBvcmlnaW5hbCBmdW5jdGlvbiBpcyBjYWxsZWQgb3IgdGhlIGJyb3dzZXIgd2luZG93LgogICAgICogQHJldHVybiB7RnVuY3Rpb259IFRoZSBuZXcgZnVuY3Rpb24KICAgICAqLwogICAgY3JlYXRlU2VxdWVuY2U6IGZ1bmN0aW9uKG9yaWdGbiwgbmV3Rm4sIHNjb3BlKSB7CiAgICAgICAgaWYgKCFFeHQuaXNGdW5jdGlvbihuZXdGbikpIHsKICAgICAgICAgICAgcmV0dXJuIG9yaWdGbjsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciByZXR2YWwgPSBvcmlnRm4uYXBwbHkodGhpcyB8fCB3aW5kb3csIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICBuZXdGbi5hcHBseShzY29wZSB8fCB0aGlzIHx8IHdpbmRvdywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIHJldHVybiByZXR2YWw7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfQp9OwoKLyoqCiAqIFNob3J0aGFuZCBmb3Ige0BsaW5rIEV4dC51dGlsLkZ1bmN0aW9ucyNkZWZlcn0gICAKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIGRlZmVyLgogKiBAcGFyYW0ge051bWJlcn0gbWlsbGlzIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGZvciB0aGUgc2V0VGltZW91dCBjYWxsIChpZiBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gMCB0aGUgZnVuY3Rpb24gaXMgZXhlY3V0ZWQgaW1tZWRpYXRlbHkpCiAqIEBwYXJhbSB7T2JqZWN0fSBzY29wZSAob3B0aW9uYWwpIFRoZSBzY29wZSAoPGNvZGU+PGI+dGhpczwvYj48L2NvZGU+IHJlZmVyZW5jZSkgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogKiA8Yj5JZiBvbWl0dGVkLCBkZWZhdWx0cyB0byB0aGUgYnJvd3NlciB3aW5kb3cuPC9iPgogKiBAcGFyYW0ge0FycmF5fSBhcmdzIChvcHRpb25hbCkgT3ZlcnJpZGVzIGFyZ3VtZW50cyBmb3IgdGhlIGNhbGwuIChEZWZhdWx0cyB0byB0aGUgYXJndW1lbnRzIHBhc3NlZCBieSB0aGUgY2FsbGVyKQogKiBAcGFyYW0ge0Jvb2xlYW4vTnVtYmVyfSBhcHBlbmRBcmdzIChvcHRpb25hbCkgaWYgVHJ1ZSBhcmdzIGFyZSBhcHBlbmRlZCB0byBjYWxsIGFyZ3MgaW5zdGVhZCBvZiBvdmVycmlkaW5nLAogKiBpZiBhIG51bWJlciB0aGUgYXJncyBhcmUgaW5zZXJ0ZWQgYXQgdGhlIHNwZWNpZmllZCBwb3NpdGlvbgogKiBAcmV0dXJuIHtOdW1iZXJ9IFRoZSB0aW1lb3V0IGlkIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBjbGVhclRpbWVvdXQKICogQG1lbWJlciBFeHQKICogQG1ldGhvZCBkZWZlcgogKi8KCkV4dC5kZWZlciA9IEV4dC51dGlsLkZ1bmN0aW9ucy5kZWZlcjsKCi8qKgogKiBTaG9ydGhhbmQgZm9yIHtAbGluayBFeHQudXRpbC5GdW5jdGlvbnMjY3JlYXRlSW50ZXJjZXB0b3J9ICAgCiAqIEBwYXJhbSB7RnVuY3Rpb259IG9yaWdGbiBUaGUgb3JpZ2luYWwgZnVuY3Rpb24uCiAqIEBwYXJhbSB7RnVuY3Rpb259IG5ld0ZuIFRoZSBmdW5jdGlvbiB0byBjYWxsIGJlZm9yZSB0aGUgb3JpZ2luYWwKICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIChvcHRpb25hbCkgVGhlIHNjb3BlICg8Y29kZT48Yj50aGlzPC9iPjwvY29kZT4gcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUgcGFzc2VkIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogKiA8Yj5JZiBvbWl0dGVkLCBkZWZhdWx0cyB0byB0aGUgc2NvcGUgaW4gd2hpY2ggdGhlIG9yaWdpbmFsIGZ1bmN0aW9uIGlzIGNhbGxlZCBvciB0aGUgYnJvd3NlciB3aW5kb3cuPC9iPgogKiBAcmV0dXJuIHtGdW5jdGlvbn0gVGhlIG5ldyBmdW5jdGlvbgogKiBAbWVtYmVyIEV4dAogKiBAbWV0aG9kIGRlZmVyCiAqLwoKRXh0LmNyZWF0ZUludGVyY2VwdG9yID0gRXh0LnV0aWwuRnVuY3Rpb25zLmNyZWF0ZUludGVyY2VwdG9yOwoKLyoqCiAqIFNob3J0aGFuZCBmb3Ige0BsaW5rIEV4dC51dGlsLkZ1bmN0aW9ucyNjcmVhdGVTZXF1ZW5jZX0KICogQHBhcmFtIHtGdW5jdGlvbn0gb3JpZ0ZuIFRoZSBvcmlnaW5hbCBmdW5jdGlvbi4KICogQHBhcmFtIHtGdW5jdGlvbn0gbmV3Rm4gVGhlIGZ1bmN0aW9uIHRvIHNlcXVlbmNlCiAqIEBwYXJhbSB7T2JqZWN0fSBzY29wZSAob3B0aW9uYWwpIFRoZSBzY29wZSAodGhpcyByZWZlcmVuY2UpIGluIHdoaWNoIHRoZSBwYXNzZWQgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAqIElmIG9taXR0ZWQsIGRlZmF1bHRzIHRvIHRoZSBzY29wZSBpbiB3aGljaCB0aGUgb3JpZ2luYWwgZnVuY3Rpb24gaXMgY2FsbGVkIG9yIHRoZSBicm93c2VyIHdpbmRvdy4KICogQHJldHVybiB7RnVuY3Rpb259IFRoZSBuZXcgZnVuY3Rpb24KICogQG1lbWJlciBFeHQKICogQG1ldGhvZCBkZWZlcgogKi8KCkV4dC5jcmVhdGVTZXF1ZW5jZSA9IEV4dC51dGlsLkZ1bmN0aW9ucy5jcmVhdGVTZXF1ZW5jZTsKCi8qKgogKiBTaG9ydGhhbmQgZm9yIHtAbGluayBFeHQudXRpbC5GdW5jdGlvbnMjY3JlYXRlRGVsZWdhdGV9CiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBkZWxlZ2F0ZS4KICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIChvcHRpb25hbCkgVGhlIHNjb3BlICg8Y29kZT48Yj50aGlzPC9iPjwvY29kZT4gcmVmZXJlbmNlKSBpbiB3aGljaCB0aGUgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAqIDxiPklmIG9taXR0ZWQsIGRlZmF1bHRzIHRvIHRoZSBicm93c2VyIHdpbmRvdy48L2I+CiAqIEBwYXJhbSB7QXJyYXl9IGFyZ3MgKG9wdGlvbmFsKSBPdmVycmlkZXMgYXJndW1lbnRzIGZvciB0aGUgY2FsbC4gKERlZmF1bHRzIHRvIHRoZSBhcmd1bWVudHMgcGFzc2VkIGJ5IHRoZSBjYWxsZXIpCiAqIEBwYXJhbSB7Qm9vbGVhbi9OdW1iZXJ9IGFwcGVuZEFyZ3MgKG9wdGlvbmFsKSBpZiBUcnVlIGFyZ3MgYXJlIGFwcGVuZGVkIHRvIGNhbGwgYXJncyBpbnN0ZWFkIG9mIG92ZXJyaWRpbmcsCiAqIGlmIGEgbnVtYmVyIHRoZSBhcmdzIGFyZSBpbnNlcnRlZCBhdCB0aGUgc3BlY2lmaWVkIHBvc2l0aW9uCiAqIEByZXR1cm4ge0Z1bmN0aW9ufSBUaGUgbmV3IGZ1bmN0aW9uCiAqIEBtZW1iZXIgRXh0CiAqIEBtZXRob2QgZGVmZXIKICovCkV4dC5jcmVhdGVEZWxlZ2F0ZSA9IEV4dC51dGlsLkZ1bmN0aW9ucy5jcmVhdGVEZWxlZ2F0ZTsKLyoqCiAqIEBjbGFzcyBFeHQudXRpbC5PYnNlcnZhYmxlCiAqLwpFeHQuYXBwbHkoRXh0LnV0aWwuT2JzZXJ2YWJsZS5wcm90b3R5cGUsIGZ1bmN0aW9uKCl7CiAgICAvLyB0aGlzIGlzIGNvbnNpZGVyZWQgZXhwZXJpbWVudGFsIChhbG9uZyB3aXRoIGJlZm9yZU1ldGhvZCwgYWZ0ZXJNZXRob2QsIHJlbW92ZU1ldGhvZExpc3RlbmVyPykKICAgIC8vIGFsbG93cyBmb3IgZWFzaWVyIGludGVyY2VwdG9yIGFuZCBzZXF1ZW5jZXMsIGluY2x1ZGluZyBjYW5jZWxsaW5nIGFuZCBvdmVyd3JpdGluZyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBjYWxsCiAgICAvLyBwcml2YXRlCiAgICBmdW5jdGlvbiBnZXRNZXRob2RFdmVudChtZXRob2QpewogICAgICAgIHZhciBlID0gKHRoaXMubWV0aG9kRXZlbnRzID0gdGhpcy5tZXRob2RFdmVudHMgfHwKICAgICAgICB7fSlbbWV0aG9kXSwgcmV0dXJuVmFsdWUsIHYsIGNhbmNlbCwgb2JqID0gdGhpczsKCiAgICAgICAgaWYgKCFlKSB7CiAgICAgICAgICAgIHRoaXMubWV0aG9kRXZlbnRzW21ldGhvZF0gPSBlID0ge307CiAgICAgICAgICAgIGUub3JpZ2luYWxGbiA9IHRoaXNbbWV0aG9kXTsKICAgICAgICAgICAgZS5tZXRob2ROYW1lID0gbWV0aG9kOwogICAgICAgICAgICBlLmJlZm9yZSA9IFtdOwogICAgICAgICAgICBlLmFmdGVyID0gW107CgogICAgICAgICAgICB2YXIgbWFrZUNhbGwgPSBmdW5jdGlvbihmbiwgc2NvcGUsIGFyZ3MpewogICAgICAgICAgICAgICAgaWYoKHYgPSBmbi5hcHBseShzY29wZSB8fCBvYmosIGFyZ3MpKSAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHYgPT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodi5yZXR1cm5WYWx1ZSAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblZhbHVlID0gdi5yZXR1cm5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5WYWx1ZSA9IHY7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2FuY2VsID0gISF2LmNhbmNlbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodiA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbmNlbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5WYWx1ZSA9IHY7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXNbbWV0aG9kXSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCksCiAgICAgICAgICAgICAgICAgICAgYjsKICAgICAgICAgICAgICAgIHJldHVyblZhbHVlID0gdiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGNhbmNlbCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGUuYmVmb3JlLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBiID0gZS5iZWZvcmVbaV07CiAgICAgICAgICAgICAgICAgICAgbWFrZUNhbGwoYi5mbiwgYi5zY29wZSwgYXJncyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbmNlbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKCh2ID0gZS5vcmlnaW5hbEZuLmFwcGx5KG9iaiwgYXJncykpICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgICAgIHJldHVyblZhbHVlID0gdjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBlLmFmdGVyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBiID0gZS5hZnRlcltpXTsKICAgICAgICAgICAgICAgICAgICBtYWtlQ2FsbChiLmZuLCBiLnNjb3BlLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2FuY2VsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5WYWx1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBlOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgLy8gdGhlc2UgYXJlIGNvbnNpZGVyZWQgZXhwZXJpbWVudGFsCiAgICAgICAgLy8gYWxsb3dzIGZvciBlYXNpZXIgaW50ZXJjZXB0b3IgYW5kIHNlcXVlbmNlcywgaW5jbHVkaW5nIGNhbmNlbGxpbmcgYW5kIG92ZXJ3cml0aW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGNhbGwKICAgICAgICAvLyBhZGRzIGFuICdpbnRlcmNlcHRvcicgY2FsbGVkIGJlZm9yZSB0aGUgb3JpZ2luYWwgbWV0aG9kCiAgICAgICAgYmVmb3JlTWV0aG9kIDogZnVuY3Rpb24obWV0aG9kLCBmbiwgc2NvcGUpewogICAgICAgICAgICBnZXRNZXRob2RFdmVudC5jYWxsKHRoaXMsIG1ldGhvZCkuYmVmb3JlLnB1c2goewogICAgICAgICAgICAgICAgZm46IGZuLAogICAgICAgICAgICAgICAgc2NvcGU6IHNjb3BlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8vIGFkZHMgYSAnc2VxdWVuY2UnIGNhbGxlZCBhZnRlciB0aGUgb3JpZ2luYWwgbWV0aG9kCiAgICAgICAgYWZ0ZXJNZXRob2QgOiBmdW5jdGlvbihtZXRob2QsIGZuLCBzY29wZSl7CiAgICAgICAgICAgIGdldE1ldGhvZEV2ZW50LmNhbGwodGhpcywgbWV0aG9kKS5hZnRlci5wdXNoKHsKICAgICAgICAgICAgICAgIGZuOiBmbiwKICAgICAgICAgICAgICAgIHNjb3BlOiBzY29wZQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVNZXRob2RMaXN0ZW5lcjogZnVuY3Rpb24obWV0aG9kLCBmbiwgc2NvcGUpewogICAgICAgICAgICB2YXIgZSA9IHRoaXMuZ2V0TWV0aG9kRXZlbnQobWV0aG9kKTsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gZS5iZWZvcmUubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgaWYoZS5iZWZvcmVbaV0uZm4gPT0gZm4gJiYgZS5iZWZvcmVbaV0uc2NvcGUgPT0gc2NvcGUpewogICAgICAgICAgICAgICAgICAgIGUuYmVmb3JlLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gZS5hZnRlci5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICBpZihlLmFmdGVyW2ldLmZuID09IGZuICYmIGUuYWZ0ZXJbaV0uc2NvcGUgPT0gc2NvcGUpewogICAgICAgICAgICAgICAgICAgIGUuYWZ0ZXIuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlbGF5cyBzZWxlY3RlZCBldmVudHMgZnJvbSB0aGUgc3BlY2lmaWVkIE9ic2VydmFibGUgYXMgaWYgdGhlIGV2ZW50cyB3ZXJlIGZpcmVkIGJ5IDx0dD48Yj50aGlzPC9iPjwvdHQ+LgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvIFRoZSBPYnNlcnZhYmxlIHdob3NlIGV2ZW50cyB0aGlzIG9iamVjdCBpcyB0byByZWxheS4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBldmVudHMgQXJyYXkgb2YgZXZlbnQgbmFtZXMgdG8gcmVsYXkuCiAgICAgICAgICovCiAgICAgICAgcmVsYXlFdmVudHMgOiBmdW5jdGlvbihvLCBldmVudHMpewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVIYW5kbGVyKGVuYW1lKXsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIHJldHVybiBtZS5maXJlRXZlbnQuYXBwbHkobWUsIFtlbmFtZV0uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gZXZlbnRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIHZhciBlbmFtZSA9IGV2ZW50c1tpXTsKICAgICAgICAgICAgICAgIG1lLmV2ZW50c1tlbmFtZV0gPSBtZS5ldmVudHNbZW5hbWVdIHx8IHRydWU7CiAgICAgICAgICAgICAgICBvLm9uKGVuYW1lLCBjcmVhdGVIYW5kbGVyKGVuYW1lKSwgbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogPHA+RW5hYmxlcyBldmVudHMgZmlyZWQgYnkgdGhpcyBPYnNlcnZhYmxlIHRvIGJ1YmJsZSB1cCBhbiBvd25lciBoaWVyYXJjaHkgYnkgY2FsbGluZwogICAgICAgICAqIDxjb2RlPnRoaXMuZ2V0QnViYmxlVGFyZ2V0KCk8L2NvZGU+IGlmIHByZXNlbnQuIFRoZXJlIGlzIG5vIGltcGxlbWVudGF0aW9uIGluIHRoZSBPYnNlcnZhYmxlIGJhc2UgY2xhc3MuPC9wPgogICAgICAgICAqIDxwPlRoaXMgaXMgY29tbW9ubHkgdXNlZCBieSBFeHQuQ29tcG9uZW50cyB0byBidWJibGUgZXZlbnRzIHRvIG93bmVyIENvbnRhaW5lcnMuIFNlZSB7QGxpbmsgRXh0LkNvbXBvbmVudC5nZXRCdWJibGVUYXJnZXR9LiBUaGUgZGVmYXVsdAogICAgICAgICAqIGltcGxlbWVudGF0aW9uIGluIEV4dC5Db21wb25lbnQgcmV0dXJucyB0aGUgQ29tcG9uZW50J3MgaW1tZWRpYXRlIG93bmVyLiBCdXQgaWYgYSBrbm93biB0YXJnZXQgaXMgcmVxdWlyZWQsIHRoaXMgY2FuIGJlIG92ZXJyaWRkZW4gdG8KICAgICAgICAgKiBhY2Nlc3MgdGhlIHJlcXVpcmVkIHRhcmdldCBtb3JlIHF1aWNrbHkuPC9wPgogICAgICAgICAqIDxwPkV4YW1wbGU6PC9wPjxwcmU+PGNvZGU+CkV4dC5vdmVycmlkZShFeHQuZm9ybS5GaWVsZCwgewogICAgCiAgICBpbml0Q29tcG9uZW50IDogRXh0LmZvcm0uRmllbGQucHJvdG90eXBlLmluaXRDb21wb25lbnQuY3JlYXRlU2VxdWVuY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5lbmFibGVCdWJibGUoJ2NoYW5nZScpOwogICAgfSksCgogICAgCiAgICBnZXRCdWJibGVUYXJnZXQgOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuZm9ybVBhbmVsKSB7CiAgICAgICAgICAgIHRoaXMuZm9ybVBhbmVsID0gdGhpcy5maW5kUGFyZW50QnlUeXBlKCdmb3JtJyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmZvcm1QYW5lbDsKICAgIH0KfSk7Cgp2YXIgbXlGb3JtID0gbmV3IEV4dC5mb3JtUGFuZWwoewogICAgdGl0bGU6ICdVc2VyIERldGFpbHMnLAogICAgaXRlbXM6IFt7CiAgICAgICAgLi4uCiAgICB9XSwKICAgIGxpc3RlbmVyczogewogICAgICAgIGNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBteUZvcm0uaGVhZGVyLnNldFN0eWxlKCdjb2xvcicsICdyZWQnKTsKICAgICAgICB9CiAgICB9Cn0pOwo8L2NvZGU+PC9wcmU+CiAgICAgICAgICogQHBhcmFtIHtTdHJpbmcvQXJyYXl9IGV2ZW50cyBUaGUgZXZlbnQgbmFtZSB0byBidWJibGUsIG9yIGFuIEFycmF5IG9mIGV2ZW50IG5hbWVzLgogICAgICAgICAqLwogICAgICAgIGVuYWJsZUJ1YmJsZSA6IGZ1bmN0aW9uKGV2ZW50cyl7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgICAgIGlmKCFFeHQuaXNFbXB0eShldmVudHMpKXsKICAgICAgICAgICAgICAgIGV2ZW50cyA9IEV4dC5pc0FycmF5KGV2ZW50cykgPyBldmVudHMgOiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gZXZlbnRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB2YXIgZW5hbWUgPSBldmVudHNbaV07CiAgICAgICAgICAgICAgICAgICAgZW5hbWUgPSBlbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIHZhciBjZSA9IG1lLmV2ZW50c1tlbmFtZV0gfHwgdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNlID09ICdib29sZWFuJykgewogICAgICAgICAgICAgICAgICAgICAgICBjZSA9IG5ldyBFeHQudXRpbC5FdmVudChtZSwgZW5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBtZS5ldmVudHNbZW5hbWVdID0gY2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNlLmJ1YmJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KCkpOwoKCgpFeHQudXRpbC5PYnNlcnZhYmxlLmNhcHR1cmUgPSBmdW5jdGlvbihvLCBmbiwgc2NvcGUpewogICAgby5maXJlRXZlbnQgPSBvLmZpcmVFdmVudC5jcmVhdGVJbnRlcmNlcHRvcihmbiwgc2NvcGUpOwp9OwoKCgpFeHQudXRpbC5PYnNlcnZhYmxlLm9ic2VydmVDbGFzcyA9IGZ1bmN0aW9uKGMsIGxpc3RlbmVycyl7CiAgICBpZihjKXsKICAgICAgaWYoIWMuZmlyZUV2ZW50KXsKICAgICAgICAgIEV4dC5hcHBseShjLCBuZXcgRXh0LnV0aWwuT2JzZXJ2YWJsZSgpKTsKICAgICAgICAgIEV4dC51dGlsLk9ic2VydmFibGUuY2FwdHVyZShjLnByb3RvdHlwZSwgYy5maXJlRXZlbnQsIGMpOwogICAgICB9CiAgICAgIGlmKHR5cGVvZiBsaXN0ZW5lcnMgPT0gJ29iamVjdCcpewogICAgICAgICAgYy5vbihsaXN0ZW5lcnMpOwogICAgICB9CiAgICAgIHJldHVybiBjOwogICB9Cn07CgpFeHQuYXBwbHkoRXh0LkV2ZW50TWFuYWdlciwgZnVuY3Rpb24oKXsKICAgdmFyIHJlc2l6ZUV2ZW50LAogICAgICAgcmVzaXplVGFzaywKICAgICAgIHRleHRFdmVudCwKICAgICAgIHRleHRTaXplLAogICAgICAgRCA9IEV4dC5saWIuRG9tLAogICAgICAgcHJvcFJlID0gL14oPzpzY29wZXxkZWxheXxidWZmZXJ8c2luZ2xlfHN0b3BFdmVudHxwcmV2ZW50RGVmYXVsdHxzdG9wUHJvcGFnYXRpb258bm9ybWFsaXplZHxhcmdzfGRlbGVnYXRlKSQvLAogICAgICAgdW5sb2FkID0gRXh0LkV2ZW50TWFuYWdlci5fdW5sb2FkLAogICAgICAgY3VyV2lkdGggPSAwLAogICAgICAgY3VySGVpZ2h0ID0gMCwKICAgICAgIAogICAgICAgCiAgICAgICAKICAgICAgIHVzZUtleWRvd24gPSBFeHQuaXNXZWJLaXQgPwogICAgICAgICAgICAgICAgICAgRXh0Lm51bShuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9BcHBsZVdlYktpdFwvKFxkKykvKVsxXSkgPj0gNTI1IDoKICAgICAgICAgICAgICAgICAgICEoKEV4dC5pc0dlY2tvICYmICFFeHQuaXNXaW5kb3dzKSB8fCBFeHQuaXNPcGVyYSk7CgogICByZXR1cm4gewogICAgICAgX3VubG9hZDogZnVuY3Rpb24oKXsKICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLnVuKHdpbmRvdywgInJlc2l6ZSIsIHRoaXMuZmlyZVdpbmRvd1Jlc2l6ZSwgdGhpcyk7CiAgICAgICAgICAgdW5sb2FkLmNhbGwoRXh0LkV2ZW50TWFuYWdlcik7ICAgIAogICAgICAgfSwKICAgICAgIAogICAgICAgCiAgICAgICBkb1Jlc2l6ZUV2ZW50OiBmdW5jdGlvbigpewogICAgICAgICAgIHZhciBoID0gRC5nZXRWaWV3SGVpZ2h0KCksCiAgICAgICAgICAgICAgIHcgPSBELmdldFZpZXdXaWR0aCgpOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKGN1ckhlaWdodCAhPSBoIHx8IGN1cldpZHRoICE9IHcpewogICAgICAgICAgICAgICByZXNpemVFdmVudC5maXJlKGN1cldpZHRoID0gdywgY3VySGVpZ2h0ID0gaCk7CiAgICAgICAgICAgIH0KICAgICAgIH0sCgogICAgICAgCiAgICAgICBvbldpbmRvd1Jlc2l6ZSA6IGZ1bmN0aW9uKGZuLCBzY29wZSwgb3B0aW9ucyl7CiAgICAgICAgICAgaWYoIXJlc2l6ZUV2ZW50KXsKICAgICAgICAgICAgICAgcmVzaXplRXZlbnQgPSBuZXcgRXh0LnV0aWwuRXZlbnQoKTsKICAgICAgICAgICAgICAgcmVzaXplVGFzayA9IG5ldyBFeHQudXRpbC5EZWxheWVkVGFzayh0aGlzLmRvUmVzaXplRXZlbnQpOwogICAgICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLm9uKHdpbmRvdywgInJlc2l6ZSIsIHRoaXMuZmlyZVdpbmRvd1Jlc2l6ZSwgdGhpcyk7CiAgICAgICAgICAgfQogICAgICAgICAgIHJlc2l6ZUV2ZW50LmFkZExpc3RlbmVyKGZuLCBzY29wZSwgb3B0aW9ucyk7CiAgICAgICB9LAoKICAgICAgIAogICAgICAgZmlyZVdpbmRvd1Jlc2l6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgaWYocmVzaXplRXZlbnQpewogICAgICAgICAgICAgICByZXNpemVUYXNrLmRlbGF5KDEwMCk7CiAgICAgICAgICAgfQogICAgICAgfSwKCiAgICAgICAKICAgICAgIG9uVGV4dFJlc2l6ZSA6IGZ1bmN0aW9uKGZuLCBzY29wZSwgb3B0aW9ucyl7CiAgICAgICAgICAgaWYoIXRleHRFdmVudCl7CiAgICAgICAgICAgICAgIHRleHRFdmVudCA9IG5ldyBFeHQudXRpbC5FdmVudCgpOwogICAgICAgICAgICAgICB2YXIgdGV4dEVsID0gbmV3IEV4dC5FbGVtZW50KGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKTsKICAgICAgICAgICAgICAgdGV4dEVsLmRvbS5jbGFzc05hbWUgPSAneC10ZXh0LXJlc2l6ZSc7CiAgICAgICAgICAgICAgIHRleHRFbC5kb20uaW5uZXJIVE1MID0gJ1gnOwogICAgICAgICAgICAgICB0ZXh0RWwuYXBwZW5kVG8oZG9jdW1lbnQuYm9keSk7CiAgICAgICAgICAgICAgIHRleHRTaXplID0gdGV4dEVsLmRvbS5vZmZzZXRIZWlnaHQ7CiAgICAgICAgICAgICAgIHNldEludGVydmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICBpZih0ZXh0RWwuZG9tLm9mZnNldEhlaWdodCAhPSB0ZXh0U2l6ZSl7CiAgICAgICAgICAgICAgICAgICAgICAgdGV4dEV2ZW50LmZpcmUodGV4dFNpemUsIHRleHRTaXplID0gdGV4dEVsLmRvbS5vZmZzZXRIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICB9LCB0aGlzLnRleHRSZXNpemVJbnRlcnZhbCk7CiAgICAgICAgICAgfQogICAgICAgICAgIHRleHRFdmVudC5hZGRMaXN0ZW5lcihmbiwgc2NvcGUsIG9wdGlvbnMpOwogICAgICAgfSwKCiAgICAgICAKICAgICAgIHJlbW92ZVJlc2l6ZUxpc3RlbmVyIDogZnVuY3Rpb24oZm4sIHNjb3BlKXsKICAgICAgICAgICBpZihyZXNpemVFdmVudCl7CiAgICAgICAgICAgICAgIHJlc2l6ZUV2ZW50LnJlbW92ZUxpc3RlbmVyKGZuLCBzY29wZSk7CiAgICAgICAgICAgfQogICAgICAgfSwKCiAgICAgICAKICAgICAgIGZpcmVSZXNpemUgOiBmdW5jdGlvbigpewogICAgICAgICAgIGlmKHJlc2l6ZUV2ZW50KXsKICAgICAgICAgICAgICAgcmVzaXplRXZlbnQuZmlyZShELmdldFZpZXdXaWR0aCgpLCBELmdldFZpZXdIZWlnaHQoKSk7CiAgICAgICAgICAgfQogICAgICAgfSwKCiAgICAgICAgCiAgICAgICB0ZXh0UmVzaXplSW50ZXJ2YWwgOiA1MCwKCiAgICAgICAKICAgICAgIGllRGVmZXJTcmMgOiBmYWxzZSwKICAgICAgIAogICAgICAgCiAgICAgICBnZXRLZXlFdmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgcmV0dXJuIHVzZUtleWRvd24gPyAna2V5ZG93bicgOiAna2V5cHJlc3MnOwogICAgICAgfSwKCiAgICAgICAKICAgICAgIAogICAgICAgdXNlS2V5ZG93bjogdXNlS2V5ZG93bgogICB9Owp9KCkpOwoKRXh0LkV2ZW50TWFuYWdlci5vbiA9IEV4dC5FdmVudE1hbmFnZXIuYWRkTGlzdGVuZXI7CgoKRXh0LmFwcGx5KEV4dC5FdmVudE9iamVjdEltcGwucHJvdG90eXBlLCB7CiAgIAogICBCQUNLU1BBQ0U6IDgsCiAgIAogICBUQUI6IDksCiAgIAogICBOVU1fQ0VOVEVSOiAxMiwKICAgCiAgIEVOVEVSOiAxMywKICAgCiAgIFJFVFVSTjogMTMsCiAgIAogICBTSElGVDogMTYsCiAgIAogICBDVFJMOiAxNywKICAgQ09OVFJPTCA6IDE3LCAKICAgCiAgIEFMVDogMTgsCiAgIAogICBQQVVTRTogMTksCiAgIAogICBDQVBTX0xPQ0s6IDIwLAogICAKICAgRVNDOiAyNywKICAgCiAgIFNQQUNFOiAzMiwKICAgCiAgIFBBR0VfVVA6IDMzLAogICBQQUdFVVAgOiAzMywgCiAgIAogICBQQUdFX0RPV046IDM0LAogICBQQUdFRE9XTiA6IDM0LCAKICAgCiAgIEVORDogMzUsCiAgIAogICBIT01FOiAzNiwKICAgCiAgIExFRlQ6IDM3LAogICAKICAgVVA6IDM4LAogICAKICAgUklHSFQ6IDM5LAogICAKICAgRE9XTjogNDAsCiAgIAogICBQUklOVF9TQ1JFRU46IDQ0LAogICAKICAgSU5TRVJUOiA0NSwKICAgCiAgIERFTEVURTogNDYsCiAgIAogICBaRVJPOiA0OCwKICAgCiAgIE9ORTogNDksCiAgIAogICBUV086IDUwLAogICAKICAgVEhSRUU6IDUxLAogICAKICAgRk9VUjogNTIsCiAgIAogICBGSVZFOiA1MywKICAgCiAgIFNJWDogNTQsCiAgIAogICBTRVZFTjogNTUsCiAgIAogICBFSUdIVDogNTYsCiAgIAogICBOSU5FOiA1NywKICAgCiAgIEE6IDY1LAogICAKICAgQjogNjYsCiAgIAogICBDOiA2NywKICAgCiAgIEQ6IDY4LAogICAKICAgRTogNjksCiAgIAogICBGOiA3MCwKICAgCiAgIEc6IDcxLAogICAKICAgSDogNzIsCiAgIAogICBJOiA3MywKICAgCiAgIEo6IDc0LAogICAKICAgSzogNzUsCiAgIAogICBMOiA3NiwKICAgCiAgIE06IDc3LAogICAKICAgTjogNzgsCiAgIAogICBPOiA3OSwKICAgCiAgIFA6IDgwLAogICAKICAgUTogODEsCiAgIAogICBSOiA4MiwKICAgCiAgIFM6IDgzLAogICAKICAgVDogODQsCiAgIAogICBVOiA4NSwKICAgCiAgIFY6IDg2LAogICAKICAgVzogODcsCiAgIAogICBYOiA4OCwKICAgCiAgIFk6IDg5LAogICAKICAgWjogOTAsCiAgIAogICBDT05URVhUX01FTlU6IDkzLAogICAKICAgTlVNX1pFUk86IDk2LAogICAKICAgTlVNX09ORTogOTcsCiAgIAogICBOVU1fVFdPOiA5OCwKICAgCiAgIE5VTV9USFJFRTogOTksCiAgIAogICBOVU1fRk9VUjogMTAwLAogICAKICAgTlVNX0ZJVkU6IDEwMSwKICAgCiAgIE5VTV9TSVg6IDEwMiwKICAgCiAgIE5VTV9TRVZFTjogMTAzLAogICAKICAgTlVNX0VJR0hUOiAxMDQsCiAgIAogICBOVU1fTklORTogMTA1LAogICAKICAgTlVNX01VTFRJUExZOiAxMDYsCiAgIAogICBOVU1fUExVUzogMTA3LAogICAKICAgTlVNX01JTlVTOiAxMDksCiAgIAogICBOVU1fUEVSSU9EOiAxMTAsCiAgIAogICBOVU1fRElWSVNJT046IDExMSwKICAgCiAgIEYxOiAxMTIsCiAgIAogICBGMjogMTEzLAogICAKICAgRjM6IDExNCwKICAgCiAgIEY0OiAxMTUsCiAgIAogICBGNTogMTE2LAogICAKICAgRjY6IDExNywKICAgCiAgIEY3OiAxMTgsCiAgIAogICBGODogMTE5LAogICAKICAgRjk6IDEyMCwKICAgCiAgIEYxMDogMTIxLAogICAKICAgRjExOiAxMjIsCiAgIAogICBGMTI6IDEyMywKCiAgIAogICBpc05hdktleVByZXNzIDogZnVuY3Rpb24oKXsKICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgayA9IHRoaXMubm9ybWFsaXplS2V5KG1lLmtleUNvZGUpOwogICAgICAgcmV0dXJuIChrID49IDMzICYmIGsgPD0gNDApIHx8ICAKICAgICAgIGsgPT0gbWUuUkVUVVJOIHx8CiAgICAgICBrID09IG1lLlRBQiB8fAogICAgICAgayA9PSBtZS5FU0M7CiAgIH0sCgogICBpc1NwZWNpYWxLZXkgOiBmdW5jdGlvbigpewogICAgICAgdmFyIGsgPSB0aGlzLm5vcm1hbGl6ZUtleSh0aGlzLmtleUNvZGUpOwogICAgICAgcmV0dXJuICh0aGlzLnR5cGUgPT0gJ2tleXByZXNzJyAmJiB0aGlzLmN0cmxLZXkpIHx8CiAgICAgICB0aGlzLmlzTmF2S2V5UHJlc3MoKSB8fAogICAgICAgKGsgPT0gdGhpcy5CQUNLU1BBQ0UpIHx8IAogICAgICAgKGsgPj0gMTYgJiYgayA8PSAyMCkgfHwgCiAgICAgICAoayA+PSA0NCAmJiBrIDw9IDQ2KTsgICAKICAgfSwKCiAgIGdldFBvaW50IDogZnVuY3Rpb24oKXsKICAgICAgIHJldHVybiBuZXcgRXh0LmxpYi5Qb2ludCh0aGlzLnh5WzBdLCB0aGlzLnh5WzFdKTsKICAgfSwKCiAgIAogICBoYXNNb2RpZmllciA6IGZ1bmN0aW9uKCl7CiAgICAgICByZXR1cm4gKCh0aGlzLmN0cmxLZXkgfHwgdGhpcy5hbHRLZXkpIHx8IHRoaXMuc2hpZnRLZXkpOwogICB9Cn0pOwpFeHQuRWxlbWVudC5hZGRNZXRob2RzKHsKICAgIAogICAgc3dhbGxvd0V2ZW50IDogZnVuY3Rpb24oZXZlbnROYW1lLCBwcmV2ZW50RGVmYXVsdCkgewogICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgZnVuY3Rpb24gZm4oZSkgewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICBpZiAocHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoRXh0LmlzQXJyYXkoZXZlbnROYW1lKSkgewogICAgICAgICAgICBFeHQuZWFjaChldmVudE5hbWUsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICBtZS5vbihlLCBmbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gbWU7CiAgICAgICAgfQogICAgICAgIG1lLm9uKGV2ZW50TmFtZSwgZm4pOwogICAgICAgIHJldHVybiBtZTsKICAgIH0sCgogICAgCiAgICByZWxheUV2ZW50IDogZnVuY3Rpb24oZXZlbnROYW1lLCBvYnNlcnZhYmxlKSB7CiAgICAgICAgdGhpcy5vbihldmVudE5hbWUsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgb2JzZXJ2YWJsZS5maXJlRXZlbnQoZXZlbnROYW1lLCBlKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICBjbGVhbiA6IGZ1bmN0aW9uKGZvcmNlUmVjbGVhbikgewogICAgICAgIHZhciBtZSAgPSB0aGlzLAogICAgICAgICAgICBkb20gPSBtZS5kb20sCiAgICAgICAgICAgIG4gICA9IGRvbS5maXJzdENoaWxkLAogICAgICAgICAgICBuaSAgPSAtMTsKCiAgICAgICAgaWYgKEV4dC5FbGVtZW50LmRhdGEoZG9tLCAnaXNDbGVhbmVkJykgJiYgZm9yY2VSZWNsZWFuICE9PSB0cnVlKSB7CiAgICAgICAgICAgIHJldHVybiBtZTsKICAgICAgICB9CgogICAgICAgIHdoaWxlIChuKSB7CiAgICAgICAgICAgIHZhciBueCA9IG4ubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIGlmIChuLm5vZGVUeXBlID09IDMgJiYgISgvXFMvLnRlc3Qobi5ub2RlVmFsdWUpKSkgewogICAgICAgICAgICAgICAgZG9tLnJlbW92ZUNoaWxkKG4pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbi5ub2RlSW5kZXggPSArK25pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG4gPSBueDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgRXh0LkVsZW1lbnQuZGF0YShkb20sICdpc0NsZWFuZWQnLCB0cnVlKTsKICAgICAgICByZXR1cm4gbWU7CiAgICB9LAoKICAgIAogICAgbG9hZCA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB1cGRhdGVNYW5hZ2VyID0gdGhpcy5nZXRVcGRhdGVyKCk7CiAgICAgICAgdXBkYXRlTWFuYWdlci51cGRhdGUuYXBwbHkodXBkYXRlTWFuYWdlciwgYXJndW1lbnRzKTsKICAgICAgICAKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBnZXRVcGRhdGVyIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlTWFuYWdlciB8fCAodGhpcy51cGRhdGVNYW5hZ2VyID0gbmV3IEV4dC5VcGRhdGVyKHRoaXMpKTsKICAgIH0sCgogICAgCiAgICB1cGRhdGUgOiBmdW5jdGlvbihodG1sLCBsb2FkU2NyaXB0cywgY2FsbGJhY2spIHsKICAgICAgICBpZiAoIXRoaXMuZG9tKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBodG1sID0gaHRtbCB8fCAiIjsKCiAgICAgICAgaWYgKGxvYWRTY3JpcHRzICE9PSB0cnVlKSB7CiAgICAgICAgICAgIHRoaXMuZG9tLmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIHZhciBpZCAgPSBFeHQuaWQoKSwKICAgICAgICAgICAgZG9tID0gdGhpcy5kb207CgogICAgICAgIGh0bWwgKz0gJzxzcGFuIGlkPSInICsgaWQgKyAnIj48L3NwYW4+JzsKCiAgICAgICAgRXh0LmxpYi5FdmVudC5vbkF2YWlsYWJsZShpZCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBET0MgICAgPSBkb2N1bWVudCwKICAgICAgICAgICAgICAgIGhkICAgICA9IERPQy5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdLAogICAgICAgICAgICAgICAgcmUgICAgID0gLyg/OjxzY3JpcHQoW14+XSopPz4pKChcbnxccnwuKSo/KSg/OjxcL3NjcmlwdD4pL2lnLAogICAgICAgICAgICAgICAgc3JjUmUgID0gL1xzc3JjPShbXCdcIl0pKC4qPylcMS9pLAogICAgICAgICAgICAgICAgdHlwZVJlID0gL1xzdHlwZT0oW1wnXCJdKSguKj8pXDEvaSwKICAgICAgICAgICAgICAgIG1hdGNoLAogICAgICAgICAgICAgICAgYXR0cnMsCiAgICAgICAgICAgICAgICBzcmNNYXRjaCwKICAgICAgICAgICAgICAgIHR5cGVNYXRjaCwKICAgICAgICAgICAgICAgIGVsLAogICAgICAgICAgICAgICAgczsKCiAgICAgICAgICAgIHdoaWxlICgobWF0Y2ggPSByZS5leGVjKGh0bWwpKSkgewogICAgICAgICAgICAgICAgYXR0cnMgPSBtYXRjaFsxXTsKICAgICAgICAgICAgICAgIHNyY01hdGNoID0gYXR0cnMgPyBhdHRycy5tYXRjaChzcmNSZSkgOiBmYWxzZTsKICAgICAgICAgICAgICAgIGlmIChzcmNNYXRjaCAmJiBzcmNNYXRjaFsyXSkgewogICAgICAgICAgICAgICAgICAgcyA9IERPQy5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICAgICAgICAgICAgIHMuc3JjID0gc3JjTWF0Y2hbMl07CiAgICAgICAgICAgICAgICAgICB0eXBlTWF0Y2ggPSBhdHRycy5tYXRjaCh0eXBlUmUpOwogICAgICAgICAgICAgICAgICAgaWYgKHR5cGVNYXRjaCAmJiB0eXBlTWF0Y2hbMl0pIHsKICAgICAgICAgICAgICAgICAgICAgICBzLnR5cGUgPSB0eXBlTWF0Y2hbMl07CiAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICBoZC5hcHBlbmRDaGlsZChzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobWF0Y2hbMl0gJiYgbWF0Y2hbMl0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuZXhlY1NjcmlwdCkgewogICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5leGVjU2NyaXB0KG1hdGNoWzJdKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5ldmFsKG1hdGNoWzJdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGVsID0gRE9DLmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgaWYgKGVsKSB7CiAgICAgICAgICAgICAgICBFeHQucmVtb3ZlTm9kZShlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGRvbS5pbm5lckhUTUwgPSBodG1sLnJlcGxhY2UoLyg/OjxzY3JpcHQuKj8+KSgoXG58XHJ8LikqPykoPzo8XC9zY3JpcHQ+KS9pZywgIiIpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHJlbW92ZUFsbExpc3RlbmVycyA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucmVtb3ZlQW5jaG9yKCk7CiAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5yZW1vdmVBbGwodGhpcy5kb20pOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGNyZWF0ZVByb3h5IDogZnVuY3Rpb24oY29uZmlnLCByZW5kZXJUbywgbWF0Y2hCb3gpIHsKICAgICAgICBjb25maWcgPSAodHlwZW9mIGNvbmZpZyA9PSAnb2JqZWN0JykgPyBjb25maWcgOiB7dGFnIDogImRpdiIsIGNsczogY29uZmlnfTsKCiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgcHJveHkgPSByZW5kZXJUbyA/IEV4dC5Eb21IZWxwZXIuYXBwZW5kKHJlbmRlclRvLCBjb25maWcsIHRydWUpIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEV4dC5Eb21IZWxwZXIuaW5zZXJ0QmVmb3JlKG1lLmRvbSwgY29uZmlnLCB0cnVlKTsKCiAgICAgICAgaWYgKG1hdGNoQm94ICYmIG1lLnNldEJveCAmJiBtZS5nZXRCb3gpIHsgCiAgICAgICAgICAgcHJveHkuc2V0Qm94KG1lLmdldEJveCgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb3h5OwogICAgfQp9KTsKCkV4dC5FbGVtZW50LnByb3RvdHlwZS5nZXRVcGRhdGVNYW5hZ2VyID0gRXh0LkVsZW1lbnQucHJvdG90eXBlLmdldFVwZGF0ZXI7CgpFeHQuRWxlbWVudC5hZGRNZXRob2RzKHsKICAgIAogICAgZ2V0QW5jaG9yWFkgOiBmdW5jdGlvbihhbmNob3IsIGxvY2FsLCBzKXsKICAgICAgICAKICAgICAgICAKCQlhbmNob3IgPSAoYW5jaG9yIHx8ICJ0bCIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgcyA9IHMgfHwge307CiAgICAgICAgCiAgICAgICAgdmFyIG1lID0gdGhpcywgICAgICAgIAogICAgICAgIAl2cCA9IG1lLmRvbSA9PSBkb2N1bWVudC5ib2R5IHx8IG1lLmRvbSA9PSBkb2N1bWVudCwKICAgICAgICAJdyA9IHMud2lkdGggfHwgdnAgPyBFeHQubGliLkRvbS5nZXRWaWV3V2lkdGgoKSA6IG1lLmdldFdpZHRoKCksCiAgICAgICAgCWggPSBzLmhlaWdodCB8fCB2cCA/IEV4dC5saWIuRG9tLmdldFZpZXdIZWlnaHQoKSA6IG1lLmdldEhlaWdodCgpLCAgICAgICAgIAkgICAgICAgIAkKICAgICAgICAJeHksICAgICAgIAkKICAgICAgICAJciA9IE1hdGgucm91bmQsCiAgICAgICAgCW8gPSBtZS5nZXRYWSgpLAogICAgICAgIAlzY3JvbGwgPSBtZS5nZXRTY3JvbGwoKSwKICAgICAgICAJZXh0cmFYID0gdnAgPyBzY3JvbGwubGVmdCA6ICFsb2NhbCA/IG9bMF0gOiAwLAogICAgICAgIAlleHRyYVkgPSB2cCA/IHNjcm9sbC50b3AgOiAhbG9jYWwgPyBvWzFdIDogMCwKICAgICAgICAJaGFzaCA9IHsKCSAgICAgICAgCWMgIDogW3IodyAqIDAuNSksIHIoaCAqIDAuNSldLAoJICAgICAgICAJdCAgOiBbcih3ICogMC41KSwgMF0sCgkgICAgICAgIAlsICA6IFswLCByKGggKiAwLjUpXSwKCSAgICAgICAgCXIgIDogW3csIHIoaCAqIDAuNSldLAoJICAgICAgICAJYiAgOiBbcih3ICogMC41KSwgaF0sCgkgICAgICAgIAl0bCA6IFswLCAwXSwJCgkgICAgICAgIAlibCA6IFswLCBoXSwKCSAgICAgICAgCWJyIDogW3csIGhdLAoJICAgICAgICAJdHIgOiBbdywgMF0KICAgICAgICAJfTsKICAgICAgICAKICAgICAgICB4eSA9IGhhc2hbYW5jaG9yXTsJCiAgICAgICAgcmV0dXJuIFt4eVswXSArIGV4dHJhWCwgeHlbMV0gKyBleHRyYVldOyAKICAgIH0sCgogICAgCiAgICBhbmNob3JUbyA6IGZ1bmN0aW9uKGVsLCBhbGlnbm1lbnQsIG9mZnNldHMsIGFuaW1hdGUsIG1vbml0b3JTY3JvbGwsIGNhbGxiYWNrKXsgICAgICAgIAoJICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgIGRvbSA9IG1lLmRvbSwKICAgICAgICAgICAgc2Nyb2xsID0gIUV4dC5pc0VtcHR5KG1vbml0b3JTY3JvbGwpLAogICAgICAgICAgICBhY3Rpb24gPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgRXh0LmZseShkb20pLmFsaWduVG8oZWwsIGFsaWdubWVudCwgb2Zmc2V0cywgYW5pbWF0ZSk7CiAgICAgICAgICAgICAgICBFeHQuY2FsbGJhY2soY2FsbGJhY2ssIEV4dC5mbHkoZG9tKSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGFuY2hvciA9IHRoaXMuZ2V0QW5jaG9yKCk7CiAgICAgICAgICAgIAogICAgICAgIAogICAgICAgIHRoaXMucmVtb3ZlQW5jaG9yKCk7CiAgICAgICAgRXh0LmFwcGx5KGFuY2hvciwgewogICAgICAgICAgICBmbjogYWN0aW9uLAogICAgICAgICAgICBzY3JvbGw6IHNjcm9sbAogICAgICAgIH0pOwoKICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLm9uV2luZG93UmVzaXplKGFjdGlvbiwgbnVsbCk7CiAgICAgICAgCiAgICAgICAgaWYoc2Nyb2xsKXsKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5vbih3aW5kb3csICdzY3JvbGwnLCBhY3Rpb24sIG51bGwsCiAgICAgICAgICAgICAgICB7YnVmZmVyOiAhaXNOYU4obW9uaXRvclNjcm9sbCkgPyBtb25pdG9yU2Nyb2xsIDogNTB9KTsKICAgICAgICB9CiAgICAgICAgYWN0aW9uLmNhbGwobWUpOyAKICAgICAgICByZXR1cm4gbWU7CiAgICB9LAogICAgCiAgICAKICAgIHJlbW92ZUFuY2hvciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgYW5jaG9yID0gdGhpcy5nZXRBbmNob3IoKTsKICAgICAgICAgICAgCiAgICAgICAgaWYoYW5jaG9yICYmIGFuY2hvci5mbil7CiAgICAgICAgICAgIEV4dC5FdmVudE1hbmFnZXIucmVtb3ZlUmVzaXplTGlzdGVuZXIoYW5jaG9yLmZuKTsKICAgICAgICAgICAgaWYoYW5jaG9yLnNjcm9sbCl7CiAgICAgICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLnVuKHdpbmRvdywgJ3Njcm9sbCcsIGFuY2hvci5mbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIGFuY2hvci5mbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKICAgIAogICAgCiAgICBnZXRBbmNob3IgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBkYXRhID0gRXh0LkVsZW1lbnQuZGF0YSwKICAgICAgICAgICAgZG9tID0gdGhpcy5kb207CiAgICAgICAgICAgIGlmICghZG9tKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuY2hvciA9IGRhdGEoZG9tLCAnX2FuY2hvcicpOwogICAgICAgICAgICAKICAgICAgICBpZighYW5jaG9yKXsKICAgICAgICAgICAgYW5jaG9yID0gZGF0YShkb20sICdfYW5jaG9yJywge30pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYW5jaG9yOwogICAgfSwKCiAgICAKICAgIGdldEFsaWduVG9YWSA6IGZ1bmN0aW9uKGVsLCBwLCBvKXsJICAgIAogICAgICAgIGVsID0gRXh0LmdldChlbCk7CiAgICAgICAgCiAgICAgICAgaWYoIWVsIHx8ICFlbC5kb20pewogICAgICAgICAgICB0aHJvdyAiRWxlbWVudC5hbGlnblRvWFkgd2l0aCBhbiBlbGVtZW50IHRoYXQgZG9lc24ndCBleGlzdCI7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIG8gPSBvIHx8IFswLDBdOwogICAgICAgIHAgPSAoIXAgfHwgcCA9PSAiPyIgPyAidGwtYmw/IiA6ICghKC8tLykudGVzdChwKSAmJiBwICE9PSAiIiA/ICJ0bC0iICsgcCA6IHAgfHwgInRsLWJsIikpLnRvTG93ZXJDYXNlKCk7ICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAJZCA9IG1lLmRvbSwKICAgICAgICAJYTEsCiAgICAgICAgCWEyLAogICAgICAgIAl4LAogICAgICAgIAl5LAogICAgICAgIAkKICAgICAgICAJdywKICAgICAgICAJaCwKICAgICAgICAJciwKICAgICAgICAJZHcgPSBFeHQubGliLkRvbS5nZXRWaWV3V2lkdGgoKSAtMTAsIAogICAgICAgIAlkaCA9IEV4dC5saWIuRG9tLmdldFZpZXdIZWlnaHQoKS0xMCwgCiAgICAgICAgCXAxeSwKICAgICAgICAJcDF4LCAgICAgICAgCQogICAgICAgIAlwMnksCiAgICAgICAgCXAyeCwKICAgICAgICAJc3dhcFksCiAgICAgICAgCXN3YXBYLAogICAgICAgIAlkb2MgPSBkb2N1bWVudCwKICAgICAgICAJZG9jRWxlbWVudCA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCiAgICAgICAgCWRvY0JvZHkgPSBkb2MuYm9keSwKICAgICAgICAJc2Nyb2xsWCA9IChkb2NFbGVtZW50LnNjcm9sbExlZnQgfHwgZG9jQm9keS5zY3JvbGxMZWZ0IHx8IDApKzUsCiAgICAgICAgCXNjcm9sbFkgPSAoZG9jRWxlbWVudC5zY3JvbGxUb3AgfHwgZG9jQm9keS5zY3JvbGxUb3AgfHwgMCkrNSwKICAgICAgICAJYyA9IGZhbHNlLCAKICAgICAgICAJcDEgPSAiIiwgCiAgICAgICAgCXAyID0gIiIsCiAgICAgICAgCW0gPSBwLm1hdGNoKC9eKFthLXpdKyktKFthLXpdKykoXD8pPyQvKTsKICAgICAgICAKICAgICAgICBpZighbSl7CiAgICAgICAgICAgdGhyb3cgIkVsZW1lbnQuYWxpZ25UbyB3aXRoIGFuIGludmFsaWQgYWxpZ25tZW50ICIgKyBwOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBwMSA9IG1bMV07IAogICAgICAgIHAyID0gbVsyXTsgCiAgICAgICAgYyA9ICEhbVszXTsKCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgYTEgPSBtZS5nZXRBbmNob3JYWShwMSwgdHJ1ZSk7CiAgICAgICAgYTIgPSBlbC5nZXRBbmNob3JYWShwMiwgZmFsc2UpOwoKICAgICAgICB4ID0gYTJbMF0gLSBhMVswXSArIG9bMF07CiAgICAgICAgeSA9IGEyWzFdIC0gYTFbMV0gKyBvWzFdOwoKICAgICAgICBpZihjKXsgICAgCgkgICAgICAgdyA9IG1lLmdldFdpZHRoKCk7CiAgICAgICAgICAgaCA9IG1lLmdldEhlaWdodCgpOwogICAgICAgICAgIHIgPSBlbC5nZXRSZWdpb24oKTsgICAgICAgCiAgICAgICAgICAgCiAgICAgICAgICAgCiAgICAgICAgICAgCiAgICAgICAgICAgcDF5ID0gcDEuY2hhckF0KDApOwogICAgICAgICAgIHAxeCA9IHAxLmNoYXJBdChwMS5sZW5ndGgtMSk7CiAgICAgICAgICAgcDJ5ID0gcDIuY2hhckF0KDApOwogICAgICAgICAgIHAyeCA9IHAyLmNoYXJBdChwMi5sZW5ndGgtMSk7CiAgICAgICAgICAgc3dhcFkgPSAoKHAxeT09InQiICYmIHAyeT09ImIiKSB8fCAocDF5PT0iYiIgJiYgcDJ5PT0idCIpKTsKICAgICAgICAgICBzd2FwWCA9ICgocDF4PT0iciIgJiYgcDJ4PT0ibCIpIHx8IChwMXg9PSJsIiAmJiBwMng9PSJyIikpOyAgICAgICAgICAKICAgICAgICAgICAKCiAgICAgICAgICAgaWYgKHggKyB3ID4gZHcgKyBzY3JvbGxYKSB7CiAgICAgICAgICAgICAgICB4ID0gc3dhcFggPyByLmxlZnQtdyA6IGR3K3Njcm9sbFgtdzsKICAgICAgICAgICB9CiAgICAgICAgICAgaWYgKHggPCBzY3JvbGxYKSB7CiAgICAgICAgICAgICAgIHggPSBzd2FwWCA/IHIucmlnaHQgOiBzY3JvbGxYOwogICAgICAgICAgIH0KICAgICAgICAgICBpZiAoeSArIGggPiBkaCArIHNjcm9sbFkpIHsKICAgICAgICAgICAgICAgIHkgPSBzd2FwWSA/IHIudG9wLWggOiBkaCtzY3JvbGxZLWg7CiAgICAgICAgICAgIH0KICAgICAgICAgICBpZiAoeSA8IHNjcm9sbFkpewogICAgICAgICAgICAgICB5ID0gc3dhcFkgPyByLmJvdHRvbSA6IHNjcm9sbFk7CiAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gW3gseV07CiAgICB9LAoKICAgIAogICAgYWxpZ25UbyA6IGZ1bmN0aW9uKGVsZW1lbnQsIHBvc2l0aW9uLCBvZmZzZXRzLCBhbmltYXRlKXsKCSAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgIHJldHVybiBtZS5zZXRYWShtZS5nZXRBbGlnblRvWFkoZWxlbWVudCwgcG9zaXRpb24sIG9mZnNldHMpLAogICAgICAgICAgCQkgICAgICAgIG1lLnByZWFuaW0gJiYgISFhbmltYXRlID8gbWUucHJlYW5pbShhcmd1bWVudHMsIDMpIDogZmFsc2UpOwogICAgfSwKICAgIAogICAgCiAgICBhZGp1c3RGb3JDb25zdHJhaW50cyA6IGZ1bmN0aW9uKHh5LCBwYXJlbnQsIG9mZnNldHMpewogICAgICAgIHJldHVybiB0aGlzLmdldENvbnN0cmFpblRvWFkocGFyZW50IHx8IGRvY3VtZW50LCBmYWxzZSwgb2Zmc2V0cywgeHkpIHx8ICB4eTsKICAgIH0sCgogICAgCiAgICBnZXRDb25zdHJhaW5Ub1hZIDogZnVuY3Rpb24oZWwsIGxvY2FsLCBvZmZzZXRzLCBwcm9wb3NlZFhZKXsgICAKCSAgICB2YXIgb3MgPSB7dG9wOjAsIGxlZnQ6MCwgYm90dG9tOjAsIHJpZ2h0OiAwfTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGVsLCBsb2NhbCwgb2Zmc2V0cywgcHJvcG9zZWRYWSl7CiAgICAgICAgICAgIGVsID0gRXh0LmdldChlbCk7CiAgICAgICAgICAgIG9mZnNldHMgPSBvZmZzZXRzID8gRXh0LmFwcGx5SWYob2Zmc2V0cywgb3MpIDogb3M7CgogICAgICAgICAgICB2YXIgdncsIHZoLCB2eCA9IDAsIHZ5ID0gMDsKICAgICAgICAgICAgaWYoZWwuZG9tID09IGRvY3VtZW50LmJvZHkgfHwgZWwuZG9tID09IGRvY3VtZW50KXsKICAgICAgICAgICAgICAgIHZ3ID1FeHQubGliLkRvbS5nZXRWaWV3V2lkdGgoKTsKICAgICAgICAgICAgICAgIHZoID0gRXh0LmxpYi5Eb20uZ2V0Vmlld0hlaWdodCgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHZ3ID0gZWwuZG9tLmNsaWVudFdpZHRoOwogICAgICAgICAgICAgICAgdmggPSBlbC5kb20uY2xpZW50SGVpZ2h0OwogICAgICAgICAgICAgICAgaWYoIWxvY2FsKXsKICAgICAgICAgICAgICAgICAgICB2YXIgdnh5ID0gZWwuZ2V0WFkoKTsKICAgICAgICAgICAgICAgICAgICB2eCA9IHZ4eVswXTsKICAgICAgICAgICAgICAgICAgICB2eSA9IHZ4eVsxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHMgPSBlbC5nZXRTY3JvbGwoKTsKCiAgICAgICAgICAgIHZ4ICs9IG9mZnNldHMubGVmdCArIHMubGVmdDsKICAgICAgICAgICAgdnkgKz0gb2Zmc2V0cy50b3AgKyBzLnRvcDsKCiAgICAgICAgICAgIHZ3IC09IG9mZnNldHMucmlnaHQ7CiAgICAgICAgICAgIHZoIC09IG9mZnNldHMuYm90dG9tOwoKICAgICAgICAgICAgdmFyIHZyID0gdnggKyB2dywKICAgICAgICAgICAgICAgIHZiID0gdnkgKyB2aCwKICAgICAgICAgICAgICAgIHh5ID0gcHJvcG9zZWRYWSB8fCAoIWxvY2FsID8gdGhpcy5nZXRYWSgpIDogW3RoaXMuZ2V0TGVmdCh0cnVlKSwgdGhpcy5nZXRUb3AodHJ1ZSldKSwKICAgICAgICAgICAgICAgIHggPSB4eVswXSwgeSA9IHh5WzFdLAogICAgICAgICAgICAgICAgb2Zmc2V0ID0gdGhpcy5nZXRDb25zdHJhaW5PZmZzZXQoKSwKICAgICAgICAgICAgICAgIHcgPSB0aGlzLmRvbS5vZmZzZXRXaWR0aCArIG9mZnNldCwgCiAgICAgICAgICAgICAgICBoID0gdGhpcy5kb20ub2Zmc2V0SGVpZ2h0ICsgb2Zmc2V0OwoKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBtb3ZlZCA9IGZhbHNlOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKCh4ICsgdykgPiB2cil7CiAgICAgICAgICAgICAgICB4ID0gdnIgLSB3OwogICAgICAgICAgICAgICAgbW92ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCh5ICsgaCkgPiB2Yil7CiAgICAgICAgICAgICAgICB5ID0gdmIgLSBoOwogICAgICAgICAgICAgICAgbW92ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZih4IDwgdngpewogICAgICAgICAgICAgICAgeCA9IHZ4OwogICAgICAgICAgICAgICAgbW92ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHkgPCB2eSl7CiAgICAgICAgICAgICAgICB5ID0gdnk7CiAgICAgICAgICAgICAgICBtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vdmVkID8gW3gsIHldIDogZmFsc2U7CiAgICAgICAgfTsKICAgIH0oKSwKCSAgICAKCSAgICAKCSAgICAgICAgCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKICAgIAogICAgZ2V0Q29uc3RyYWluT2Zmc2V0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gMDsKICAgIH0sCiAgICAKICAgIAogICAgZ2V0Q2VudGVyWFkgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmdldEFsaWduVG9YWShkb2N1bWVudCwgJ2MtYycpOwogICAgfSwKCiAgICAKICAgIGNlbnRlciA6IGZ1bmN0aW9uKGNlbnRlckluKXsKICAgICAgICByZXR1cm4gdGhpcy5hbGlnblRvKGNlbnRlckluIHx8IGRvY3VtZW50LCAnYy1jJyk7ICAgICAgICAKICAgIH0gICAgCn0pOwoKRXh0LkVsZW1lbnQuYWRkTWV0aG9kcyh7CiAgICAKICAgIHNlbGVjdCA6IGZ1bmN0aW9uKHNlbGVjdG9yLCB1bmlxdWUpewogICAgICAgIHJldHVybiBFeHQuRWxlbWVudC5zZWxlY3Qoc2VsZWN0b3IsIHVuaXF1ZSwgdGhpcy5kb20pOwogICAgfQp9KTsKRXh0LmFwcGx5KEV4dC5FbGVtZW50LnByb3RvdHlwZSwgZnVuY3Rpb24oKSB7Cgl2YXIgR0VURE9NID0gRXh0LmdldERvbSwKCQlHRVQgPSBFeHQuZ2V0LAoJCURIID0gRXh0LkRvbUhlbHBlcjsKCQoJcmV0dXJuIHsJCgkJCgkgICAgaW5zZXJ0U2libGluZzogZnVuY3Rpb24oZWwsIHdoZXJlLCByZXR1cm5Eb20pewoJICAgICAgICB2YXIgbWUgPSB0aGlzLAoJICAgICAgICAJcnQsCiAgICAgICAgICAgICAgICBpc0FmdGVyID0gKHdoZXJlIHx8ICdiZWZvcmUnKS50b0xvd2VyQ2FzZSgpID09ICdhZnRlcicsCiAgICAgICAgICAgICAgICBpbnNlcnRFbDsKCSAgICAgICAgCQoJICAgICAgICBpZihFeHQuaXNBcnJheShlbCkpewogICAgICAgICAgICAgICAgaW5zZXJ0RWwgPSBtZTsKCSAgICAgICAgICAgIEV4dC5lYWNoKGVsLCBmdW5jdGlvbihlKSB7CgkJICAgICAgICAgICAgcnQgPSBFeHQuZmx5KGluc2VydEVsLCAnX2ludGVybmFsJykuaW5zZXJ0U2libGluZyhlLCB3aGVyZSwgcmV0dXJuRG9tKTsKICAgICAgICAgICAgICAgICAgICBpZihpc0FmdGVyKXsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0RWwgPSBydDsKICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9KTsKCSAgICAgICAgICAgIHJldHVybiBydDsKCSAgICAgICAgfQoJICAgICAgICAgICAgICAgIAoJICAgICAgICBlbCA9IGVsIHx8IHt9OwoJICAgICAgIAkKICAgICAgICAgICAgaWYoZWwubm9kZVR5cGUgfHwgZWwuZG9tKXsKICAgICAgICAgICAgICAgIHJ0ID0gbWUuZG9tLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKEdFVERPTShlbCksIGlzQWZ0ZXIgPyBtZS5kb20ubmV4dFNpYmxpbmcgOiBtZS5kb20pOwogICAgICAgICAgICAgICAgaWYgKCFyZXR1cm5Eb20pIHsKICAgICAgICAgICAgICAgICAgICBydCA9IEdFVChydCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgaWYgKGlzQWZ0ZXIgJiYgIW1lLmRvbS5uZXh0U2libGluZykgewogICAgICAgICAgICAgICAgICAgIHJ0ID0gREguYXBwZW5kKG1lLmRvbS5wYXJlbnROb2RlLCBlbCwgIXJldHVybkRvbSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcnQgPSBESFtpc0FmdGVyID8gJ2luc2VydEFmdGVyJyA6ICdpbnNlcnRCZWZvcmUnXShtZS5kb20sIGVsLCAhcmV0dXJuRG9tKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoJICAgICAgICByZXR1cm4gcnQ7CgkgICAgfQogICAgfTsKfSgpKTsKCgpFeHQuRWxlbWVudC5ib3hNYXJrdXAgPSAnPGRpdiBjbGFzcz0iezB9LXRsIj48ZGl2IGNsYXNzPSJ7MH0tdHIiPjxkaXYgY2xhc3M9InswfS10YyI+PC9kaXY+PC9kaXY+PC9kaXY+PGRpdiBjbGFzcz0iezB9LW1sIj48ZGl2IGNsYXNzPSJ7MH0tbXIiPjxkaXYgY2xhc3M9InswfS1tYyI+PC9kaXY+PC9kaXY+PC9kaXY+PGRpdiBjbGFzcz0iezB9LWJsIj48ZGl2IGNsYXNzPSJ7MH0tYnIiPjxkaXYgY2xhc3M9InswfS1iYyI+PC9kaXY+PC9kaXY+PC9kaXY+JzsKCkV4dC5FbGVtZW50LmFkZE1ldGhvZHMoZnVuY3Rpb24oKXsKICAgIHZhciBJTlRFUk5BTCA9ICJfaW50ZXJuYWwiLAogICAgICAgIHB4TWF0Y2ggPSAvKFxkK1wuP1xkKylweC87CiAgICByZXR1cm4gewogICAgICAgIAogICAgICAgIGFwcGx5U3R5bGVzIDogZnVuY3Rpb24oc3R5bGUpewogICAgICAgICAgICBFeHQuRG9tSGVscGVyLmFwcGx5U3R5bGVzKHRoaXMuZG9tLCBzdHlsZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldFN0eWxlcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciByZXQgPSB7fTsKICAgICAgICAgICAgRXh0LmVhY2goYXJndW1lbnRzLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgIHJldFt2XSA9IHRoaXMuZ2V0U3R5bGUodik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRoaXMpOwogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHNldE92ZXJmbG93IDogZnVuY3Rpb24odil7CiAgICAgICAgICAgIHZhciBkb20gPSB0aGlzLmRvbTsKICAgICAgICAgICAgaWYodj09J2F1dG8nICYmIEV4dC5pc01hYyAmJiBFeHQuaXNHZWNrbzIpeyAKICAgICAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgKGZ1bmN0aW9uKCl7ZG9tLnN0eWxlLm92ZXJmbG93ID0gJ2F1dG8nO30pLmRlZmVyKDEpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGRvbS5zdHlsZS5vdmVyZmxvdyA9IHY7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgIAogICAgICAgIGJveFdyYXAgOiBmdW5jdGlvbihjbHMpewogICAgICAgICAgICBjbHMgPSBjbHMgfHwgJ3gtYm94JzsKICAgICAgICAgICAgdmFyIGVsID0gRXh0LmdldCh0aGlzLmluc2VydEh0bWwoImJlZm9yZUJlZ2luIiwgIjxkaXYgY2xhc3M9JyIgKyBjbHMgKyAiJz4iICsgU3RyaW5nLmZvcm1hdChFeHQuRWxlbWVudC5ib3hNYXJrdXAsIGNscykgKyAiPC9kaXY+IikpOyAgICAgICAgCiAgICAgICAgICAgIEV4dC5Eb21RdWVyeS5zZWxlY3ROb2RlKCcuJyArIGNscyArICctbWMnLCBlbC5kb20pLmFwcGVuZENoaWxkKHRoaXMuZG9tKTsKICAgICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHNldFNpemUgOiBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0LCBhbmltYXRlKXsKICAgICAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICAgICAgaWYodHlwZW9mIHdpZHRoID09ICdvYmplY3QnKXsgCiAgICAgICAgICAgICAgICBoZWlnaHQgPSB3aWR0aC5oZWlnaHQ7CiAgICAgICAgICAgICAgICB3aWR0aCA9IHdpZHRoLndpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdpZHRoID0gbWUuYWRqdXN0V2lkdGgod2lkdGgpOwogICAgICAgICAgICBoZWlnaHQgPSBtZS5hZGp1c3RIZWlnaHQoaGVpZ2h0KTsKICAgICAgICAgICAgaWYoIWFuaW1hdGUgfHwgIW1lLmFuaW0pewogICAgICAgICAgICAgICAgbWUuZG9tLnN0eWxlLndpZHRoID0gbWUuYWRkVW5pdHMod2lkdGgpOwogICAgICAgICAgICAgICAgbWUuZG9tLnN0eWxlLmhlaWdodCA9IG1lLmFkZFVuaXRzKGhlaWdodCk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgbWUuYW5pbSh7d2lkdGg6IHt0bzogd2lkdGh9LCBoZWlnaHQ6IHt0bzogaGVpZ2h0fX0sIG1lLnByZWFuaW0oYXJndW1lbnRzLCAyKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1lOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldENvbXB1dGVkSGVpZ2h0IDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIGggPSBNYXRoLm1heChtZS5kb20ub2Zmc2V0SGVpZ2h0LCBtZS5kb20uY2xpZW50SGVpZ2h0KTsKICAgICAgICAgICAgaWYoIWgpewogICAgICAgICAgICAgICAgaCA9IHBhcnNlRmxvYXQobWUuZ2V0U3R5bGUoJ2hlaWdodCcpKSB8fCAwOwogICAgICAgICAgICAgICAgaWYoIW1lLmlzQm9yZGVyQm94KCkpewogICAgICAgICAgICAgICAgICAgIGggKz0gbWUuZ2V0RnJhbWVXaWR0aCgndGInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRDb21wdXRlZFdpZHRoIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIHcgPSBNYXRoLm1heCh0aGlzLmRvbS5vZmZzZXRXaWR0aCwgdGhpcy5kb20uY2xpZW50V2lkdGgpOwogICAgICAgICAgICBpZighdyl7CiAgICAgICAgICAgICAgICB3ID0gcGFyc2VGbG9hdCh0aGlzLmdldFN0eWxlKCd3aWR0aCcpKSB8fCAwOwogICAgICAgICAgICAgICAgaWYoIXRoaXMuaXNCb3JkZXJCb3goKSl7CiAgICAgICAgICAgICAgICAgICAgdyArPSB0aGlzLmdldEZyYW1lV2lkdGgoJ2xyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHc7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0RnJhbWVXaWR0aCA6IGZ1bmN0aW9uKHNpZGVzLCBvbmx5Q29udGVudEJveCl7CiAgICAgICAgICAgIHJldHVybiBvbmx5Q29udGVudEJveCAmJiB0aGlzLmlzQm9yZGVyQm94KCkgPyAwIDogKHRoaXMuZ2V0UGFkZGluZyhzaWRlcykgKyB0aGlzLmdldEJvcmRlcldpZHRoKHNpZGVzKSk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgYWRkQ2xhc3NPbk92ZXIgOiBmdW5jdGlvbihjbGFzc05hbWUpewogICAgICAgICAgICB0aGlzLmhvdmVyKAogICAgICAgICAgICAgICAgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBFeHQuZmx5KHRoaXMsIElOVEVSTkFMKS5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgRXh0LmZseSh0aGlzLCBJTlRFUk5BTCkucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgYWRkQ2xhc3NPbkZvY3VzIDogZnVuY3Rpb24oY2xhc3NOYW1lKXsKICAgICAgICAgICAgdGhpcy5vbigiZm9jdXMiLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgRXh0LmZseSh0aGlzLCBJTlRFUk5BTCkuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgfSwgdGhpcy5kb20pOwogICAgICAgICAgICB0aGlzLm9uKCJibHVyIiwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIEV4dC5mbHkodGhpcywgSU5URVJOQUwpLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0sIHRoaXMuZG9tKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgYWRkQ2xhc3NPbkNsaWNrIDogZnVuY3Rpb24oY2xhc3NOYW1lKXsKICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXMuZG9tOwogICAgICAgICAgICB0aGlzLm9uKCJtb3VzZWRvd24iLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgRXh0LmZseShkb20sIElOVEVSTkFMKS5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgdmFyIGQgPSBFeHQuZ2V0RG9jKCksCiAgICAgICAgICAgICAgICAgICAgZm4gPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICBFeHQuZmx5KGRvbSwgSU5URVJOQUwpLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGQucmVtb3ZlTGlzdGVuZXIoIm1vdXNldXAiLCBmbik7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGQub24oIm1vdXNldXAiLCBmbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAKCiAgICAgICAgZ2V0Vmlld1NpemUgOiBmdW5jdGlvbigpewogICAgICAgICAgICB2YXIgZG9jID0gZG9jdW1lbnQsCiAgICAgICAgICAgICAgICBkID0gdGhpcy5kb20sCiAgICAgICAgICAgICAgICBpc0RvYyA9IChkID09IGRvYyB8fCBkID09IGRvYy5ib2R5KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNEb2MpIHsKICAgICAgICAgICAgICAgIHZhciBleHRkb20gPSBFeHQubGliLkRvbTsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgd2lkdGggOiBleHRkb20uZ2V0Vmlld1dpZHRoKCksCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0IDogZXh0ZG9tLmdldFZpZXdIZWlnaHQoKQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICB3aWR0aCA6IGQuY2xpZW50V2lkdGgsCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0IDogZC5jbGllbnRIZWlnaHQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKCiAgICAgICAgZ2V0U3R5bGVTaXplIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgICAgIHcsIGgsCiAgICAgICAgICAgICAgICBkb2MgPSBkb2N1bWVudCwKICAgICAgICAgICAgICAgIGQgPSB0aGlzLmRvbSwKICAgICAgICAgICAgICAgIGlzRG9jID0gKGQgPT0gZG9jIHx8IGQgPT0gZG9jLmJvZHkpLAogICAgICAgICAgICAgICAgcyA9IGQuc3R5bGU7CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGlzRG9jKSB7CiAgICAgICAgICAgICAgICB2YXIgZXh0ZG9tID0gRXh0LmxpYi5Eb207CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIHdpZHRoIDogZXh0ZG9tLmdldFZpZXdXaWR0aCgpLAogICAgICAgICAgICAgICAgICAgIGhlaWdodCA6IGV4dGRvbS5nZXRWaWV3SGVpZ2h0KCkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHMud2lkdGggJiYgcy53aWR0aCAhPSAnYXV0bycpewogICAgICAgICAgICAgICAgdyA9IHBhcnNlRmxvYXQocy53aWR0aCk7CiAgICAgICAgICAgICAgICBpZihtZS5pc0JvcmRlckJveCgpKXsKICAgICAgICAgICAgICAgICAgIHcgLT0gbWUuZ2V0RnJhbWVXaWR0aCgnbHInKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYocy5oZWlnaHQgJiYgcy5oZWlnaHQgIT0gJ2F1dG8nKXsKICAgICAgICAgICAgICAgIGggPSBwYXJzZUZsb2F0KHMuaGVpZ2h0KTsKICAgICAgICAgICAgICAgIGlmKG1lLmlzQm9yZGVyQm94KCkpewogICAgICAgICAgICAgICAgICAgaCAtPSBtZS5nZXRGcmFtZVdpZHRoKCd0YicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4ge3dpZHRoOiB3IHx8IG1lLmdldFdpZHRoKHRydWUpLCBoZWlnaHQ6IGggfHwgbWUuZ2V0SGVpZ2h0KHRydWUpfTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRTaXplIDogZnVuY3Rpb24oY29udGVudFNpemUpewogICAgICAgICAgICByZXR1cm4ge3dpZHRoOiB0aGlzLmdldFdpZHRoKGNvbnRlbnRTaXplKSwgaGVpZ2h0OiB0aGlzLmdldEhlaWdodChjb250ZW50U2l6ZSl9OwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHJlcGFpbnQgOiBmdW5jdGlvbigpewogICAgICAgICAgICB2YXIgZG9tID0gdGhpcy5kb207CiAgICAgICAgICAgIHRoaXMuYWRkQ2xhc3MoIngtcmVwYWludCIpOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBFeHQuZmx5KGRvbSkucmVtb3ZlQ2xhc3MoIngtcmVwYWludCIpOwogICAgICAgICAgICB9LCAxKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgdW5zZWxlY3RhYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdGhpcy5kb20udW5zZWxlY3RhYmxlID0gIm9uIjsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3dhbGxvd0V2ZW50KCJzZWxlY3RzdGFydCIsIHRydWUpLgogICAgICAgICAgICAgICAgICAgICAgICBhcHBseVN0eWxlcygiLW1vei11c2VyLXNlbGVjdDpub25lOy1raHRtbC11c2VyLXNlbGVjdDpub25lOyIpLgogICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcygieC11bnNlbGVjdGFibGUiKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRNYXJnaW5zIDogZnVuY3Rpb24oc2lkZSl7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgICBoYXNoID0ge3Q6InRvcCIsIGw6ImxlZnQiLCByOiJyaWdodCIsIGI6ICJib3R0b20ifSwKICAgICAgICAgICAgICAgIG8gPSB7fTsKCiAgICAgICAgICAgIGlmICghc2lkZSkgewogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbWUubWFyZ2lucyl7CiAgICAgICAgICAgICAgICAgICAgb1toYXNoW2tleV1dID0gcGFyc2VGbG9hdChtZS5nZXRTdHlsZShtZS5tYXJnaW5zW2tleV0pKSB8fCAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG87CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWUuYWRkU3R5bGVzLmNhbGwobWUsIHNpZGUsIG1lLm1hcmdpbnMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfSgpKTsKCkV4dC5FbGVtZW50LmFkZE1ldGhvZHMoewogICAgCiAgICBzZXRCb3ggOiBmdW5jdGlvbihib3gsIGFkanVzdCwgYW5pbWF0ZSl7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAJdyA9IGJveC53aWR0aCwgCiAgICAgICAgCWggPSBib3guaGVpZ2h0OwogICAgICAgIGlmKChhZGp1c3QgJiYgIW1lLmF1dG9Cb3hBZGp1c3QpICYmICFtZS5pc0JvcmRlckJveCgpKXsKICAgICAgICAgICB3IC09IChtZS5nZXRCb3JkZXJXaWR0aCgibHIiKSArIG1lLmdldFBhZGRpbmcoImxyIikpOwogICAgICAgICAgIGggLT0gKG1lLmdldEJvcmRlcldpZHRoKCJ0YiIpICsgbWUuZ2V0UGFkZGluZygidGIiKSk7CiAgICAgICAgfQogICAgICAgIG1lLnNldEJvdW5kcyhib3gueCwgYm94LnksIHcsIGgsIG1lLmFuaW1UZXN0LmNhbGwobWUsIGFyZ3VtZW50cywgYW5pbWF0ZSwgMikpOwogICAgICAgIHJldHVybiBtZTsKICAgIH0sCgogICAgCglnZXRCb3ggOiBmdW5jdGlvbihjb250ZW50Qm94LCBsb2NhbCkgewkgICAgCgkgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAJeHksCiAgICAgICAgCWxlZnQsCiAgICAgICAgCXRvcCwKICAgICAgICAJZ2V0Qm9yZGVyV2lkdGggPSBtZS5nZXRCb3JkZXJXaWR0aCwKICAgICAgICAJZ2V0UGFkZGluZyA9IG1lLmdldFBhZGRpbmcsIAogICAgICAgIAlsLAogICAgICAgIAlyLAogICAgICAgIAl0LAogICAgICAgIAliOwogICAgICAgIGlmKCFsb2NhbCl7CiAgICAgICAgICAgIHh5ID0gbWUuZ2V0WFkoKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgbGVmdCA9IHBhcnNlSW50KG1lLmdldFN0eWxlKCJsZWZ0IiksIDEwKSB8fCAwOwogICAgICAgICAgICB0b3AgPSBwYXJzZUludChtZS5nZXRTdHlsZSgidG9wIiksIDEwKSB8fCAwOwogICAgICAgICAgICB4eSA9IFtsZWZ0LCB0b3BdOwogICAgICAgIH0KICAgICAgICB2YXIgZWwgPSBtZS5kb20sIHcgPSBlbC5vZmZzZXRXaWR0aCwgaCA9IGVsLm9mZnNldEhlaWdodCwgYng7CiAgICAgICAgaWYoIWNvbnRlbnRCb3gpewogICAgICAgICAgICBieCA9IHt4OiB4eVswXSwgeTogeHlbMV0sIDA6IHh5WzBdLCAxOiB4eVsxXSwgd2lkdGg6IHcsIGhlaWdodDogaH07CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGwgPSBnZXRCb3JkZXJXaWR0aC5jYWxsKG1lLCAibCIpICsgZ2V0UGFkZGluZy5jYWxsKG1lLCAibCIpOwogICAgICAgICAgICByID0gZ2V0Qm9yZGVyV2lkdGguY2FsbChtZSwgInIiKSArIGdldFBhZGRpbmcuY2FsbChtZSwgInIiKTsKICAgICAgICAgICAgdCA9IGdldEJvcmRlcldpZHRoLmNhbGwobWUsICJ0IikgKyBnZXRQYWRkaW5nLmNhbGwobWUsICJ0Iik7CiAgICAgICAgICAgIGIgPSBnZXRCb3JkZXJXaWR0aC5jYWxsKG1lLCAiYiIpICsgZ2V0UGFkZGluZy5jYWxsKG1lLCAiYiIpOwogICAgICAgICAgICBieCA9IHt4OiB4eVswXStsLCB5OiB4eVsxXSt0LCAwOiB4eVswXStsLCAxOiB4eVsxXSt0LCB3aWR0aDogdy0obCtyKSwgaGVpZ2h0OiBoLSh0K2IpfTsKICAgICAgICB9CiAgICAgICAgYngucmlnaHQgPSBieC54ICsgYngud2lkdGg7CiAgICAgICAgYnguYm90dG9tID0gYngueSArIGJ4LmhlaWdodDsKICAgICAgICByZXR1cm4gYng7Cgl9LAoJCiAgICAKICAgICBtb3ZlIDogZnVuY3Rpb24oZGlyZWN0aW9uLCBkaXN0YW5jZSwgYW5pbWF0ZSl7CiAgICAgICAgdmFyIG1lID0gdGhpcywgICAgICAgIAkKICAgICAgICAJeHkgPSBtZS5nZXRYWSgpLAogICAgICAgIAl4ID0geHlbMF0sCiAgICAgICAgCXkgPSB4eVsxXSwgICAgICAgIAkKICAgICAgICAJbGVmdCA9IFt4IC0gZGlzdGFuY2UsIHldLAogICAgICAgIAlyaWdodCA9IFt4ICsgZGlzdGFuY2UsIHldLAogICAgICAgIAl0b3AgPSBbeCwgeSAtIGRpc3RhbmNlXSwKICAgICAgICAJYm90dG9tID0gW3gsIHkgKyBkaXN0YW5jZV0sCgkgICAgICAgCWhhc2ggPSB7CgkgICAgICAgIAlsIDoJbGVmdCwKCSAgICAgICAgCWxlZnQgOiBsZWZ0LAoJICAgICAgICAJciA6IHJpZ2h0LAoJICAgICAgICAJcmlnaHQgOiByaWdodCwKCSAgICAgICAgCXQgOiB0b3AsCgkgICAgICAgIAl0b3AgOiB0b3AsCgkgICAgICAgIAl1cCA6IHRvcCwKCSAgICAgICAgCWIgOiBib3R0b20sIAoJICAgICAgICAJYm90dG9tIDogYm90dG9tLAoJICAgICAgICAJZG93biA6IGJvdHRvbQkgICAgICAgIAkJCgkgICAgICAgIH07CiAgICAgICAgCiAJICAgIGRpcmVjdGlvbiA9IGRpcmVjdGlvbi50b0xvd2VyQ2FzZSgpOyAgICAKIAkgICAgbWUubW92ZVRvKGhhc2hbZGlyZWN0aW9uXVswXSwgaGFzaFtkaXJlY3Rpb25dWzFdLCBtZS5hbmltVGVzdC5jYWxsKG1lLCBhcmd1bWVudHMsIGFuaW1hdGUsIDIpKTsKICAgIH0sCiAgICAKICAgIAogICAgIHNldExlZnRUb3AgOiBmdW5jdGlvbihsZWZ0LCB0b3ApewoJICAgIHZhciBtZSA9IHRoaXMsCgkgICAgCXN0eWxlID0gbWUuZG9tLnN0eWxlOwogICAgICAgIHN0eWxlLmxlZnQgPSBtZS5hZGRVbml0cyhsZWZ0KTsKICAgICAgICBzdHlsZS50b3AgPSBtZS5hZGRVbml0cyh0b3ApOwogICAgICAgIHJldHVybiBtZTsKICAgIH0sCiAgICAKICAgIAogICAgZ2V0UmVnaW9uIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gRXh0LmxpYi5Eb20uZ2V0UmVnaW9uKHRoaXMuZG9tKTsKICAgIH0sCiAgICAKICAgIAogICAgc2V0Qm91bmRzIDogZnVuY3Rpb24oeCwgeSwgd2lkdGgsIGhlaWdodCwgYW5pbWF0ZSl7CgkgICAgdmFyIG1lID0gdGhpczsKICAgICAgICBpZiAoIWFuaW1hdGUgfHwgIW1lLmFuaW0pIHsKICAgICAgICAgICAgbWUuc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KTsKICAgICAgICAgICAgbWUuc2V0TG9jYXRpb24oeCwgeSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWUuYW5pbSh7cG9pbnRzOiB7dG86IFt4LCB5XX0sIAogICAgICAgICAgICAJCSB3aWR0aDoge3RvOiBtZS5hZGp1c3RXaWR0aCh3aWR0aCl9LCAKICAgICAgICAgICAgCQkgaGVpZ2h0OiB7dG86IG1lLmFkanVzdEhlaWdodChoZWlnaHQpfX0sCiAgICAgICAgICAgICAgICAgICAgIG1lLnByZWFuaW0oYXJndW1lbnRzLCA0KSwgCiAgICAgICAgICAgICAgICAgICAgICdtb3Rpb24nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lOwogICAgfSwKCiAgICAKICAgIHNldFJlZ2lvbiA6IGZ1bmN0aW9uKHJlZ2lvbiwgYW5pbWF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLnNldEJvdW5kcyhyZWdpb24ubGVmdCwgcmVnaW9uLnRvcCwgcmVnaW9uLnJpZ2h0LXJlZ2lvbi5sZWZ0LCByZWdpb24uYm90dG9tLXJlZ2lvbi50b3AsIHRoaXMuYW5pbVRlc3QuY2FsbCh0aGlzLCBhcmd1bWVudHMsIGFuaW1hdGUsIDEpKTsKICAgIH0KfSk7CkV4dC5FbGVtZW50LmFkZE1ldGhvZHMoewogICAgCiAgICBzY3JvbGxUbyA6IGZ1bmN0aW9uKHNpZGUsIHZhbHVlLCBhbmltYXRlKSB7CiAgICAgICAgCiAgICAgICAgdmFyIHRvcCA9IC90b3AvaS50ZXN0KHNpZGUpLAogICAgICAgICAgICBtZSA9IHRoaXMsCiAgICAgICAgICAgIGRvbSA9IG1lLmRvbSwKICAgICAgICAgICAgcHJvcDsKICAgICAgICBpZiAoIWFuaW1hdGUgfHwgIW1lLmFuaW0pIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHByb3AgPSAnc2Nyb2xsJyArICh0b3AgPyAnVG9wJyA6ICdMZWZ0Jyk7CiAgICAgICAgICAgIGRvbVtwcm9wXSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHByb3AgPSAnc2Nyb2xsJyArICh0b3AgPyAnTGVmdCcgOiAnVG9wJyk7CiAgICAgICAgICAgIG1lLmFuaW0oe3Njcm9sbDoge3RvOiB0b3AgPyBbZG9tW3Byb3BdLCB2YWx1ZV0gOiBbdmFsdWUsIGRvbVtwcm9wXV19fSwgbWUucHJlYW5pbShhcmd1bWVudHMsIDIpLCAnc2Nyb2xsJyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZTsKICAgIH0sCiAgICAKICAgIAogICAgc2Nyb2xsSW50b1ZpZXcgOiBmdW5jdGlvbihjb250YWluZXIsIGhzY3JvbGwpIHsKICAgICAgICB2YXIgYyA9IEV4dC5nZXREb20oY29udGFpbmVyKSB8fCBFeHQuZ2V0Qm9keSgpLmRvbSwKICAgICAgICAgICAgZWwgPSB0aGlzLmRvbSwKICAgICAgICAgICAgbyA9IHRoaXMuZ2V0T2Zmc2V0c1RvKGMpLAogICAgICAgICAgICBsID0gb1swXSArIGMuc2Nyb2xsTGVmdCwKICAgICAgICAgICAgdCA9IG9bMV0gKyBjLnNjcm9sbFRvcCwKICAgICAgICAgICAgYiA9IHQgKyBlbC5vZmZzZXRIZWlnaHQsCiAgICAgICAgICAgIHIgPSBsICsgZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgIGNoID0gYy5jbGllbnRIZWlnaHQsCiAgICAgICAgICAgIGN0ID0gcGFyc2VJbnQoYy5zY3JvbGxUb3AsIDEwKSwKICAgICAgICAgICAgY2wgPSBwYXJzZUludChjLnNjcm9sbExlZnQsIDEwKSwKICAgICAgICAgICAgY2IgPSBjdCArIGNoLAogICAgICAgICAgICBjciA9IGNsICsgYy5jbGllbnRXaWR0aDsKCiAgICAgICAgaWYgKGVsLm9mZnNldEhlaWdodCA+IGNoIHx8IHQgPCBjdCkgewogICAgICAgICAgICBjLnNjcm9sbFRvcCA9IHQ7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGIgPiBjYikgewogICAgICAgICAgICBjLnNjcm9sbFRvcCA9IGItY2g7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGMuc2Nyb2xsVG9wID0gYy5zY3JvbGxUb3A7CgogICAgICAgIGlmIChoc2Nyb2xsICE9PSBmYWxzZSkgewogICAgICAgICAgICBpZiAoZWwub2Zmc2V0V2lkdGggPiBjLmNsaWVudFdpZHRoIHx8IGwgPCBjbCkgewogICAgICAgICAgICAgICAgYy5zY3JvbGxMZWZ0ID0gbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChyID4gY3IpIHsKICAgICAgICAgICAgICAgIGMuc2Nyb2xsTGVmdCA9IHIgLSBjLmNsaWVudFdpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGMuc2Nyb2xsTGVmdCA9IGMuc2Nyb2xsTGVmdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgc2Nyb2xsQ2hpbGRJbnRvVmlldyA6IGZ1bmN0aW9uKGNoaWxkLCBoc2Nyb2xsKSB7CiAgICAgICAgRXh0LmZseShjaGlsZCwgJ19zY3JvbGxDaGlsZEludG9WaWV3Jykuc2Nyb2xsSW50b1ZpZXcodGhpcywgaHNjcm9sbCk7CiAgICB9LAogICAgCiAgICAKICAgICBzY3JvbGwgOiBmdW5jdGlvbihkaXJlY3Rpb24sIGRpc3RhbmNlLCBhbmltYXRlKSB7CiAgICAgICAgaWYgKCF0aGlzLmlzU2Nyb2xsYWJsZSgpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGVsID0gdGhpcy5kb20sCiAgICAgICAgICAgIGwgPSBlbC5zY3JvbGxMZWZ0LCB0ID0gZWwuc2Nyb2xsVG9wLAogICAgICAgICAgICB3ID0gZWwuc2Nyb2xsV2lkdGgsIGggPSBlbC5zY3JvbGxIZWlnaHQsCiAgICAgICAgICAgIGN3ID0gZWwuY2xpZW50V2lkdGgsIGNoID0gZWwuY2xpZW50SGVpZ2h0LAogICAgICAgICAgICBzY3JvbGxlZCA9IGZhbHNlLCB2LAogICAgICAgICAgICBoYXNoID0gewogICAgICAgICAgICAgICAgbDogTWF0aC5taW4obCArIGRpc3RhbmNlLCB3LWN3KSwKICAgICAgICAgICAgICAgIHI6IHYgPSBNYXRoLm1heChsIC0gZGlzdGFuY2UsIDApLAogICAgICAgICAgICAgICAgdDogTWF0aC5tYXgodCAtIGRpc3RhbmNlLCAwKSwKICAgICAgICAgICAgICAgIGI6IE1hdGgubWluKHQgKyBkaXN0YW5jZSwgaC1jaCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaGFzaC5kID0gaGFzaC5iOwogICAgICAgICAgICBoYXNoLnUgPSBoYXNoLnQ7CiAgICAgICAgCiAgICAgICAgZGlyZWN0aW9uID0gZGlyZWN0aW9uLnN1YnN0cigwLCAxKTsKICAgICAgICBpZiAoKHYgPSBoYXNoW2RpcmVjdGlvbl0pID4gLTEpIHsKICAgICAgICAgICAgc2Nyb2xsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnNjcm9sbFRvKGRpcmVjdGlvbiA9PSAnbCcgfHwgZGlyZWN0aW9uID09ICdyJyA/ICdsZWZ0JyA6ICd0b3AnLCB2LCB0aGlzLnByZWFuaW0oYXJndW1lbnRzLCAyKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzY3JvbGxlZDsKICAgIH0KfSk7CkV4dC5FbGVtZW50LmFkZE1ldGhvZHMoCiAgICBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgVklTSUJJTElUWSAgICAgID0gInZpc2liaWxpdHkiLAogICAgICAgICAgICBESVNQTEFZICAgICAgICAgPSAiZGlzcGxheSIsCiAgICAgICAgICAgIEhJRERFTiAgICAgICAgICA9ICJoaWRkZW4iLAogICAgICAgICAgICBOT05FICAgICAgICAgICAgPSAibm9uZSIsCiAgICAgICAgICAgIFhNQVNLRUQgICAgICAgICA9ICJ4LW1hc2tlZCIsCiAgICAgICAgICAgIFhNQVNLRURSRUxBVElWRSA9ICJ4LW1hc2tlZC1yZWxhdGl2ZSIsCiAgICAgICAgICAgIGRhdGEgICAgICAgICAgICA9IEV4dC5FbGVtZW50LmRhdGE7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIAogICAgICAgICAgICBpc1Zpc2libGUgOiBmdW5jdGlvbihkZWVwKSB7CiAgICAgICAgICAgICAgICB2YXIgdmlzID0gIXRoaXMuaXNTdHlsZShWSVNJQklMSVRZLCBISURERU4pICYmICF0aGlzLmlzU3R5bGUoRElTUExBWSwgTk9ORSksCiAgICAgICAgICAgICAgICAgICAgcCAgID0gdGhpcy5kb20ucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGRlZXAgIT09IHRydWUgfHwgIXZpcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2aXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHdoaWxlIChwICYmICEoL15ib2R5L2kudGVzdChwLnRhZ05hbWUpKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghRXh0LmZseShwLCAnX2lzVmlzaWJsZScpLmlzVmlzaWJsZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcCA9IHAucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgCiAgICAgICAgICAgIGlzRGlzcGxheWVkIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIXRoaXMuaXNTdHlsZShESVNQTEFZLCBOT05FKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIAogICAgICAgICAgICBlbmFibGVEaXNwbGF5TW9kZSA6IGZ1bmN0aW9uKGRpc3BsYXkpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0VmlzaWJpbGl0eU1vZGUoRXh0LkVsZW1lbnQuRElTUExBWSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghRXh0LmlzRW1wdHkoZGlzcGxheSkpIHsKICAgICAgICAgICAgICAgICAgICBkYXRhKHRoaXMuZG9tLCAnb3JpZ2luYWxEaXNwbGF5JywgZGlzcGxheSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgCiAgICAgICAgICAgIG1hc2sgOiBmdW5jdGlvbihtc2csIG1zZ0NscykgewogICAgICAgICAgICAgICAgdmFyIG1lICA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgZG9tID0gbWUuZG9tLAogICAgICAgICAgICAgICAgICAgIGRoICA9IEV4dC5Eb21IZWxwZXIsCiAgICAgICAgICAgICAgICAgICAgRVhURUxNQVNLTVNHID0gImV4dC1lbC1tYXNrLW1zZyIsCiAgICAgICAgICAgICAgICAgICAgZWwsCiAgICAgICAgICAgICAgICAgICAgbWFzazsKCiAgICAgICAgICAgICAgICBpZiAoIS9eYm9keS9pLnRlc3QoZG9tLnRhZ05hbWUpICYmIG1lLmdldFN0eWxlKCdwb3NpdGlvbicpID09ICdzdGF0aWMnKSB7CiAgICAgICAgICAgICAgICAgICAgbWUuYWRkQ2xhc3MoWE1BU0tFRFJFTEFUSVZFKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlbCA9IGRhdGEoZG9tLCAnbWFza01zZycpKSB7CiAgICAgICAgICAgICAgICAgICAgZWwucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZWwgPSBkYXRhKGRvbSwgJ21hc2snKSkgewogICAgICAgICAgICAgICAgICAgIGVsLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG1hc2sgPSBkaC5hcHBlbmQoZG9tLCB7Y2xzIDogImV4dC1lbC1tYXNrIn0sIHRydWUpOwogICAgICAgICAgICAgICAgZGF0YShkb20sICdtYXNrJywgbWFzayk7CgogICAgICAgICAgICAgICAgbWUuYWRkQ2xhc3MoWE1BU0tFRCk7CiAgICAgICAgICAgICAgICBtYXNrLnNldERpc3BsYXllZCh0cnVlKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtc2cgPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbW0gPSBkaC5hcHBlbmQoZG9tLCB7Y2xzIDogRVhURUxNQVNLTVNHLCBjbjp7dGFnOidkaXYnfX0sIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGRhdGEoZG9tLCAnbWFza01zZycsIG1tKTsKICAgICAgICAgICAgICAgICAgICBtbS5kb20uY2xhc3NOYW1lID0gbXNnQ2xzID8gRVhURUxNQVNLTVNHICsgIiAiICsgbXNnQ2xzIDogRVhURUxNQVNLTVNHOwogICAgICAgICAgICAgICAgICAgIG1tLmRvbS5maXJzdENoaWxkLmlubmVySFRNTCA9IG1zZzsKICAgICAgICAgICAgICAgICAgICBtbS5zZXREaXNwbGF5ZWQodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgbW0uY2VudGVyKG1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoRXh0LmlzSUUgJiYgIShFeHQuaXNJRTcgJiYgRXh0LmlzU3RyaWN0KSAmJiBtZS5nZXRTdHlsZSgnaGVpZ2h0JykgPT0gJ2F1dG8nKSB7CiAgICAgICAgICAgICAgICAgICAgbWFzay5zZXRTaXplKHVuZGVmaW5lZCwgbWUuZ2V0SGVpZ2h0KCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gbWFzazsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIAogICAgICAgICAgICB1bm1hc2sgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBtZSAgICAgID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBkb20gICAgID0gbWUuZG9tLAogICAgICAgICAgICAgICAgICAgIG1hc2sgICAgPSBkYXRhKGRvbSwgJ21hc2snKSwKICAgICAgICAgICAgICAgICAgICBtYXNrTXNnID0gZGF0YShkb20sICdtYXNrTXNnJyk7CgogICAgICAgICAgICAgICAgaWYgKG1hc2spIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWFza01zZykgewogICAgICAgICAgICAgICAgICAgICAgICBtYXNrTXNnLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBkYXRhKGRvbSwgJ21hc2tNc2cnLCB1bmRlZmluZWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBtYXNrLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIGRhdGEoZG9tLCAnbWFzaycsIHVuZGVmaW5lZCk7CiAgICAgICAgICAgICAgICAgICAgbWUucmVtb3ZlQ2xhc3MoW1hNQVNLRUQsIFhNQVNLRURSRUxBVElWRV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgCiAgICAgICAgICAgIGlzTWFza2VkIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgbSA9IGRhdGEodGhpcy5kb20sICdtYXNrJyk7CiAgICAgICAgICAgICAgICByZXR1cm4gbSAmJiBtLmlzVmlzaWJsZSgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgCiAgICAgICAgICAgIGNyZWF0ZVNoaW0gOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpLAogICAgICAgICAgICAgICAgICAgIHNoaW07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVsLmZyYW1lQm9yZGVyID0gJzAnOwogICAgICAgICAgICAgICAgZWwuY2xhc3NOYW1lID0gJ2V4dC1zaGltJzsKICAgICAgICAgICAgICAgIGVsLnNyYyA9IEV4dC5TU0xfU0VDVVJFX1VSTDsKICAgICAgICAgICAgICAgIHNoaW0gPSBFeHQuZ2V0KHRoaXMuZG9tLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGVsLCB0aGlzLmRvbSkpOwogICAgICAgICAgICAgICAgc2hpbS5hdXRvQm94QWRqdXN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm4gc2hpbTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KCkKKTsKRXh0LkVsZW1lbnQuYWRkTWV0aG9kcyh7CiAgICAKICAgIGFkZEtleUxpc3RlbmVyIDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpewogICAgICAgIHZhciBjb25maWc7CiAgICAgICAgaWYodHlwZW9mIGtleSAhPSAnb2JqZWN0JyB8fCBFeHQuaXNBcnJheShrZXkpKXsKICAgICAgICAgICAgY29uZmlnID0gewogICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICBmbjogZm4sCiAgICAgICAgICAgICAgICBzY29wZTogc2NvcGUKICAgICAgICAgICAgfTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgY29uZmlnID0gewogICAgICAgICAgICAgICAga2V5IDoga2V5LmtleSwKICAgICAgICAgICAgICAgIHNoaWZ0IDoga2V5LnNoaWZ0LAogICAgICAgICAgICAgICAgY3RybCA6IGtleS5jdHJsLAogICAgICAgICAgICAgICAgYWx0IDoga2V5LmFsdCwKICAgICAgICAgICAgICAgIGZuOiBmbiwKICAgICAgICAgICAgICAgIHNjb3BlOiBzY29wZQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEV4dC5LZXlNYXAodGhpcywgY29uZmlnKTsKICAgIH0sCgogICAgCiAgICBhZGRLZXlNYXAgOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIHJldHVybiBuZXcgRXh0LktleU1hcCh0aGlzLCBjb25maWcpOwogICAgfQp9KTsKCgoKRXh0LkNvbXBvc2l0ZUVsZW1lbnRMaXRlLmltcG9ydEVsZW1lbnRNZXRob2RzKCk7CkV4dC5hcHBseShFeHQuQ29tcG9zaXRlRWxlbWVudExpdGUucHJvdG90eXBlLCB7CiAgICBhZGRFbGVtZW50cyA6IGZ1bmN0aW9uKGVscywgcm9vdCl7CiAgICAgICAgaWYoIWVscyl7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBpZih0eXBlb2YgZWxzID09ICJzdHJpbmciKXsKICAgICAgICAgICAgZWxzID0gRXh0LkVsZW1lbnQuc2VsZWN0b3JGdW5jdGlvbihlbHMsIHJvb3QpOwogICAgICAgIH0KICAgICAgICB2YXIgeWVscyA9IHRoaXMuZWxlbWVudHM7CiAgICAgICAgRXh0LmVhY2goZWxzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHllbHMucHVzaChFeHQuZ2V0KGUpKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBmaXJzdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuaXRlbSgwKTsKICAgIH0sCgogICAgCiAgICBsYXN0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pdGVtKHRoaXMuZ2V0Q291bnQoKS0xKTsKICAgIH0sCgogICAgCiAgICBjb250YWlucyA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICByZXR1cm4gdGhpcy5pbmRleE9mKGVsKSAhPSAtMTsKICAgIH0sCgogICAgCiAgICByZW1vdmVFbGVtZW50IDogZnVuY3Rpb24oa2V5cywgcmVtb3ZlRG9tKXsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBlbHMgPSB0aGlzLmVsZW1lbnRzLAogICAgICAgICAgICBlbDsKICAgICAgICBFeHQuZWFjaChrZXlzLCBmdW5jdGlvbih2YWwpewogICAgICAgICAgICBpZiAoKGVsID0gKGVsc1t2YWxdIHx8IGVsc1t2YWwgPSBtZS5pbmRleE9mKHZhbCldKSkpIHsKICAgICAgICAgICAgICAgIGlmKHJlbW92ZURvbSl7CiAgICAgICAgICAgICAgICAgICAgaWYoZWwuZG9tKXsKICAgICAgICAgICAgICAgICAgICAgICAgZWwucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIEV4dC5yZW1vdmVOb2RlKGVsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHMuc3BsaWNlKHZhbCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KfSk7CgpFeHQuQ29tcG9zaXRlRWxlbWVudCA9IEV4dC5leHRlbmQoRXh0LkNvbXBvc2l0ZUVsZW1lbnRMaXRlLCB7CiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oZWxzLCByb290KXsKICAgICAgICB0aGlzLmVsZW1lbnRzID0gW107CiAgICAgICAgdGhpcy5hZGQoZWxzLCByb290KTsKICAgIH0sCiAgICAKICAgIAogICAgZ2V0RWxlbWVudCA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICAKICAgICAgICByZXR1cm4gZWw7CiAgICB9LAogICAgCiAgICAKICAgIHRyYW5zZm9ybUVsZW1lbnQgOiBmdW5jdGlvbihlbCl7CiAgICAgICAgcmV0dXJuIEV4dC5nZXQoZWwpOwogICAgfQoKICAgIAoKICAgIAoKICAgIAp9KTsKCgpFeHQuRWxlbWVudC5zZWxlY3QgPSBmdW5jdGlvbihzZWxlY3RvciwgdW5pcXVlLCByb290KXsKICAgIHZhciBlbHM7CiAgICBpZih0eXBlb2Ygc2VsZWN0b3IgPT0gInN0cmluZyIpewogICAgICAgIGVscyA9IEV4dC5FbGVtZW50LnNlbGVjdG9yRnVuY3Rpb24oc2VsZWN0b3IsIHJvb3QpOwogICAgfWVsc2UgaWYoc2VsZWN0b3IubGVuZ3RoICE9PSB1bmRlZmluZWQpewogICAgICAgIGVscyA9IHNlbGVjdG9yOwogICAgfWVsc2V7CiAgICAgICAgdGhyb3cgIkludmFsaWQgc2VsZWN0b3IiOwogICAgfQoKICAgIHJldHVybiAodW5pcXVlID09PSB0cnVlKSA/IG5ldyBFeHQuQ29tcG9zaXRlRWxlbWVudChlbHMpIDogbmV3IEV4dC5Db21wb3NpdGVFbGVtZW50TGl0ZShlbHMpOwp9OwoKCkV4dC5zZWxlY3QgPSBFeHQuRWxlbWVudC5zZWxlY3Q7CkV4dC5VcGRhdGVNYW5hZ2VyID0gRXh0LlVwZGF0ZXIgPSBFeHQuZXh0ZW5kKEV4dC51dGlsLk9ic2VydmFibGUsCmZ1bmN0aW9uKCkgewogICAgdmFyIEJFRk9SRVVQREFURSA9ICJiZWZvcmV1cGRhdGUiLAogICAgICAgIFVQREFURSA9ICJ1cGRhdGUiLAogICAgICAgIEZBSUxVUkUgPSAiZmFpbHVyZSI7CgogICAgCiAgICBmdW5jdGlvbiBwcm9jZXNzU3VjY2VzcyhyZXNwb25zZSl7CiAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICBtZS50cmFuc2FjdGlvbiA9IG51bGw7CiAgICAgICAgaWYgKHJlc3BvbnNlLmFyZ3VtZW50LmZvcm0gJiYgcmVzcG9uc2UuYXJndW1lbnQucmVzZXQpIHsKICAgICAgICAgICAgdHJ5IHsgCiAgICAgICAgICAgICAgICByZXNwb25zZS5hcmd1bWVudC5mb3JtLnJlc2V0KCk7CiAgICAgICAgICAgIH0gY2F0Y2goZSl7fQogICAgICAgIH0KICAgICAgICBpZiAobWUubG9hZFNjcmlwdHMpIHsKICAgICAgICAgICAgbWUucmVuZGVyZXIucmVuZGVyKG1lLmVsLCByZXNwb25zZSwgbWUsCiAgICAgICAgICAgICAgIHVwZGF0ZUNvbXBsZXRlLmNyZWF0ZURlbGVnYXRlKG1lLCBbcmVzcG9uc2VdKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWUucmVuZGVyZXIucmVuZGVyKG1lLmVsLCByZXNwb25zZSwgbWUpOwogICAgICAgICAgICB1cGRhdGVDb21wbGV0ZS5jYWxsKG1lLCByZXNwb25zZSk7CiAgICAgICAgfQogICAgfQoKICAgIAogICAgZnVuY3Rpb24gdXBkYXRlQ29tcGxldGUocmVzcG9uc2UsIHR5cGUsIHN1Y2Nlc3MpewogICAgICAgIHRoaXMuZmlyZUV2ZW50KHR5cGUgfHwgVVBEQVRFLCB0aGlzLmVsLCByZXNwb25zZSk7CiAgICAgICAgaWYoRXh0LmlzRnVuY3Rpb24ocmVzcG9uc2UuYXJndW1lbnQuY2FsbGJhY2spKXsKICAgICAgICAgICAgcmVzcG9uc2UuYXJndW1lbnQuY2FsbGJhY2suY2FsbChyZXNwb25zZS5hcmd1bWVudC5zY29wZSwgdGhpcy5lbCwgRXh0LmlzRW1wdHkoc3VjY2VzcykgPyB0cnVlIDogZmFsc2UsIHJlc3BvbnNlLCByZXNwb25zZS5hcmd1bWVudC5vcHRpb25zKTsKICAgICAgICB9CiAgICB9CgogICAgCiAgICBmdW5jdGlvbiBwcm9jZXNzRmFpbHVyZShyZXNwb25zZSl7CiAgICAgICAgdXBkYXRlQ29tcGxldGUuY2FsbCh0aGlzLCByZXNwb25zZSwgRkFJTFVSRSwgISEodGhpcy50cmFuc2FjdGlvbiA9IG51bGwpKTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihlbCwgZm9yY2VOZXcpewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgICAgICBlbCA9IEV4dC5nZXQoZWwpOwogICAgICAgICAgICBpZighZm9yY2VOZXcgJiYgZWwudXBkYXRlTWFuYWdlcil7CiAgICAgICAgICAgICAgICByZXR1cm4gZWwudXBkYXRlTWFuYWdlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgbWUuZWwgPSBlbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIG1lLmRlZmF1bHRVcmwgPSBudWxsOwoKICAgICAgICAgICAgbWUuYWRkRXZlbnRzKAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBCRUZPUkVVUERBVEUsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIFVQREFURSwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgRkFJTFVSRQogICAgICAgICAgICApOwoKICAgICAgICAgICAgRXh0LmFwcGx5KG1lLCBFeHQuVXBkYXRlci5kZWZhdWx0cyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCgogICAgICAgICAgICAKICAgICAgICAgICAgbWUudHJhbnNhY3Rpb24gPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgbWUucmVmcmVzaERlbGVnYXRlID0gbWUucmVmcmVzaC5jcmVhdGVEZWxlZ2F0ZShtZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBtZS51cGRhdGVEZWxlZ2F0ZSA9IG1lLnVwZGF0ZS5jcmVhdGVEZWxlZ2F0ZShtZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBtZS5mb3JtVXBkYXRlRGVsZWdhdGUgPSAobWUuZm9ybVVwZGF0ZSB8fCBmdW5jdGlvbigpe30pLmNyZWF0ZURlbGVnYXRlKG1lKTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBtZS5yZW5kZXJlciA9IG1lLnJlbmRlcmVyIHx8IG1lLmdldERlZmF1bHRSZW5kZXJlcigpOwoKICAgICAgICAgICAgRXh0LlVwZGF0ZXIuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKG1lKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBzZXRSZW5kZXJlciA6IGZ1bmN0aW9uKHJlbmRlcmVyKXsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldFJlbmRlcmVyIDogZnVuY3Rpb24oKXsKICAgICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJlcjsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXREZWZhdWx0UmVuZGVyZXI6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbmV3IEV4dC5VcGRhdGVyLkJhc2ljUmVuZGVyZXIoKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBzZXREZWZhdWx0VXJsIDogZnVuY3Rpb24oZGVmYXVsdFVybCl7CiAgICAgICAgICAgIHRoaXMuZGVmYXVsdFVybCA9IGRlZmF1bHRVcmw7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0RWwgOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gdGhpcy5lbDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICB1cGRhdGUgOiBmdW5jdGlvbih1cmwsIHBhcmFtcywgY2FsbGJhY2ssIGRpc2NhcmRVcmwpewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICAgICAgY2ZnLAogICAgICAgICAgICAgICAgY2FsbGVyU2NvcGU7CgogICAgICAgICAgICBpZihtZS5maXJlRXZlbnQoQkVGT1JFVVBEQVRFLCBtZS5lbCwgdXJsLCBwYXJhbXMpICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICBpZihFeHQuaXNPYmplY3QodXJsKSl7IAogICAgICAgICAgICAgICAgICAgIGNmZyA9IHVybDsKICAgICAgICAgICAgICAgICAgICB1cmwgPSBjZmcudXJsOwogICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCBjZmcucGFyYW1zOwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgY2ZnLmNhbGxiYWNrOwogICAgICAgICAgICAgICAgICAgIGRpc2NhcmRVcmwgPSBkaXNjYXJkVXJsIHx8IGNmZy5kaXNjYXJkVXJsOwogICAgICAgICAgICAgICAgICAgIGNhbGxlclNjb3BlID0gY2ZnLnNjb3BlOwogICAgICAgICAgICAgICAgICAgIGlmKCFFeHQuaXNFbXB0eShjZmcubm9jYWNoZSkpe21lLmRpc2FibGVDYWNoaW5nID0gY2ZnLm5vY2FjaGU7fTsKICAgICAgICAgICAgICAgICAgICBpZighRXh0LmlzRW1wdHkoY2ZnLnRleHQpKXttZS5pbmRpY2F0b3JUZXh0ID0gJzxkaXYgY2xhc3M9ImxvYWRpbmctaW5kaWNhdG9yIj4nK2NmZy50ZXh0KyI8L2Rpdj4iO307CiAgICAgICAgICAgICAgICAgICAgaWYoIUV4dC5pc0VtcHR5KGNmZy5zY3JpcHRzKSl7bWUubG9hZFNjcmlwdHMgPSBjZmcuc2NyaXB0czt9OwogICAgICAgICAgICAgICAgICAgIGlmKCFFeHQuaXNFbXB0eShjZmcudGltZW91dCkpe21lLnRpbWVvdXQgPSBjZmcudGltZW91dDt9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbWUuc2hvd0xvYWRpbmcoKTsKCiAgICAgICAgICAgICAgICBpZighZGlzY2FyZFVybCl7CiAgICAgICAgICAgICAgICAgICAgbWUuZGVmYXVsdFVybCA9IHVybDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKEV4dC5pc0Z1bmN0aW9uKHVybCkpewogICAgICAgICAgICAgICAgICAgIHVybCA9IHVybC5jYWxsKG1lKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgbyA9IEV4dC5hcHBseSh7fSwgewogICAgICAgICAgICAgICAgICAgIHVybCA6IHVybCwKICAgICAgICAgICAgICAgICAgICBwYXJhbXM6IChFeHQuaXNGdW5jdGlvbihwYXJhbXMpICYmIGNhbGxlclNjb3BlKSA/IHBhcmFtcy5jcmVhdGVEZWxlZ2F0ZShjYWxsZXJTY29wZSkgOiBwYXJhbXMsCiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogcHJvY2Vzc1N1Y2Nlc3MsCiAgICAgICAgICAgICAgICAgICAgZmFpbHVyZTogcHJvY2Vzc0ZhaWx1cmUsCiAgICAgICAgICAgICAgICAgICAgc2NvcGU6IG1lLAogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgdGltZW91dDogKG1lLnRpbWVvdXQqMTAwMCksCiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZUNhY2hpbmc6IG1lLmRpc2FibGVDYWNoaW5nLAogICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJvcHRpb25zIjogY2ZnLAogICAgICAgICAgICAgICAgICAgICAgICAidXJsIjogdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9ybSI6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsYmFjayI6IGNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgICAgICAic2NvcGUiOiBjYWxsZXJTY29wZSB8fCB3aW5kb3csCiAgICAgICAgICAgICAgICAgICAgICAgICJwYXJhbXMiOiBwYXJhbXMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBjZmcpOwoKICAgICAgICAgICAgICAgIG1lLnRyYW5zYWN0aW9uID0gRXh0LkFqYXgucmVxdWVzdChvKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGZvcm1VcGRhdGUgOiBmdW5jdGlvbihmb3JtLCB1cmwsIHJlc2V0LCBjYWxsYmFjayl7CiAgICAgICAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgICAgICAgIGlmKG1lLmZpcmVFdmVudChCRUZPUkVVUERBVEUsIG1lLmVsLCBmb3JtLCB1cmwpICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICBpZihFeHQuaXNGdW5jdGlvbih1cmwpKXsKICAgICAgICAgICAgICAgICAgICB1cmwgPSB1cmwuY2FsbChtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3JtID0gRXh0LmdldERvbShmb3JtKTsKICAgICAgICAgICAgICAgIG1lLnRyYW5zYWN0aW9uID0gRXh0LkFqYXgucmVxdWVzdCh7CiAgICAgICAgICAgICAgICAgICAgZm9ybTogZm9ybSwKICAgICAgICAgICAgICAgICAgICB1cmw6dXJsLAogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHByb2Nlc3NTdWNjZXNzLAogICAgICAgICAgICAgICAgICAgIGZhaWx1cmU6IHByb2Nlc3NGYWlsdXJlLAogICAgICAgICAgICAgICAgICAgIHNjb3BlOiBtZSwKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0OiAobWUudGltZW91dCoxMDAwKSwKICAgICAgICAgICAgICAgICAgICBhcmd1bWVudDogewogICAgICAgICAgICAgICAgICAgICAgICAidXJsIjogdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9ybSI6IGZvcm0sCiAgICAgICAgICAgICAgICAgICAgICAgICJjYWxsYmFjayI6IGNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgICAgICAicmVzZXQiOiByZXNldAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgbWUuc2hvd0xvYWRpbmcuZGVmZXIoMSwgbWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgc3RhcnRBdXRvUmVmcmVzaCA6IGZ1bmN0aW9uKGludGVydmFsLCB1cmwsIHBhcmFtcywgY2FsbGJhY2ssIHJlZnJlc2hOb3cpewogICAgICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgICAgICBpZihyZWZyZXNoTm93KXsKICAgICAgICAgICAgICAgIG1lLnVwZGF0ZSh1cmwgfHwgbWUuZGVmYXVsdFVybCwgcGFyYW1zLCBjYWxsYmFjaywgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobWUuYXV0b1JlZnJlc2hQcm9jSWQpewogICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChtZS5hdXRvUmVmcmVzaFByb2NJZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWUuYXV0b1JlZnJlc2hQcm9jSWQgPSBzZXRJbnRlcnZhbChtZS51cGRhdGUuY3JlYXRlRGVsZWdhdGUobWUsIFt1cmwgfHwgbWUuZGVmYXVsdFVybCwgcGFyYW1zLCBjYWxsYmFjaywgdHJ1ZV0pLCBpbnRlcnZhbCAqIDEwMDApOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHN0b3BBdXRvUmVmcmVzaCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmKHRoaXMuYXV0b1JlZnJlc2hQcm9jSWQpewogICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmF1dG9SZWZyZXNoUHJvY0lkKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmF1dG9SZWZyZXNoUHJvY0lkOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaXNBdXRvUmVmcmVzaGluZyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgcmV0dXJuICEhdGhpcy5hdXRvUmVmcmVzaFByb2NJZDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBzaG93TG9hZGluZyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmKHRoaXMuc2hvd0xvYWRJbmRpY2F0b3IpewogICAgICAgICAgICAgICAgdGhpcy5lbC5kb20uaW5uZXJIVE1MID0gdGhpcy5pbmRpY2F0b3JUZXh0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgYWJvcnQgOiBmdW5jdGlvbigpewogICAgICAgICAgICBpZih0aGlzLnRyYW5zYWN0aW9uKXsKICAgICAgICAgICAgICAgIEV4dC5BamF4LmFib3J0KHRoaXMudHJhbnNhY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaXNVcGRhdGluZyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRyYW5zYWN0aW9uID8gRXh0LkFqYXguaXNMb2FkaW5nKHRoaXMudHJhbnNhY3Rpb24pIDogZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcmVmcmVzaCA6IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgICAgICAgaWYodGhpcy5kZWZhdWx0VXJsKXsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKHRoaXMuZGVmYXVsdFVybCwgbnVsbCwgY2FsbGJhY2ssIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfSgpKTsKCgpFeHQuVXBkYXRlci5kZWZhdWx0cyA9IHsKICAgCiAgICB0aW1lb3V0IDogMzAsCiAgICAKICAgIGRpc2FibGVDYWNoaW5nIDogZmFsc2UsCiAgICAKICAgIHNob3dMb2FkSW5kaWNhdG9yIDogdHJ1ZSwKICAgIAogICAgaW5kaWNhdG9yVGV4dCA6ICc8ZGl2IGNsYXNzPSJsb2FkaW5nLWluZGljYXRvciI+TG9hZGluZy4uLjwvZGl2PicsCiAgICAgCiAgICBsb2FkU2NyaXB0cyA6IGZhbHNlLAogICAgCiAgICBzc2xCbGFua1VybCA6IEV4dC5TU0xfU0VDVVJFX1VSTAp9OwoKCgpFeHQuVXBkYXRlci51cGRhdGVFbGVtZW50ID0gZnVuY3Rpb24oZWwsIHVybCwgcGFyYW1zLCBvcHRpb25zKXsKICAgIHZhciB1bSA9IEV4dC5nZXQoZWwpLmdldFVwZGF0ZXIoKTsKICAgIEV4dC5hcHBseSh1bSwgb3B0aW9ucyk7CiAgICB1bS51cGRhdGUodXJsLCBwYXJhbXMsIG9wdGlvbnMgPyBvcHRpb25zLmNhbGxiYWNrIDogbnVsbCk7Cn07CgoKRXh0LlVwZGF0ZXIuQmFzaWNSZW5kZXJlciA9IGZ1bmN0aW9uKCl7fTsKCkV4dC5VcGRhdGVyLkJhc2ljUmVuZGVyZXIucHJvdG90eXBlID0gewogICAgCiAgICAgcmVuZGVyIDogZnVuY3Rpb24oZWwsIHJlc3BvbnNlLCB1cGRhdGVNYW5hZ2VyLCBjYWxsYmFjayl7CiAgICAgICAgZWwudXBkYXRlKHJlc3BvbnNlLnJlc3BvbnNlVGV4dCwgdXBkYXRlTWFuYWdlci5sb2FkU2NyaXB0cywgY2FsbGJhY2spOwogICAgfQp9OwoKCgooZnVuY3Rpb24oKSB7CgoKRGF0ZS51c2VTdHJpY3QgPSBmYWxzZTsKCgoKCgpmdW5jdGlvbiB4Zihmb3JtYXQpIHsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBmb3JtYXQucmVwbGFjZSgvXHsoXGQrKVx9L2csIGZ1bmN0aW9uKG0sIGkpIHsKICAgICAgICByZXR1cm4gYXJnc1tpXTsKICAgIH0pOwp9CgoKCkRhdGUuZm9ybWF0Q29kZVRvUmVnZXggPSBmdW5jdGlvbihjaGFyYWN0ZXIsIGN1cnJlbnRHcm91cCkgewogICAgCiAgICB2YXIgcCA9IERhdGUucGFyc2VDb2Rlc1tjaGFyYWN0ZXJdOwoKICAgIGlmIChwKSB7CiAgICAgIHAgPSB0eXBlb2YgcCA9PSAnZnVuY3Rpb24nPyBwKCkgOiBwOwogICAgICBEYXRlLnBhcnNlQ29kZXNbY2hhcmFjdGVyXSA9IHA7IAogICAgfQoKICAgIHJldHVybiBwID8gRXh0LmFwcGx5SWYoewogICAgICBjOiBwLmMgPyB4ZihwLmMsIGN1cnJlbnRHcm91cCB8fCAiezB9IikgOiBwLmMKICAgIH0sIHApIDogewogICAgICAgIGc6MCwKICAgICAgICBjOm51bGwsCiAgICAgICAgczpFeHQuZXNjYXBlUmUoY2hhcmFjdGVyKSAKICAgIH07Cn07CgoKdmFyICRmID0gRGF0ZS5mb3JtYXRDb2RlVG9SZWdleDsKCkV4dC5hcHBseShEYXRlLCB7CiAgICAKICAgIHBhcnNlRnVuY3Rpb25zOiB7CiAgICAgICAgIk0kIjogZnVuY3Rpb24oaW5wdXQsIHN0cmljdCkgewogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciByZSA9IG5ldyBSZWdFeHAoJ1xcL0RhdGVcXCgoWy0rXSk/KFxcZCspKD86WystXVxcZHs0fSk/XFwpXFwvJyk7CiAgICAgICAgICAgIHZhciByID0gKGlucHV0IHx8ICcnKS5tYXRjaChyZSk7CiAgICAgICAgICAgIHJldHVybiByPyBuZXcgRGF0ZSgoKHJbMV0gfHwgJycpICsgclsyXSkgKiAxKSA6IG51bGw7CiAgICAgICAgfQogICAgfSwKICAgIHBhcnNlUmVnZXhlczogW10sCgogICAgCiAgICBmb3JtYXRGdW5jdGlvbnM6IHsKICAgICAgICAiTSQiOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiAnXFwvRGF0ZSgnICsgdGhpcy5nZXRUaW1lKCkgKyAnKVxcLyc7CiAgICAgICAgfQogICAgfSwKCiAgICB5MmtZZWFyIDogNTAsCgogICAgCiAgICBNSUxMSSA6ICJtcyIsCgogICAgCiAgICBTRUNPTkQgOiAicyIsCgogICAgCiAgICBNSU5VVEUgOiAibWkiLAoKICAgIAogICAgSE9VUiA6ICJoIiwKCiAgICAKICAgIERBWSA6ICJkIiwKCiAgICAKICAgIE1PTlRIIDogIm1vIiwKCiAgICAKICAgIFlFQVIgOiAieSIsCgogICAgCiAgICBkZWZhdWx0czoge30sCgogICAgCiAgICBkYXlOYW1lcyA6IFsKICAgICAgICAiU3VuZGF5IiwKICAgICAgICAiTW9uZGF5IiwKICAgICAgICAiVHVlc2RheSIsCiAgICAgICAgIldlZG5lc2RheSIsCiAgICAgICAgIlRodXJzZGF5IiwKICAgICAgICAiRnJpZGF5IiwKICAgICAgICAiU2F0dXJkYXkiCiAgICBdLAoKICAgIAogICAgbW9udGhOYW1lcyA6IFsKICAgICAgICAiSmFudWFyeSIsCiAgICAgICAgIkZlYnJ1YXJ5IiwKICAgICAgICAiTWFyY2giLAogICAgICAgICJBcHJpbCIsCiAgICAgICAgIk1heSIsCiAgICAgICAgIkp1bmUiLAogICAgICAgICJKdWx5IiwKICAgICAgICAiQXVndXN0IiwKICAgICAgICAiU2VwdGVtYmVyIiwKICAgICAgICAiT2N0b2JlciIsCiAgICAgICAgIk5vdmVtYmVyIiwKICAgICAgICAiRGVjZW1iZXIiCiAgICBdLAoKICAgIAogICAgbW9udGhOdW1iZXJzIDogewogICAgICAgIEphbjowLAogICAgICAgIEZlYjoxLAogICAgICAgIE1hcjoyLAogICAgICAgIEFwcjozLAogICAgICAgIE1heTo0LAogICAgICAgIEp1bjo1LAogICAgICAgIEp1bDo2LAogICAgICAgIEF1Zzo3LAogICAgICAgIFNlcDo4LAogICAgICAgIE9jdDo5LAogICAgICAgIE5vdjoxMCwKICAgICAgICBEZWM6MTEKICAgIH0sCgogICAgCiAgICBnZXRTaG9ydE1vbnRoTmFtZSA6IGZ1bmN0aW9uKG1vbnRoKSB7CiAgICAgICAgcmV0dXJuIERhdGUubW9udGhOYW1lc1ttb250aF0uc3Vic3RyaW5nKDAsIDMpOwogICAgfSwKCiAgICAKICAgIGdldFNob3J0RGF5TmFtZSA6IGZ1bmN0aW9uKGRheSkgewogICAgICAgIHJldHVybiBEYXRlLmRheU5hbWVzW2RheV0uc3Vic3RyaW5nKDAsIDMpOwogICAgfSwKCiAgICAKICAgIGdldE1vbnRoTnVtYmVyIDogZnVuY3Rpb24obmFtZSkgewogICAgICAgIAogICAgICAgIHJldHVybiBEYXRlLm1vbnRoTnVtYmVyc1tuYW1lLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zdWJzdHJpbmcoMSwgMykudG9Mb3dlckNhc2UoKV07CiAgICB9LAogICAgCiAgICAKICAgIGZvcm1hdENvbnRhaW5zSG91ckluZm8gOiAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgc3RyaXBFc2NhcGVSZSA9IC8oXFwuKS9nLAogICAgICAgICAgICBob3VySW5mb1JlID0gLyhbZ0doSGlzdWNVT1BaXXxNXCQpLzsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZm9ybWF0KXsKICAgICAgICAgICAgcmV0dXJuIGhvdXJJbmZvUmUudGVzdChmb3JtYXQucmVwbGFjZShzdHJpcEVzY2FwZVJlLCAnJykpOwogICAgICAgIH07CiAgICB9KSgpLAoKICAgIAogICAgZm9ybWF0Q29kZXMgOiB7CiAgICAgICAgZDogIlN0cmluZy5sZWZ0UGFkKHRoaXMuZ2V0RGF0ZSgpLCAyLCAnMCcpIiwKICAgICAgICBEOiAiRGF0ZS5nZXRTaG9ydERheU5hbWUodGhpcy5nZXREYXkoKSkiLCAKICAgICAgICBqOiAidGhpcy5nZXREYXRlKCkiLAogICAgICAgIGw6ICJEYXRlLmRheU5hbWVzW3RoaXMuZ2V0RGF5KCldIiwKICAgICAgICBOOiAiKHRoaXMuZ2V0RGF5KCkgPyB0aGlzLmdldERheSgpIDogNykiLAogICAgICAgIFM6ICJ0aGlzLmdldFN1ZmZpeCgpIiwKICAgICAgICB3OiAidGhpcy5nZXREYXkoKSIsCiAgICAgICAgejogInRoaXMuZ2V0RGF5T2ZZZWFyKCkiLAogICAgICAgIFc6ICJTdHJpbmcubGVmdFBhZCh0aGlzLmdldFdlZWtPZlllYXIoKSwgMiwgJzAnKSIsCiAgICAgICAgRjogIkRhdGUubW9udGhOYW1lc1t0aGlzLmdldE1vbnRoKCldIiwKICAgICAgICBtOiAiU3RyaW5nLmxlZnRQYWQodGhpcy5nZXRNb250aCgpICsgMSwgMiwgJzAnKSIsCiAgICAgICAgTTogIkRhdGUuZ2V0U2hvcnRNb250aE5hbWUodGhpcy5nZXRNb250aCgpKSIsIAogICAgICAgIG46ICIodGhpcy5nZXRNb250aCgpICsgMSkiLAogICAgICAgIHQ6ICJ0aGlzLmdldERheXNJbk1vbnRoKCkiLAogICAgICAgIEw6ICIodGhpcy5pc0xlYXBZZWFyKCkgPyAxIDogMCkiLAogICAgICAgIG86ICIodGhpcy5nZXRGdWxsWWVhcigpICsgKHRoaXMuZ2V0V2Vla09mWWVhcigpID09IDEgJiYgdGhpcy5nZXRNb250aCgpID4gMCA/ICsxIDogKHRoaXMuZ2V0V2Vla09mWWVhcigpID49IDUyICYmIHRoaXMuZ2V0TW9udGgoKSA8IDExID8gLTEgOiAwKSkpIiwKICAgICAgICBZOiAiU3RyaW5nLmxlZnRQYWQodGhpcy5nZXRGdWxsWWVhcigpLCA0LCAnMCcpIiwKICAgICAgICB5OiAiKCcnICsgdGhpcy5nZXRGdWxsWWVhcigpKS5zdWJzdHJpbmcoMiwgNCkiLAogICAgICAgIGE6ICIodGhpcy5nZXRIb3VycygpIDwgMTIgPyAnYW0nIDogJ3BtJykiLAogICAgICAgIEE6ICIodGhpcy5nZXRIb3VycygpIDwgMTIgPyAnQU0nIDogJ1BNJykiLAogICAgICAgIGc6ICIoKHRoaXMuZ2V0SG91cnMoKSAlIDEyKSA/IHRoaXMuZ2V0SG91cnMoKSAlIDEyIDogMTIpIiwKICAgICAgICBHOiAidGhpcy5nZXRIb3VycygpIiwKICAgICAgICBoOiAiU3RyaW5nLmxlZnRQYWQoKHRoaXMuZ2V0SG91cnMoKSAlIDEyKSA/IHRoaXMuZ2V0SG91cnMoKSAlIDEyIDogMTIsIDIsICcwJykiLAogICAgICAgIEg6ICJTdHJpbmcubGVmdFBhZCh0aGlzLmdldEhvdXJzKCksIDIsICcwJykiLAogICAgICAgIGk6ICJTdHJpbmcubGVmdFBhZCh0aGlzLmdldE1pbnV0ZXMoKSwgMiwgJzAnKSIsCiAgICAgICAgczogIlN0cmluZy5sZWZ0UGFkKHRoaXMuZ2V0U2Vjb25kcygpLCAyLCAnMCcpIiwKICAgICAgICB1OiAiU3RyaW5nLmxlZnRQYWQodGhpcy5nZXRNaWxsaXNlY29uZHMoKSwgMywgJzAnKSIsCiAgICAgICAgTzogInRoaXMuZ2V0R01UT2Zmc2V0KCkiLAogICAgICAgIFA6ICJ0aGlzLmdldEdNVE9mZnNldCh0cnVlKSIsCiAgICAgICAgVDogInRoaXMuZ2V0VGltZXpvbmUoKSIsCiAgICAgICAgWjogIih0aGlzLmdldFRpbWV6b25lT2Zmc2V0KCkgKiAtNjApIiwKCiAgICAgICAgYzogZnVuY3Rpb24oKSB7IAogICAgICAgICAgICBmb3IgKHZhciBjID0gIlktbS1kVEg6aTpzUCIsIGNvZGUgPSBbXSwgaSA9IDAsIGwgPSBjLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICAgICAgICAgICAgdmFyIGUgPSBjLmNoYXJBdChpKTsKICAgICAgICAgICAgICAgIGNvZGUucHVzaChlID09ICJUIiA/ICInVCciIDogRGF0ZS5nZXRGb3JtYXRDb2RlKGUpKTsgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNvZGUuam9pbigiICsgIik7CiAgICAgICAgfSwKICAgICAgICAKCiAgICAgICAgVTogIk1hdGgucm91bmQodGhpcy5nZXRUaW1lKCkgLyAxMDAwKSIKICAgIH0sCgogICAgCiAgICBpc1ZhbGlkIDogZnVuY3Rpb24oeSwgbSwgZCwgaCwgaSwgcywgbXMpIHsKICAgICAgICAKICAgICAgICBoID0gaCB8fCAwOwogICAgICAgIGkgPSBpIHx8IDA7CiAgICAgICAgcyA9IHMgfHwgMDsKICAgICAgICBtcyA9IG1zIHx8IDA7CgogICAgICAgIAogICAgICAgIHZhciBkdCA9IG5ldyBEYXRlKHkgPCAxMDAgPyAxMDAgOiB5LCBtIC0gMSwgZCwgaCwgaSwgcywgbXMpLmFkZChEYXRlLllFQVIsIHkgPCAxMDAgPyB5IC0gMTAwIDogMCk7CgogICAgICAgIHJldHVybiB5ID09IGR0LmdldEZ1bGxZZWFyKCkgJiYKICAgICAgICAgICAgbSA9PSBkdC5nZXRNb250aCgpICsgMSAmJgogICAgICAgICAgICBkID09IGR0LmdldERhdGUoKSAmJgogICAgICAgICAgICBoID09IGR0LmdldEhvdXJzKCkgJiYKICAgICAgICAgICAgaSA9PSBkdC5nZXRNaW51dGVzKCkgJiYKICAgICAgICAgICAgcyA9PSBkdC5nZXRTZWNvbmRzKCkgJiYKICAgICAgICAgICAgbXMgPT0gZHQuZ2V0TWlsbGlzZWNvbmRzKCk7CiAgICB9LAoKICAgIAogICAgcGFyc2VEYXRlIDogZnVuY3Rpb24oaW5wdXQsIGZvcm1hdCwgc3RyaWN0KSB7CiAgICAgICAgdmFyIHAgPSBEYXRlLnBhcnNlRnVuY3Rpb25zOwogICAgICAgIGlmIChwW2Zvcm1hdF0gPT0gbnVsbCkgewogICAgICAgICAgICBEYXRlLmNyZWF0ZVBhcnNlcihmb3JtYXQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcFtmb3JtYXRdKGlucHV0LCBFeHQuaXNEZWZpbmVkKHN0cmljdCkgPyBzdHJpY3QgOiBEYXRlLnVzZVN0cmljdCk7CiAgICB9LAoKICAgIAogICAgZ2V0Rm9ybWF0Q29kZSA6IGZ1bmN0aW9uKGNoYXJhY3RlcikgewogICAgICAgIHZhciBmID0gRGF0ZS5mb3JtYXRDb2Rlc1tjaGFyYWN0ZXJdOwoKICAgICAgICBpZiAoZikgewogICAgICAgICAgZiA9IHR5cGVvZiBmID09ICdmdW5jdGlvbic/IGYoKSA6IGY7CiAgICAgICAgICBEYXRlLmZvcm1hdENvZGVzW2NoYXJhY3Rlcl0gPSBmOyAKICAgICAgICB9CgogICAgICAgIAogICAgICAgIHJldHVybiBmIHx8ICgiJyIgKyBTdHJpbmcuZXNjYXBlKGNoYXJhY3RlcikgKyAiJyIpOwogICAgfSwKCiAgICAKICAgIGNyZWF0ZUZvcm1hdCA6IGZ1bmN0aW9uKGZvcm1hdCkgewogICAgICAgIHZhciBjb2RlID0gW10sCiAgICAgICAgICAgIHNwZWNpYWwgPSBmYWxzZSwKICAgICAgICAgICAgY2ggPSAnJzsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmb3JtYXQubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgY2ggPSBmb3JtYXQuY2hhckF0KGkpOwogICAgICAgICAgICBpZiAoIXNwZWNpYWwgJiYgY2ggPT0gIlxcIikgewogICAgICAgICAgICAgICAgc3BlY2lhbCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3BlY2lhbCkgewogICAgICAgICAgICAgICAgc3BlY2lhbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgY29kZS5wdXNoKCInIiArIFN0cmluZy5lc2NhcGUoY2gpICsgIiciKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvZGUucHVzaChEYXRlLmdldEZvcm1hdENvZGUoY2gpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBEYXRlLmZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdID0gbmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGNvZGUuam9pbignKycpKTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVQYXJzZXIgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29kZSA9IFsKICAgICAgICAgICAgInZhciBkdCwgeSwgbSwgZCwgaCwgaSwgcywgbXMsIG8sIHosIHp6LCB1LCB2LCIsCiAgICAgICAgICAgICAgICAiZGVmID0gRGF0ZS5kZWZhdWx0cywiLAogICAgICAgICAgICAgICAgInJlc3VsdHMgPSBTdHJpbmcoaW5wdXQpLm1hdGNoKERhdGUucGFyc2VSZWdleGVzW3swfV0pOyIsIAoKICAgICAgICAgICAgImlmKHJlc3VsdHMpeyIsCiAgICAgICAgICAgICAgICAiezF9IiwKCiAgICAgICAgICAgICAgICAiaWYodSAhPSBudWxsKXsiLCAKICAgICAgICAgICAgICAgICAgICAidiA9IG5ldyBEYXRlKHUgKiAxMDAwKTsiLCAKICAgICAgICAgICAgICAgICJ9ZWxzZXsiLAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICJkdCA9IChuZXcgRGF0ZSgpKS5jbGVhclRpbWUoKTsiLAoKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAieSA9IEV4dC5udW0oeSwgRXh0Lm51bShkZWYueSwgZHQuZ2V0RnVsbFllYXIoKSkpOyIsCiAgICAgICAgICAgICAgICAgICAgIm0gPSBFeHQubnVtKG0sIEV4dC5udW0oZGVmLm0gLSAxLCBkdC5nZXRNb250aCgpKSk7IiwKICAgICAgICAgICAgICAgICAgICAiZCA9IEV4dC5udW0oZCwgRXh0Lm51bShkZWYuZCwgZHQuZ2V0RGF0ZSgpKSk7IiwKCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgImggID0gRXh0Lm51bShoLCBFeHQubnVtKGRlZi5oLCBkdC5nZXRIb3VycygpKSk7IiwKICAgICAgICAgICAgICAgICAgICAiaSAgPSBFeHQubnVtKGksIEV4dC5udW0oZGVmLmksIGR0LmdldE1pbnV0ZXMoKSkpOyIsCiAgICAgICAgICAgICAgICAgICAgInMgID0gRXh0Lm51bShzLCBFeHQubnVtKGRlZi5zLCBkdC5nZXRTZWNvbmRzKCkpKTsiLAogICAgICAgICAgICAgICAgICAgICJtcyA9IEV4dC5udW0obXMsIEV4dC5udW0oZGVmLm1zLCBkdC5nZXRNaWxsaXNlY29uZHMoKSkpOyIsCgogICAgICAgICAgICAgICAgICAgICJpZih6ID49IDAgJiYgeSA+PSAwKXsiLAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICJ2ID0gbmV3IERhdGUoeSA8IDEwMCA/IDEwMCA6IHksIDAsIDEsIGgsIGksIHMsIG1zKS5hZGQoRGF0ZS5ZRUFSLCB5IDwgMTAwID8geSAtIDEwMCA6IDApOyIsCgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgInYgPSAhc3RyaWN0PyB2IDogKHN0cmljdCA9PT0gdHJ1ZSAmJiAoeiA8PSAzNjQgfHwgKHYuaXNMZWFwWWVhcigpICYmIHogPD0gMzY1KSk/IHYuYWRkKERhdGUuREFZLCB6KSA6IG51bGwpOyIsCiAgICAgICAgICAgICAgICAgICAgIn1lbHNlIGlmKHN0cmljdCA9PT0gdHJ1ZSAmJiAhRGF0ZS5pc1ZhbGlkKHksIG0gKyAxLCBkLCBoLCBpLCBzLCBtcykpeyIsIAogICAgICAgICAgICAgICAgICAgICAgICAidiA9IG51bGw7IiwgCiAgICAgICAgICAgICAgICAgICAgIn1lbHNleyIsCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgInYgPSBuZXcgRGF0ZSh5IDwgMTAwID8gMTAwIDogeSwgbSwgZCwgaCwgaSwgcywgbXMpLmFkZChEYXRlLllFQVIsIHkgPCAxMDAgPyB5IC0gMTAwIDogMCk7IiwKICAgICAgICAgICAgICAgICAgICAifSIsCiAgICAgICAgICAgICAgICAifSIsCiAgICAgICAgICAgICJ9IiwKCiAgICAgICAgICAgICJpZih2KXsiLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAiaWYoenogIT0gbnVsbCl7IiwKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAidiA9IHYuYWRkKERhdGUuU0VDT05ELCAtdi5nZXRUaW1lem9uZU9mZnNldCgpICogNjAgLSB6eik7IiwKICAgICAgICAgICAgICAgICJ9ZWxzZSBpZihvKXsiLAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICJ2ID0gdi5hZGQoRGF0ZS5NSU5VVEUsIC12LmdldFRpbWV6b25lT2Zmc2V0KCkgKyAoc24gPT0gJysnPyAtMSA6IDEpICogKGhyICogNjAgKyBtbikpOyIsCiAgICAgICAgICAgICAgICAifSIsCiAgICAgICAgICAgICJ9IiwKCiAgICAgICAgICAgICJyZXR1cm4gdjsiCiAgICAgICAgXS5qb2luKCdcbicpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZm9ybWF0KSB7CiAgICAgICAgICAgIHZhciByZWdleE51bSA9IERhdGUucGFyc2VSZWdleGVzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGN1cnJlbnRHcm91cCA9IDEsCiAgICAgICAgICAgICAgICBjYWxjID0gW10sCiAgICAgICAgICAgICAgICByZWdleCA9IFtdLAogICAgICAgICAgICAgICAgc3BlY2lhbCA9IGZhbHNlLAogICAgICAgICAgICAgICAgY2ggPSAiIiwKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgb2JqLAogICAgICAgICAgICAgICAgbGFzdDsKCiAgICAgICAgICAgIGZvciAoOyBpIDwgZm9ybWF0Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgICAgICBjaCA9IGZvcm1hdC5jaGFyQXQoaSk7CiAgICAgICAgICAgICAgICBpZiAoIXNwZWNpYWwgJiYgY2ggPT0gIlxcIikgewogICAgICAgICAgICAgICAgICAgIHNwZWNpYWwgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzcGVjaWFsKSB7CiAgICAgICAgICAgICAgICAgICAgc3BlY2lhbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHJlZ2V4LnB1c2goU3RyaW5nLmVzY2FwZShjaCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvYmogPSAkZihjaCwgY3VycmVudEdyb3VwKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50R3JvdXAgKz0gb2JqLmc7CiAgICAgICAgICAgICAgICAgICAgcmVnZXgucHVzaChvYmoucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5nICYmIG9iai5jKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvYmouY2FsY0xhc3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QgPSBvYmouYzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGMucHVzaChvYmouYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChsYXN0KSB7CiAgICAgICAgICAgICAgICBjYWxjLnB1c2gobGFzdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERhdGUucGFyc2VSZWdleGVzW3JlZ2V4TnVtXSA9IG5ldyBSZWdFeHAoIl4iICsgcmVnZXguam9pbignJykgKyAiJCIsICdpJyk7CiAgICAgICAgICAgIERhdGUucGFyc2VGdW5jdGlvbnNbZm9ybWF0XSA9IG5ldyBGdW5jdGlvbigiaW5wdXQiLCAic3RyaWN0IiwgeGYoY29kZSwgcmVnZXhOdW0sIGNhbGMuam9pbignJykpKTsKICAgICAgICB9OwogICAgfSgpLAoKICAgIAogICAgcGFyc2VDb2RlcyA6IHsKICAgICAgICAKICAgICAgICBkOiB7CiAgICAgICAgICAgIGc6MSwKICAgICAgICAgICAgYzoiZCA9IHBhcnNlSW50KHJlc3VsdHNbezB9XSwgMTApO1xuIiwKICAgICAgICAgICAgczoiKFxcZHsyfSkiIAogICAgICAgIH0sCiAgICAgICAgajogewogICAgICAgICAgICBnOjEsCiAgICAgICAgICAgIGM6ImQgPSBwYXJzZUludChyZXN1bHRzW3swfV0sIDEwKTtcbiIsCiAgICAgICAgICAgIHM6IihcXGR7MSwyfSkiIAogICAgICAgIH0sCiAgICAgICAgRDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZvciAodmFyIGEgPSBbXSwgaSA9IDA7IGkgPCA3OyBhLnB1c2goRGF0ZS5nZXRTaG9ydERheU5hbWUoaSkpLCArK2kpOyAKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGc6MCwKICAgICAgICAgICAgICAgIGM6bnVsbCwKICAgICAgICAgICAgICAgIHM6Iig/OiIgKyBhLmpvaW4oInwiKSArIikiCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGc6MCwKICAgICAgICAgICAgICAgIGM6bnVsbCwKICAgICAgICAgICAgICAgIHM6Iig/OiIgKyBEYXRlLmRheU5hbWVzLmpvaW4oInwiKSArICIpIgogICAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgTjogewogICAgICAgICAgICBnOjAsCiAgICAgICAgICAgIGM6bnVsbCwKICAgICAgICAgICAgczoiWzEtN10iIAogICAgICAgIH0sCiAgICAgICAgUzogewogICAgICAgICAgICBnOjAsCiAgICAgICAgICAgIGM6bnVsbCwKICAgICAgICAgICAgczoiKD86c3R8bmR8cmR8dGgpIgogICAgICAgIH0sCiAgICAgICAgdzogewogICAgICAgICAgICBnOjAsCiAgICAgICAgICAgIGM6bnVsbCwKICAgICAgICAgICAgczoiWzAtNl0iIAogICAgICAgIH0sCiAgICAgICAgejogewogICAgICAgICAgICBnOjEsCiAgICAgICAgICAgIGM6InogPSBwYXJzZUludChyZXN1bHRzW3swfV0sIDEwKTtcbiIsCiAgICAgICAgICAgIHM6IihcXGR7MSwzfSkiIAogICAgICAgIH0sCiAgICAgICAgVzogewogICAgICAgICAgICBnOjAsCiAgICAgICAgICAgIGM6bnVsbCwKICAgICAgICAgICAgczoiKD86XFxkezJ9KSIgCiAgICAgICAgfSwKICAgICAgICBGOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGc6MSwKICAgICAgICAgICAgICAgIGM6Im0gPSBwYXJzZUludChEYXRlLmdldE1vbnRoTnVtYmVyKHJlc3VsdHNbezB9XSksIDEwKTtcbiIsIAogICAgICAgICAgICAgICAgczoiKCIgKyBEYXRlLm1vbnRoTmFtZXMuam9pbigifCIpICsgIikiCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBNOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZm9yICh2YXIgYSA9IFtdLCBpID0gMDsgaSA8IDEyOyBhLnB1c2goRGF0ZS5nZXRTaG9ydE1vbnRoTmFtZShpKSksICsraSk7IAogICAgICAgICAgICByZXR1cm4gRXh0LmFwcGx5SWYoewogICAgICAgICAgICAgICAgczoiKCIgKyBhLmpvaW4oInwiKSArICIpIgogICAgICAgICAgICB9LCAkZigiRiIpKTsKICAgICAgICB9LAogICAgICAgIG06IHsKICAgICAgICAgICAgZzoxLAogICAgICAgICAgICBjOiJtID0gcGFyc2VJbnQocmVzdWx0c1t7MH1dLCAxMCkgLSAxO1xuIiwKICAgICAgICAgICAgczoiKFxcZHsyfSkiIAogICAgICAgIH0sCiAgICAgICAgbjogewogICAgICAgICAgICBnOjEsCiAgICAgICAgICAgIGM6Im0gPSBwYXJzZUludChyZXN1bHRzW3swfV0sIDEwKSAtIDE7XG4iLAogICAgICAgICAgICBzOiIoXFxkezEsMn0pIiAKICAgICAgICB9LAogICAgICAgIHQ6IHsKICAgICAgICAgICAgZzowLAogICAgICAgICAgICBjOm51bGwsCiAgICAgICAgICAgIHM6Iig/OlxcZHsyfSkiIAogICAgICAgIH0sCiAgICAgICAgTDogewogICAgICAgICAgICBnOjAsCiAgICAgICAgICAgIGM6bnVsbCwKICAgICAgICAgICAgczoiKD86MXwwKSIKICAgICAgICB9LAogICAgICAgIG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gJGYoIlkiKTsKICAgICAgICB9LAogICAgICAgIFk6IHsKICAgICAgICAgICAgZzoxLAogICAgICAgICAgICBjOiJ5ID0gcGFyc2VJbnQocmVzdWx0c1t7MH1dLCAxMCk7XG4iLAogICAgICAgICAgICBzOiIoXFxkezR9KSIgCiAgICAgICAgfSwKICAgICAgICB5OiB7CiAgICAgICAgICAgIGc6MSwKICAgICAgICAgICAgYzoidmFyIHR5ID0gcGFyc2VJbnQocmVzdWx0c1t7MH1dLCAxMCk7XG4iCiAgICAgICAgICAgICAgICArICJ5ID0gdHkgPiBEYXRlLnkya1llYXIgPyAxOTAwICsgdHkgOiAyMDAwICsgdHk7XG4iLCAKICAgICAgICAgICAgczoiKFxcZHsxLDJ9KSIKICAgICAgICB9LAogICAgICAgIAogICAgICAgIGE6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiAkZigiQSIpOwogICAgICAgIH0sCiAgICAgICAgQTogewogICAgICAgICAgICAKICAgICAgICAgICAgY2FsY0xhc3Q6IHRydWUsCiAgICAgICAgICAgIGc6MSwKICAgICAgICAgICAgYzoiaWYgKC8oYW0pL2kudGVzdChyZXN1bHRzW3swfV0pKSB7XG4iCiAgICAgICAgICAgICAgICArICJpZiAoIWggfHwgaCA9PSAxMikgeyBoID0gMDsgfVxuIgogICAgICAgICAgICAgICAgKyAifSBlbHNlIHsgaWYgKCFoIHx8IGggPCAxMikgeyBoID0gKGggfHwgMCkgKyAxMjsgfX0iLAogICAgICAgICAgICBzOiIoQU18UE18YW18cG0pIgogICAgICAgIH0sCiAgICAgICAgZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAkZigiRyIpOwogICAgICAgIH0sCiAgICAgICAgRzogewogICAgICAgICAgICBnOjEsCiAgICAgICAgICAgIGM6ImggPSBwYXJzZUludChyZXN1bHRzW3swfV0sIDEwKTtcbiIsCiAgICAgICAgICAgIHM6IihcXGR7MSwyfSkiIAogICAgICAgIH0sCiAgICAgICAgaDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAkZigiSCIpOwogICAgICAgIH0sCiAgICAgICAgSDogewogICAgICAgICAgICBnOjEsCiAgICAgICAgICAgIGM6ImggPSBwYXJzZUludChyZXN1bHRzW3swfV0sIDEwKTtcbiIsCiAgICAgICAgICAgIHM6IihcXGR7Mn0pIiAKICAgICAgICB9LAogICAgICAgIGk6IHsKICAgICAgICAgICAgZzoxLAogICAgICAgICAgICBjOiJpID0gcGFyc2VJbnQocmVzdWx0c1t7MH1dLCAxMCk7XG4iLAogICAgICAgICAgICBzOiIoXFxkezJ9KSIgCiAgICAgICAgfSwKICAgICAgICBzOiB7CiAgICAgICAgICAgIGc6MSwKICAgICAgICAgICAgYzoicyA9IHBhcnNlSW50KHJlc3VsdHNbezB9XSwgMTApO1xuIiwKICAgICAgICAgICAgczoiKFxcZHsyfSkiIAogICAgICAgIH0sCiAgICAgICAgdTogewogICAgICAgICAgICBnOjEsCiAgICAgICAgICAgIGM6Im1zID0gcmVzdWx0c1t7MH1dOyBtcyA9IHBhcnNlSW50KG1zLCAxMCkvTWF0aC5wb3coMTAsIG1zLmxlbmd0aCAtIDMpO1xuIiwKICAgICAgICAgICAgczoiKFxcZCspIiAKICAgICAgICB9LAogICAgICAgIE86IHsKICAgICAgICAgICAgZzoxLAogICAgICAgICAgICBjOlsKICAgICAgICAgICAgICAgICJvID0gcmVzdWx0c1t7MH1dOyIsCiAgICAgICAgICAgICAgICAidmFyIHNuID0gby5zdWJzdHJpbmcoMCwxKSwiLCAKICAgICAgICAgICAgICAgICAgICAiaHIgPSBvLnN1YnN0cmluZygxLDMpKjEgKyBNYXRoLmZsb29yKG8uc3Vic3RyaW5nKDMsNSkgLyA2MCksIiwgCiAgICAgICAgICAgICAgICAgICAgIm1uID0gby5zdWJzdHJpbmcoMyw1KSAlIDYwOyIsIAogICAgICAgICAgICAgICAgIm8gPSAoKC0xMiA8PSAoaHIqNjAgKyBtbikvNjApICYmICgoaHIqNjAgKyBtbikvNjAgPD0gMTQpKT8gKHNuICsgU3RyaW5nLmxlZnRQYWQoaHIsIDIsICcwJykgKyBTdHJpbmcubGVmdFBhZChtbiwgMiwgJzAnKSkgOiBudWxsO1xuIiAKICAgICAgICAgICAgXS5qb2luKCJcbiIpLAogICAgICAgICAgICBzOiAiKFsrXC1dXFxkezR9KSIgCiAgICAgICAgfSwKICAgICAgICBQOiB7CiAgICAgICAgICAgIGc6MSwKICAgICAgICAgICAgYzpbCiAgICAgICAgICAgICAgICAibyA9IHJlc3VsdHNbezB9XTsiLAogICAgICAgICAgICAgICAgInZhciBzbiA9IG8uc3Vic3RyaW5nKDAsMSksIiwgCiAgICAgICAgICAgICAgICAgICAgImhyID0gby5zdWJzdHJpbmcoMSwzKSoxICsgTWF0aC5mbG9vcihvLnN1YnN0cmluZyg0LDYpIC8gNjApLCIsIAogICAgICAgICAgICAgICAgICAgICJtbiA9IG8uc3Vic3RyaW5nKDQsNikgJSA2MDsiLCAKICAgICAgICAgICAgICAgICJvID0gKCgtMTIgPD0gKGhyKjYwICsgbW4pLzYwKSAmJiAoKGhyKjYwICsgbW4pLzYwIDw9IDE0KSk/IChzbiArIFN0cmluZy5sZWZ0UGFkKGhyLCAyLCAnMCcpICsgU3RyaW5nLmxlZnRQYWQobW4sIDIsICcwJykpIDogbnVsbDtcbiIgCiAgICAgICAgICAgIF0uam9pbigiXG4iKSwKICAgICAgICAgICAgczogIihbK1wtXVxcZHsyfTpcXGR7Mn0pIiAKICAgICAgICB9LAogICAgICAgIFQ6IHsKICAgICAgICAgICAgZzowLAogICAgICAgICAgICBjOm51bGwsCiAgICAgICAgICAgIHM6IltBLVpdezEsNH0iIAogICAgICAgIH0sCiAgICAgICAgWjogewogICAgICAgICAgICBnOjEsCiAgICAgICAgICAgIGM6Inp6ID0gcmVzdWx0c1t7MH1dICogMTtcbiIgCiAgICAgICAgICAgICAgICAgICsgInp6ID0gKC00MzIwMCA8PSB6eiAmJiB6eiA8PSA1MDQwMCk/IHp6IDogbnVsbDtcbiIsCiAgICAgICAgICAgIHM6IihbK1wtXT9cXGR7MSw1fSkiIAogICAgICAgIH0sCiAgICAgICAgYzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjYWxjID0gW10sCiAgICAgICAgICAgICAgICBhcnIgPSBbCiAgICAgICAgICAgICAgICAgICAgJGYoIlkiLCAxKSwgCiAgICAgICAgICAgICAgICAgICAgJGYoIm0iLCAyKSwgCiAgICAgICAgICAgICAgICAgICAgJGYoImQiLCAzKSwgCiAgICAgICAgICAgICAgICAgICAgJGYoImgiLCA0KSwgCiAgICAgICAgICAgICAgICAgICAgJGYoImkiLCA1KSwgCiAgICAgICAgICAgICAgICAgICAgJGYoInMiLCA2KSwgCiAgICAgICAgICAgICAgICAgICAge2M6Im1zID0gcmVzdWx0c1s3XSB8fCAnMCc7IG1zID0gcGFyc2VJbnQobXMsIDEwKS9NYXRoLnBvdygxMCwgbXMubGVuZ3RoIC0gMyk7XG4ifSwgCiAgICAgICAgICAgICAgICAgICAge2M6WyAKICAgICAgICAgICAgICAgICAgICAgICAgImlmKHJlc3VsdHNbOF0pIHsiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpZihyZXN1bHRzWzhdID09ICdaJyl7IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAienogPSAwOyIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIn1lbHNlIGlmIChyZXN1bHRzWzhdLmluZGV4T2YoJzonKSA+IC0xKXsiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRmKCJQIiwgOCkuYywgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAifWVsc2V7IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZigiTyIsIDgpLmMsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIn0iLAogICAgICAgICAgICAgICAgICAgICAgICAifSIKICAgICAgICAgICAgICAgICAgICBdLmpvaW4oJ1xuJyl9CiAgICAgICAgICAgICAgICBdOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnIubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICAgICAgICBjYWxjLnB1c2goYXJyW2ldLmMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZzoxLAogICAgICAgICAgICAgICAgYzpjYWxjLmpvaW4oIiIpLAogICAgICAgICAgICAgICAgczpbCiAgICAgICAgICAgICAgICAgICAgYXJyWzBdLnMsIAogICAgICAgICAgICAgICAgICAgICIoPzoiLCAiLSIsIGFyclsxXS5zLCAKICAgICAgICAgICAgICAgICAgICAgICAgIig/OiIsICItIiwgYXJyWzJdLnMsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIig/OiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIig/OlR8ICk/IiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyWzNdLnMsICI6IiwgYXJyWzRdLnMsICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiKD86OiIsIGFycls1XS5zLCAiKT8iLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiKD86KD86XFwufCwpKFxcZCspKT8iLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiKFp8KD86Wy0rXVxcZHsyfSg/OjopP1xcZHsyfSkpPyIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIik/IiwKICAgICAgICAgICAgICAgICAgICAgICAgIik/IiwKICAgICAgICAgICAgICAgICAgICAiKT8iCiAgICAgICAgICAgICAgICBdLmpvaW4oIiIpCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICBVOiB7CiAgICAgICAgICAgIGc6MSwKICAgICAgICAgICAgYzoidSA9IHBhcnNlSW50KHJlc3VsdHNbezB9XSwgMTApO1xuIiwKICAgICAgICAgICAgczoiKC0/XFxkKykiIAogICAgICAgIH0KICAgIH0KfSk7Cgp9KCkpOwoKRXh0LmFwcGx5KERhdGUucHJvdG90eXBlLCB7CiAgICAKICAgIGRhdGVGb3JtYXQgOiBmdW5jdGlvbihmb3JtYXQpIHsKICAgICAgICBpZiAoRGF0ZS5mb3JtYXRGdW5jdGlvbnNbZm9ybWF0XSA9PSBudWxsKSB7CiAgICAgICAgICAgIERhdGUuY3JlYXRlRm9ybWF0KGZvcm1hdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBEYXRlLmZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdLmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgZ2V0VGltZXpvbmUgOiBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICByZXR1cm4gdGhpcy50b1N0cmluZygpLnJlcGxhY2UoL14uKiAoPzpcKCguKilcKXwoW0EtWl17MSw0fSkoPzpbXC0rXVswLTldezR9KT8oPzogLT9cZCspPykkLywgIiQxJDIiKS5yZXBsYWNlKC9bXkEtWl0vZywgIiIpOwogICAgfSwKCiAgICAKICAgIGdldEdNVE9mZnNldCA6IGZ1bmN0aW9uKGNvbG9uKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLmdldFRpbWV6b25lT2Zmc2V0KCkgPiAwID8gIi0iIDogIisiKQogICAgICAgICAgICArIFN0cmluZy5sZWZ0UGFkKE1hdGguZmxvb3IoTWF0aC5hYnModGhpcy5nZXRUaW1lem9uZU9mZnNldCgpKSAvIDYwKSwgMiwgIjAiKQogICAgICAgICAgICArIChjb2xvbiA/ICI6IiA6ICIiKQogICAgICAgICAgICArIFN0cmluZy5sZWZ0UGFkKE1hdGguYWJzKHRoaXMuZ2V0VGltZXpvbmVPZmZzZXQoKSAlIDYwKSwgMiwgIjAiKTsKICAgIH0sCgogICAgCiAgICBnZXREYXlPZlllYXI6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBudW0gPSAwLAogICAgICAgICAgICBkID0gdGhpcy5jbG9uZSgpLAogICAgICAgICAgICBtID0gdGhpcy5nZXRNb250aCgpLAogICAgICAgICAgICBpOwoKICAgICAgICBmb3IgKGkgPSAwLCBkLnNldERhdGUoMSksIGQuc2V0TW9udGgoMCk7IGkgPCBtOyBkLnNldE1vbnRoKCsraSkpIHsKICAgICAgICAgICAgbnVtICs9IGQuZ2V0RGF5c0luTW9udGgoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bSArIHRoaXMuZ2V0RGF0ZSgpIC0gMTsKICAgIH0sCgogICAgCiAgICBnZXRXZWVrT2ZZZWFyIDogZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgdmFyIG1zMWQgPSA4NjRlNSwgCiAgICAgICAgICAgIG1zN2QgPSA3ICogbXMxZDsgCgogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsgCiAgICAgICAgICAgIHZhciBEQzMgPSBEYXRlLlVUQyh0aGlzLmdldEZ1bGxZZWFyKCksIHRoaXMuZ2V0TW9udGgoKSwgdGhpcy5nZXREYXRlKCkgKyAzKSAvIG1zMWQsIAogICAgICAgICAgICAgICAgQVdOID0gTWF0aC5mbG9vcihEQzMgLyA3KSwgCiAgICAgICAgICAgICAgICBXeXIgPSBuZXcgRGF0ZShBV04gKiBtczdkKS5nZXRVVENGdWxsWWVhcigpOwoKICAgICAgICAgICAgcmV0dXJuIEFXTiAtIE1hdGguZmxvb3IoRGF0ZS5VVEMoV3lyLCAwLCA3KSAvIG1zN2QpICsgMTsKICAgICAgICB9OwogICAgfSgpLAoKICAgIAogICAgaXNMZWFwWWVhciA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB5ZWFyID0gdGhpcy5nZXRGdWxsWWVhcigpOwogICAgICAgIHJldHVybiAhISgoeWVhciAmIDMpID09IDAgJiYgKHllYXIgJSAxMDAgfHwgKHllYXIgJSA0MDAgPT0gMCAmJiB5ZWFyKSkpOwogICAgfSwKCiAgICAKICAgIGdldEZpcnN0RGF5T2ZNb250aCA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkYXkgPSAodGhpcy5nZXREYXkoKSAtICh0aGlzLmdldERhdGUoKSAtIDEpKSAlIDc7CiAgICAgICAgcmV0dXJuIChkYXkgPCAwKSA/IChkYXkgKyA3KSA6IGRheTsKICAgIH0sCgogICAgCiAgICBnZXRMYXN0RGF5T2ZNb250aCA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldExhc3REYXRlT2ZNb250aCgpLmdldERheSgpOwogICAgfSwKCgogICAgCiAgICBnZXRGaXJzdERhdGVPZk1vbnRoIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMuZ2V0RnVsbFllYXIoKSwgdGhpcy5nZXRNb250aCgpLCAxKTsKICAgIH0sCgogICAgCiAgICBnZXRMYXN0RGF0ZU9mTW9udGggOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUodGhpcy5nZXRGdWxsWWVhcigpLCB0aGlzLmdldE1vbnRoKCksIHRoaXMuZ2V0RGF5c0luTW9udGgoKSk7CiAgICB9LAoKICAgIAogICAgZ2V0RGF5c0luTW9udGg6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBkYXlzSW5Nb250aCA9IFszMSwgMjgsIDMxLCAzMCwgMzEsIDMwLCAzMSwgMzEsIDMwLCAzMSwgMzAsIDMxXTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgeyAKICAgICAgICAgICAgdmFyIG0gPSB0aGlzLmdldE1vbnRoKCk7CgogICAgICAgICAgICByZXR1cm4gbSA9PSAxICYmIHRoaXMuaXNMZWFwWWVhcigpID8gMjkgOiBkYXlzSW5Nb250aFttXTsKICAgICAgICB9OwogICAgfSgpLAoKICAgIAogICAgZ2V0U3VmZml4IDogZnVuY3Rpb24oKSB7CiAgICAgICAgc3dpdGNoICh0aGlzLmdldERhdGUoKSkgewogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGNhc2UgMjE6CiAgICAgICAgICAgIGNhc2UgMzE6CiAgICAgICAgICAgICAgICByZXR1cm4gInN0IjsKICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICBjYXNlIDIyOgogICAgICAgICAgICAgICAgcmV0dXJuICJuZCI7CiAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgY2FzZSAyMzoKICAgICAgICAgICAgICAgIHJldHVybiAicmQiOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuICJ0aCI7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNsb25lIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMuZ2V0VGltZSgpKTsKICAgIH0sCgogICAgCiAgICBpc0RTVCA6IGZ1bmN0aW9uKCkgewogICAgICAgIAogICAgICAgIAogICAgICAgIHJldHVybiBuZXcgRGF0ZSh0aGlzLmdldEZ1bGxZZWFyKCksIDAsIDEpLmdldFRpbWV6b25lT2Zmc2V0KCkgIT0gdGhpcy5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgfSwKCiAgICAKICAgIGNsZWFyVGltZSA6IGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgaWYgKGNsb25lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb25lKCkuY2xlYXJUaW1lKCk7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICB2YXIgZCA9IHRoaXMuZ2V0RGF0ZSgpOwoKICAgICAgICAKICAgICAgICB0aGlzLnNldEhvdXJzKDApOwogICAgICAgIHRoaXMuc2V0TWludXRlcygwKTsKICAgICAgICB0aGlzLnNldFNlY29uZHMoMCk7CiAgICAgICAgdGhpcy5zZXRNaWxsaXNlY29uZHMoMCk7CgogICAgICAgIGlmICh0aGlzLmdldERhdGUoKSAhPSBkKSB7IAogICAgICAgICAgICAKICAgICAgICAgICAgCgogICAgICAgICAgICAKICAgICAgICAgICAgZm9yICh2YXIgaHIgPSAxLCBjID0gdGhpcy5hZGQoRGF0ZS5IT1VSLCBocik7IGMuZ2V0RGF0ZSgpICE9IGQ7IGhyKyssIGMgPSB0aGlzLmFkZChEYXRlLkhPVVIsIGhyKSk7CgogICAgICAgICAgICB0aGlzLnNldERhdGUoZCk7CiAgICAgICAgICAgIHRoaXMuc2V0SG91cnMoYy5nZXRIb3VycygpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGFkZCA6IGZ1bmN0aW9uKGludGVydmFsLCB2YWx1ZSkgewogICAgICAgIHZhciBkID0gdGhpcy5jbG9uZSgpOwogICAgICAgIGlmICghaW50ZXJ2YWwgfHwgdmFsdWUgPT09IDApIHJldHVybiBkOwoKICAgICAgICBzd2l0Y2goaW50ZXJ2YWwudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICBjYXNlIERhdGUuTUlMTEk6CiAgICAgICAgICAgICAgICBkLnNldE1pbGxpc2Vjb25kcyh0aGlzLmdldE1pbGxpc2Vjb25kcygpICsgdmFsdWUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgRGF0ZS5TRUNPTkQ6CiAgICAgICAgICAgICAgICBkLnNldFNlY29uZHModGhpcy5nZXRTZWNvbmRzKCkgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEYXRlLk1JTlVURToKICAgICAgICAgICAgICAgIGQuc2V0TWludXRlcyh0aGlzLmdldE1pbnV0ZXMoKSArIHZhbHVlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIERhdGUuSE9VUjoKICAgICAgICAgICAgICAgIGQuc2V0SG91cnModGhpcy5nZXRIb3VycygpICsgdmFsdWUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgRGF0ZS5EQVk6CiAgICAgICAgICAgICAgICBkLnNldERhdGUodGhpcy5nZXREYXRlKCkgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEYXRlLk1PTlRIOgogICAgICAgICAgICAgICAgdmFyIGRheSA9IHRoaXMuZ2V0RGF0ZSgpOwogICAgICAgICAgICAgICAgaWYgKGRheSA+IDI4KSB7CiAgICAgICAgICAgICAgICAgICAgZGF5ID0gTWF0aC5taW4oZGF5LCB0aGlzLmdldEZpcnN0RGF0ZU9mTW9udGgoKS5hZGQoJ21vJywgdmFsdWUpLmdldExhc3REYXRlT2ZNb250aCgpLmdldERhdGUoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkLnNldERhdGUoZGF5KTsKICAgICAgICAgICAgICAgIGQuc2V0TW9udGgodGhpcy5nZXRNb250aCgpICsgdmFsdWUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgRGF0ZS5ZRUFSOgogICAgICAgICAgICAgICAgZC5zZXRGdWxsWWVhcih0aGlzLmdldEZ1bGxZZWFyKCkgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGQ7CiAgICB9LAoKICAgIAogICAgYmV0d2VlbiA6IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgICB2YXIgdCA9IHRoaXMuZ2V0VGltZSgpOwogICAgICAgIHJldHVybiBzdGFydC5nZXRUaW1lKCkgPD0gdCAmJiB0IDw9IGVuZC5nZXRUaW1lKCk7CiAgICB9Cn0pOwoKCgpEYXRlLnByb3RvdHlwZS5mb3JtYXQgPSBEYXRlLnByb3RvdHlwZS5kYXRlRm9ybWF0OwoKCgppZiAoRXh0LmlzU2FmYXJpICYmIChuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9XZWJLaXRcLyhcZCspLylbMV0gfHwgTmFOKSA8IDQyMCkgewogICAgRXh0LmFwcGx5KERhdGUucHJvdG90eXBlLCB7CiAgICAgICAgX3hNb250aCA6IERhdGUucHJvdG90eXBlLnNldE1vbnRoLAogICAgICAgIF94RGF0ZSAgOiBEYXRlLnByb3RvdHlwZS5zZXREYXRlLAoKICAgICAgICAKICAgICAgICAKICAgICAgICBzZXRNb250aCA6IGZ1bmN0aW9uKG51bSkgewogICAgICAgICAgICBpZiAobnVtIDw9IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgbiA9IE1hdGguY2VpbCgtbnVtKSwKICAgICAgICAgICAgICAgICAgICBiYWNrX3llYXIgPSBNYXRoLmNlaWwobiAvIDEyKSwKICAgICAgICAgICAgICAgICAgICBtb250aCA9IChuICUgMTIpID8gMTIgLSBuICUgMTIgOiAwOwoKICAgICAgICAgICAgICAgIHRoaXMuc2V0RnVsbFllYXIodGhpcy5nZXRGdWxsWWVhcigpIC0gYmFja195ZWFyKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5feE1vbnRoKG1vbnRoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl94TW9udGgobnVtKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgIHNldERhdGUgOiBmdW5jdGlvbihkKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0VGltZSh0aGlzLmdldFRpbWUoKSAtICh0aGlzLmdldERhdGUoKSAtIGQpICogODY0ZTUpOwogICAgICAgIH0KICAgIH0pOwp9CgoKCgoKRXh0LnV0aWwuTWl4ZWRDb2xsZWN0aW9uID0gZnVuY3Rpb24oYWxsb3dGdW5jdGlvbnMsIGtleUZuKXsKICAgIHRoaXMuaXRlbXMgPSBbXTsKICAgIHRoaXMubWFwID0ge307CiAgICB0aGlzLmtleXMgPSBbXTsKICAgIHRoaXMubGVuZ3RoID0gMDsKICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgIAogICAgICAgICdjbGVhcicsCiAgICAgICAgCiAgICAgICAgJ2FkZCcsCiAgICAgICAgCiAgICAgICAgJ3JlcGxhY2UnLAogICAgICAgIAogICAgICAgICdyZW1vdmUnLAogICAgICAgICdzb3J0JwogICAgKTsKICAgIHRoaXMuYWxsb3dGdW5jdGlvbnMgPSBhbGxvd0Z1bmN0aW9ucyA9PT0gdHJ1ZTsKICAgIGlmKGtleUZuKXsKICAgICAgICB0aGlzLmdldEtleSA9IGtleUZuOwogICAgfQogICAgRXh0LnV0aWwuTWl4ZWRDb2xsZWN0aW9uLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsKfTsKCkV4dC5leHRlbmQoRXh0LnV0aWwuTWl4ZWRDb2xsZWN0aW9uLCBFeHQudXRpbC5PYnNlcnZhYmxlLCB7CgogICAgCiAgICBhbGxvd0Z1bmN0aW9ucyA6IGZhbHNlLAoKICAgIAogICAgYWRkIDogZnVuY3Rpb24oa2V5LCBvKXsKICAgICAgICBpZihhcmd1bWVudHMubGVuZ3RoID09IDEpewogICAgICAgICAgICBvID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICBrZXkgPSB0aGlzLmdldEtleShvKTsKICAgICAgICB9CiAgICAgICAgaWYodHlwZW9mIGtleSAhPSAndW5kZWZpbmVkJyAmJiBrZXkgIT09IG51bGwpewogICAgICAgICAgICB2YXIgb2xkID0gdGhpcy5tYXBba2V5XTsKICAgICAgICAgICAgaWYodHlwZW9mIG9sZCAhPSAndW5kZWZpbmVkJyl7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZXBsYWNlKGtleSwgbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5tYXBba2V5XSA9IG87CiAgICAgICAgfQogICAgICAgIHRoaXMubGVuZ3RoKys7CiAgICAgICAgdGhpcy5pdGVtcy5wdXNoKG8pOwogICAgICAgIHRoaXMua2V5cy5wdXNoKGtleSk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2FkZCcsIHRoaXMubGVuZ3RoLTEsIG8sIGtleSk7CiAgICAgICAgcmV0dXJuIG87CiAgICB9LAoKICAgIAogICAgZ2V0S2V5IDogZnVuY3Rpb24obyl7CiAgICAgICAgIHJldHVybiBvLmlkOwogICAgfSwKCiAgICAKICAgIHJlcGxhY2UgOiBmdW5jdGlvbihrZXksIG8pewogICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CiAgICAgICAgICAgIG8gPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgIGtleSA9IHRoaXMuZ2V0S2V5KG8pOwogICAgICAgIH0KICAgICAgICB2YXIgb2xkID0gdGhpcy5tYXBba2V5XTsKICAgICAgICBpZih0eXBlb2Yga2V5ID09ICd1bmRlZmluZWQnIHx8IGtleSA9PT0gbnVsbCB8fCB0eXBlb2Ygb2xkID09ICd1bmRlZmluZWQnKXsKICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZChrZXksIG8pOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmluZGV4T2ZLZXkoa2V5KTsKICAgICAgICB0aGlzLml0ZW1zW2luZGV4XSA9IG87CiAgICAgICAgdGhpcy5tYXBba2V5XSA9IG87CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3JlcGxhY2UnLCBrZXksIG9sZCwgbyk7CiAgICAgICAgcmV0dXJuIG87CiAgICB9LAoKICAgIAogICAgYWRkQWxsIDogZnVuY3Rpb24ob2Jqcyl7CiAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+IDEgfHwgRXh0LmlzQXJyYXkob2JqcykpewogICAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gYXJndW1lbnRzIDogb2JqczsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gYXJncy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICB0aGlzLmFkZChhcmdzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH1lbHNlewogICAgICAgICAgICBmb3IodmFyIGtleSBpbiBvYmpzKXsKICAgICAgICAgICAgICAgIGlmKHRoaXMuYWxsb3dGdW5jdGlvbnMgfHwgdHlwZW9mIG9ianNba2V5XSAhPSAnZnVuY3Rpb24nKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZChrZXksIG9ianNba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZWFjaCA6IGZ1bmN0aW9uKGZuLCBzY29wZSl7CiAgICAgICAgdmFyIGl0ZW1zID0gW10uY29uY2F0KHRoaXMuaXRlbXMpOyAKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBpdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGlmKGZuLmNhbGwoc2NvcGUgfHwgaXRlbXNbaV0sIGl0ZW1zW2ldLCBpLCBsZW4pID09PSBmYWxzZSl7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBlYWNoS2V5IDogZnVuY3Rpb24oZm4sIHNjb3BlKXsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmtleXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHdpbmRvdywgdGhpcy5rZXlzW2ldLCB0aGlzLml0ZW1zW2ldLCBpLCBsZW4pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBmaW5kIDogZnVuY3Rpb24oZm4sIHNjb3BlKXsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSB0aGlzLml0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgaWYoZm4uY2FsbChzY29wZSB8fCB3aW5kb3csIHRoaXMuaXRlbXNbaV0sIHRoaXMua2V5c1tpXSkpewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXNbaV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIAogICAgaW5zZXJ0IDogZnVuY3Rpb24oaW5kZXgsIGtleSwgbyl7CiAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAyKXsKICAgICAgICAgICAgbyA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAga2V5ID0gdGhpcy5nZXRLZXkobyk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuY29udGFpbnNLZXkoa2V5KSl7CiAgICAgICAgICAgIHRoaXMuc3VzcGVuZEV2ZW50cygpOwogICAgICAgICAgICB0aGlzLnJlbW92ZUtleShrZXkpOwogICAgICAgICAgICB0aGlzLnJlc3VtZUV2ZW50cygpOwogICAgICAgIH0KICAgICAgICBpZihpbmRleCA+PSB0aGlzLmxlbmd0aCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmFkZChrZXksIG8pOwogICAgICAgIH0KICAgICAgICB0aGlzLmxlbmd0aCsrOwogICAgICAgIHRoaXMuaXRlbXMuc3BsaWNlKGluZGV4LCAwLCBvKTsKICAgICAgICBpZih0eXBlb2Yga2V5ICE9ICd1bmRlZmluZWQnICYmIGtleSAhPT0gbnVsbCl7CiAgICAgICAgICAgIHRoaXMubWFwW2tleV0gPSBvOwogICAgICAgIH0KICAgICAgICB0aGlzLmtleXMuc3BsaWNlKGluZGV4LCAwLCBrZXkpOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdhZGQnLCBpbmRleCwgbywga2V5KTsKICAgICAgICByZXR1cm4gbzsKICAgIH0sCgogICAgCiAgICByZW1vdmUgOiBmdW5jdGlvbihvKXsKICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmVBdCh0aGlzLmluZGV4T2YobykpOwogICAgfSwKCiAgICAKICAgIHJlbW92ZUF0IDogZnVuY3Rpb24oaW5kZXgpewogICAgICAgIGlmKGluZGV4IDwgdGhpcy5sZW5ndGggJiYgaW5kZXggPj0gMCl7CiAgICAgICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgICAgIHZhciBvID0gdGhpcy5pdGVtc1tpbmRleF07CiAgICAgICAgICAgIHRoaXMuaXRlbXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgdmFyIGtleSA9IHRoaXMua2V5c1tpbmRleF07CiAgICAgICAgICAgIGlmKHR5cGVvZiBrZXkgIT0gJ3VuZGVmaW5lZCcpewogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubWFwW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5rZXlzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdyZW1vdmUnLCBvLCBrZXkpOwogICAgICAgICAgICByZXR1cm4gbzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAKICAgIHJlbW92ZUtleSA6IGZ1bmN0aW9uKGtleSl7CiAgICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlQXQodGhpcy5pbmRleE9mS2V5KGtleSkpOwogICAgfSwKCiAgICAKICAgIGdldENvdW50IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5sZW5ndGg7CiAgICB9LAoKICAgIAogICAgaW5kZXhPZiA6IGZ1bmN0aW9uKG8pewogICAgICAgIHJldHVybiB0aGlzLml0ZW1zLmluZGV4T2Yobyk7CiAgICB9LAoKICAgIAogICAgaW5kZXhPZktleSA6IGZ1bmN0aW9uKGtleSl7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5cy5pbmRleE9mKGtleSk7CiAgICB9LAoKICAgIAogICAgaXRlbSA6IGZ1bmN0aW9uKGtleSl7CiAgICAgICAgdmFyIG1rID0gdGhpcy5tYXBba2V5XSwKICAgICAgICAgICAgaXRlbSA9IG1rICE9PSB1bmRlZmluZWQgPyBtayA6ICh0eXBlb2Yga2V5ID09ICdudW1iZXInKSA/IHRoaXMuaXRlbXNba2V5XSA6IHVuZGVmaW5lZDsKICAgICAgICByZXR1cm4gdHlwZW9mIGl0ZW0gIT0gJ2Z1bmN0aW9uJyB8fCB0aGlzLmFsbG93RnVuY3Rpb25zID8gaXRlbSA6IG51bGw7IAogICAgfSwKCiAgICAKICAgIGl0ZW1BdCA6IGZ1bmN0aW9uKGluZGV4KXsKICAgICAgICByZXR1cm4gdGhpcy5pdGVtc1tpbmRleF07CiAgICB9LAoKICAgIAogICAga2V5IDogZnVuY3Rpb24oa2V5KXsKICAgICAgICByZXR1cm4gdGhpcy5tYXBba2V5XTsKICAgIH0sCgogICAgCiAgICBjb250YWlucyA6IGZ1bmN0aW9uKG8pewogICAgICAgIHJldHVybiB0aGlzLmluZGV4T2YobykgIT0gLTE7CiAgICB9LAoKICAgIAogICAgY29udGFpbnNLZXkgOiBmdW5jdGlvbihrZXkpewogICAgICAgIHJldHVybiB0eXBlb2YgdGhpcy5tYXBba2V5XSAhPSAndW5kZWZpbmVkJzsKICAgIH0sCgogICAgCiAgICBjbGVhciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuaXRlbXMgPSBbXTsKICAgICAgICB0aGlzLmtleXMgPSBbXTsKICAgICAgICB0aGlzLm1hcCA9IHt9OwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjbGVhcicpOwogICAgfSwKCiAgICAKICAgIGZpcnN0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pdGVtc1swXTsKICAgIH0sCgogICAgCiAgICBsYXN0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pdGVtc1t0aGlzLmxlbmd0aC0xXTsKICAgIH0sCgogICAgCiAgICBfc29ydCA6IGZ1bmN0aW9uKHByb3BlcnR5LCBkaXIsIGZuKXsKICAgICAgICB2YXIgaSwgbGVuLAogICAgICAgICAgICBkc2MgICA9IFN0cmluZyhkaXIpLnRvVXBwZXJDYXNlKCkgPT0gJ0RFU0MnID8gLTEgOiAxLAoKICAgICAgICAgICAgCiAgICAgICAgICAgIGMgICAgID0gW10sCiAgICAgICAgICAgIGtleXMgID0gdGhpcy5rZXlzLAogICAgICAgICAgICBpdGVtcyA9IHRoaXMuaXRlbXM7CgogICAgICAgIAogICAgICAgIGZuID0gZm4gfHwgZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICByZXR1cm4gYSAtIGI7CiAgICAgICAgfTsKCiAgICAgICAgCiAgICAgICAgZm9yKGkgPSAwLCBsZW4gPSBpdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGNbYy5sZW5ndGhdID0gewogICAgICAgICAgICAgICAga2V5ICA6IGtleXNbaV0sCiAgICAgICAgICAgICAgICB2YWx1ZTogaXRlbXNbaV0sCiAgICAgICAgICAgICAgICBpbmRleDogaQogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgYy5zb3J0KGZ1bmN0aW9uKGEsIGIpewogICAgICAgICAgICB2YXIgdiA9IGZuKGFbcHJvcGVydHldLCBiW3Byb3BlcnR5XSkgKiBkc2M7CiAgICAgICAgICAgIGlmKHYgPT09IDApewogICAgICAgICAgICAgICAgdiA9IChhLmluZGV4IDwgYi5pbmRleCA/IC0xIDogMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgfSk7CgogICAgICAgIAogICAgICAgIGZvcihpID0gMCwgbGVuID0gYy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGl0ZW1zW2ldID0gY1tpXS52YWx1ZTsKICAgICAgICAgICAga2V5c1tpXSAgPSBjW2ldLmtleTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzb3J0JywgdGhpcyk7CiAgICB9LAoKICAgIAogICAgc29ydCA6IGZ1bmN0aW9uKGRpciwgZm4pewogICAgICAgIHRoaXMuX3NvcnQoJ3ZhbHVlJywgZGlyLCBmbik7CiAgICB9LAoKICAgIAogICAgcmVvcmRlcjogZnVuY3Rpb24obWFwcGluZykgewogICAgICAgIHRoaXMuc3VzcGVuZEV2ZW50cygpOwoKICAgICAgICB2YXIgaXRlbXMgPSB0aGlzLml0ZW1zLAogICAgICAgICAgICBpbmRleCA9IDAsCiAgICAgICAgICAgIGxlbmd0aCA9IGl0ZW1zLmxlbmd0aCwKICAgICAgICAgICAgb3JkZXIgPSBbXSwKICAgICAgICAgICAgcmVtYWluaW5nID0gW10sCiAgICAgICAgICAgIG9sZEluZGV4OwoKICAgICAgICAKICAgICAgICBmb3IgKG9sZEluZGV4IGluIG1hcHBpbmcpIHsKICAgICAgICAgICAgb3JkZXJbbWFwcGluZ1tvbGRJbmRleF1dID0gaXRlbXNbb2xkSW5kZXhdOwogICAgICAgIH0KCiAgICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIGlmIChtYXBwaW5nW2luZGV4XSA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHJlbWFpbmluZy5wdXNoKGl0ZW1zW2luZGV4XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBpZiAob3JkZXJbaW5kZXhdID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgb3JkZXJbaW5kZXhdID0gcmVtYWluaW5nLnNoaWZ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLmFkZEFsbChvcmRlcik7CgogICAgICAgIHRoaXMucmVzdW1lRXZlbnRzKCk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3NvcnQnLCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBrZXlTb3J0IDogZnVuY3Rpb24oZGlyLCBmbil7CiAgICAgICAgdGhpcy5fc29ydCgna2V5JywgZGlyLCBmbiB8fCBmdW5jdGlvbihhLCBiKXsKICAgICAgICAgICAgdmFyIHYxID0gU3RyaW5nKGEpLnRvVXBwZXJDYXNlKCksIHYyID0gU3RyaW5nKGIpLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiB2MSA+IHYyID8gMSA6ICh2MSA8IHYyID8gLTEgOiAwKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICBnZXRSYW5nZSA6IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpewogICAgICAgIHZhciBpdGVtcyA9IHRoaXMuaXRlbXM7CiAgICAgICAgaWYoaXRlbXMubGVuZ3RoIDwgMSl7CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgICAgc3RhcnQgPSBzdGFydCB8fCAwOwogICAgICAgIGVuZCA9IE1hdGgubWluKHR5cGVvZiBlbmQgPT0gJ3VuZGVmaW5lZCcgPyB0aGlzLmxlbmd0aC0xIDogZW5kLCB0aGlzLmxlbmd0aC0xKTsKICAgICAgICB2YXIgaSwgciA9IFtdOwogICAgICAgIGlmKHN0YXJ0IDw9IGVuZCl7CiAgICAgICAgICAgIGZvcihpID0gc3RhcnQ7IGkgPD0gZW5kOyBpKyspIHsKICAgICAgICAgICAgICAgIHJbci5sZW5ndGhdID0gaXRlbXNbaV07CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgZm9yKGkgPSBzdGFydDsgaSA+PSBlbmQ7IGktLSkgewogICAgICAgICAgICAgICAgcltyLmxlbmd0aF0gPSBpdGVtc1tpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcjsKICAgIH0sCgogICAgCiAgICBmaWx0ZXIgOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUsIGFueU1hdGNoLCBjYXNlU2Vuc2l0aXZlKXsKICAgICAgICBpZihFeHQuaXNFbXB0eSh2YWx1ZSwgZmFsc2UpKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2xvbmUoKTsKICAgICAgICB9CiAgICAgICAgdmFsdWUgPSB0aGlzLmNyZWF0ZVZhbHVlTWF0Y2hlcih2YWx1ZSwgYW55TWF0Y2gsIGNhc2VTZW5zaXRpdmUpOwogICAgICAgIHJldHVybiB0aGlzLmZpbHRlckJ5KGZ1bmN0aW9uKG8pewogICAgICAgICAgICByZXR1cm4gbyAmJiB2YWx1ZS50ZXN0KG9bcHJvcGVydHldKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICBmaWx0ZXJCeSA6IGZ1bmN0aW9uKGZuLCBzY29wZSl7CiAgICAgICAgdmFyIHIgPSBuZXcgRXh0LnV0aWwuTWl4ZWRDb2xsZWN0aW9uKCk7CiAgICAgICAgci5nZXRLZXkgPSB0aGlzLmdldEtleTsKICAgICAgICB2YXIgayA9IHRoaXMua2V5cywgaXQgPSB0aGlzLml0ZW1zOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGl0Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgaWYoZm4uY2FsbChzY29wZXx8dGhpcywgaXRbaV0sIGtbaV0pKXsKICAgICAgICAgICAgICAgIHIuYWRkKGtbaV0sIGl0W2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcjsKICAgIH0sCgogICAgCiAgICBmaW5kSW5kZXggOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUsIHN0YXJ0LCBhbnlNYXRjaCwgY2FzZVNlbnNpdGl2ZSl7CiAgICAgICAgaWYoRXh0LmlzRW1wdHkodmFsdWUsIGZhbHNlKSl7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgdmFsdWUgPSB0aGlzLmNyZWF0ZVZhbHVlTWF0Y2hlcih2YWx1ZSwgYW55TWF0Y2gsIGNhc2VTZW5zaXRpdmUpOwogICAgICAgIHJldHVybiB0aGlzLmZpbmRJbmRleEJ5KGZ1bmN0aW9uKG8pewogICAgICAgICAgICByZXR1cm4gbyAmJiB2YWx1ZS50ZXN0KG9bcHJvcGVydHldKTsKICAgICAgICB9LCBudWxsLCBzdGFydCk7CiAgICB9LAoKICAgIAogICAgZmluZEluZGV4QnkgOiBmdW5jdGlvbihmbiwgc2NvcGUsIHN0YXJ0KXsKICAgICAgICB2YXIgayA9IHRoaXMua2V5cywgaXQgPSB0aGlzLml0ZW1zOwogICAgICAgIGZvcih2YXIgaSA9IChzdGFydHx8MCksIGxlbiA9IGl0Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgaWYoZm4uY2FsbChzY29wZXx8dGhpcywgaXRbaV0sIGtbaV0pKXsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVWYWx1ZU1hdGNoZXIgOiBmdW5jdGlvbih2YWx1ZSwgYW55TWF0Y2gsIGNhc2VTZW5zaXRpdmUsIGV4YWN0TWF0Y2gpIHsKICAgICAgICBpZiAoIXZhbHVlLmV4ZWMpIHsgCiAgICAgICAgICAgIHZhciBlciA9IEV4dC5lc2NhcGVSZTsKICAgICAgICAgICAgdmFsdWUgPSBTdHJpbmcodmFsdWUpOwoKICAgICAgICAgICAgaWYgKGFueU1hdGNoID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGVyKHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gJ14nICsgZXIodmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKGV4YWN0TWF0Y2ggPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSArPSAnJCc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFsdWUgPSBuZXcgUmVnRXhwKHZhbHVlLCBjYXNlU2Vuc2l0aXZlID8gJycgOiAnaScpOwogICAgICAgICB9CiAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCgogICAgCiAgICBjbG9uZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHIgPSBuZXcgRXh0LnV0aWwuTWl4ZWRDb2xsZWN0aW9uKCk7CiAgICAgICAgdmFyIGsgPSB0aGlzLmtleXMsIGl0ID0gdGhpcy5pdGVtczsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBpdC5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIHIuYWRkKGtbaV0sIGl0W2ldKTsKICAgICAgICB9CiAgICAgICAgci5nZXRLZXkgPSB0aGlzLmdldEtleTsKICAgICAgICByZXR1cm4gcjsKICAgIH0KfSk7CgpFeHQudXRpbC5NaXhlZENvbGxlY3Rpb24ucHJvdG90eXBlLmdldCA9IEV4dC51dGlsLk1peGVkQ29sbGVjdGlvbi5wcm90b3R5cGUuaXRlbTsKCkV4dC5BYnN0cmFjdE1hbmFnZXIgPSBFeHQuZXh0ZW5kKE9iamVjdCwgewogICAgdHlwZU5hbWU6ICd0eXBlJywKICAgIAogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcgfHwge30pOwogICAgICAgIAogICAgICAgIAogICAgICAgIHRoaXMuYWxsID0gbmV3IEV4dC51dGlsLk1peGVkQ29sbGVjdGlvbigpOwogICAgICAgIAogICAgICAgIHRoaXMudHlwZXMgPSB7fTsKICAgIH0sCiAgICAKICAgIAogICAgZ2V0IDogZnVuY3Rpb24oaWQpewogICAgICAgIHJldHVybiB0aGlzLmFsbC5nZXQoaWQpOwogICAgfSwKICAgIAogICAgCiAgICByZWdpc3RlcjogZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHRoaXMuYWxsLmFkZChpdGVtKTsKICAgIH0sCiAgICAKICAgIAogICAgdW5yZWdpc3RlcjogZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHRoaXMuYWxsLnJlbW92ZShpdGVtKTsgICAgICAgIAogICAgfSwKICAgIAogICAgCiAgICByZWdpc3RlclR5cGUgOiBmdW5jdGlvbih0eXBlLCBjbHMpewogICAgICAgIHRoaXMudHlwZXNbdHlwZV0gPSBjbHM7CiAgICAgICAgY2xzW3RoaXMudHlwZU5hbWVdID0gdHlwZTsKICAgIH0sCiAgICAKICAgIAogICAgaXNSZWdpc3RlcmVkIDogZnVuY3Rpb24odHlwZSl7CiAgICAgICAgcmV0dXJuIHRoaXMudHlwZXNbdHlwZV0gIT09IHVuZGVmaW5lZDsgICAgCiAgICB9LAogICAgCiAgICAKICAgIGNyZWF0ZTogZnVuY3Rpb24oY29uZmlnLCBkZWZhdWx0VHlwZSkgewogICAgICAgIHZhciB0eXBlICAgICAgICA9IGNvbmZpZ1t0aGlzLnR5cGVOYW1lXSB8fCBjb25maWcudHlwZSB8fCBkZWZhdWx0VHlwZSwKICAgICAgICAgICAgQ29uc3RydWN0b3IgPSB0aGlzLnR5cGVzW3R5cGVdOwogICAgICAgIAogICAgICAgIGlmIChDb25zdHJ1Y3RvciA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFN0cmluZy5mb3JtYXQoIlRoZSAnezB9JyB0eXBlIGhhcyBub3QgYmVlbiByZWdpc3RlcmVkIHdpdGggdGhpcyBtYW5hZ2VyIiwgdHlwZSkpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gbmV3IENvbnN0cnVjdG9yKGNvbmZpZyk7CiAgICB9LAogICAgCiAgICAKICAgIG9uQXZhaWxhYmxlIDogZnVuY3Rpb24oaWQsIGZuLCBzY29wZSl7CiAgICAgICAgdmFyIGFsbCA9IHRoaXMuYWxsOwogICAgICAgIAogICAgICAgIGFsbC5vbigiYWRkIiwgZnVuY3Rpb24oaW5kZXgsIG8pewogICAgICAgICAgICBpZiAoby5pZCA9PSBpZCkgewogICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCBvLCBvKTsKICAgICAgICAgICAgICAgIGFsbC51bigiYWRkIiwgZm4sIHNjb3BlKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQp9KTsKRXh0LnV0aWwuRm9ybWF0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgdHJpbVJlICAgICAgICAgPSAvXlxzK3xccyskL2csCiAgICAgICAgc3RyaXBUYWdzUkUgICAgPSAvPFwvP1tePl0rPi9naSwKICAgICAgICBzdHJpcFNjcmlwdHNSZSA9IC8oPzo8c2NyaXB0Lio/PikoKFxufFxyfC4pKj8pKD86PFwvc2NyaXB0PikvaWcsCiAgICAgICAgbmwyYnJSZSAgICAgICAgPSAvXHI/XG4vZzsKCiAgICByZXR1cm4gewogICAgICAgIAogICAgICAgIGVsbGlwc2lzIDogZnVuY3Rpb24odmFsdWUsIGxlbiwgd29yZCkgewogICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoID4gbGVuKSB7CiAgICAgICAgICAgICAgICBpZiAod29yZCkgewogICAgICAgICAgICAgICAgICAgIHZhciB2cyAgICA9IHZhbHVlLnN1YnN0cigwLCBsZW4gLSAyKSwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBNYXRoLm1heCh2cy5sYXN0SW5kZXhPZignICcpLCB2cy5sYXN0SW5kZXhPZignLicpLCB2cy5sYXN0SW5kZXhPZignIScpLCB2cy5sYXN0SW5kZXhPZignPycpKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT0gLTEgfHwgaW5kZXggPCAobGVuIC0gMTUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS5zdWJzdHIoMCwgbGVuIC0gMykgKyAiLi4uIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdnMuc3Vic3RyKDAsIGluZGV4KSArICIuLi4iOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnN1YnN0cigwLCBsZW4gLSAzKSArICIuLi4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICB1bmRlZiA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkID8gdmFsdWUgOiAiIjsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBkZWZhdWx0VmFsdWUgOiBmdW5jdGlvbih2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSAnJyA/IHZhbHVlIDogZGVmYXVsdFZhbHVlOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGh0bWxFbmNvZGUgOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gIXZhbHVlID8gdmFsdWUgOiBTdHJpbmcodmFsdWUpLnJlcGxhY2UoLyYvZywgIiZhbXA7IikucmVwbGFjZSgvPi9nLCAiJmd0OyIpLnJlcGxhY2UoLzwvZywgIiZsdDsiKS5yZXBsYWNlKC8iL2csICImcXVvdDsiKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBodG1sRGVjb2RlIDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuICF2YWx1ZSA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKS5yZXBsYWNlKC8mZ3Q7L2csICI+IikucmVwbGFjZSgvJmx0Oy9nLCAiPCIpLnJlcGxhY2UoLyZxdW90Oy9nLCAnIicpLnJlcGxhY2UoLyZhbXA7L2csICImIik7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgdHJpbSA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnJlcGxhY2UodHJpbVJlLCAiIik7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgc3Vic3RyIDogZnVuY3Rpb24odmFsdWUsIHN0YXJ0LCBsZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkuc3Vic3RyKHN0YXJ0LCBsZW5ndGgpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGxvd2VyY2FzZSA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgdXBwZXJjYXNlIDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9VcHBlckNhc2UoKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBjYXBpdGFsaXplIDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuICF2YWx1ZSA/IHZhbHVlIDogdmFsdWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB2YWx1ZS5zdWJzdHIoMSkudG9Mb3dlckNhc2UoKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBjYWxsIDogZnVuY3Rpb24odmFsdWUsIGZuKSB7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMikgewogICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgICAgICAgICAgICAgYXJncy51bnNoaWZ0KHZhbHVlKTsKICAgICAgICAgICAgICAgIHJldHVybiBldmFsKGZuKS5hcHBseSh3aW5kb3csIGFyZ3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGV2YWwoZm4pLmNhbGwod2luZG93LCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICB1c01vbmV5IDogZnVuY3Rpb24odikgewogICAgICAgICAgICB2ID0gKE1hdGgucm91bmQoKHYtMCkqMTAwKSkvMTAwOwogICAgICAgICAgICB2ID0gKHYgPT0gTWF0aC5mbG9vcih2KSkgPyB2ICsgIi4wMCIgOiAoKHYqMTAgPT0gTWF0aC5mbG9vcih2KjEwKSkgPyB2ICsgIjAiIDogdik7CiAgICAgICAgICAgIHYgPSBTdHJpbmcodik7CiAgICAgICAgICAgIHZhciBwcyA9IHYuc3BsaXQoJy4nKSwKICAgICAgICAgICAgICAgIHdob2xlID0gcHNbMF0sCiAgICAgICAgICAgICAgICBzdWIgPSBwc1sxXSA/ICcuJysgcHNbMV0gOiAnLjAwJywKICAgICAgICAgICAgICAgIHIgPSAvKFxkKykoXGR7M30pLzsKICAgICAgICAgICAgd2hpbGUgKHIudGVzdCh3aG9sZSkpIHsKICAgICAgICAgICAgICAgIHdob2xlID0gd2hvbGUucmVwbGFjZShyLCAnJDEnICsgJywnICsgJyQyJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdiA9IHdob2xlICsgc3ViOwogICAgICAgICAgICBpZiAodi5jaGFyQXQoMCkgPT0gJy0nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJy0kJyArIHYuc3Vic3RyKDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiJCIgKyAgdjsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBkYXRlIDogZnVuY3Rpb24odiwgZm9ybWF0KSB7CiAgICAgICAgICAgIGlmICghdikgewogICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghRXh0LmlzRGF0ZSh2KSkgewogICAgICAgICAgICAgICAgdiA9IG5ldyBEYXRlKERhdGUucGFyc2UodikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2LmRhdGVGb3JtYXQoZm9ybWF0IHx8ICJtL2QvWSIpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGRhdGVSZW5kZXJlciA6IGZ1bmN0aW9uKGZvcm1hdCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24odikgewogICAgICAgICAgICAgICAgcmV0dXJuIEV4dC51dGlsLkZvcm1hdC5kYXRlKHYsIGZvcm1hdCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgc3RyaXBUYWdzIDogZnVuY3Rpb24odikgewogICAgICAgICAgICByZXR1cm4gIXYgPyB2IDogU3RyaW5nKHYpLnJlcGxhY2Uoc3RyaXBUYWdzUkUsICIiKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBzdHJpcFNjcmlwdHMgOiBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgIHJldHVybiAhdiA/IHYgOiBTdHJpbmcodikucmVwbGFjZShzdHJpcFNjcmlwdHNSZSwgIiIpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGZpbGVTaXplIDogZnVuY3Rpb24oc2l6ZSkgewogICAgICAgICAgICBpZiAoc2l6ZSA8IDEwMjQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzaXplICsgIiBieXRlcyI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2l6ZSA8IDEwNDg1NzYpIHsKICAgICAgICAgICAgICAgIHJldHVybiAoTWF0aC5yb3VuZCgoKHNpemUqMTApIC8gMTAyNCkpLzEwKSArICIgS0IiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIChNYXRoLnJvdW5kKCgoc2l6ZSoxMCkgLyAxMDQ4NTc2KSkvMTApICsgIiBNQiI7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBtYXRoIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIGZucyA9IHt9OwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHYsIGEpewogICAgICAgICAgICAgICAgaWYgKCFmbnNbYV0pIHsKICAgICAgICAgICAgICAgICAgICBmbnNbYV0gPSBuZXcgRnVuY3Rpb24oJ3YnLCAncmV0dXJuIHYgJyArIGEgKyAnOycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGZuc1thXSh2KTsKICAgICAgICAgICAgfTsKICAgICAgICB9KCksCgogICAgICAgIAogICAgICAgIHJvdW5kIDogZnVuY3Rpb24odmFsdWUsIHByZWNpc2lvbikgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gTnVtYmVyKHZhbHVlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwcmVjaXNpb24gPT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgIHByZWNpc2lvbiA9IE1hdGgucG93KDEwLCBwcmVjaXNpb24pOwogICAgICAgICAgICAgICAgcmVzdWx0ID0gTWF0aC5yb3VuZCh2YWx1ZSAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBudW1iZXI6IGZ1bmN0aW9uKHYsIGZvcm1hdCkgewogICAgICAgICAgICBpZiAoIWZvcm1hdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdiA9IEV4dC5udW0odiwgTmFOKTsKICAgICAgICAgICAgaWYgKGlzTmFOKHYpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbW1hID0gJywnLAogICAgICAgICAgICAgICAgZGVjICAgPSAnLicsCiAgICAgICAgICAgICAgICBpMThuICA9IGZhbHNlLAogICAgICAgICAgICAgICAgbmVnICAgPSB2IDwgMDsKCiAgICAgICAgICAgIHYgPSBNYXRoLmFicyh2KTsKICAgICAgICAgICAgaWYgKGZvcm1hdC5zdWJzdHIoZm9ybWF0Lmxlbmd0aCAtIDIpID09ICcvaScpIHsKICAgICAgICAgICAgICAgIGZvcm1hdCA9IGZvcm1hdC5zdWJzdHIoMCwgZm9ybWF0Lmxlbmd0aCAtIDIpOwogICAgICAgICAgICAgICAgaTE4biAgID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbW1hICA9ICcuJzsKICAgICAgICAgICAgICAgIGRlYyAgICA9ICcsJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGhhc0NvbW1hID0gZm9ybWF0LmluZGV4T2YoY29tbWEpICE9IC0xLAogICAgICAgICAgICAgICAgcHNwbGl0ICAgPSAoaTE4biA/IGZvcm1hdC5yZXBsYWNlKC9bXlxkXCxdL2csICcnKSA6IGZvcm1hdC5yZXBsYWNlKC9bXlxkXC5dL2csICcnKSkuc3BsaXQoZGVjKTsKCiAgICAgICAgICAgIGlmICgxIDwgcHNwbGl0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdiA9IHYudG9GaXhlZChwc3BsaXRbMV0ubGVuZ3RoKTsKICAgICAgICAgICAgfSBlbHNlIGlmKDIgPCBwc3BsaXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAoJ051bWJlckZvcm1hdEV4Y2VwdGlvbjogaW52YWxpZCBmb3JtYXQsIGZvcm1hdHMgc2hvdWxkIGhhdmUgbm8gbW9yZSB0aGFuIDEgcGVyaW9kOiAnICsgZm9ybWF0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHYgPSB2LnRvRml4ZWQoMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBmbnVtID0gdi50b1N0cmluZygpOwoKICAgICAgICAgICAgcHNwbGl0ID0gZm51bS5zcGxpdCgnLicpOwoKICAgICAgICAgICAgaWYgKGhhc0NvbW1hKSB7CiAgICAgICAgICAgICAgICB2YXIgY251bSA9IHBzcGxpdFswXSwgCiAgICAgICAgICAgICAgICAgICAgcGFyciA9IFtdLCAKICAgICAgICAgICAgICAgICAgICBqICAgID0gY251bS5sZW5ndGgsIAogICAgICAgICAgICAgICAgICAgIG0gICAgPSBNYXRoLmZsb29yKGogLyAzKSwKICAgICAgICAgICAgICAgICAgICBuICAgID0gY251bS5sZW5ndGggJSAzIHx8IDMsCiAgICAgICAgICAgICAgICAgICAgaTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgajsgaSArPSBuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGkgIT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBuID0gMzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcGFycltwYXJyLmxlbmd0aF0gPSBjbnVtLnN1YnN0cihpLCBuKTsKICAgICAgICAgICAgICAgICAgICBtIC09IDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmbnVtID0gcGFyci5qb2luKGNvbW1hKTsKICAgICAgICAgICAgICAgIGlmIChwc3BsaXRbMV0pIHsKICAgICAgICAgICAgICAgICAgICBmbnVtICs9IGRlYyArIHBzcGxpdFsxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChwc3BsaXRbMV0pIHsKICAgICAgICAgICAgICAgICAgICBmbnVtID0gcHNwbGl0WzBdICsgZGVjICsgcHNwbGl0WzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gKG5lZyA/ICctJyA6ICcnKSArIGZvcm1hdC5yZXBsYWNlKC9bXGQsP1wuP10rLywgZm51bSk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgbnVtYmVyUmVuZGVyZXIgOiBmdW5jdGlvbihmb3JtYXQpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBFeHQudXRpbC5Gb3JtYXQubnVtYmVyKHYsIGZvcm1hdCk7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcGx1cmFsIDogZnVuY3Rpb24odiwgcywgcCkgewogICAgICAgICAgICByZXR1cm4gdiArJyAnICsgKHYgPT0gMSA/IHMgOiAocCA/IHAgOiBzKydzJykpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIG5sMmJyIDogZnVuY3Rpb24odikgewogICAgICAgICAgICByZXR1cm4gRXh0LmlzRW1wdHkodikgPyAnJyA6IHYucmVwbGFjZShubDJiclJlLCAnPGJyLz4nKTsKICAgICAgICB9CiAgICB9Owp9KCk7CgpFeHQuWFRlbXBsYXRlID0gZnVuY3Rpb24oKXsKICAgIEV4dC5YVGVtcGxhdGUuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgcyA9IG1lLmh0bWwsCiAgICAgICAgcmUgPSAvPHRwbFxiW14+XSo+KCg/Oig/PShbXjxdKykpXDJ8PCg/IXRwbFxiW14+XSo+KSkqPyk8XC90cGw+LywKICAgICAgICBuYW1lUmUgPSAvXjx0cGxcYltePl0qP2Zvcj0iKC4qPykiLywKICAgICAgICBpZlJlID0gL148dHBsXGJbXj5dKj9pZj0iKC4qPykiLywKICAgICAgICBleGVjUmUgPSAvXjx0cGxcYltePl0qP2V4ZWM9IiguKj8pIi8sCiAgICAgICAgbSwKICAgICAgICBpZCA9IDAsCiAgICAgICAgdHBscyA9IFtdLAogICAgICAgIFZBTFVFUyA9ICd2YWx1ZXMnLAogICAgICAgIFBBUkVOVCA9ICdwYXJlbnQnLAogICAgICAgIFhJTkRFWCA9ICd4aW5kZXgnLAogICAgICAgIFhDT1VOVCA9ICd4Y291bnQnLAogICAgICAgIFJFVFVSTiA9ICdyZXR1cm4gJywKICAgICAgICBXSVRIVkFMVUVTID0gJ3dpdGgodmFsdWVzKXsgJzsKCiAgICBzID0gWyc8dHBsPicsIHMsICc8L3RwbD4nXS5qb2luKCcnKTsKCiAgICB3aGlsZSgobSA9IHMubWF0Y2gocmUpKSl7CiAgICAgICAgdmFyIG0yID0gbVswXS5tYXRjaChuYW1lUmUpLAogICAgICAgICAgICBtMyA9IG1bMF0ubWF0Y2goaWZSZSksCiAgICAgICAgICAgIG00ID0gbVswXS5tYXRjaChleGVjUmUpLAogICAgICAgICAgICBleHAgPSBudWxsLAogICAgICAgICAgICBmbiA9IG51bGwsCiAgICAgICAgICAgIGV4ZWMgPSBudWxsLAogICAgICAgICAgICBuYW1lID0gbTIgJiYgbTJbMV0gPyBtMlsxXSA6ICcnOwoKICAgICAgIGlmIChtMykgewogICAgICAgICAgIGV4cCA9IG0zICYmIG0zWzFdID8gbTNbMV0gOiBudWxsOwogICAgICAgICAgIGlmKGV4cCl7CiAgICAgICAgICAgICAgIGZuID0gbmV3IEZ1bmN0aW9uKFZBTFVFUywgUEFSRU5ULCBYSU5ERVgsIFhDT1VOVCwgV0lUSFZBTFVFUyArIFJFVFVSTiArKEV4dC51dGlsLkZvcm1hdC5odG1sRGVjb2RlKGV4cCkpKyc7IH0nKTsKICAgICAgICAgICB9CiAgICAgICB9CiAgICAgICBpZiAobTQpIHsKICAgICAgICAgICBleHAgPSBtNCAmJiBtNFsxXSA/IG00WzFdIDogbnVsbDsKICAgICAgICAgICBpZihleHApewogICAgICAgICAgICAgICBleGVjID0gbmV3IEZ1bmN0aW9uKFZBTFVFUywgUEFSRU5ULCBYSU5ERVgsIFhDT1VOVCwgV0lUSFZBTFVFUyArKEV4dC51dGlsLkZvcm1hdC5odG1sRGVjb2RlKGV4cCkpKyc7IH0nKTsKICAgICAgICAgICB9CiAgICAgICB9CiAgICAgICBpZihuYW1lKXsKICAgICAgICAgICBzd2l0Y2gobmFtZSl7CiAgICAgICAgICAgICAgIGNhc2UgJy4nOiBuYW1lID0gbmV3IEZ1bmN0aW9uKFZBTFVFUywgUEFSRU5ULCBXSVRIVkFMVUVTICsgUkVUVVJOICsgVkFMVUVTICsgJzsgfScpOyBicmVhazsKICAgICAgICAgICAgICAgY2FzZSAnLi4nOiBuYW1lID0gbmV3IEZ1bmN0aW9uKFZBTFVFUywgUEFSRU5ULCBXSVRIVkFMVUVTICsgUkVUVVJOICsgUEFSRU5UICsgJzsgfScpOyBicmVhazsKICAgICAgICAgICAgICAgZGVmYXVsdDogbmFtZSA9IG5ldyBGdW5jdGlvbihWQUxVRVMsIFBBUkVOVCwgV0lUSFZBTFVFUyArIFJFVFVSTiArIG5hbWUgKyAnOyB9Jyk7CiAgICAgICAgICAgfQogICAgICAgfQogICAgICAgdHBscy5wdXNoKHsKICAgICAgICAgICAgaWQ6IGlkLAogICAgICAgICAgICB0YXJnZXQ6IG5hbWUsCiAgICAgICAgICAgIGV4ZWM6IGV4ZWMsCiAgICAgICAgICAgIHRlc3Q6IGZuLAogICAgICAgICAgICBib2R5OiBtWzFdfHwnJwogICAgICAgIH0pOwogICAgICAgcyA9IHMucmVwbGFjZShtWzBdLCAne3h0cGwnKyBpZCArICd9Jyk7CiAgICAgICArK2lkOwogICAgfQogICAgZm9yKHZhciBpID0gdHBscy5sZW5ndGgtMTsgaSA+PSAwOyAtLWkpewogICAgICAgIG1lLmNvbXBpbGVUcGwodHBsc1tpXSk7CiAgICB9CiAgICBtZS5tYXN0ZXIgPSB0cGxzW3RwbHMubGVuZ3RoLTFdOwogICAgbWUudHBscyA9IHRwbHM7Cn07CkV4dC5leHRlbmQoRXh0LlhUZW1wbGF0ZSwgRXh0LlRlbXBsYXRlLCB7CiAgICAKICAgIHJlIDogL1x7KFtcd1wtXC5cI10rKSg/Olw6KFtcd1wuXSopKD86XCgoLio/KT9cKSk/KT8oXHM/W1wrXC1cKlxcXVxzP1tcZFwuXCtcLVwqXFxcKFwpXSspP1x9L2csCiAgICAKICAgIGNvZGVSZSA6IC9ce1xbKCg/OlxcXF18LnxcbikqPylcXVx9L2csCgogICAgCiAgICBhcHBseVN1YlRlbXBsYXRlIDogZnVuY3Rpb24oaWQsIHZhbHVlcywgcGFyZW50LCB4aW5kZXgsIHhjb3VudCl7CiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgbGVuLAogICAgICAgICAgICB0ID0gbWUudHBsc1tpZF0sCiAgICAgICAgICAgIHZzLAogICAgICAgICAgICBidWYgPSBbXTsKICAgICAgICBpZiAoKHQudGVzdCAmJiAhdC50ZXN0LmNhbGwobWUsIHZhbHVlcywgcGFyZW50LCB4aW5kZXgsIHhjb3VudCkpIHx8CiAgICAgICAgICAgICh0LmV4ZWMgJiYgdC5leGVjLmNhbGwobWUsIHZhbHVlcywgcGFyZW50LCB4aW5kZXgsIHhjb3VudCkpKSB7CiAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9CiAgICAgICAgdnMgPSB0LnRhcmdldCA/IHQudGFyZ2V0LmNhbGwobWUsIHZhbHVlcywgcGFyZW50KSA6IHZhbHVlczsKICAgICAgICBsZW4gPSB2cy5sZW5ndGg7CiAgICAgICAgcGFyZW50ID0gdC50YXJnZXQgPyB2YWx1ZXMgOiBwYXJlbnQ7CiAgICAgICAgaWYodC50YXJnZXQgJiYgRXh0LmlzQXJyYXkodnMpKXsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gdnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgYnVmW2J1Zi5sZW5ndGhdID0gdC5jb21waWxlZC5jYWxsKG1lLCB2c1tpXSwgcGFyZW50LCBpKzEsIGxlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJ1Zi5qb2luKCcnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHQuY29tcGlsZWQuY2FsbChtZSwgdnMsIHBhcmVudCwgeGluZGV4LCB4Y291bnQpOwogICAgfSwKCiAgICAKICAgIGNvbXBpbGVUcGwgOiBmdW5jdGlvbih0cGwpewogICAgICAgIHZhciBmbSA9IEV4dC51dGlsLkZvcm1hdCwKICAgICAgICAgICAgdXNlRiA9IHRoaXMuZGlzYWJsZUZvcm1hdHMgIT09IHRydWUsCiAgICAgICAgICAgIHNlcCA9IEV4dC5pc0dlY2tvID8gIisiIDogIiwiLAogICAgICAgICAgICBib2R5OwoKICAgICAgICBmdW5jdGlvbiBmbihtLCBuYW1lLCBmb3JtYXQsIGFyZ3MsIG1hdGgpewogICAgICAgICAgICBpZihuYW1lLnN1YnN0cigwLCA0KSA9PSAneHRwbCcpewogICAgICAgICAgICAgICAgcmV0dXJuICInIisgc2VwICsndGhpcy5hcHBseVN1YlRlbXBsYXRlKCcrbmFtZS5zdWJzdHIoNCkrJywgdmFsdWVzLCBwYXJlbnQsIHhpbmRleCwgeGNvdW50KScrc2VwKyInIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdjsKICAgICAgICAgICAgaWYobmFtZSA9PT0gJy4nKXsKICAgICAgICAgICAgICAgIHYgPSAndmFsdWVzJzsKICAgICAgICAgICAgfWVsc2UgaWYobmFtZSA9PT0gJyMnKXsKICAgICAgICAgICAgICAgIHYgPSAneGluZGV4JzsKICAgICAgICAgICAgfWVsc2UgaWYobmFtZS5pbmRleE9mKCcuJykgIT0gLTEpewogICAgICAgICAgICAgICAgdiA9IG5hbWU7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdiA9ICJ2YWx1ZXNbJyIgKyBuYW1lICsgIiddIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihtYXRoKXsKICAgICAgICAgICAgICAgIHYgPSAnKCcgKyB2ICsgbWF0aCArICcpJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZm9ybWF0ICYmIHVzZUYpIHsKICAgICAgICAgICAgICAgIGFyZ3MgPSBhcmdzID8gJywnICsgYXJncyA6ICIiOwogICAgICAgICAgICAgICAgaWYoZm9ybWF0LnN1YnN0cigwLCA1KSAhPSAidGhpcy4iKXsKICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSAiZm0uIiArIGZvcm1hdCArICcoJzsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIGZvcm1hdCA9ICd0aGlzLmNhbGwoIicrIGZvcm1hdC5zdWJzdHIoNSkgKyAnIiwgJzsKICAgICAgICAgICAgICAgICAgICBhcmdzID0gIiwgdmFsdWVzIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFyZ3M9ICcnOyBmb3JtYXQgPSAiKCIrdisiID09PSB1bmRlZmluZWQgPyAnJyA6ICI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICInIisgc2VwICsgZm9ybWF0ICsgdiArIGFyZ3MgKyAiKSIrc2VwKyInIjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNvZGVGbihtLCBjb2RlKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiAiJyIgKyBzZXAgKyAnKCcgKyBjb2RlLnJlcGxhY2UoL1xcJy9nLCAiJyIpICsgJyknICsgc2VwICsgIiciOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYoRXh0LmlzR2Vja28pewogICAgICAgICAgICBib2R5ID0gInRwbC5jb21waWxlZCA9IGZ1bmN0aW9uKHZhbHVlcywgcGFyZW50LCB4aW5kZXgsIHhjb3VudCl7IHJldHVybiAnIiArCiAgICAgICAgICAgICAgICAgICB0cGwuYm9keS5yZXBsYWNlKC8oXHJcbnxcbikvZywgJ1xcbicpLnJlcGxhY2UoLycvZywgIlxcJyIpLnJlcGxhY2UodGhpcy5yZSwgZm4pLnJlcGxhY2UodGhpcy5jb2RlUmUsIGNvZGVGbikgKwogICAgICAgICAgICAgICAgICAgICInO307IjsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgYm9keSA9IFsidHBsLmNvbXBpbGVkID0gZnVuY3Rpb24odmFsdWVzLCBwYXJlbnQsIHhpbmRleCwgeGNvdW50KXsgcmV0dXJuIFsnIl07CiAgICAgICAgICAgIGJvZHkucHVzaCh0cGwuYm9keS5yZXBsYWNlKC8oXHJcbnxcbikvZywgJ1xcbicpLnJlcGxhY2UoLycvZywgIlxcJyIpLnJlcGxhY2UodGhpcy5yZSwgZm4pLnJlcGxhY2UodGhpcy5jb2RlUmUsIGNvZGVGbikpOwogICAgICAgICAgICBib2R5LnB1c2goIiddLmpvaW4oJycpO307Iik7CiAgICAgICAgICAgIGJvZHkgPSBib2R5LmpvaW4oJycpOwogICAgICAgIH0KICAgICAgICBldmFsKGJvZHkpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGFwcGx5VGVtcGxhdGUgOiBmdW5jdGlvbih2YWx1ZXMpewogICAgICAgIHJldHVybiB0aGlzLm1hc3Rlci5jb21waWxlZC5jYWxsKHRoaXMsIHZhbHVlcywge30sIDEsIDEpOwogICAgfSwKCiAgICAKICAgIGNvbXBpbGUgOiBmdW5jdGlvbigpe3JldHVybiB0aGlzO30KCiAgICAKICAgIAogICAgCgp9KTsKCkV4dC5YVGVtcGxhdGUucHJvdG90eXBlLmFwcGx5ID0gRXh0LlhUZW1wbGF0ZS5wcm90b3R5cGUuYXBwbHlUZW1wbGF0ZTsKCgpFeHQuWFRlbXBsYXRlLmZyb20gPSBmdW5jdGlvbihlbCl7CiAgICBlbCA9IEV4dC5nZXREb20oZWwpOwogICAgcmV0dXJuIG5ldyBFeHQuWFRlbXBsYXRlKGVsLnZhbHVlIHx8IGVsLmlubmVySFRNTCk7Cn07CgpFeHQudXRpbC5DU1MgPSBmdW5jdGlvbigpewoJdmFyIHJ1bGVzID0gbnVsbDsKICAgCXZhciBkb2MgPSBkb2N1bWVudDsKCiAgICB2YXIgY2FtZWxSZSA9IC8oLVthLXpdKS9naTsKICAgIHZhciBjYW1lbEZuID0gZnVuY3Rpb24obSwgYSl7IHJldHVybiBhLmNoYXJBdCgxKS50b1VwcGVyQ2FzZSgpOyB9OwoKICAgcmV0dXJuIHsKICAgCiAgIGNyZWF0ZVN0eWxlU2hlZXQgOiBmdW5jdGlvbihjc3NUZXh0LCBpZCl7CiAgICAgICB2YXIgc3M7CiAgICAgICB2YXIgaGVhZCA9IGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdOwogICAgICAgdmFyIHJ1bGVzID0gZG9jLmNyZWF0ZUVsZW1lbnQoInN0eWxlIik7CiAgICAgICBydWxlcy5zZXRBdHRyaWJ1dGUoInR5cGUiLCAidGV4dC9jc3MiKTsKICAgICAgIGlmKGlkKXsKICAgICAgICAgICBydWxlcy5zZXRBdHRyaWJ1dGUoImlkIiwgaWQpOwogICAgICAgfQogICAgICAgaWYoRXh0LmlzSUUpewogICAgICAgICAgIGhlYWQuYXBwZW5kQ2hpbGQocnVsZXMpOwogICAgICAgICAgIHNzID0gcnVsZXMuc3R5bGVTaGVldDsKICAgICAgICAgICBzcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgICAgIH1lbHNlewogICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICAgIHJ1bGVzLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVUZXh0Tm9kZShjc3NUZXh0KSk7CiAgICAgICAgICAgfWNhdGNoKGUpewogICAgICAgICAgICAgICBydWxlcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgICAgICAgICB9CiAgICAgICAgICAgaGVhZC5hcHBlbmRDaGlsZChydWxlcyk7CiAgICAgICAgICAgc3MgPSBydWxlcy5zdHlsZVNoZWV0ID8gcnVsZXMuc3R5bGVTaGVldCA6IChydWxlcy5zaGVldCB8fCBkb2Muc3R5bGVTaGVldHNbZG9jLnN0eWxlU2hlZXRzLmxlbmd0aC0xXSk7CiAgICAgICB9CiAgICAgICB0aGlzLmNhY2hlU3R5bGVTaGVldChzcyk7CiAgICAgICByZXR1cm4gc3M7CiAgIH0sCgogICAKICAgcmVtb3ZlU3R5bGVTaGVldCA6IGZ1bmN0aW9uKGlkKXsKICAgICAgIHZhciBleGlzdGluZyA9IGRvYy5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICBpZihleGlzdGluZyl7CiAgICAgICAgICAgZXhpc3RpbmcucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChleGlzdGluZyk7CiAgICAgICB9CiAgIH0sCgogICAKICAgc3dhcFN0eWxlU2hlZXQgOiBmdW5jdGlvbihpZCwgdXJsKXsKICAgICAgIHRoaXMucmVtb3ZlU3R5bGVTaGVldChpZCk7CiAgICAgICB2YXIgc3MgPSBkb2MuY3JlYXRlRWxlbWVudCgibGluayIpOwogICAgICAgc3Muc2V0QXR0cmlidXRlKCJyZWwiLCAic3R5bGVzaGVldCIpOwogICAgICAgc3Muc2V0QXR0cmlidXRlKCJ0eXBlIiwgInRleHQvY3NzIik7CiAgICAgICBzcy5zZXRBdHRyaWJ1dGUoImlkIiwgaWQpOwogICAgICAgc3Muc2V0QXR0cmlidXRlKCJocmVmIiwgdXJsKTsKICAgICAgIGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdLmFwcGVuZENoaWxkKHNzKTsKICAgfSwKICAgCiAgIAogICByZWZyZXNoQ2FjaGUgOiBmdW5jdGlvbigpewogICAgICAgcmV0dXJuIHRoaXMuZ2V0UnVsZXModHJ1ZSk7CiAgIH0sCgogICAKICAgY2FjaGVTdHlsZVNoZWV0IDogZnVuY3Rpb24oc3MpewogICAgICAgaWYoIXJ1bGVzKXsKICAgICAgICAgICBydWxlcyA9IHt9OwogICAgICAgfQogICAgICAgdHJ5ewogICAgICAgICAgIHZhciBzc1J1bGVzID0gc3MuY3NzUnVsZXMgfHwgc3MucnVsZXM7CiAgICAgICAgICAgZm9yKHZhciBqID0gc3NSdWxlcy5sZW5ndGgtMTsgaiA+PSAwOyAtLWopewogICAgICAgICAgICAgICBydWxlc1tzc1J1bGVzW2pdLnNlbGVjdG9yVGV4dC50b0xvd2VyQ2FzZSgpXSA9IHNzUnVsZXNbal07CiAgICAgICAgICAgfQogICAgICAgfWNhdGNoKGUpe30KICAgfSwKICAgCiAgIAogICBnZXRSdWxlcyA6IGZ1bmN0aW9uKHJlZnJlc2hDYWNoZSl7CiAgIAkJaWYocnVsZXMgPT09IG51bGwgfHwgcmVmcmVzaENhY2hlKXsKICAgCQkJcnVsZXMgPSB7fTsKICAgCQkJdmFyIGRzID0gZG9jLnN0eWxlU2hlZXRzOwogICAJCQlmb3IodmFyIGkgPTAsIGxlbiA9IGRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgCQkJICAgIHRyeXsKICAgIAkJICAgICAgICB0aGlzLmNhY2hlU3R5bGVTaGVldChkc1tpXSk7CiAgICAJCSAgICB9Y2F0Y2goZSl7fSAKCSAgICAgICAgfQogICAJCX0KICAgCQlyZXR1cm4gcnVsZXM7CiAgIAl9LAogICAJCiAgIAkKICAgZ2V0UnVsZSA6IGZ1bmN0aW9uKHNlbGVjdG9yLCByZWZyZXNoQ2FjaGUpewogICAJCXZhciBycyA9IHRoaXMuZ2V0UnVsZXMocmVmcmVzaENhY2hlKTsKICAgCQlpZighRXh0LmlzQXJyYXkoc2VsZWN0b3IpKXsKICAgCQkgICAgcmV0dXJuIHJzW3NlbGVjdG9yLnRvTG93ZXJDYXNlKCldOwogICAJCX0KICAgCQlmb3IodmFyIGkgPSAwOyBpIDwgc2VsZWN0b3IubGVuZ3RoOyBpKyspewoJCQlpZihyc1tzZWxlY3RvcltpXV0pewoJCQkJcmV0dXJuIHJzW3NlbGVjdG9yW2ldLnRvTG93ZXJDYXNlKCldOwoJCQl9CgkJfQoJCXJldHVybiBudWxsOwogICAJfSwKICAgCQogICAJCiAgIAkKICAgdXBkYXRlUnVsZSA6IGZ1bmN0aW9uKHNlbGVjdG9yLCBwcm9wZXJ0eSwgdmFsdWUpewogICAJCWlmKCFFeHQuaXNBcnJheShzZWxlY3RvcikpewogICAJCQl2YXIgcnVsZSA9IHRoaXMuZ2V0UnVsZShzZWxlY3Rvcik7CiAgIAkJCWlmKHJ1bGUpewogICAJCQkJcnVsZS5zdHlsZVtwcm9wZXJ0eS5yZXBsYWNlKGNhbWVsUmUsIGNhbWVsRm4pXSA9IHZhbHVlOwogICAJCQkJcmV0dXJuIHRydWU7CiAgIAkJCX0KICAgCQl9ZWxzZXsKICAgCQkJZm9yKHZhciBpID0gMDsgaSA8IHNlbGVjdG9yLmxlbmd0aDsgaSsrKXsKICAgCQkJCWlmKHRoaXMudXBkYXRlUnVsZShzZWxlY3RvcltpXSwgcHJvcGVydHksIHZhbHVlKSl7CiAgIAkJCQkJcmV0dXJuIHRydWU7CiAgIAkJCQl9CiAgIAkJCX0KICAgCQl9CiAgIAkJcmV0dXJuIGZhbHNlOwogICAJfQogICB9OwkKfSgpOwpFeHQudXRpbC5DbGlja1JlcGVhdGVyID0gRXh0LmV4dGVuZChFeHQudXRpbC5PYnNlcnZhYmxlLCB7CiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oZWwsIGNvbmZpZyl7CiAgICAgICAgdGhpcy5lbCA9IEV4dC5nZXQoZWwpOwogICAgICAgIHRoaXMuZWwudW5zZWxlY3RhYmxlKCk7CgogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwoKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAKICAgICAgICAibW91c2Vkb3duIiwKICAgICAgICAKICAgICAgICAiY2xpY2siLAogICAgICAgIAogICAgICAgICJtb3VzZXVwIgogICAgICAgICk7CgogICAgICAgIGlmKCF0aGlzLmRpc2FibGVkKXsKICAgICAgICAgICAgdGhpcy5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlKCk7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBpZih0aGlzLmhhbmRsZXIpewogICAgICAgICAgICB0aGlzLm9uKCJjbGljayIsIHRoaXMuaGFuZGxlciwgIHRoaXMuc2NvcGUgfHwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICBFeHQudXRpbC5DbGlja1JlcGVhdGVyLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsgICAgICAgIAogICAgfSwKICAgIAogICAgaW50ZXJ2YWwgOiAyMCwKICAgIGRlbGF5OiAyNTAsCiAgICBwcmV2ZW50RGVmYXVsdCA6IHRydWUsCiAgICBzdG9wRGVmYXVsdCA6IGZhbHNlLAogICAgdGltZXIgOiAwLAoKICAgIAogICAgZW5hYmxlOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICB0aGlzLmVsLm9uKCdtb3VzZWRvd24nLCB0aGlzLmhhbmRsZU1vdXNlRG93biwgdGhpcyk7CiAgICAgICAgICAgIGlmIChFeHQuaXNJRSl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLm9uKCdkYmxjbGljaycsIHRoaXMuaGFuZGxlRGJsQ2xpY2ssIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMucHJldmVudERlZmF1bHQgfHwgdGhpcy5zdG9wRGVmYXVsdCl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLm9uKCdjbGljaycsIHRoaXMuZXZlbnRPcHRpb25zLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7CiAgICB9LAoKICAgIAogICAgZGlzYWJsZTogZnVuY3Rpb24oIGZvcmNlKXsKICAgICAgICBpZihmb3JjZSB8fCAhdGhpcy5kaXNhYmxlZCl7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgICAgICAgICAgaWYodGhpcy5wcmVzc0NsYXNzKXsKICAgICAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3ModGhpcy5wcmVzc0NsYXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFeHQuZ2V0RG9jKCkudW4oJ21vdXNldXAnLCB0aGlzLmhhbmRsZU1vdXNlVXAsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUFsbExpc3RlbmVycygpOwogICAgICAgIH0KICAgICAgICB0aGlzLmRpc2FibGVkID0gdHJ1ZTsKICAgIH0sCgogICAgCiAgICBzZXREaXNhYmxlZDogZnVuY3Rpb24oZGlzYWJsZWQpewogICAgICAgIHRoaXNbZGlzYWJsZWQgPyAnZGlzYWJsZScgOiAnZW5hYmxlJ10oKTsKICAgIH0sCgogICAgZXZlbnRPcHRpb25zOiBmdW5jdGlvbihlKXsKICAgICAgICBpZih0aGlzLnByZXZlbnREZWZhdWx0KXsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnN0b3BEZWZhdWx0KXsKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZGVzdHJveSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGlzYWJsZSh0cnVlKTsKICAgICAgICBFeHQuZGVzdHJveSh0aGlzLmVsKTsKICAgICAgICB0aGlzLnB1cmdlTGlzdGVuZXJzKCk7CiAgICB9LAoKICAgIGhhbmRsZURibENsaWNrIDogZnVuY3Rpb24oZSl7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwogICAgICAgIHRoaXMuZWwuYmx1cigpOwoKICAgICAgICB0aGlzLmZpcmVFdmVudCgibW91c2Vkb3duIiwgdGhpcywgZSk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoImNsaWNrIiwgdGhpcywgZSk7CiAgICB9LAoKICAgIAogICAgaGFuZGxlTW91c2VEb3duIDogZnVuY3Rpb24oZSl7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwogICAgICAgIHRoaXMuZWwuYmx1cigpOwogICAgICAgIGlmKHRoaXMucHJlc3NDbGFzcyl7CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3ModGhpcy5wcmVzc0NsYXNzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5tb3VzZWRvd25UaW1lID0gbmV3IERhdGUoKTsKCiAgICAgICAgRXh0LmdldERvYygpLm9uKCJtb3VzZXVwIiwgdGhpcy5oYW5kbGVNb3VzZVVwLCB0aGlzKTsKICAgICAgICB0aGlzLmVsLm9uKCJtb3VzZW91dCIsIHRoaXMuaGFuZGxlTW91c2VPdXQsIHRoaXMpOwoKICAgICAgICB0aGlzLmZpcmVFdmVudCgibW91c2Vkb3duIiwgdGhpcywgZSk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoImNsaWNrIiwgdGhpcywgZSk7CgogICAgICAgIAogICAgICAgIGlmICh0aGlzLmFjY2VsZXJhdGUpIHsKICAgICAgICAgICAgdGhpcy5kZWxheSA9IDQwMDsKICAgICAgICB9CiAgICAgICAgdGhpcy50aW1lciA9IHRoaXMuY2xpY2suZGVmZXIodGhpcy5kZWxheSB8fCB0aGlzLmludGVydmFsLCB0aGlzLCBbZV0pOwogICAgfSwKCiAgICAKICAgIGNsaWNrIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoImNsaWNrIiwgdGhpcywgZSk7CiAgICAgICAgdGhpcy50aW1lciA9IHRoaXMuY2xpY2suZGVmZXIodGhpcy5hY2NlbGVyYXRlID8KICAgICAgICAgICAgdGhpcy5lYXNlT3V0RXhwbyh0aGlzLm1vdXNlZG93blRpbWUuZ2V0RWxhcHNlZCgpLAogICAgICAgICAgICAgICAgNDAwLAogICAgICAgICAgICAgICAgLTM5MCwKICAgICAgICAgICAgICAgIDEyMDAwKSA6CiAgICAgICAgICAgIHRoaXMuaW50ZXJ2YWwsIHRoaXMsIFtlXSk7CiAgICB9LAoKICAgIGVhc2VPdXRFeHBvIDogZnVuY3Rpb24gKHQsIGIsIGMsIGQpIHsKICAgICAgICByZXR1cm4gKHQ9PWQpID8gYitjIDogYyAqICgtTWF0aC5wb3coMiwgLTEwICogdC9kKSArIDEpICsgYjsKICAgIH0sCgogICAgCiAgICBoYW5kbGVNb3VzZU91dCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwogICAgICAgIGlmKHRoaXMucHJlc3NDbGFzcyl7CiAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3ModGhpcy5wcmVzc0NsYXNzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lbC5vbigibW91c2VvdmVyIiwgdGhpcy5oYW5kbGVNb3VzZVJldHVybiwgdGhpcyk7CiAgICB9LAoKICAgIAogICAgaGFuZGxlTW91c2VSZXR1cm4gOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZWwudW4oIm1vdXNlb3ZlciIsIHRoaXMuaGFuZGxlTW91c2VSZXR1cm4sIHRoaXMpOwogICAgICAgIGlmKHRoaXMucHJlc3NDbGFzcyl7CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3ModGhpcy5wcmVzc0NsYXNzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jbGljaygpOwogICAgfSwKCiAgICAKICAgIGhhbmRsZU1vdXNlVXAgOiBmdW5jdGlvbihlKXsKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lcik7CiAgICAgICAgdGhpcy5lbC51bigibW91c2VvdmVyIiwgdGhpcy5oYW5kbGVNb3VzZVJldHVybiwgdGhpcyk7CiAgICAgICAgdGhpcy5lbC51bigibW91c2VvdXQiLCB0aGlzLmhhbmRsZU1vdXNlT3V0LCB0aGlzKTsKICAgICAgICBFeHQuZ2V0RG9jKCkudW4oIm1vdXNldXAiLCB0aGlzLmhhbmRsZU1vdXNlVXAsIHRoaXMpOwogICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3ModGhpcy5wcmVzc0NsYXNzKTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgibW91c2V1cCIsIHRoaXMsIGUpOwogICAgfQp9KTsKRXh0LktleU5hdiA9IGZ1bmN0aW9uKGVsLCBjb25maWcpewogICAgdGhpcy5lbCA9IEV4dC5nZXQoZWwpOwogICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CiAgICBpZighdGhpcy5kaXNhYmxlZCl7CiAgICAgICAgdGhpcy5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5lbmFibGUoKTsKICAgIH0KfTsKCkV4dC5LZXlOYXYucHJvdG90eXBlID0gewogICAgCiAgICBkaXNhYmxlZCA6IGZhbHNlLAogICAgCiAgICBkZWZhdWx0RXZlbnRBY3Rpb246ICJzdG9wRXZlbnQiLAogICAgCiAgICBmb3JjZUtleURvd24gOiBmYWxzZSwKCiAgICAKICAgIHJlbGF5IDogZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIGsgPSBlLmdldEtleSgpLAogICAgICAgICAgICBoID0gdGhpcy5rZXlUb0hhbmRsZXJba107CiAgICAgICAgaWYoaCAmJiB0aGlzW2hdKXsKICAgICAgICAgICAgaWYodGhpcy5kb1JlbGF5KGUsIHRoaXNbaF0sIGgpICE9PSB0cnVlKXsKICAgICAgICAgICAgICAgIGVbdGhpcy5kZWZhdWx0RXZlbnRBY3Rpb25dKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZG9SZWxheSA6IGZ1bmN0aW9uKGUsIGgsIGhuYW1lKXsKICAgICAgICByZXR1cm4gaC5jYWxsKHRoaXMuc2NvcGUgfHwgdGhpcywgZSwgaG5hbWUpOwogICAgfSwKCiAgICAKICAgIGVudGVyIDogZmFsc2UsCiAgICBsZWZ0IDogZmFsc2UsCiAgICByaWdodCA6IGZhbHNlLAogICAgdXAgOiBmYWxzZSwKICAgIGRvd24gOiBmYWxzZSwKICAgIHRhYiA6IGZhbHNlLAogICAgZXNjIDogZmFsc2UsCiAgICBwYWdlVXAgOiBmYWxzZSwKICAgIHBhZ2VEb3duIDogZmFsc2UsCiAgICBkZWwgOiBmYWxzZSwKICAgIGhvbWUgOiBmYWxzZSwKICAgIGVuZCA6IGZhbHNlLAogICAgc3BhY2UgOiBmYWxzZSwKCiAgICAKICAgIGtleVRvSGFuZGxlciA6IHsKICAgICAgICAzNyA6ICJsZWZ0IiwKICAgICAgICAzOSA6ICJyaWdodCIsCiAgICAgICAgMzggOiAidXAiLAogICAgICAgIDQwIDogImRvd24iLAogICAgICAgIDMzIDogInBhZ2VVcCIsCiAgICAgICAgMzQgOiAicGFnZURvd24iLAogICAgICAgIDQ2IDogImRlbCIsCiAgICAgICAgMzYgOiAiaG9tZSIsCiAgICAgICAgMzUgOiAiZW5kIiwKICAgICAgICAxMyA6ICJlbnRlciIsCiAgICAgICAgMjcgOiAiZXNjIiwKICAgICAgICA5ICA6ICJ0YWIiLAogICAgICAgIDMyIDogInNwYWNlIgogICAgfSwKICAgIAogICAgc3RvcEtleVVwOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIGsgPSBlLmdldEtleSgpOwoKICAgICAgICBpZiAoayA+PSAzNyAmJiBrIDw9IDQwKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5kaXNhYmxlKCk7ICAgIAogICAgfSwKCgkKCWVuYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHsKICAgICAgICAgICAgaWYgKEV4dC5pc1NhZmFyaTIpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5lbC5vbigna2V5dXAnLCB0aGlzLnN0b3BLZXlVcCwgdGhpcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZWwub24odGhpcy5pc0tleWRvd24oKT8gJ2tleWRvd24nIDogJ2tleXByZXNzJywgdGhpcy5yZWxheSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICB9LAoKCQoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmRpc2FibGVkKSB7CiAgICAgICAgICAgIGlmIChFeHQuaXNTYWZhcmkyKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuZWwudW4oJ2tleXVwJywgdGhpcy5zdG9wS2V5VXAsIHRoaXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmVsLnVuKHRoaXMuaXNLZXlkb3duKCk/ICdrZXlkb3duJyA6ICdrZXlwcmVzcycsIHRoaXMucmVsYXksIHRoaXMpOwogICAgICAgICAgICB0aGlzLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIHNldERpc2FibGVkIDogZnVuY3Rpb24oZGlzYWJsZWQpewogICAgICAgIHRoaXNbZGlzYWJsZWQgPyAiZGlzYWJsZSIgOiAiZW5hYmxlIl0oKTsKICAgIH0sCiAgICAKICAgIAogICAgaXNLZXlkb3duOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmZvcmNlS2V5RG93biB8fCBFeHQuRXZlbnRNYW5hZ2VyLnVzZUtleWRvd247CiAgICB9Cn07CgpFeHQuS2V5TWFwID0gZnVuY3Rpb24oZWwsIGNvbmZpZywgZXZlbnROYW1lKXsKICAgIHRoaXMuZWwgID0gRXh0LmdldChlbCk7CiAgICB0aGlzLmV2ZW50TmFtZSA9IGV2ZW50TmFtZSB8fCAia2V5ZG93biI7CiAgICB0aGlzLmJpbmRpbmdzID0gW107CiAgICBpZihjb25maWcpewogICAgICAgIHRoaXMuYWRkQmluZGluZyhjb25maWcpOwogICAgfQogICAgdGhpcy5lbmFibGUoKTsKfTsKCkV4dC5LZXlNYXAucHJvdG90eXBlID0gewogICAgCiAgICBzdG9wRXZlbnQgOiBmYWxzZSwKCiAgICAKCWFkZEJpbmRpbmcgOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIGlmKEV4dC5pc0FycmF5KGNvbmZpZykpewogICAgICAgICAgICBFeHQuZWFjaChjb25maWcsIGZ1bmN0aW9uKGMpewogICAgICAgICAgICAgICAgdGhpcy5hZGRCaW5kaW5nKGMpOwogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIga2V5Q29kZSA9IGNvbmZpZy5rZXksCiAgICAgICAgICAgIGZuID0gY29uZmlnLmZuIHx8IGNvbmZpZy5oYW5kbGVyLAogICAgICAgICAgICBzY29wZSA9IGNvbmZpZy5zY29wZTsKCglpZiAoY29uZmlnLnN0b3BFdmVudCkgewoJICAgIHRoaXMuc3RvcEV2ZW50ID0gY29uZmlnLnN0b3BFdmVudDsgICAgCgl9CQoKICAgICAgICBpZih0eXBlb2Yga2V5Q29kZSA9PSAic3RyaW5nIil7CiAgICAgICAgICAgIHZhciBrcyA9IFtdOwogICAgICAgICAgICB2YXIga2V5U3RyaW5nID0ga2V5Q29kZS50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICBmb3IodmFyIGogPSAwLCBsZW4gPSBrZXlTdHJpbmcubGVuZ3RoOyBqIDwgbGVuOyBqKyspewogICAgICAgICAgICAgICAga3MucHVzaChrZXlTdHJpbmcuY2hhckNvZGVBdChqKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAga2V5Q29kZSA9IGtzOwogICAgICAgIH0KICAgICAgICB2YXIga2V5QXJyYXkgPSBFeHQuaXNBcnJheShrZXlDb2RlKTsKICAgICAgICAKICAgICAgICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uKGUpewogICAgICAgICAgICBpZih0aGlzLmNoZWNrTW9kaWZpZXJzKGNvbmZpZywgZSkpewogICAgICAgICAgICAgICAgdmFyIGsgPSBlLmdldEtleSgpOwogICAgICAgICAgICAgICAgaWYoa2V5QXJyYXkpewogICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGtleUNvZGUubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZihrZXlDb2RlW2ldID09IGspewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RvcEV2ZW50KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB3aW5kb3csIGssIGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIGlmKGsgPT0ga2V5Q29kZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuc3RvcEV2ZW50KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHdpbmRvdywgaywgZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB0aGlzLmJpbmRpbmdzLnB1c2goaGFuZGxlcik7Cgl9LAogICAgCiAgICAKICAgIGNoZWNrTW9kaWZpZXJzOiBmdW5jdGlvbihjb25maWcsIGUpewogICAgICAgIHZhciB2YWwsIGtleSwga2V5cyA9IFsnc2hpZnQnLCAnY3RybCcsICdhbHQnXTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0ga2V5cy5sZW5ndGg7IGkgPCBsZW47ICsraSl7CiAgICAgICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgIHZhbCA9IGNvbmZpZ1trZXldOwogICAgICAgICAgICBpZighKHZhbCA9PT0gdW5kZWZpbmVkIHx8ICh2YWwgPT09IGVba2V5ICsgJ0tleSddKSkpewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAKICAgIG9uIDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpewogICAgICAgIHZhciBrZXlDb2RlLCBzaGlmdCwgY3RybCwgYWx0OwogICAgICAgIGlmKHR5cGVvZiBrZXkgPT0gIm9iamVjdCIgJiYgIUV4dC5pc0FycmF5KGtleSkpewogICAgICAgICAgICBrZXlDb2RlID0ga2V5LmtleTsKICAgICAgICAgICAgc2hpZnQgPSBrZXkuc2hpZnQ7CiAgICAgICAgICAgIGN0cmwgPSBrZXkuY3RybDsKICAgICAgICAgICAgYWx0ID0ga2V5LmFsdDsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAga2V5Q29kZSA9IGtleTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hZGRCaW5kaW5nKHsKICAgICAgICAgICAga2V5OiBrZXlDb2RlLAogICAgICAgICAgICBzaGlmdDogc2hpZnQsCiAgICAgICAgICAgIGN0cmw6IGN0cmwsCiAgICAgICAgICAgIGFsdDogYWx0LAogICAgICAgICAgICBmbjogZm4sCiAgICAgICAgICAgIHNjb3BlOiBzY29wZQogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIGhhbmRsZUtleURvd24gOiBmdW5jdGlvbihlKXsKCSAgICBpZih0aGlzLmVuYWJsZWQpeyAKICAgIAkgICAgdmFyIGIgPSB0aGlzLmJpbmRpbmdzOwogICAgCSAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBiLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgIAkgICAgICAgIGJbaV0uY2FsbCh0aGlzLCBlKTsKICAgIAkgICAgfQoJICAgIH0KCX0sCgoJCglpc0VuYWJsZWQgOiBmdW5jdGlvbigpewoJICAgIHJldHVybiB0aGlzLmVuYWJsZWQ7Cgl9LAoKCQoJZW5hYmxlOiBmdW5jdGlvbigpewoJCWlmKCF0aGlzLmVuYWJsZWQpewoJCSAgICB0aGlzLmVsLm9uKHRoaXMuZXZlbnROYW1lLCB0aGlzLmhhbmRsZUtleURvd24sIHRoaXMpOwoJCSAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoJCX0KCX0sCgoJCglkaXNhYmxlOiBmdW5jdGlvbigpewoJCWlmKHRoaXMuZW5hYmxlZCl7CgkJICAgIHRoaXMuZWwucmVtb3ZlTGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuaGFuZGxlS2V5RG93biwgdGhpcyk7CgkJICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwoJCX0KCX0sCiAgICAKICAgIAogICAgc2V0RGlzYWJsZWQgOiBmdW5jdGlvbihkaXNhYmxlZCl7CiAgICAgICAgdGhpc1tkaXNhYmxlZCA/ICJkaXNhYmxlIiA6ICJlbmFibGUiXSgpOwogICAgfQp9OwpFeHQudXRpbC5UZXh0TWV0cmljcyA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgc2hhcmVkOwogICAgcmV0dXJuIHsKICAgICAgICAKICAgICAgICBtZWFzdXJlIDogZnVuY3Rpb24oZWwsIHRleHQsIGZpeGVkV2lkdGgpewogICAgICAgICAgICBpZighc2hhcmVkKXsKICAgICAgICAgICAgICAgIHNoYXJlZCA9IEV4dC51dGlsLlRleHRNZXRyaWNzLkluc3RhbmNlKGVsLCBmaXhlZFdpZHRoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzaGFyZWQuYmluZChlbCk7CiAgICAgICAgICAgIHNoYXJlZC5zZXRGaXhlZFdpZHRoKGZpeGVkV2lkdGggfHwgJ2F1dG8nKTsKICAgICAgICAgICAgcmV0dXJuIHNoYXJlZC5nZXRTaXplKHRleHQpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGNyZWF0ZUluc3RhbmNlIDogZnVuY3Rpb24oZWwsIGZpeGVkV2lkdGgpewogICAgICAgICAgICByZXR1cm4gRXh0LnV0aWwuVGV4dE1ldHJpY3MuSW5zdGFuY2UoZWwsIGZpeGVkV2lkdGgpOwogICAgICAgIH0KICAgIH07Cn0oKTsKCkV4dC51dGlsLlRleHRNZXRyaWNzLkluc3RhbmNlID0gZnVuY3Rpb24oYmluZFRvLCBmaXhlZFdpZHRoKXsKICAgIHZhciBtbCA9IG5ldyBFeHQuRWxlbWVudChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG1sLmRvbSk7CiAgICBtbC5wb3NpdGlvbignYWJzb2x1dGUnKTsKICAgIG1sLnNldExlZnRUb3AoLTEwMDAsIC0xMDAwKTsKICAgIG1sLmhpZGUoKTsKCiAgICBpZihmaXhlZFdpZHRoKXsKICAgICAgICBtbC5zZXRXaWR0aChmaXhlZFdpZHRoKTsKICAgIH0KCiAgICB2YXIgaW5zdGFuY2UgPSB7CiAgICAgICAgCiAgICAgICAgZ2V0U2l6ZSA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgICAgICBtbC51cGRhdGUodGV4dCk7CiAgICAgICAgICAgIHZhciBzID0gbWwuZ2V0U2l6ZSgpOwogICAgICAgICAgICBtbC51cGRhdGUoJycpOwogICAgICAgICAgICByZXR1cm4gczsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBiaW5kIDogZnVuY3Rpb24oZWwpewogICAgICAgICAgICBtbC5zZXRTdHlsZSgKICAgICAgICAgICAgICAgIEV4dC5mbHkoZWwpLmdldFN0eWxlcygnZm9udC1zaXplJywnZm9udC1zdHlsZScsICdmb250LXdlaWdodCcsICdmb250LWZhbWlseScsJ2xpbmUtaGVpZ2h0JywgJ3RleHQtdHJhbnNmb3JtJywgJ2xldHRlci1zcGFjaW5nJykKICAgICAgICAgICAgKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBzZXRGaXhlZFdpZHRoIDogZnVuY3Rpb24od2lkdGgpewogICAgICAgICAgICBtbC5zZXRXaWR0aCh3aWR0aCk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0V2lkdGggOiBmdW5jdGlvbih0ZXh0KXsKICAgICAgICAgICAgbWwuZG9tLnN0eWxlLndpZHRoID0gJ2F1dG8nOwogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTaXplKHRleHQpLndpZHRoOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldEhlaWdodCA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTaXplKHRleHQpLmhlaWdodDsKICAgICAgICB9CiAgICB9OwoKICAgIGluc3RhbmNlLmJpbmQoYmluZFRvKTsKCiAgICByZXR1cm4gaW5zdGFuY2U7Cn07CgpFeHQuRWxlbWVudC5hZGRNZXRob2RzKHsKICAgIAogICAgZ2V0VGV4dFdpZHRoIDogZnVuY3Rpb24odGV4dCwgbWluLCBtYXgpewogICAgICAgIHJldHVybiAoRXh0LnV0aWwuVGV4dE1ldHJpY3MubWVhc3VyZSh0aGlzLmRvbSwgRXh0LnZhbHVlKHRleHQsIHRoaXMuZG9tLmlubmVySFRNTCwgdHJ1ZSkpLndpZHRoKS5jb25zdHJhaW4obWluIHx8IDAsIG1heCB8fCAxMDAwMDAwKTsKICAgIH0KfSk7CgpFeHQudXRpbC5Db29raWVzID0gewogICAgCiAgICBzZXQgOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgICAgdmFyIGFyZ3YgPSBhcmd1bWVudHM7CiAgICAgICAgdmFyIGFyZ2MgPSBhcmd1bWVudHMubGVuZ3RoOwogICAgICAgIHZhciBleHBpcmVzID0gKGFyZ2MgPiAyKSA/IGFyZ3ZbMl0gOiBudWxsOwogICAgICAgIHZhciBwYXRoID0gKGFyZ2MgPiAzKSA/IGFyZ3ZbM10gOiAnLyc7CiAgICAgICAgdmFyIGRvbWFpbiA9IChhcmdjID4gNCkgPyBhcmd2WzRdIDogbnVsbDsKICAgICAgICB2YXIgc2VjdXJlID0gKGFyZ2MgPiA1KSA/IGFyZ3ZbNV0gOiBmYWxzZTsKICAgICAgICBkb2N1bWVudC5jb29raWUgPSBuYW1lICsgIj0iICsgZXNjYXBlKHZhbHVlKSArICgoZXhwaXJlcyA9PT0gbnVsbCkgPyAiIiA6ICgiOyBleHBpcmVzPSIgKyBleHBpcmVzLnRvR01UU3RyaW5nKCkpKSArICgocGF0aCA9PT0gbnVsbCkgPyAiIiA6ICgiOyBwYXRoPSIgKyBwYXRoKSkgKyAoKGRvbWFpbiA9PT0gbnVsbCkgPyAiIiA6ICgiOyBkb21haW49IiArIGRvbWFpbikpICsgKChzZWN1cmUgPT09IHRydWUpID8gIjsgc2VjdXJlIiA6ICIiKTsKICAgIH0sCgogICAgCiAgICBnZXQgOiBmdW5jdGlvbihuYW1lKXsKICAgICAgICB2YXIgYXJnID0gbmFtZSArICI9IjsKICAgICAgICB2YXIgYWxlbiA9IGFyZy5sZW5ndGg7CiAgICAgICAgdmFyIGNsZW4gPSBkb2N1bWVudC5jb29raWUubGVuZ3RoOwogICAgICAgIHZhciBpID0gMDsKICAgICAgICB2YXIgaiA9IDA7CiAgICAgICAgd2hpbGUoaSA8IGNsZW4pewogICAgICAgICAgICBqID0gaSArIGFsZW47CiAgICAgICAgICAgIGlmKGRvY3VtZW50LmNvb2tpZS5zdWJzdHJpbmcoaSwgaikgPT0gYXJnKXsKICAgICAgICAgICAgICAgIHJldHVybiBFeHQudXRpbC5Db29raWVzLmdldENvb2tpZVZhbChqKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpID0gZG9jdW1lbnQuY29va2llLmluZGV4T2YoIiAiLCBpKSArIDE7CiAgICAgICAgICAgIGlmKGkgPT09IDApewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIAogICAgY2xlYXIgOiBmdW5jdGlvbihuYW1lKXsKICAgICAgICBpZihFeHQudXRpbC5Db29raWVzLmdldChuYW1lKSl7CiAgICAgICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IG5hbWUgKyAiPSIgKyAiOyBleHBpcmVzPVRodSwgMDEtSmFuLTcwIDAwOjAwOjAxIEdNVCI7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgZ2V0Q29va2llVmFsIDogZnVuY3Rpb24ob2Zmc2V0KXsKICAgICAgICB2YXIgZW5kc3RyID0gZG9jdW1lbnQuY29va2llLmluZGV4T2YoIjsiLCBvZmZzZXQpOwogICAgICAgIGlmKGVuZHN0ciA9PSAtMSl7CiAgICAgICAgICAgIGVuZHN0ciA9IGRvY3VtZW50LmNvb2tpZS5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bmVzY2FwZShkb2N1bWVudC5jb29raWUuc3Vic3RyaW5nKG9mZnNldCwgZW5kc3RyKSk7CiAgICB9Cn07CkV4dC5oYW5kbGVFcnJvciA9IGZ1bmN0aW9uKGUpIHsKICAgIHRocm93IGU7Cn07CgoKRXh0LkVycm9yID0gZnVuY3Rpb24obWVzc2FnZSkgewogICAgCiAgICB0aGlzLm1lc3NhZ2UgPSAodGhpcy5sYW5nW21lc3NhZ2VdKSA/IHRoaXMubGFuZ1ttZXNzYWdlXSA6IG1lc3NhZ2U7Cn07CgpFeHQuRXJyb3IucHJvdG90eXBlID0gbmV3IEVycm9yKCk7CkV4dC5hcHBseShFeHQuRXJyb3IucHJvdG90eXBlLCB7CiAgICAKICAgIGxhbmc6IHt9LAoKICAgIG5hbWU6ICdFeHQuRXJyb3InLAogICAgCiAgICBnZXROYW1lIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubmFtZTsKICAgIH0sCiAgICAKICAgIGdldE1lc3NhZ2UgOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5tZXNzYWdlOwogICAgfSwKICAgIAogICAgdG9Kc29uIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEV4dC5lbmNvZGUodGhpcyk7CiAgICB9Cn0pOwoKRXh0LkNvbXBvbmVudE1nciA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgYWxsID0gbmV3IEV4dC51dGlsLk1peGVkQ29sbGVjdGlvbigpOwogICAgdmFyIHR5cGVzID0ge307CiAgICB2YXIgcHR5cGVzID0ge307CgogICAgcmV0dXJuIHsKICAgICAgICAKICAgICAgICByZWdpc3RlciA6IGZ1bmN0aW9uKGMpewogICAgICAgICAgICBhbGwuYWRkKGMpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHVucmVnaXN0ZXIgOiBmdW5jdGlvbihjKXsKICAgICAgICAgICAgYWxsLnJlbW92ZShjKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXQgOiBmdW5jdGlvbihpZCl7CiAgICAgICAgICAgIHJldHVybiBhbGwuZ2V0KGlkKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBvbkF2YWlsYWJsZSA6IGZ1bmN0aW9uKGlkLCBmbiwgc2NvcGUpewogICAgICAgICAgICBhbGwub24oImFkZCIsIGZ1bmN0aW9uKGluZGV4LCBvKXsKICAgICAgICAgICAgICAgIGlmKG8uaWQgPT0gaWQpewogICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgbywgbyk7CiAgICAgICAgICAgICAgICAgICAgYWxsLnVuKCJhZGQiLCBmbiwgc2NvcGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBhbGwgOiBhbGwsCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdHlwZXMgOiB0eXBlcywKICAgICAgICAKICAgICAgICAKICAgICAgICBwdHlwZXM6IHB0eXBlcywKICAgICAgICAKICAgICAgICAKICAgICAgICBpc1JlZ2lzdGVyZWQgOiBmdW5jdGlvbih4dHlwZSl7CiAgICAgICAgICAgIHJldHVybiB0eXBlc1t4dHlwZV0gIT09IHVuZGVmaW5lZDsgICAgCiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAKICAgICAgICBpc1BsdWdpblJlZ2lzdGVyZWQgOiBmdW5jdGlvbihwdHlwZSl7CiAgICAgICAgICAgIHJldHVybiBwdHlwZXNbcHR5cGVdICE9PSB1bmRlZmluZWQ7ICAgIAogICAgICAgIH0sICAgICAgICAKCiAgICAgICAgCiAgICAgICAgcmVnaXN0ZXJUeXBlIDogZnVuY3Rpb24oeHR5cGUsIGNscyl7CiAgICAgICAgICAgIHR5cGVzW3h0eXBlXSA9IGNsczsKICAgICAgICAgICAgY2xzLnh0eXBlID0geHR5cGU7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgY3JlYXRlIDogZnVuY3Rpb24oY29uZmlnLCBkZWZhdWx0VHlwZSl7CiAgICAgICAgICAgIHJldHVybiBjb25maWcucmVuZGVyID8gY29uZmlnIDogbmV3IHR5cGVzW2NvbmZpZy54dHlwZSB8fCBkZWZhdWx0VHlwZV0oY29uZmlnKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICByZWdpc3RlclBsdWdpbiA6IGZ1bmN0aW9uKHB0eXBlLCBjbHMpewogICAgICAgICAgICBwdHlwZXNbcHR5cGVdID0gY2xzOwogICAgICAgICAgICBjbHMucHR5cGUgPSBwdHlwZTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBjcmVhdGVQbHVnaW4gOiBmdW5jdGlvbihjb25maWcsIGRlZmF1bHRUeXBlKXsKICAgICAgICAgICAgdmFyIFBsdWdpbkNscyA9IHB0eXBlc1tjb25maWcucHR5cGUgfHwgZGVmYXVsdFR5cGVdOwogICAgICAgICAgICBpZiAoUGx1Z2luQ2xzLmluaXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBQbHVnaW5DbHM7ICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQbHVnaW5DbHMoY29uZmlnKTsKICAgICAgICAgICAgfSAgICAgICAgICAgIAogICAgICAgIH0KICAgIH07Cn0oKTsKCgpFeHQucmVnID0gRXh0LkNvbXBvbmVudE1nci5yZWdpc3RlclR5cGU7IAoKRXh0LnByZWcgPSBFeHQuQ29tcG9uZW50TWdyLnJlZ2lzdGVyUGx1Z2luOwoKRXh0LmNyZWF0ZSA9IEV4dC5Db21wb25lbnRNZ3IuY3JlYXRlOwpFeHQuQ29tcG9uZW50ID0gZnVuY3Rpb24oY29uZmlnKXsKICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTsKICAgIGlmKGNvbmZpZy5pbml0aWFsQ29uZmlnKXsKICAgICAgICBpZihjb25maWcuaXNBY3Rpb24peyAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYmFzZUFjdGlvbiA9IGNvbmZpZzsKICAgICAgICB9CiAgICAgICAgY29uZmlnID0gY29uZmlnLmluaXRpYWxDb25maWc7IAogICAgfWVsc2UgaWYoY29uZmlnLnRhZ05hbWUgfHwgY29uZmlnLmRvbSB8fCBFeHQuaXNTdHJpbmcoY29uZmlnKSl7IAogICAgICAgIGNvbmZpZyA9IHthcHBseVRvOiBjb25maWcsIGlkOiBjb25maWcuaWQgfHwgY29uZmlnfTsKICAgIH0KCiAgICAKICAgIHRoaXMuaW5pdGlhbENvbmZpZyA9IGNvbmZpZzsKCiAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgIAogICAgICAgICdhZGRlZCcsCiAgICAgICAgCiAgICAgICAgJ2Rpc2FibGUnLAogICAgICAgIAogICAgICAgICdlbmFibGUnLAogICAgICAgIAogICAgICAgICdiZWZvcmVzaG93JywKICAgICAgICAKICAgICAgICAnc2hvdycsCiAgICAgICAgCiAgICAgICAgJ2JlZm9yZWhpZGUnLAogICAgICAgIAogICAgICAgICdoaWRlJywKICAgICAgICAKICAgICAgICAncmVtb3ZlZCcsCiAgICAgICAgCiAgICAgICAgJ2JlZm9yZXJlbmRlcicsCiAgICAgICAgCiAgICAgICAgJ3JlbmRlcicsCiAgICAgICAgCiAgICAgICAgJ2FmdGVycmVuZGVyJywKICAgICAgICAKICAgICAgICAnYmVmb3JlZGVzdHJveScsCiAgICAgICAgCiAgICAgICAgJ2Rlc3Ryb3knLAogICAgICAgIAogICAgICAgICdiZWZvcmVzdGF0ZXJlc3RvcmUnLAogICAgICAgIAogICAgICAgICdzdGF0ZXJlc3RvcmUnLAogICAgICAgIAogICAgICAgICdiZWZvcmVzdGF0ZXNhdmUnLAogICAgICAgIAogICAgICAgICdzdGF0ZXNhdmUnCiAgICApOwogICAgdGhpcy5nZXRJZCgpOwogICAgRXh0LkNvbXBvbmVudE1nci5yZWdpc3Rlcih0aGlzKTsKICAgIEV4dC5Db21wb25lbnQuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMpOwoKICAgIGlmKHRoaXMuYmFzZUFjdGlvbil7CiAgICAgICAgdGhpcy5iYXNlQWN0aW9uLmFkZENvbXBvbmVudCh0aGlzKTsKICAgIH0KCiAgICB0aGlzLmluaXRDb21wb25lbnQoKTsKCiAgICBpZih0aGlzLnBsdWdpbnMpewogICAgICAgIGlmKEV4dC5pc0FycmF5KHRoaXMucGx1Z2lucykpewogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSB0aGlzLnBsdWdpbnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zW2ldID0gdGhpcy5pbml0UGx1Z2luKHRoaXMucGx1Z2luc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5wbHVnaW5zID0gdGhpcy5pbml0UGx1Z2luKHRoaXMucGx1Z2lucyk7CiAgICAgICAgfQogICAgfQoKICAgIGlmKHRoaXMuc3RhdGVmdWwgIT09IGZhbHNlKXsKICAgICAgICB0aGlzLmluaXRTdGF0ZSgpOwogICAgfQoKICAgIGlmKHRoaXMuYXBwbHlUbyl7CiAgICAgICAgdGhpcy5hcHBseVRvTWFya3VwKHRoaXMuYXBwbHlUbyk7CiAgICAgICAgZGVsZXRlIHRoaXMuYXBwbHlUbzsKICAgIH1lbHNlIGlmKHRoaXMucmVuZGVyVG8pewogICAgICAgIHRoaXMucmVuZGVyKHRoaXMucmVuZGVyVG8pOwogICAgICAgIGRlbGV0ZSB0aGlzLnJlbmRlclRvOwogICAgfQp9OwoKCkV4dC5Db21wb25lbnQuQVVUT19JRCA9IDEwMDA7CgpFeHQuZXh0ZW5kKEV4dC5Db21wb25lbnQsIEV4dC51dGlsLk9ic2VydmFibGUsIHsKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAoKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIGRpc2FibGVkIDogZmFsc2UsCiAgICAKICAgIGhpZGRlbiA6IGZhbHNlLAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICBhdXRvRWwgOiAnZGl2JywKCiAgICAKICAgIGRpc2FibGVkQ2xhc3MgOiAneC1pdGVtLWRpc2FibGVkJywKICAgIAogICAgYWxsb3dEb21Nb3ZlIDogdHJ1ZSwKICAgIAogICAgYXV0b1Nob3cgOiBmYWxzZSwKICAgIAogICAgaGlkZU1vZGUgOiAnZGlzcGxheScsCiAgICAKICAgIGhpZGVQYXJlbnQgOiBmYWxzZSwKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICByZW5kZXJlZCA6IGZhbHNlLAoKICAgIAogICAgCgogICAgCgogICAgCiAgICB0cGxXcml0ZU1vZGUgOiAnb3ZlcndyaXRlJywKCiAgICAKICAgIAogICAgCiAgICBidWJibGVFdmVudHM6IFtdLAoKCiAgICAKICAgIGN0eXBlIDogJ0V4dC5Db21wb25lbnQnLAoKICAgIAogICAgYWN0aW9uTW9kZSA6ICdlbCcsCgogICAgCiAgICBnZXRBY3Rpb25FbCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXNbdGhpcy5hY3Rpb25Nb2RlXTsKICAgIH0sCgogICAgaW5pdFBsdWdpbiA6IGZ1bmN0aW9uKHApewogICAgICAgIGlmKHAucHR5cGUgJiYgIUV4dC5pc0Z1bmN0aW9uKHAuaW5pdCkpewogICAgICAgICAgICBwID0gRXh0LkNvbXBvbmVudE1nci5jcmVhdGVQbHVnaW4ocCk7CiAgICAgICAgfWVsc2UgaWYoRXh0LmlzU3RyaW5nKHApKXsKICAgICAgICAgICAgcCA9IEV4dC5Db21wb25lbnRNZ3IuY3JlYXRlUGx1Z2luKHsKICAgICAgICAgICAgICAgIHB0eXBlOiBwCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBwLmluaXQodGhpcyk7CiAgICAgICAgcmV0dXJuIHA7CiAgICB9LAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgCiAgICAgICAgaWYodGhpcy5saXN0ZW5lcnMpewogICAgICAgICAgICB0aGlzLm9uKHRoaXMubGlzdGVuZXJzKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubGlzdGVuZXJzOwogICAgICAgIH0KICAgICAgICB0aGlzLmVuYWJsZUJ1YmJsZSh0aGlzLmJ1YmJsZUV2ZW50cyk7CiAgICB9LAoKICAgIAogICAgcmVuZGVyIDogZnVuY3Rpb24oY29udGFpbmVyLCBwb3NpdGlvbil7CiAgICAgICAgaWYoIXRoaXMucmVuZGVyZWQgJiYgdGhpcy5maXJlRXZlbnQoJ2JlZm9yZXJlbmRlcicsIHRoaXMpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIGlmKCFjb250YWluZXIgJiYgdGhpcy5lbCl7CiAgICAgICAgICAgICAgICB0aGlzLmVsID0gRXh0LmdldCh0aGlzLmVsKTsKICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9IHRoaXMuZWwuZG9tLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICB0aGlzLmFsbG93RG9tTW92ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gRXh0LmdldChjb250YWluZXIpOwogICAgICAgICAgICBpZih0aGlzLmN0Q2xzKXsKICAgICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLmFkZENsYXNzKHRoaXMuY3RDbHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVuZGVyZWQgPSB0cnVlOwogICAgICAgICAgICBpZihwb3NpdGlvbiAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIGlmKEV4dC5pc051bWJlcihwb3NpdGlvbikpewogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gdGhpcy5jb250YWluZXIuZG9tLmNoaWxkTm9kZXNbcG9zaXRpb25dOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gPSBFeHQuZ2V0RG9tKHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm9uUmVuZGVyKHRoaXMuY29udGFpbmVyLCBwb3NpdGlvbiB8fCBudWxsKTsKICAgICAgICAgICAgaWYodGhpcy5hdXRvU2hvdyl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUNsYXNzKFsneC1oaWRkZW4nLCd4LWhpZGUtJyArIHRoaXMuaGlkZU1vZGVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLmNscyl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLmFkZENsYXNzKHRoaXMuY2xzKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNsczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLnN0eWxlKXsKICAgICAgICAgICAgICAgIHRoaXMuZWwuYXBwbHlTdHlsZXModGhpcy5zdHlsZSk7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zdHlsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLm92ZXJDbHMpewogICAgICAgICAgICAgICAgdGhpcy5lbC5hZGRDbGFzc09uT3Zlcih0aGlzLm92ZXJDbHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdyZW5kZXInLCB0aGlzKTsKCgogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBjb250ZW50VGFyZ2V0ID0gdGhpcy5nZXRDb250ZW50VGFyZ2V0KCk7CiAgICAgICAgICAgIGlmICh0aGlzLmh0bWwpewogICAgICAgICAgICAgICAgY29udGVudFRhcmdldC51cGRhdGUoRXh0LkRvbUhlbHBlci5tYXJrdXAodGhpcy5odG1sKSk7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5odG1sOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmNvbnRlbnRFbCl7CiAgICAgICAgICAgICAgICB2YXIgY2UgPSBFeHQuZ2V0RG9tKHRoaXMuY29udGVudEVsKTsKICAgICAgICAgICAgICAgIEV4dC5mbHkoY2UpLnJlbW92ZUNsYXNzKFsneC1oaWRkZW4nLCAneC1oaWRlLWRpc3BsYXknXSk7CiAgICAgICAgICAgICAgICBjb250ZW50VGFyZ2V0LmFwcGVuZENoaWxkKGNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy50cGwpIHsKICAgICAgICAgICAgICAgIGlmICghdGhpcy50cGwuY29tcGlsZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHBsID0gbmV3IEV4dC5YVGVtcGxhdGUodGhpcy50cGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMudHBsW3RoaXMudHBsV3JpdGVNb2RlXShjb250ZW50VGFyZ2V0LCB0aGlzLmRhdGEpOwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmRhdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hZnRlclJlbmRlcih0aGlzLmNvbnRhaW5lcik7CgoKICAgICAgICAgICAgaWYodGhpcy5oaWRkZW4pewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRvSGlkZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRpc2FibGUodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKHRoaXMuc3RhdGVmdWwgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdFN0YXRlRXZlbnRzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2FmdGVycmVuZGVyJywgdGhpcyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgCiAgICB1cGRhdGU6IGZ1bmN0aW9uKGh0bWxPckRhdGEsIGxvYWRTY3JpcHRzLCBjYikgewogICAgICAgIHZhciBjb250ZW50VGFyZ2V0ID0gdGhpcy5nZXRDb250ZW50VGFyZ2V0KCk7CiAgICAgICAgaWYgKHRoaXMudHBsICYmIHR5cGVvZiBodG1sT3JEYXRhICE9PSAic3RyaW5nIikgewogICAgICAgICAgICB0aGlzLnRwbFt0aGlzLnRwbFdyaXRlTW9kZV0oY29udGVudFRhcmdldCwgaHRtbE9yRGF0YSB8fCB7fSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGh0bWwgPSBFeHQuaXNPYmplY3QoaHRtbE9yRGF0YSkgPyBFeHQuRG9tSGVscGVyLm1hcmt1cChodG1sT3JEYXRhKSA6IGh0bWxPckRhdGE7CiAgICAgICAgICAgIGNvbnRlbnRUYXJnZXQudXBkYXRlKGh0bWwsIGxvYWRTY3JpcHRzLCBjYik7CiAgICAgICAgfQogICAgfSwKCgogICAgCiAgICBvbkFkZGVkIDogZnVuY3Rpb24oY29udGFpbmVyLCBwb3MpIHsKICAgICAgICB0aGlzLm93bmVyQ3QgPSBjb250YWluZXI7CiAgICAgICAgdGhpcy5pbml0UmVmKCk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2FkZGVkJywgdGhpcywgY29udGFpbmVyLCBwb3MpOwogICAgfSwKCiAgICAKICAgIG9uUmVtb3ZlZCA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucmVtb3ZlUmVmKCk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3JlbW92ZWQnLCB0aGlzLCB0aGlzLm93bmVyQ3QpOwogICAgICAgIGRlbGV0ZSB0aGlzLm93bmVyQ3Q7CiAgICB9LAoKICAgIAogICAgaW5pdFJlZiA6IGZ1bmN0aW9uKCkgewogICAgICAgIAogICAgICAgIGlmKHRoaXMucmVmICYmICF0aGlzLnJlZk93bmVyKXsKICAgICAgICAgICAgdmFyIGxldmVscyA9IHRoaXMucmVmLnNwbGl0KCcvJyksCiAgICAgICAgICAgICAgICBsYXN0ID0gbGV2ZWxzLmxlbmd0aCwKICAgICAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICAgICAgdCA9IHRoaXM7CgogICAgICAgICAgICB3aGlsZSh0ICYmIGkgPCBsYXN0KXsKICAgICAgICAgICAgICAgIHQgPSB0Lm93bmVyQ3Q7CiAgICAgICAgICAgICAgICArK2k7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodCl7CiAgICAgICAgICAgICAgICB0W3RoaXMucmVmTmFtZSA9IGxldmVsc1stLWldXSA9IHRoaXM7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMucmVmT3duZXIgPSB0OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICByZW1vdmVSZWYgOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5yZWZPd25lciAmJiB0aGlzLnJlZk5hbWUpIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMucmVmT3duZXJbdGhpcy5yZWZOYW1lXTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMucmVmT3duZXI7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGluaXRTdGF0ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoRXh0LnN0YXRlLk1hbmFnZXIpewogICAgICAgICAgICB2YXIgaWQgPSB0aGlzLmdldFN0YXRlSWQoKTsKICAgICAgICAgICAgaWYoaWQpewogICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gRXh0LnN0YXRlLk1hbmFnZXIuZ2V0KGlkKTsKICAgICAgICAgICAgICAgIGlmKHN0YXRlKXsKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3Jlc3RhdGVyZXN0b3JlJywgdGhpcywgc3RhdGUpICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwbHlTdGF0ZShFeHQuYXBwbHkoe30sIHN0YXRlKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzdGF0ZXJlc3RvcmUnLCB0aGlzLCBzdGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldFN0YXRlSWQgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnN0YXRlSWQgfHwgKCgvXihleHQtY29tcC18ZXh0LWdlbikvKS50ZXN0KFN0cmluZyh0aGlzLmlkKSkgPyBudWxsIDogdGhpcy5pZCk7CiAgICB9LAoKICAgIAogICAgaW5pdFN0YXRlRXZlbnRzIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnN0YXRlRXZlbnRzKXsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgZTsgZSA9IHRoaXMuc3RhdGVFdmVudHNbaV07IGkrKyl7CiAgICAgICAgICAgICAgICB0aGlzLm9uKGUsIHRoaXMuc2F2ZVN0YXRlLCB0aGlzLCB7ZGVsYXk6MTAwfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYXBwbHlTdGF0ZSA6IGZ1bmN0aW9uKHN0YXRlKXsKICAgICAgICBpZihzdGF0ZSl7CiAgICAgICAgICAgIEV4dC5hcHBseSh0aGlzLCBzdGF0ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldFN0YXRlIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgCiAgICBzYXZlU3RhdGUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKEV4dC5zdGF0ZS5NYW5hZ2VyICYmIHRoaXMuc3RhdGVmdWwgIT09IGZhbHNlKXsKICAgICAgICAgICAgdmFyIGlkID0gdGhpcy5nZXRTdGF0ZUlkKCk7CiAgICAgICAgICAgIGlmKGlkKXsKICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUoKTsKICAgICAgICAgICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVzdGF0ZXNhdmUnLCB0aGlzLCBzdGF0ZSkgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgICAgICBFeHQuc3RhdGUuTWFuYWdlci5zZXQoaWQsIHN0YXRlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnc3RhdGVzYXZlJywgdGhpcywgc3RhdGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFwcGx5VG9NYXJrdXAgOiBmdW5jdGlvbihlbCl7CiAgICAgICAgdGhpcy5hbGxvd0RvbU1vdmUgPSBmYWxzZTsKICAgICAgICB0aGlzLmVsID0gRXh0LmdldChlbCk7CiAgICAgICAgdGhpcy5yZW5kZXIodGhpcy5lbC5kb20ucGFyZW50Tm9kZSk7CiAgICB9LAoKICAgIAogICAgYWRkQ2xhc3MgOiBmdW5jdGlvbihjbHMpewogICAgICAgIGlmKHRoaXMuZWwpewogICAgICAgICAgICB0aGlzLmVsLmFkZENsYXNzKGNscyk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuY2xzID0gdGhpcy5jbHMgPyB0aGlzLmNscyArICcgJyArIGNscyA6IGNsczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihjbHMpewogICAgICAgIGlmKHRoaXMuZWwpewogICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUNsYXNzKGNscyk7CiAgICAgICAgfWVsc2UgaWYodGhpcy5jbHMpewogICAgICAgICAgICB0aGlzLmNscyA9IHRoaXMuY2xzLnNwbGl0KCcgJykucmVtb3ZlKGNscykuam9pbignICcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKXsKICAgICAgICBpZighdGhpcy5lbCAmJiB0aGlzLmF1dG9FbCl7CiAgICAgICAgICAgIGlmKEV4dC5pc1N0cmluZyh0aGlzLmF1dG9FbCkpewogICAgICAgICAgICAgICAgdGhpcy5lbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGhpcy5hdXRvRWwpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgIEV4dC5Eb21IZWxwZXIub3ZlcndyaXRlKGRpdiwgdGhpcy5hdXRvRWwpOwogICAgICAgICAgICAgICAgdGhpcy5lbCA9IGRpdi5maXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdGhpcy5lbC5pZCkgewogICAgICAgICAgICAgICAgdGhpcy5lbC5pZCA9IHRoaXMuZ2V0SWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZih0aGlzLmVsKXsKICAgICAgICAgICAgdGhpcy5lbCA9IEV4dC5nZXQodGhpcy5lbCk7CiAgICAgICAgICAgIGlmKHRoaXMuYWxsb3dEb21Nb3ZlICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICBjdC5kb20uaW5zZXJ0QmVmb3JlKHRoaXMuZWwuZG9tLCBwb3NpdGlvbik7CiAgICAgICAgICAgICAgICBpZiAoZGl2KSB7CiAgICAgICAgICAgICAgICAgICAgRXh0LnJlbW92ZU5vZGUoZGl2KTsKICAgICAgICAgICAgICAgICAgICBkaXYgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldEF1dG9DcmVhdGUgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBjZmcgPSBFeHQuaXNPYmplY3QodGhpcy5hdXRvQ3JlYXRlKSA/CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dG9DcmVhdGUgOiBFeHQuYXBwbHkoe30sIHRoaXMuZGVmYXVsdEF1dG9DcmVhdGUpOwogICAgICAgIGlmKHRoaXMuaWQgJiYgIWNmZy5pZCl7CiAgICAgICAgICAgIGNmZy5pZCA9IHRoaXMuaWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjZmc7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJSZW5kZXIgOiBFeHQuZW1wdHlGbiwKCiAgICAKICAgIGRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLmlzRGVzdHJveWVkKXsKICAgICAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoJ2JlZm9yZWRlc3Ryb3knLCB0aGlzKSAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgdGhpcy5kZXN0cm95aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuYmVmb3JlRGVzdHJveSgpOwogICAgICAgICAgICAgICAgaWYodGhpcy5vd25lckN0ICYmIHRoaXMub3duZXJDdC5yZW1vdmUpewogICAgICAgICAgICAgICAgICAgIHRoaXMub3duZXJDdC5yZW1vdmUodGhpcywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmFjdGlvbk1vZGUgPT0gJ2NvbnRhaW5lcicgfHwgdGhpcy5yZW1vdmVNb2RlID09ICdjb250YWluZXInKXsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZih0aGlzLmZvY3VzVGFzayAmJiB0aGlzLmZvY3VzVGFzay5jYW5jZWwpewogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9jdXNUYXNrLmNhbmNlbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vbkRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIEV4dC5Db21wb25lbnRNZ3IudW5yZWdpc3Rlcih0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdkZXN0cm95JywgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLnB1cmdlTGlzdGVuZXJzKCk7CiAgICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3lpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuaXNEZXN0cm95ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICBkZWxldGVNZW1iZXJzIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBhcmdzLmxlbmd0aDsgaSA8IGxlbjsgKytpKXsKICAgICAgICAgICAgZGVsZXRlIHRoaXNbYXJnc1tpXV07CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGJlZm9yZURlc3Ryb3kgOiBFeHQuZW1wdHlGbiwKCiAgICAKICAgIG9uRGVzdHJveSAgOiBFeHQuZW1wdHlGbiwKCiAgICAKICAgIGdldEVsIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5lbDsKICAgIH0sCgogICAgCiAgICBnZXRDb250ZW50VGFyZ2V0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5lbDsKICAgIH0sCgogICAgCiAgICBnZXRJZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuaWQgfHwgKHRoaXMuaWQgPSAnZXh0LWNvbXAtJyArICgrK0V4dC5Db21wb25lbnQuQVVUT19JRCkpOwogICAgfSwKCiAgICAKICAgIGdldEl0ZW1JZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuaXRlbUlkIHx8IHRoaXMuZ2V0SWQoKTsKICAgIH0sCgogICAgCiAgICBmb2N1cyA6IGZ1bmN0aW9uKHNlbGVjdFRleHQsIGRlbGF5KXsKICAgICAgICBpZihkZWxheSl7CiAgICAgICAgICAgIHRoaXMuZm9jdXNUYXNrID0gbmV3IEV4dC51dGlsLkRlbGF5ZWRUYXNrKHRoaXMuZm9jdXMsIHRoaXMsIFtzZWxlY3RUZXh0LCBmYWxzZV0pOwogICAgICAgICAgICB0aGlzLmZvY3VzVGFzay5kZWxheShFeHQuaXNOdW1iZXIoZGVsYXkpID8gZGVsYXkgOiAxMCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnJlbmRlcmVkICYmICF0aGlzLmlzRGVzdHJveWVkKXsKICAgICAgICAgICAgdGhpcy5lbC5mb2N1cygpOwogICAgICAgICAgICBpZihzZWxlY3RUZXh0ID09PSB0cnVlKXsKICAgICAgICAgICAgICAgIHRoaXMuZWwuZG9tLnNlbGVjdCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGJsdXIgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLmVsLmJsdXIoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZGlzYWJsZSA6IGZ1bmN0aW9uKCBzaWxlbnQpewogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLm9uRGlzYWJsZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICBpZihzaWxlbnQgIT09IHRydWUpewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZGlzYWJsZScsIHRoaXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBvbkRpc2FibGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZ2V0QWN0aW9uRWwoKS5hZGRDbGFzcyh0aGlzLmRpc2FibGVkQ2xhc3MpOwogICAgICAgIHRoaXMuZWwuZG9tLmRpc2FibGVkID0gdHJ1ZTsKICAgIH0sCgogICAgCiAgICBlbmFibGUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLm9uRW5hYmxlKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnZW5hYmxlJywgdGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgb25FbmFibGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZ2V0QWN0aW9uRWwoKS5yZW1vdmVDbGFzcyh0aGlzLmRpc2FibGVkQ2xhc3MpOwogICAgICAgIHRoaXMuZWwuZG9tLmRpc2FibGVkID0gZmFsc2U7CiAgICB9LAoKICAgIAogICAgc2V0RGlzYWJsZWQgOiBmdW5jdGlvbihkaXNhYmxlZCl7CiAgICAgICAgcmV0dXJuIHRoaXNbZGlzYWJsZWQgPyAnZGlzYWJsZScgOiAnZW5hYmxlJ10oKTsKICAgIH0sCgogICAgCiAgICBzaG93IDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3Jlc2hvdycsIHRoaXMpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuaGlkZGVuID0gZmFsc2U7CiAgICAgICAgICAgIGlmKHRoaXMuYXV0b1JlbmRlcil7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcihFeHQuaXNCb29sZWFuKHRoaXMuYXV0b1JlbmRlcikgPyBFeHQuZ2V0Qm9keSgpIDogdGhpcy5hdXRvUmVuZGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgICAgIHRoaXMub25TaG93KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3Nob3cnLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgb25TaG93IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmdldFZpc2liaWxpdHlFbCgpLnJlbW92ZUNsYXNzKCd4LWhpZGUtJyArIHRoaXMuaGlkZU1vZGUpOwogICAgfSwKCiAgICAKICAgIGhpZGUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVoaWRlJywgdGhpcykgIT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5kb0hpZGUoKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2hpZGUnLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZG9IaWRlOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuaGlkZGVuID0gdHJ1ZTsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy5vbkhpZGUoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25IaWRlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmdldFZpc2liaWxpdHlFbCgpLmFkZENsYXNzKCd4LWhpZGUtJyArIHRoaXMuaGlkZU1vZGUpOwogICAgfSwKCiAgICAKICAgIGdldFZpc2liaWxpdHlFbCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuaGlkZVBhcmVudCA/IHRoaXMuY29udGFpbmVyIDogdGhpcy5nZXRBY3Rpb25FbCgpOwogICAgfSwKCiAgICAKICAgIHNldFZpc2libGUgOiBmdW5jdGlvbih2aXNpYmxlKXsKICAgICAgICByZXR1cm4gdGhpc1t2aXNpYmxlID8gJ3Nob3cnIDogJ2hpZGUnXSgpOwogICAgfSwKCiAgICAKICAgIGlzVmlzaWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyZWQgJiYgdGhpcy5nZXRWaXNpYmlsaXR5RWwoKS5pc1Zpc2libGUoKTsKICAgIH0sCgogICAgCiAgICBjbG9uZUNvbmZpZyA6IGZ1bmN0aW9uKG92ZXJyaWRlcyl7CiAgICAgICAgb3ZlcnJpZGVzID0gb3ZlcnJpZGVzIHx8IHt9OwogICAgICAgIHZhciBpZCA9IG92ZXJyaWRlcy5pZCB8fCBFeHQuaWQoKTsKICAgICAgICB2YXIgY2ZnID0gRXh0LmFwcGx5SWYob3ZlcnJpZGVzLCB0aGlzLmluaXRpYWxDb25maWcpOwogICAgICAgIGNmZy5pZCA9IGlkOyAKICAgICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IoY2ZnKTsKICAgIH0sCgogICAgCiAgICBnZXRYVHlwZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IueHR5cGU7CiAgICB9LAoKICAgIAogICAgaXNYVHlwZSA6IGZ1bmN0aW9uKHh0eXBlLCBzaGFsbG93KXsKICAgICAgICAKICAgICAgICBpZiAoRXh0LmlzRnVuY3Rpb24oeHR5cGUpKXsKICAgICAgICAgICAgeHR5cGUgPSB4dHlwZS54dHlwZTsgCiAgICAgICAgfWVsc2UgaWYgKEV4dC5pc09iamVjdCh4dHlwZSkpewogICAgICAgICAgICB4dHlwZSA9IHh0eXBlLmNvbnN0cnVjdG9yLnh0eXBlOyAKICAgICAgICB9CgogICAgICAgIHJldHVybiAhc2hhbGxvdyA/ICgnLycgKyB0aGlzLmdldFhUeXBlcygpICsgJy8nKS5pbmRleE9mKCcvJyArIHh0eXBlICsgJy8nKSAhPSAtMSA6IHRoaXMuY29uc3RydWN0b3IueHR5cGUgPT0geHR5cGU7CiAgICB9LAoKICAgIAogICAgZ2V0WFR5cGVzIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdGMgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGlmKCF0Yy54dHlwZXMpewogICAgICAgICAgICB2YXIgYyA9IFtdLCBzYyA9IHRoaXM7CiAgICAgICAgICAgIHdoaWxlKHNjICYmIHNjLmNvbnN0cnVjdG9yLnh0eXBlKXsKICAgICAgICAgICAgICAgIGMudW5zaGlmdChzYy5jb25zdHJ1Y3Rvci54dHlwZSk7CiAgICAgICAgICAgICAgICBzYyA9IHNjLmNvbnN0cnVjdG9yLnN1cGVyY2xhc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGMueHR5cGVDaGFpbiA9IGM7CiAgICAgICAgICAgIHRjLnh0eXBlcyA9IGMuam9pbignLycpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGMueHR5cGVzOwogICAgfSwKCiAgICAKICAgIGZpbmRQYXJlbnRCeSA6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgZm9yICh2YXIgcCA9IHRoaXMub3duZXJDdDsgKHAgIT0gbnVsbCkgJiYgIWZuKHAsIHRoaXMpOyBwID0gcC5vd25lckN0KTsKICAgICAgICByZXR1cm4gcCB8fCBudWxsOwogICAgfSwKCiAgICAKICAgIGZpbmRQYXJlbnRCeVR5cGUgOiBmdW5jdGlvbih4dHlwZSwgc2hhbGxvdyl7CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZFBhcmVudEJ5KGZ1bmN0aW9uKGMpewogICAgICAgICAgICByZXR1cm4gYy5pc1hUeXBlKHh0eXBlLCBzaGFsbG93KTsKICAgICAgICB9KTsKICAgIH0sCiAgICAKICAgIAogICAgYnViYmxlIDogZnVuY3Rpb24oZm4sIHNjb3BlLCBhcmdzKXsKICAgICAgICB2YXIgcCA9IHRoaXM7CiAgICAgICAgd2hpbGUocCl7CiAgICAgICAgICAgIGlmKGZuLmFwcGx5KHNjb3BlIHx8IHAsIGFyZ3MgfHwgW3BdKSA9PT0gZmFsc2UpewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcCA9IHAub3duZXJDdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZ2V0UG9zaXRpb25FbCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb25FbCB8fCB0aGlzLmVsOwogICAgfSwKCiAgICAKICAgIHB1cmdlTGlzdGVuZXJzIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuQ29tcG9uZW50LnN1cGVyY2xhc3MucHVyZ2VMaXN0ZW5lcnMuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLm1vbnMpewogICAgICAgICAgICB0aGlzLm9uKCdiZWZvcmVkZXN0cm95JywgdGhpcy5jbGVhck1vbnMsIHRoaXMsIHtzaW5nbGU6IHRydWV9KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgY2xlYXJNb25zIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZWFjaCh0aGlzLm1vbnMsIGZ1bmN0aW9uKG0pewogICAgICAgICAgICBtLml0ZW0udW4obS5lbmFtZSwgbS5mbiwgbS5zY29wZSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgdGhpcy5tb25zID0gW107CiAgICB9LAoKICAgIAogICAgY3JlYXRlTW9uczogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5tb25zKXsKICAgICAgICAgICAgdGhpcy5tb25zID0gW107CiAgICAgICAgICAgIHRoaXMub24oJ2JlZm9yZWRlc3Ryb3knLCB0aGlzLmNsZWFyTW9ucywgdGhpcywge3NpbmdsZTogdHJ1ZX0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBtb24gOiBmdW5jdGlvbihpdGVtLCBlbmFtZSwgZm4sIHNjb3BlLCBvcHQpewogICAgICAgIHRoaXMuY3JlYXRlTW9ucygpOwogICAgICAgIGlmKEV4dC5pc09iamVjdChlbmFtZSkpewogICAgICAgICAgICB2YXIgcHJvcFJlID0gL14oPzpzY29wZXxkZWxheXxidWZmZXJ8c2luZ2xlfHN0b3BFdmVudHxwcmV2ZW50RGVmYXVsdHxzdG9wUHJvcGFnYXRpb258bm9ybWFsaXplZHxhcmdzfGRlbGVnYXRlKSQvOwoKICAgICAgICAgICAgdmFyIG8gPSBlbmFtZTsKICAgICAgICAgICAgZm9yKHZhciBlIGluIG8pewogICAgICAgICAgICAgICAgaWYocHJvcFJlLnRlc3QoZSkpewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoRXh0LmlzRnVuY3Rpb24ob1tlXSkpewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMubW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgaXRlbTogaXRlbSwgZW5hbWU6IGUsIGZuOiBvW2VdLCBzY29wZTogby5zY29wZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGl0ZW0ub24oZSwgb1tlXSwgby5zY29wZSwgbyk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW06IGl0ZW0sIGVuYW1lOiBlLCBmbjogb1tlXSwgc2NvcGU6IG8uc2NvcGUKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpdGVtLm9uKGUsIG9bZV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMubW9ucy5wdXNoKHsKICAgICAgICAgICAgaXRlbTogaXRlbSwgZW5hbWU6IGVuYW1lLCBmbjogZm4sIHNjb3BlOiBzY29wZQogICAgICAgIH0pOwogICAgICAgIGl0ZW0ub24oZW5hbWUsIGZuLCBzY29wZSwgb3B0KTsKICAgIH0sCgogICAgCiAgICBtdW4gOiBmdW5jdGlvbihpdGVtLCBlbmFtZSwgZm4sIHNjb3BlKXsKICAgICAgICB2YXIgZm91bmQsIG1vbjsKICAgICAgICB0aGlzLmNyZWF0ZU1vbnMoKTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSB0aGlzLm1vbnMubGVuZ3RoOyBpIDwgbGVuOyArK2kpewogICAgICAgICAgICBtb24gPSB0aGlzLm1vbnNbaV07CiAgICAgICAgICAgIGlmKGl0ZW0gPT09IG1vbi5pdGVtICYmIGVuYW1lID09IG1vbi5lbmFtZSAmJiBmbiA9PT0gbW9uLmZuICYmIHNjb3BlID09PSBtb24uc2NvcGUpewogICAgICAgICAgICAgICAgdGhpcy5tb25zLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgIGl0ZW0udW4oZW5hbWUsIGZuLCBzY29wZSk7CiAgICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZm91bmQ7CiAgICB9LAoKICAgIAogICAgbmV4dFNpYmxpbmcgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMub3duZXJDdCl7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMub3duZXJDdC5pdGVtcy5pbmRleE9mKHRoaXMpOwogICAgICAgICAgICBpZihpbmRleCAhPSAtMSAmJiBpbmRleCsxIDwgdGhpcy5vd25lckN0Lml0ZW1zLmdldENvdW50KCkpewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMub3duZXJDdC5pdGVtcy5pdGVtQXQoaW5kZXgrMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIAogICAgcHJldmlvdXNTaWJsaW5nIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLm93bmVyQ3QpewogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLm93bmVyQ3QuaXRlbXMuaW5kZXhPZih0aGlzKTsKICAgICAgICAgICAgaWYoaW5kZXggPiAwKXsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm93bmVyQ3QuaXRlbXMuaXRlbUF0KGluZGV4LTEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAKICAgIGdldEJ1YmJsZVRhcmdldCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMub3duZXJDdDsKICAgIH0KfSk7CgpFeHQucmVnKCdjb21wb25lbnQnLCBFeHQuQ29tcG9uZW50KTsKCkV4dC5BY3Rpb24gPSBFeHQuZXh0ZW5kKE9iamVjdCwgewogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCgogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIHRoaXMuaW5pdGlhbENvbmZpZyA9IGNvbmZpZzsKICAgICAgICB0aGlzLml0ZW1JZCA9IGNvbmZpZy5pdGVtSWQgPSAoY29uZmlnLml0ZW1JZCB8fCBjb25maWcuaWQgfHwgRXh0LmlkKCkpOwogICAgICAgIHRoaXMuaXRlbXMgPSBbXTsKICAgIH0sCiAgICAKICAgIAogICAgaXNBY3Rpb24gOiB0cnVlLAoKICAgIAogICAgc2V0VGV4dCA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgIHRoaXMuaW5pdGlhbENvbmZpZy50ZXh0ID0gdGV4dDsKICAgICAgICB0aGlzLmNhbGxFYWNoKCdzZXRUZXh0JywgW3RleHRdKTsKICAgIH0sCgogICAgCiAgICBnZXRUZXh0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsQ29uZmlnLnRleHQ7CiAgICB9LAoKICAgIAogICAgc2V0SWNvbkNsYXNzIDogZnVuY3Rpb24oY2xzKXsKICAgICAgICB0aGlzLmluaXRpYWxDb25maWcuaWNvbkNscyA9IGNsczsKICAgICAgICB0aGlzLmNhbGxFYWNoKCdzZXRJY29uQ2xhc3MnLCBbY2xzXSk7CiAgICB9LAoKICAgIAogICAgZ2V0SWNvbkNsYXNzIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsQ29uZmlnLmljb25DbHM7CiAgICB9LAoKICAgIAogICAgc2V0RGlzYWJsZWQgOiBmdW5jdGlvbih2KXsKICAgICAgICB0aGlzLmluaXRpYWxDb25maWcuZGlzYWJsZWQgPSB2OwogICAgICAgIHRoaXMuY2FsbEVhY2goJ3NldERpc2FibGVkJywgW3ZdKTsKICAgIH0sCgogICAgCiAgICBlbmFibGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuc2V0RGlzYWJsZWQoZmFsc2UpOwogICAgfSwKCiAgICAKICAgIGRpc2FibGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuc2V0RGlzYWJsZWQodHJ1ZSk7CiAgICB9LAoKICAgIAogICAgaXNEaXNhYmxlZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5pdGlhbENvbmZpZy5kaXNhYmxlZDsKICAgIH0sCgogICAgCiAgICBzZXRIaWRkZW4gOiBmdW5jdGlvbih2KXsKICAgICAgICB0aGlzLmluaXRpYWxDb25maWcuaGlkZGVuID0gdjsKICAgICAgICB0aGlzLmNhbGxFYWNoKCdzZXRWaXNpYmxlJywgWyF2XSk7CiAgICB9LAoKICAgIAogICAgc2hvdyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zZXRIaWRkZW4oZmFsc2UpOwogICAgfSwKCiAgICAKICAgIGhpZGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuc2V0SGlkZGVuKHRydWUpOwogICAgfSwKCiAgICAKICAgIGlzSGlkZGVuIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pbml0aWFsQ29uZmlnLmhpZGRlbjsKICAgIH0sCgogICAgCiAgICBzZXRIYW5kbGVyIDogZnVuY3Rpb24oZm4sIHNjb3BlKXsKICAgICAgICB0aGlzLmluaXRpYWxDb25maWcuaGFuZGxlciA9IGZuOwogICAgICAgIHRoaXMuaW5pdGlhbENvbmZpZy5zY29wZSA9IHNjb3BlOwogICAgICAgIHRoaXMuY2FsbEVhY2goJ3NldEhhbmRsZXInLCBbZm4sIHNjb3BlXSk7CiAgICB9LAoKICAgIAogICAgZWFjaCA6IGZ1bmN0aW9uKGZuLCBzY29wZSl7CiAgICAgICAgRXh0LmVhY2godGhpcy5pdGVtcywgZm4sIHNjb3BlKTsKICAgIH0sCgogICAgCiAgICBjYWxsRWFjaCA6IGZ1bmN0aW9uKGZuTmFtZSwgYXJncyl7CiAgICAgICAgdmFyIGNzID0gdGhpcy5pdGVtczsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBjcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGNzW2ldW2ZuTmFtZV0uYXBwbHkoY3NbaV0sIGFyZ3MpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhZGRDb21wb25lbnQgOiBmdW5jdGlvbihjb21wKXsKICAgICAgICB0aGlzLml0ZW1zLnB1c2goY29tcCk7CiAgICAgICAgY29tcC5vbignZGVzdHJveScsIHRoaXMucmVtb3ZlQ29tcG9uZW50LCB0aGlzKTsKICAgIH0sCgogICAgCiAgICByZW1vdmVDb21wb25lbnQgOiBmdW5jdGlvbihjb21wKXsKICAgICAgICB0aGlzLml0ZW1zLnJlbW92ZShjb21wKTsKICAgIH0sCgogICAgCiAgICBleGVjdXRlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmluaXRpYWxDb25maWcuaGFuZGxlci5hcHBseSh0aGlzLmluaXRpYWxDb25maWcuc2NvcGUgfHwgd2luZG93LCBhcmd1bWVudHMpOwogICAgfQp9KTsKCihmdW5jdGlvbigpewpFeHQuTGF5ZXIgPSBmdW5jdGlvbihjb25maWcsIGV4aXN0aW5nRWwpewogICAgY29uZmlnID0gY29uZmlnIHx8IHt9OwogICAgdmFyIGRoID0gRXh0LkRvbUhlbHBlciwKICAgICAgICBjcCA9IGNvbmZpZy5wYXJlbnRFbCwgcGVsID0gY3AgPyBFeHQuZ2V0RG9tKGNwKSA6IGRvY3VtZW50LmJvZHk7CiAgICAgICAgCiAgICBpZiAoZXhpc3RpbmdFbCkgewogICAgICAgIHRoaXMuZG9tID0gRXh0LmdldERvbShleGlzdGluZ0VsKTsKICAgIH0KICAgIGlmKCF0aGlzLmRvbSl7CiAgICAgICAgdmFyIG8gPSBjb25maWcuZGggfHwge3RhZzogJ2RpdicsIGNsczogJ3gtbGF5ZXInfTsKICAgICAgICB0aGlzLmRvbSA9IGRoLmFwcGVuZChwZWwsIG8pOwogICAgfQogICAgaWYoY29uZmlnLmNscyl7CiAgICAgICAgdGhpcy5hZGRDbGFzcyhjb25maWcuY2xzKTsKICAgIH0KICAgIHRoaXMuY29uc3RyYWluID0gY29uZmlnLmNvbnN0cmFpbiAhPT0gZmFsc2U7CiAgICB0aGlzLnNldFZpc2liaWxpdHlNb2RlKEV4dC5FbGVtZW50LlZJU0lCSUxJVFkpOwogICAgaWYoY29uZmlnLmlkKXsKICAgICAgICB0aGlzLmlkID0gdGhpcy5kb20uaWQgPSBjb25maWcuaWQ7CiAgICB9ZWxzZXsKICAgICAgICB0aGlzLmlkID0gRXh0LmlkKHRoaXMuZG9tKTsKICAgIH0KICAgIHRoaXMuemluZGV4ID0gY29uZmlnLnppbmRleCB8fCB0aGlzLmdldFpJbmRleCgpOwogICAgdGhpcy5wb3NpdGlvbignYWJzb2x1dGUnLCB0aGlzLnppbmRleCk7CiAgICBpZihjb25maWcuc2hhZG93KXsKICAgICAgICB0aGlzLnNoYWRvd09mZnNldCA9IGNvbmZpZy5zaGFkb3dPZmZzZXQgfHwgNDsKICAgICAgICB0aGlzLnNoYWRvdyA9IG5ldyBFeHQuU2hhZG93KHsKICAgICAgICAgICAgb2Zmc2V0IDogdGhpcy5zaGFkb3dPZmZzZXQsCiAgICAgICAgICAgIG1vZGUgOiBjb25maWcuc2hhZG93CiAgICAgICAgfSk7CiAgICB9ZWxzZXsKICAgICAgICB0aGlzLnNoYWRvd09mZnNldCA9IDA7CiAgICB9CiAgICB0aGlzLnVzZVNoaW0gPSBjb25maWcuc2hpbSAhPT0gZmFsc2UgJiYgRXh0LnVzZVNoaW1zOwogICAgdGhpcy51c2VEaXNwbGF5ID0gY29uZmlnLnVzZURpc3BsYXk7CiAgICB0aGlzLmhpZGUoKTsKfTsKCnZhciBzdXByID0gRXh0LkVsZW1lbnQucHJvdG90eXBlOwoKCnZhciBzaGltcyA9IFtdOwoKRXh0LmV4dGVuZChFeHQuTGF5ZXIsIEV4dC5FbGVtZW50LCB7CgogICAgZ2V0WkluZGV4IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy56aW5kZXggfHwgcGFyc2VJbnQoKHRoaXMuZ2V0U2hpbSgpIHx8IHRoaXMpLmdldFN0eWxlKCd6LWluZGV4JyksIDEwKSB8fCAxMTAwMDsKICAgIH0sCgogICAgZ2V0U2hpbSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMudXNlU2hpbSl7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnNoaW0pewogICAgICAgICAgICByZXR1cm4gdGhpcy5zaGltOwogICAgICAgIH0KICAgICAgICB2YXIgc2hpbSA9IHNoaW1zLnNoaWZ0KCk7CiAgICAgICAgaWYoIXNoaW0pewogICAgICAgICAgICBzaGltID0gdGhpcy5jcmVhdGVTaGltKCk7CiAgICAgICAgICAgIHNoaW0uZW5hYmxlRGlzcGxheU1vZGUoJ2Jsb2NrJyk7CiAgICAgICAgICAgIHNoaW0uZG9tLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIHNoaW0uZG9tLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CiAgICAgICAgfQogICAgICAgIHZhciBwbiA9IHRoaXMuZG9tLnBhcmVudE5vZGU7CiAgICAgICAgaWYoc2hpbS5kb20ucGFyZW50Tm9kZSAhPSBwbil7CiAgICAgICAgICAgIHBuLmluc2VydEJlZm9yZShzaGltLmRvbSwgdGhpcy5kb20pOwogICAgICAgIH0KICAgICAgICBzaGltLnNldFN0eWxlKCd6LWluZGV4JywgdGhpcy5nZXRaSW5kZXgoKS0yKTsKICAgICAgICB0aGlzLnNoaW0gPSBzaGltOwogICAgICAgIHJldHVybiBzaGltOwogICAgfSwKCiAgICBoaWRlU2hpbSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5zaGltKXsKICAgICAgICAgICAgdGhpcy5zaGltLnNldERpc3BsYXllZChmYWxzZSk7CiAgICAgICAgICAgIHNoaW1zLnB1c2godGhpcy5zaGltKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuc2hpbTsKICAgICAgICB9CiAgICB9LAoKICAgIGRpc2FibGVTaGFkb3cgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuc2hhZG93KXsKICAgICAgICAgICAgdGhpcy5zaGFkb3dEaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuc2hhZG93LmhpZGUoKTsKICAgICAgICAgICAgdGhpcy5sYXN0U2hhZG93T2Zmc2V0ID0gdGhpcy5zaGFkb3dPZmZzZXQ7CiAgICAgICAgICAgIHRoaXMuc2hhZG93T2Zmc2V0ID0gMDsKICAgICAgICB9CiAgICB9LAoKICAgIGVuYWJsZVNoYWRvdyA6IGZ1bmN0aW9uKHNob3cpewogICAgICAgIGlmKHRoaXMuc2hhZG93KXsKICAgICAgICAgICAgdGhpcy5zaGFkb3dEaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICBpZihFeHQuaXNEZWZpbmVkKHRoaXMubGFzdFNoYWRvd09mZnNldCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2hhZG93T2Zmc2V0ID0gdGhpcy5sYXN0U2hhZG93T2Zmc2V0OwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubGFzdFNoYWRvd09mZnNldDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihzaG93KXsKICAgICAgICAgICAgICAgIHRoaXMuc3luYyh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICAKICAgIAogICAgc3luYyA6IGZ1bmN0aW9uKGRvU2hvdyl7CiAgICAgICAgdmFyIHNoYWRvdyA9IHRoaXMuc2hhZG93OwogICAgICAgIGlmKCF0aGlzLnVwZGF0aW5nICYmIHRoaXMuaXNWaXNpYmxlKCkgJiYgKHNoYWRvdyB8fCB0aGlzLnVzZVNoaW0pKXsKICAgICAgICAgICAgdmFyIHNoaW0gPSB0aGlzLmdldFNoaW0oKSwKICAgICAgICAgICAgICAgIHcgPSB0aGlzLmdldFdpZHRoKCksCiAgICAgICAgICAgICAgICBoID0gdGhpcy5nZXRIZWlnaHQoKSwKICAgICAgICAgICAgICAgIGwgPSB0aGlzLmdldExlZnQodHJ1ZSksCiAgICAgICAgICAgICAgICB0ID0gdGhpcy5nZXRUb3AodHJ1ZSk7CgogICAgICAgICAgICBpZihzaGFkb3cgJiYgIXRoaXMuc2hhZG93RGlzYWJsZWQpewogICAgICAgICAgICAgICAgaWYoZG9TaG93ICYmICFzaGFkb3cuaXNWaXNpYmxlKCkpewogICAgICAgICAgICAgICAgICAgIHNoYWRvdy5zaG93KHRoaXMpOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgc2hhZG93LnJlYWxpZ24obCwgdCwgdywgaCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihzaGltKXsKICAgICAgICAgICAgICAgICAgICBpZihkb1Nob3cpewogICAgICAgICAgICAgICAgICAgICAgIHNoaW0uc2hvdygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2YXIgc2hhZG93QWRqID0gc2hhZG93LmVsLmdldFhZKCksIHNoaW1TdHlsZSA9IHNoaW0uZG9tLnN0eWxlLAogICAgICAgICAgICAgICAgICAgICAgICBzaGFkb3dTaXplID0gc2hhZG93LmVsLmdldFNpemUoKTsKICAgICAgICAgICAgICAgICAgICBzaGltU3R5bGUubGVmdCA9IChzaGFkb3dBZGpbMF0pKydweCc7CiAgICAgICAgICAgICAgICAgICAgc2hpbVN0eWxlLnRvcCA9IChzaGFkb3dBZGpbMV0pKydweCc7CiAgICAgICAgICAgICAgICAgICAgc2hpbVN0eWxlLndpZHRoID0gKHNoYWRvd1NpemUud2lkdGgpKydweCc7CiAgICAgICAgICAgICAgICAgICAgc2hpbVN0eWxlLmhlaWdodCA9IChzaGFkb3dTaXplLmhlaWdodCkrJ3B4JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2UgaWYoc2hpbSl7CiAgICAgICAgICAgICAgICBpZihkb1Nob3cpewogICAgICAgICAgICAgICAgICAgc2hpbS5zaG93KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzaGltLnNldFNpemUodywgaCk7CiAgICAgICAgICAgICAgICBzaGltLnNldExlZnRUb3AobCwgdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5oaWRlU2hpbSgpOwogICAgICAgIGlmKHRoaXMuc2hhZG93KXsKICAgICAgICAgICAgdGhpcy5zaGFkb3cuaGlkZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycygpOwogICAgICAgIEV4dC5yZW1vdmVOb2RlKHRoaXMuZG9tKTsKICAgICAgICBkZWxldGUgdGhpcy5kb207CiAgICB9LAoKICAgIHJlbW92ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICB9LAoKICAgIAogICAgYmVnaW5VcGRhdGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMudXBkYXRpbmcgPSB0cnVlOwogICAgfSwKCiAgICAKICAgIGVuZFVwZGF0ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy51cGRhdGluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuc3luYyh0cnVlKTsKICAgIH0sCgogICAgCiAgICBoaWRlVW5kZXJzIDogZnVuY3Rpb24obmVnT2Zmc2V0KXsKICAgICAgICBpZih0aGlzLnNoYWRvdyl7CiAgICAgICAgICAgIHRoaXMuc2hhZG93LmhpZGUoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5oaWRlU2hpbSgpOwogICAgfSwKCiAgICAKICAgIGNvbnN0cmFpblhZIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmNvbnN0cmFpbil7CiAgICAgICAgICAgIHZhciB2dyA9IEV4dC5saWIuRG9tLmdldFZpZXdXaWR0aCgpLAogICAgICAgICAgICAgICAgdmggPSBFeHQubGliLkRvbS5nZXRWaWV3SGVpZ2h0KCk7CiAgICAgICAgICAgIHZhciBzID0gRXh0LmdldERvYygpLmdldFNjcm9sbCgpOwoKICAgICAgICAgICAgdmFyIHh5ID0gdGhpcy5nZXRYWSgpOwogICAgICAgICAgICB2YXIgeCA9IHh5WzBdLCB5ID0geHlbMV07CiAgICAgICAgICAgIHZhciBzbyA9IHRoaXMuc2hhZG93T2Zmc2V0OwogICAgICAgICAgICB2YXIgdyA9IHRoaXMuZG9tLm9mZnNldFdpZHRoK3NvLCBoID0gdGhpcy5kb20ub2Zmc2V0SGVpZ2h0K3NvOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIG1vdmVkID0gZmFsc2U7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZigoeCArIHcpID4gdncrcy5sZWZ0KXsKICAgICAgICAgICAgICAgIHggPSB2dyAtIHcgLSBzbzsKICAgICAgICAgICAgICAgIG1vdmVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZigoeSArIGgpID4gdmgrcy50b3ApewogICAgICAgICAgICAgICAgeSA9IHZoIC0gaCAtIHNvOwogICAgICAgICAgICAgICAgbW92ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZih4IDwgcy5sZWZ0KXsKICAgICAgICAgICAgICAgIHggPSBzLmxlZnQ7CiAgICAgICAgICAgICAgICBtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoeSA8IHMudG9wKXsKICAgICAgICAgICAgICAgIHkgPSBzLnRvcDsKICAgICAgICAgICAgICAgIG1vdmVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihtb3ZlZCl7CiAgICAgICAgICAgICAgICBpZih0aGlzLmF2b2lkWSl7CiAgICAgICAgICAgICAgICAgICAgdmFyIGF5ID0gdGhpcy5hdm9pZFk7CiAgICAgICAgICAgICAgICAgICAgaWYoeSA8PSBheSAmJiAoeStoKSA+PSBheSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBheS1oLTU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgeHkgPSBbeCwgeV07CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JlWFkoeHkpOwogICAgICAgICAgICAgICAgc3Vwci5zZXRYWS5jYWxsKHRoaXMsIHh5KTsKICAgICAgICAgICAgICAgIHRoaXMuc3luYygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIAogICAgZ2V0Q29uc3RyYWluT2Zmc2V0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5zaGFkb3dPZmZzZXQ7ICAgIAogICAgfSwKCiAgICBpc1Zpc2libGUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnZpc2libGU7CiAgICB9LAoKICAgIAogICAgc2hvd0FjdGlvbiA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy52aXNpYmxlID0gdHJ1ZTsgCiAgICAgICAgaWYodGhpcy51c2VEaXNwbGF5ID09PSB0cnVlKXsKICAgICAgICAgICAgdGhpcy5zZXREaXNwbGF5ZWQoJycpOwogICAgICAgIH1lbHNlIGlmKHRoaXMubGFzdFhZKXsKICAgICAgICAgICAgc3Vwci5zZXRYWS5jYWxsKHRoaXMsIHRoaXMubGFzdFhZKTsKICAgICAgICB9ZWxzZSBpZih0aGlzLmxhc3RMVCl7CiAgICAgICAgICAgIHN1cHIuc2V0TGVmdFRvcC5jYWxsKHRoaXMsIHRoaXMubGFzdExUWzBdLCB0aGlzLmxhc3RMVFsxXSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGhpZGVBY3Rpb24gOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMudmlzaWJsZSA9IGZhbHNlOwogICAgICAgIGlmKHRoaXMudXNlRGlzcGxheSA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHRoaXMuc2V0RGlzcGxheWVkKGZhbHNlKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5zZXRMZWZ0VG9wKC0xMDAwMCwtMTAwMDApOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRWaXNpYmxlIDogZnVuY3Rpb24odiwgYSwgZCwgYywgZSl7CiAgICAgICAgaWYodil7CiAgICAgICAgICAgIHRoaXMuc2hvd0FjdGlvbigpOwogICAgICAgIH0KICAgICAgICBpZihhICYmIHYpewogICAgICAgICAgICB2YXIgY2IgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgdGhpcy5zeW5jKHRydWUpOwogICAgICAgICAgICAgICAgaWYoYyl7CiAgICAgICAgICAgICAgICAgICAgYygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LmNyZWF0ZURlbGVnYXRlKHRoaXMpOwogICAgICAgICAgICBzdXByLnNldFZpc2libGUuY2FsbCh0aGlzLCB0cnVlLCB0cnVlLCBkLCBjYiwgZSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGlmKCF2KXsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZVVuZGVycyh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2IgPSBjOwogICAgICAgICAgICBpZihhKXsKICAgICAgICAgICAgICAgIGNiID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVBY3Rpb24oKTsKICAgICAgICAgICAgICAgICAgICBpZihjKXsKICAgICAgICAgICAgICAgICAgICAgICAgYygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0uY3JlYXRlRGVsZWdhdGUodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3Vwci5zZXRWaXNpYmxlLmNhbGwodGhpcywgdiwgYSwgZCwgY2IsIGUpOwogICAgICAgICAgICBpZih2KXsKICAgICAgICAgICAgICAgIHRoaXMuc3luYyh0cnVlKTsKICAgICAgICAgICAgfWVsc2UgaWYoIWEpewogICAgICAgICAgICAgICAgdGhpcy5oaWRlQWN0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHN0b3JlWFkgOiBmdW5jdGlvbih4eSl7CiAgICAgICAgZGVsZXRlIHRoaXMubGFzdExUOwogICAgICAgIHRoaXMubGFzdFhZID0geHk7CiAgICB9LAoKICAgIHN0b3JlTGVmdFRvcCA6IGZ1bmN0aW9uKGxlZnQsIHRvcCl7CiAgICAgICAgZGVsZXRlIHRoaXMubGFzdFhZOwogICAgICAgIHRoaXMubGFzdExUID0gW2xlZnQsIHRvcF07CiAgICB9LAoKICAgIAogICAgYmVmb3JlRnggOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuYmVmb3JlQWN0aW9uKCk7CiAgICAgICAgcmV0dXJuIEV4dC5MYXllci5zdXBlcmNsYXNzLmJlZm9yZUZ4LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJGeCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LkxheWVyLnN1cGVyY2xhc3MuYWZ0ZXJGeC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMuc3luYyh0aGlzLmlzVmlzaWJsZSgpKTsKICAgIH0sCgogICAgCiAgICBiZWZvcmVBY3Rpb24gOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLnVwZGF0aW5nICYmIHRoaXMuc2hhZG93KXsKICAgICAgICAgICAgdGhpcy5zaGFkb3cuaGlkZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRMZWZ0IDogZnVuY3Rpb24obGVmdCl7CiAgICAgICAgdGhpcy5zdG9yZUxlZnRUb3AobGVmdCwgdGhpcy5nZXRUb3AodHJ1ZSkpOwogICAgICAgIHN1cHIuc2V0TGVmdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMuc3luYygpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICBzZXRUb3AgOiBmdW5jdGlvbih0b3ApewogICAgICAgIHRoaXMuc3RvcmVMZWZ0VG9wKHRoaXMuZ2V0TGVmdCh0cnVlKSwgdG9wKTsKICAgICAgICBzdXByLnNldFRvcC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMuc3luYygpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICBzZXRMZWZ0VG9wIDogZnVuY3Rpb24obGVmdCwgdG9wKXsKICAgICAgICB0aGlzLnN0b3JlTGVmdFRvcChsZWZ0LCB0b3ApOwogICAgICAgIHN1cHIuc2V0TGVmdFRvcC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMuc3luYygpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICBzZXRYWSA6IGZ1bmN0aW9uKHh5LCBhLCBkLCBjLCBlKXsKICAgICAgICB0aGlzLmZpeERpc3BsYXkoKTsKICAgICAgICB0aGlzLmJlZm9yZUFjdGlvbigpOwogICAgICAgIHRoaXMuc3RvcmVYWSh4eSk7CiAgICAgICAgdmFyIGNiID0gdGhpcy5jcmVhdGVDQihjKTsKICAgICAgICBzdXByLnNldFhZLmNhbGwodGhpcywgeHksIGEsIGQsIGNiLCBlKTsKICAgICAgICBpZighYSl7CiAgICAgICAgICAgIGNiKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGNyZWF0ZUNCIDogZnVuY3Rpb24oYyl7CiAgICAgICAgdmFyIGVsID0gdGhpczsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgICAgICAgZWwuY29uc3RyYWluWFkoKTsKICAgICAgICAgICAgZWwuc3luYyh0cnVlKTsKICAgICAgICAgICAgaWYoYyl7CiAgICAgICAgICAgICAgICBjKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSwKCiAgICAKICAgIHNldFggOiBmdW5jdGlvbih4LCBhLCBkLCBjLCBlKXsKICAgICAgICB0aGlzLnNldFhZKFt4LCB0aGlzLmdldFkoKV0sIGEsIGQsIGMsIGUpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHNldFkgOiBmdW5jdGlvbih5LCBhLCBkLCBjLCBlKXsKICAgICAgICB0aGlzLnNldFhZKFt0aGlzLmdldFgoKSwgeV0sIGEsIGQsIGMsIGUpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHNldFNpemUgOiBmdW5jdGlvbih3LCBoLCBhLCBkLCBjLCBlKXsKICAgICAgICB0aGlzLmJlZm9yZUFjdGlvbigpOwogICAgICAgIHZhciBjYiA9IHRoaXMuY3JlYXRlQ0IoYyk7CiAgICAgICAgc3Vwci5zZXRTaXplLmNhbGwodGhpcywgdywgaCwgYSwgZCwgY2IsIGUpOwogICAgICAgIGlmKCFhKXsKICAgICAgICAgICAgY2IoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgc2V0V2lkdGggOiBmdW5jdGlvbih3LCBhLCBkLCBjLCBlKXsKICAgICAgICB0aGlzLmJlZm9yZUFjdGlvbigpOwogICAgICAgIHZhciBjYiA9IHRoaXMuY3JlYXRlQ0IoYyk7CiAgICAgICAgc3Vwci5zZXRXaWR0aC5jYWxsKHRoaXMsIHcsIGEsIGQsIGNiLCBlKTsKICAgICAgICBpZighYSl7CiAgICAgICAgICAgIGNiKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHNldEhlaWdodCA6IGZ1bmN0aW9uKGgsIGEsIGQsIGMsIGUpewogICAgICAgIHRoaXMuYmVmb3JlQWN0aW9uKCk7CiAgICAgICAgdmFyIGNiID0gdGhpcy5jcmVhdGVDQihjKTsKICAgICAgICBzdXByLnNldEhlaWdodC5jYWxsKHRoaXMsIGgsIGEsIGQsIGNiLCBlKTsKICAgICAgICBpZighYSl7CiAgICAgICAgICAgIGNiKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHNldEJvdW5kcyA6IGZ1bmN0aW9uKHgsIHksIHcsIGgsIGEsIGQsIGMsIGUpewogICAgICAgIHRoaXMuYmVmb3JlQWN0aW9uKCk7CiAgICAgICAgdmFyIGNiID0gdGhpcy5jcmVhdGVDQihjKTsKICAgICAgICBpZighYSl7CiAgICAgICAgICAgIHRoaXMuc3RvcmVYWShbeCwgeV0pOwogICAgICAgICAgICBzdXByLnNldFhZLmNhbGwodGhpcywgW3gsIHldKTsKICAgICAgICAgICAgc3Vwci5zZXRTaXplLmNhbGwodGhpcywgdywgaCwgYSwgZCwgY2IsIGUpOwogICAgICAgICAgICBjYigpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBzdXByLnNldEJvdW5kcy5jYWxsKHRoaXMsIHgsIHksIHcsIGgsIGEsIGQsIGNiLCBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgc2V0WkluZGV4IDogZnVuY3Rpb24oemluZGV4KXsKICAgICAgICB0aGlzLnppbmRleCA9IHppbmRleDsKICAgICAgICB0aGlzLnNldFN0eWxlKCd6LWluZGV4JywgemluZGV4ICsgMik7CiAgICAgICAgaWYodGhpcy5zaGFkb3cpewogICAgICAgICAgICB0aGlzLnNoYWRvdy5zZXRaSW5kZXgoemluZGV4ICsgMSk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuc2hpbSl7CiAgICAgICAgICAgIHRoaXMuc2hpbS5zZXRTdHlsZSgnei1pbmRleCcsIHppbmRleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQp9KTsKfSkoKTsKCkV4dC5TaGFkb3cgPSBmdW5jdGlvbihjb25maWcpIHsKICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwogICAgaWYgKHR5cGVvZiB0aGlzLm1vZGUgIT0gInN0cmluZyIpIHsKICAgICAgICB0aGlzLm1vZGUgPSB0aGlzLmRlZmF1bHRNb2RlOwogICAgfQogICAgdmFyIG8gPSB0aGlzLm9mZnNldCwKICAgICAgICBhID0gewogICAgICAgICAgICBoOiAwCiAgICAgICAgfSwKICAgICAgICByYWQgPSBNYXRoLmZsb29yKHRoaXMub2Zmc2V0IC8gMik7CiAgICBzd2l0Y2ggKHRoaXMubW9kZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgCiAgICAgICAgY2FzZSAiZHJvcCI6CiAgICAgICAgICAgIGEudyA9IDA7CiAgICAgICAgICAgIGEubCA9IGEudCA9IG87CiAgICAgICAgICAgIGEudCAtPSAxOwogICAgICAgICAgICBpZiAoRXh0LmlzSUUpIHsKICAgICAgICAgICAgICAgIGEubCAtPSB0aGlzLm9mZnNldCArIHJhZDsKICAgICAgICAgICAgICAgIGEudCAtPSB0aGlzLm9mZnNldCArIHJhZDsKICAgICAgICAgICAgICAgIGEudyAtPSByYWQ7CiAgICAgICAgICAgICAgICBhLmggLT0gcmFkOwogICAgICAgICAgICAgICAgYS50ICs9IDE7CiAgICAgICAgICAgIH0KICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJzaWRlcyI6CiAgICAgICAgICAgIGEudyA9IChvICogMik7CiAgICAgICAgICAgIGEubCA9IC1vOwogICAgICAgICAgICBhLnQgPSBvIC0gMTsKICAgICAgICAgICAgaWYgKEV4dC5pc0lFKSB7CiAgICAgICAgICAgICAgICBhLmwgLT0gKHRoaXMub2Zmc2V0IC0gcmFkKTsKICAgICAgICAgICAgICAgIGEudCAtPSB0aGlzLm9mZnNldCArIHJhZDsKICAgICAgICAgICAgICAgIGEubCArPSAxOwogICAgICAgICAgICAgICAgYS53IC09ICh0aGlzLm9mZnNldCAtIHJhZCkgKiAyOwogICAgICAgICAgICAgICAgYS53IC09IHJhZCArIDE7CiAgICAgICAgICAgICAgICBhLmggLT0gMTsKICAgICAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgImZyYW1lIjoKICAgICAgICAgICAgYS53ID0gYS5oID0gKG8gKiAyKTsKICAgICAgICAgICAgYS5sID0gYS50ID0gLW87CiAgICAgICAgICAgIGEudCArPSAxOwogICAgICAgICAgICBhLmggLT0gMjsKICAgICAgICAgICAgaWYgKEV4dC5pc0lFKSB7CiAgICAgICAgICAgICAgICBhLmwgLT0gKHRoaXMub2Zmc2V0IC0gcmFkKTsKICAgICAgICAgICAgICAgIGEudCAtPSAodGhpcy5vZmZzZXQgLSByYWQpOwogICAgICAgICAgICAgICAgYS5sICs9IDE7CiAgICAgICAgICAgICAgICBhLncgLT0gKHRoaXMub2Zmc2V0ICsgcmFkICsgMSk7CiAgICAgICAgICAgICAgICBhLmggLT0gKHRoaXMub2Zmc2V0ICsgcmFkKTsKICAgICAgICAgICAgICAgIGEuaCArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICB9OwoKICAgIHRoaXMuYWRqdXN0cyA9IGE7Cn07CgpFeHQuU2hhZG93LnByb3RvdHlwZSA9IHsKICAgIAogICAgCiAgICBvZmZzZXQ6IDQsCgogICAgCiAgICBkZWZhdWx0TW9kZTogImRyb3AiLAoKICAgIAogICAgc2hvdzogZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgdGFyZ2V0ID0gRXh0LmdldCh0YXJnZXQpOwogICAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgICAgICB0aGlzLmVsID0gRXh0LlNoYWRvdy5Qb29sLnB1bGwoKTsKICAgICAgICAgICAgaWYgKHRoaXMuZWwuZG9tLm5leHRTaWJsaW5nICE9IHRhcmdldC5kb20pIHsKICAgICAgICAgICAgICAgIHRoaXMuZWwuaW5zZXJ0QmVmb3JlKHRhcmdldCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5lbC5zZXRTdHlsZSgiei1pbmRleCIsIHRoaXMuekluZGV4IHx8IHBhcnNlSW50KHRhcmdldC5nZXRTdHlsZSgiei1pbmRleCIpLCAxMCkgLSAxKTsKICAgICAgICBpZiAoRXh0LmlzSUUpIHsKICAgICAgICAgICAgdGhpcy5lbC5kb20uc3R5bGUuZmlsdGVyID0gInByb2dpZDpEWEltYWdlVHJhbnNmb3JtLk1pY3Jvc29mdC5hbHBoYShvcGFjaXR5PTUwKSBwcm9naWQ6RFhJbWFnZVRyYW5zZm9ybS5NaWNyb3NvZnQuQmx1cihwaXhlbHJhZGl1cz0iICsgKHRoaXMub2Zmc2V0KSArICIpIjsKICAgICAgICB9CiAgICAgICAgdGhpcy5yZWFsaWduKAogICAgICAgIHRhcmdldC5nZXRMZWZ0KHRydWUpLAogICAgICAgIHRhcmdldC5nZXRUb3AodHJ1ZSksCiAgICAgICAgdGFyZ2V0LmdldFdpZHRoKCksCiAgICAgICAgdGFyZ2V0LmdldEhlaWdodCgpCiAgICAgICAgKTsKICAgICAgICB0aGlzLmVsLmRvbS5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgIH0sCgogICAgCiAgICBpc1Zpc2libGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmVsID8gdHJ1ZTogZmFsc2U7CiAgICB9LAoKICAgIAogICAgcmVhbGlnbjogZnVuY3Rpb24obCwgdCwgdywgaCkgewogICAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBhID0gdGhpcy5hZGp1c3RzLAogICAgICAgICAgICBkID0gdGhpcy5lbC5kb20sCiAgICAgICAgICAgIHMgPSBkLnN0eWxlLAogICAgICAgICAgICBpZWEgPSAwLAogICAgICAgICAgICBzdyA9ICh3ICsgYS53KSwKICAgICAgICAgICAgc2ggPSAoaCArIGEuaCksCiAgICAgICAgICAgIHN3cyA9IHN3ICsgInB4IiwKICAgICAgICAgICAgc2hzID0gc2ggKyAicHgiLAogICAgICAgICAgICBjbiwKICAgICAgICAgICAgc3d3OwogICAgICAgIHMubGVmdCA9IChsICsgYS5sKSArICJweCI7CiAgICAgICAgcy50b3AgPSAodCArIGEudCkgKyAicHgiOwogICAgICAgIGlmIChzLndpZHRoICE9IHN3cyB8fCBzLmhlaWdodCAhPSBzaHMpIHsKICAgICAgICAgICAgcy53aWR0aCA9IHN3czsKICAgICAgICAgICAgcy5oZWlnaHQgPSBzaHM7CiAgICAgICAgICAgIGlmICghRXh0LmlzSUUpIHsKICAgICAgICAgICAgICAgIGNuID0gZC5jaGlsZE5vZGVzOwogICAgICAgICAgICAgICAgc3d3ID0gTWF0aC5tYXgoMCwgKHN3IC0gMTIpKSArICJweCI7CiAgICAgICAgICAgICAgICBjblswXS5jaGlsZE5vZGVzWzFdLnN0eWxlLndpZHRoID0gc3d3OwogICAgICAgICAgICAgICAgY25bMV0uY2hpbGROb2Rlc1sxXS5zdHlsZS53aWR0aCA9IHN3dzsKICAgICAgICAgICAgICAgIGNuWzJdLmNoaWxkTm9kZXNbMV0uc3R5bGUud2lkdGggPSBzd3c7CiAgICAgICAgICAgICAgICBjblsxXS5zdHlsZS5oZWlnaHQgPSBNYXRoLm1heCgwLCAoc2ggLSAxMikpICsgInB4IjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBoaWRlOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5lbCkgewogICAgICAgICAgICB0aGlzLmVsLmRvbS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICBFeHQuU2hhZG93LlBvb2wucHVzaCh0aGlzLmVsKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuZWw7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNldFpJbmRleDogZnVuY3Rpb24oeikgewogICAgICAgIHRoaXMuekluZGV4ID0gejsKICAgICAgICBpZiAodGhpcy5lbCkgewogICAgICAgICAgICB0aGlzLmVsLnNldFN0eWxlKCJ6LWluZGV4Iiwgeik7CiAgICAgICAgfQogICAgfQp9OwoKCkV4dC5TaGFkb3cuUG9vbCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHAgPSBbXSwKICAgICAgICBtYXJrdXAgPSBFeHQuaXNJRSA/CiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWllLXNoYWRvdyI+PC9kaXY+JzoKICAgICAgICAgICAgJzxkaXYgY2xhc3M9Ingtc2hhZG93Ij48ZGl2IGNsYXNzPSJ4c3QiPjxkaXYgY2xhc3M9InhzdGwiPjwvZGl2PjxkaXYgY2xhc3M9InhzdGMiPjwvZGl2PjxkaXYgY2xhc3M9InhzdHIiPjwvZGl2PjwvZGl2PjxkaXYgY2xhc3M9InhzYyI+PGRpdiBjbGFzcz0ieHNtbCI+PC9kaXY+PGRpdiBjbGFzcz0ieHNtYyI+PC9kaXY+PGRpdiBjbGFzcz0ieHNtciI+PC9kaXY+PC9kaXY+PGRpdiBjbGFzcz0ieHNiIj48ZGl2IGNsYXNzPSJ4c2JsIj48L2Rpdj48ZGl2IGNsYXNzPSJ4c2JjIj48L2Rpdj48ZGl2IGNsYXNzPSJ4c2JyIj48L2Rpdj48L2Rpdj48L2Rpdj4nOwogICAgcmV0dXJuIHsKICAgICAgICBwdWxsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHNoID0gcC5zaGlmdCgpOwogICAgICAgICAgICBpZiAoIXNoKSB7CiAgICAgICAgICAgICAgICBzaCA9IEV4dC5nZXQoRXh0LkRvbUhlbHBlci5pbnNlcnRIdG1sKCJiZWZvcmVCZWdpbiIsIGRvY3VtZW50LmJvZHkuZmlyc3RDaGlsZCwgbWFya3VwKSk7CiAgICAgICAgICAgICAgICBzaC5hdXRvQm94QWRqdXN0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNoOwogICAgICAgIH0sCgogICAgICAgIHB1c2g6IGZ1bmN0aW9uKHNoKSB7CiAgICAgICAgICAgIHAucHVzaChzaCk7CiAgICAgICAgfQogICAgfTsKfSgpOwpFeHQuQm94Q29tcG9uZW50ID0gRXh0LmV4dGVuZChFeHQuQ29tcG9uZW50LCB7CgogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKCiAgICAKCiAgICAKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5Cb3hDb21wb25lbnQuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAncmVzaXplJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdtb3ZlJwogICAgICAgICk7CiAgICB9LAoKICAgIAogICAgYm94UmVhZHkgOiBmYWxzZSwKICAgIAogICAgZGVmZXJIZWlnaHQ6IGZhbHNlLAoKICAgIAogICAgc2V0U2l6ZSA6IGZ1bmN0aW9uKHcsIGgpewoKICAgICAgICAKICAgICAgICBpZih0eXBlb2YgdyA9PSAnb2JqZWN0Jyl7CiAgICAgICAgICAgIGggPSB3LmhlaWdodDsKICAgICAgICAgICAgdyA9IHcud2lkdGg7CiAgICAgICAgfQogICAgICAgIGlmIChFeHQuaXNEZWZpbmVkKHcpICYmIEV4dC5pc0RlZmluZWQodGhpcy5ib3hNaW5XaWR0aCkgJiYgKHcgPCB0aGlzLmJveE1pbldpZHRoKSkgewogICAgICAgICAgICB3ID0gdGhpcy5ib3hNaW5XaWR0aDsKICAgICAgICB9CiAgICAgICAgaWYgKEV4dC5pc0RlZmluZWQoaCkgJiYgRXh0LmlzRGVmaW5lZCh0aGlzLmJveE1pbkhlaWdodCkgJiYgKGggPCB0aGlzLmJveE1pbkhlaWdodCkpIHsKICAgICAgICAgICAgaCA9IHRoaXMuYm94TWluSGVpZ2h0OwogICAgICAgIH0KICAgICAgICBpZiAoRXh0LmlzRGVmaW5lZCh3KSAmJiBFeHQuaXNEZWZpbmVkKHRoaXMuYm94TWF4V2lkdGgpICYmICh3ID4gdGhpcy5ib3hNYXhXaWR0aCkpIHsKICAgICAgICAgICAgdyA9IHRoaXMuYm94TWF4V2lkdGg7CiAgICAgICAgfQogICAgICAgIGlmIChFeHQuaXNEZWZpbmVkKGgpICYmIEV4dC5pc0RlZmluZWQodGhpcy5ib3hNYXhIZWlnaHQpICYmIChoID4gdGhpcy5ib3hNYXhIZWlnaHQpKSB7CiAgICAgICAgICAgIGggPSB0aGlzLmJveE1heEhlaWdodDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYoIXRoaXMuYm94UmVhZHkpewogICAgICAgICAgICB0aGlzLndpZHRoICA9IHc7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gaDsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBpZih0aGlzLmNhY2hlU2l6ZXMgIT09IGZhbHNlICYmIHRoaXMubGFzdFNpemUgJiYgdGhpcy5sYXN0U2l6ZS53aWR0aCA9PSB3ICYmIHRoaXMubGFzdFNpemUuaGVpZ2h0ID09IGgpewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgdGhpcy5sYXN0U2l6ZSA9IHt3aWR0aDogdywgaGVpZ2h0OiBofTsKICAgICAgICB2YXIgYWRqID0gdGhpcy5hZGp1c3RTaXplKHcsIGgpLAogICAgICAgICAgICBhdyA9IGFkai53aWR0aCwKICAgICAgICAgICAgYWggPSBhZGouaGVpZ2h0LAogICAgICAgICAgICByejsKICAgICAgICBpZihhdyAhPT0gdW5kZWZpbmVkIHx8IGFoICE9PSB1bmRlZmluZWQpeyAKICAgICAgICAgICAgcnogPSB0aGlzLmdldFJlc2l6ZUVsKCk7CiAgICAgICAgICAgIGlmKCF0aGlzLmRlZmVySGVpZ2h0ICYmIGF3ICE9PSB1bmRlZmluZWQgJiYgYWggIT09IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICByei5zZXRTaXplKGF3LCBhaCk7CiAgICAgICAgICAgIH1lbHNlIGlmKCF0aGlzLmRlZmVySGVpZ2h0ICYmIGFoICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgcnouc2V0SGVpZ2h0KGFoKTsKICAgICAgICAgICAgfWVsc2UgaWYoYXcgIT09IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICByei5zZXRXaWR0aChhdyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vblJlc2l6ZShhdywgYWgsIHcsIGgpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgncmVzaXplJywgdGhpcywgYXcsIGFoLCB3LCBoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgc2V0V2lkdGggOiBmdW5jdGlvbih3aWR0aCl7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0U2l6ZSh3aWR0aCk7CiAgICB9LAoKICAgIAogICAgc2V0SGVpZ2h0IDogZnVuY3Rpb24oaGVpZ2h0KXsKICAgICAgICByZXR1cm4gdGhpcy5zZXRTaXplKHVuZGVmaW5lZCwgaGVpZ2h0KTsKICAgIH0sCgogICAgCiAgICBnZXRTaXplIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5nZXRSZXNpemVFbCgpLmdldFNpemUoKTsKICAgIH0sCgogICAgCiAgICBnZXRXaWR0aCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UmVzaXplRWwoKS5nZXRXaWR0aCgpOwogICAgfSwKCiAgICAKICAgIGdldEhlaWdodCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UmVzaXplRWwoKS5nZXRIZWlnaHQoKTsKICAgIH0sCgogICAgCiAgICBnZXRPdXRlclNpemUgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBlbCA9IHRoaXMuZ2V0UmVzaXplRWwoKTsKICAgICAgICByZXR1cm4ge3dpZHRoOiBlbC5nZXRXaWR0aCgpICsgZWwuZ2V0TWFyZ2lucygnbHInKSwKICAgICAgICAgICAgICAgIGhlaWdodDogZWwuZ2V0SGVpZ2h0KCkgKyBlbC5nZXRNYXJnaW5zKCd0YicpfTsKICAgIH0sCgogICAgCiAgICBnZXRQb3NpdGlvbiA6IGZ1bmN0aW9uKGxvY2FsKXsKICAgICAgICB2YXIgZWwgPSB0aGlzLmdldFBvc2l0aW9uRWwoKTsKICAgICAgICBpZihsb2NhbCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHJldHVybiBbZWwuZ2V0TGVmdCh0cnVlKSwgZWwuZ2V0VG9wKHRydWUpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMueHkgfHwgZWwuZ2V0WFkoKTsKICAgIH0sCgogICAgCiAgICBnZXRCb3ggOiBmdW5jdGlvbihsb2NhbCl7CiAgICAgICAgdmFyIHBvcyA9IHRoaXMuZ2V0UG9zaXRpb24obG9jYWwpOwogICAgICAgIHZhciBzID0gdGhpcy5nZXRTaXplKCk7CiAgICAgICAgcy54ID0gcG9zWzBdOwogICAgICAgIHMueSA9IHBvc1sxXTsKICAgICAgICByZXR1cm4gczsKICAgIH0sCgogICAgCiAgICB1cGRhdGVCb3ggOiBmdW5jdGlvbihib3gpewogICAgICAgIHRoaXMuc2V0U2l6ZShib3gud2lkdGgsIGJveC5oZWlnaHQpOwogICAgICAgIHRoaXMuc2V0UGFnZVBvc2l0aW9uKGJveC54LCBib3gueSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZ2V0UmVzaXplRWwgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnJlc2l6ZUVsIHx8IHRoaXMuZWw7CiAgICB9LAoKICAgIAogICAgc2V0QXV0b1Njcm9sbCA6IGZ1bmN0aW9uKHNjcm9sbCl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuZ2V0Q29udGVudFRhcmdldCgpLnNldE92ZXJmbG93KHNjcm9sbCA/ICdhdXRvJyA6ICcnKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hdXRvU2Nyb2xsID0gc2Nyb2xsOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHNldFBvc2l0aW9uIDogZnVuY3Rpb24oeCwgeSl7CiAgICAgICAgaWYoeCAmJiB0eXBlb2YgeFsxXSA9PSAnbnVtYmVyJyl7CiAgICAgICAgICAgIHkgPSB4WzFdOwogICAgICAgICAgICB4ID0geFswXTsKICAgICAgICB9CiAgICAgICAgdGhpcy54ID0geDsKICAgICAgICB0aGlzLnkgPSB5OwogICAgICAgIGlmKCF0aGlzLmJveFJlYWR5KXsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICAgIHZhciBhZGogPSB0aGlzLmFkanVzdFBvc2l0aW9uKHgsIHkpOwogICAgICAgIHZhciBheCA9IGFkai54LCBheSA9IGFkai55OwoKICAgICAgICB2YXIgZWwgPSB0aGlzLmdldFBvc2l0aW9uRWwoKTsKICAgICAgICBpZihheCAhPT0gdW5kZWZpbmVkIHx8IGF5ICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICBpZihheCAhPT0gdW5kZWZpbmVkICYmIGF5ICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgZWwuc2V0TGVmdFRvcChheCwgYXkpOwogICAgICAgICAgICB9ZWxzZSBpZihheCAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIGVsLnNldExlZnQoYXgpOwogICAgICAgICAgICB9ZWxzZSBpZihheSAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIGVsLnNldFRvcChheSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vblBvc2l0aW9uKGF4LCBheSk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdtb3ZlJywgdGhpcywgYXgsIGF5KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgc2V0UGFnZVBvc2l0aW9uIDogZnVuY3Rpb24oeCwgeSl7CiAgICAgICAgaWYoeCAmJiB0eXBlb2YgeFsxXSA9PSAnbnVtYmVyJyl7CiAgICAgICAgICAgIHkgPSB4WzFdOwogICAgICAgICAgICB4ID0geFswXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5wYWdlWCA9IHg7CiAgICAgICAgdGhpcy5wYWdlWSA9IHk7CiAgICAgICAgaWYoIXRoaXMuYm94UmVhZHkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKHggPT09IHVuZGVmaW5lZCB8fCB5ID09PSB1bmRlZmluZWQpeyAKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgcCA9IHRoaXMuZ2V0UG9zaXRpb25FbCgpLnRyYW5zbGF0ZVBvaW50cyh4LCB5KTsKICAgICAgICB0aGlzLnNldFBvc2l0aW9uKHAubGVmdCwgcC50b3ApOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGFmdGVyUmVuZGVyIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuQm94Q29tcG9uZW50LnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLnJlc2l6ZUVsKXsKICAgICAgICAgICAgdGhpcy5yZXNpemVFbCA9IEV4dC5nZXQodGhpcy5yZXNpemVFbCk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMucG9zaXRpb25FbCl7CiAgICAgICAgICAgIHRoaXMucG9zaXRpb25FbCA9IEV4dC5nZXQodGhpcy5wb3NpdGlvbkVsKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5ib3hSZWFkeSA9IHRydWU7CiAgICAgICAgRXh0LmlzRGVmaW5lZCh0aGlzLmF1dG9TY3JvbGwpICYmIHRoaXMuc2V0QXV0b1Njcm9sbCh0aGlzLmF1dG9TY3JvbGwpOwogICAgICAgIHRoaXMuc2V0U2l6ZSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CiAgICAgICAgaWYodGhpcy54IHx8IHRoaXMueSl7CiAgICAgICAgICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy54LCB0aGlzLnkpOwogICAgICAgIH1lbHNlIGlmKHRoaXMucGFnZVggfHwgdGhpcy5wYWdlWSl7CiAgICAgICAgICAgIHRoaXMuc2V0UGFnZVBvc2l0aW9uKHRoaXMucGFnZVgsIHRoaXMucGFnZVkpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzeW5jU2l6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgZGVsZXRlIHRoaXMubGFzdFNpemU7CiAgICAgICAgdGhpcy5zZXRTaXplKHRoaXMuYXV0b1dpZHRoID8gdW5kZWZpbmVkIDogdGhpcy5nZXRSZXNpemVFbCgpLmdldFdpZHRoKCksIHRoaXMuYXV0b0hlaWdodCA/IHVuZGVmaW5lZCA6IHRoaXMuZ2V0UmVzaXplRWwoKS5nZXRIZWlnaHQoKSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgb25SZXNpemUgOiBmdW5jdGlvbihhZGpXaWR0aCwgYWRqSGVpZ2h0LCByYXdXaWR0aCwgcmF3SGVpZ2h0KXsKICAgIH0sCgogICAgCiAgICBvblBvc2l0aW9uIDogZnVuY3Rpb24oeCwgeSl7CgogICAgfSwKCiAgICAKICAgIGFkanVzdFNpemUgOiBmdW5jdGlvbih3LCBoKXsKICAgICAgICBpZih0aGlzLmF1dG9XaWR0aCl7CiAgICAgICAgICAgIHcgPSAnYXV0byc7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuYXV0b0hlaWdodCl7CiAgICAgICAgICAgIGggPSAnYXV0byc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7d2lkdGggOiB3LCBoZWlnaHQ6IGh9OwogICAgfSwKCiAgICAKICAgIGFkanVzdFBvc2l0aW9uIDogZnVuY3Rpb24oeCwgeSl7CiAgICAgICAgcmV0dXJuIHt4IDogeCwgeTogeX07CiAgICB9Cn0pOwpFeHQucmVnKCdib3gnLCBFeHQuQm94Q29tcG9uZW50KTsKCgoKRXh0LlNwYWNlciA9IEV4dC5leHRlbmQoRXh0LkJveENvbXBvbmVudCwgewogICAgYXV0b0VsOidkaXYnCn0pOwpFeHQucmVnKCdzcGFjZXInLCBFeHQuU3BhY2VyKTsKRXh0LlNwbGl0QmFyID0gZnVuY3Rpb24oZHJhZ0VsZW1lbnQsIHJlc2l6aW5nRWxlbWVudCwgb3JpZW50YXRpb24sIHBsYWNlbWVudCwgZXhpc3RpbmdQcm94eSl7CgogICAgCiAgICB0aGlzLmVsID0gRXh0LmdldChkcmFnRWxlbWVudCwgdHJ1ZSk7CiAgICB0aGlzLmVsLmRvbS51bnNlbGVjdGFibGUgPSAib24iOwogICAgCiAgICB0aGlzLnJlc2l6aW5nRWwgPSBFeHQuZ2V0KHJlc2l6aW5nRWxlbWVudCwgdHJ1ZSk7CgogICAgCiAgICB0aGlzLm9yaWVudGF0aW9uID0gb3JpZW50YXRpb24gfHwgRXh0LlNwbGl0QmFyLkhPUklaT05UQUw7CgogICAgCiAgICAKICAgIHRoaXMubWluU2l6ZSA9IDA7CgogICAgCiAgICB0aGlzLm1heFNpemUgPSAyMDAwOwoKICAgIAogICAgdGhpcy5hbmltYXRlID0gZmFsc2U7CgogICAgCiAgICB0aGlzLnVzZVNoaW0gPSBmYWxzZTsKCiAgICAKICAgIHRoaXMuc2hpbSA9IG51bGw7CgogICAgaWYoIWV4aXN0aW5nUHJveHkpewogICAgICAgIAogICAgICAgIHRoaXMucHJveHkgPSBFeHQuU3BsaXRCYXIuY3JlYXRlUHJveHkodGhpcy5vcmllbnRhdGlvbik7CiAgICB9ZWxzZXsKICAgICAgICB0aGlzLnByb3h5ID0gRXh0LmdldChleGlzdGluZ1Byb3h5KS5kb207CiAgICB9CiAgICAKICAgIHRoaXMuZGQgPSBuZXcgRXh0LmRkLkREUHJveHkodGhpcy5lbC5kb20uaWQsICJYU3BsaXRCYXJzIiwge2RyYWdFbElkIDogdGhpcy5wcm94eS5pZH0pOwoKICAgIAogICAgdGhpcy5kZC5iNFN0YXJ0RHJhZyA9IHRoaXMub25TdGFydFByb3h5RHJhZy5jcmVhdGVEZWxlZ2F0ZSh0aGlzKTsKCiAgICAKICAgIHRoaXMuZGQuZW5kRHJhZyA9IHRoaXMub25FbmRQcm94eURyYWcuY3JlYXRlRGVsZWdhdGUodGhpcyk7CgogICAgCiAgICB0aGlzLmRyYWdTcGVjcyA9IHt9OwoKICAgIAogICAgdGhpcy5hZGFwdGVyID0gbmV3IEV4dC5TcGxpdEJhci5CYXNpY0xheW91dEFkYXB0ZXIoKTsKICAgIHRoaXMuYWRhcHRlci5pbml0KHRoaXMpOwoKICAgIGlmKHRoaXMub3JpZW50YXRpb24gPT0gRXh0LlNwbGl0QmFyLkhPUklaT05UQUwpewogICAgICAgIAogICAgICAgIHRoaXMucGxhY2VtZW50ID0gcGxhY2VtZW50IHx8ICh0aGlzLmVsLmdldFgoKSA+IHRoaXMucmVzaXppbmdFbC5nZXRYKCkgPyBFeHQuU3BsaXRCYXIuTEVGVCA6IEV4dC5TcGxpdEJhci5SSUdIVCk7CiAgICAgICAgdGhpcy5lbC5hZGRDbGFzcygieC1zcGxpdGJhci1oIik7CiAgICB9ZWxzZXsKICAgICAgICAKICAgICAgICB0aGlzLnBsYWNlbWVudCA9IHBsYWNlbWVudCB8fCAodGhpcy5lbC5nZXRZKCkgPiB0aGlzLnJlc2l6aW5nRWwuZ2V0WSgpID8gRXh0LlNwbGl0QmFyLlRPUCA6IEV4dC5TcGxpdEJhci5CT1RUT00pOwogICAgICAgIHRoaXMuZWwuYWRkQ2xhc3MoIngtc3BsaXRiYXItdiIpOwogICAgfQoKICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgIAogICAgICAgICJyZXNpemUiLAogICAgICAgIAogICAgICAgICJtb3ZlZCIsCiAgICAgICAgCiAgICAgICAgImJlZm9yZXJlc2l6ZSIsCgogICAgICAgICJiZWZvcmVhcHBseSIKICAgICk7CgogICAgRXh0LlNwbGl0QmFyLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsKfTsKCkV4dC5leHRlbmQoRXh0LlNwbGl0QmFyLCBFeHQudXRpbC5PYnNlcnZhYmxlLCB7CiAgICBvblN0YXJ0UHJveHlEcmFnIDogZnVuY3Rpb24oeCwgeSl7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoImJlZm9yZXJlc2l6ZSIsIHRoaXMpOwogICAgICAgIHRoaXMub3ZlcmxheSA9ICBFeHQuRG9tSGVscGVyLmFwcGVuZChkb2N1bWVudC5ib2R5LCAge2NsczogIngtZHJhZy1vdmVybGF5IiwgaHRtbDogIiYjMTYwOyJ9LCB0cnVlKTsKICAgICAgICB0aGlzLm92ZXJsYXkudW5zZWxlY3RhYmxlKCk7CiAgICAgICAgdGhpcy5vdmVybGF5LnNldFNpemUoRXh0LmxpYi5Eb20uZ2V0Vmlld1dpZHRoKHRydWUpLCBFeHQubGliLkRvbS5nZXRWaWV3SGVpZ2h0KHRydWUpKTsKICAgICAgICB0aGlzLm92ZXJsYXkuc2hvdygpOwogICAgICAgIEV4dC5nZXQodGhpcy5wcm94eSkuc2V0RGlzcGxheWVkKCJibG9jayIpOwogICAgICAgIHZhciBzaXplID0gdGhpcy5hZGFwdGVyLmdldEVsZW1lbnRTaXplKHRoaXMpOwogICAgICAgIHRoaXMuYWN0aXZlTWluU2l6ZSA9IHRoaXMuZ2V0TWluaW11bVNpemUoKTsKICAgICAgICB0aGlzLmFjdGl2ZU1heFNpemUgPSB0aGlzLmdldE1heGltdW1TaXplKCk7CiAgICAgICAgdmFyIGMxID0gc2l6ZSAtIHRoaXMuYWN0aXZlTWluU2l6ZTsKICAgICAgICB2YXIgYzIgPSBNYXRoLm1heCh0aGlzLmFjdGl2ZU1heFNpemUgLSBzaXplLCAwKTsKICAgICAgICBpZih0aGlzLm9yaWVudGF0aW9uID09IEV4dC5TcGxpdEJhci5IT1JJWk9OVEFMKXsKICAgICAgICAgICAgdGhpcy5kZC5yZXNldENvbnN0cmFpbnRzKCk7CiAgICAgICAgICAgIHRoaXMuZGQuc2V0WENvbnN0cmFpbnQoCiAgICAgICAgICAgICAgICB0aGlzLnBsYWNlbWVudCA9PSBFeHQuU3BsaXRCYXIuTEVGVCA/IGMxIDogYzIsCiAgICAgICAgICAgICAgICB0aGlzLnBsYWNlbWVudCA9PSBFeHQuU3BsaXRCYXIuTEVGVCA/IGMyIDogYzEsCiAgICAgICAgICAgICAgICB0aGlzLnRpY2tTaXplCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHRoaXMuZGQuc2V0WUNvbnN0cmFpbnQoMCwgMCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuZGQucmVzZXRDb25zdHJhaW50cygpOwogICAgICAgICAgICB0aGlzLmRkLnNldFhDb25zdHJhaW50KDAsIDApOwogICAgICAgICAgICB0aGlzLmRkLnNldFlDb25zdHJhaW50KAogICAgICAgICAgICAgICAgdGhpcy5wbGFjZW1lbnQgPT0gRXh0LlNwbGl0QmFyLlRPUCA/IGMxIDogYzIsCiAgICAgICAgICAgICAgICB0aGlzLnBsYWNlbWVudCA9PSBFeHQuU3BsaXRCYXIuVE9QID8gYzIgOiBjMSwKICAgICAgICAgICAgICAgIHRoaXMudGlja1NpemUKICAgICAgICAgICAgKTsKICAgICAgICAgfQogICAgICAgIHRoaXMuZHJhZ1NwZWNzLnN0YXJ0U2l6ZSA9IHNpemU7CiAgICAgICAgdGhpcy5kcmFnU3BlY3Muc3RhcnRQb2ludCA9IFt4LCB5XTsKICAgICAgICBFeHQuZGQuRERQcm94eS5wcm90b3R5cGUuYjRTdGFydERyYWcuY2FsbCh0aGlzLmRkLCB4LCB5KTsKICAgIH0sCgogICAgCiAgICBvbkVuZFByb3h5RHJhZyA6IGZ1bmN0aW9uKGUpewogICAgICAgIEV4dC5nZXQodGhpcy5wcm94eSkuc2V0RGlzcGxheWVkKGZhbHNlKTsKICAgICAgICB2YXIgZW5kUG9pbnQgPSBFeHQubGliLkV2ZW50LmdldFhZKGUpOwogICAgICAgIGlmKHRoaXMub3ZlcmxheSl7CiAgICAgICAgICAgIEV4dC5kZXN0cm95KHRoaXMub3ZlcmxheSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm92ZXJsYXk7CiAgICAgICAgfQogICAgICAgIHZhciBuZXdTaXplOwogICAgICAgIGlmKHRoaXMub3JpZW50YXRpb24gPT0gRXh0LlNwbGl0QmFyLkhPUklaT05UQUwpewogICAgICAgICAgICBuZXdTaXplID0gdGhpcy5kcmFnU3BlY3Muc3RhcnRTaXplICsKICAgICAgICAgICAgICAgICh0aGlzLnBsYWNlbWVudCA9PSBFeHQuU3BsaXRCYXIuTEVGVCA/CiAgICAgICAgICAgICAgICAgICAgZW5kUG9pbnRbMF0gLSB0aGlzLmRyYWdTcGVjcy5zdGFydFBvaW50WzBdIDoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyYWdTcGVjcy5zdGFydFBvaW50WzBdIC0gZW5kUG9pbnRbMF0KICAgICAgICAgICAgICAgICk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIG5ld1NpemUgPSB0aGlzLmRyYWdTcGVjcy5zdGFydFNpemUgKwogICAgICAgICAgICAgICAgKHRoaXMucGxhY2VtZW50ID09IEV4dC5TcGxpdEJhci5UT1AgPwogICAgICAgICAgICAgICAgICAgIGVuZFBvaW50WzFdIC0gdGhpcy5kcmFnU3BlY3Muc3RhcnRQb2ludFsxXSA6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcmFnU3BlY3Muc3RhcnRQb2ludFsxXSAtIGVuZFBvaW50WzFdCiAgICAgICAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBuZXdTaXplID0gTWF0aC5taW4oTWF0aC5tYXgobmV3U2l6ZSwgdGhpcy5hY3RpdmVNaW5TaXplKSwgdGhpcy5hY3RpdmVNYXhTaXplKTsKICAgICAgICBpZihuZXdTaXplICE9IHRoaXMuZHJhZ1NwZWNzLnN0YXJ0U2l6ZSl7CiAgICAgICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVhcHBseScsIHRoaXMsIG5ld1NpemUpICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICB0aGlzLmFkYXB0ZXIuc2V0RWxlbWVudFNpemUodGhpcywgbmV3U2l6ZSk7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgibW92ZWQiLCB0aGlzLCBuZXdTaXplKTsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJyZXNpemUiLCB0aGlzLCBuZXdTaXplKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRBZGFwdGVyIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5hZGFwdGVyOwogICAgfSwKCiAgICAKICAgIHNldEFkYXB0ZXIgOiBmdW5jdGlvbihhZGFwdGVyKXsKICAgICAgICB0aGlzLmFkYXB0ZXIgPSBhZGFwdGVyOwogICAgICAgIHRoaXMuYWRhcHRlci5pbml0KHRoaXMpOwogICAgfSwKCiAgICAKICAgIGdldE1pbmltdW1TaXplIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5taW5TaXplOwogICAgfSwKCiAgICAKICAgIHNldE1pbmltdW1TaXplIDogZnVuY3Rpb24obWluU2l6ZSl7CiAgICAgICAgdGhpcy5taW5TaXplID0gbWluU2l6ZTsKICAgIH0sCgogICAgCiAgICBnZXRNYXhpbXVtU2l6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMubWF4U2l6ZTsKICAgIH0sCgogICAgCiAgICBzZXRNYXhpbXVtU2l6ZSA6IGZ1bmN0aW9uKG1heFNpemUpewogICAgICAgIHRoaXMubWF4U2l6ZSA9IG1heFNpemU7CiAgICB9LAoKICAgIAogICAgc2V0Q3VycmVudFNpemUgOiBmdW5jdGlvbihzaXplKXsKICAgICAgICB2YXIgb2xkQW5pbWF0ZSA9IHRoaXMuYW5pbWF0ZTsKICAgICAgICB0aGlzLmFuaW1hdGUgPSBmYWxzZTsKICAgICAgICB0aGlzLmFkYXB0ZXIuc2V0RWxlbWVudFNpemUodGhpcywgc2l6ZSk7CiAgICAgICAgdGhpcy5hbmltYXRlID0gb2xkQW5pbWF0ZTsKICAgIH0sCgogICAgCiAgICBkZXN0cm95IDogZnVuY3Rpb24ocmVtb3ZlRWwpewogICAgICAgIEV4dC5kZXN0cm95KHRoaXMuc2hpbSwgRXh0LmdldCh0aGlzLnByb3h5KSk7CiAgICAgICAgdGhpcy5kZC51bnJlZygpOwogICAgICAgIGlmKHJlbW92ZUVsKXsKICAgICAgICAgICAgdGhpcy5lbC5yZW1vdmUoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5wdXJnZUxpc3RlbmVycygpOwogICAgfQp9KTsKCgpFeHQuU3BsaXRCYXIuY3JlYXRlUHJveHkgPSBmdW5jdGlvbihkaXIpewogICAgdmFyIHByb3h5ID0gbmV3IEV4dC5FbGVtZW50KGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocHJveHkuZG9tKTsKICAgIHByb3h5LnVuc2VsZWN0YWJsZSgpOwogICAgdmFyIGNscyA9ICd4LXNwbGl0YmFyLXByb3h5JzsKICAgIHByb3h5LmFkZENsYXNzKGNscyArICcgJyArIChkaXIgPT0gRXh0LlNwbGl0QmFyLkhPUklaT05UQUwgPyBjbHMgKyctaCcgOiBjbHMgKyAnLXYnKSk7CiAgICByZXR1cm4gcHJveHkuZG9tOwp9OwoKCkV4dC5TcGxpdEJhci5CYXNpY0xheW91dEFkYXB0ZXIgPSBmdW5jdGlvbigpewp9OwoKRXh0LlNwbGl0QmFyLkJhc2ljTGF5b3V0QWRhcHRlci5wcm90b3R5cGUgPSB7CiAgICAKICAgIGluaXQgOiBmdW5jdGlvbihzKXsKCiAgICB9LAogICAgCiAgICAgZ2V0RWxlbWVudFNpemUgOiBmdW5jdGlvbihzKXsKICAgICAgICBpZihzLm9yaWVudGF0aW9uID09IEV4dC5TcGxpdEJhci5IT1JJWk9OVEFMKXsKICAgICAgICAgICAgcmV0dXJuIHMucmVzaXppbmdFbC5nZXRXaWR0aCgpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICByZXR1cm4gcy5yZXNpemluZ0VsLmdldEhlaWdodCgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRFbGVtZW50U2l6ZSA6IGZ1bmN0aW9uKHMsIG5ld1NpemUsIG9uQ29tcGxldGUpewogICAgICAgIGlmKHMub3JpZW50YXRpb24gPT0gRXh0LlNwbGl0QmFyLkhPUklaT05UQUwpewogICAgICAgICAgICBpZighcy5hbmltYXRlKXsKICAgICAgICAgICAgICAgIHMucmVzaXppbmdFbC5zZXRXaWR0aChuZXdTaXplKTsKICAgICAgICAgICAgICAgIGlmKG9uQ29tcGxldGUpewogICAgICAgICAgICAgICAgICAgIG9uQ29tcGxldGUocywgbmV3U2l6ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgcy5yZXNpemluZ0VsLnNldFdpZHRoKG5ld1NpemUsIHRydWUsIC4xLCBvbkNvbXBsZXRlLCAnZWFzZU91dCcpOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CgogICAgICAgICAgICBpZighcy5hbmltYXRlKXsKICAgICAgICAgICAgICAgIHMucmVzaXppbmdFbC5zZXRIZWlnaHQobmV3U2l6ZSk7CiAgICAgICAgICAgICAgICBpZihvbkNvbXBsZXRlKXsKICAgICAgICAgICAgICAgICAgICBvbkNvbXBsZXRlKHMsIG5ld1NpemUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHMucmVzaXppbmdFbC5zZXRIZWlnaHQobmV3U2l6ZSwgdHJ1ZSwgLjEsIG9uQ29tcGxldGUsICdlYXNlT3V0Jyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07CgoKRXh0LlNwbGl0QmFyLkFic29sdXRlTGF5b3V0QWRhcHRlciA9IGZ1bmN0aW9uKGNvbnRhaW5lcil7CiAgICB0aGlzLmJhc2ljID0gbmV3IEV4dC5TcGxpdEJhci5CYXNpY0xheW91dEFkYXB0ZXIoKTsKICAgIHRoaXMuY29udGFpbmVyID0gRXh0LmdldChjb250YWluZXIpOwp9OwoKRXh0LlNwbGl0QmFyLkFic29sdXRlTGF5b3V0QWRhcHRlci5wcm90b3R5cGUgPSB7CiAgICBpbml0IDogZnVuY3Rpb24ocyl7CiAgICAgICAgdGhpcy5iYXNpYy5pbml0KHMpOwogICAgfSwKCiAgICBnZXRFbGVtZW50U2l6ZSA6IGZ1bmN0aW9uKHMpewogICAgICAgIHJldHVybiB0aGlzLmJhc2ljLmdldEVsZW1lbnRTaXplKHMpOwogICAgfSwKCiAgICBzZXRFbGVtZW50U2l6ZSA6IGZ1bmN0aW9uKHMsIG5ld1NpemUsIG9uQ29tcGxldGUpewogICAgICAgIHRoaXMuYmFzaWMuc2V0RWxlbWVudFNpemUocywgbmV3U2l6ZSwgdGhpcy5tb3ZlU3BsaXR0ZXIuY3JlYXRlRGVsZWdhdGUodGhpcywgW3NdKSk7CiAgICB9LAoKICAgIG1vdmVTcGxpdHRlciA6IGZ1bmN0aW9uKHMpewogICAgICAgIHZhciB5ZXMgPSBFeHQuU3BsaXRCYXI7CiAgICAgICAgc3dpdGNoKHMucGxhY2VtZW50KXsKICAgICAgICAgICAgY2FzZSB5ZXMuTEVGVDoKICAgICAgICAgICAgICAgIHMuZWwuc2V0WChzLnJlc2l6aW5nRWwuZ2V0UmlnaHQoKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSB5ZXMuUklHSFQ6CiAgICAgICAgICAgICAgICBzLmVsLnNldFN0eWxlKCJyaWdodCIsICh0aGlzLmNvbnRhaW5lci5nZXRXaWR0aCgpIC0gcy5yZXNpemluZ0VsLmdldExlZnQoKSkgKyAicHgiKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIHllcy5UT1A6CiAgICAgICAgICAgICAgICBzLmVsLnNldFkocy5yZXNpemluZ0VsLmdldEJvdHRvbSgpKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIHllcy5CT1RUT006CiAgICAgICAgICAgICAgICBzLmVsLnNldFkocy5yZXNpemluZ0VsLmdldFRvcCgpIC0gcy5lbC5nZXRIZWlnaHQoKSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9Cn07CgoKRXh0LlNwbGl0QmFyLlZFUlRJQ0FMID0gMTsKCgpFeHQuU3BsaXRCYXIuSE9SSVpPTlRBTCA9IDI7CgoKRXh0LlNwbGl0QmFyLkxFRlQgPSAxOwoKCkV4dC5TcGxpdEJhci5SSUdIVCA9IDI7CgoKRXh0LlNwbGl0QmFyLlRPUCA9IDM7CgoKRXh0LlNwbGl0QmFyLkJPVFRPTSA9IDQ7CgpFeHQuQ29udGFpbmVyID0gRXh0LmV4dGVuZChFeHQuQm94Q29tcG9uZW50LCB7CiAgICAKICAgIAogICAgCiAgICAKICAgIGJ1ZmZlclJlc2l6ZTogNTAsCgogICAgCiAgICAKICAgIAoKCiAgICAKICAgIGF1dG9EZXN0cm95IDogdHJ1ZSwKCiAgICAKICAgIGZvcmNlTGF5b3V0OiBmYWxzZSwKCiAgICAKICAgIAogICAgZGVmYXVsdFR5cGUgOiAncGFuZWwnLAoKICAgIAogICAgcmVzaXplRXZlbnQ6ICdyZXNpemUnLAoKICAgIAogICAgYnViYmxlRXZlbnRzOiBbJ2FkZCcsICdyZW1vdmUnXSwKCiAgICAKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5Db250YWluZXIuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CgogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2FmdGVybGF5b3V0JywKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVhZGQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZXJlbW92ZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYWRkJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdyZW1vdmUnCiAgICAgICAgKTsKCiAgICAgICAgCiAgICAgICAgdmFyIGl0ZW1zID0gdGhpcy5pdGVtczsKICAgICAgICBpZihpdGVtcyl7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLml0ZW1zOwogICAgICAgICAgICB0aGlzLmFkZChpdGVtcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGluaXRJdGVtcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMuaXRlbXMpewogICAgICAgICAgICB0aGlzLml0ZW1zID0gbmV3IEV4dC51dGlsLk1peGVkQ29sbGVjdGlvbihmYWxzZSwgdGhpcy5nZXRDb21wb25lbnRJZCk7CiAgICAgICAgICAgIHRoaXMuZ2V0TGF5b3V0KCk7IAogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRMYXlvdXQgOiBmdW5jdGlvbihsYXlvdXQpewogICAgICAgIGlmKHRoaXMubGF5b3V0ICYmIHRoaXMubGF5b3V0ICE9IGxheW91dCl7CiAgICAgICAgICAgIHRoaXMubGF5b3V0LnNldENvbnRhaW5lcihudWxsKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5sYXlvdXQgPSBsYXlvdXQ7CiAgICAgICAgdGhpcy5pbml0SXRlbXMoKTsKICAgICAgICBsYXlvdXQuc2V0Q29udGFpbmVyKHRoaXMpOwogICAgfSwKCiAgICBhZnRlclJlbmRlcjogZnVuY3Rpb24oKXsKICAgICAgICAKICAgICAgICAKICAgICAgICBFeHQuQ29udGFpbmVyLnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICBpZighdGhpcy5sYXlvdXQpewogICAgICAgICAgICB0aGlzLmxheW91dCA9ICdhdXRvJzsKICAgICAgICB9CiAgICAgICAgaWYoRXh0LmlzT2JqZWN0KHRoaXMubGF5b3V0KSAmJiAhdGhpcy5sYXlvdXQubGF5b3V0KXsKICAgICAgICAgICAgdGhpcy5sYXlvdXRDb25maWcgPSB0aGlzLmxheW91dDsKICAgICAgICAgICAgdGhpcy5sYXlvdXQgPSB0aGlzLmxheW91dENvbmZpZy50eXBlOwogICAgICAgIH0KICAgICAgICBpZihFeHQuaXNTdHJpbmcodGhpcy5sYXlvdXQpKXsKICAgICAgICAgICAgdGhpcy5sYXlvdXQgPSBuZXcgRXh0LkNvbnRhaW5lci5MQVlPVVRTW3RoaXMubGF5b3V0LnRvTG93ZXJDYXNlKCldKHRoaXMubGF5b3V0Q29uZmlnKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZXRMYXlvdXQodGhpcy5sYXlvdXQpOwoKICAgICAgICAKICAgICAgICBpZih0aGlzLmFjdGl2ZUl0ZW0gIT09IHVuZGVmaW5lZCAmJiB0aGlzLmxheW91dC5zZXRBY3RpdmVJdGVtKXsKICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmFjdGl2ZUl0ZW07CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFjdGl2ZUl0ZW07CiAgICAgICAgICAgIHRoaXMubGF5b3V0LnNldEFjdGl2ZUl0ZW0oaXRlbSk7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBpZighdGhpcy5vd25lckN0KXsKICAgICAgICAgICAgdGhpcy5kb0xheW91dChmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICAKICAgICAgICBpZih0aGlzLm1vbml0b3JSZXNpemUgPT09IHRydWUpewogICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLm9uV2luZG93UmVzaXplKHRoaXMuZG9MYXlvdXQsIHRoaXMsIFtmYWxzZV0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRMYXlvdXRUYXJnZXQgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmVsOwogICAgfSwKCiAgICAKICAgIGdldENvbXBvbmVudElkIDogZnVuY3Rpb24oY29tcCl7CiAgICAgICAgcmV0dXJuIGNvbXAuZ2V0SXRlbUlkKCk7CiAgICB9LAoKICAgIAogICAgYWRkIDogZnVuY3Rpb24oY29tcCl7CiAgICAgICAgdGhpcy5pbml0SXRlbXMoKTsKICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cy5sZW5ndGggPiAxOwogICAgICAgIGlmKGFyZ3MgfHwgRXh0LmlzQXJyYXkoY29tcCkpewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICAgIEV4dC5lYWNoKGFyZ3MgPyBhcmd1bWVudHMgOiBjb21wLCBmdW5jdGlvbihjKXsKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHRoaXMuYWRkKGMpKTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHZhciBjID0gdGhpcy5sb29rdXBDb21wb25lbnQodGhpcy5hcHBseURlZmF1bHRzKGNvbXApKTsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLml0ZW1zLmxlbmd0aDsKICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3JlYWRkJywgdGhpcywgYywgaW5kZXgpICE9PSBmYWxzZSAmJiB0aGlzLm9uQmVmb3JlQWRkKGMpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuaXRlbXMuYWRkKGMpOwogICAgICAgICAgICAKICAgICAgICAgICAgYy5vbkFkZGVkKHRoaXMsIGluZGV4KTsKICAgICAgICAgICAgdGhpcy5vbkFkZChjKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2FkZCcsIHRoaXMsIGMsIGluZGV4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGM7CiAgICB9LAoKICAgIG9uQWRkIDogZnVuY3Rpb24oYyl7CiAgICAgICAgCiAgICB9LAoKICAgIAogICAgb25BZGRlZCA6IGZ1bmN0aW9uKGNvbnRhaW5lciwgcG9zKSB7CiAgICAgICAgCiAgICAgICAgdGhpcy5vd25lckN0ID0gY29udGFpbmVyOwogICAgICAgIHRoaXMuaW5pdFJlZigpOwogICAgICAgIAogICAgICAgIHRoaXMuY2FzY2FkZShmdW5jdGlvbihjKXsKICAgICAgICAgICAgYy5pbml0UmVmKCk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2FkZGVkJywgdGhpcywgY29udGFpbmVyLCBwb3MpOwogICAgfSwKCiAgICAKICAgIGluc2VydCA6IGZ1bmN0aW9uKGluZGV4LCBjb21wKSB7CiAgICAgICAgdmFyIGFyZ3MgICA9IGFyZ3VtZW50cywKICAgICAgICAgICAgbGVuZ3RoID0gYXJncy5sZW5ndGgsCiAgICAgICAgICAgIHJlc3VsdCA9IFtdLAogICAgICAgICAgICBpLCBjOwogICAgICAgIAogICAgICAgIHRoaXMuaW5pdEl0ZW1zKCk7CiAgICAgICAgCiAgICAgICAgaWYgKGxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgZm9yIChpID0gbGVuZ3RoIC0gMTsgaSA+PSAxOyAtLWkpIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHRoaXMuaW5zZXJ0KGluZGV4LCBhcmdzW2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYyA9IHRoaXMubG9va3VwQ29tcG9uZW50KHRoaXMuYXBwbHlEZWZhdWx0cyhjb21wKSk7CiAgICAgICAgaW5kZXggPSBNYXRoLm1pbihpbmRleCwgdGhpcy5pdGVtcy5sZW5ndGgpOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLmZpcmVFdmVudCgnYmVmb3JlYWRkJywgdGhpcywgYywgaW5kZXgpICE9PSBmYWxzZSAmJiB0aGlzLm9uQmVmb3JlQWRkKGMpICE9PSBmYWxzZSkgewogICAgICAgICAgICBpZiAoYy5vd25lckN0ID09IHRoaXMpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXRlbXMucmVtb3ZlKGMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaXRlbXMuaW5zZXJ0KGluZGV4LCBjKTsKICAgICAgICAgICAgYy5vbkFkZGVkKHRoaXMsIGluZGV4KTsKICAgICAgICAgICAgdGhpcy5vbkFkZChjKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2FkZCcsIHRoaXMsIGMsIGluZGV4KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIGM7CiAgICB9LAoKICAgIAogICAgYXBwbHlEZWZhdWx0cyA6IGZ1bmN0aW9uKGMpewogICAgICAgIHZhciBkID0gdGhpcy5kZWZhdWx0czsKICAgICAgICBpZihkKXsKICAgICAgICAgICAgaWYoRXh0LmlzRnVuY3Rpb24oZCkpewogICAgICAgICAgICAgICAgZCA9IGQuY2FsbCh0aGlzLCBjKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihFeHQuaXNTdHJpbmcoYykpewogICAgICAgICAgICAgICAgYyA9IEV4dC5Db21wb25lbnRNZ3IuZ2V0KGMpOwogICAgICAgICAgICAgICAgRXh0LmFwcGx5KGMsIGQpOwogICAgICAgICAgICB9ZWxzZSBpZighYy5ldmVudHMpewogICAgICAgICAgICAgICAgRXh0LmFwcGx5SWYoYy5pc0FjdGlvbiA/IGMuaW5pdGlhbENvbmZpZyA6IGMsIGQpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIEV4dC5hcHBseShjLCBkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYzsKICAgIH0sCgogICAgCiAgICBvbkJlZm9yZUFkZCA6IGZ1bmN0aW9uKGl0ZW0pewogICAgICAgIGlmKGl0ZW0ub3duZXJDdCl7CiAgICAgICAgICAgIGl0ZW0ub3duZXJDdC5yZW1vdmUoaXRlbSwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmhpZGVCb3JkZXJzID09PSB0cnVlKXsKICAgICAgICAgICAgaXRlbS5ib3JkZXIgPSAoaXRlbS5ib3JkZXIgPT09IHRydWUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZW1vdmUgOiBmdW5jdGlvbihjb21wLCBhdXRvRGVzdHJveSl7CiAgICAgICAgdGhpcy5pbml0SXRlbXMoKTsKICAgICAgICB2YXIgYyA9IHRoaXMuZ2V0Q29tcG9uZW50KGNvbXApOwogICAgICAgIGlmKGMgJiYgdGhpcy5maXJlRXZlbnQoJ2JlZm9yZXJlbW92ZScsIHRoaXMsIGMpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuZG9SZW1vdmUoYywgYXV0b0Rlc3Ryb3kpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgncmVtb3ZlJywgdGhpcywgYyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjOwogICAgfSwKCiAgICBvblJlbW92ZTogZnVuY3Rpb24oYyl7CiAgICAgICAgCiAgICB9LAoKICAgIAogICAgZG9SZW1vdmU6IGZ1bmN0aW9uKGMsIGF1dG9EZXN0cm95KXsKICAgICAgICB2YXIgbCA9IHRoaXMubGF5b3V0LAogICAgICAgICAgICBoYXNMYXlvdXQgPSBsICYmIHRoaXMucmVuZGVyZWQ7CgogICAgICAgIGlmKGhhc0xheW91dCl7CiAgICAgICAgICAgIGwub25SZW1vdmUoYyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaXRlbXMucmVtb3ZlKGMpOwogICAgICAgIGMub25SZW1vdmVkKCk7CiAgICAgICAgdGhpcy5vblJlbW92ZShjKTsKICAgICAgICBpZihhdXRvRGVzdHJveSA9PT0gdHJ1ZSB8fCAoYXV0b0Rlc3Ryb3kgIT09IGZhbHNlICYmIHRoaXMuYXV0b0Rlc3Ryb3kpKXsKICAgICAgICAgICAgYy5kZXN0cm95KCk7CiAgICAgICAgfQogICAgICAgIGlmKGhhc0xheW91dCl7CiAgICAgICAgICAgIGwuYWZ0ZXJSZW1vdmUoYyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHJlbW92ZUFsbDogZnVuY3Rpb24oYXV0b0Rlc3Ryb3kpewogICAgICAgIHRoaXMuaW5pdEl0ZW1zKCk7CiAgICAgICAgdmFyIGl0ZW0sIHJlbSA9IFtdLCBpdGVtcyA9IFtdOwogICAgICAgIHRoaXMuaXRlbXMuZWFjaChmdW5jdGlvbihpKXsKICAgICAgICAgICAgcmVtLnB1c2goaSk7CiAgICAgICAgfSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHJlbS5sZW5ndGg7IGkgPCBsZW47ICsraSl7CiAgICAgICAgICAgIGl0ZW0gPSByZW1baV07CiAgICAgICAgICAgIHRoaXMucmVtb3ZlKGl0ZW0sIGF1dG9EZXN0cm95KTsKICAgICAgICAgICAgaWYoaXRlbS5vd25lckN0ICE9PSB0aGlzKXsKICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2goaXRlbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGl0ZW1zOwogICAgfSwKCiAgICAKICAgIGdldENvbXBvbmVudCA6IGZ1bmN0aW9uKGNvbXApewogICAgICAgIGlmKEV4dC5pc09iamVjdChjb21wKSl7CiAgICAgICAgICAgIGNvbXAgPSBjb21wLmdldEl0ZW1JZCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5pdGVtcy5nZXQoY29tcCk7CiAgICB9LAoKICAgIAogICAgbG9va3VwQ29tcG9uZW50IDogZnVuY3Rpb24oY29tcCl7CiAgICAgICAgaWYoRXh0LmlzU3RyaW5nKGNvbXApKXsKICAgICAgICAgICAgcmV0dXJuIEV4dC5Db21wb25lbnRNZ3IuZ2V0KGNvbXApOwogICAgICAgIH1lbHNlIGlmKCFjb21wLmV2ZW50cyl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUNvbXBvbmVudChjb21wKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNvbXA7CiAgICB9LAoKICAgIAogICAgY3JlYXRlQ29tcG9uZW50IDogZnVuY3Rpb24oY29uZmlnLCBkZWZhdWx0VHlwZSl7CiAgICAgICAgaWYgKGNvbmZpZy5yZW5kZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbmZpZzsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdmFyIGMgPSBFeHQuY3JlYXRlKEV4dC5hcHBseSh7CiAgICAgICAgICAgIG93bmVyQ3Q6IHRoaXMKICAgICAgICB9LCBjb25maWcpLCBkZWZhdWx0VHlwZSB8fCB0aGlzLmRlZmF1bHRUeXBlKTsKICAgICAgICBkZWxldGUgYy5pbml0aWFsQ29uZmlnLm93bmVyQ3Q7CiAgICAgICAgZGVsZXRlIGMub3duZXJDdDsKICAgICAgICByZXR1cm4gYzsKICAgIH0sCgogICAgCiAgICBjYW5MYXlvdXQgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZWwgPSB0aGlzLmdldFZpc2liaWxpdHlFbCgpOwogICAgICAgIHJldHVybiBlbCAmJiBlbC5kb20gJiYgIWVsLmlzU3R5bGUoImRpc3BsYXkiLCAibm9uZSIpOwogICAgfSwKCiAgICAKCiAgICBkb0xheW91dCA6IGZ1bmN0aW9uKHNoYWxsb3csIGZvcmNlKXsKICAgICAgICB2YXIgcmVuZGVyZWQgPSB0aGlzLnJlbmRlcmVkLAogICAgICAgICAgICBmb3JjZUxheW91dCA9IGZvcmNlIHx8IHRoaXMuZm9yY2VMYXlvdXQ7CgogICAgICAgIGlmKHRoaXMuY29sbGFwc2VkIHx8ICF0aGlzLmNhbkxheW91dCgpKXsKICAgICAgICAgICAgdGhpcy5kZWZlckxheW91dCA9IHRoaXMuZGVmZXJMYXlvdXQgfHwgIXNoYWxsb3c7CiAgICAgICAgICAgIGlmKCFmb3JjZUxheW91dCl7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2hhbGxvdyA9IHNoYWxsb3cgJiYgIXRoaXMuZGVmZXJMYXlvdXQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuZGVmZXJMYXlvdXQ7CiAgICAgICAgfQogICAgICAgIGlmKHJlbmRlcmVkICYmIHRoaXMubGF5b3V0KXsKICAgICAgICAgICAgdGhpcy5sYXlvdXQubGF5b3V0KCk7CiAgICAgICAgfQogICAgICAgIGlmKHNoYWxsb3cgIT09IHRydWUgJiYgdGhpcy5pdGVtcyl7CiAgICAgICAgICAgIHZhciBjcyA9IHRoaXMuaXRlbXMuaXRlbXM7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGNzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIHZhciBjID0gY3NbaV07CiAgICAgICAgICAgICAgICBpZihjLmRvTGF5b3V0KXsKICAgICAgICAgICAgICAgICAgICBjLmRvTGF5b3V0KGZhbHNlLCBmb3JjZUxheW91dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYocmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLm9uTGF5b3V0KHNoYWxsb3csIGZvcmNlTGF5b3V0KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5oYXNMYXlvdXQgPSB0cnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLmZvcmNlTGF5b3V0OwogICAgfSwKCiAgICBvbkxheW91dCA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgc2hvdWxkQnVmZmVyTGF5b3V0OiBmdW5jdGlvbigpewogICAgICAgIAogICAgICAgIHZhciBobCA9IHRoaXMuaGFzTGF5b3V0OwogICAgICAgIGlmKHRoaXMub3duZXJDdCl7CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gaGwgPyAhdGhpcy5oYXNMYXlvdXRQZW5kaW5nKCkgOiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIGhsOwogICAgfSwKCiAgICAKICAgIGhhc0xheW91dFBlbmRpbmc6IGZ1bmN0aW9uKCl7CiAgICAgICAgCiAgICAgICAgdmFyIHBlbmRpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLm93bmVyQ3QuYnViYmxlKGZ1bmN0aW9uKGMpewogICAgICAgICAgICBpZihjLmxheW91dFBlbmRpbmcpewogICAgICAgICAgICAgICAgcGVuZGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcGVuZGluZzsKICAgIH0sCgogICAgb25TaG93IDogZnVuY3Rpb24oKXsKICAgICAgICAKICAgICAgICBFeHQuQ29udGFpbmVyLnN1cGVyY2xhc3Mub25TaG93LmNhbGwodGhpcyk7CiAgICAgICAgCiAgICAgICAgaWYoRXh0LmlzRGVmaW5lZCh0aGlzLmRlZmVyTGF5b3V0KSl7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmRlZmVyTGF5b3V0OwogICAgICAgICAgICB0aGlzLmRvTGF5b3V0KHRydWUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRMYXlvdXQgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLmxheW91dCl7CiAgICAgICAgICAgIHZhciBsYXlvdXQgPSBuZXcgRXh0LmxheW91dC5BdXRvTGF5b3V0KHRoaXMubGF5b3V0Q29uZmlnKTsKICAgICAgICAgICAgdGhpcy5zZXRMYXlvdXQobGF5b3V0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMubGF5b3V0OwogICAgfSwKCiAgICAKICAgIGJlZm9yZURlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBjOwogICAgICAgIGlmKHRoaXMuaXRlbXMpewogICAgICAgICAgICB3aGlsZShjID0gdGhpcy5pdGVtcy5maXJzdCgpKXsKICAgICAgICAgICAgICAgIHRoaXMuZG9SZW1vdmUoYywgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYodGhpcy5tb25pdG9yUmVzaXplKXsKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5yZW1vdmVSZXNpemVMaXN0ZW5lcih0aGlzLmRvTGF5b3V0LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy5sYXlvdXQpOwogICAgICAgIEV4dC5Db250YWluZXIuc3VwZXJjbGFzcy5iZWZvcmVEZXN0cm95LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgY2FzY2FkZSA6IGZ1bmN0aW9uKGZuLCBzY29wZSwgYXJncyl7CiAgICAgICAgaWYoZm4uYXBwbHkoc2NvcGUgfHwgdGhpcywgYXJncyB8fCBbdGhpc10pICE9PSBmYWxzZSl7CiAgICAgICAgICAgIGlmKHRoaXMuaXRlbXMpewogICAgICAgICAgICAgICAgdmFyIGNzID0gdGhpcy5pdGVtcy5pdGVtczsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGNzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBpZihjc1tpXS5jYXNjYWRlKXsKICAgICAgICAgICAgICAgICAgICAgICAgY3NbaV0uY2FzY2FkZShmbiwgc2NvcGUsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICBmbi5hcHBseShzY29wZSB8fCBjc1tpXSwgYXJncyB8fCBbY3NbaV1dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZmluZEJ5SWQgOiBmdW5jdGlvbihpZCl7CiAgICAgICAgdmFyIG0gPSBudWxsLCAKICAgICAgICAgICAgY3QgPSB0aGlzOwogICAgICAgIHRoaXMuY2FzY2FkZShmdW5jdGlvbihjKXsKICAgICAgICAgICAgaWYoY3QgIT0gYyAmJiBjLmlkID09PSBpZCl7CiAgICAgICAgICAgICAgICBtID0gYzsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBtOwogICAgfSwKCiAgICAKICAgIGZpbmRCeVR5cGUgOiBmdW5jdGlvbih4dHlwZSwgc2hhbGxvdyl7CiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5KGZ1bmN0aW9uKGMpewogICAgICAgICAgICByZXR1cm4gYy5pc1hUeXBlKHh0eXBlLCBzaGFsbG93KTsKICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICBmaW5kIDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewogICAgICAgIHJldHVybiB0aGlzLmZpbmRCeShmdW5jdGlvbihjKXsKICAgICAgICAgICAgcmV0dXJuIGNbcHJvcF0gPT09IHZhbHVlOwogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIGZpbmRCeSA6IGZ1bmN0aW9uKGZuLCBzY29wZSl7CiAgICAgICAgdmFyIG0gPSBbXSwgY3QgPSB0aGlzOwogICAgICAgIHRoaXMuY2FzY2FkZShmdW5jdGlvbihjKXsKICAgICAgICAgICAgaWYoY3QgIT0gYyAmJiBmbi5jYWxsKHNjb3BlIHx8IGMsIGMsIGN0KSA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICBtLnB1c2goYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbTsKICAgIH0sCgogICAgCiAgICBnZXQgOiBmdW5jdGlvbihrZXkpewogICAgICAgIHJldHVybiB0aGlzLmdldENvbXBvbmVudChrZXkpOwogICAgfQp9KTsKCkV4dC5Db250YWluZXIuTEFZT1VUUyA9IHt9OwpFeHQucmVnKCdjb250YWluZXInLCBFeHQuQ29udGFpbmVyKTsKCkV4dC5sYXlvdXQuQ29udGFpbmVyTGF5b3V0ID0gRXh0LmV4dGVuZChPYmplY3QsIHsKICAgIAogICAgCgogICAgCgogICAgCiAgICBtb25pdG9yUmVzaXplOmZhbHNlLAogICAgCiAgICBhY3RpdmVJdGVtIDogbnVsbCwKCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGNvbmZpZyl7CiAgICAgICAgdGhpcy5pZCA9IEV4dC5pZChudWxsLCAnZXh0LWxheW91dC0nKTsKICAgICAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKICAgIH0sCgogICAgdHlwZTogJ2NvbnRhaW5lcicsCgogICAgCiAgICBJRU1lYXN1cmVIYWNrIDogZnVuY3Rpb24odGFyZ2V0LCB2aWV3RmxhZykgewogICAgICAgIHZhciB0Q2hpbGRyZW4gPSB0YXJnZXQuZG9tLmNoaWxkTm9kZXMsIHRMZW4gPSB0Q2hpbGRyZW4ubGVuZ3RoLCBjLCBkID0gW10sIGUsIGksIHJldDsKICAgICAgICBmb3IgKGkgPSAwIDsgaSA8IHRMZW4gOyBpKyspIHsKICAgICAgICAgICAgYyA9IHRDaGlsZHJlbltpXTsKICAgICAgICAgICAgZSA9IEV4dC5nZXQoYyk7CiAgICAgICAgICAgIGlmIChlKSB7CiAgICAgICAgICAgICAgICBkW2ldID0gZS5nZXRTdHlsZSgnZGlzcGxheScpOwogICAgICAgICAgICAgICAgZS5zZXRTdHlsZSh7ZGlzcGxheTogJ25vbmUnfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0ID0gdGFyZ2V0ID8gdGFyZ2V0LmdldFZpZXdTaXplKHZpZXdGbGFnKSA6IHt9OwogICAgICAgIGZvciAoaSA9IDAgOyBpIDwgdExlbiA7IGkrKykgewogICAgICAgICAgICBjID0gdENoaWxkcmVuW2ldOwogICAgICAgICAgICBlID0gRXh0LmdldChjKTsKICAgICAgICAgICAgaWYgKGUpIHsKICAgICAgICAgICAgICAgIGUuc2V0U3R5bGUoe2Rpc3BsYXk6IGRbaV19KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfSwKCiAgICAKICAgIGdldExheW91dFRhcmdldFNpemUgOiBFeHQuRW1wdHlGbiwKCiAgICAKICAgIGxheW91dCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGN0ID0gdGhpcy5jb250YWluZXIsIHRhcmdldCA9IGN0LmdldExheW91dFRhcmdldCgpOwogICAgICAgIGlmKCEodGhpcy5oYXNMYXlvdXQgfHwgRXh0LmlzRW1wdHkodGhpcy50YXJnZXRDbHMpKSl7CiAgICAgICAgICAgIHRhcmdldC5hZGRDbGFzcyh0aGlzLnRhcmdldENscyk7CiAgICAgICAgfQogICAgICAgIHRoaXMub25MYXlvdXQoY3QsIHRhcmdldCk7CiAgICAgICAgY3QuZmlyZUV2ZW50KCdhZnRlcmxheW91dCcsIGN0LCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBvbkxheW91dCA6IGZ1bmN0aW9uKGN0LCB0YXJnZXQpewogICAgICAgIHRoaXMucmVuZGVyQWxsKGN0LCB0YXJnZXQpOwogICAgfSwKCiAgICAKICAgIGlzVmFsaWRQYXJlbnQgOiBmdW5jdGlvbihjLCB0YXJnZXQpewogICAgICAgIHJldHVybiB0YXJnZXQgJiYgYy5nZXRQb3NpdGlvbkVsKCkuZG9tLnBhcmVudE5vZGUgPT0gKHRhcmdldC5kb20gfHwgdGFyZ2V0KTsKICAgIH0sCgogICAgCiAgICByZW5kZXJBbGwgOiBmdW5jdGlvbihjdCwgdGFyZ2V0KXsKICAgICAgICB2YXIgaXRlbXMgPSBjdC5pdGVtcy5pdGVtcywgaSwgYywgbGVuID0gaXRlbXMubGVuZ3RoOwogICAgICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGMgPSBpdGVtc1tpXTsKICAgICAgICAgICAgaWYoYyAmJiAoIWMucmVuZGVyZWQgfHwgIXRoaXMuaXNWYWxpZFBhcmVudChjLCB0YXJnZXQpKSl7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckl0ZW0oYywgaSwgdGFyZ2V0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZW5kZXJJdGVtIDogZnVuY3Rpb24oYywgcG9zaXRpb24sIHRhcmdldCl7CiAgICAgICAgaWYgKGMpIHsKICAgICAgICAgICAgaWYgKCFjLnJlbmRlcmVkKSB7CiAgICAgICAgICAgICAgICBjLnJlbmRlcih0YXJnZXQsIHBvc2l0aW9uKTsKICAgICAgICAgICAgICAgIHRoaXMuY29uZmlndXJlSXRlbShjKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5pc1ZhbGlkUGFyZW50KGMsIHRhcmdldCkpIHsKICAgICAgICAgICAgICAgIGlmIChFeHQuaXNOdW1iZXIocG9zaXRpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gPSB0YXJnZXQuZG9tLmNoaWxkTm9kZXNbcG9zaXRpb25dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0YXJnZXQuZG9tLmluc2VydEJlZm9yZShjLmdldFBvc2l0aW9uRWwoKS5kb20sIHBvc2l0aW9uIHx8IG51bGwpOwogICAgICAgICAgICAgICAgYy5jb250YWluZXIgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ3VyZUl0ZW0oYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgCiAgICBnZXRSZW5kZXJlZEl0ZW1zOiBmdW5jdGlvbihjdCl7CiAgICAgICAgdmFyIHQgPSBjdC5nZXRMYXlvdXRUYXJnZXQoKSwgY3RpID0gY3QuaXRlbXMuaXRlbXMsIGxlbiA9IGN0aS5sZW5ndGgsIGksIGMsIGl0ZW1zID0gW107CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKChjID0gY3RpW2ldKS5yZW5kZXJlZCAmJiB0aGlzLmlzVmFsaWRQYXJlbnQoYywgdCkgJiYgYy5zaG91bGRMYXlvdXQgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2goYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJldHVybiBpdGVtczsKICAgIH0sCgogICAgCiAgICBjb25maWd1cmVJdGVtOiBmdW5jdGlvbihjKXsKICAgICAgICBpZiAodGhpcy5leHRyYUNscykgewogICAgICAgICAgICB2YXIgdCA9IGMuZ2V0UG9zaXRpb25FbCA/IGMuZ2V0UG9zaXRpb25FbCgpIDogYzsKICAgICAgICAgICAgdC5hZGRDbGFzcyh0aGlzLmV4dHJhQ2xzKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgaWYgKGMuZG9MYXlvdXQgJiYgdGhpcy5mb3JjZUxheW91dCkgewogICAgICAgICAgICBjLmRvTGF5b3V0KCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnJlbmRlckhpZGRlbiAmJiBjICE9IHRoaXMuYWN0aXZlSXRlbSkgewogICAgICAgICAgICBjLmhpZGUoKTsKICAgICAgICB9CiAgICB9LAoKICAgIG9uUmVtb3ZlOiBmdW5jdGlvbihjKXsKICAgICAgICBpZih0aGlzLmFjdGl2ZUl0ZW0gPT0gYyl7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFjdGl2ZUl0ZW07CiAgICAgICAgfQogICAgICAgIGlmKGMucmVuZGVyZWQgJiYgdGhpcy5leHRyYUNscyl7CiAgICAgICAgICAgIHZhciB0ID0gYy5nZXRQb3NpdGlvbkVsID8gYy5nZXRQb3NpdGlvbkVsKCkgOiBjOwogICAgICAgICAgICB0LnJlbW92ZUNsYXNzKHRoaXMuZXh0cmFDbHMpOwogICAgICAgIH0KICAgIH0sCgogICAgYWZ0ZXJSZW1vdmU6IGZ1bmN0aW9uKGMpewogICAgICAgIGlmKGMucmVtb3ZlUmVzdG9yZSl7CiAgICAgICAgICAgIGMucmVtb3ZlTW9kZSA9ICdjb250YWluZXInOwogICAgICAgICAgICBkZWxldGUgYy5yZW1vdmVSZXN0b3JlOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblJlc2l6ZTogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY3QgPSB0aGlzLmNvbnRhaW5lciwKICAgICAgICAgICAgYjsKICAgICAgICBpZihjdC5jb2xsYXBzZWQpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGIgPSBjdC5idWZmZXJSZXNpemUgJiYgY3Quc2hvdWxkQnVmZmVyTGF5b3V0KCkpewogICAgICAgICAgICBpZighdGhpcy5yZXNpemVUYXNrKXsKICAgICAgICAgICAgICAgIHRoaXMucmVzaXplVGFzayA9IG5ldyBFeHQudXRpbC5EZWxheWVkVGFzayh0aGlzLnJ1bkxheW91dCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2l6ZUJ1ZmZlciA9IEV4dC5pc051bWJlcihiKSA/IGIgOiA1MDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdC5sYXlvdXRQZW5kaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5yZXNpemVUYXNrLmRlbGF5KHRoaXMucmVzaXplQnVmZmVyKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5ydW5MYXlvdXQoKTsKICAgICAgICB9CiAgICB9LAoKICAgIHJ1bkxheW91dDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY3QgPSB0aGlzLmNvbnRhaW5lcjsKICAgICAgICB0aGlzLmxheW91dCgpOwogICAgICAgIGN0Lm9uTGF5b3V0KCk7CiAgICAgICAgZGVsZXRlIGN0LmxheW91dFBlbmRpbmc7CiAgICB9LAoKICAgIAogICAgc2V0Q29udGFpbmVyIDogZnVuY3Rpb24oY3QpewogICAgICAgIAogICAgICAgIGlmKHRoaXMubW9uaXRvclJlc2l6ZSAmJiBjdCAhPSB0aGlzLmNvbnRhaW5lcil7CiAgICAgICAgICAgIHZhciBvbGQgPSB0aGlzLmNvbnRhaW5lcjsKICAgICAgICAgICAgaWYob2xkKXsKICAgICAgICAgICAgICAgIG9sZC51bihvbGQucmVzaXplRXZlbnQsIHRoaXMub25SZXNpemUsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGN0KXsKICAgICAgICAgICAgICAgIGN0Lm9uKGN0LnJlc2l6ZUV2ZW50LCB0aGlzLm9uUmVzaXplLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmNvbnRhaW5lciA9IGN0OwogICAgfSwKCiAgICAKICAgIHBhcnNlTWFyZ2lucyA6IGZ1bmN0aW9uKHYpewogICAgICAgIGlmIChFeHQuaXNOdW1iZXIodikpIHsKICAgICAgICAgICAgdiA9IHYudG9TdHJpbmcoKTsKICAgICAgICB9CiAgICAgICAgdmFyIG1zICA9IHYuc3BsaXQoJyAnKSwKICAgICAgICAgICAgbGVuID0gbXMubGVuZ3RoOwogICAgICAgICAgICAKICAgICAgICBpZiAobGVuID09IDEpIHsKICAgICAgICAgICAgbXNbMV0gPSBtc1syXSA9IG1zWzNdID0gbXNbMF07CiAgICAgICAgfSBlbHNlIGlmKGxlbiA9PSAyKSB7CiAgICAgICAgICAgIG1zWzJdID0gbXNbMF07CiAgICAgICAgICAgIG1zWzNdID0gbXNbMV07CiAgICAgICAgfSBlbHNlIGlmKGxlbiA9PSAzKSB7CiAgICAgICAgICAgIG1zWzNdID0gbXNbMV07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHRvcCAgIDpwYXJzZUludChtc1swXSwgMTApIHx8IDAsCiAgICAgICAgICAgIHJpZ2h0IDpwYXJzZUludChtc1sxXSwgMTApIHx8IDAsCiAgICAgICAgICAgIGJvdHRvbTpwYXJzZUludChtc1syXSwgMTApIHx8IDAsCiAgICAgICAgICAgIGxlZnQgIDpwYXJzZUludChtc1szXSwgMTApIHx8IDAKICAgICAgICB9OwogICAgfSwKCiAgICAKICAgIGZpZWxkVHBsOiAoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHQgPSBuZXcgRXh0LlRlbXBsYXRlKAogICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1mb3JtLWl0ZW0ge2l0ZW1DbHN9IiB0YWJJbmRleD0iLTEiPicsCiAgICAgICAgICAgICAgICAnPGxhYmVsIGZvcj0ie2lkfSIgc3R5bGU9IntsYWJlbFN0eWxlfSIgY2xhc3M9IngtZm9ybS1pdGVtLWxhYmVsIj57bGFiZWx9e2xhYmVsU2VwYXJhdG9yfTwvbGFiZWw+JywKICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWZvcm0tZWxlbWVudCIgaWQ9IngtZm9ybS1lbC17aWR9IiBzdHlsZT0ie2VsZW1lbnRTdHlsZX0iPicsCiAgICAgICAgICAgICAgICAnPC9kaXY+PGRpdiBjbGFzcz0ie2NsZWFyQ2xzfSI+PC9kaXY+JywKICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICApOwogICAgICAgIHQuZGlzYWJsZUZvcm1hdHMgPSB0cnVlOwogICAgICAgIHJldHVybiB0LmNvbXBpbGUoKTsKICAgIH0pKCksCgogICAgCiAgICBkZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICAKICAgICAgICBpZih0aGlzLnJlc2l6ZVRhc2sgJiYgdGhpcy5yZXNpemVUYXNrLmNhbmNlbCl7CiAgICAgICAgICAgIHRoaXMucmVzaXplVGFzay5jYW5jZWwoKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5jb250YWluZXIpIHsKICAgICAgICAgICAgdGhpcy5jb250YWluZXIudW4odGhpcy5jb250YWluZXIucmVzaXplRXZlbnQsIHRoaXMub25SZXNpemUsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZighRXh0LmlzRW1wdHkodGhpcy50YXJnZXRDbHMpKXsKICAgICAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuY29udGFpbmVyLmdldExheW91dFRhcmdldCgpOwogICAgICAgICAgICBpZih0YXJnZXQpewogICAgICAgICAgICAgICAgdGFyZ2V0LnJlbW92ZUNsYXNzKHRoaXMudGFyZ2V0Q2xzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfSk7CkV4dC5sYXlvdXQuQXV0b0xheW91dCA9IEV4dC5leHRlbmQoRXh0LmxheW91dC5Db250YWluZXJMYXlvdXQsIHsKICAgIHR5cGU6ICdhdXRvJywKCiAgICBtb25pdG9yUmVzaXplOiB0cnVlLAoKICAgIG9uTGF5b3V0IDogZnVuY3Rpb24oY3QsIHRhcmdldCl7CiAgICAgICAgRXh0LmxheW91dC5BdXRvTGF5b3V0LnN1cGVyY2xhc3Mub25MYXlvdXQuY2FsbCh0aGlzLCBjdCwgdGFyZ2V0KTsKICAgICAgICB2YXIgY3MgPSB0aGlzLmdldFJlbmRlcmVkSXRlbXMoY3QpLCBsZW4gPSBjcy5sZW5ndGgsIGksIGM7CiAgICAgICAgZm9yKGkgPSAwOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICBjID0gY3NbaV07CiAgICAgICAgICAgIGlmIChjLmRvTGF5b3V0KXsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYy5kb0xheW91dCh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfSk7CgpFeHQuQ29udGFpbmVyLkxBWU9VVFNbJ2F1dG8nXSA9IEV4dC5sYXlvdXQuQXV0b0xheW91dDsKCkV4dC5sYXlvdXQuRml0TGF5b3V0ID0gRXh0LmV4dGVuZChFeHQubGF5b3V0LkNvbnRhaW5lckxheW91dCwgewogICAgCiAgICBtb25pdG9yUmVzaXplOnRydWUsCgogICAgdHlwZTogJ2ZpdCcsCgogICAgZ2V0TGF5b3V0VGFyZ2V0U2l6ZSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLmNvbnRhaW5lci5nZXRMYXlvdXRUYXJnZXQoKTsKICAgICAgICBpZiAoIXRhcmdldCkgewogICAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB0YXJnZXQuZ2V0U3R5bGVTaXplKCk7CiAgICB9LAoKICAgIAogICAgb25MYXlvdXQgOiBmdW5jdGlvbihjdCwgdGFyZ2V0KXsKICAgICAgICBFeHQubGF5b3V0LkZpdExheW91dC5zdXBlcmNsYXNzLm9uTGF5b3V0LmNhbGwodGhpcywgY3QsIHRhcmdldCk7CiAgICAgICAgaWYoIWN0LmNvbGxhcHNlZCl7CiAgICAgICAgICAgIHRoaXMuc2V0SXRlbVNpemUodGhpcy5hY3RpdmVJdGVtIHx8IGN0Lml0ZW1zLml0ZW1BdCgwKSwgdGhpcy5nZXRMYXlvdXRUYXJnZXRTaXplKCkpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRJdGVtU2l6ZSA6IGZ1bmN0aW9uKGl0ZW0sIHNpemUpewogICAgICAgIGlmKGl0ZW0gJiYgc2l6ZS5oZWlnaHQgPiAwKXsgCiAgICAgICAgICAgIGl0ZW0uc2V0U2l6ZShzaXplKTsKICAgICAgICB9CiAgICB9Cn0pOwpFeHQuQ29udGFpbmVyLkxBWU9VVFNbJ2ZpdCddID0gRXh0LmxheW91dC5GaXRMYXlvdXQ7CkV4dC5sYXlvdXQuQ2FyZExheW91dCA9IEV4dC5leHRlbmQoRXh0LmxheW91dC5GaXRMYXlvdXQsIHsKICAgIAogICAgZGVmZXJyZWRSZW5kZXIgOiBmYWxzZSwKCiAgICAKICAgIGxheW91dE9uQ2FyZENoYW5nZSA6IGZhbHNlLAoKICAgIAogICAgCiAgICByZW5kZXJIaWRkZW4gOiB0cnVlLAoKICAgIHR5cGU6ICdjYXJkJywKCiAgICAKICAgIHNldEFjdGl2ZUl0ZW0gOiBmdW5jdGlvbihpdGVtKXsKICAgICAgICB2YXIgYWkgPSB0aGlzLmFjdGl2ZUl0ZW0sCiAgICAgICAgICAgIGN0ID0gdGhpcy5jb250YWluZXI7CiAgICAgICAgaXRlbSA9IGN0LmdldENvbXBvbmVudChpdGVtKTsKCiAgICAgICAgCiAgICAgICAgaWYoaXRlbSAmJiBhaSAhPSBpdGVtKXsKCiAgICAgICAgICAgIAogICAgICAgICAgICBpZihhaSl7CiAgICAgICAgICAgICAgICBhaS5oaWRlKCk7CiAgICAgICAgICAgICAgICBpZiAoYWkuaGlkZGVuICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYWkuZmlyZUV2ZW50KCdkZWFjdGl2YXRlJywgYWkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbGF5b3V0ID0gaXRlbS5kb0xheW91dCAmJiAodGhpcy5sYXlvdXRPbkNhcmRDaGFuZ2UgfHwgIWl0ZW0ucmVuZGVyZWQpOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlSXRlbSA9IGl0ZW07CgogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGRlbGV0ZSBpdGVtLmRlZmVyTGF5b3V0OwoKICAgICAgICAgICAgCiAgICAgICAgICAgIGl0ZW0uc2hvdygpOwoKICAgICAgICAgICAgdGhpcy5sYXlvdXQoKTsKCiAgICAgICAgICAgIGlmKGxheW91dCl7CiAgICAgICAgICAgICAgICBpdGVtLmRvTGF5b3V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbS5maXJlRXZlbnQoJ2FjdGl2YXRlJywgaXRlbSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHJlbmRlckFsbCA6IGZ1bmN0aW9uKGN0LCB0YXJnZXQpewogICAgICAgIGlmKHRoaXMuZGVmZXJyZWRSZW5kZXIpewogICAgICAgICAgICB0aGlzLnJlbmRlckl0ZW0odGhpcy5hY3RpdmVJdGVtLCB1bmRlZmluZWQsIHRhcmdldCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIEV4dC5sYXlvdXQuQ2FyZExheW91dC5zdXBlcmNsYXNzLnJlbmRlckFsbC5jYWxsKHRoaXMsIGN0LCB0YXJnZXQpOwogICAgICAgIH0KICAgIH0KfSk7CkV4dC5Db250YWluZXIuTEFZT1VUU1snY2FyZCddID0gRXh0LmxheW91dC5DYXJkTGF5b3V0OwoKRXh0LmxheW91dC5BbmNob3JMYXlvdXQgPSBFeHQuZXh0ZW5kKEV4dC5sYXlvdXQuQ29udGFpbmVyTGF5b3V0LCB7CiAgICAKCiAgICAKICAgIG1vbml0b3JSZXNpemUgOiB0cnVlLAoKICAgIHR5cGUgOiAnYW5jaG9yJywKCiAgICAKICAgIGRlZmF1bHRBbmNob3IgOiAnMTAwJScsCgogICAgcGFyc2VBbmNob3JSRSA6IC9eKHJ8cmlnaHR8Ynxib3R0b20pJC9pLAoKCiAgICBnZXRMYXlvdXRUYXJnZXRTaXplIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuY29udGFpbmVyLmdldExheW91dFRhcmdldCgpLCByZXQgPSB7fTsKICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgIHJldCA9IHRhcmdldC5nZXRWaWV3U2l6ZSgpOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEV4dC5pc0lFICYmIEV4dC5pc1N0cmljdCAmJiByZXQud2lkdGggPT0gMCl7CiAgICAgICAgICAgICAgICByZXQgPSAgdGFyZ2V0LmdldFN0eWxlU2l6ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldC53aWR0aCAtPSB0YXJnZXQuZ2V0UGFkZGluZygnbHInKTsKICAgICAgICAgICAgcmV0LmhlaWdodCAtPSB0YXJnZXQuZ2V0UGFkZGluZygndGInKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0sCgogICAgCiAgICBvbkxheW91dCA6IGZ1bmN0aW9uKGNvbnRhaW5lciwgdGFyZ2V0KSB7CiAgICAgICAgRXh0LmxheW91dC5BbmNob3JMYXlvdXQuc3VwZXJjbGFzcy5vbkxheW91dC5jYWxsKHRoaXMsIGNvbnRhaW5lciwgdGFyZ2V0KTsKCiAgICAgICAgdmFyIHNpemUgPSB0aGlzLmdldExheW91dFRhcmdldFNpemUoKSwKICAgICAgICAgICAgY29udGFpbmVyV2lkdGggPSBzaXplLndpZHRoLAogICAgICAgICAgICBjb250YWluZXJIZWlnaHQgPSBzaXplLmhlaWdodCwKICAgICAgICAgICAgb3ZlcmZsb3cgPSB0YXJnZXQuZ2V0U3R5bGUoJ292ZXJmbG93JyksCiAgICAgICAgICAgIGNvbXBvbmVudHMgPSB0aGlzLmdldFJlbmRlcmVkSXRlbXMoY29udGFpbmVyKSwKICAgICAgICAgICAgbGVuID0gY29tcG9uZW50cy5sZW5ndGgsCiAgICAgICAgICAgIGJveGVzID0gW10sCiAgICAgICAgICAgIGJveCwKICAgICAgICAgICAgYW5jaG9yV2lkdGgsCiAgICAgICAgICAgIGFuY2hvckhlaWdodCwKICAgICAgICAgICAgY29tcG9uZW50LAogICAgICAgICAgICBhbmNob3JTcGVjLAogICAgICAgICAgICBjYWxjV2lkdGgsCiAgICAgICAgICAgIGNhbGNIZWlnaHQsCiAgICAgICAgICAgIGFuY2hvcnNBcnJheSwKICAgICAgICAgICAgdG90YWxIZWlnaHQgPSAwLAogICAgICAgICAgICBpLAogICAgICAgICAgICBlbDsKCiAgICAgICAgaWYoY29udGFpbmVyV2lkdGggPCAyMCAmJiBjb250YWluZXJIZWlnaHQgPCAyMCl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIAogICAgICAgIGlmKGNvbnRhaW5lci5hbmNob3JTaXplKSB7CiAgICAgICAgICAgIGlmKHR5cGVvZiBjb250YWluZXIuYW5jaG9yU2l6ZSA9PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgYW5jaG9yV2lkdGggPSBjb250YWluZXIuYW5jaG9yU2l6ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFuY2hvcldpZHRoID0gY29udGFpbmVyLmFuY2hvclNpemUud2lkdGg7CiAgICAgICAgICAgICAgICBhbmNob3JIZWlnaHQgPSBjb250YWluZXIuYW5jaG9yU2l6ZS5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhbmNob3JXaWR0aCA9IGNvbnRhaW5lci5pbml0aWFsQ29uZmlnLndpZHRoOwogICAgICAgICAgICBhbmNob3JIZWlnaHQgPSBjb250YWluZXIuaW5pdGlhbENvbmZpZy5oZWlnaHQ7CiAgICAgICAgfQoKICAgICAgICBmb3IoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBjb21wb25lbnQgPSBjb21wb25lbnRzW2ldOwogICAgICAgICAgICBlbCA9IGNvbXBvbmVudC5nZXRQb3NpdGlvbkVsKCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFjb21wb25lbnQuYW5jaG9yICYmIGNvbXBvbmVudC5pdGVtcyAmJiAhRXh0LmlzTnVtYmVyKGNvbXBvbmVudC53aWR0aCkgJiYgIShFeHQuaXNJRTYgJiYgRXh0LmlzU3RyaWN0KSl7CiAgICAgICAgICAgICAgICBjb21wb25lbnQuYW5jaG9yID0gdGhpcy5kZWZhdWx0QW5jaG9yOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihjb21wb25lbnQuYW5jaG9yKSB7CiAgICAgICAgICAgICAgICBhbmNob3JTcGVjID0gY29tcG9uZW50LmFuY2hvclNwZWM7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmKCFhbmNob3JTcGVjKXsKICAgICAgICAgICAgICAgICAgICBhbmNob3JzQXJyYXkgPSBjb21wb25lbnQuYW5jaG9yLnNwbGl0KCcgJyk7CiAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50LmFuY2hvclNwZWMgPSBhbmNob3JTcGVjID0gewogICAgICAgICAgICAgICAgICAgICAgICByaWdodDogdGhpcy5wYXJzZUFuY2hvcihhbmNob3JzQXJyYXlbMF0sIGNvbXBvbmVudC5pbml0aWFsQ29uZmlnLndpZHRoLCBhbmNob3JXaWR0aCksCiAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogdGhpcy5wYXJzZUFuY2hvcihhbmNob3JzQXJyYXlbMV0sIGNvbXBvbmVudC5pbml0aWFsQ29uZmlnLmhlaWdodCwgYW5jaG9ySGVpZ2h0KQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYWxjV2lkdGggPSBhbmNob3JTcGVjLnJpZ2h0ID8gdGhpcy5hZGp1c3RXaWR0aEFuY2hvcihhbmNob3JTcGVjLnJpZ2h0KGNvbnRhaW5lcldpZHRoKSAtIGVsLmdldE1hcmdpbnMoJ2xyJyksIGNvbXBvbmVudCkgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICBjYWxjSGVpZ2h0ID0gYW5jaG9yU3BlYy5ib3R0b20gPyB0aGlzLmFkanVzdEhlaWdodEFuY2hvcihhbmNob3JTcGVjLmJvdHRvbShjb250YWluZXJIZWlnaHQpIC0gZWwuZ2V0TWFyZ2lucygndGInKSwgY29tcG9uZW50KSA6IHVuZGVmaW5lZDsKCiAgICAgICAgICAgICAgICBpZihjYWxjV2lkdGggfHwgY2FsY0hlaWdodCkgewogICAgICAgICAgICAgICAgICAgIGJveGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQ6IGNvbXBvbmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGNhbGNXaWR0aCB8fCB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogY2FsY0hlaWdodCB8fCB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBib3hlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBib3ggPSBib3hlc1tpXTsKICAgICAgICAgICAgYm94LmNvbXBvbmVudC5zZXRTaXplKGJveC53aWR0aCwgYm94LmhlaWdodCk7CiAgICAgICAgfQoKICAgICAgICBpZiAob3ZlcmZsb3cgJiYgb3ZlcmZsb3cgIT0gJ2hpZGRlbicgJiYgIXRoaXMuYWRqdXN0bWVudFBhc3MpIHsKICAgICAgICAgICAgdmFyIG5ld1RhcmdldFNpemUgPSB0aGlzLmdldExheW91dFRhcmdldFNpemUoKTsKICAgICAgICAgICAgaWYgKG5ld1RhcmdldFNpemUud2lkdGggIT0gc2l6ZS53aWR0aCB8fCBuZXdUYXJnZXRTaXplLmhlaWdodCAhPSBzaXplLmhlaWdodCl7CiAgICAgICAgICAgICAgICB0aGlzLmFkanVzdG1lbnRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMub25MYXlvdXQoY29udGFpbmVyLCB0YXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgdGhpcy5hZGp1c3RtZW50UGFzczsKICAgIH0sCgogICAgCiAgICBwYXJzZUFuY2hvciA6IGZ1bmN0aW9uKGEsIHN0YXJ0LCBjc3RhcnQpIHsKICAgICAgICBpZiAoYSAmJiBhICE9ICdub25lJykgewogICAgICAgICAgICB2YXIgbGFzdDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnBhcnNlQW5jaG9yUkUudGVzdChhKSkgewogICAgICAgICAgICAgICAgdmFyIGRpZmYgPSBjc3RhcnQgLSBzdGFydDsKICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih2KXsKICAgICAgICAgICAgICAgICAgICBpZih2ICE9PSBsYXN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdCA9IHY7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2IC0gZGlmZjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIGlmKGEuaW5kZXhPZignJScpICE9IC0xKSB7CiAgICAgICAgICAgICAgICB2YXIgcmF0aW8gPSBwYXJzZUZsb2F0KGEucmVwbGFjZSgnJScsICcnKSkqLjAxOwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHYpewogICAgICAgICAgICAgICAgICAgIGlmKHYgIT09IGxhc3QpewogICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gdjsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodipyYXRpbyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhID0gcGFyc2VJbnQoYSwgMTApOwogICAgICAgICAgICAgICAgaWYgKCFpc05hTihhKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2ICE9PSBsYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gdjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2ICsgYTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAKICAgIGFkanVzdFdpZHRoQW5jaG9yIDogZnVuY3Rpb24odmFsdWUsIGNvbXApewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCgogICAgCiAgICBhZGp1c3RIZWlnaHRBbmNob3IgOiBmdW5jdGlvbih2YWx1ZSwgY29tcCl7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIAp9KTsKRXh0LkNvbnRhaW5lci5MQVlPVVRTWydhbmNob3InXSA9IEV4dC5sYXlvdXQuQW5jaG9yTGF5b3V0OwoKRXh0LmxheW91dC5Db2x1bW5MYXlvdXQgPSBFeHQuZXh0ZW5kKEV4dC5sYXlvdXQuQ29udGFpbmVyTGF5b3V0LCB7CiAgICAKICAgIG1vbml0b3JSZXNpemU6dHJ1ZSwKCiAgICB0eXBlOiAnY29sdW1uJywKCiAgICBleHRyYUNsczogJ3gtY29sdW1uJywKCiAgICBzY3JvbGxPZmZzZXQgOiAwLAoKICAgIAoKICAgIHRhcmdldENsczogJ3gtY29sdW1uLWxheW91dC1jdCcsCgogICAgaXNWYWxpZFBhcmVudCA6IGZ1bmN0aW9uKGMsIHRhcmdldCl7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXJDdCAmJiBjLmdldFBvc2l0aW9uRWwoKS5kb20ucGFyZW50Tm9kZSA9PSB0aGlzLmlubmVyQ3QuZG9tOwogICAgfSwKCiAgICBnZXRMYXlvdXRUYXJnZXRTaXplIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuY29udGFpbmVyLmdldExheW91dFRhcmdldCgpLCByZXQ7CiAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICByZXQgPSB0YXJnZXQuZ2V0Vmlld1NpemUoKTsKCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChFeHQuaXNJRSAmJiBFeHQuaXNTdHJpY3QgJiYgcmV0LndpZHRoID09IDApewogICAgICAgICAgICAgICAgcmV0ID0gIHRhcmdldC5nZXRTdHlsZVNpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0LndpZHRoIC09IHRhcmdldC5nZXRQYWRkaW5nKCdscicpOwogICAgICAgICAgICByZXQuaGVpZ2h0IC09IHRhcmdldC5nZXRQYWRkaW5nKCd0YicpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfSwKCiAgICByZW5kZXJBbGwgOiBmdW5jdGlvbihjdCwgdGFyZ2V0KSB7CiAgICAgICAgaWYoIXRoaXMuaW5uZXJDdCl7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pbm5lckN0ID0gdGFyZ2V0LmNyZWF0ZUNoaWxkKHtjbHM6J3gtY29sdW1uLWlubmVyJ30pOwogICAgICAgICAgICB0aGlzLmlubmVyQ3QuY3JlYXRlQ2hpbGQoe2NsczoneC1jbGVhcid9KTsKICAgICAgICB9CiAgICAgICAgRXh0LmxheW91dC5Db2x1bW5MYXlvdXQuc3VwZXJjbGFzcy5yZW5kZXJBbGwuY2FsbCh0aGlzLCBjdCwgdGhpcy5pbm5lckN0KTsKICAgIH0sCgogICAgCiAgICBvbkxheW91dCA6IGZ1bmN0aW9uKGN0LCB0YXJnZXQpewogICAgICAgIHZhciBjcyA9IGN0Lml0ZW1zLml0ZW1zLAogICAgICAgICAgICBsZW4gPSBjcy5sZW5ndGgsCiAgICAgICAgICAgIGMsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIG0sCiAgICAgICAgICAgIG1hcmdpbnMgPSBbXTsKCiAgICAgICAgdGhpcy5yZW5kZXJBbGwoY3QsIHRhcmdldCk7CgogICAgICAgIHZhciBzaXplID0gdGhpcy5nZXRMYXlvdXRUYXJnZXRTaXplKCk7CgogICAgICAgIGlmKHNpemUud2lkdGggPCAxICYmIHNpemUuaGVpZ2h0IDwgMSl7IAogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdyA9IHNpemUud2lkdGggLSB0aGlzLnNjcm9sbE9mZnNldCwKICAgICAgICAgICAgaCA9IHNpemUuaGVpZ2h0LAogICAgICAgICAgICBwdyA9IHc7CgogICAgICAgIHRoaXMuaW5uZXJDdC5zZXRXaWR0aCh3KTsKCiAgICAgICAgCiAgICAgICAgCgogICAgICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgYyA9IGNzW2ldOwogICAgICAgICAgICBtID0gYy5nZXRQb3NpdGlvbkVsKCkuZ2V0TWFyZ2lucygnbHInKTsKICAgICAgICAgICAgbWFyZ2luc1tpXSA9IG07CiAgICAgICAgICAgIGlmKCFjLmNvbHVtbldpZHRoKXsKICAgICAgICAgICAgICAgIHB3IC09IChjLmdldFdpZHRoKCkgKyBtKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcHcgPSBwdyA8IDAgPyAwIDogcHc7CgogICAgICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgYyA9IGNzW2ldOwogICAgICAgICAgICBtID0gbWFyZ2luc1tpXTsKICAgICAgICAgICAgaWYoYy5jb2x1bW5XaWR0aCl7CiAgICAgICAgICAgICAgICBjLnNldFNpemUoTWF0aC5mbG9vcihjLmNvbHVtbldpZHRoICogcHcpIC0gbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIAogICAgICAgIAogICAgICAgIGlmIChFeHQuaXNJRSkgewogICAgICAgICAgICBpZiAoaSA9IHRhcmdldC5nZXRTdHlsZSgnb3ZlcmZsb3cnKSAmJiBpICE9ICdoaWRkZW4nICYmICF0aGlzLmFkanVzdG1lbnRQYXNzKSB7CiAgICAgICAgICAgICAgICB2YXIgdHMgPSB0aGlzLmdldExheW91dFRhcmdldFNpemUoKTsKICAgICAgICAgICAgICAgIGlmICh0cy53aWR0aCAhPSBzaXplLndpZHRoKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkanVzdG1lbnRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTGF5b3V0KGN0LCB0YXJnZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRlbGV0ZSB0aGlzLmFkanVzdG1lbnRQYXNzOwogICAgfQoKICAgIAp9KTsKCkV4dC5Db250YWluZXIuTEFZT1VUU1snY29sdW1uJ10gPSBFeHQubGF5b3V0LkNvbHVtbkxheW91dDsKCkV4dC5sYXlvdXQuQm9yZGVyTGF5b3V0ID0gRXh0LmV4dGVuZChFeHQubGF5b3V0LkNvbnRhaW5lckxheW91dCwgewogICAgCiAgICBtb25pdG9yUmVzaXplOnRydWUsCiAgICAKICAgIHJlbmRlcmVkIDogZmFsc2UsCgogICAgdHlwZTogJ2JvcmRlcicsCgogICAgdGFyZ2V0Q2xzOiAneC1ib3JkZXItbGF5b3V0LWN0JywKCiAgICBnZXRMYXlvdXRUYXJnZXRTaXplIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuY29udGFpbmVyLmdldExheW91dFRhcmdldCgpOwogICAgICAgIHJldHVybiB0YXJnZXQgPyB0YXJnZXQuZ2V0Vmlld1NpemUoKSA6IHt9OwogICAgfSwKCiAgICAKICAgIG9uTGF5b3V0IDogZnVuY3Rpb24oY3QsIHRhcmdldCl7CiAgICAgICAgdmFyIGNvbGxhcHNlZCwgaSwgYywgcG9zLCBpdGVtcyA9IGN0Lml0ZW1zLml0ZW1zLCBsZW4gPSBpdGVtcy5sZW5ndGg7CiAgICAgICAgaWYoIXRoaXMucmVuZGVyZWQpewogICAgICAgICAgICBjb2xsYXBzZWQgPSBbXTsKICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGMgPSBpdGVtc1tpXTsKICAgICAgICAgICAgICAgIHBvcyA9IGMucmVnaW9uOwogICAgICAgICAgICAgICAgaWYoYy5jb2xsYXBzZWQpewogICAgICAgICAgICAgICAgICAgIGNvbGxhcHNlZC5wdXNoKGMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYy5jb2xsYXBzZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmKCFjLnJlbmRlcmVkKXsKICAgICAgICAgICAgICAgICAgICBjLnJlbmRlcih0YXJnZXQsIGkpOwogICAgICAgICAgICAgICAgICAgIGMuZ2V0UG9zaXRpb25FbCgpLmFkZENsYXNzKCd4LWJvcmRlci1wYW5lbCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpc1twb3NdID0gcG9zICE9ICdjZW50ZXInICYmIGMuc3BsaXQgPwogICAgICAgICAgICAgICAgICAgIG5ldyBFeHQubGF5b3V0LkJvcmRlckxheW91dC5TcGxpdFJlZ2lvbih0aGlzLCBjLmluaXRpYWxDb25maWcsIHBvcykgOgogICAgICAgICAgICAgICAgICAgIG5ldyBFeHQubGF5b3V0LkJvcmRlckxheW91dC5SZWdpb24odGhpcywgYy5pbml0aWFsQ29uZmlnLCBwb3MpOwogICAgICAgICAgICAgICAgdGhpc1twb3NdLnJlbmRlcih0YXJnZXQsIGMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVuZGVyZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNpemUgPSB0aGlzLmdldExheW91dFRhcmdldFNpemUoKTsKICAgICAgICBpZihzaXplLndpZHRoIDwgMjAgfHwgc2l6ZS5oZWlnaHQgPCAyMCl7IAogICAgICAgICAgICBpZihjb2xsYXBzZWQpewogICAgICAgICAgICAgICAgdGhpcy5yZXN0b3JlQ29sbGFwc2VkID0gY29sbGFwc2VkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9ZWxzZSBpZih0aGlzLnJlc3RvcmVDb2xsYXBzZWQpewogICAgICAgICAgICBjb2xsYXBzZWQgPSB0aGlzLnJlc3RvcmVDb2xsYXBzZWQ7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnJlc3RvcmVDb2xsYXBzZWQ7CiAgICAgICAgfQoKICAgICAgICB2YXIgdyA9IHNpemUud2lkdGgsIGggPSBzaXplLmhlaWdodCwKICAgICAgICAgICAgY2VudGVyVyA9IHcsIGNlbnRlckggPSBoLCBjZW50ZXJZID0gMCwgY2VudGVyWCA9IDAsCiAgICAgICAgICAgIG4gPSB0aGlzLm5vcnRoLCBzID0gdGhpcy5zb3V0aCwgd2VzdCA9IHRoaXMud2VzdCwgZSA9IHRoaXMuZWFzdCwgYyA9IHRoaXMuY2VudGVyLAogICAgICAgICAgICBiLCBtLCB0b3RhbFdpZHRoLCB0b3RhbEhlaWdodDsKICAgICAgICBpZighYyAmJiBFeHQubGF5b3V0LkJvcmRlckxheW91dC5XQVJOICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRocm93ICdObyBjZW50ZXIgcmVnaW9uIGRlZmluZWQgaW4gQm9yZGVyTGF5b3V0ICcgKyBjdC5pZDsKICAgICAgICB9CgogICAgICAgIGlmKG4gJiYgbi5pc1Zpc2libGUoKSl7CiAgICAgICAgICAgIGIgPSBuLmdldFNpemUoKTsKICAgICAgICAgICAgbSA9IG4uZ2V0TWFyZ2lucygpOwogICAgICAgICAgICBiLndpZHRoID0gdyAtIChtLmxlZnQrbS5yaWdodCk7CiAgICAgICAgICAgIGIueCA9IG0ubGVmdDsKICAgICAgICAgICAgYi55ID0gbS50b3A7CiAgICAgICAgICAgIGNlbnRlclkgPSBiLmhlaWdodCArIGIueSArIG0uYm90dG9tOwogICAgICAgICAgICBjZW50ZXJIIC09IGNlbnRlclk7CiAgICAgICAgICAgIG4uYXBwbHlMYXlvdXQoYik7CiAgICAgICAgfQogICAgICAgIGlmKHMgJiYgcy5pc1Zpc2libGUoKSl7CiAgICAgICAgICAgIGIgPSBzLmdldFNpemUoKTsKICAgICAgICAgICAgbSA9IHMuZ2V0TWFyZ2lucygpOwogICAgICAgICAgICBiLndpZHRoID0gdyAtIChtLmxlZnQrbS5yaWdodCk7CiAgICAgICAgICAgIGIueCA9IG0ubGVmdDsKICAgICAgICAgICAgdG90YWxIZWlnaHQgPSAoYi5oZWlnaHQgKyBtLnRvcCArIG0uYm90dG9tKTsKICAgICAgICAgICAgYi55ID0gaCAtIHRvdGFsSGVpZ2h0ICsgbS50b3A7CiAgICAgICAgICAgIGNlbnRlckggLT0gdG90YWxIZWlnaHQ7CiAgICAgICAgICAgIHMuYXBwbHlMYXlvdXQoYik7CiAgICAgICAgfQogICAgICAgIGlmKHdlc3QgJiYgd2VzdC5pc1Zpc2libGUoKSl7CiAgICAgICAgICAgIGIgPSB3ZXN0LmdldFNpemUoKTsKICAgICAgICAgICAgbSA9IHdlc3QuZ2V0TWFyZ2lucygpOwogICAgICAgICAgICBiLmhlaWdodCA9IGNlbnRlckggLSAobS50b3ArbS5ib3R0b20pOwogICAgICAgICAgICBiLnggPSBtLmxlZnQ7CiAgICAgICAgICAgIGIueSA9IGNlbnRlclkgKyBtLnRvcDsKICAgICAgICAgICAgdG90YWxXaWR0aCA9IChiLndpZHRoICsgbS5sZWZ0ICsgbS5yaWdodCk7CiAgICAgICAgICAgIGNlbnRlclggKz0gdG90YWxXaWR0aDsKICAgICAgICAgICAgY2VudGVyVyAtPSB0b3RhbFdpZHRoOwogICAgICAgICAgICB3ZXN0LmFwcGx5TGF5b3V0KGIpOwogICAgICAgIH0KICAgICAgICBpZihlICYmIGUuaXNWaXNpYmxlKCkpewogICAgICAgICAgICBiID0gZS5nZXRTaXplKCk7CiAgICAgICAgICAgIG0gPSBlLmdldE1hcmdpbnMoKTsKICAgICAgICAgICAgYi5oZWlnaHQgPSBjZW50ZXJIIC0gKG0udG9wK20uYm90dG9tKTsKICAgICAgICAgICAgdG90YWxXaWR0aCA9IChiLndpZHRoICsgbS5sZWZ0ICsgbS5yaWdodCk7CiAgICAgICAgICAgIGIueCA9IHcgLSB0b3RhbFdpZHRoICsgbS5sZWZ0OwogICAgICAgICAgICBiLnkgPSBjZW50ZXJZICsgbS50b3A7CiAgICAgICAgICAgIGNlbnRlclcgLT0gdG90YWxXaWR0aDsKICAgICAgICAgICAgZS5hcHBseUxheW91dChiKTsKICAgICAgICB9CiAgICAgICAgaWYoYyl7CiAgICAgICAgICAgIG0gPSBjLmdldE1hcmdpbnMoKTsKICAgICAgICAgICAgdmFyIGNlbnRlckJveCA9IHsKICAgICAgICAgICAgICAgIHg6IGNlbnRlclggKyBtLmxlZnQsCiAgICAgICAgICAgICAgICB5OiBjZW50ZXJZICsgbS50b3AsCiAgICAgICAgICAgICAgICB3aWR0aDogY2VudGVyVyAtIChtLmxlZnQrbS5yaWdodCksCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGNlbnRlckggLSAobS50b3ArbS5ib3R0b20pCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGMuYXBwbHlMYXlvdXQoY2VudGVyQm94KTsKICAgICAgICB9CiAgICAgICAgaWYoY29sbGFwc2VkKXsKICAgICAgICAgICAgZm9yKGkgPSAwLCBsZW4gPSBjb2xsYXBzZWQubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgY29sbGFwc2VkW2ldLmNvbGxhcHNlKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZihFeHQuaXNJRSAmJiBFeHQuaXNTdHJpY3QpeyAKICAgICAgICAgICAgdGFyZ2V0LnJlcGFpbnQoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGkgPSB0YXJnZXQuZ2V0U3R5bGUoJ292ZXJmbG93JykgJiYgaSAhPSAnaGlkZGVuJyAmJiAhdGhpcy5hZGp1c3RtZW50UGFzcykgewogICAgICAgICAgICB2YXIgdHMgPSB0aGlzLmdldExheW91dFRhcmdldFNpemUoKTsKICAgICAgICAgICAgaWYgKHRzLndpZHRoICE9IHNpemUud2lkdGggfHwgdHMuaGVpZ2h0ICE9IHNpemUuaGVpZ2h0KXsKICAgICAgICAgICAgICAgIHRoaXMuYWRqdXN0bWVudFBhc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5vbkxheW91dChjdCwgdGFyZ2V0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBkZWxldGUgdGhpcy5hZGp1c3RtZW50UGFzczsKICAgIH0sCgogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHIgPSBbJ25vcnRoJywgJ3NvdXRoJywgJ2Vhc3QnLCAnd2VzdCddLCBpLCByZWdpb247CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVnaW9uID0gdGhpc1tyW2ldXTsKICAgICAgICAgICAgaWYocmVnaW9uKXsKICAgICAgICAgICAgICAgIGlmKHJlZ2lvbi5kZXN0cm95KXsKICAgICAgICAgICAgICAgICAgICByZWdpb24uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfWVsc2UgaWYgKHJlZ2lvbi5zcGxpdCl7CiAgICAgICAgICAgICAgICAgICAgcmVnaW9uLnNwbGl0LmRlc3Ryb3kodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgRXh0LmxheW91dC5Cb3JkZXJMYXlvdXQuc3VwZXJjbGFzcy5kZXN0cm95LmNhbGwodGhpcyk7CiAgICB9CgogICAgCn0pOwoKCkV4dC5sYXlvdXQuQm9yZGVyTGF5b3V0LlJlZ2lvbiA9IGZ1bmN0aW9uKGxheW91dCwgY29uZmlnLCBwb3MpewogICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CiAgICB0aGlzLmxheW91dCA9IGxheW91dDsKICAgIHRoaXMucG9zaXRpb24gPSBwb3M7CiAgICB0aGlzLnN0YXRlID0ge307CiAgICBpZih0eXBlb2YgdGhpcy5tYXJnaW5zID09ICdzdHJpbmcnKXsKICAgICAgICB0aGlzLm1hcmdpbnMgPSB0aGlzLmxheW91dC5wYXJzZU1hcmdpbnModGhpcy5tYXJnaW5zKTsKICAgIH0KICAgIHRoaXMubWFyZ2lucyA9IEV4dC5hcHBseUlmKHRoaXMubWFyZ2lucyB8fCB7fSwgdGhpcy5kZWZhdWx0TWFyZ2lucyk7CiAgICBpZih0aGlzLmNvbGxhcHNpYmxlKXsKICAgICAgICBpZih0eXBlb2YgdGhpcy5jbWFyZ2lucyA9PSAnc3RyaW5nJyl7CiAgICAgICAgICAgIHRoaXMuY21hcmdpbnMgPSB0aGlzLmxheW91dC5wYXJzZU1hcmdpbnModGhpcy5jbWFyZ2lucyk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuY29sbGFwc2VNb2RlID09ICdtaW5pJyAmJiAhdGhpcy5jbWFyZ2lucyl7CiAgICAgICAgICAgIHRoaXMuY21hcmdpbnMgPSB7bGVmdDowLHRvcDowLHJpZ2h0OjAsYm90dG9tOjB9OwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmNtYXJnaW5zID0gRXh0LmFwcGx5SWYodGhpcy5jbWFyZ2lucyB8fCB7fSwKICAgICAgICAgICAgICAgIHBvcyA9PSAnbm9ydGgnIHx8IHBvcyA9PSAnc291dGgnID8gdGhpcy5kZWZhdWx0TlNDTWFyZ2lucyA6IHRoaXMuZGVmYXVsdEVXQ01hcmdpbnMpOwogICAgICAgIH0KICAgIH0KfTsKCkV4dC5sYXlvdXQuQm9yZGVyTGF5b3V0LlJlZ2lvbi5wcm90b3R5cGUgPSB7CiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICBjb2xsYXBzaWJsZSA6IGZhbHNlLAogICAgCiAgICBzcGxpdDpmYWxzZSwKICAgIAogICAgZmxvYXRhYmxlOiB0cnVlLAogICAgCiAgICBtaW5XaWR0aDo1MCwKICAgIAogICAgbWluSGVpZ2h0OjUwLAoKICAgIAogICAgZGVmYXVsdE1hcmdpbnMgOiB7bGVmdDowLHRvcDowLHJpZ2h0OjAsYm90dG9tOjB9LAogICAgCiAgICBkZWZhdWx0TlNDTWFyZ2lucyA6IHtsZWZ0OjUsdG9wOjUscmlnaHQ6NSxib3R0b206NX0sCiAgICAKICAgIGRlZmF1bHRFV0NNYXJnaW5zIDoge2xlZnQ6NSx0b3A6MCxyaWdodDo1LGJvdHRvbTowfSwKICAgIGZsb2F0aW5nWkluZGV4OiAxMDAsCgogICAgCiAgICBpc0NvbGxhcHNlZCA6IGZhbHNlLAoKICAgIAogICAgCiAgICAKCiAgICAKICAgIHJlbmRlciA6IGZ1bmN0aW9uKGN0LCBwKXsKICAgICAgICB0aGlzLnBhbmVsID0gcDsKICAgICAgICBwLmVsLmVuYWJsZURpc3BsYXlNb2RlKCk7CiAgICAgICAgdGhpcy50YXJnZXRFbCA9IGN0OwogICAgICAgIHRoaXMuZWwgPSBwLmVsOwoKICAgICAgICB2YXIgZ3MgPSBwLmdldFN0YXRlLCBwcyA9IHRoaXMucG9zaXRpb247CiAgICAgICAgcC5nZXRTdGF0ZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBFeHQuYXBwbHkoZ3MuY2FsbChwKSB8fCB7fSwgdGhpcy5zdGF0ZSk7CiAgICAgICAgfS5jcmVhdGVEZWxlZ2F0ZSh0aGlzKTsKCiAgICAgICAgaWYocHMgIT0gJ2NlbnRlcicpewogICAgICAgICAgICBwLmFsbG93UXVldWVkRXhwYW5kID0gZmFsc2U7CiAgICAgICAgICAgIHAub24oewogICAgICAgICAgICAgICAgYmVmb3JlY29sbGFwc2U6IHRoaXMuYmVmb3JlQ29sbGFwc2UsCiAgICAgICAgICAgICAgICBjb2xsYXBzZTogdGhpcy5vbkNvbGxhcHNlLAogICAgICAgICAgICAgICAgYmVmb3JlZXhwYW5kOiB0aGlzLmJlZm9yZUV4cGFuZCwKICAgICAgICAgICAgICAgIGV4cGFuZDogdGhpcy5vbkV4cGFuZCwKICAgICAgICAgICAgICAgIGhpZGU6IHRoaXMub25IaWRlLAogICAgICAgICAgICAgICAgc2hvdzogdGhpcy5vblNob3csCiAgICAgICAgICAgICAgICBzY29wZTogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhpcy5jb2xsYXBzaWJsZSB8fCB0aGlzLmZsb2F0YWJsZSl7CiAgICAgICAgICAgICAgICBwLmNvbGxhcHNlRWwgPSAnZWwnOwogICAgICAgICAgICAgICAgcC5zbGlkZUFuY2hvciA9IHRoaXMuZ2V0U2xpZGVBbmNob3IoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihwLnRvb2xzICYmIHAudG9vbHMudG9nZ2xlKXsKICAgICAgICAgICAgICAgIHAudG9vbHMudG9nZ2xlLmFkZENsYXNzKCd4LXRvb2wtY29sbGFwc2UtJytwcyk7CiAgICAgICAgICAgICAgICBwLnRvb2xzLnRvZ2dsZS5hZGRDbGFzc09uT3ZlcigneC10b29sLWNvbGxhcHNlLScrcHMrJy1vdmVyJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0Q29sbGFwc2VkRWwgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLmNvbGxhcHNlZEVsKXsKICAgICAgICAgICAgaWYoIXRoaXMudG9vbFRlbXBsYXRlKXsKICAgICAgICAgICAgICAgIHZhciB0dCA9IG5ldyBFeHQuVGVtcGxhdGUoCiAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LXRvb2wgeC10b29sLXtpZH0iPiYjMTYwOzwvZGl2PicKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB0dC5kaXNhYmxlRm9ybWF0cyA9IHRydWU7CiAgICAgICAgICAgICAgICB0dC5jb21waWxlKCk7CiAgICAgICAgICAgICAgICBFeHQubGF5b3V0LkJvcmRlckxheW91dC5SZWdpb24ucHJvdG90eXBlLnRvb2xUZW1wbGF0ZSA9IHR0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY29sbGFwc2VkRWwgPSB0aGlzLnRhcmdldEVsLmNyZWF0ZUNoaWxkKHsKICAgICAgICAgICAgICAgIGNsczogIngtbGF5b3V0LWNvbGxhcHNlZCB4LWxheW91dC1jb2xsYXBzZWQtIit0aGlzLnBvc2l0aW9uLAogICAgICAgICAgICAgICAgaWQ6IHRoaXMucGFuZWwuaWQgKyAnLXhjb2xsYXBzZWQnCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmNvbGxhcHNlZEVsLmVuYWJsZURpc3BsYXlNb2RlKCdibG9jaycpOwoKICAgICAgICAgICAgaWYodGhpcy5jb2xsYXBzZU1vZGUgPT0gJ21pbmknKXsKICAgICAgICAgICAgICAgIHRoaXMuY29sbGFwc2VkRWwuYWRkQ2xhc3MoJ3gtbGF5b3V0LWNtaW5pLScrdGhpcy5wb3NpdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLm1pbmlDb2xsYXBzZWRFbCA9IHRoaXMuY29sbGFwc2VkRWwuY3JlYXRlQ2hpbGQoewogICAgICAgICAgICAgICAgICAgIGNsczogIngtbGF5b3V0LW1pbmkgeC1sYXlvdXQtbWluaS0iK3RoaXMucG9zaXRpb24sIGh0bWw6ICImIzE2MDsiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMubWluaUNvbGxhcHNlZEVsLmFkZENsYXNzT25PdmVyKCd4LWxheW91dC1taW5pLW92ZXInKTsKICAgICAgICAgICAgICAgIHRoaXMuY29sbGFwc2VkRWwuYWRkQ2xhc3NPbk92ZXIoIngtbGF5b3V0LWNvbGxhcHNlZC1vdmVyIik7CiAgICAgICAgICAgICAgICB0aGlzLmNvbGxhcHNlZEVsLm9uKCdjbGljaycsIHRoaXMub25FeHBhbmRDbGljaywgdGhpcywge3N0b3BFdmVudDp0cnVlfSk7CiAgICAgICAgICAgIH1lbHNlIHsKICAgICAgICAgICAgICAgIGlmKHRoaXMuY29sbGFwc2libGUgIT09IGZhbHNlICYmICF0aGlzLmhpZGVDb2xsYXBzZVRvb2wpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuZXhwYW5kVG9vbEVsID0gdGhpcy50b29sVGVtcGxhdGUuYXBwZW5kKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsYXBzZWRFbC5kb20sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7aWQ6J2V4cGFuZC0nK3RoaXMucG9zaXRpb259LCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB0LmFkZENsYXNzT25PdmVyKCd4LXRvb2wtZXhwYW5kLScrdGhpcy5wb3NpdGlvbisnLW92ZXInKTsKICAgICAgICAgICAgICAgICAgICB0Lm9uKCdjbGljaycsIHRoaXMub25FeHBhbmRDbGljaywgdGhpcywge3N0b3BFdmVudDp0cnVlfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZih0aGlzLmZsb2F0YWJsZSAhPT0gZmFsc2UgfHwgdGhpcy50aXRsZUNvbGxhcHNlKXsKICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGFwc2VkRWwuYWRkQ2xhc3NPbk92ZXIoIngtbGF5b3V0LWNvbGxhcHNlZC1vdmVyIik7CiAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxhcHNlZEVsLm9uKCJjbGljayIsIHRoaXNbdGhpcy5mbG9hdGFibGUgPyAnY29sbGFwc2VDbGljaycgOiAnb25FeHBhbmRDbGljayddLCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5jb2xsYXBzZWRFbDsKICAgIH0sCgogICAgCiAgICBvbkV4cGFuZENsaWNrIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYodGhpcy5pc1NsaWQpewogICAgICAgICAgICB0aGlzLnBhbmVsLmV4cGFuZChmYWxzZSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMucGFuZWwuZXhwYW5kKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uQ29sbGFwc2VDbGljayA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMucGFuZWwuY29sbGFwc2UoKTsKICAgIH0sCgogICAgCiAgICBiZWZvcmVDb2xsYXBzZSA6IGZ1bmN0aW9uKHAsIGFuaW1hdGUpewogICAgICAgIHRoaXMubGFzdEFuaW0gPSBhbmltYXRlOwogICAgICAgIGlmKHRoaXMuc3BsaXRFbCl7CiAgICAgICAgICAgIHRoaXMuc3BsaXRFbC5oaWRlKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZ2V0Q29sbGFwc2VkRWwoKS5zaG93KCk7CiAgICAgICAgdmFyIGVsID0gdGhpcy5wYW5lbC5nZXRFbCgpOwogICAgICAgIHRoaXMub3JpZ2luYWxaSW5kZXggPSBlbC5nZXRTdHlsZSgnei1pbmRleCcpOwogICAgICAgIGVsLnNldFN0eWxlKCd6LWluZGV4JywgMTAwKTsKICAgICAgICB0aGlzLmlzQ29sbGFwc2VkID0gdHJ1ZTsKICAgICAgICB0aGlzLmxheW91dC5sYXlvdXQoKTsKICAgIH0sCgogICAgCiAgICBvbkNvbGxhcHNlIDogZnVuY3Rpb24oYW5pbWF0ZSl7CiAgICAgICAgdGhpcy5wYW5lbC5lbC5zZXRTdHlsZSgnei1pbmRleCcsIDEpOwogICAgICAgIGlmKHRoaXMubGFzdEFuaW0gPT09IGZhbHNlIHx8IHRoaXMucGFuZWwuYW5pbUNvbGxhcHNlID09PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuZ2V0Q29sbGFwc2VkRWwoKS5kb20uc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5nZXRDb2xsYXBzZWRFbCgpLnNsaWRlSW4odGhpcy5wYW5lbC5zbGlkZUFuY2hvciwge2R1cmF0aW9uOi4yfSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RhdGUuY29sbGFwc2VkID0gdHJ1ZTsKICAgICAgICB0aGlzLnBhbmVsLnNhdmVTdGF0ZSgpOwogICAgfSwKCiAgICAKICAgIGJlZm9yZUV4cGFuZCA6IGZ1bmN0aW9uKGFuaW1hdGUpewogICAgICAgIGlmKHRoaXMuaXNTbGlkKXsKICAgICAgICAgICAgdGhpcy5hZnRlclNsaWRlSW4oKTsKICAgICAgICB9CiAgICAgICAgdmFyIGMgPSB0aGlzLmdldENvbGxhcHNlZEVsKCk7CiAgICAgICAgdGhpcy5lbC5zaG93KCk7CiAgICAgICAgaWYodGhpcy5wb3NpdGlvbiA9PSAnZWFzdCcgfHwgdGhpcy5wb3NpdGlvbiA9PSAnd2VzdCcpewogICAgICAgICAgICB0aGlzLnBhbmVsLnNldFNpemUodW5kZWZpbmVkLCBjLmdldEhlaWdodCgpKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5wYW5lbC5zZXRTaXplKGMuZ2V0V2lkdGgoKSwgdW5kZWZpbmVkKTsKICAgICAgICB9CiAgICAgICAgYy5oaWRlKCk7CiAgICAgICAgYy5kb20uc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogICAgICAgIHRoaXMucGFuZWwuZWwuc2V0U3R5bGUoJ3otaW5kZXgnLCB0aGlzLmZsb2F0aW5nWkluZGV4KTsKICAgIH0sCgogICAgCiAgICBvbkV4cGFuZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5pc0NvbGxhcHNlZCA9IGZhbHNlOwogICAgICAgIGlmKHRoaXMuc3BsaXRFbCl7CiAgICAgICAgICAgIHRoaXMuc3BsaXRFbC5zaG93KCk7CiAgICAgICAgfQogICAgICAgIHRoaXMubGF5b3V0LmxheW91dCgpOwogICAgICAgIHRoaXMucGFuZWwuZWwuc2V0U3R5bGUoJ3otaW5kZXgnLCB0aGlzLm9yaWdpbmFsWkluZGV4KTsKICAgICAgICB0aGlzLnN0YXRlLmNvbGxhcHNlZCA9IGZhbHNlOwogICAgICAgIHRoaXMucGFuZWwuc2F2ZVN0YXRlKCk7CiAgICB9LAoKICAgIAogICAgY29sbGFwc2VDbGljayA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKHRoaXMuaXNTbGlkKXsKICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgIHRoaXMuc2xpZGVJbigpOwogICAgICAgIH1lbHNlewogICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgdGhpcy5zbGlkZU91dCgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkhpZGUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuaXNDb2xsYXBzZWQpewogICAgICAgICAgICB0aGlzLmdldENvbGxhcHNlZEVsKCkuaGlkZSgpOwogICAgICAgIH1lbHNlIGlmKHRoaXMuc3BsaXRFbCl7CiAgICAgICAgICAgIHRoaXMuc3BsaXRFbC5oaWRlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uU2hvdyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5pc0NvbGxhcHNlZCl7CiAgICAgICAgICAgIHRoaXMuZ2V0Q29sbGFwc2VkRWwoKS5zaG93KCk7CiAgICAgICAgfWVsc2UgaWYodGhpcy5zcGxpdEVsKXsKICAgICAgICAgICAgdGhpcy5zcGxpdEVsLnNob3coKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaXNWaXNpYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gIXRoaXMucGFuZWwuaGlkZGVuOwogICAgfSwKCiAgICAKICAgIGdldE1hcmdpbnMgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmlzQ29sbGFwc2VkICYmIHRoaXMuY21hcmdpbnMgPyB0aGlzLmNtYXJnaW5zIDogdGhpcy5tYXJnaW5zOwogICAgfSwKCiAgICAKICAgIGdldFNpemUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmlzQ29sbGFwc2VkID8gdGhpcy5nZXRDb2xsYXBzZWRFbCgpLmdldFNpemUoKSA6IHRoaXMucGFuZWwuZ2V0U2l6ZSgpOwogICAgfSwKCiAgICAKICAgIHNldFBhbmVsIDogZnVuY3Rpb24ocGFuZWwpewogICAgICAgIHRoaXMucGFuZWwgPSBwYW5lbDsKICAgIH0sCgogICAgCiAgICBnZXRNaW5XaWR0aDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5taW5XaWR0aDsKICAgIH0sCgogICAgCiAgICBnZXRNaW5IZWlnaHQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMubWluSGVpZ2h0OwogICAgfSwKCiAgICAKICAgIGFwcGx5TGF5b3V0Q29sbGFwc2VkIDogZnVuY3Rpb24oYm94KXsKICAgICAgICB2YXIgY2UgPSB0aGlzLmdldENvbGxhcHNlZEVsKCk7CiAgICAgICAgY2Uuc2V0TGVmdFRvcChib3gueCwgYm94LnkpOwogICAgICAgIGNlLnNldFNpemUoYm94LndpZHRoLCBib3guaGVpZ2h0KTsKICAgIH0sCgogICAgCiAgICBhcHBseUxheW91dCA6IGZ1bmN0aW9uKGJveCl7CiAgICAgICAgaWYodGhpcy5pc0NvbGxhcHNlZCl7CiAgICAgICAgICAgIHRoaXMuYXBwbHlMYXlvdXRDb2xsYXBzZWQoYm94KTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5wYW5lbC5zZXRQb3NpdGlvbihib3gueCwgYm94LnkpOwogICAgICAgICAgICB0aGlzLnBhbmVsLnNldFNpemUoYm94LndpZHRoLCBib3guaGVpZ2h0KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYmVmb3JlU2xpZGU6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5wYW5lbC5iZWZvcmVFZmZlY3QoKTsKICAgIH0sCgogICAgCiAgICBhZnRlclNsaWRlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnBhbmVsLmFmdGVyRWZmZWN0KCk7CiAgICB9LAoKICAgIAogICAgaW5pdEF1dG9IaWRlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmF1dG9IaWRlICE9PSBmYWxzZSl7CiAgICAgICAgICAgIGlmKCF0aGlzLmF1dG9IaWRlSGQpewogICAgICAgICAgICAgICAgdGhpcy5hdXRvSGlkZVNsaWRlVGFzayA9IG5ldyBFeHQudXRpbC5EZWxheWVkVGFzayh0aGlzLnNsaWRlSW4sIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5hdXRvSGlkZUhkID0gewogICAgICAgICAgICAgICAgICAgICJtb3VzZW91dCI6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgICAgICAgICBpZighZS53aXRoaW4odGhpcy5lbCwgdHJ1ZSkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvSGlkZVNsaWRlVGFzay5kZWxheSg1MDApOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAibW91c2VvdmVyIiA6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dG9IaWRlU2xpZGVUYXNrLmNhbmNlbCgpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2NvcGUgOiB0aGlzCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwub24odGhpcy5hdXRvSGlkZUhkKTsKICAgICAgICAgICAgdGhpcy5jb2xsYXBzZWRFbC5vbih0aGlzLmF1dG9IaWRlSGQpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBjbGVhckF1dG9IaWRlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmF1dG9IaWRlICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuZWwudW4oIm1vdXNlb3V0IiwgdGhpcy5hdXRvSGlkZUhkLm1vdXNlb3V0KTsKICAgICAgICAgICAgdGhpcy5lbC51bigibW91c2VvdmVyIiwgdGhpcy5hdXRvSGlkZUhkLm1vdXNlb3Zlcik7CiAgICAgICAgICAgIHRoaXMuY29sbGFwc2VkRWwudW4oIm1vdXNlb3V0IiwgdGhpcy5hdXRvSGlkZUhkLm1vdXNlb3V0KTsKICAgICAgICAgICAgdGhpcy5jb2xsYXBzZWRFbC51bigibW91c2VvdmVyIiwgdGhpcy5hdXRvSGlkZUhkLm1vdXNlb3Zlcik7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNsZWFyTW9uaXRvciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmdldERvYygpLnVuKCJjbGljayIsIHRoaXMuc2xpZGVJbklmLCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBzbGlkZU91dCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5pc1NsaWQgfHwgdGhpcy5lbC5oYXNBY3RpdmVGeCgpKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmlzU2xpZCA9IHRydWU7CiAgICAgICAgdmFyIHRzID0gdGhpcy5wYW5lbC50b29scywgZGgsIHBjOwogICAgICAgIGlmKHRzICYmIHRzLnRvZ2dsZSl7CiAgICAgICAgICAgIHRzLnRvZ2dsZS5oaWRlKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZWwuc2hvdygpOwoKICAgICAgICAKICAgICAgICBwYyA9IHRoaXMucGFuZWwuY29sbGFwc2VkOwogICAgICAgIHRoaXMucGFuZWwuY29sbGFwc2VkID0gZmFsc2U7CgogICAgICAgIGlmKHRoaXMucG9zaXRpb24gPT0gJ2Vhc3QnIHx8IHRoaXMucG9zaXRpb24gPT0gJ3dlc3QnKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRoID0gdGhpcy5wYW5lbC5kZWZlckhlaWdodDsKICAgICAgICAgICAgdGhpcy5wYW5lbC5kZWZlckhlaWdodCA9IGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5wYW5lbC5zZXRTaXplKHVuZGVmaW5lZCwgdGhpcy5jb2xsYXBzZWRFbC5nZXRIZWlnaHQoKSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wYW5lbC5kZWZlckhlaWdodCA9IGRoOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLnBhbmVsLnNldFNpemUodGhpcy5jb2xsYXBzZWRFbC5nZXRXaWR0aCgpLCB1bmRlZmluZWQpOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgdGhpcy5wYW5lbC5jb2xsYXBzZWQgPSBwYzsKCiAgICAgICAgdGhpcy5yZXN0b3JlTFQgPSBbdGhpcy5lbC5kb20uc3R5bGUubGVmdCwgdGhpcy5lbC5kb20uc3R5bGUudG9wXTsKICAgICAgICB0aGlzLmVsLmFsaWduVG8odGhpcy5jb2xsYXBzZWRFbCwgdGhpcy5nZXRDb2xsYXBzZUFuY2hvcigpKTsKICAgICAgICB0aGlzLmVsLnNldFN0eWxlKCJ6LWluZGV4IiwgdGhpcy5mbG9hdGluZ1pJbmRleCsyKTsKICAgICAgICB0aGlzLnBhbmVsLmVsLnJlcGxhY2VDbGFzcygneC1wYW5lbC1jb2xsYXBzZWQnLCAneC1wYW5lbC1mbG9hdGluZycpOwogICAgICAgIGlmKHRoaXMuYW5pbUZsb2F0ICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuYmVmb3JlU2xpZGUoKTsKICAgICAgICAgICAgdGhpcy5lbC5zbGlkZUluKHRoaXMuZ2V0U2xpZGVBbmNob3IoKSwgewogICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZnRlclNsaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbml0QXV0b0hpZGUoKTsKICAgICAgICAgICAgICAgICAgICBFeHQuZ2V0RG9jKCkub24oImNsaWNrIiwgdGhpcy5zbGlkZUluSWYsIHRoaXMpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgYmxvY2s6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuaW5pdEF1dG9IaWRlKCk7CiAgICAgICAgICAgICBFeHQuZ2V0RG9jKCkub24oImNsaWNrIiwgdGhpcy5zbGlkZUluSWYsIHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhZnRlclNsaWRlSW4gOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuY2xlYXJBdXRvSGlkZSgpOwogICAgICAgIHRoaXMuaXNTbGlkID0gZmFsc2U7CiAgICAgICAgdGhpcy5jbGVhck1vbml0b3IoKTsKICAgICAgICB0aGlzLmVsLnNldFN0eWxlKCJ6LWluZGV4IiwgIiIpOwogICAgICAgIHRoaXMucGFuZWwuZWwucmVwbGFjZUNsYXNzKCd4LXBhbmVsLWZsb2F0aW5nJywgJ3gtcGFuZWwtY29sbGFwc2VkJyk7CiAgICAgICAgdGhpcy5lbC5kb20uc3R5bGUubGVmdCA9IHRoaXMucmVzdG9yZUxUWzBdOwogICAgICAgIHRoaXMuZWwuZG9tLnN0eWxlLnRvcCA9IHRoaXMucmVzdG9yZUxUWzFdOwoKICAgICAgICB2YXIgdHMgPSB0aGlzLnBhbmVsLnRvb2xzOwogICAgICAgIGlmKHRzICYmIHRzLnRvZ2dsZSl7CiAgICAgICAgICAgIHRzLnRvZ2dsZS5zaG93KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNsaWRlSW4gOiBmdW5jdGlvbihjYil7CiAgICAgICAgaWYoIXRoaXMuaXNTbGlkIHx8IHRoaXMuZWwuaGFzQWN0aXZlRngoKSl7CiAgICAgICAgICAgIEV4dC5jYWxsYmFjayhjYik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5pc1NsaWQgPSBmYWxzZTsKICAgICAgICBpZih0aGlzLmFuaW1GbG9hdCAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLmJlZm9yZVNsaWRlKCk7CiAgICAgICAgICAgIHRoaXMuZWwuc2xpZGVPdXQodGhpcy5nZXRTbGlkZUFuY2hvcigpLCB7CiAgICAgICAgICAgICAgICBjYWxsYmFjazogZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFmdGVyU2xpZGUoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFmdGVyU2xpZGVJbigpOwogICAgICAgICAgICAgICAgICAgIEV4dC5jYWxsYmFjayhjYik7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgICAgICBibG9jazogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5lbC5oaWRlKCk7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJTbGlkZUluKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNsaWRlSW5JZiA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKCFlLndpdGhpbih0aGlzLmVsKSl7CiAgICAgICAgICAgIHRoaXMuc2xpZGVJbigpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhbmNob3JzIDogewogICAgICAgICJ3ZXN0IiA6ICJsZWZ0IiwKICAgICAgICAiZWFzdCIgOiAicmlnaHQiLAogICAgICAgICJub3J0aCIgOiAidG9wIiwKICAgICAgICAic291dGgiIDogImJvdHRvbSIKICAgIH0sCgogICAgCiAgICBzYW5jaG9ycyA6IHsKICAgICAgICAid2VzdCIgOiAibCIsCiAgICAgICAgImVhc3QiIDogInIiLAogICAgICAgICJub3J0aCIgOiAidCIsCiAgICAgICAgInNvdXRoIiA6ICJiIgogICAgfSwKCiAgICAKICAgIGNhbmNob3JzIDogewogICAgICAgICJ3ZXN0IiA6ICJ0bC10ciIsCiAgICAgICAgImVhc3QiIDogInRyLXRsIiwKICAgICAgICAibm9ydGgiIDogInRsLWJsIiwKICAgICAgICAic291dGgiIDogImJsLXRsIgogICAgfSwKCiAgICAKICAgIGdldEFuY2hvciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYW5jaG9yc1t0aGlzLnBvc2l0aW9uXTsKICAgIH0sCgogICAgCiAgICBnZXRDb2xsYXBzZUFuY2hvciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuY2FuY2hvcnNbdGhpcy5wb3NpdGlvbl07CiAgICB9LAoKICAgIAogICAgZ2V0U2xpZGVBbmNob3IgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnNhbmNob3JzW3RoaXMucG9zaXRpb25dOwogICAgfSwKCiAgICAKICAgIGdldEFsaWduQWRqIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY20gPSB0aGlzLmNtYXJnaW5zOwogICAgICAgIHN3aXRjaCh0aGlzLnBvc2l0aW9uKXsKICAgICAgICAgICAgY2FzZSAid2VzdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gWzAsIDBdOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZWFzdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gWzAsIDBdOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAibm9ydGgiOgogICAgICAgICAgICAgICAgcmV0dXJuIFswLCAwXTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNvdXRoIjoKICAgICAgICAgICAgICAgIHJldHVybiBbMCwgMF07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRFeHBhbmRBZGogOiBmdW5jdGlvbigpewogICAgICAgIHZhciBjID0gdGhpcy5jb2xsYXBzZWRFbCwgY20gPSB0aGlzLmNtYXJnaW5zOwogICAgICAgIHN3aXRjaCh0aGlzLnBvc2l0aW9uKXsKICAgICAgICAgICAgY2FzZSAid2VzdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gWy0oY20ucmlnaHQrYy5nZXRXaWR0aCgpK2NtLmxlZnQpLCAwXTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImVhc3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIFtjbS5yaWdodCtjLmdldFdpZHRoKCkrY20ubGVmdCwgMF07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJub3J0aCI6CiAgICAgICAgICAgICAgICByZXR1cm4gWzAsIC0oY20udG9wK2NtLmJvdHRvbStjLmdldEhlaWdodCgpKV07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3V0aCI6CiAgICAgICAgICAgICAgICByZXR1cm4gWzAsIGNtLnRvcCtjbS5ib3R0b20rYy5nZXRIZWlnaHQoKV07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0sCgogICAgZGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMuYXV0b0hpZGVTbGlkZVRhc2sgJiYgdGhpcy5hdXRvSGlkZVNsaWRlVGFzay5jYW5jZWwpewogICAgICAgICAgICB0aGlzLmF1dG9IaWRlU2xpZGVUYXNrLmNhbmNlbCgpOwogICAgICAgIH0KICAgICAgICBFeHQuZGVzdHJveU1lbWJlcnModGhpcywgJ21pbmlDb2xsYXBzZWRFbCcsICdjb2xsYXBzZWRFbCcsICdleHBhbmRUb29sRWwnKTsKICAgIH0KfTsKCgpFeHQubGF5b3V0LkJvcmRlckxheW91dC5TcGxpdFJlZ2lvbiA9IGZ1bmN0aW9uKGxheW91dCwgY29uZmlnLCBwb3MpewogICAgRXh0LmxheW91dC5Cb3JkZXJMYXlvdXQuU3BsaXRSZWdpb24uc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGxheW91dCwgY29uZmlnLCBwb3MpOwogICAgCiAgICB0aGlzLmFwcGx5TGF5b3V0ID0gdGhpcy5hcHBseUZuc1twb3NdOwp9OwoKRXh0LmV4dGVuZChFeHQubGF5b3V0LkJvcmRlckxheW91dC5TcGxpdFJlZ2lvbiwgRXh0LmxheW91dC5Cb3JkZXJMYXlvdXQuUmVnaW9uLCB7CiAgICAKICAgIAogICAgc3BsaXRUaXAgOiAiRHJhZyB0byByZXNpemUuIiwKICAgIAogICAgY29sbGFwc2libGVTcGxpdFRpcCA6ICJEcmFnIHRvIHJlc2l6ZS4gRG91YmxlIGNsaWNrIHRvIGhpZGUuIiwKICAgIAogICAgdXNlU3BsaXRUaXBzIDogZmFsc2UsCgogICAgCiAgICBzcGxpdFNldHRpbmdzIDogewogICAgICAgIG5vcnRoIDogewogICAgICAgICAgICBvcmllbnRhdGlvbjogRXh0LlNwbGl0QmFyLlZFUlRJQ0FMLAogICAgICAgICAgICBwbGFjZW1lbnQ6IEV4dC5TcGxpdEJhci5UT1AsCiAgICAgICAgICAgIG1heEZuIDogJ2dldFZNYXhTaXplJywKICAgICAgICAgICAgbWluUHJvcDogJ21pbkhlaWdodCcsCiAgICAgICAgICAgIG1heFByb3A6ICdtYXhIZWlnaHQnCiAgICAgICAgfSwKICAgICAgICBzb3V0aCA6IHsKICAgICAgICAgICAgb3JpZW50YXRpb246IEV4dC5TcGxpdEJhci5WRVJUSUNBTCwKICAgICAgICAgICAgcGxhY2VtZW50OiBFeHQuU3BsaXRCYXIuQk9UVE9NLAogICAgICAgICAgICBtYXhGbiA6ICdnZXRWTWF4U2l6ZScsCiAgICAgICAgICAgIG1pblByb3A6ICdtaW5IZWlnaHQnLAogICAgICAgICAgICBtYXhQcm9wOiAnbWF4SGVpZ2h0JwogICAgICAgIH0sCiAgICAgICAgZWFzdCA6IHsKICAgICAgICAgICAgb3JpZW50YXRpb246IEV4dC5TcGxpdEJhci5IT1JJWk9OVEFMLAogICAgICAgICAgICBwbGFjZW1lbnQ6IEV4dC5TcGxpdEJhci5SSUdIVCwKICAgICAgICAgICAgbWF4Rm4gOiAnZ2V0SE1heFNpemUnLAogICAgICAgICAgICBtaW5Qcm9wOiAnbWluV2lkdGgnLAogICAgICAgICAgICBtYXhQcm9wOiAnbWF4V2lkdGgnCiAgICAgICAgfSwKICAgICAgICB3ZXN0IDogewogICAgICAgICAgICBvcmllbnRhdGlvbjogRXh0LlNwbGl0QmFyLkhPUklaT05UQUwsCiAgICAgICAgICAgIHBsYWNlbWVudDogRXh0LlNwbGl0QmFyLkxFRlQsCiAgICAgICAgICAgIG1heEZuIDogJ2dldEhNYXhTaXplJywKICAgICAgICAgICAgbWluUHJvcDogJ21pbldpZHRoJywKICAgICAgICAgICAgbWF4UHJvcDogJ21heFdpZHRoJwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhcHBseUZucyA6IHsKICAgICAgICB3ZXN0IDogZnVuY3Rpb24oYm94KXsKICAgICAgICAgICAgaWYodGhpcy5pc0NvbGxhcHNlZCl7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseUxheW91dENvbGxhcHNlZChib3gpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzZCA9IHRoaXMuc3BsaXRFbC5kb20sIHMgPSBzZC5zdHlsZTsKICAgICAgICAgICAgdGhpcy5wYW5lbC5zZXRQb3NpdGlvbihib3gueCwgYm94LnkpOwogICAgICAgICAgICB2YXIgc3cgPSBzZC5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgcy5sZWZ0ID0gKGJveC54K2JveC53aWR0aC1zdykrJ3B4JzsKICAgICAgICAgICAgcy50b3AgPSAoYm94LnkpKydweCc7CiAgICAgICAgICAgIHMuaGVpZ2h0ID0gTWF0aC5tYXgoMCwgYm94LmhlaWdodCkrJ3B4JzsKICAgICAgICAgICAgdGhpcy5wYW5lbC5zZXRTaXplKGJveC53aWR0aC1zdywgYm94LmhlaWdodCk7CiAgICAgICAgfSwKICAgICAgICBlYXN0IDogZnVuY3Rpb24oYm94KXsKICAgICAgICAgICAgaWYodGhpcy5pc0NvbGxhcHNlZCl7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseUxheW91dENvbGxhcHNlZChib3gpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzZCA9IHRoaXMuc3BsaXRFbC5kb20sIHMgPSBzZC5zdHlsZTsKICAgICAgICAgICAgdmFyIHN3ID0gc2Qub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgIHRoaXMucGFuZWwuc2V0UG9zaXRpb24oYm94Lngrc3csIGJveC55KTsKICAgICAgICAgICAgcy5sZWZ0ID0gKGJveC54KSsncHgnOwogICAgICAgICAgICBzLnRvcCA9IChib3gueSkrJ3B4JzsKICAgICAgICAgICAgcy5oZWlnaHQgPSBNYXRoLm1heCgwLCBib3guaGVpZ2h0KSsncHgnOwogICAgICAgICAgICB0aGlzLnBhbmVsLnNldFNpemUoYm94LndpZHRoLXN3LCBib3guaGVpZ2h0KTsKICAgICAgICB9LAogICAgICAgIG5vcnRoIDogZnVuY3Rpb24oYm94KXsKICAgICAgICAgICAgaWYodGhpcy5pc0NvbGxhcHNlZCl7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseUxheW91dENvbGxhcHNlZChib3gpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzZCA9IHRoaXMuc3BsaXRFbC5kb20sIHMgPSBzZC5zdHlsZTsKICAgICAgICAgICAgdmFyIHNoID0gc2Qub2Zmc2V0SGVpZ2h0OwogICAgICAgICAgICB0aGlzLnBhbmVsLnNldFBvc2l0aW9uKGJveC54LCBib3gueSk7CiAgICAgICAgICAgIHMubGVmdCA9IChib3gueCkrJ3B4JzsKICAgICAgICAgICAgcy50b3AgPSAoYm94LnkrYm94LmhlaWdodC1zaCkrJ3B4JzsKICAgICAgICAgICAgcy53aWR0aCA9IE1hdGgubWF4KDAsIGJveC53aWR0aCkrJ3B4JzsKICAgICAgICAgICAgdGhpcy5wYW5lbC5zZXRTaXplKGJveC53aWR0aCwgYm94LmhlaWdodC1zaCk7CiAgICAgICAgfSwKICAgICAgICBzb3V0aCA6IGZ1bmN0aW9uKGJveCl7CiAgICAgICAgICAgIGlmKHRoaXMuaXNDb2xsYXBzZWQpewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlMYXlvdXRDb2xsYXBzZWQoYm94KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2QgPSB0aGlzLnNwbGl0RWwuZG9tLCBzID0gc2Quc3R5bGU7CiAgICAgICAgICAgIHZhciBzaCA9IHNkLm9mZnNldEhlaWdodDsKICAgICAgICAgICAgdGhpcy5wYW5lbC5zZXRQb3NpdGlvbihib3gueCwgYm94Lnkrc2gpOwogICAgICAgICAgICBzLmxlZnQgPSAoYm94LngpKydweCc7CiAgICAgICAgICAgIHMudG9wID0gKGJveC55KSsncHgnOwogICAgICAgICAgICBzLndpZHRoID0gTWF0aC5tYXgoMCwgYm94LndpZHRoKSsncHgnOwogICAgICAgICAgICB0aGlzLnBhbmVsLnNldFNpemUoYm94LndpZHRoLCBib3guaGVpZ2h0LXNoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVuZGVyIDogZnVuY3Rpb24oY3QsIHApewogICAgICAgIEV4dC5sYXlvdXQuQm9yZGVyTGF5b3V0LlNwbGl0UmVnaW9uLnN1cGVyY2xhc3MucmVuZGVyLmNhbGwodGhpcywgY3QsIHApOwoKICAgICAgICB2YXIgcHMgPSB0aGlzLnBvc2l0aW9uOwoKICAgICAgICB0aGlzLnNwbGl0RWwgPSBjdC5jcmVhdGVDaGlsZCh7CiAgICAgICAgICAgIGNsczogIngtbGF5b3V0LXNwbGl0IHgtbGF5b3V0LXNwbGl0LSIrcHMsIGh0bWw6ICImIzE2MDsiLAogICAgICAgICAgICBpZDogdGhpcy5wYW5lbC5pZCArICcteHNwbGl0JwogICAgICAgIH0pOwoKICAgICAgICBpZih0aGlzLmNvbGxhcHNlTW9kZSA9PSAnbWluaScpewogICAgICAgICAgICB0aGlzLm1pbmlTcGxpdEVsID0gdGhpcy5zcGxpdEVsLmNyZWF0ZUNoaWxkKHsKICAgICAgICAgICAgICAgIGNsczogIngtbGF5b3V0LW1pbmkgeC1sYXlvdXQtbWluaS0iK3BzLCBodG1sOiAiJiMxNjA7IgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5taW5pU3BsaXRFbC5hZGRDbGFzc09uT3ZlcigneC1sYXlvdXQtbWluaS1vdmVyJyk7CiAgICAgICAgICAgIHRoaXMubWluaVNwbGl0RWwub24oJ2NsaWNrJywgdGhpcy5vbkNvbGxhcHNlQ2xpY2ssIHRoaXMsIHtzdG9wRXZlbnQ6dHJ1ZX0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIHMgPSB0aGlzLnNwbGl0U2V0dGluZ3NbcHNdOwoKICAgICAgICB0aGlzLnNwbGl0ID0gbmV3IEV4dC5TcGxpdEJhcih0aGlzLnNwbGl0RWwuZG9tLCBwLmVsLCBzLm9yaWVudGF0aW9uKTsKICAgICAgICB0aGlzLnNwbGl0LnRpY2tTaXplID0gdGhpcy50aWNrU2l6ZTsKICAgICAgICB0aGlzLnNwbGl0LnBsYWNlbWVudCA9IHMucGxhY2VtZW50OwogICAgICAgIHRoaXMuc3BsaXQuZ2V0TWF4aW11bVNpemUgPSB0aGlzW3MubWF4Rm5dLmNyZWF0ZURlbGVnYXRlKHRoaXMpOwogICAgICAgIHRoaXMuc3BsaXQubWluU2l6ZSA9IHRoaXMubWluU2l6ZSB8fCB0aGlzW3MubWluUHJvcF07CiAgICAgICAgdGhpcy5zcGxpdC5vbigiYmVmb3JlYXBwbHkiLCB0aGlzLm9uU3BsaXRNb3ZlLCB0aGlzKTsKICAgICAgICB0aGlzLnNwbGl0LnVzZVNoaW0gPSB0aGlzLnVzZVNoaW0gPT09IHRydWU7CiAgICAgICAgdGhpcy5tYXhTaXplID0gdGhpcy5tYXhTaXplIHx8IHRoaXNbcy5tYXhQcm9wXTsKCiAgICAgICAgaWYocC5oaWRkZW4pewogICAgICAgICAgICB0aGlzLnNwbGl0RWwuaGlkZSgpOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy51c2VTcGxpdFRpcHMpewogICAgICAgICAgICB0aGlzLnNwbGl0RWwuZG9tLnRpdGxlID0gdGhpcy5jb2xsYXBzaWJsZSA/IHRoaXMuY29sbGFwc2libGVTcGxpdFRpcCA6IHRoaXMuc3BsaXRUaXA7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuY29sbGFwc2libGUpewogICAgICAgICAgICB0aGlzLnNwbGl0RWwub24oImRibGNsaWNrIiwgdGhpcy5vbkNvbGxhcHNlQ2xpY2ssICB0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0U2l6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5pc0NvbGxhcHNlZCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbGxhcHNlZEVsLmdldFNpemUoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHMgPSB0aGlzLnBhbmVsLmdldFNpemUoKTsKICAgICAgICBpZih0aGlzLnBvc2l0aW9uID09ICdub3J0aCcgfHwgdGhpcy5wb3NpdGlvbiA9PSAnc291dGgnKXsKICAgICAgICAgICAgcy5oZWlnaHQgKz0gdGhpcy5zcGxpdEVsLmRvbS5vZmZzZXRIZWlnaHQ7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHMud2lkdGggKz0gdGhpcy5zcGxpdEVsLmRvbS5vZmZzZXRXaWR0aDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHM7CiAgICB9LAoKICAgIAogICAgZ2V0SE1heFNpemUgOiBmdW5jdGlvbigpewogICAgICAgICB2YXIgY21heCA9IHRoaXMubWF4U2l6ZSB8fCAxMDAwMDsKICAgICAgICAgdmFyIGNlbnRlciA9IHRoaXMubGF5b3V0LmNlbnRlcjsKICAgICAgICAgcmV0dXJuIE1hdGgubWluKGNtYXgsICh0aGlzLmVsLmdldFdpZHRoKCkrY2VudGVyLmVsLmdldFdpZHRoKCkpLWNlbnRlci5nZXRNaW5XaWR0aCgpKTsKICAgIH0sCgogICAgCiAgICBnZXRWTWF4U2l6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGNtYXggPSB0aGlzLm1heFNpemUgfHwgMTAwMDA7CiAgICAgICAgdmFyIGNlbnRlciA9IHRoaXMubGF5b3V0LmNlbnRlcjsKICAgICAgICByZXR1cm4gTWF0aC5taW4oY21heCwgKHRoaXMuZWwuZ2V0SGVpZ2h0KCkrY2VudGVyLmVsLmdldEhlaWdodCgpKS1jZW50ZXIuZ2V0TWluSGVpZ2h0KCkpOwogICAgfSwKCiAgICAKICAgIG9uU3BsaXRNb3ZlIDogZnVuY3Rpb24oc3BsaXQsIG5ld1NpemUpewogICAgICAgIHZhciBzID0gdGhpcy5wYW5lbC5nZXRTaXplKCk7CiAgICAgICAgdGhpcy5sYXN0U3BsaXRTaXplID0gbmV3U2l6ZTsKICAgICAgICBpZih0aGlzLnBvc2l0aW9uID09ICdub3J0aCcgfHwgdGhpcy5wb3NpdGlvbiA9PSAnc291dGgnKXsKICAgICAgICAgICAgdGhpcy5wYW5lbC5zZXRTaXplKHMud2lkdGgsIG5ld1NpemUpOwogICAgICAgICAgICB0aGlzLnN0YXRlLmhlaWdodCA9IG5ld1NpemU7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMucGFuZWwuc2V0U2l6ZShuZXdTaXplLCBzLmhlaWdodCk7CiAgICAgICAgICAgIHRoaXMuc3RhdGUud2lkdGggPSBuZXdTaXplOwogICAgICAgIH0KICAgICAgICB0aGlzLmxheW91dC5sYXlvdXQoKTsKICAgICAgICB0aGlzLnBhbmVsLnNhdmVTdGF0ZSgpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgCiAgICBnZXRTcGxpdEJhciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuc3BsaXQ7CiAgICB9LAoKICAgIAogICAgZGVzdHJveSA6IGZ1bmN0aW9uKCkgewogICAgICAgIEV4dC5kZXN0cm95KHRoaXMubWluaVNwbGl0RWwsIHRoaXMuc3BsaXQsIHRoaXMuc3BsaXRFbCk7CiAgICAgICAgRXh0LmxheW91dC5Cb3JkZXJMYXlvdXQuU3BsaXRSZWdpb24uc3VwZXJjbGFzcy5kZXN0cm95LmNhbGwodGhpcyk7CiAgICB9Cn0pOwoKRXh0LkNvbnRhaW5lci5MQVlPVVRTWydib3JkZXInXSA9IEV4dC5sYXlvdXQuQm9yZGVyTGF5b3V0OwoKRXh0LmxheW91dC5Gb3JtTGF5b3V0ID0gRXh0LmV4dGVuZChFeHQubGF5b3V0LkFuY2hvckxheW91dCwgewoKICAgIAogICAgbGFiZWxTZXBhcmF0b3IgOiAnOicsCgogICAgCgogICAgCiAgICB0cmFja0xhYmVsczogdHJ1ZSwKCiAgICB0eXBlOiAnZm9ybScsCgogICAgb25SZW1vdmU6IGZ1bmN0aW9uKGMpewogICAgICAgIEV4dC5sYXlvdXQuRm9ybUxheW91dC5zdXBlcmNsYXNzLm9uUmVtb3ZlLmNhbGwodGhpcywgYyk7CiAgICAgICAgaWYodGhpcy50cmFja0xhYmVscyl7CiAgICAgICAgICAgIGMudW4oJ3Nob3cnLCB0aGlzLm9uRmllbGRTaG93LCB0aGlzKTsKICAgICAgICAgICAgYy51bignaGlkZScsIHRoaXMub25GaWVsZEhpZGUsIHRoaXMpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB2YXIgZWwgPSBjLmdldFBvc2l0aW9uRWwoKSwKICAgICAgICAgICAgY3QgPSBjLmdldEl0ZW1DdCAmJiBjLmdldEl0ZW1DdCgpOwogICAgICAgIGlmIChjLnJlbmRlcmVkICYmIGN0KSB7CiAgICAgICAgICAgIGlmIChlbCAmJiBlbC5kb20pIHsKICAgICAgICAgICAgICAgIGVsLmluc2VydEFmdGVyKGN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFeHQuZGVzdHJveShjdCk7CiAgICAgICAgICAgIEV4dC5kZXN0cm95TWVtYmVycyhjLCAnbGFiZWwnLCAnaXRlbUN0Jyk7CiAgICAgICAgICAgIGlmIChjLmN1c3RvbUl0ZW1DdCkgewogICAgICAgICAgICAgICAgRXh0LmRlc3Ryb3lNZW1iZXJzKGMsICdnZXRJdGVtQ3QnLCAnY3VzdG9tSXRlbUN0Jyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0Q29udGFpbmVyIDogZnVuY3Rpb24oY3QpewogICAgICAgIEV4dC5sYXlvdXQuRm9ybUxheW91dC5zdXBlcmNsYXNzLnNldENvbnRhaW5lci5jYWxsKHRoaXMsIGN0KTsKICAgICAgICBpZihjdC5sYWJlbEFsaWduKXsKICAgICAgICAgICAgY3QuYWRkQ2xhc3MoJ3gtZm9ybS1sYWJlbC0nK2N0LmxhYmVsQWxpZ24pOwogICAgICAgIH0KCiAgICAgICAgaWYoY3QuaGlkZUxhYmVscyl7CiAgICAgICAgICAgIEV4dC5hcHBseSh0aGlzLCB7CiAgICAgICAgICAgICAgICBsYWJlbFN0eWxlOiAnZGlzcGxheTpub25lJywKICAgICAgICAgICAgICAgIGVsZW1lbnRTdHlsZTogJ3BhZGRpbmctbGVmdDowOycsCiAgICAgICAgICAgICAgICBsYWJlbEFkanVzdDogMAogICAgICAgICAgICB9KTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5sYWJlbFNlcGFyYXRvciA9IEV4dC5pc0RlZmluZWQoY3QubGFiZWxTZXBhcmF0b3IpID8gY3QubGFiZWxTZXBhcmF0b3IgOiB0aGlzLmxhYmVsU2VwYXJhdG9yOwogICAgICAgICAgICBjdC5sYWJlbFdpZHRoID0gY3QubGFiZWxXaWR0aCB8fCAxMDA7CiAgICAgICAgICAgIGlmKEV4dC5pc051bWJlcihjdC5sYWJlbFdpZHRoKSl7CiAgICAgICAgICAgICAgICB2YXIgcGFkID0gRXh0LmlzTnVtYmVyKGN0LmxhYmVsUGFkKSA/IGN0LmxhYmVsUGFkIDogNTsKICAgICAgICAgICAgICAgIEV4dC5hcHBseSh0aGlzLCB7CiAgICAgICAgICAgICAgICAgICAgbGFiZWxBZGp1c3Q6IGN0LmxhYmVsV2lkdGggKyBwYWQsCiAgICAgICAgICAgICAgICAgICAgbGFiZWxTdHlsZTogJ3dpZHRoOicgKyBjdC5sYWJlbFdpZHRoICsgJ3B4OycsCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudFN0eWxlOiAncGFkZGluZy1sZWZ0OicgKyAoY3QubGFiZWxXaWR0aCArIHBhZCkgKyAncHgnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihjdC5sYWJlbEFsaWduID09ICd0b3AnKXsKICAgICAgICAgICAgICAgIEV4dC5hcHBseSh0aGlzLCB7CiAgICAgICAgICAgICAgICAgICAgbGFiZWxTdHlsZTogJ3dpZHRoOmF1dG87JywKICAgICAgICAgICAgICAgICAgICBsYWJlbEFkanVzdDogMCwKICAgICAgICAgICAgICAgICAgICBlbGVtZW50U3R5bGU6ICdwYWRkaW5nLWxlZnQ6MDsnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBpc0hpZGU6IGZ1bmN0aW9uKGMpewogICAgICAgIHJldHVybiBjLmhpZGVMYWJlbCB8fCB0aGlzLmNvbnRhaW5lci5oaWRlTGFiZWxzOwogICAgfSwKCiAgICBvbkZpZWxkU2hvdzogZnVuY3Rpb24oYyl7CiAgICAgICAgYy5nZXRJdGVtQ3QoKS5yZW1vdmVDbGFzcygneC1oaWRlLScgKyBjLmhpZGVNb2RlKTsKCiAgICAgICAgCiAgICAgICAgaWYgKGMuaXNDb21wb3NpdGUpIHsKICAgICAgICAgICAgYy5kb0xheW91dCgpOwogICAgICAgIH0KICAgIH0sCgogICAgb25GaWVsZEhpZGU6IGZ1bmN0aW9uKGMpewogICAgICAgIGMuZ2V0SXRlbUN0KCkuYWRkQ2xhc3MoJ3gtaGlkZS0nICsgYy5oaWRlTW9kZSk7CiAgICB9LAoKICAgIAogICAgZ2V0TGFiZWxTdHlsZTogZnVuY3Rpb24ocyl7CiAgICAgICAgdmFyIGxzID0gJycsIGl0ZW1zID0gW3RoaXMubGFiZWxTdHlsZSwgc107CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGl0ZW1zLmxlbmd0aDsgaSA8IGxlbjsgKytpKXsKICAgICAgICAgICAgaWYgKGl0ZW1zW2ldKXsKICAgICAgICAgICAgICAgIGxzICs9IGl0ZW1zW2ldOwogICAgICAgICAgICAgICAgaWYgKGxzLnN1YnN0cigtMSwgMSkgIT0gJzsnKXsKICAgICAgICAgICAgICAgICAgICBscyArPSAnOyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxzOwogICAgfSwKCiAgICAKCiAgICAKICAgIHJlbmRlckl0ZW0gOiBmdW5jdGlvbihjLCBwb3NpdGlvbiwgdGFyZ2V0KXsKICAgICAgICBpZihjICYmIChjLmlzRm9ybUZpZWxkIHx8IGMuZmllbGRMYWJlbCkgJiYgYy5pbnB1dFR5cGUgIT0gJ2hpZGRlbicpewogICAgICAgICAgICB2YXIgYXJncyA9IHRoaXMuZ2V0VGVtcGxhdGVBcmdzKGMpOwogICAgICAgICAgICBpZihFeHQuaXNOdW1iZXIocG9zaXRpb24pKXsKICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gdGFyZ2V0LmRvbS5jaGlsZE5vZGVzW3Bvc2l0aW9uXSB8fCBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHBvc2l0aW9uKXsKICAgICAgICAgICAgICAgIGMuaXRlbUN0ID0gdGhpcy5maWVsZFRwbC5pbnNlcnRCZWZvcmUocG9zaXRpb24sIGFyZ3MsIHRydWUpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGMuaXRlbUN0ID0gdGhpcy5maWVsZFRwbC5hcHBlbmQodGFyZ2V0LCBhcmdzLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighYy5nZXRJdGVtQ3QpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIEV4dC5hcHBseShjLCB7CiAgICAgICAgICAgICAgICAgICAgZ2V0SXRlbUN0OiBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYy5pdGVtQ3Q7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBjdXN0b21JdGVtQ3Q6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGMubGFiZWwgPSBjLmdldEl0ZW1DdCgpLmNoaWxkKCdsYWJlbC54LWZvcm0taXRlbS1sYWJlbCcpOwogICAgICAgICAgICBpZighYy5yZW5kZXJlZCl7CiAgICAgICAgICAgICAgICBjLnJlbmRlcigneC1mb3JtLWVsLScgKyBjLmlkKTsKICAgICAgICAgICAgfWVsc2UgaWYoIXRoaXMuaXNWYWxpZFBhcmVudChjLCB0YXJnZXQpKXsKICAgICAgICAgICAgICAgIEV4dC5mbHkoJ3gtZm9ybS1lbC0nICsgYy5pZCkuYXBwZW5kQ2hpbGQoYy5nZXRQb3NpdGlvbkVsKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMudHJhY2tMYWJlbHMpewogICAgICAgICAgICAgICAgaWYoYy5oaWRkZW4pewogICAgICAgICAgICAgICAgICAgIHRoaXMub25GaWVsZEhpZGUoYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjLm9uKHsKICAgICAgICAgICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgICAgICAgICBzaG93OiB0aGlzLm9uRmllbGRTaG93LAogICAgICAgICAgICAgICAgICAgIGhpZGU6IHRoaXMub25GaWVsZEhpZGUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY29uZmlndXJlSXRlbShjKTsKICAgICAgICB9ZWxzZSB7CiAgICAgICAgICAgIEV4dC5sYXlvdXQuRm9ybUxheW91dC5zdXBlcmNsYXNzLnJlbmRlckl0ZW0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0VGVtcGxhdGVBcmdzOiBmdW5jdGlvbihmaWVsZCkgewogICAgICAgIHZhciBub0xhYmVsU2VwID0gIWZpZWxkLmZpZWxkTGFiZWwgfHwgZmllbGQuaGlkZUxhYmVsLAogICAgICAgICAgICBpdGVtQ2xzID0gKGZpZWxkLml0ZW1DbHMgfHwgdGhpcy5jb250YWluZXIuaXRlbUNscyB8fCAnJykgKyAoZmllbGQuaGlkZUxhYmVsID8gJyB4LWhpZGUtbGFiZWwnIDogJycpOwoKICAgICAgICAKICAgICAgICBpZiAoRXh0LmlzSUU5ICYmIEV4dC5pc0lFUXVpcmtzICYmIGZpZWxkIGluc3RhbmNlb2YgRXh0LmZvcm0uVGV4dEZpZWxkKSB7CiAgICAgICAgICAgIGl0ZW1DbHMgKz0gJyB4LWlucHV0LXdyYXBwZXInOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaWQgICAgICAgICAgICA6IGZpZWxkLmlkLAogICAgICAgICAgICBsYWJlbCAgICAgICAgIDogZmllbGQuZmllbGRMYWJlbCwKICAgICAgICAgICAgaXRlbUNscyAgICAgICA6IGl0ZW1DbHMsCiAgICAgICAgICAgIGNsZWFyQ2xzICAgICAgOiBmaWVsZC5jbGVhckNscyB8fCAneC1mb3JtLWNsZWFyLWxlZnQnLAogICAgICAgICAgICBsYWJlbFN0eWxlICAgIDogdGhpcy5nZXRMYWJlbFN0eWxlKGZpZWxkLmxhYmVsU3R5bGUpLAogICAgICAgICAgICBlbGVtZW50U3R5bGUgIDogdGhpcy5lbGVtZW50U3R5bGUgfHwgJycsCiAgICAgICAgICAgIGxhYmVsU2VwYXJhdG9yOiBub0xhYmVsU2VwID8gJycgOiAoRXh0LmlzRGVmaW5lZChmaWVsZC5sYWJlbFNlcGFyYXRvcikgPyBmaWVsZC5sYWJlbFNlcGFyYXRvciA6IHRoaXMubGFiZWxTZXBhcmF0b3IpCiAgICAgICAgfTsKICAgIH0sCgogICAgCiAgICBhZGp1c3RXaWR0aEFuY2hvcjogZnVuY3Rpb24odmFsdWUsIGMpewogICAgICAgIGlmKGMubGFiZWwgJiYgIXRoaXMuaXNIaWRlKGMpICYmICh0aGlzLmNvbnRhaW5lci5sYWJlbEFsaWduICE9ICd0b3AnKSl7CiAgICAgICAgICAgIHZhciBhZGp1c3QgPSBFeHQuaXNJRTYgfHwgKEV4dC5pc0lFICYmICFFeHQuaXNTdHJpY3QpOwogICAgICAgICAgICByZXR1cm4gdmFsdWUgLSB0aGlzLmxhYmVsQWRqdXN0ICsgKGFkanVzdCA/IC0zIDogMCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCgogICAgYWRqdXN0SGVpZ2h0QW5jaG9yIDogZnVuY3Rpb24odmFsdWUsIGMpewogICAgICAgIGlmKGMubGFiZWwgJiYgIXRoaXMuaXNIaWRlKGMpICYmICh0aGlzLmNvbnRhaW5lci5sYWJlbEFsaWduID09ICd0b3AnKSl7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSAtIGMubGFiZWwuZ2V0SGVpZ2h0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCgogICAgCiAgICBpc1ZhbGlkUGFyZW50IDogZnVuY3Rpb24oYywgdGFyZ2V0KXsKICAgICAgICByZXR1cm4gdGFyZ2V0ICYmIHRoaXMuY29udGFpbmVyLmdldEVsKCkuY29udGFpbnMoYy5nZXRQb3NpdGlvbkVsKCkpOwogICAgfQoKICAgIAp9KTsKCkV4dC5Db250YWluZXIuTEFZT1VUU1snZm9ybSddID0gRXh0LmxheW91dC5Gb3JtTGF5b3V0OwoKRXh0LmxheW91dC5BY2NvcmRpb25MYXlvdXQgPSBFeHQuZXh0ZW5kKEV4dC5sYXlvdXQuRml0TGF5b3V0LCB7CiAgICAKICAgIGZpbGwgOiB0cnVlLAogICAgCiAgICBhdXRvV2lkdGggOiB0cnVlLAogICAgCiAgICB0aXRsZUNvbGxhcHNlIDogdHJ1ZSwKICAgIAogICAgaGlkZUNvbGxhcHNlVG9vbCA6IGZhbHNlLAogICAgCiAgICBjb2xsYXBzZUZpcnN0IDogZmFsc2UsCiAgICAKICAgIGFuaW1hdGUgOiBmYWxzZSwKICAgIAogICAgc2VxdWVuY2UgOiBmYWxzZSwKICAgIAogICAgYWN0aXZlT25Ub3AgOiBmYWxzZSwKCiAgICB0eXBlOiAnYWNjb3JkaW9uJywKCiAgICByZW5kZXJJdGVtIDogZnVuY3Rpb24oYyl7CiAgICAgICAgaWYodGhpcy5hbmltYXRlID09PSBmYWxzZSl7CiAgICAgICAgICAgIGMuYW5pbUNvbGxhcHNlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGMuY29sbGFwc2libGUgPSB0cnVlOwogICAgICAgIGlmKHRoaXMuYXV0b1dpZHRoKXsKICAgICAgICAgICAgYy5hdXRvV2lkdGggPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnRpdGxlQ29sbGFwc2UpewogICAgICAgICAgICBjLnRpdGxlQ29sbGFwc2UgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmhpZGVDb2xsYXBzZVRvb2wpewogICAgICAgICAgICBjLmhpZGVDb2xsYXBzZVRvb2wgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmNvbGxhcHNlRmlyc3QgIT09IHVuZGVmaW5lZCl7CiAgICAgICAgICAgIGMuY29sbGFwc2VGaXJzdCA9IHRoaXMuY29sbGFwc2VGaXJzdDsKICAgICAgICB9CiAgICAgICAgaWYoIXRoaXMuYWN0aXZlSXRlbSAmJiAhYy5jb2xsYXBzZWQpewogICAgICAgICAgICB0aGlzLnNldEFjdGl2ZUl0ZW0oYywgdHJ1ZSk7CiAgICAgICAgfWVsc2UgaWYodGhpcy5hY3RpdmVJdGVtICYmIHRoaXMuYWN0aXZlSXRlbSAhPSBjKXsKICAgICAgICAgICAgYy5jb2xsYXBzZWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBFeHQubGF5b3V0LkFjY29yZGlvbkxheW91dC5zdXBlcmNsYXNzLnJlbmRlckl0ZW0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICBjLmhlYWRlci5hZGRDbGFzcygneC1hY2NvcmRpb24taGQnKTsKICAgICAgICBjLm9uKCdiZWZvcmVleHBhbmQnLCB0aGlzLmJlZm9yZUV4cGFuZCwgdGhpcyk7CiAgICB9LAoKICAgIG9uUmVtb3ZlOiBmdW5jdGlvbihjKXsKICAgICAgICBFeHQubGF5b3V0LkFjY29yZGlvbkxheW91dC5zdXBlcmNsYXNzLm9uUmVtb3ZlLmNhbGwodGhpcywgYyk7CiAgICAgICAgaWYoYy5yZW5kZXJlZCl7CiAgICAgICAgICAgIGMuaGVhZGVyLnJlbW92ZUNsYXNzKCd4LWFjY29yZGlvbi1oZCcpOwogICAgICAgIH0KICAgICAgICBjLnVuKCdiZWZvcmVleHBhbmQnLCB0aGlzLmJlZm9yZUV4cGFuZCwgdGhpcyk7CiAgICB9LAoKICAgIAogICAgYmVmb3JlRXhwYW5kIDogZnVuY3Rpb24ocCwgYW5pbSl7CiAgICAgICAgdmFyIGFpID0gdGhpcy5hY3RpdmVJdGVtOwogICAgICAgIGlmKGFpKXsKICAgICAgICAgICAgaWYodGhpcy5zZXF1ZW5jZSl7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5hY3RpdmVJdGVtOwogICAgICAgICAgICAgICAgaWYgKCFhaS5jb2xsYXBzZWQpewogICAgICAgICAgICAgICAgICAgIGFpLmNvbGxhcHNlKHtjYWxsYmFjazpmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICBwLmV4cGFuZChhbmltIHx8IHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0sIHNjb3BlOiB0aGlzfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGFpLmNvbGxhcHNlKHRoaXMuYW5pbWF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5zZXRBY3RpdmUocCk7CiAgICAgICAgaWYodGhpcy5hY3RpdmVPblRvcCl7CiAgICAgICAgICAgIHAuZWwuZG9tLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHAuZWwuZG9tLCBwLmVsLmRvbS5wYXJlbnROb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLmxheW91dCgpOwogICAgfSwKCiAgICAKICAgIHNldEl0ZW1TaXplIDogZnVuY3Rpb24oaXRlbSwgc2l6ZSl7CiAgICAgICAgaWYodGhpcy5maWxsICYmIGl0ZW0pewogICAgICAgICAgICB2YXIgaGggPSAwLCBpLCBjdCA9IHRoaXMuZ2V0UmVuZGVyZWRJdGVtcyh0aGlzLmNvbnRhaW5lciksIGxlbiA9IGN0Lmxlbmd0aCwgcDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgaWYoKHAgPSBjdFtpXSkgIT0gaXRlbSAmJiAhcC5oaWRkZW4pewogICAgICAgICAgICAgICAgICAgIGhoICs9IHAuaGVhZGVyLmdldEhlaWdodCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgc2l6ZS5oZWlnaHQgLT0gaGg7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaXRlbS5zZXRTaXplKHNpemUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRBY3RpdmVJdGVtIDogZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgdGhpcy5zZXRBY3RpdmUoaXRlbSwgdHJ1ZSk7CiAgICB9LAoKICAgIAogICAgc2V0QWN0aXZlIDogZnVuY3Rpb24oaXRlbSwgZXhwYW5kKXsKICAgICAgICB2YXIgYWkgPSB0aGlzLmFjdGl2ZUl0ZW07CiAgICAgICAgaXRlbSA9IHRoaXMuY29udGFpbmVyLmdldENvbXBvbmVudChpdGVtKTsKICAgICAgICBpZihhaSAhPSBpdGVtKXsKICAgICAgICAgICAgaWYoaXRlbS5yZW5kZXJlZCAmJiBpdGVtLmNvbGxhcHNlZCAmJiBleHBhbmQpewogICAgICAgICAgICAgICAgaXRlbS5leHBhbmQoKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBpZihhaSl7CiAgICAgICAgICAgICAgICAgICBhaS5maXJlRXZlbnQoJ2RlYWN0aXZhdGUnLCBhaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUl0ZW0gPSBpdGVtOwogICAgICAgICAgICAgICAgaXRlbS5maXJlRXZlbnQoJ2FjdGl2YXRlJywgaXRlbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0pOwpFeHQuQ29udGFpbmVyLkxBWU9VVFMuYWNjb3JkaW9uID0gRXh0LmxheW91dC5BY2NvcmRpb25MYXlvdXQ7CgoKRXh0LmxheW91dC5BY2NvcmRpb24gPSBFeHQubGF5b3V0LkFjY29yZGlvbkxheW91dDsKRXh0LmxheW91dC5UYWJsZUxheW91dCA9IEV4dC5leHRlbmQoRXh0LmxheW91dC5Db250YWluZXJMYXlvdXQsIHsKICAgIAoKICAgIAogICAgbW9uaXRvclJlc2l6ZTpmYWxzZSwKCiAgICB0eXBlOiAndGFibGUnLAoKICAgIHRhcmdldENsczogJ3gtdGFibGUtbGF5b3V0LWN0JywKCiAgICAKICAgIHRhYmxlQXR0cnM6bnVsbCwKCiAgICAKICAgIHNldENvbnRhaW5lciA6IGZ1bmN0aW9uKGN0KXsKICAgICAgICBFeHQubGF5b3V0LlRhYmxlTGF5b3V0LnN1cGVyY2xhc3Muc2V0Q29udGFpbmVyLmNhbGwodGhpcywgY3QpOwoKICAgICAgICB0aGlzLmN1cnJlbnRSb3cgPSAwOwogICAgICAgIHRoaXMuY3VycmVudENvbHVtbiA9IDA7CiAgICAgICAgdGhpcy5jZWxscyA9IFtdOwogICAgfSwKICAgIAogICAgCiAgICBvbkxheW91dCA6IGZ1bmN0aW9uKGN0LCB0YXJnZXQpewogICAgICAgIHZhciBjcyA9IGN0Lml0ZW1zLml0ZW1zLCBsZW4gPSBjcy5sZW5ndGgsIGMsIGk7CgogICAgICAgIGlmKCF0aGlzLnRhYmxlKXsKICAgICAgICAgICAgdGFyZ2V0LmFkZENsYXNzKCd4LXRhYmxlLWxheW91dC1jdCcpOwoKICAgICAgICAgICAgdGhpcy50YWJsZSA9IHRhcmdldC5jcmVhdGVDaGlsZCgKICAgICAgICAgICAgICAgIEV4dC5hcHBseSh7dGFnOid0YWJsZScsIGNsczoneC10YWJsZS1sYXlvdXQnLCBjZWxsc3BhY2luZzogMCwgY246IHt0YWc6ICd0Ym9keSd9fSwgdGhpcy50YWJsZUF0dHJzKSwgbnVsbCwgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMucmVuZGVyQWxsKGN0LCB0YXJnZXQpOwogICAgfSwKCiAgICAKICAgIGdldFJvdyA6IGZ1bmN0aW9uKGluZGV4KXsKICAgICAgICB2YXIgcm93ID0gdGhpcy50YWJsZS50Qm9kaWVzWzBdLmNoaWxkTm9kZXNbaW5kZXhdOwogICAgICAgIGlmKCFyb3cpewogICAgICAgICAgICByb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpOwogICAgICAgICAgICB0aGlzLnRhYmxlLnRCb2RpZXNbMF0uYXBwZW5kQ2hpbGQocm93KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvdzsKICAgIH0sCgogICAgCiAgICBnZXROZXh0Q2VsbCA6IGZ1bmN0aW9uKGMpewogICAgICAgIHZhciBjZWxsID0gdGhpcy5nZXROZXh0Tm9uU3Bhbih0aGlzLmN1cnJlbnRDb2x1bW4sIHRoaXMuY3VycmVudFJvdyk7CiAgICAgICAgdmFyIGN1ckNvbCA9IHRoaXMuY3VycmVudENvbHVtbiA9IGNlbGxbMF0sIGN1clJvdyA9IHRoaXMuY3VycmVudFJvdyA9IGNlbGxbMV07CiAgICAgICAgZm9yKHZhciByb3dJbmRleCA9IGN1clJvdzsgcm93SW5kZXggPCBjdXJSb3cgKyAoYy5yb3dzcGFuIHx8IDEpOyByb3dJbmRleCsrKXsKICAgICAgICAgICAgaWYoIXRoaXMuY2VsbHNbcm93SW5kZXhdKXsKICAgICAgICAgICAgICAgIHRoaXMuY2VsbHNbcm93SW5kZXhdID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKHZhciBjb2xJbmRleCA9IGN1ckNvbDsgY29sSW5kZXggPCBjdXJDb2wgKyAoYy5jb2xzcGFuIHx8IDEpOyBjb2xJbmRleCsrKXsKICAgICAgICAgICAgICAgIHRoaXMuY2VsbHNbcm93SW5kZXhdW2NvbEluZGV4XSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHRkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGQnKTsKICAgICAgICBpZihjLmNlbGxJZCl7CiAgICAgICAgICAgIHRkLmlkID0gYy5jZWxsSWQ7CiAgICAgICAgfQogICAgICAgIHZhciBjbHMgPSAneC10YWJsZS1sYXlvdXQtY2VsbCc7CiAgICAgICAgaWYoYy5jZWxsQ2xzKXsKICAgICAgICAgICAgY2xzICs9ICcgJyArIGMuY2VsbENsczsKICAgICAgICB9CiAgICAgICAgdGQuY2xhc3NOYW1lID0gY2xzOwogICAgICAgIGlmKGMuY29sc3Bhbil7CiAgICAgICAgICAgIHRkLmNvbFNwYW4gPSBjLmNvbHNwYW47CiAgICAgICAgfQogICAgICAgIGlmKGMucm93c3Bhbil7CiAgICAgICAgICAgIHRkLnJvd1NwYW4gPSBjLnJvd3NwYW47CiAgICAgICAgfQogICAgICAgIHRoaXMuZ2V0Um93KGN1clJvdykuYXBwZW5kQ2hpbGQodGQpOwogICAgICAgIHJldHVybiB0ZDsKICAgIH0sCgogICAgCiAgICBnZXROZXh0Tm9uU3BhbjogZnVuY3Rpb24oY29sSW5kZXgsIHJvd0luZGV4KXsKICAgICAgICB2YXIgY29scyA9IHRoaXMuY29sdW1uczsKICAgICAgICB3aGlsZSgoY29scyAmJiBjb2xJbmRleCA+PSBjb2xzKSB8fCAodGhpcy5jZWxsc1tyb3dJbmRleF0gJiYgdGhpcy5jZWxsc1tyb3dJbmRleF1bY29sSW5kZXhdKSkgewogICAgICAgICAgICBpZihjb2xzICYmIGNvbEluZGV4ID49IGNvbHMpewogICAgICAgICAgICAgICAgcm93SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbEluZGV4ID0gMDsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBjb2xJbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBbY29sSW5kZXgsIHJvd0luZGV4XTsKICAgIH0sCgogICAgCiAgICByZW5kZXJJdGVtIDogZnVuY3Rpb24oYywgcG9zaXRpb24sIHRhcmdldCl7CiAgICAgICAgCiAgICAgICAgaWYoIXRoaXMudGFibGUpewogICAgICAgICAgICB0aGlzLnRhYmxlID0gdGFyZ2V0LmNyZWF0ZUNoaWxkKAogICAgICAgICAgICAgICAgRXh0LmFwcGx5KHt0YWc6J3RhYmxlJywgY2xzOid4LXRhYmxlLWxheW91dCcsIGNlbGxzcGFjaW5nOiAwLCBjbjoge3RhZzogJ3Rib2R5J319LCB0aGlzLnRhYmxlQXR0cnMpLCBudWxsLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgaWYoYyAmJiAhYy5yZW5kZXJlZCl7CiAgICAgICAgICAgIGMucmVuZGVyKHRoaXMuZ2V0TmV4dENlbGwoYykpOwogICAgICAgICAgICB0aGlzLmNvbmZpZ3VyZUl0ZW0oYyk7CiAgICAgICAgfWVsc2UgaWYoYyAmJiAhdGhpcy5pc1ZhbGlkUGFyZW50KGMsIHRhcmdldCkpewogICAgICAgICAgICB2YXIgY29udGFpbmVyID0gdGhpcy5nZXROZXh0Q2VsbChjKTsKICAgICAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShjLmdldFBvc2l0aW9uRWwoKS5kb20sIG51bGwpOwogICAgICAgICAgICBjLmNvbnRhaW5lciA9IEV4dC5nZXQoY29udGFpbmVyKTsKICAgICAgICAgICAgdGhpcy5jb25maWd1cmVJdGVtKGMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBpc1ZhbGlkUGFyZW50IDogZnVuY3Rpb24oYywgdGFyZ2V0KXsKICAgICAgICByZXR1cm4gYy5nZXRQb3NpdGlvbkVsKCkudXAoJ3RhYmxlJywgNSkuZG9tLnBhcmVudE5vZGUgPT09ICh0YXJnZXQuZG9tIHx8IHRhcmdldCk7CiAgICB9LAogICAgCiAgICBkZXN0cm95OiBmdW5jdGlvbigpewogICAgICAgIGRlbGV0ZSB0aGlzLnRhYmxlOwogICAgICAgIEV4dC5sYXlvdXQuVGFibGVMYXlvdXQuc3VwZXJjbGFzcy5kZXN0cm95LmNhbGwodGhpcyk7CiAgICB9CgogICAgCn0pOwoKRXh0LkNvbnRhaW5lci5MQVlPVVRTWyd0YWJsZSddID0gRXh0LmxheW91dC5UYWJsZUxheW91dDsKRXh0LmxheW91dC5BYnNvbHV0ZUxheW91dCA9IEV4dC5leHRlbmQoRXh0LmxheW91dC5BbmNob3JMYXlvdXQsIHsKCiAgICBleHRyYUNsczogJ3gtYWJzLWxheW91dC1pdGVtJywKCiAgICB0eXBlOiAnYWJzb2x1dGUnLAoKICAgIG9uTGF5b3V0IDogZnVuY3Rpb24oY3QsIHRhcmdldCl7CiAgICAgICAgdGFyZ2V0LnBvc2l0aW9uKCk7CiAgICAgICAgdGhpcy5wYWRkaW5nTGVmdCA9IHRhcmdldC5nZXRQYWRkaW5nKCdsJyk7CiAgICAgICAgdGhpcy5wYWRkaW5nVG9wID0gdGFyZ2V0LmdldFBhZGRpbmcoJ3QnKTsKICAgICAgICBFeHQubGF5b3V0LkFic29sdXRlTGF5b3V0LnN1cGVyY2xhc3Mub25MYXlvdXQuY2FsbCh0aGlzLCBjdCwgdGFyZ2V0KTsKICAgIH0sCgogICAgCiAgICBhZGp1c3RXaWR0aEFuY2hvciA6IGZ1bmN0aW9uKHZhbHVlLCBjb21wKXsKICAgICAgICByZXR1cm4gdmFsdWUgPyB2YWx1ZSAtIGNvbXAuZ2V0UG9zaXRpb24odHJ1ZSlbMF0gKyB0aGlzLnBhZGRpbmdMZWZ0IDogdmFsdWU7CiAgICB9LAoKICAgIAogICAgYWRqdXN0SGVpZ2h0QW5jaG9yIDogZnVuY3Rpb24odmFsdWUsIGNvbXApewogICAgICAgIHJldHVybiAgdmFsdWUgPyB2YWx1ZSAtIGNvbXAuZ2V0UG9zaXRpb24odHJ1ZSlbMV0gKyB0aGlzLnBhZGRpbmdUb3AgOiB2YWx1ZTsKICAgIH0KICAgIAp9KTsKRXh0LkNvbnRhaW5lci5MQVlPVVRTWydhYnNvbHV0ZSddID0gRXh0LmxheW91dC5BYnNvbHV0ZUxheW91dDsKCkV4dC5sYXlvdXQuQm94TGF5b3V0ID0gRXh0LmV4dGVuZChFeHQubGF5b3V0LkNvbnRhaW5lckxheW91dCwgewogICAgCiAgICBkZWZhdWx0TWFyZ2lucyA6IHtsZWZ0OjAsdG9wOjAscmlnaHQ6MCxib3R0b206MH0sCiAgICAKICAgIHBhZGRpbmcgOiAnMCcsCiAgICAKICAgIHBhY2sgOiAnc3RhcnQnLAoKICAgIAogICAgbW9uaXRvclJlc2l6ZSA6IHRydWUsCiAgICB0eXBlOiAnYm94JywKICAgIHNjcm9sbE9mZnNldCA6IDAsCiAgICBleHRyYUNscyA6ICd4LWJveC1pdGVtJywKICAgIHRhcmdldENscyA6ICd4LWJveC1sYXlvdXQtY3QnLAogICAgaW5uZXJDbHMgOiAneC1ib3gtaW5uZXInLAoKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBFeHQubGF5b3V0LkJveExheW91dC5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgY29uZmlnKTsKCiAgICAgICAgaWYgKEV4dC5pc1N0cmluZyh0aGlzLmRlZmF1bHRNYXJnaW5zKSkgewogICAgICAgICAgICB0aGlzLmRlZmF1bHRNYXJnaW5zID0gdGhpcy5wYXJzZU1hcmdpbnModGhpcy5kZWZhdWx0TWFyZ2lucyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5vdmVyZmxvd0hhbmRsZXI7CiAgICAgICAgCiAgICAgICAgaWYgKHR5cGVvZiBoYW5kbGVyID09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGhhbmRsZXIgPSB7CiAgICAgICAgICAgICAgICB0eXBlOiBoYW5kbGVyCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciBoYW5kbGVyVHlwZSA9ICdub25lJzsKICAgICAgICBpZiAoaGFuZGxlciAmJiBoYW5kbGVyLnR5cGUgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGhhbmRsZXJUeXBlID0gaGFuZGxlci50eXBlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB2YXIgY29uc3RydWN0b3IgPSBFeHQubGF5b3V0LmJveE92ZXJmbG93W2hhbmRsZXJUeXBlXTsKICAgICAgICBpZiAoY29uc3RydWN0b3JbdGhpcy50eXBlXSkgewogICAgICAgICAgICBjb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yW3RoaXMudHlwZV07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMub3ZlcmZsb3dIYW5kbGVyID0gbmV3IGNvbnN0cnVjdG9yKHRoaXMsIGhhbmRsZXIpOwogICAgfSwKCiAgICAKICAgIG9uTGF5b3V0OiBmdW5jdGlvbihjb250YWluZXIsIHRhcmdldCkgewogICAgICAgIEV4dC5sYXlvdXQuQm94TGF5b3V0LnN1cGVyY2xhc3Mub25MYXlvdXQuY2FsbCh0aGlzLCBjb250YWluZXIsIHRhcmdldCk7CgogICAgICAgIHZhciB0U2l6ZSA9IHRoaXMuZ2V0TGF5b3V0VGFyZ2V0U2l6ZSgpLAogICAgICAgICAgICBpdGVtcyA9IHRoaXMuZ2V0VmlzaWJsZUl0ZW1zKGNvbnRhaW5lciksCiAgICAgICAgICAgIGNhbGNzID0gdGhpcy5jYWxjdWxhdGVDaGlsZEJveGVzKGl0ZW1zLCB0U2l6ZSksCiAgICAgICAgICAgIGJveGVzID0gY2FsY3MuYm94ZXMsCiAgICAgICAgICAgIG1ldGEgID0gY2FsY3MubWV0YTsKICAgICAgICAKICAgICAgICAKICAgICAgICBpZiAodFNpemUud2lkdGggPiAwKSB7CiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5vdmVyZmxvd0hhbmRsZXIsCiAgICAgICAgICAgICAgICBtZXRob2QgID0gbWV0YS50b29OYXJyb3cgPyAnaGFuZGxlT3ZlcmZsb3cnIDogJ2NsZWFyT3ZlcmZsb3cnOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHJlc3VsdHMgPSBoYW5kbGVyW21ldGhvZF0oY2FsY3MsIHRTaXplKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChyZXN1bHRzKSB7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy50YXJnZXRTaXplKSB7CiAgICAgICAgICAgICAgICAgICAgdFNpemUgPSByZXN1bHRzLnRhcmdldFNpemU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChyZXN1bHRzLnJlY2FsY3VsYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbXMgPSB0aGlzLmdldFZpc2libGVJdGVtcyhjb250YWluZXIpOwogICAgICAgICAgICAgICAgICAgIGNhbGNzID0gdGhpcy5jYWxjdWxhdGVDaGlsZEJveGVzKGl0ZW1zLCB0U2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgYm94ZXMgPSBjYWxjcy5ib3hlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICAKICAgICAgICB0aGlzLmxheW91dFRhcmdldExhc3RTaXplID0gdFNpemU7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdGhpcy5jaGlsZEJveENhY2hlID0gY2FsY3M7CiAgICAgICAgCiAgICAgICAgdGhpcy51cGRhdGVJbm5lckN0U2l6ZSh0U2l6ZSwgY2FsY3MpOwogICAgICAgIHRoaXMudXBkYXRlQ2hpbGRCb3hlcyhib3hlcyk7CgogICAgICAgIAogICAgICAgIHRoaXMuaGFuZGxlVGFyZ2V0T3ZlcmZsb3codFNpemUsIGNvbnRhaW5lciwgdGFyZ2V0KTsKICAgIH0sCgogICAgCiAgICB1cGRhdGVDaGlsZEJveGVzOiBmdW5jdGlvbihib3hlcykgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBib3hlcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgYm94ICA9IGJveGVzW2ldLAogICAgICAgICAgICAgICAgY29tcCA9IGJveC5jb21wb25lbnQ7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoYm94LmRpcnR5U2l6ZSkgewogICAgICAgICAgICAgICAgY29tcC5zZXRTaXplKGJveC53aWR0aCwgYm94LmhlaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpc05hTihib3gubGVmdCkgfHwgaXNOYU4oYm94LnRvcCkpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjb21wLnNldFBvc2l0aW9uKGJveC5sZWZ0LCBib3gudG9wKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdXBkYXRlSW5uZXJDdFNpemU6IGZ1bmN0aW9uKHRTaXplLCBjYWxjcykgewogICAgICAgIHZhciBhbGlnbiAgID0gdGhpcy5hbGlnbiwKICAgICAgICAgICAgcGFkZGluZyA9IHRoaXMucGFkZGluZywKICAgICAgICAgICAgd2lkdGggICA9IHRTaXplLndpZHRoLAogICAgICAgICAgICBoZWlnaHQgID0gdFNpemUuaGVpZ2h0OwogICAgICAgIAogICAgICAgIGlmICh0aGlzLnR5cGUgPT0gJ2hib3gnKSB7CiAgICAgICAgICAgIHZhciBpbm5lckN0V2lkdGggID0gd2lkdGgsCiAgICAgICAgICAgICAgICBpbm5lckN0SGVpZ2h0ID0gY2FsY3MubWV0YS5tYXhIZWlnaHQgKyBwYWRkaW5nLnRvcCArIHBhZGRpbmcuYm90dG9tOwoKICAgICAgICAgICAgaWYgKGFsaWduID09ICdzdHJldGNoJykgewogICAgICAgICAgICAgICAgaW5uZXJDdEhlaWdodCA9IGhlaWdodDsKICAgICAgICAgICAgfSBlbHNlIGlmIChhbGlnbiA9PSAnbWlkZGxlJykgewogICAgICAgICAgICAgICAgaW5uZXJDdEhlaWdodCA9IE1hdGgubWF4KGhlaWdodCwgaW5uZXJDdEhlaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgaW5uZXJDdEhlaWdodCA9IGhlaWdodCwKICAgICAgICAgICAgICAgIGlubmVyQ3RXaWR0aCAgPSBjYWxjcy5tZXRhLm1heFdpZHRoICsgcGFkZGluZy5sZWZ0ICsgcGFkZGluZy5yaWdodDsKCiAgICAgICAgICAgIGlmIChhbGlnbiA9PSAnc3RyZXRjaCcpIHsKICAgICAgICAgICAgICAgIGlubmVyQ3RXaWR0aCA9IHdpZHRoOwogICAgICAgICAgICB9IGVsc2UgaWYgKGFsaWduID09ICdjZW50ZXInKSB7CiAgICAgICAgICAgICAgICBpbm5lckN0V2lkdGggPSBNYXRoLm1heCh3aWR0aCwgaW5uZXJDdFdpZHRoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5pbm5lckN0LnNldFNpemUoaW5uZXJDdFdpZHRoIHx8IHVuZGVmaW5lZCwgaW5uZXJDdEhlaWdodCB8fCB1bmRlZmluZWQpOwogICAgfSwKCiAgICAKICAgIGhhbmRsZVRhcmdldE92ZXJmbG93OiBmdW5jdGlvbihwcmV2aW91c1RhcmdldFNpemUsIGNvbnRhaW5lciwgdGFyZ2V0KSB7CiAgICAgICAgdmFyIG92ZXJmbG93ID0gdGFyZ2V0LmdldFN0eWxlKCdvdmVyZmxvdycpOwoKICAgICAgICBpZiAob3ZlcmZsb3cgJiYgb3ZlcmZsb3cgIT0gJ2hpZGRlbicgJiYhdGhpcy5hZGp1c3RtZW50UGFzcykgewogICAgICAgICAgICB2YXIgbmV3VGFyZ2V0U2l6ZSA9IHRoaXMuZ2V0TGF5b3V0VGFyZ2V0U2l6ZSgpOwogICAgICAgICAgICBpZiAobmV3VGFyZ2V0U2l6ZS53aWR0aCAhPSBwcmV2aW91c1RhcmdldFNpemUud2lkdGggfHwgbmV3VGFyZ2V0U2l6ZS5oZWlnaHQgIT0gcHJldmlvdXNUYXJnZXRTaXplLmhlaWdodCl7CiAgICAgICAgICAgICAgICB0aGlzLmFkanVzdG1lbnRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMub25MYXlvdXQoY29udGFpbmVyLCB0YXJnZXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgdGhpcy5hZGp1c3RtZW50UGFzczsKICAgIH0sCgogICAgCiAgICBpc1ZhbGlkUGFyZW50IDogZnVuY3Rpb24oYywgdGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5uZXJDdCAmJiBjLmdldFBvc2l0aW9uRWwoKS5kb20ucGFyZW50Tm9kZSA9PSB0aGlzLmlubmVyQ3QuZG9tOwogICAgfSwKCiAgICAKICAgIGdldFZpc2libGVJdGVtczogZnVuY3Rpb24oY3QpIHsKICAgICAgICB2YXIgY3QgID0gY3QgfHwgdGhpcy5jb250YWluZXIsCiAgICAgICAgICAgIHQgICA9IGN0LmdldExheW91dFRhcmdldCgpLAogICAgICAgICAgICBjdGkgPSBjdC5pdGVtcy5pdGVtcywKICAgICAgICAgICAgbGVuID0gY3RpLmxlbmd0aCwKCiAgICAgICAgICAgIGksIGMsIGl0ZW1zID0gW107CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpZigoYyA9IGN0aVtpXSkucmVuZGVyZWQgJiYgdGhpcy5pc1ZhbGlkUGFyZW50KGMsIHQpICYmIGMuaGlkZGVuICE9PSB0cnVlICAmJiBjLmNvbGxhcHNlZCAhPT0gdHJ1ZSAmJiBjLnNob3VsZExheW91dCAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgaXRlbXMucHVzaChjKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGl0ZW1zOwogICAgfSwKCiAgICAKICAgIHJlbmRlckFsbCA6IGZ1bmN0aW9uKGN0LCB0YXJnZXQpIHsKICAgICAgICBpZiAoIXRoaXMuaW5uZXJDdCkgewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5pbm5lckN0ID0gdGFyZ2V0LmNyZWF0ZUNoaWxkKHtjbHM6dGhpcy5pbm5lckNsc30pOwogICAgICAgICAgICB0aGlzLnBhZGRpbmcgPSB0aGlzLnBhcnNlTWFyZ2lucyh0aGlzLnBhZGRpbmcpOwogICAgICAgIH0KICAgICAgICBFeHQubGF5b3V0LkJveExheW91dC5zdXBlcmNsYXNzLnJlbmRlckFsbC5jYWxsKHRoaXMsIGN0LCB0aGlzLmlubmVyQ3QpOwogICAgfSwKCiAgICBnZXRMYXlvdXRUYXJnZXRTaXplIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuY29udGFpbmVyLmdldExheW91dFRhcmdldCgpLCByZXQ7CiAgICAgICAgCiAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICByZXQgPSB0YXJnZXQuZ2V0Vmlld1NpemUoKTsKCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChFeHQuaXNJRSAmJiBFeHQuaXNTdHJpY3QgJiYgcmV0LndpZHRoID09IDApewogICAgICAgICAgICAgICAgcmV0ID0gIHRhcmdldC5nZXRTdHlsZVNpemUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0LndpZHRoICAtPSB0YXJnZXQuZ2V0UGFkZGluZygnbHInKTsKICAgICAgICAgICAgcmV0LmhlaWdodCAtPSB0YXJnZXQuZ2V0UGFkZGluZygndGInKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0sCgogICAgCiAgICByZW5kZXJJdGVtIDogZnVuY3Rpb24oYykgewogICAgICAgIGlmKEV4dC5pc1N0cmluZyhjLm1hcmdpbnMpKXsKICAgICAgICAgICAgYy5tYXJnaW5zID0gdGhpcy5wYXJzZU1hcmdpbnMoYy5tYXJnaW5zKTsKICAgICAgICB9ZWxzZSBpZighYy5tYXJnaW5zKXsKICAgICAgICAgICAgYy5tYXJnaW5zID0gdGhpcy5kZWZhdWx0TWFyZ2luczsKICAgICAgICB9CiAgICAgICAgRXh0LmxheW91dC5Cb3hMYXlvdXQuc3VwZXJjbGFzcy5yZW5kZXJJdGVtLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgCiAgICAKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIEV4dC5kZXN0cm95KHRoaXMub3ZlcmZsb3dIYW5kbGVyKTsKICAgICAgICAKICAgICAgICBFeHQubGF5b3V0LkJveExheW91dC5zdXBlcmNsYXNzLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KfSk7CgoKCkV4dC5sYXlvdXQuYm94T3ZlcmZsb3cuTm9uZSA9IEV4dC5leHRlbmQoT2JqZWN0LCB7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24obGF5b3V0LCBjb25maWcpIHsKICAgICAgICB0aGlzLmxheW91dCA9IGxheW91dDsKICAgICAgICAKICAgICAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnIHx8IHt9KTsKICAgIH0sCiAgICAKICAgIGhhbmRsZU92ZXJmbG93OiBFeHQuZW1wdHlGbiwKICAgIAogICAgY2xlYXJPdmVyZmxvdzogRXh0LmVtcHR5Rm4KfSk7CgoKRXh0LmxheW91dC5ib3hPdmVyZmxvdy5ub25lID0gRXh0LmxheW91dC5ib3hPdmVyZmxvdy5Ob25lOwoKRXh0LmxheW91dC5ib3hPdmVyZmxvdy5NZW51ID0gRXh0LmV4dGVuZChFeHQubGF5b3V0LmJveE92ZXJmbG93Lk5vbmUsIHsKICAgIAogICAgYWZ0ZXJDbHM6ICd4LXN0cmlwLXJpZ2h0JywKICAgIAogICAgCiAgICBub0l0ZW1zTWVudVRleHQgOiAnPGRpdiBjbGFzcz0ieC10b29sYmFyLW5vLWl0ZW1zIj4oTm9uZSk8L2Rpdj4nLAogICAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24obGF5b3V0KSB7CiAgICAgICAgRXh0LmxheW91dC5ib3hPdmVyZmxvdy5NZW51LnN1cGVyY2xhc3MuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAKICAgICAgICAKICAgICAgICB0aGlzLm1lbnVJdGVtcyA9IFtdOwogICAgfSwKICAgIAogICAgCiAgICBjcmVhdGVJbm5lckVsZW1lbnRzOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuYWZ0ZXJDdCkgewogICAgICAgICAgICB0aGlzLmFmdGVyQ3QgID0gdGhpcy5sYXlvdXQuaW5uZXJDdC5pbnNlcnRTaWJsaW5nKHtjbHM6IHRoaXMuYWZ0ZXJDbHN9LCAgJ2JlZm9yZScpOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgY2xlYXJPdmVyZmxvdzogZnVuY3Rpb24oY2FsY3VsYXRpb25zLCB0YXJnZXRTaXplKSB7CiAgICAgICAgdmFyIG5ld1dpZHRoID0gdGFyZ2V0U2l6ZS53aWR0aCArICh0aGlzLmFmdGVyQ3QgPyB0aGlzLmFmdGVyQ3QuZ2V0V2lkdGgoKSA6IDApLAogICAgICAgICAgICBpdGVtcyAgICA9IHRoaXMubWVudUl0ZW1zOwogICAgICAgIAogICAgICAgIHRoaXMuaGlkZVRyaWdnZXIoKTsKICAgICAgICAKICAgICAgICBmb3IgKHZhciBpbmRleCA9IDAsIGxlbmd0aCA9IGl0ZW1zLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgaXRlbXMucG9wKCkuY29tcG9uZW50LnNob3coKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdGFyZ2V0U2l6ZTogewogICAgICAgICAgICAgICAgaGVpZ2h0OiB0YXJnZXRTaXplLmhlaWdodCwKICAgICAgICAgICAgICAgIHdpZHRoIDogbmV3V2lkdGgKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9LAogICAgCiAgICAKICAgIHNob3dUcmlnZ2VyOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmNyZWF0ZU1lbnUoKTsKICAgICAgICB0aGlzLm1lbnVUcmlnZ2VyLnNob3coKTsKICAgIH0sCiAgICAKICAgIAogICAgaGlkZVRyaWdnZXI6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLm1lbnVUcmlnZ2VyICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICB0aGlzLm1lbnVUcmlnZ2VyLmhpZGUoKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIGJlZm9yZU1lbnVTaG93OiBmdW5jdGlvbihtZW51KSB7CiAgICAgICAgdmFyIGl0ZW1zID0gdGhpcy5tZW51SXRlbXMsCiAgICAgICAgICAgIGxlbiAgID0gaXRlbXMubGVuZ3RoLAogICAgICAgICAgICBpdGVtLAogICAgICAgICAgICBwcmV2OwoKICAgICAgICB2YXIgbmVlZHNTZXAgPSBmdW5jdGlvbihncm91cCwgaXRlbSl7CiAgICAgICAgICAgIHJldHVybiBncm91cC5pc1hUeXBlKCdidXR0b25ncm91cCcpICYmICEoaXRlbSBpbnN0YW5jZW9mIEV4dC5Ub29sYmFyLlNlcGFyYXRvcik7CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICB0aGlzLmNsZWFyTWVudSgpOwogICAgICAgIG1lbnUucmVtb3ZlQWxsKCk7CiAgICAgICAgCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpdGVtID0gaXRlbXNbaV0uY29tcG9uZW50OwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHByZXYgJiYgKG5lZWRzU2VwKGl0ZW0sIHByZXYpIHx8IG5lZWRzU2VwKHByZXYsIGl0ZW0pKSkgewogICAgICAgICAgICAgICAgbWVudS5hZGQoJy0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5hZGRDb21wb25lbnRUb01lbnUobWVudSwgaXRlbSk7CiAgICAgICAgICAgIHByZXYgPSBpdGVtOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYgKG1lbnUuaXRlbXMubGVuZ3RoIDwgMSkgewogICAgICAgICAgICBtZW51LmFkZCh0aGlzLm5vSXRlbXNNZW51VGV4dCk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBjcmVhdGVNZW51Q29uZmlnIDogZnVuY3Rpb24oY29tcG9uZW50LCBoaWRlT25DbGljayl7CiAgICAgICAgdmFyIGNvbmZpZyA9IEV4dC5hcHBseSh7fSwgY29tcG9uZW50LmluaXRpYWxDb25maWcpLAogICAgICAgICAgICBncm91cCAgPSBjb21wb25lbnQudG9nZ2xlR3JvdXA7CgogICAgICAgIEV4dC5jb3B5VG8oY29uZmlnLCBjb21wb25lbnQsIFsKICAgICAgICAgICAgJ2ljb25DbHMnLCAnaWNvbicsICdpdGVtSWQnLCAnZGlzYWJsZWQnLCAnaGFuZGxlcicsICdzY29wZScsICdtZW51JwogICAgICAgIF0pOwoKICAgICAgICBFeHQuYXBwbHkoY29uZmlnLCB7CiAgICAgICAgICAgIHRleHQgICAgICAgOiBjb21wb25lbnQub3ZlcmZsb3dUZXh0IHx8IGNvbXBvbmVudC50ZXh0LAogICAgICAgICAgICBoaWRlT25DbGljazogaGlkZU9uQ2xpY2sKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGdyb3VwIHx8IGNvbXBvbmVudC5lbmFibGVUb2dnbGUpIHsKICAgICAgICAgICAgRXh0LmFwcGx5KGNvbmZpZywgewogICAgICAgICAgICAgICAgZ3JvdXAgIDogZ3JvdXAsCiAgICAgICAgICAgICAgICBjaGVja2VkOiBjb21wb25lbnQucHJlc3NlZCwKICAgICAgICAgICAgICAgIGxpc3RlbmVyczogewogICAgICAgICAgICAgICAgICAgIGNoZWNrY2hhbmdlOiBmdW5jdGlvbihpdGVtLCBjaGVja2VkKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50LnRvZ2dsZShjaGVja2VkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZGVsZXRlIGNvbmZpZy5vd25lckN0OwogICAgICAgIGRlbGV0ZSBjb25maWcueHR5cGU7CiAgICAgICAgZGVsZXRlIGNvbmZpZy5pZDsKCiAgICAgICAgcmV0dXJuIGNvbmZpZzsKICAgIH0sCgogICAgCiAgICBhZGRDb21wb25lbnRUb01lbnUgOiBmdW5jdGlvbihtZW51LCBjb21wb25lbnQpIHsKICAgICAgICBpZiAoY29tcG9uZW50IGluc3RhbmNlb2YgRXh0LlRvb2xiYXIuU2VwYXJhdG9yKSB7CiAgICAgICAgICAgIG1lbnUuYWRkKCctJyk7CgogICAgICAgIH0gZWxzZSBpZiAoRXh0LmlzRnVuY3Rpb24oY29tcG9uZW50LmlzWFR5cGUpKSB7CiAgICAgICAgICAgIGlmIChjb21wb25lbnQuaXNYVHlwZSgnc3BsaXRidXR0b24nKSkgewogICAgICAgICAgICAgICAgbWVudS5hZGQodGhpcy5jcmVhdGVNZW51Q29uZmlnKGNvbXBvbmVudCwgdHJ1ZSkpOwoKICAgICAgICAgICAgfSBlbHNlIGlmIChjb21wb25lbnQuaXNYVHlwZSgnYnV0dG9uJykpIHsKICAgICAgICAgICAgICAgIG1lbnUuYWRkKHRoaXMuY3JlYXRlTWVudUNvbmZpZyhjb21wb25lbnQsICFjb21wb25lbnQubWVudSkpOwoKICAgICAgICAgICAgfSBlbHNlIGlmIChjb21wb25lbnQuaXNYVHlwZSgnYnV0dG9uZ3JvdXAnKSkgewogICAgICAgICAgICAgICAgY29tcG9uZW50Lml0ZW1zLmVhY2goZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkQ29tcG9uZW50VG9NZW51KG1lbnUsIGl0ZW0pOwogICAgICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIGNsZWFyTWVudSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG1lbnUgPSB0aGlzLm1vcmVNZW51OwogICAgICAgIGlmIChtZW51ICYmIG1lbnUuaXRlbXMpIHsKICAgICAgICAgICAgbWVudS5pdGVtcy5lYWNoKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICAgICAgZGVsZXRlIGl0ZW0ubWVudTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBjcmVhdGVNZW51OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMubWVudVRyaWdnZXIpIHsKICAgICAgICAgICAgdGhpcy5jcmVhdGVJbm5lckVsZW1lbnRzKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZW51ID0gbmV3IEV4dC5tZW51Lk1lbnUoewogICAgICAgICAgICAgICAgb3duZXJDdCA6IHRoaXMubGF5b3V0LmNvbnRhaW5lciwKICAgICAgICAgICAgICAgIGxpc3RlbmVyczogewogICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgICAgIGJlZm9yZXNob3c6IHRoaXMuYmVmb3JlTWVudVNob3cKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZW51VHJpZ2dlciA9IG5ldyBFeHQuQnV0dG9uKHsKICAgICAgICAgICAgICAgIGljb25DbHMgOiAneC10b29sYmFyLW1vcmUtaWNvbicsCiAgICAgICAgICAgICAgICBjbHMgICAgIDogJ3gtdG9vbGJhci1tb3JlJywKICAgICAgICAgICAgICAgIG1lbnUgICAgOiB0aGlzLm1lbnUsCiAgICAgICAgICAgICAgICByZW5kZXJUbzogdGhpcy5hZnRlckN0CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy5tZW51LCB0aGlzLm1lbnVUcmlnZ2VyKTsKICAgIH0KfSk7CgpFeHQubGF5b3V0LmJveE92ZXJmbG93Lm1lbnUgPSBFeHQubGF5b3V0LmJveE92ZXJmbG93Lk1lbnU7CgoKCkV4dC5sYXlvdXQuYm94T3ZlcmZsb3cuSG9yaXpvbnRhbE1lbnUgPSBFeHQuZXh0ZW5kKEV4dC5sYXlvdXQuYm94T3ZlcmZsb3cuTWVudSwgewogICAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICAgICAgRXh0LmxheW91dC5ib3hPdmVyZmxvdy5Ib3Jpem9udGFsTWVudS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgCiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgbGF5b3V0ID0gbWUubGF5b3V0LAogICAgICAgICAgICBvcmlnRnVuY3Rpb24gPSBsYXlvdXQuY2FsY3VsYXRlQ2hpbGRCb3hlczsKICAgICAgICAKICAgICAgICBsYXlvdXQuY2FsY3VsYXRlQ2hpbGRCb3hlcyA9IGZ1bmN0aW9uKHZpc2libGVJdGVtcywgdGFyZ2V0U2l6ZSkgewogICAgICAgICAgICB2YXIgY2FsY3MgPSBvcmlnRnVuY3Rpb24uYXBwbHkobGF5b3V0LCBhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgbWV0YSAgPSBjYWxjcy5tZXRhLAogICAgICAgICAgICAgICAgaXRlbXMgPSBtZS5tZW51SXRlbXM7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBoaWRkZW5XaWR0aCA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGluZGV4ID0gMCwgbGVuZ3RoID0gaXRlbXMubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgaGlkZGVuV2lkdGggKz0gaXRlbXNbaW5kZXhdLndpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBtZXRhLm1pbmltdW1XaWR0aCArPSBoaWRkZW5XaWR0aDsKICAgICAgICAgICAgbWV0YS50b29OYXJyb3cgPSBtZXRhLm1pbmltdW1XaWR0aCA+IHRhcmdldFNpemUud2lkdGg7CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gY2FsY3M7CiAgICAgICAgfTsgICAgICAgIAogICAgfSwKICAgIAogICAgaGFuZGxlT3ZlcmZsb3c6IGZ1bmN0aW9uKGNhbGN1bGF0aW9ucywgdGFyZ2V0U2l6ZSkgewogICAgICAgIHRoaXMuc2hvd1RyaWdnZXIoKTsKICAgICAgICAKICAgICAgICB2YXIgbmV3V2lkdGggICAgPSB0YXJnZXRTaXplLndpZHRoIC0gdGhpcy5hZnRlckN0LmdldFdpZHRoKCksCiAgICAgICAgICAgIGJveGVzICAgICAgID0gY2FsY3VsYXRpb25zLmJveGVzLAogICAgICAgICAgICB1c2VkV2lkdGggICA9IDAsCiAgICAgICAgICAgIHJlY2FsY3VsYXRlID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgZm9yICh2YXIgaW5kZXggPSAwLCBsZW5ndGggPSBib3hlcy5sZW5ndGg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICAgIHVzZWRXaWR0aCArPSBib3hlc1tpbmRleF0ud2lkdGg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciBzcGFyZVdpZHRoID0gbmV3V2lkdGggLSB1c2VkV2lkdGgsCiAgICAgICAgICAgIHNob3dDb3VudCAgPSAwOwogICAgICAgIAogICAgICAgIAogICAgICAgIGZvciAodmFyIGluZGV4ID0gMCwgbGVuZ3RoID0gdGhpcy5tZW51SXRlbXMubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICB2YXIgaGlkZGVuID0gdGhpcy5tZW51SXRlbXNbaW5kZXhdLAogICAgICAgICAgICAgICAgY29tcCAgID0gaGlkZGVuLmNvbXBvbmVudCwKICAgICAgICAgICAgICAgIHdpZHRoICA9IGhpZGRlbi53aWR0aDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh3aWR0aCA8IHNwYXJlV2lkdGgpIHsKICAgICAgICAgICAgICAgIGNvbXAuc2hvdygpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzcGFyZVdpZHRoIC09IHdpZHRoOwogICAgICAgICAgICAgICAgc2hvd0NvdW50ICsrOwogICAgICAgICAgICAgICAgcmVjYWxjdWxhdGUgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICBpZiAocmVjYWxjdWxhdGUpIHsKICAgICAgICAgICAgdGhpcy5tZW51SXRlbXMgPSB0aGlzLm1lbnVJdGVtcy5zbGljZShzaG93Q291bnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBib3hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgICAgdmFyIGl0ZW0gID0gYm94ZXNbaV0uY29tcG9uZW50LAogICAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gYm94ZXNbaV0ubGVmdCArIGJveGVzW2ldLndpZHRoOwoKICAgICAgICAgICAgICAgIGlmIChyaWdodCA+PSBuZXdXaWR0aCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubWVudUl0ZW1zLnVuc2hpZnQoewogICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQ6IGl0ZW0sCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoICAgIDogYm94ZXNbaV0ud2lkdGgKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgaXRlbS5oaWRlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLm1lbnVJdGVtcy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICB0aGlzLmhpZGVUcmlnZ2VyKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHRhcmdldFNpemU6IHsKICAgICAgICAgICAgICAgIGhlaWdodDogdGFyZ2V0U2l6ZS5oZWlnaHQsCiAgICAgICAgICAgICAgICB3aWR0aCA6IG5ld1dpZHRoCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlY2FsY3VsYXRlOiByZWNhbGN1bGF0ZQogICAgICAgIH07CiAgICB9Cn0pOwoKRXh0LmxheW91dC5ib3hPdmVyZmxvdy5tZW51Lmhib3ggPSBFeHQubGF5b3V0LmJveE92ZXJmbG93Lkhvcml6b250YWxNZW51OwpFeHQubGF5b3V0LmJveE92ZXJmbG93LlNjcm9sbGVyID0gRXh0LmV4dGVuZChFeHQubGF5b3V0LmJveE92ZXJmbG93Lk5vbmUsIHsKICAgIAogICAgYW5pbWF0ZVNjcm9sbDogdHJ1ZSwKICAgIAogICAgCiAgICBzY3JvbGxJbmNyZW1lbnQ6IDEwMCwKICAgIAogICAgCiAgICB3aGVlbEluY3JlbWVudDogMywKICAgIAogICAgCiAgICBzY3JvbGxSZXBlYXRJbnRlcnZhbDogNDAwLAogICAgCiAgICAKICAgIHNjcm9sbER1cmF0aW9uOiAwLjQsCiAgICAKICAgIAogICAgYmVmb3JlQ2xzOiAneC1zdHJpcC1sZWZ0JywKICAgIAogICAgCiAgICBhZnRlckNsczogJ3gtc3RyaXAtcmlnaHQnLAogICAgCiAgICAKICAgIHNjcm9sbGVyQ2xzOiAneC1zdHJpcC1zY3JvbGxlcicsCiAgICAKICAgIAogICAgYmVmb3JlU2Nyb2xsZXJDbHM6ICd4LXN0cmlwLXNjcm9sbGVyLWxlZnQnLAogICAgCiAgICAKICAgIGFmdGVyU2Nyb2xsZXJDbHM6ICd4LXN0cmlwLXNjcm9sbGVyLXJpZ2h0JywKICAgIAogICAgCiAgICBjcmVhdGVXaGVlbExpc3RlbmVyOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmxheW91dC5pbm5lckN0Lm9uKHsKICAgICAgICAgICAgc2NvcGUgICAgIDogdGhpcywKICAgICAgICAgICAgbW91c2V3aGVlbDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKCiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbEJ5KGUuZ2V0V2hlZWxEZWx0YSgpICogdGhpcy53aGVlbEluY3JlbWVudCAqIC0xLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCiAgICAKICAgIAogICAgaGFuZGxlT3ZlcmZsb3c6IGZ1bmN0aW9uKGNhbGN1bGF0aW9ucywgdGFyZ2V0U2l6ZSkgewogICAgICAgIHRoaXMuY3JlYXRlSW5uZXJFbGVtZW50cygpOwogICAgICAgIHRoaXMuc2hvd1Njcm9sbGVycygpOwogICAgfSwKICAgIAogICAgCiAgICBjbGVhck92ZXJmbG93OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmhpZGVTY3JvbGxlcnMoKTsKICAgIH0sCiAgICAKICAgIAogICAgc2hvd1Njcm9sbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jcmVhdGVTY3JvbGxlcnMoKTsKICAgICAgICAKICAgICAgICB0aGlzLmJlZm9yZVNjcm9sbGVyLnNob3coKTsKICAgICAgICB0aGlzLmFmdGVyU2Nyb2xsZXIuc2hvdygpOwogICAgICAgIAogICAgICAgIHRoaXMudXBkYXRlU2Nyb2xsQnV0dG9ucygpOwogICAgfSwKICAgIAogICAgCiAgICBoaWRlU2Nyb2xsZXJzOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5iZWZvcmVTY3JvbGxlciAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgdGhpcy5iZWZvcmVTY3JvbGxlci5oaWRlKCk7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJTY3JvbGxlci5oaWRlKCk7ICAgICAgICAgIAogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgY3JlYXRlU2Nyb2xsZXJzOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuYmVmb3JlU2Nyb2xsZXIgJiYgIXRoaXMuYWZ0ZXJTY3JvbGxlcikgewogICAgICAgICAgICB2YXIgYmVmb3JlID0gdGhpcy5iZWZvcmVDdC5jcmVhdGVDaGlsZCh7CiAgICAgICAgICAgICAgICBjbHM6IFN0cmluZy5mb3JtYXQoInswfSB7MX0gIiwgdGhpcy5zY3JvbGxlckNscywgdGhpcy5iZWZvcmVTY3JvbGxlckNscykKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgYWZ0ZXIgPSB0aGlzLmFmdGVyQ3QuY3JlYXRlQ2hpbGQoewogICAgICAgICAgICAgICAgY2xzOiBTdHJpbmcuZm9ybWF0KCJ7MH0gezF9IiwgdGhpcy5zY3JvbGxlckNscywgdGhpcy5hZnRlclNjcm9sbGVyQ2xzKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGJlZm9yZS5hZGRDbGFzc09uT3Zlcih0aGlzLmJlZm9yZVNjcm9sbGVyQ2xzICsgJy1ob3ZlcicpOwogICAgICAgICAgICBhZnRlci5hZGRDbGFzc09uT3Zlcih0aGlzLmFmdGVyU2Nyb2xsZXJDbHMgKyAnLWhvdmVyJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBiZWZvcmUuc2V0VmlzaWJpbGl0eU1vZGUoRXh0LkVsZW1lbnQuRElTUExBWSk7CiAgICAgICAgICAgIGFmdGVyLnNldFZpc2liaWxpdHlNb2RlKEV4dC5FbGVtZW50LkRJU1BMQVkpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5iZWZvcmVSZXBlYXRlciA9IG5ldyBFeHQudXRpbC5DbGlja1JlcGVhdGVyKGJlZm9yZSwgewogICAgICAgICAgICAgICAgaW50ZXJ2YWw6IHRoaXMuc2Nyb2xsUmVwZWF0SW50ZXJ2YWwsCiAgICAgICAgICAgICAgICBoYW5kbGVyIDogdGhpcy5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgc2NvcGUgICA6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmFmdGVyUmVwZWF0ZXIgPSBuZXcgRXh0LnV0aWwuQ2xpY2tSZXBlYXRlcihhZnRlciwgewogICAgICAgICAgICAgICAgaW50ZXJ2YWw6IHRoaXMuc2Nyb2xsUmVwZWF0SW50ZXJ2YWwsCiAgICAgICAgICAgICAgICBoYW5kbGVyIDogdGhpcy5zY3JvbGxSaWdodCwKICAgICAgICAgICAgICAgIHNjb3BlICAgOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYmVmb3JlU2Nyb2xsZXIgPSBiZWZvcmU7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5hZnRlclNjcm9sbGVyID0gYWZ0ZXI7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBFeHQuZGVzdHJveSh0aGlzLmJlZm9yZVNjcm9sbGVyLCB0aGlzLmFmdGVyU2Nyb2xsZXIsIHRoaXMuYmVmb3JlUmVwZWF0ZXIsIHRoaXMuYWZ0ZXJSZXBlYXRlciwgdGhpcy5iZWZvcmVDdCwgdGhpcy5hZnRlckN0KTsKICAgIH0sCiAgICAKICAgIAogICAgc2Nyb2xsQnk6IGZ1bmN0aW9uKGRlbHRhLCBhbmltYXRlKSB7CiAgICAgICAgdGhpcy5zY3JvbGxUbyh0aGlzLmdldFNjcm9sbFBvc2l0aW9uKCkgKyBkZWx0YSwgYW5pbWF0ZSk7CiAgICB9LAogICAgCiAgICAKICAgIGdldEl0ZW06IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICBpZiAoRXh0LmlzU3RyaW5nKGl0ZW0pKSB7CiAgICAgICAgICAgIGl0ZW0gPSBFeHQuZ2V0Q21wKGl0ZW0pOwogICAgICAgIH0gZWxzZSBpZiAoRXh0LmlzTnVtYmVyKGl0ZW0pKSB7CiAgICAgICAgICAgIGl0ZW0gPSB0aGlzLml0ZW1zW2l0ZW1dOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gaXRlbTsKICAgIH0sCiAgICAKICAgIAogICAgZ2V0U2Nyb2xsQW5pbTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZHVyYXRpb246IHRoaXMuc2Nyb2xsRHVyYXRpb24sIAogICAgICAgICAgICBjYWxsYmFjazogdGhpcy51cGRhdGVTY3JvbGxCdXR0b25zLCAKICAgICAgICAgICAgc2NvcGUgICA6IHRoaXMKICAgICAgICB9OwogICAgfSwKICAgIAogICAgCiAgICB1cGRhdGVTY3JvbGxCdXR0b25zOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5iZWZvcmVTY3JvbGxlciA9PSB1bmRlZmluZWQgfHwgdGhpcy5hZnRlclNjcm9sbGVyID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciBiZWZvcmVNZXRoID0gdGhpcy5hdEV4dHJlbWVCZWZvcmUoKSAgPyAnYWRkQ2xhc3MnIDogJ3JlbW92ZUNsYXNzJywKICAgICAgICAgICAgYWZ0ZXJNZXRoICA9IHRoaXMuYXRFeHRyZW1lQWZ0ZXIoKSA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnLAogICAgICAgICAgICBiZWZvcmVDbHMgID0gdGhpcy5iZWZvcmVTY3JvbGxlckNscyArICctZGlzYWJsZWQnLAogICAgICAgICAgICBhZnRlckNscyAgID0gdGhpcy5hZnRlclNjcm9sbGVyQ2xzICArICctZGlzYWJsZWQnOwogICAgICAgIAogICAgICAgIHRoaXMuYmVmb3JlU2Nyb2xsZXJbYmVmb3JlTWV0aF0oYmVmb3JlQ2xzKTsKICAgICAgICB0aGlzLmFmdGVyU2Nyb2xsZXJbYWZ0ZXJNZXRoXShhZnRlckNscyk7CiAgICAgICAgdGhpcy5zY3JvbGxpbmcgPSBmYWxzZTsKICAgIH0sCiAgICAKICAgIAogICAgYXRFeHRyZW1lQmVmb3JlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRTY3JvbGxQb3NpdGlvbigpID09PSAwOwogICAgfSwKICAgIAogICAgCiAgICBzY3JvbGxMZWZ0OiBmdW5jdGlvbihhbmltYXRlKSB7CiAgICAgICAgdGhpcy5zY3JvbGxCeSgtdGhpcy5zY3JvbGxJbmNyZW1lbnQsIGFuaW1hdGUpOwogICAgfSwKICAgIAogICAgCiAgICBzY3JvbGxSaWdodDogZnVuY3Rpb24oYW5pbWF0ZSkgewogICAgICAgIHRoaXMuc2Nyb2xsQnkodGhpcy5zY3JvbGxJbmNyZW1lbnQsIGFuaW1hdGUpOwogICAgfSwKICAgIAogICAgCiAgICBzY3JvbGxUb0l0ZW06IGZ1bmN0aW9uKGl0ZW0sIGFuaW1hdGUpIHsKICAgICAgICBpdGVtID0gdGhpcy5nZXRJdGVtKGl0ZW0pOwogICAgICAgIAogICAgICAgIGlmIChpdGVtICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICB2YXIgdmlzaWJpbGl0eSA9IHRoaXMuZ2V0SXRlbVZpc2liaWxpdHkoaXRlbSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXZpc2liaWxpdHkuZnVsbHlWaXNpYmxlKSB7CiAgICAgICAgICAgICAgICB2YXIgYm94ICA9IGl0ZW0uZ2V0Qm94KHRydWUsIHRydWUpLAogICAgICAgICAgICAgICAgICAgIG5ld1ggPSBib3gueDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh2aXNpYmlsaXR5LmhpZGRlblJpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgbmV3WCAtPSAodGhpcy5sYXlvdXQuaW5uZXJDdC5nZXRXaWR0aCgpIC0gYm94LndpZHRoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxUbyhuZXdYLCBhbmltYXRlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgZ2V0SXRlbVZpc2liaWxpdHk6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICB2YXIgYm94ICAgICAgICAgPSB0aGlzLmdldEl0ZW0oaXRlbSkuZ2V0Qm94KHRydWUsIHRydWUpLAogICAgICAgICAgICBpdGVtTGVmdCAgICA9IGJveC54LAogICAgICAgICAgICBpdGVtUmlnaHQgICA9IGJveC54ICsgYm94LndpZHRoLAogICAgICAgICAgICBzY3JvbGxMZWZ0ICA9IHRoaXMuZ2V0U2Nyb2xsUG9zaXRpb24oKSwKICAgICAgICAgICAgc2Nyb2xsUmlnaHQgPSB0aGlzLmxheW91dC5pbm5lckN0LmdldFdpZHRoKCkgKyBzY3JvbGxMZWZ0OwogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGhpZGRlbkxlZnQgIDogaXRlbUxlZnQgPCBzY3JvbGxMZWZ0LAogICAgICAgICAgICBoaWRkZW5SaWdodCA6IGl0ZW1SaWdodCA+IHNjcm9sbFJpZ2h0LAogICAgICAgICAgICBmdWxseVZpc2libGU6IGl0ZW1MZWZ0ID4gc2Nyb2xsTGVmdCAmJiBpdGVtUmlnaHQgPCBzY3JvbGxSaWdodAogICAgICAgIH07CiAgICB9Cn0pOwoKRXh0LmxheW91dC5ib3hPdmVyZmxvdy5zY3JvbGxlciA9IEV4dC5sYXlvdXQuYm94T3ZlcmZsb3cuU2Nyb2xsZXI7CgoKDQpFeHQubGF5b3V0LmJveE92ZXJmbG93LlZlcnRpY2FsU2Nyb2xsZXIgPSBFeHQuZXh0ZW5kKEV4dC5sYXlvdXQuYm94T3ZlcmZsb3cuU2Nyb2xsZXIsIHsKICAgIHNjcm9sbEluY3JlbWVudDogNzUsCiAgICB3aGVlbEluY3JlbWVudCA6IDIsCiAgICAKICAgIGhhbmRsZU92ZXJmbG93OiBmdW5jdGlvbihjYWxjdWxhdGlvbnMsIHRhcmdldFNpemUpIHsKICAgICAgICBFeHQubGF5b3V0LmJveE92ZXJmbG93LlZlcnRpY2FsU2Nyb2xsZXIuc3VwZXJjbGFzcy5oYW5kbGVPdmVyZmxvdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHRhcmdldFNpemU6IHsKICAgICAgICAgICAgICAgIGhlaWdodDogdGFyZ2V0U2l6ZS5oZWlnaHQgLSAodGhpcy5iZWZvcmVDdC5nZXRIZWlnaHQoKSArIHRoaXMuYWZ0ZXJDdC5nZXRIZWlnaHQoKSksCiAgICAgICAgICAgICAgICB3aWR0aCA6IHRhcmdldFNpemUud2lkdGgKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9LAogICAgCiAgICAKICAgIGNyZWF0ZUlubmVyRWxlbWVudHM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLmxheW91dC5pbm5lckN0OwogICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgIGlmICghdGhpcy5iZWZvcmVDdCkgewogICAgICAgICAgICB0aGlzLmJlZm9yZUN0ID0gdGFyZ2V0Lmluc2VydFNpYmxpbmcoe2NsczogdGhpcy5iZWZvcmVDbHN9LCAnYmVmb3JlJyk7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJDdCAgPSB0YXJnZXQuaW5zZXJ0U2libGluZyh7Y2xzOiB0aGlzLmFmdGVyQ2xzfSwgICdhZnRlcicpOwoKICAgICAgICAgICAgdGhpcy5jcmVhdGVXaGVlbExpc3RlbmVyKCk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBzY3JvbGxUbzogZnVuY3Rpb24ocG9zaXRpb24sIGFuaW1hdGUpIHsKICAgICAgICB2YXIgb2xkUG9zaXRpb24gPSB0aGlzLmdldFNjcm9sbFBvc2l0aW9uKCksCiAgICAgICAgICAgIG5ld1Bvc2l0aW9uID0gcG9zaXRpb24uY29uc3RyYWluKDAsIHRoaXMuZ2V0TWF4U2Nyb2xsQm90dG9tKCkpOwogICAgICAgIAogICAgICAgIGlmIChuZXdQb3NpdGlvbiAhPSBvbGRQb3NpdGlvbiAmJiAhdGhpcy5zY3JvbGxpbmcpIHsKICAgICAgICAgICAgaWYgKGFuaW1hdGUgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBhbmltYXRlID0gdGhpcy5hbmltYXRlU2Nyb2xsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmxheW91dC5pbm5lckN0LnNjcm9sbFRvKCd0b3AnLCBuZXdQb3NpdGlvbiwgYW5pbWF0ZSA/IHRoaXMuZ2V0U2Nyb2xsQW5pbSgpIDogZmFsc2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGFuaW1hdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVNjcm9sbEJ1dHRvbnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgZ2V0U2Nyb2xsUG9zaXRpb246IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHBhcnNlSW50KHRoaXMubGF5b3V0LmlubmVyQ3QuZG9tLnNjcm9sbFRvcCwgMTApIHx8IDA7CiAgICB9LAogICAgCiAgICAKICAgIGdldE1heFNjcm9sbEJvdHRvbTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubGF5b3V0LmlubmVyQ3QuZG9tLnNjcm9sbEhlaWdodCAtIHRoaXMubGF5b3V0LmlubmVyQ3QuZ2V0SGVpZ2h0KCk7CiAgICB9LAogICAgCiAgICAKICAgIGF0RXh0cmVtZUFmdGVyOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRTY3JvbGxQb3NpdGlvbigpID49IHRoaXMuZ2V0TWF4U2Nyb2xsQm90dG9tKCk7CiAgICB9Cn0pOwoKRXh0LmxheW91dC5ib3hPdmVyZmxvdy5zY3JvbGxlci52Ym94ID0gRXh0LmxheW91dC5ib3hPdmVyZmxvdy5WZXJ0aWNhbFNjcm9sbGVyOwoKCgpFeHQubGF5b3V0LmJveE92ZXJmbG93Lkhvcml6b250YWxTY3JvbGxlciA9IEV4dC5leHRlbmQoRXh0LmxheW91dC5ib3hPdmVyZmxvdy5TY3JvbGxlciwgewogICAgaGFuZGxlT3ZlcmZsb3c6IGZ1bmN0aW9uKGNhbGN1bGF0aW9ucywgdGFyZ2V0U2l6ZSkgewogICAgICAgIEV4dC5sYXlvdXQuYm94T3ZlcmZsb3cuSG9yaXpvbnRhbFNjcm9sbGVyLnN1cGVyY2xhc3MuaGFuZGxlT3ZlcmZsb3cuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0YXJnZXRTaXplOiB7CiAgICAgICAgICAgICAgICBoZWlnaHQ6IHRhcmdldFNpemUuaGVpZ2h0LAogICAgICAgICAgICAgICAgd2lkdGggOiB0YXJnZXRTaXplLndpZHRoIC0gKHRoaXMuYmVmb3JlQ3QuZ2V0V2lkdGgoKSArIHRoaXMuYWZ0ZXJDdC5nZXRXaWR0aCgpKQogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0sCiAgICAKICAgIAogICAgY3JlYXRlSW5uZXJFbGVtZW50czogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMubGF5b3V0LmlubmVyQ3Q7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgaWYgKCF0aGlzLmJlZm9yZUN0KSB7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJDdCAgPSB0YXJnZXQuaW5zZXJ0U2libGluZyh7Y2xzOiB0aGlzLmFmdGVyQ2xzfSwgICdiZWZvcmUnKTsKICAgICAgICAgICAgdGhpcy5iZWZvcmVDdCA9IHRhcmdldC5pbnNlcnRTaWJsaW5nKHtjbHM6IHRoaXMuYmVmb3JlQ2xzfSwgJ2JlZm9yZScpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jcmVhdGVXaGVlbExpc3RlbmVyKCk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBzY3JvbGxUbzogZnVuY3Rpb24ocG9zaXRpb24sIGFuaW1hdGUpIHsKICAgICAgICB2YXIgb2xkUG9zaXRpb24gPSB0aGlzLmdldFNjcm9sbFBvc2l0aW9uKCksCiAgICAgICAgICAgIG5ld1Bvc2l0aW9uID0gcG9zaXRpb24uY29uc3RyYWluKDAsIHRoaXMuZ2V0TWF4U2Nyb2xsUmlnaHQoKSk7CiAgICAgICAgCiAgICAgICAgaWYgKG5ld1Bvc2l0aW9uICE9IG9sZFBvc2l0aW9uICYmICF0aGlzLnNjcm9sbGluZykgewogICAgICAgICAgICBpZiAoYW5pbWF0ZSA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGFuaW1hdGUgPSB0aGlzLmFuaW1hdGVTY3JvbGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMubGF5b3V0LmlubmVyQ3Quc2Nyb2xsVG8oJ2xlZnQnLCBuZXdQb3NpdGlvbiwgYW5pbWF0ZSA/IHRoaXMuZ2V0U2Nyb2xsQW5pbSgpIDogZmFsc2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGFuaW1hdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVNjcm9sbEJ1dHRvbnMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgZ2V0U2Nyb2xsUG9zaXRpb246IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHBhcnNlSW50KHRoaXMubGF5b3V0LmlubmVyQ3QuZG9tLnNjcm9sbExlZnQsIDEwKSB8fCAwOwogICAgfSwKICAgIAogICAgCiAgICBnZXRNYXhTY3JvbGxSaWdodDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubGF5b3V0LmlubmVyQ3QuZG9tLnNjcm9sbFdpZHRoIC0gdGhpcy5sYXlvdXQuaW5uZXJDdC5nZXRXaWR0aCgpOwogICAgfSwKICAgIAogICAgCiAgICBhdEV4dHJlbWVBZnRlcjogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsUG9zaXRpb24oKSA+PSB0aGlzLmdldE1heFNjcm9sbFJpZ2h0KCk7CiAgICB9Cn0pOwoKRXh0LmxheW91dC5ib3hPdmVyZmxvdy5zY3JvbGxlci5oYm94ID0gRXh0LmxheW91dC5ib3hPdmVyZmxvdy5Ib3Jpem9udGFsU2Nyb2xsZXI7CkV4dC5sYXlvdXQuSEJveExheW91dCA9IEV4dC5leHRlbmQoRXh0LmxheW91dC5Cb3hMYXlvdXQsIHsKICAgIAogICAgYWxpZ246ICd0b3AnLCAKCiAgICB0eXBlIDogJ2hib3gnLAoKICAgIAogICAgCgogICAgCiAgICBjYWxjdWxhdGVDaGlsZEJveGVzOiBmdW5jdGlvbih2aXNpYmxlSXRlbXMsIHRhcmdldFNpemUpIHsKICAgICAgICB2YXIgdmlzaWJsZUNvdW50ID0gdmlzaWJsZUl0ZW1zLmxlbmd0aCwKCiAgICAgICAgICAgIHBhZGRpbmcgICAgICA9IHRoaXMucGFkZGluZywKICAgICAgICAgICAgdG9wT2Zmc2V0ICAgID0gcGFkZGluZy50b3AsCiAgICAgICAgICAgIGxlZnRPZmZzZXQgICA9IHBhZGRpbmcubGVmdCwKICAgICAgICAgICAgcGFkZGluZ1ZlcnQgID0gdG9wT2Zmc2V0ICArIHBhZGRpbmcuYm90dG9tLAogICAgICAgICAgICBwYWRkaW5nSG9yaXogPSBsZWZ0T2Zmc2V0ICsgcGFkZGluZy5yaWdodCwKCiAgICAgICAgICAgIHdpZHRoICAgICAgICA9IHRhcmdldFNpemUud2lkdGggLSB0aGlzLnNjcm9sbE9mZnNldCwKICAgICAgICAgICAgaGVpZ2h0ICAgICAgID0gdGFyZ2V0U2l6ZS5oZWlnaHQsCiAgICAgICAgICAgIGF2YWlsSGVpZ2h0ICA9IE1hdGgubWF4KDAsIGhlaWdodCAtIHBhZGRpbmdWZXJ0KSwKCiAgICAgICAgICAgIGlzU3RhcnQgICAgICA9IHRoaXMucGFjayA9PSAnc3RhcnQnLAogICAgICAgICAgICBpc0NlbnRlciAgICAgPSB0aGlzLnBhY2sgPT0gJ2NlbnRlcicsCiAgICAgICAgICAgIGlzRW5kICAgICAgICA9IHRoaXMucGFjayA9PSAnZW5kJywKCiAgICAgICAgICAgIG5vbkZsZXhXaWR0aCA9IDAsCiAgICAgICAgICAgIG1heEhlaWdodCAgICA9IDAsCiAgICAgICAgICAgIHRvdGFsRmxleCAgICA9IDAsCiAgICAgICAgICAgIGRlc2lyZWRXaWR0aCA9IDAsCiAgICAgICAgICAgIG1pbmltdW1XaWR0aCA9IDAsCgogICAgICAgICAgICAKICAgICAgICAgICAgYm94ZXMgICAgICAgID0gW10sCgogICAgICAgICAgICAKICAgICAgICAgICAgY2hpbGQsIGNoaWxkV2lkdGgsIGNoaWxkSGVpZ2h0LCBjaGlsZFNpemUsIGNoaWxkTWFyZ2lucywgY2FuTGF5b3V0LCBpLCBjYWxjcywgZmxleGVkV2lkdGgsIAogICAgICAgICAgICBob3Jpek1hcmdpbnMsIHZlcnRNYXJnaW5zLCBzdHJldGNoSGVpZ2h0OwoKICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdmlzaWJsZUNvdW50OyBpKyspIHsKICAgICAgICAgICAgY2hpbGQgICAgICAgPSB2aXNpYmxlSXRlbXNbaV07CiAgICAgICAgICAgIGNoaWxkSGVpZ2h0ID0gY2hpbGQuaGVpZ2h0OwogICAgICAgICAgICBjaGlsZFdpZHRoICA9IGNoaWxkLndpZHRoOwogICAgICAgICAgICBjYW5MYXlvdXQgICA9ICFjaGlsZC5oYXNMYXlvdXQgJiYgdHlwZW9mIGNoaWxkLmRvTGF5b3V0ID09ICdmdW5jdGlvbic7CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZFdpZHRoICE9ICdudW1iZXInKSB7CgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoY2hpbGQuZmxleCAmJiAhY2hpbGRXaWR0aCkgewogICAgICAgICAgICAgICAgICAgIHRvdGFsRmxleCArPSBjaGlsZC5mbGV4OwoKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoIWNoaWxkV2lkdGggJiYgY2FuTGF5b3V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkLmRvTGF5b3V0KCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjaGlsZFNpemUgICA9IGNoaWxkLmdldFNpemUoKTsKICAgICAgICAgICAgICAgICAgICBjaGlsZFdpZHRoICA9IGNoaWxkU2l6ZS53aWR0aDsKICAgICAgICAgICAgICAgICAgICBjaGlsZEhlaWdodCA9IGNoaWxkU2l6ZS5oZWlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkTWFyZ2lucyA9IGNoaWxkLm1hcmdpbnM7CiAgICAgICAgICAgIGhvcml6TWFyZ2lucyA9IGNoaWxkTWFyZ2lucy5sZWZ0ICsgY2hpbGRNYXJnaW5zLnJpZ2h0OwoKICAgICAgICAgICAgbm9uRmxleFdpZHRoICs9IGhvcml6TWFyZ2lucyArIChjaGlsZFdpZHRoIHx8IDApOwogICAgICAgICAgICBkZXNpcmVkV2lkdGggKz0gaG9yaXpNYXJnaW5zICsgKGNoaWxkLmZsZXggPyBjaGlsZC5taW5XaWR0aCB8fCAwIDogY2hpbGRXaWR0aCk7CiAgICAgICAgICAgIG1pbmltdW1XaWR0aCArPSBob3Jpek1hcmdpbnMgKyAoY2hpbGQubWluV2lkdGggfHwgY2hpbGRXaWR0aCB8fCAwKTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkSGVpZ2h0ICE9ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FuTGF5b3V0KSB7CiAgICAgICAgICAgICAgICAgICAgY2hpbGQuZG9MYXlvdXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkSGVpZ2h0ID0gY2hpbGQuZ2V0SGVpZ2h0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1heEhlaWdodCA9IE1hdGgubWF4KG1heEhlaWdodCwgY2hpbGRIZWlnaHQgKyBjaGlsZE1hcmdpbnMudG9wICsgY2hpbGRNYXJnaW5zLmJvdHRvbSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgYm94ZXMucHVzaCh7CiAgICAgICAgICAgICAgICBjb21wb25lbnQ6IGNoaWxkLAogICAgICAgICAgICAgICAgaGVpZ2h0ICAgOiBjaGlsZEhlaWdodCB8fCB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICB3aWR0aCAgICA6IGNoaWxkV2lkdGggIHx8IHVuZGVmaW5lZAogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICB2YXIgc2hvcnRmYWxsID0gZGVzaXJlZFdpZHRoIC0gd2lkdGgsCiAgICAgICAgICAgIHRvb05hcnJvdyA9IG1pbmltdW1XaWR0aCA+IHdpZHRoOwogICAgICAgICAgICAKICAgICAgICAKICAgICAgICB2YXIgYXZhaWxhYmxlV2lkdGggPSBNYXRoLm1heCgwLCB3aWR0aCAtIG5vbkZsZXhXaWR0aCAtIHBhZGRpbmdIb3Jpeik7CiAgICAgICAgCiAgICAgICAgaWYgKHRvb05hcnJvdykgewogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdmlzaWJsZUNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGJveGVzW2ldLndpZHRoID0gdmlzaWJsZUl0ZW1zW2ldLm1pbldpZHRoIHx8IHZpc2libGVJdGVtc1tpXS53aWR0aCB8fCBib3hlc1tpXS53aWR0aDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHNob3J0ZmFsbCA+IDApIHsKICAgICAgICAgICAgICAgIHZhciBtaW5XaWR0aHMgPSBbXTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpbmRleCA9IDAsIGxlbmd0aCA9IHZpc2libGVDb3VudDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbSAgICAgPSB2aXNpYmxlSXRlbXNbaW5kZXhdLAogICAgICAgICAgICAgICAgICAgICAgICBtaW5XaWR0aCA9IGl0ZW0ubWluV2lkdGggfHwgMDsKCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uZmxleCkgewogICAgICAgICAgICAgICAgICAgICAgICBib3hlc1tpbmRleF0ud2lkdGggPSBtaW5XaWR0aDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBtaW5XaWR0aHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5XaWR0aCA6IG1pbldpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlOiBib3hlc1tpbmRleF0ud2lkdGggLSBtaW5XaWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ICAgIDogaW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIG1pbldpZHRocy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5hdmFpbGFibGUgPiBiLmF2YWlsYWJsZSA/IDEgOiAtMTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBtaW5XaWR0aHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbUluZGV4ID0gbWluV2lkdGhzW2ldLmluZGV4OwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIChpdGVtSW5kZXggPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gICAgICA9IHZpc2libGVJdGVtc1tpdGVtSW5kZXhdLAogICAgICAgICAgICAgICAgICAgICAgICBib3ggICAgICAgPSBib3hlc1tpdGVtSW5kZXhdLAogICAgICAgICAgICAgICAgICAgICAgICBvbGRXaWR0aCAgPSBib3gud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIG1pbldpZHRoICA9IGl0ZW0ubWluV2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1dpZHRoICA9IE1hdGgubWF4KG1pbldpZHRoLCBvbGRXaWR0aCAtIE1hdGguY2VpbChzaG9ydGZhbGwgLyAobGVuZ3RoIC0gaSkpKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVkdWN0aW9uID0gb2xkV2lkdGggLSBuZXdXaWR0aDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBib3hlc1tpdGVtSW5kZXhdLndpZHRoID0gbmV3V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgc2hvcnRmYWxsIC09IHJlZHVjdGlvbjsgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2YXIgcmVtYWluaW5nV2lkdGggPSBhdmFpbGFibGVXaWR0aCwKICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdGbGV4ICA9IHRvdGFsRmxleDsKCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB2aXNpYmxlQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNoaWxkID0gdmlzaWJsZUl0ZW1zW2ldOwogICAgICAgICAgICAgICAgICAgIGNhbGNzID0gYm94ZXNbaV07CgogICAgICAgICAgICAgICAgICAgIGNoaWxkTWFyZ2lucyA9IGNoaWxkLm1hcmdpbnM7CiAgICAgICAgICAgICAgICAgICAgdmVydE1hcmdpbnMgID0gY2hpbGRNYXJnaW5zLnRvcCArIGNoaWxkTWFyZ2lucy5ib3R0b207CgogICAgICAgICAgICAgICAgICAgIGlmIChpc1N0YXJ0ICYmIGNoaWxkLmZsZXggJiYgIWNoaWxkLndpZHRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsZXhlZFdpZHRoICAgICA9IE1hdGguY2VpbCgoY2hpbGQuZmxleCAvIHJlbWFpbmluZ0ZsZXgpICogcmVtYWluaW5nV2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdXaWR0aCAtPSBmbGV4ZWRXaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nRmxleCAgLT0gY2hpbGQuZmxleDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGNzLndpZHRoID0gZmxleGVkV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGNzLmRpcnR5U2l6ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChpc0NlbnRlcikgewogICAgICAgICAgICBsZWZ0T2Zmc2V0ICs9IGF2YWlsYWJsZVdpZHRoIC8gMjsKICAgICAgICB9IGVsc2UgaWYgKGlzRW5kKSB7CiAgICAgICAgICAgIGxlZnRPZmZzZXQgKz0gYXZhaWxhYmxlV2lkdGg7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCB2aXNpYmxlQ291bnQ7IGkrKykgewogICAgICAgICAgICBjaGlsZCA9IHZpc2libGVJdGVtc1tpXTsKICAgICAgICAgICAgY2FsY3MgPSBib3hlc1tpXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNoaWxkTWFyZ2lucyA9IGNoaWxkLm1hcmdpbnM7CiAgICAgICAgICAgIGxlZnRPZmZzZXQgICs9IGNoaWxkTWFyZ2lucy5sZWZ0OwogICAgICAgICAgICB2ZXJ0TWFyZ2lucyAgPSBjaGlsZE1hcmdpbnMudG9wICsgY2hpbGRNYXJnaW5zLmJvdHRvbTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNhbGNzLmxlZnQgPSBsZWZ0T2Zmc2V0OwogICAgICAgICAgICBjYWxjcy50b3AgID0gdG9wT2Zmc2V0ICsgY2hpbGRNYXJnaW5zLnRvcDsKCiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5hbGlnbikgewogICAgICAgICAgICAgICAgY2FzZSAnc3RyZXRjaCc6CiAgICAgICAgICAgICAgICAgICAgc3RyZXRjaEhlaWdodCA9IGF2YWlsSGVpZ2h0IC0gdmVydE1hcmdpbnM7CiAgICAgICAgICAgICAgICAgICAgY2FsY3MuaGVpZ2h0ICA9IHN0cmV0Y2hIZWlnaHQuY29uc3RyYWluKGNoaWxkLm1pbkhlaWdodCB8fCAwLCBjaGlsZC5tYXhIZWlnaHQgfHwgMTAwMDAwMCk7CiAgICAgICAgICAgICAgICAgICAgY2FsY3MuZGlydHlTaXplID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ3N0cmV0Y2htYXgnOgogICAgICAgICAgICAgICAgICAgIHN0cmV0Y2hIZWlnaHQgPSBtYXhIZWlnaHQgLSB2ZXJ0TWFyZ2luczsKICAgICAgICAgICAgICAgICAgICBjYWxjcy5oZWlnaHQgID0gc3RyZXRjaEhlaWdodC5jb25zdHJhaW4oY2hpbGQubWluSGVpZ2h0IHx8IDAsIGNoaWxkLm1heEhlaWdodCB8fCAxMDAwMDAwKTsKICAgICAgICAgICAgICAgICAgICBjYWxjcy5kaXJ0eVNpemUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnbWlkZGxlJzoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlmZiA9IGF2YWlsSGVpZ2h0IC0gY2FsY3MuaGVpZ2h0IC0gdmVydE1hcmdpbnM7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRpZmYgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGNzLnRvcCA9IHRvcE9mZnNldCArIHZlcnRNYXJnaW5zICsgKGRpZmYgLyAyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGxlZnRPZmZzZXQgKz0gY2FsY3Mud2lkdGggKyBjaGlsZE1hcmdpbnMucmlnaHQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBib3hlczogYm94ZXMsCiAgICAgICAgICAgIG1ldGEgOiB7CiAgICAgICAgICAgICAgICBtYXhIZWlnaHQgICA6IG1heEhlaWdodCwKICAgICAgICAgICAgICAgIG5vbkZsZXhXaWR0aDogbm9uRmxleFdpZHRoLAogICAgICAgICAgICAgICAgZGVzaXJlZFdpZHRoOiBkZXNpcmVkV2lkdGgsCiAgICAgICAgICAgICAgICBtaW5pbXVtV2lkdGg6IG1pbmltdW1XaWR0aCwKICAgICAgICAgICAgICAgIHNob3J0ZmFsbCAgIDogZGVzaXJlZFdpZHRoIC0gd2lkdGgsCiAgICAgICAgICAgICAgICB0b29OYXJyb3cgICA6IHRvb05hcnJvdwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0KfSk7CgpFeHQuQ29udGFpbmVyLkxBWU9VVFMuaGJveCA9IEV4dC5sYXlvdXQuSEJveExheW91dDsKRXh0LmxheW91dC5WQm94TGF5b3V0ID0gRXh0LmV4dGVuZChFeHQubGF5b3V0LkJveExheW91dCwgewogICAgCiAgICBhbGlnbiA6ICdsZWZ0JywgCiAgICB0eXBlOiAndmJveCcsCgogICAgCgogICAgCgogICAgCiAgICBjYWxjdWxhdGVDaGlsZEJveGVzOiBmdW5jdGlvbih2aXNpYmxlSXRlbXMsIHRhcmdldFNpemUpIHsKICAgICAgICB2YXIgdmlzaWJsZUNvdW50ID0gdmlzaWJsZUl0ZW1zLmxlbmd0aCwKCiAgICAgICAgICAgIHBhZGRpbmcgICAgICA9IHRoaXMucGFkZGluZywKICAgICAgICAgICAgdG9wT2Zmc2V0ICAgID0gcGFkZGluZy50b3AsCiAgICAgICAgICAgIGxlZnRPZmZzZXQgICA9IHBhZGRpbmcubGVmdCwKICAgICAgICAgICAgcGFkZGluZ1ZlcnQgID0gdG9wT2Zmc2V0ICArIHBhZGRpbmcuYm90dG9tLAogICAgICAgICAgICBwYWRkaW5nSG9yaXogPSBsZWZ0T2Zmc2V0ICsgcGFkZGluZy5yaWdodCwKCiAgICAgICAgICAgIHdpZHRoICAgICAgICA9IHRhcmdldFNpemUud2lkdGggLSB0aGlzLnNjcm9sbE9mZnNldCwKICAgICAgICAgICAgaGVpZ2h0ICAgICAgID0gdGFyZ2V0U2l6ZS5oZWlnaHQsCiAgICAgICAgICAgIGF2YWlsV2lkdGggICA9IE1hdGgubWF4KDAsIHdpZHRoIC0gcGFkZGluZ0hvcml6KSwKCiAgICAgICAgICAgIGlzU3RhcnQgICAgICA9IHRoaXMucGFjayA9PSAnc3RhcnQnLAogICAgICAgICAgICBpc0NlbnRlciAgICAgPSB0aGlzLnBhY2sgPT0gJ2NlbnRlcicsCiAgICAgICAgICAgIGlzRW5kICAgICAgICA9IHRoaXMucGFjayA9PSAnZW5kJywKCiAgICAgICAgICAgIG5vbkZsZXhIZWlnaHQ9IDAsCiAgICAgICAgICAgIG1heFdpZHRoICAgICA9IDAsCiAgICAgICAgICAgIHRvdGFsRmxleCAgICA9IDAsCiAgICAgICAgICAgIGRlc2lyZWRIZWlnaHQ9IDAsCiAgICAgICAgICAgIG1pbmltdW1IZWlnaHQ9IDAsCgogICAgICAgICAgICAKICAgICAgICAgICAgYm94ZXMgICAgICAgID0gW10sCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgY2hpbGQsIGNoaWxkV2lkdGgsIGNoaWxkSGVpZ2h0LCBjaGlsZFNpemUsIGNoaWxkTWFyZ2lucywgY2FuTGF5b3V0LCBpLCBjYWxjcywgZmxleGVkSGVpZ2h0LCAKICAgICAgICAgICAgaG9yaXpNYXJnaW5zLCB2ZXJ0TWFyZ2lucywgc3RyZXRjaFdpZHRoLCBsZW5ndGg7CgogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCB2aXNpYmxlQ291bnQ7IGkrKykgewogICAgICAgICAgICBjaGlsZCA9IHZpc2libGVJdGVtc1tpXTsKICAgICAgICAgICAgY2hpbGRIZWlnaHQgPSBjaGlsZC5oZWlnaHQ7CiAgICAgICAgICAgIGNoaWxkV2lkdGggID0gY2hpbGQud2lkdGg7CiAgICAgICAgICAgIGNhbkxheW91dCAgID0gIWNoaWxkLmhhc0xheW91dCAmJiB0eXBlb2YgY2hpbGQuZG9MYXlvdXQgPT0gJ2Z1bmN0aW9uJzsKCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkSGVpZ2h0ICE9ICdudW1iZXInKSB7CgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoY2hpbGQuZmxleCAmJiAhY2hpbGRIZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICB0b3RhbEZsZXggKz0gY2hpbGQuZmxleDsKCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKCFjaGlsZEhlaWdodCAmJiBjYW5MYXlvdXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuZG9MYXlvdXQoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNoaWxkU2l6ZSA9IGNoaWxkLmdldFNpemUoKTsKICAgICAgICAgICAgICAgICAgICBjaGlsZFdpZHRoID0gY2hpbGRTaXplLndpZHRoOwogICAgICAgICAgICAgICAgICAgIGNoaWxkSGVpZ2h0ID0gY2hpbGRTaXplLmhlaWdodDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY2hpbGRNYXJnaW5zID0gY2hpbGQubWFyZ2luczsKICAgICAgICAgICAgdmVydE1hcmdpbnMgID0gY2hpbGRNYXJnaW5zLnRvcCArIGNoaWxkTWFyZ2lucy5ib3R0b207CgogICAgICAgICAgICBub25GbGV4SGVpZ2h0ICs9IHZlcnRNYXJnaW5zICsgKGNoaWxkSGVpZ2h0IHx8IDApOwogICAgICAgICAgICBkZXNpcmVkSGVpZ2h0ICs9IHZlcnRNYXJnaW5zICsgKGNoaWxkLmZsZXggPyBjaGlsZC5taW5IZWlnaHQgfHwgMCA6IGNoaWxkSGVpZ2h0KTsKICAgICAgICAgICAgbWluaW11bUhlaWdodCArPSB2ZXJ0TWFyZ2lucyArIChjaGlsZC5taW5IZWlnaHQgfHwgY2hpbGRIZWlnaHQgfHwgMCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZFdpZHRoICE9ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICBpZiAoY2FuTGF5b3V0KSB7CiAgICAgICAgICAgICAgICAgICAgY2hpbGQuZG9MYXlvdXQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkV2lkdGggPSBjaGlsZC5nZXRXaWR0aCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXhXaWR0aCA9IE1hdGgubWF4KG1heFdpZHRoLCBjaGlsZFdpZHRoICsgY2hpbGRNYXJnaW5zLmxlZnQgKyBjaGlsZE1hcmdpbnMucmlnaHQpOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIGJveGVzLnB1c2goewogICAgICAgICAgICAgICAgY29tcG9uZW50OiBjaGlsZCwKICAgICAgICAgICAgICAgIGhlaWdodCAgIDogY2hpbGRIZWlnaHQgfHwgdW5kZWZpbmVkLAogICAgICAgICAgICAgICAgd2lkdGggICAgOiBjaGlsZFdpZHRoIHx8IHVuZGVmaW5lZAogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICB2YXIgc2hvcnRmYWxsID0gZGVzaXJlZEhlaWdodCAtIGhlaWdodCwKICAgICAgICAgICAgdG9vTmFycm93ID0gbWluaW11bUhlaWdodCA+IGhlaWdodDsKCiAgICAgICAgCiAgICAgICAgdmFyIGF2YWlsYWJsZUhlaWdodCA9IE1hdGgubWF4KDAsIChoZWlnaHQgLSBub25GbGV4SGVpZ2h0IC0gcGFkZGluZ1ZlcnQpKTsKICAgICAgICAKICAgICAgICBpZiAodG9vTmFycm93KSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbmd0aCA9IHZpc2libGVDb3VudDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBib3hlc1tpXS5oZWlnaHQgPSB2aXNpYmxlSXRlbXNbaV0ubWluSGVpZ2h0IHx8IHZpc2libGVJdGVtc1tpXS5oZWlnaHQgfHwgYm94ZXNbaV0uaGVpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoc2hvcnRmYWxsID4gMCkgewogICAgICAgICAgICAgICAgdmFyIG1pbkhlaWdodHMgPSBbXTsKCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAodmFyIGluZGV4ID0gMCwgbGVuZ3RoID0gdmlzaWJsZUNvdW50OyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBpdGVtICAgICAgPSB2aXNpYmxlSXRlbXNbaW5kZXhdLAogICAgICAgICAgICAgICAgICAgICAgICBtaW5IZWlnaHQgPSBpdGVtLm1pbkhlaWdodCB8fCAwOwoKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5mbGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJveGVzW2luZGV4XS5oZWlnaHQgPSBtaW5IZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWluSGVpZ2h0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkhlaWdodDogbWluSGVpZ2h0LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2YWlsYWJsZTogYm94ZXNbaW5kZXhdLmhlaWdodCAtIG1pbkhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ICAgIDogaW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbWluSGVpZ2h0cy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5hdmFpbGFibGUgPiBiLmF2YWlsYWJsZSA/IDEgOiAtMTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IG1pbkhlaWdodHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbUluZGV4ID0gbWluSGVpZ2h0c1tpXS5pbmRleDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1JbmRleCA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbSAgICAgID0gdmlzaWJsZUl0ZW1zW2l0ZW1JbmRleF0sCiAgICAgICAgICAgICAgICAgICAgICAgIGJveCAgICAgICA9IGJveGVzW2l0ZW1JbmRleF0sCiAgICAgICAgICAgICAgICAgICAgICAgIG9sZEhlaWdodCAgPSBib3guaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgICBtaW5IZWlnaHQgID0gaXRlbS5taW5IZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0hlaWdodCAgPSBNYXRoLm1heChtaW5IZWlnaHQsIG9sZEhlaWdodCAtIE1hdGguY2VpbChzaG9ydGZhbGwgLyAobGVuZ3RoIC0gaSkpKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmVkdWN0aW9uID0gb2xkSGVpZ2h0IC0gbmV3SGVpZ2h0OwoKICAgICAgICAgICAgICAgICAgICBib3hlc1tpdGVtSW5kZXhdLmhlaWdodCA9IG5ld0hlaWdodDsKICAgICAgICAgICAgICAgICAgICBzaG9ydGZhbGwgLT0gcmVkdWN0aW9uOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2YXIgcmVtYWluaW5nSGVpZ2h0ID0gYXZhaWxhYmxlSGVpZ2h0LAogICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ0ZsZXggICA9IHRvdGFsRmxleDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdmlzaWJsZUNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjaGlsZCA9IHZpc2libGVJdGVtc1tpXTsKICAgICAgICAgICAgICAgICAgICBjYWxjcyA9IGJveGVzW2ldOwoKICAgICAgICAgICAgICAgICAgICBjaGlsZE1hcmdpbnMgPSBjaGlsZC5tYXJnaW5zOwogICAgICAgICAgICAgICAgICAgIGhvcml6TWFyZ2lucyA9IGNoaWxkTWFyZ2lucy5sZWZ0ICsgY2hpbGRNYXJnaW5zLnJpZ2h0OwoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNTdGFydCAmJiBjaGlsZC5mbGV4ICYmICFjaGlsZC5oZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZmxleGVkSGVpZ2h0ICAgICA9IE1hdGguY2VpbCgoY2hpbGQuZmxleCAvIHJlbWFpbmluZ0ZsZXgpICogcmVtYWluaW5nSGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nSGVpZ2h0IC09IGZsZXhlZEhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nRmxleCAgIC09IGNoaWxkLmZsZXg7CgogICAgICAgICAgICAgICAgICAgICAgICBjYWxjcy5oZWlnaHQgPSBmbGV4ZWRIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGNzLmRpcnR5U2l6ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNDZW50ZXIpIHsKICAgICAgICAgICAgdG9wT2Zmc2V0ICs9IGF2YWlsYWJsZUhlaWdodCAvIDI7CiAgICAgICAgfSBlbHNlIGlmIChpc0VuZCkgewogICAgICAgICAgICB0b3BPZmZzZXQgKz0gYXZhaWxhYmxlSGVpZ2h0OwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHZpc2libGVDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGNoaWxkID0gdmlzaWJsZUl0ZW1zW2ldOwogICAgICAgICAgICBjYWxjcyA9IGJveGVzW2ldOwoKICAgICAgICAgICAgY2hpbGRNYXJnaW5zID0gY2hpbGQubWFyZ2luczsKICAgICAgICAgICAgdG9wT2Zmc2V0ICAgKz0gY2hpbGRNYXJnaW5zLnRvcDsKICAgICAgICAgICAgaG9yaXpNYXJnaW5zID0gY2hpbGRNYXJnaW5zLmxlZnQgKyBjaGlsZE1hcmdpbnMucmlnaHQ7CiAgICAgICAgICAgIAoKICAgICAgICAgICAgY2FsY3MubGVmdCA9IGxlZnRPZmZzZXQgKyBjaGlsZE1hcmdpbnMubGVmdDsKICAgICAgICAgICAgY2FsY3MudG9wICA9IHRvcE9mZnNldDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHN3aXRjaCAodGhpcy5hbGlnbikgewogICAgICAgICAgICAgICAgY2FzZSAnc3RyZXRjaCc6CiAgICAgICAgICAgICAgICAgICAgc3RyZXRjaFdpZHRoID0gYXZhaWxXaWR0aCAtIGhvcml6TWFyZ2luczsKICAgICAgICAgICAgICAgICAgICBjYWxjcy53aWR0aCAgPSBzdHJldGNoV2lkdGguY29uc3RyYWluKGNoaWxkLm1pbldpZHRoIHx8IDAsIGNoaWxkLm1heFdpZHRoIHx8IDEwMDAwMDApOwogICAgICAgICAgICAgICAgICAgIGNhbGNzLmRpcnR5U2l6ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdzdHJldGNobWF4JzoKICAgICAgICAgICAgICAgICAgICBzdHJldGNoV2lkdGggPSBtYXhXaWR0aCAtIGhvcml6TWFyZ2luczsKICAgICAgICAgICAgICAgICAgICBjYWxjcy53aWR0aCAgPSBzdHJldGNoV2lkdGguY29uc3RyYWluKGNoaWxkLm1pbldpZHRoIHx8IDAsIGNoaWxkLm1heFdpZHRoIHx8IDEwMDAwMDApOwogICAgICAgICAgICAgICAgICAgIGNhbGNzLmRpcnR5U2l6ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdjZW50ZXInOgogICAgICAgICAgICAgICAgICAgIHZhciBkaWZmID0gYXZhaWxXaWR0aCAtIGNhbGNzLndpZHRoIC0gaG9yaXpNYXJnaW5zOwogICAgICAgICAgICAgICAgICAgIGlmIChkaWZmID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxjcy5sZWZ0ID0gbGVmdE9mZnNldCArIGhvcml6TWFyZ2lucyArIChkaWZmIC8gMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0b3BPZmZzZXQgKz0gY2FsY3MuaGVpZ2h0ICsgY2hpbGRNYXJnaW5zLmJvdHRvbTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYm94ZXM6IGJveGVzLAogICAgICAgICAgICBtZXRhIDogewogICAgICAgICAgICAgICAgbWF4V2lkdGggICAgIDogbWF4V2lkdGgsCiAgICAgICAgICAgICAgICBub25GbGV4SGVpZ2h0OiBub25GbGV4SGVpZ2h0LAogICAgICAgICAgICAgICAgZGVzaXJlZEhlaWdodDogZGVzaXJlZEhlaWdodCwKICAgICAgICAgICAgICAgIG1pbmltdW1IZWlnaHQ6IG1pbmltdW1IZWlnaHQsCiAgICAgICAgICAgICAgICBzaG9ydGZhbGwgICAgOiBkZXNpcmVkSGVpZ2h0IC0gaGVpZ2h0LAogICAgICAgICAgICAgICAgdG9vTmFycm93ICAgIDogdG9vTmFycm93CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQp9KTsKCkV4dC5Db250YWluZXIuTEFZT1VUUy52Ym94ID0gRXh0LmxheW91dC5WQm94TGF5b3V0OwoKRXh0LmxheW91dC5Ub29sYmFyTGF5b3V0ID0gRXh0LmV4dGVuZChFeHQubGF5b3V0LkNvbnRhaW5lckxheW91dCwgewogICAgbW9uaXRvclJlc2l6ZSA6IHRydWUsCgogICAgdHlwZTogJ3Rvb2xiYXInLAoKICAgIAogICAgdHJpZ2dlcldpZHRoOiAxOCwKCiAgICAKICAgIG5vSXRlbXNNZW51VGV4dCA6ICc8ZGl2IGNsYXNzPSJ4LXRvb2xiYXItbm8taXRlbXMiPihOb25lKTwvZGl2PicsCgogICAgCiAgICBsYXN0T3ZlcmZsb3c6IGZhbHNlLAoKICAgIAogICAgdGFibGVIVE1MOiBbCiAgICAgICAgJzx0YWJsZSBjZWxsc3BhY2luZz0iMCIgY2xhc3M9IngtdG9vbGJhci1jdCI+JywKICAgICAgICAgICAgJzx0Ym9keT4nLAogICAgICAgICAgICAgICAgJzx0cj4nLAogICAgICAgICAgICAgICAgICAgICc8dGQgY2xhc3M9IngtdG9vbGJhci1sZWZ0IiBhbGlnbj0iezB9Ij4nLAogICAgICAgICAgICAgICAgICAgICAgICAnPHRhYmxlIGNlbGxzcGFjaW5nPSIwIj4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzx0Ym9keT4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8dHIgY2xhc3M9IngtdG9vbGJhci1sZWZ0LXJvdyI+PC90cj4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvdGJvZHk+JywKICAgICAgICAgICAgICAgICAgICAgICAgJzwvdGFibGU+JywKICAgICAgICAgICAgICAgICAgICAnPC90ZD4nLAogICAgICAgICAgICAgICAgICAgICc8dGQgY2xhc3M9IngtdG9vbGJhci1yaWdodCIgYWxpZ249InJpZ2h0Ij4nLAogICAgICAgICAgICAgICAgICAgICAgICAnPHRhYmxlIGNlbGxzcGFjaW5nPSIwIiBjbGFzcz0ieC10b29sYmFyLXJpZ2h0LWN0Ij4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJzx0Ym9keT4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8dHI+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzx0ZD4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzx0YWJsZSBjZWxsc3BhY2luZz0iMCI+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHRib2R5PicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8dHIgY2xhc3M9IngtdG9vbGJhci1yaWdodC1yb3ciPjwvdHI+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC90Ym9keT4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvdGFibGU+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvdGQ+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzx0ZD4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzx0YWJsZSBjZWxsc3BhY2luZz0iMCI+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHRib2R5PicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8dHIgY2xhc3M9IngtdG9vbGJhci1leHRyYXMtcm93Ij48L3RyPicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvdGJvZHk+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L3RhYmxlPicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L3RkPicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvdHI+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L3Rib2R5PicsCiAgICAgICAgICAgICAgICAgICAgICAgICc8L3RhYmxlPicsCiAgICAgICAgICAgICAgICAgICAgJzwvdGQ+JywKICAgICAgICAgICAgICAgICc8L3RyPicsCiAgICAgICAgICAgICc8L3Rib2R5PicsCiAgICAgICAgJzwvdGFibGU+JwogICAgXS5qb2luKCIiKSwKCiAgICAKICAgIG9uTGF5b3V0IDogZnVuY3Rpb24oY3QsIHRhcmdldCkgewogICAgICAgIAogICAgICAgIGlmICghdGhpcy5sZWZ0VHIpIHsKICAgICAgICAgICAgdmFyIGFsaWduID0gY3QuYnV0dG9uQWxpZ24gPT0gJ2NlbnRlcicgPyAnY2VudGVyJyA6ICdsZWZ0JzsKCiAgICAgICAgICAgIHRhcmdldC5hZGRDbGFzcygneC10b29sYmFyLWxheW91dC1jdCcpOwogICAgICAgICAgICB0YXJnZXQuaW5zZXJ0SHRtbCgnYmVmb3JlRW5kJywgU3RyaW5nLmZvcm1hdCh0aGlzLnRhYmxlSFRNTCwgYWxpZ24pKTsKCiAgICAgICAgICAgIHRoaXMubGVmdFRyICAgPSB0YXJnZXQuY2hpbGQoJ3RyLngtdG9vbGJhci1sZWZ0LXJvdycsIHRydWUpOwogICAgICAgICAgICB0aGlzLnJpZ2h0VHIgID0gdGFyZ2V0LmNoaWxkKCd0ci54LXRvb2xiYXItcmlnaHQtcm93JywgdHJ1ZSk7CiAgICAgICAgICAgIHRoaXMuZXh0cmFzVHIgPSB0YXJnZXQuY2hpbGQoJ3RyLngtdG9vbGJhci1leHRyYXMtcm93JywgdHJ1ZSk7CgogICAgICAgICAgICBpZiAodGhpcy5oaWRkZW5JdGVtID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmhpZGRlbkl0ZW1zID0gW107CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBzaWRlICAgICA9IGN0LmJ1dHRvbkFsaWduID09ICdyaWdodCcgPyB0aGlzLnJpZ2h0VHIgOiB0aGlzLmxlZnRUciwKICAgICAgICAgICAgaXRlbXMgICAgPSBjdC5pdGVtcy5pdGVtcywKICAgICAgICAgICAgcG9zaXRpb24gPSAwOwoKICAgICAgICAKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gaXRlbXMubGVuZ3RoLCBjOyBpIDwgbGVuOyBpKyssIHBvc2l0aW9uKyspIHsKICAgICAgICAgICAgYyA9IGl0ZW1zW2ldOwoKICAgICAgICAgICAgaWYgKGMuaXNGaWxsKSB7CiAgICAgICAgICAgICAgICBzaWRlICAgPSB0aGlzLnJpZ2h0VHI7CiAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IC0xOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFjLnJlbmRlcmVkKSB7CiAgICAgICAgICAgICAgICBjLnJlbmRlcih0aGlzLmluc2VydENlbGwoYywgc2lkZSwgcG9zaXRpb24pKTsKICAgICAgICAgICAgICAgIHRoaXMuY29uZmlndXJlSXRlbShjKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghYy54dGJIaWRkZW4gJiYgIXRoaXMuaXNWYWxpZFBhcmVudChjLCBzaWRlLmNoaWxkTm9kZXNbcG9zaXRpb25dKSkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZCA9IHRoaXMuaW5zZXJ0Q2VsbChjLCBzaWRlLCBwb3NpdGlvbik7CiAgICAgICAgICAgICAgICAgICAgdGQuYXBwZW5kQ2hpbGQoYy5nZXRQb3NpdGlvbkVsKCkuZG9tKTsKICAgICAgICAgICAgICAgICAgICBjLmNvbnRhaW5lciA9IEV4dC5nZXQodGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICB0aGlzLmNsZWFudXAodGhpcy5sZWZ0VHIpOwogICAgICAgIHRoaXMuY2xlYW51cCh0aGlzLnJpZ2h0VHIpOwogICAgICAgIHRoaXMuY2xlYW51cCh0aGlzLmV4dHJhc1RyKTsKICAgICAgICB0aGlzLmZpdFRvU2l6ZSh0YXJnZXQpOwogICAgfSwKCiAgICAKICAgIGNsZWFudXAgOiBmdW5jdGlvbihlbCkgewogICAgICAgIHZhciBjbiA9IGVsLmNoaWxkTm9kZXMsIGksIGM7CgogICAgICAgIGZvciAoaSA9IGNuLmxlbmd0aC0xOyBpID49IDAgJiYgKGMgPSBjbltpXSk7IGktLSkgewogICAgICAgICAgICBpZiAoIWMuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgZWwucmVtb3ZlQ2hpbGQoYyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaW5zZXJ0Q2VsbCA6IGZ1bmN0aW9uKGMsIHRhcmdldCwgcG9zaXRpb24pIHsKICAgICAgICB2YXIgdGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZCcpOwogICAgICAgIHRkLmNsYXNzTmFtZSA9ICd4LXRvb2xiYXItY2VsbCc7CgogICAgICAgIHRhcmdldC5pbnNlcnRCZWZvcmUodGQsIHRhcmdldC5jaGlsZE5vZGVzW3Bvc2l0aW9uXSB8fCBudWxsKTsKCiAgICAgICAgcmV0dXJuIHRkOwogICAgfSwKCiAgICAKICAgIGhpZGVJdGVtIDogZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHRoaXMuaGlkZGVuSXRlbXMucHVzaChpdGVtKTsKCiAgICAgICAgaXRlbS54dGJIaWRkZW4gPSB0cnVlOwogICAgICAgIGl0ZW0ueHRiV2lkdGggPSBpdGVtLmdldFBvc2l0aW9uRWwoKS5kb20ucGFyZW50Tm9kZS5vZmZzZXRXaWR0aDsKICAgICAgICBpdGVtLmhpZGUoKTsKICAgIH0sCgogICAgCiAgICB1bmhpZGVJdGVtIDogZnVuY3Rpb24oaXRlbSkgewogICAgICAgIGl0ZW0uc2hvdygpOwogICAgICAgIGl0ZW0ueHRiSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdGhpcy5oaWRkZW5JdGVtcy5yZW1vdmUoaXRlbSk7CiAgICB9LAoKICAgIAogICAgZ2V0SXRlbVdpZHRoIDogZnVuY3Rpb24oYykgewogICAgICAgIHJldHVybiBjLmhpZGRlbiA/IChjLnh0YldpZHRoIHx8IDApIDogYy5nZXRQb3NpdGlvbkVsKCkuZG9tLnBhcmVudE5vZGUub2Zmc2V0V2lkdGg7CiAgICB9LAoKICAgIAogICAgZml0VG9TaXplIDogZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyLmVuYWJsZU92ZXJmbG93ID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgd2lkdGggICAgICAgPSB0YXJnZXQuZG9tLmNsaWVudFdpZHRoLAogICAgICAgICAgICB0YWJsZVdpZHRoICA9IHRhcmdldC5kb20uZmlyc3RDaGlsZC5vZmZzZXRXaWR0aCwKICAgICAgICAgICAgY2xpcFdpZHRoICAgPSB3aWR0aCAtIHRoaXMudHJpZ2dlcldpZHRoLAogICAgICAgICAgICBsYXN0V2lkdGggICA9IHRoaXMubGFzdFdpZHRoIHx8IDAsCgogICAgICAgICAgICBoaWRkZW5JdGVtcyA9IHRoaXMuaGlkZGVuSXRlbXMsCiAgICAgICAgICAgIGhhc0hpZGRlbnMgID0gaGlkZGVuSXRlbXMubGVuZ3RoICE9IDAsCiAgICAgICAgICAgIGlzTGFyZ2VyICAgID0gd2lkdGggPj0gbGFzdFdpZHRoOwoKICAgICAgICB0aGlzLmxhc3RXaWR0aCAgPSB3aWR0aDsKCiAgICAgICAgaWYgKHRhYmxlV2lkdGggPiB3aWR0aCB8fCAoaGFzSGlkZGVucyAmJiBpc0xhcmdlcikpIHsKICAgICAgICAgICAgdmFyIGl0ZW1zICAgICA9IHRoaXMuY29udGFpbmVyLml0ZW1zLml0ZW1zLAogICAgICAgICAgICAgICAgbGVuICAgICAgID0gaXRlbXMubGVuZ3RoLAogICAgICAgICAgICAgICAgbG9vcFdpZHRoID0gMCwKICAgICAgICAgICAgICAgIGl0ZW07CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBpdGVtID0gaXRlbXNbaV07CgogICAgICAgICAgICAgICAgaWYgKCFpdGVtLmlzRmlsbCkgewogICAgICAgICAgICAgICAgICAgIGxvb3BXaWR0aCArPSB0aGlzLmdldEl0ZW1XaWR0aChpdGVtKTsKICAgICAgICAgICAgICAgICAgICBpZiAobG9vcFdpZHRoID4gY2xpcFdpZHRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKGl0ZW0uaGlkZGVuIHx8IGl0ZW0ueHRiSGlkZGVuKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlSXRlbShpdGVtKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXRlbS54dGJIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51bmhpZGVJdGVtKGl0ZW0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaGFzSGlkZGVucyA9IGhpZGRlbkl0ZW1zLmxlbmd0aCAhPSAwOwoKICAgICAgICBpZiAoaGFzSGlkZGVucykgewogICAgICAgICAgICB0aGlzLmluaXRNb3JlKCk7CgogICAgICAgICAgICBpZiAoIXRoaXMubGFzdE92ZXJmbG93KSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5maXJlRXZlbnQoJ292ZXJmbG93Y2hhbmdlJywgdGhpcy5jb250YWluZXIsIHRydWUpOwogICAgICAgICAgICAgICAgdGhpcy5sYXN0T3ZlcmZsb3cgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLm1vcmUpIHsKICAgICAgICAgICAgdGhpcy5jbGVhck1lbnUoKTsKICAgICAgICAgICAgdGhpcy5tb3JlLmRlc3Ryb3koKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubW9yZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmxhc3RPdmVyZmxvdykgewogICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIuZmlyZUV2ZW50KCdvdmVyZmxvd2NoYW5nZScsIHRoaXMuY29udGFpbmVyLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3RPdmVyZmxvdyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNyZWF0ZU1lbnVDb25maWcgOiBmdW5jdGlvbihjb21wb25lbnQsIGhpZGVPbkNsaWNrKXsKICAgICAgICB2YXIgY29uZmlnID0gRXh0LmFwcGx5KHt9LCBjb21wb25lbnQuaW5pdGlhbENvbmZpZyksCiAgICAgICAgICAgIGdyb3VwICA9IGNvbXBvbmVudC50b2dnbGVHcm91cDsKCiAgICAgICAgRXh0LmNvcHlUbyhjb25maWcsIGNvbXBvbmVudCwgWwogICAgICAgICAgICAnaWNvbkNscycsICdpY29uJywgJ2l0ZW1JZCcsICdkaXNhYmxlZCcsICdoYW5kbGVyJywgJ3Njb3BlJywgJ21lbnUnCiAgICAgICAgXSk7CgogICAgICAgIEV4dC5hcHBseShjb25maWcsIHsKICAgICAgICAgICAgdGV4dCAgICAgICA6IGNvbXBvbmVudC5vdmVyZmxvd1RleHQgfHwgY29tcG9uZW50LnRleHQsCiAgICAgICAgICAgIGhpZGVPbkNsaWNrOiBoaWRlT25DbGljawogICAgICAgIH0pOwoKICAgICAgICBpZiAoZ3JvdXAgfHwgY29tcG9uZW50LmVuYWJsZVRvZ2dsZSkgewogICAgICAgICAgICBFeHQuYXBwbHkoY29uZmlnLCB7CiAgICAgICAgICAgICAgICBncm91cCAgOiBncm91cCwKICAgICAgICAgICAgICAgIGNoZWNrZWQ6IGNvbXBvbmVudC5wcmVzc2VkLAogICAgICAgICAgICAgICAgbGlzdGVuZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tjaGFuZ2U6IGZ1bmN0aW9uKGl0ZW0sIGNoZWNrZWQpewogICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQudG9nZ2xlKGNoZWNrZWQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgY29uZmlnLm93bmVyQ3Q7CiAgICAgICAgZGVsZXRlIGNvbmZpZy54dHlwZTsKICAgICAgICBkZWxldGUgY29uZmlnLmlkOwoKICAgICAgICByZXR1cm4gY29uZmlnOwogICAgfSwKCiAgICAKICAgIGFkZENvbXBvbmVudFRvTWVudSA6IGZ1bmN0aW9uKG1lbnUsIGNvbXBvbmVudCkgewogICAgICAgIGlmIChjb21wb25lbnQgaW5zdGFuY2VvZiBFeHQuVG9vbGJhci5TZXBhcmF0b3IpIHsKICAgICAgICAgICAgbWVudS5hZGQoJy0nKTsKCiAgICAgICAgfSBlbHNlIGlmIChFeHQuaXNGdW5jdGlvbihjb21wb25lbnQuaXNYVHlwZSkpIHsKICAgICAgICAgICAgaWYgKGNvbXBvbmVudC5pc1hUeXBlKCdzcGxpdGJ1dHRvbicpKSB7CiAgICAgICAgICAgICAgICBtZW51LmFkZCh0aGlzLmNyZWF0ZU1lbnVDb25maWcoY29tcG9uZW50LCB0cnVlKSk7CgogICAgICAgICAgICB9IGVsc2UgaWYgKGNvbXBvbmVudC5pc1hUeXBlKCdidXR0b24nKSkgewogICAgICAgICAgICAgICAgbWVudS5hZGQodGhpcy5jcmVhdGVNZW51Q29uZmlnKGNvbXBvbmVudCwgIWNvbXBvbmVudC5tZW51KSk7CgogICAgICAgICAgICB9IGVsc2UgaWYgKGNvbXBvbmVudC5pc1hUeXBlKCdidXR0b25ncm91cCcpKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnQuaXRlbXMuZWFjaChmdW5jdGlvbihpdGVtKXsKICAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRDb21wb25lbnRUb01lbnUobWVudSwgaXRlbSk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBjbGVhck1lbnUgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBtZW51ID0gdGhpcy5tb3JlTWVudTsKICAgICAgICBpZiAobWVudSAmJiBtZW51Lml0ZW1zKSB7CiAgICAgICAgICAgIG1lbnUuaXRlbXMuZWFjaChmdW5jdGlvbihpdGVtKXsKICAgICAgICAgICAgICAgIGRlbGV0ZSBpdGVtLm1lbnU7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBiZWZvcmVNb3JlU2hvdyA6IGZ1bmN0aW9uKG1lbnUpIHsKICAgICAgICB2YXIgaXRlbXMgPSB0aGlzLmNvbnRhaW5lci5pdGVtcy5pdGVtcywKICAgICAgICAgICAgbGVuICAgPSBpdGVtcy5sZW5ndGgsCiAgICAgICAgICAgIGl0ZW0sCiAgICAgICAgICAgIHByZXY7CgogICAgICAgIHZhciBuZWVkc1NlcCA9IGZ1bmN0aW9uKGdyb3VwLCBpdGVtKXsKICAgICAgICAgICAgcmV0dXJuIGdyb3VwLmlzWFR5cGUoJ2J1dHRvbmdyb3VwJykgJiYgIShpdGVtIGluc3RhbmNlb2YgRXh0LlRvb2xiYXIuU2VwYXJhdG9yKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmNsZWFyTWVudSgpOwogICAgICAgIG1lbnUucmVtb3ZlQWxsKCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBpdGVtID0gaXRlbXNbaV07CiAgICAgICAgICAgIGlmIChpdGVtLnh0YkhpZGRlbikgewogICAgICAgICAgICAgICAgaWYgKHByZXYgJiYgKG5lZWRzU2VwKGl0ZW0sIHByZXYpIHx8IG5lZWRzU2VwKHByZXYsIGl0ZW0pKSkgewogICAgICAgICAgICAgICAgICAgIG1lbnUuYWRkKCctJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmFkZENvbXBvbmVudFRvTWVudShtZW51LCBpdGVtKTsKICAgICAgICAgICAgICAgIHByZXYgPSBpdGVtOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBpZiAobWVudS5pdGVtcy5sZW5ndGggPCAxKSB7CiAgICAgICAgICAgIG1lbnUuYWRkKHRoaXMubm9JdGVtc01lbnVUZXh0KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaW5pdE1vcmUgOiBmdW5jdGlvbigpewogICAgICAgIGlmICghdGhpcy5tb3JlKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1vcmVNZW51ID0gbmV3IEV4dC5tZW51Lk1lbnUoewogICAgICAgICAgICAgICAgb3duZXJDdCA6IHRoaXMuY29udGFpbmVyLAogICAgICAgICAgICAgICAgbGlzdGVuZXJzOiB7CiAgICAgICAgICAgICAgICAgICAgYmVmb3Jlc2hvdzogdGhpcy5iZWZvcmVNb3JlU2hvdywKICAgICAgICAgICAgICAgICAgICBzY29wZTogdGhpcwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1vcmUgPSBuZXcgRXh0LkJ1dHRvbih7CiAgICAgICAgICAgICAgICBpY29uQ2xzOiAneC10b29sYmFyLW1vcmUtaWNvbicsCiAgICAgICAgICAgICAgICBjbHMgICAgOiAneC10b29sYmFyLW1vcmUnLAogICAgICAgICAgICAgICAgbWVudSAgIDogdGhpcy5tb3JlTWVudSwKICAgICAgICAgICAgICAgIG93bmVyQ3Q6IHRoaXMuY29udGFpbmVyCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIHRkID0gdGhpcy5pbnNlcnRDZWxsKHRoaXMubW9yZSwgdGhpcy5leHRyYXNUciwgMTAwKTsKICAgICAgICAgICAgdGhpcy5tb3JlLnJlbmRlcih0ZCk7CiAgICAgICAgfQogICAgfSwKCiAgICBkZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZGVzdHJveSh0aGlzLm1vcmUsIHRoaXMubW9yZU1lbnUpOwogICAgICAgIGRlbGV0ZSB0aGlzLmxlZnRUcjsKICAgICAgICBkZWxldGUgdGhpcy5yaWdodFRyOwogICAgICAgIGRlbGV0ZSB0aGlzLmV4dHJhc1RyOwogICAgICAgIEV4dC5sYXlvdXQuVG9vbGJhckxheW91dC5zdXBlcmNsYXNzLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0KfSk7CgpFeHQuQ29udGFpbmVyLkxBWU9VVFMudG9vbGJhciA9IEV4dC5sYXlvdXQuVG9vbGJhckxheW91dDsKCiBFeHQubGF5b3V0Lk1lbnVMYXlvdXQgPSBFeHQuZXh0ZW5kKEV4dC5sYXlvdXQuQ29udGFpbmVyTGF5b3V0LCB7CiAgICBtb25pdG9yUmVzaXplIDogdHJ1ZSwKCiAgICB0eXBlOiAnbWVudScsCgogICAgc2V0Q29udGFpbmVyIDogZnVuY3Rpb24oY3QpewogICAgICAgIHRoaXMubW9uaXRvclJlc2l6ZSA9ICFjdC5mbG9hdGluZzsKICAgICAgICAKICAgICAgICAKICAgICAgICBjdC5vbignYXV0b3NpemUnLCB0aGlzLmRvQXV0b1NpemUsIHRoaXMpOwogICAgICAgIEV4dC5sYXlvdXQuTWVudUxheW91dC5zdXBlcmNsYXNzLnNldENvbnRhaW5lci5jYWxsKHRoaXMsIGN0KTsKICAgIH0sCgogICAgcmVuZGVySXRlbSA6IGZ1bmN0aW9uKGMsIHBvc2l0aW9uLCB0YXJnZXQpewogICAgICAgIGlmICghdGhpcy5pdGVtVHBsKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbVRwbCA9IEV4dC5sYXlvdXQuTWVudUxheW91dC5wcm90b3R5cGUuaXRlbVRwbCA9IG5ldyBFeHQuWFRlbXBsYXRlKAogICAgICAgICAgICAgICAgJzxsaSBpZD0ie2l0ZW1JZH0iIGNsYXNzPSJ7aXRlbUNsc30iPicsCiAgICAgICAgICAgICAgICAgICAgJzx0cGwgaWY9Im5lZWRzSWNvbiI+JywKICAgICAgICAgICAgICAgICAgICAgICAgJzxpbWcgYWx0PSJ7YWx0VGV4dH0iIHNyYz0ie2ljb259IiBjbGFzcz0ie2ljb25DbHN9Ii8+JywKICAgICAgICAgICAgICAgICAgICAnPC90cGw+JywKICAgICAgICAgICAgICAgICc8L2xpPicKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGlmKGMgJiYgIWMucmVuZGVyZWQpewogICAgICAgICAgICBpZihFeHQuaXNOdW1iZXIocG9zaXRpb24pKXsKICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gdGFyZ2V0LmRvbS5jaGlsZE5vZGVzW3Bvc2l0aW9uXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYSA9IHRoaXMuZ2V0SXRlbUFyZ3MoYyk7CgoKICAgICAgICAgICAgYy5yZW5kZXIoYy5wb3NpdGlvbkVsID0gcG9zaXRpb24gPwogICAgICAgICAgICAgICAgdGhpcy5pdGVtVHBsLmluc2VydEJlZm9yZShwb3NpdGlvbiwgYSwgdHJ1ZSkgOgogICAgICAgICAgICAgICAgdGhpcy5pdGVtVHBsLmFwcGVuZCh0YXJnZXQsIGEsIHRydWUpKTsKCgogICAgICAgICAgICBjLnBvc2l0aW9uRWwubWVudUl0ZW1JZCA9IGMuZ2V0SXRlbUlkKCk7CgoKCiAgICAgICAgICAgIGlmICghYS5pc01lbnVJdGVtICYmIGEubmVlZHNJY29uKSB7CiAgICAgICAgICAgICAgICBjLnBvc2l0aW9uRWwuYWRkQ2xhc3MoJ3gtbWVudS1saXN0LWl0ZW0taW5kZW50Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jb25maWd1cmVJdGVtKGMpOwogICAgICAgIH1lbHNlIGlmKGMgJiYgIXRoaXMuaXNWYWxpZFBhcmVudChjLCB0YXJnZXQpKXsKICAgICAgICAgICAgaWYoRXh0LmlzTnVtYmVyKHBvc2l0aW9uKSl7CiAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHRhcmdldC5kb20uY2hpbGROb2Rlc1twb3NpdGlvbl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0LmRvbS5pbnNlcnRCZWZvcmUoYy5nZXRBY3Rpb25FbCgpLmRvbSwgcG9zaXRpb24gfHwgbnVsbCk7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRJdGVtQXJncyA6IGZ1bmN0aW9uKGMpIHsKICAgICAgICB2YXIgaXNNZW51SXRlbSA9IGMgaW5zdGFuY2VvZiBFeHQubWVudS5JdGVtLAogICAgICAgICAgICBjYW5IYXZlSWNvbiA9ICEoaXNNZW51SXRlbSB8fCBjIGluc3RhbmNlb2YgRXh0Lm1lbnUuU2VwYXJhdG9yKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaXNNZW51SXRlbTogaXNNZW51SXRlbSwKICAgICAgICAgICAgbmVlZHNJY29uOiBjYW5IYXZlSWNvbiAmJiAoYy5pY29uIHx8IGMuaWNvbkNscyksCiAgICAgICAgICAgIGljb246IGMuaWNvbiB8fCBFeHQuQkxBTktfSU1BR0VfVVJMLAogICAgICAgICAgICBpY29uQ2xzOiAneC1tZW51LWl0ZW0taWNvbiAnICsgKGMuaWNvbkNscyB8fCAnJyksCiAgICAgICAgICAgIGl0ZW1JZDogJ3gtbWVudS1lbC0nICsgYy5pZCwKICAgICAgICAgICAgaXRlbUNsczogJ3gtbWVudS1saXN0LWl0ZW0gJywKICAgICAgICAgICAgYWx0VGV4dDogYy5hbHRUZXh0IHx8ICcnCiAgICAgICAgfTsKICAgIH0sCgogICAgCiAgICBpc1ZhbGlkUGFyZW50IDogZnVuY3Rpb24oYywgdGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIGMuZWwudXAoJ2xpLngtbWVudS1saXN0LWl0ZW0nLCA1KS5kb20ucGFyZW50Tm9kZSA9PT0gKHRhcmdldC5kb20gfHwgdGFyZ2V0KTsKICAgIH0sCgogICAgb25MYXlvdXQgOiBmdW5jdGlvbihjdCwgdGFyZ2V0KXsKICAgICAgICBFeHQubGF5b3V0Lk1lbnVMYXlvdXQuc3VwZXJjbGFzcy5vbkxheW91dC5jYWxsKHRoaXMsIGN0LCB0YXJnZXQpOwogICAgICAgIHRoaXMuZG9BdXRvU2l6ZSgpOwogICAgfSwKCiAgICBkb0F1dG9TaXplIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY3QgPSB0aGlzLmNvbnRhaW5lciwgdyA9IGN0LndpZHRoOwogICAgICAgIGlmKGN0LmZsb2F0aW5nKXsKICAgICAgICAgICAgaWYodyl7CiAgICAgICAgICAgICAgICBjdC5zZXRXaWR0aCh3KTsKICAgICAgICAgICAgfWVsc2UgaWYoRXh0LmlzSUUpewogICAgICAgICAgICAgICAgY3Quc2V0V2lkdGgoRXh0LmlzU3RyaWN0ICYmIChFeHQuaXNJRTcgfHwgRXh0LmlzSUU4IHx8IEV4dC5pc0lFOSkgPyAnYXV0bycgOiBjdC5taW5XaWR0aCk7CiAgICAgICAgICAgICAgICB2YXIgZWwgPSBjdC5nZXRFbCgpLCB0ID0gZWwuZG9tLm9mZnNldFdpZHRoOyAKICAgICAgICAgICAgICAgIGN0LnNldFdpZHRoKGN0LmdldExheW91dFRhcmdldCgpLmdldFdpZHRoKCkgKyBlbC5nZXRGcmFtZVdpZHRoKCdscicpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfSk7CkV4dC5Db250YWluZXIuTEFZT1VUU1snbWVudSddID0gRXh0LmxheW91dC5NZW51TGF5b3V0OwoKRXh0LlZpZXdwb3J0ID0gRXh0LmV4dGVuZChFeHQuQ29udGFpbmVyLCB7CiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCgogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCkgewogICAgICAgIEV4dC5WaWV3cG9ydC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaHRtbCcpWzBdLmNsYXNzTmFtZSArPSAnIHgtdmlld3BvcnQnOwogICAgICAgIHRoaXMuZWwgPSBFeHQuZ2V0Qm9keSgpOwogICAgICAgIHRoaXMuZWwuc2V0SGVpZ2h0ID0gRXh0LmVtcHR5Rm47CiAgICAgICAgdGhpcy5lbC5zZXRXaWR0aCA9IEV4dC5lbXB0eUZuOwogICAgICAgIHRoaXMuZWwuc2V0U2l6ZSA9IEV4dC5lbXB0eUZuOwogICAgICAgIHRoaXMuZWwuZG9tLnNjcm9sbCA9ICdubyc7CiAgICAgICAgdGhpcy5hbGxvd0RvbU1vdmUgPSBmYWxzZTsKICAgICAgICB0aGlzLmF1dG9XaWR0aCA9IHRydWU7CiAgICAgICAgdGhpcy5hdXRvSGVpZ2h0ID0gdHJ1ZTsKICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLm9uV2luZG93UmVzaXplKHRoaXMuZmlyZVJlc2l6ZSwgdGhpcyk7CiAgICAgICAgdGhpcy5yZW5kZXJUbyA9IHRoaXMuZWw7CiAgICB9LAoKICAgIGZpcmVSZXNpemUgOiBmdW5jdGlvbih3LCBoKXsKICAgICAgICB0aGlzLmZpcmVFdmVudCgncmVzaXplJywgdGhpcywgdywgaCwgdywgaCk7CiAgICB9Cn0pOwpFeHQucmVnKCd2aWV3cG9ydCcsIEV4dC5WaWV3cG9ydCk7CgpFeHQuUGFuZWwgPSBFeHQuZXh0ZW5kKEV4dC5Db250YWluZXIsIHsKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCgogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKCgogICAgCiAgICBiYXNlQ2xzIDogJ3gtcGFuZWwnLAogICAgCiAgICBjb2xsYXBzZWRDbHMgOiAneC1wYW5lbC1jb2xsYXBzZWQnLAogICAgCiAgICBtYXNrRGlzYWJsZWQgOiB0cnVlLAogICAgCiAgICBhbmltQ29sbGFwc2UgOiBFeHQuZW5hYmxlRngsCiAgICAKICAgIGhlYWRlckFzVGV4dCA6IHRydWUsCiAgICAKICAgIGJ1dHRvbkFsaWduIDogJ3JpZ2h0JywKICAgIAogICAgY29sbGFwc2VkIDogZmFsc2UsCiAgICAKICAgIGNvbGxhcHNlRmlyc3QgOiB0cnVlLAogICAgCiAgICBtaW5CdXR0b25XaWR0aCA6IDc1LAogICAgCiAgICAKICAgIGVsZW1lbnRzIDogJ2JvZHknLAogICAgCiAgICBwcmV2ZW50Qm9keVJlc2V0IDogZmFsc2UsCgogICAgCiAgICBwYWRkaW5nOiB1bmRlZmluZWQsCgogICAgCiAgICByZXNpemVFdmVudDogJ2JvZHlyZXNpemUnLAoKICAgIAogICAgCiAgICAKICAgIHRvb2xUYXJnZXQgOiAnaGVhZGVyJywKICAgIGNvbGxhcHNlRWwgOiAnYndyYXAnLAogICAgc2xpZGVBbmNob3IgOiAndCcsCiAgICBkaXNhYmxlZENsYXNzIDogJycsCgogICAgCiAgICBkZWZlckhlaWdodCA6IHRydWUsCiAgICAKICAgIGV4cGFuZERlZmF1bHRzOiB7CiAgICAgICAgZHVyYXRpb24gOiAwLjI1CiAgICB9LAogICAgCiAgICBjb2xsYXBzZURlZmF1bHRzIDogewogICAgICAgIGR1cmF0aW9uIDogMC4yNQogICAgfSwKCiAgICAKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5QYW5lbC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKCiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAnYm9keXJlc2l6ZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAndGl0bGVjaGFuZ2UnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2ljb25jaGFuZ2UnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NvbGxhcHNlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdleHBhbmQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZWNvbGxhcHNlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVleHBhbmQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZWNsb3NlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjbG9zZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYWN0aXZhdGUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2RlYWN0aXZhdGUnCiAgICAgICAgKTsKCiAgICAgICAgaWYodGhpcy51bnN0eWxlZCl7CiAgICAgICAgICAgIHRoaXMuYmFzZUNscyA9ICd4LXBsYWluJzsKICAgICAgICB9CgoKICAgICAgICB0aGlzLnRvb2xiYXJzID0gW107CiAgICAgICAgCiAgICAgICAgaWYodGhpcy50YmFyKXsKICAgICAgICAgICAgdGhpcy5lbGVtZW50cyArPSAnLHRiYXInOwogICAgICAgICAgICB0aGlzLnRvcFRvb2xiYXIgPSB0aGlzLmNyZWF0ZVRvb2xiYXIodGhpcy50YmFyKTsKICAgICAgICAgICAgdGhpcy50YmFyID0gbnVsbDsKCiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuYmJhcil7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudHMgKz0gJyxiYmFyJzsKICAgICAgICAgICAgdGhpcy5ib3R0b21Ub29sYmFyID0gdGhpcy5jcmVhdGVUb29sYmFyKHRoaXMuYmJhcik7CiAgICAgICAgICAgIHRoaXMuYmJhciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLmhlYWRlciA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudHMgKz0gJyxoZWFkZXInOwogICAgICAgICAgICB0aGlzLmhlYWRlciA9IG51bGw7CiAgICAgICAgfWVsc2UgaWYodGhpcy5oZWFkZXJDZmcgfHwgKHRoaXMudGl0bGUgJiYgdGhpcy5oZWFkZXIgIT09IGZhbHNlKSl7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudHMgKz0gJyxoZWFkZXInOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5mb290ZXJDZmcgfHwgdGhpcy5mb290ZXIgPT09IHRydWUpewogICAgICAgICAgICB0aGlzLmVsZW1lbnRzICs9ICcsZm9vdGVyJzsKICAgICAgICAgICAgdGhpcy5mb290ZXIgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5idXR0b25zKXsKICAgICAgICAgICAgdGhpcy5mYmFyID0gdGhpcy5idXR0b25zOwogICAgICAgICAgICB0aGlzLmJ1dHRvbnMgPSBudWxsOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmZiYXIpewogICAgICAgICAgICB0aGlzLmNyZWF0ZUZiYXIodGhpcy5mYmFyKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5hdXRvTG9hZCl7CiAgICAgICAgICAgIHRoaXMub24oJ3JlbmRlcicsIHRoaXMuZG9BdXRvTG9hZCwgdGhpcywge2RlbGF5OjEwfSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNyZWF0ZUZiYXIgOiBmdW5jdGlvbihmYmFyKXsKICAgICAgICB2YXIgbWluID0gdGhpcy5taW5CdXR0b25XaWR0aDsKICAgICAgICB0aGlzLmVsZW1lbnRzICs9ICcsZm9vdGVyJzsKICAgICAgICB0aGlzLmZiYXIgPSB0aGlzLmNyZWF0ZVRvb2xiYXIoZmJhciwgewogICAgICAgICAgICBidXR0b25BbGlnbjogdGhpcy5idXR0b25BbGlnbiwKICAgICAgICAgICAgdG9vbGJhckNsczogJ3gtcGFuZWwtZmJhcicsCiAgICAgICAgICAgIGVuYWJsZU92ZXJmbG93OiBmYWxzZSwKICAgICAgICAgICAgZGVmYXVsdHM6IGZ1bmN0aW9uKGMpewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICBtaW5XaWR0aDogYy5taW5XaWR0aCB8fCBtaW4KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICB0aGlzLmZiYXIuaXRlbXMuZWFjaChmdW5jdGlvbihjKXsKICAgICAgICAgICAgYy5taW5XaWR0aCA9IGMubWluV2lkdGggfHwgdGhpcy5taW5CdXR0b25XaWR0aDsKICAgICAgICB9LCB0aGlzKTsKICAgICAgICB0aGlzLmJ1dHRvbnMgPSB0aGlzLmZiYXIuaXRlbXMuaXRlbXM7CiAgICB9LAoKICAgIAogICAgY3JlYXRlVG9vbGJhcjogZnVuY3Rpb24odGIsIG9wdGlvbnMpewogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgCiAgICAgICAgaWYoRXh0LmlzQXJyYXkodGIpKXsKICAgICAgICAgICAgdGIgPSB7CiAgICAgICAgICAgICAgICBpdGVtczogdGIKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gdGIuZXZlbnRzID8gRXh0LmFwcGx5KHRiLCBvcHRpb25zKSA6IHRoaXMuY3JlYXRlQ29tcG9uZW50KEV4dC5hcHBseSh7fSwgdGIsIG9wdGlvbnMpLCAndG9vbGJhcicpOwogICAgICAgIHRoaXMudG9vbGJhcnMucHVzaChyZXN1bHQpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIAogICAgY3JlYXRlRWxlbWVudCA6IGZ1bmN0aW9uKG5hbWUsIHBub2RlKXsKICAgICAgICBpZih0aGlzW25hbWVdKXsKICAgICAgICAgICAgcG5vZGUuYXBwZW5kQ2hpbGQodGhpc1tuYW1lXS5kb20pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZihuYW1lID09PSAnYndyYXAnIHx8IHRoaXMuZWxlbWVudHMuaW5kZXhPZihuYW1lKSAhPSAtMSl7CiAgICAgICAgICAgIGlmKHRoaXNbbmFtZSsnQ2ZnJ10pewogICAgICAgICAgICAgICAgdGhpc1tuYW1lXSA9IEV4dC5mbHkocG5vZGUpLmNyZWF0ZUNoaWxkKHRoaXNbbmFtZSsnQ2ZnJ10pOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgZWwuY2xhc3NOYW1lID0gdGhpc1tuYW1lKydDbHMnXTsKICAgICAgICAgICAgICAgIHRoaXNbbmFtZV0gPSBFeHQuZ2V0KHBub2RlLmFwcGVuZENoaWxkKGVsKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpc1tuYW1lKydDc3NDbGFzcyddKXsKICAgICAgICAgICAgICAgIHRoaXNbbmFtZV0uYWRkQ2xhc3ModGhpc1tuYW1lKydDc3NDbGFzcyddKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzW25hbWUrJ1N0eWxlJ10pewogICAgICAgICAgICAgICAgdGhpc1tuYW1lXS5hcHBseVN0eWxlcyh0aGlzW25hbWUrJ1N0eWxlJ10pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKXsKICAgICAgICBFeHQuUGFuZWwuc3VwZXJjbGFzcy5vblJlbmRlci5jYWxsKHRoaXMsIGN0LCBwb3NpdGlvbik7CiAgICAgICAgdGhpcy5jcmVhdGVDbGFzc2VzKCk7CgogICAgICAgIHZhciBlbCA9IHRoaXMuZWwsCiAgICAgICAgICAgIGQgPSBlbC5kb20sCiAgICAgICAgICAgIGJ3LAogICAgICAgICAgICB0czsKCgogICAgICAgIGlmKHRoaXMuY29sbGFwc2libGUgJiYgIXRoaXMuaGlkZUNvbGxhcHNlVG9vbCl7CiAgICAgICAgICAgIHRoaXMudG9vbHMgPSB0aGlzLnRvb2xzID8gdGhpcy50b29scy5zbGljZSgwKSA6IFtdOwogICAgICAgICAgICB0aGlzLnRvb2xzW3RoaXMuY29sbGFwc2VGaXJzdD8ndW5zaGlmdCc6J3B1c2gnXSh7CiAgICAgICAgICAgICAgICBpZDogJ3RvZ2dsZScsCiAgICAgICAgICAgICAgICBoYW5kbGVyIDogdGhpcy50b2dnbGVDb2xsYXBzZSwKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy50b29scyl7CiAgICAgICAgICAgIHRzID0gdGhpcy50b29sczsKICAgICAgICAgICAgdGhpcy5lbGVtZW50cyArPSAodGhpcy5oZWFkZXIgIT09IGZhbHNlKSA/ICcsaGVhZGVyJyA6ICcnOwogICAgICAgIH0KICAgICAgICB0aGlzLnRvb2xzID0ge307CgogICAgICAgIGVsLmFkZENsYXNzKHRoaXMuYmFzZUNscyk7CiAgICAgICAgaWYoZC5maXJzdENoaWxkKXsgCiAgICAgICAgICAgIHRoaXMuaGVhZGVyID0gZWwuZG93bignLicrdGhpcy5oZWFkZXJDbHMpOwogICAgICAgICAgICB0aGlzLmJ3cmFwID0gZWwuZG93bignLicrdGhpcy5id3JhcENscyk7CiAgICAgICAgICAgIHZhciBjcCA9IHRoaXMuYndyYXAgPyB0aGlzLmJ3cmFwIDogZWw7CiAgICAgICAgICAgIHRoaXMudGJhciA9IGNwLmRvd24oJy4nK3RoaXMudGJhckNscyk7CiAgICAgICAgICAgIHRoaXMuYm9keSA9IGNwLmRvd24oJy4nK3RoaXMuYm9keUNscyk7CiAgICAgICAgICAgIHRoaXMuYmJhciA9IGNwLmRvd24oJy4nK3RoaXMuYmJhckNscyk7CiAgICAgICAgICAgIHRoaXMuZm9vdGVyID0gY3AuZG93bignLicrdGhpcy5mb290ZXJDbHMpOwogICAgICAgICAgICB0aGlzLmZyb21NYXJrdXAgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5wcmV2ZW50Qm9keVJlc2V0ID09PSB0cnVlKSB7CiAgICAgICAgICAgIGVsLmFkZENsYXNzKCd4LXBhbmVsLXJlc2V0Jyk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuY2xzKXsKICAgICAgICAgICAgZWwuYWRkQ2xhc3ModGhpcy5jbHMpOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5idXR0b25zKXsKICAgICAgICAgICAgdGhpcy5lbGVtZW50cyArPSAnLGZvb3Rlcic7CiAgICAgICAgfQoKICAgICAgICAKCiAgICAgICAgCiAgICAgICAgaWYodGhpcy5mcmFtZSl7CiAgICAgICAgICAgIGVsLmluc2VydEh0bWwoJ2FmdGVyQmVnaW4nLCBTdHJpbmcuZm9ybWF0KEV4dC5FbGVtZW50LmJveE1hcmt1cCwgdGhpcy5iYXNlQ2xzKSk7CgogICAgICAgICAgICB0aGlzLmNyZWF0ZUVsZW1lbnQoJ2hlYWRlcicsIGQuZmlyc3RDaGlsZC5maXJzdENoaWxkLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICB0aGlzLmNyZWF0ZUVsZW1lbnQoJ2J3cmFwJywgZCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgYncgPSB0aGlzLmJ3cmFwLmRvbTsKICAgICAgICAgICAgdmFyIG1sID0gZC5jaGlsZE5vZGVzWzFdLCBibCA9IGQuY2hpbGROb2Rlc1syXTsKICAgICAgICAgICAgYncuYXBwZW5kQ2hpbGQobWwpOwogICAgICAgICAgICBidy5hcHBlbmRDaGlsZChibCk7CgogICAgICAgICAgICB2YXIgbWMgPSBidy5maXJzdENoaWxkLmZpcnN0Q2hpbGQuZmlyc3RDaGlsZDsKICAgICAgICAgICAgdGhpcy5jcmVhdGVFbGVtZW50KCd0YmFyJywgbWMpOwogICAgICAgICAgICB0aGlzLmNyZWF0ZUVsZW1lbnQoJ2JvZHknLCBtYyk7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlRWxlbWVudCgnYmJhcicsIG1jKTsKICAgICAgICAgICAgdGhpcy5jcmVhdGVFbGVtZW50KCdmb290ZXInLCBidy5sYXN0Q2hpbGQuZmlyc3RDaGlsZC5maXJzdENoaWxkKTsKCiAgICAgICAgICAgIGlmKCF0aGlzLmZvb3Rlcil7CiAgICAgICAgICAgICAgICB0aGlzLmJ3cmFwLmRvbS5sYXN0Q2hpbGQuY2xhc3NOYW1lICs9ICcgeC1wYW5lbC1ub2Zvb3Rlcic7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZnQgPSBFeHQuZ2V0KHRoaXMuYndyYXAuZG9tLmxhc3RDaGlsZCk7CiAgICAgICAgICAgIHRoaXMubWMgPSBFeHQuZ2V0KG1jKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5jcmVhdGVFbGVtZW50KCdoZWFkZXInLCBkKTsKICAgICAgICAgICAgdGhpcy5jcmVhdGVFbGVtZW50KCdid3JhcCcsIGQpOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIGJ3ID0gdGhpcy5id3JhcC5kb207CiAgICAgICAgICAgIHRoaXMuY3JlYXRlRWxlbWVudCgndGJhcicsIGJ3KTsKICAgICAgICAgICAgdGhpcy5jcmVhdGVFbGVtZW50KCdib2R5JywgYncpOwogICAgICAgICAgICB0aGlzLmNyZWF0ZUVsZW1lbnQoJ2JiYXInLCBidyk7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlRWxlbWVudCgnZm9vdGVyJywgYncpOwoKICAgICAgICAgICAgaWYoIXRoaXMuaGVhZGVyKXsKICAgICAgICAgICAgICAgIHRoaXMuYm9keS5hZGRDbGFzcyh0aGlzLmJvZHlDbHMgKyAnLW5vaGVhZGVyJyk7CiAgICAgICAgICAgICAgICBpZih0aGlzLnRiYXIpewogICAgICAgICAgICAgICAgICAgIHRoaXMudGJhci5hZGRDbGFzcyh0aGlzLnRiYXJDbHMgKyAnLW5vaGVhZGVyJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmKEV4dC5pc0RlZmluZWQodGhpcy5wYWRkaW5nKSl7CiAgICAgICAgICAgIHRoaXMuYm9keS5zZXRTdHlsZSgncGFkZGluZycsIHRoaXMuYm9keS5hZGRVbml0cyh0aGlzLnBhZGRpbmcpKTsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuYm9yZGVyID09PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3ModGhpcy5iYXNlQ2xzICsgJy1ub2JvcmRlcicpOwogICAgICAgICAgICB0aGlzLmJvZHkuYWRkQ2xhc3ModGhpcy5ib2R5Q2xzICsgJy1ub2JvcmRlcicpOwogICAgICAgICAgICBpZih0aGlzLmhlYWRlcil7CiAgICAgICAgICAgICAgICB0aGlzLmhlYWRlci5hZGRDbGFzcyh0aGlzLmhlYWRlckNscyArICctbm9ib3JkZXInKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLmZvb3Rlcil7CiAgICAgICAgICAgICAgICB0aGlzLmZvb3Rlci5hZGRDbGFzcyh0aGlzLmZvb3RlckNscyArICctbm9ib3JkZXInKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLnRiYXIpewogICAgICAgICAgICAgICAgdGhpcy50YmFyLmFkZENsYXNzKHRoaXMudGJhckNscyArICctbm9ib3JkZXInKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLmJiYXIpewogICAgICAgICAgICAgICAgdGhpcy5iYmFyLmFkZENsYXNzKHRoaXMuYmJhckNscyArICctbm9ib3JkZXInKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5ib2R5Qm9yZGVyID09PSBmYWxzZSl7CiAgICAgICAgICAgdGhpcy5ib2R5LmFkZENsYXNzKHRoaXMuYm9keUNscyArICctbm9ib3JkZXInKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuYndyYXAuZW5hYmxlRGlzcGxheU1vZGUoJ2Jsb2NrJyk7CgogICAgICAgIGlmKHRoaXMuaGVhZGVyKXsKICAgICAgICAgICAgdGhpcy5oZWFkZXIudW5zZWxlY3RhYmxlKCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYodGhpcy5oZWFkZXJBc1RleHQpewogICAgICAgICAgICAgICAgdGhpcy5oZWFkZXIuZG9tLmlubmVySFRNTCA9CiAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPSInICsgdGhpcy5oZWFkZXJUZXh0Q2xzICsgJyI+Jyt0aGlzLmhlYWRlci5kb20uaW5uZXJIVE1MKyc8L3NwYW4+JzsKCiAgICAgICAgICAgICAgICBpZih0aGlzLmljb25DbHMpewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SWNvbkNsYXNzKHRoaXMuaWNvbkNscyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuZmxvYXRpbmcpewogICAgICAgICAgICB0aGlzLm1ha2VGbG9hdGluZyh0aGlzLmZsb2F0aW5nKTsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuY29sbGFwc2libGUgJiYgdGhpcy50aXRsZUNvbGxhcHNlICYmIHRoaXMuaGVhZGVyKXsKICAgICAgICAgICAgdGhpcy5tb24odGhpcy5oZWFkZXIsICdjbGljaycsIHRoaXMudG9nZ2xlQ29sbGFwc2UsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmhlYWRlci5zZXRTdHlsZSgnY3Vyc29yJywgJ3BvaW50ZXInKTsKICAgICAgICB9CiAgICAgICAgaWYodHMpewogICAgICAgICAgICB0aGlzLmFkZFRvb2wuYXBwbHkodGhpcywgdHMpOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYodGhpcy5mYmFyKXsKICAgICAgICAgICAgdGhpcy5mb290ZXIuYWRkQ2xhc3MoJ3gtcGFuZWwtYnRucycpOwogICAgICAgICAgICB0aGlzLmZiYXIub3duZXJDdCA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuZmJhci5yZW5kZXIodGhpcy5mb290ZXIpOwogICAgICAgICAgICB0aGlzLmZvb3Rlci5jcmVhdGVDaGlsZCh7Y2xzOid4LWNsZWFyJ30pOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnRiYXIgJiYgdGhpcy50b3BUb29sYmFyKXsKICAgICAgICAgICAgdGhpcy50b3BUb29sYmFyLm93bmVyQ3QgPSB0aGlzOwogICAgICAgICAgICB0aGlzLnRvcFRvb2xiYXIucmVuZGVyKHRoaXMudGJhcik7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuYmJhciAmJiB0aGlzLmJvdHRvbVRvb2xiYXIpewogICAgICAgICAgICB0aGlzLmJvdHRvbVRvb2xiYXIub3duZXJDdCA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuYm90dG9tVG9vbGJhci5yZW5kZXIodGhpcy5iYmFyKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0SWNvbkNsYXNzIDogZnVuY3Rpb24oY2xzKXsKICAgICAgICB2YXIgb2xkID0gdGhpcy5pY29uQ2xzOwogICAgICAgIHRoaXMuaWNvbkNscyA9IGNsczsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkICYmIHRoaXMuaGVhZGVyKXsKICAgICAgICAgICAgaWYodGhpcy5mcmFtZSl7CiAgICAgICAgICAgICAgICB0aGlzLmhlYWRlci5hZGRDbGFzcygneC1wYW5lbC1pY29uJyk7CiAgICAgICAgICAgICAgICB0aGlzLmhlYWRlci5yZXBsYWNlQ2xhc3Mob2xkLCB0aGlzLmljb25DbHMpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHZhciBoZCA9IHRoaXMuaGVhZGVyLAogICAgICAgICAgICAgICAgICAgIGltZyA9IGhkLmNoaWxkKCdpbWcueC1wYW5lbC1pbmxpbmUtaWNvbicpOwogICAgICAgICAgICAgICAgaWYoaW1nKXsKICAgICAgICAgICAgICAgICAgICBFeHQuZmx5KGltZykucmVwbGFjZUNsYXNzKG9sZCwgdGhpcy5pY29uQ2xzKTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIHZhciBoZHNwYW4gPSBoZC5jaGlsZCgnc3Bhbi4nICsgdGhpcy5oZWFkZXJUZXh0Q2xzKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaGRzcGFuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEV4dC5Eb21IZWxwZXIuaW5zZXJ0QmVmb3JlKGhkc3Bhbi5kb20sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZzonaW1nJywgYWx0OiAnJywgc3JjOiBFeHQuQkxBTktfSU1BR0VfVVJMLCBjbHM6J3gtcGFuZWwtaW5saW5lLWljb24gJyt0aGlzLmljb25DbHMKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgnaWNvbmNoYW5nZScsIHRoaXMsIGNscywgb2xkKTsKICAgIH0sCgogICAgCiAgICBtYWtlRmxvYXRpbmcgOiBmdW5jdGlvbihjZmcpewogICAgICAgIHRoaXMuZmxvYXRpbmcgPSB0cnVlOwogICAgICAgIHRoaXMuZWwgPSBuZXcgRXh0LkxheWVyKEV4dC5hcHBseSh7fSwgY2ZnLCB7CiAgICAgICAgICAgIHNoYWRvdzogRXh0LmlzRGVmaW5lZCh0aGlzLnNoYWRvdykgPyB0aGlzLnNoYWRvdyA6ICdzaWRlcycsCiAgICAgICAgICAgIHNoYWRvd09mZnNldDogdGhpcy5zaGFkb3dPZmZzZXQsCiAgICAgICAgICAgIGNvbnN0cmFpbjpmYWxzZSwKICAgICAgICAgICAgc2hpbTogdGhpcy5zaGltID09PSBmYWxzZSA/IGZhbHNlIDogdW5kZWZpbmVkCiAgICAgICAgfSksIHRoaXMuZWwpOwogICAgfSwKCiAgICAKICAgIGdldFRvcFRvb2xiYXIgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnRvcFRvb2xiYXI7CiAgICB9LAoKICAgIAogICAgZ2V0Qm90dG9tVG9vbGJhciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYm90dG9tVG9vbGJhcjsKICAgIH0sCgogICAgCiAgICBnZXRGb290ZXJUb29sYmFyIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmJhcjsKICAgIH0sCgogICAgCiAgICBhZGRCdXR0b24gOiBmdW5jdGlvbihjb25maWcsIGhhbmRsZXIsIHNjb3BlKXsKICAgICAgICBpZighdGhpcy5mYmFyKXsKICAgICAgICAgICAgdGhpcy5jcmVhdGVGYmFyKFtdKTsKICAgICAgICB9CiAgICAgICAgaWYoaGFuZGxlcil7CiAgICAgICAgICAgIGlmKEV4dC5pc1N0cmluZyhjb25maWcpKXsKICAgICAgICAgICAgICAgIGNvbmZpZyA9IHt0ZXh0OiBjb25maWd9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbmZpZyA9IEV4dC5hcHBseSh7CiAgICAgICAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgICAgICAgc2NvcGU6IHNjb3BlCiAgICAgICAgICAgIH0sIGNvbmZpZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmZiYXIuYWRkKGNvbmZpZyk7CiAgICB9LAoKICAgIAogICAgYWRkVG9vbCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMucmVuZGVyZWQpewogICAgICAgICAgICBpZighdGhpcy50b29scyl7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2xzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXh0LmVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihhcmcpewogICAgICAgICAgICAgICAgdGhpcy50b29scy5wdXNoKGFyZyk7CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgICAKICAgICAgICBpZighdGhpc1t0aGlzLnRvb2xUYXJnZXRdKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZighdGhpcy50b29sVGVtcGxhdGUpewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHR0ID0gbmV3IEV4dC5UZW1wbGF0ZSgKICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC10b29sIHgtdG9vbC17aWR9Ij4mIzE2MDs8L2Rpdj4nCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHR0LmRpc2FibGVGb3JtYXRzID0gdHJ1ZTsKICAgICAgICAgICAgdHQuY29tcGlsZSgpOwogICAgICAgICAgICBFeHQuUGFuZWwucHJvdG90eXBlLnRvb2xUZW1wbGF0ZSA9IHR0OwogICAgICAgIH0KICAgICAgICBmb3IodmFyIGkgPSAwLCBhID0gYXJndW1lbnRzLCBsZW4gPSBhLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciB0YyA9IGFbaV07CiAgICAgICAgICAgIGlmKCF0aGlzLnRvb2xzW3RjLmlkXSl7CiAgICAgICAgICAgICAgICB2YXIgb3ZlckNscyA9ICd4LXRvb2wtJyt0Yy5pZCsnLW92ZXInOwogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLnRvb2xUZW1wbGF0ZS5pbnNlcnRGaXJzdCh0aGlzW3RoaXMudG9vbFRhcmdldF0sIHRjLCB0cnVlKTsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHNbdGMuaWRdID0gdDsKICAgICAgICAgICAgICAgIHQuZW5hYmxlRGlzcGxheU1vZGUoJ2Jsb2NrJyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vbih0LCAnY2xpY2snLCAgdGhpcy5jcmVhdGVUb29sSGFuZGxlcih0LCB0Yywgb3ZlckNscywgdGhpcykpOwogICAgICAgICAgICAgICAgaWYodGMub24pewogICAgICAgICAgICAgICAgICAgIHRoaXMubW9uKHQsIHRjLm9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKHRjLmhpZGRlbil7CiAgICAgICAgICAgICAgICAgICAgdC5oaWRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZih0Yy5xdGlwKXsKICAgICAgICAgICAgICAgICAgICBpZihFeHQuaXNPYmplY3QodGMucXRpcCkpewogICAgICAgICAgICAgICAgICAgICAgICBFeHQuUXVpY2tUaXBzLnJlZ2lzdGVyKEV4dC5hcHBseSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldDogdC5pZAogICAgICAgICAgICAgICAgICAgICAgICB9LCB0Yy5xdGlwKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5kb20ucXRpcCA9IHRjLnF0aXA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdC5hZGRDbGFzc09uT3ZlcihvdmVyQ2xzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgb25MYXlvdXQgOiBmdW5jdGlvbihzaGFsbG93LCBmb3JjZSl7CiAgICAgICAgRXh0LlBhbmVsLnN1cGVyY2xhc3Mub25MYXlvdXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICBpZih0aGlzLmhhc0xheW91dCAmJiB0aGlzLnRvb2xiYXJzLmxlbmd0aCA+IDApewogICAgICAgICAgICBFeHQuZWFjaCh0aGlzLnRvb2xiYXJzLCBmdW5jdGlvbih0Yil7CiAgICAgICAgICAgICAgICB0Yi5kb0xheW91dCh1bmRlZmluZWQsIGZvcmNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuc3luY0hlaWdodCgpOwogICAgICAgIH0KICAgIH0sCgogICAgc3luY0hlaWdodCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGggPSB0aGlzLnRvb2xiYXJIZWlnaHQsCiAgICAgICAgICAgICAgICBiZCA9IHRoaXMuYm9keSwKICAgICAgICAgICAgICAgIGxzaCA9IHRoaXMubGFzdFNpemUuaGVpZ2h0LAogICAgICAgICAgICAgICAgc3o7CgogICAgICAgIGlmKHRoaXMuYXV0b0hlaWdodCB8fCAhRXh0LmlzRGVmaW5lZChsc2gpIHx8IGxzaCA9PSAnYXV0bycpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKCiAgICAgICAgaWYoaCAhPSB0aGlzLmdldFRvb2xiYXJIZWlnaHQoKSl7CiAgICAgICAgICAgIGggPSBNYXRoLm1heCgwLCBsc2ggLSB0aGlzLmdldEZyYW1lSGVpZ2h0KCkpOwogICAgICAgICAgICBiZC5zZXRIZWlnaHQoaCk7CiAgICAgICAgICAgIHN6ID0gYmQuZ2V0U2l6ZSgpOwogICAgICAgICAgICB0aGlzLnRvb2xiYXJIZWlnaHQgPSB0aGlzLmdldFRvb2xiYXJIZWlnaHQoKTsKICAgICAgICAgICAgdGhpcy5vbkJvZHlSZXNpemUoc3oud2lkdGgsIHN6LmhlaWdodCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uU2hvdyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5mbG9hdGluZyl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVsLnNob3coKTsKICAgICAgICB9CiAgICAgICAgRXh0LlBhbmVsLnN1cGVyY2xhc3Mub25TaG93LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgb25IaWRlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmZsb2F0aW5nKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWwuaGlkZSgpOwogICAgICAgIH0KICAgICAgICBFeHQuUGFuZWwuc3VwZXJjbGFzcy5vbkhpZGUuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVUb29sSGFuZGxlciA6IGZ1bmN0aW9uKHQsIHRjLCBvdmVyQ2xzLCBwYW5lbCl7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpewogICAgICAgICAgICB0LnJlbW92ZUNsYXNzKG92ZXJDbHMpOwogICAgICAgICAgICBpZih0Yy5zdG9wRXZlbnQgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGMuaGFuZGxlcil7CiAgICAgICAgICAgICAgICB0Yy5oYW5kbGVyLmNhbGwodGMuc2NvcGUgfHwgdCwgZSwgdCwgcGFuZWwsIHRjKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9LAoKICAgIAogICAgYWZ0ZXJSZW5kZXIgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuZmxvYXRpbmcgJiYgIXRoaXMuaGlkZGVuKXsKICAgICAgICAgICAgdGhpcy5lbC5zaG93KCk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMudGl0bGUpewogICAgICAgICAgICB0aGlzLnNldFRpdGxlKHRoaXMudGl0bGUpOwogICAgICAgIH0KICAgICAgICBFeHQuUGFuZWwuc3VwZXJjbGFzcy5hZnRlclJlbmRlci5jYWxsKHRoaXMpOyAKICAgICAgICBpZiAodGhpcy5jb2xsYXBzZWQpIHsKICAgICAgICAgICAgdGhpcy5jb2xsYXBzZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jb2xsYXBzZShmYWxzZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgfSwKCiAgICAKICAgIGdldEtleU1hcCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMua2V5TWFwKXsKICAgICAgICAgICAgdGhpcy5rZXlNYXAgPSBuZXcgRXh0LktleU1hcCh0aGlzLmVsLCB0aGlzLmtleXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5rZXlNYXA7CiAgICB9LAoKICAgIAogICAgaW5pdEV2ZW50cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5rZXlzKXsKICAgICAgICAgICAgdGhpcy5nZXRLZXlNYXAoKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5kcmFnZ2FibGUpewogICAgICAgICAgICB0aGlzLmluaXREcmFnZ2FibGUoKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy50b29sYmFycy5sZW5ndGggPiAwKXsKICAgICAgICAgICAgRXh0LmVhY2godGhpcy50b29sYmFycywgZnVuY3Rpb24odGIpewogICAgICAgICAgICAgICAgdGIuZG9MYXlvdXQoKTsKICAgICAgICAgICAgICAgIHRiLm9uKHsKICAgICAgICAgICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgICAgICAgICBhZnRlcmxheW91dDogdGhpcy5zeW5jSGVpZ2h0LAogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogdGhpcy5zeW5jSGVpZ2h0CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuc3luY0hlaWdodCgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIAogICAgaW5pdERyYWdnYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgCiAgICAgICAgdGhpcy5kZCA9IG5ldyBFeHQuUGFuZWwuREQodGhpcywgRXh0LmlzQm9vbGVhbih0aGlzLmRyYWdnYWJsZSkgPyBudWxsIDogdGhpcy5kcmFnZ2FibGUpOwogICAgfSwKCiAgICAKICAgIGJlZm9yZUVmZmVjdCA6IGZ1bmN0aW9uKGFuaW0pewogICAgICAgIGlmKHRoaXMuZmxvYXRpbmcpewogICAgICAgICAgICB0aGlzLmVsLmJlZm9yZUFjdGlvbigpOwogICAgICAgIH0KICAgICAgICBpZihhbmltICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3MoJ3gtcGFuZWwtYW5pbWF0ZWQnKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYWZ0ZXJFZmZlY3QgOiBmdW5jdGlvbihhbmltKXsKICAgICAgICB0aGlzLnN5bmNTaGFkb3coKTsKICAgICAgICB0aGlzLmVsLnJlbW92ZUNsYXNzKCd4LXBhbmVsLWFuaW1hdGVkJyk7CiAgICB9LAoKICAgIAogICAgY3JlYXRlRWZmZWN0IDogZnVuY3Rpb24oYSwgY2IsIHNjb3BlKXsKICAgICAgICB2YXIgbyA9IHsKICAgICAgICAgICAgc2NvcGU6c2NvcGUsCiAgICAgICAgICAgIGJsb2NrOnRydWUKICAgICAgICB9OwogICAgICAgIGlmKGEgPT09IHRydWUpewogICAgICAgICAgICBvLmNhbGxiYWNrID0gY2I7CiAgICAgICAgICAgIHJldHVybiBvOwogICAgICAgIH1lbHNlIGlmKCFhLmNhbGxiYWNrKXsKICAgICAgICAgICAgby5jYWxsYmFjayA9IGNiOwogICAgICAgIH1lbHNlIHsgCiAgICAgICAgICAgIG8uY2FsbGJhY2sgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgY2IuY2FsbChzY29wZSk7CiAgICAgICAgICAgICAgICBFeHQuY2FsbGJhY2soYS5jYWxsYmFjaywgYS5zY29wZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBFeHQuYXBwbHlJZihvLCBhKTsKICAgIH0sCgogICAgCiAgICBjb2xsYXBzZSA6IGZ1bmN0aW9uKGFuaW1hdGUpewogICAgICAgIGlmKHRoaXMuY29sbGFwc2VkIHx8IHRoaXMuZWwuaGFzRnhCbG9jaygpIHx8IHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVjb2xsYXBzZScsIHRoaXMsIGFuaW1hdGUpID09PSBmYWxzZSl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGRvQW5pbSA9IGFuaW1hdGUgPT09IHRydWUgfHwgKGFuaW1hdGUgIT09IGZhbHNlICYmIHRoaXMuYW5pbUNvbGxhcHNlKTsKICAgICAgICB0aGlzLmJlZm9yZUVmZmVjdChkb0FuaW0pOwogICAgICAgIHRoaXMub25Db2xsYXBzZShkb0FuaW0sIGFuaW1hdGUpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIG9uQ29sbGFwc2UgOiBmdW5jdGlvbihkb0FuaW0sIGFuaW1BcmcpewogICAgICAgIGlmKGRvQW5pbSl7CiAgICAgICAgICAgIHRoaXNbdGhpcy5jb2xsYXBzZUVsXS5zbGlkZU91dCh0aGlzLnNsaWRlQW5jaG9yLAogICAgICAgICAgICAgICAgICAgIEV4dC5hcHBseSh0aGlzLmNyZWF0ZUVmZmVjdChhbmltQXJnfHx0cnVlLCB0aGlzLmFmdGVyQ29sbGFwc2UsIHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxhcHNlRGVmYXVsdHMpKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpc1t0aGlzLmNvbGxhcHNlRWxdLmhpZGUodGhpcy5oaWRlTW9kZSk7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJDb2xsYXBzZShmYWxzZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFmdGVyQ29sbGFwc2UgOiBmdW5jdGlvbihhbmltKXsKICAgICAgICB0aGlzLmNvbGxhcHNlZCA9IHRydWU7CiAgICAgICAgdGhpcy5lbC5hZGRDbGFzcyh0aGlzLmNvbGxhcHNlZENscyk7CiAgICAgICAgaWYoYW5pbSAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzW3RoaXMuY29sbGFwc2VFbF0uaGlkZSh0aGlzLmhpZGVNb2RlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hZnRlckVmZmVjdChhbmltKTsKCiAgICAgICAgCiAgICAgICAgdGhpcy5jYXNjYWRlKGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgaWYgKGMubGFzdFNpemUpIHsKICAgICAgICAgICAgICAgIGMubGFzdFNpemUgPSB7IHdpZHRoOiB1bmRlZmluZWQsIGhlaWdodDogdW5kZWZpbmVkIH07CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnY29sbGFwc2UnLCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBleHBhbmQgOiBmdW5jdGlvbihhbmltYXRlKXsKICAgICAgICBpZighdGhpcy5jb2xsYXBzZWQgfHwgdGhpcy5lbC5oYXNGeEJsb2NrKCkgfHwgdGhpcy5maXJlRXZlbnQoJ2JlZm9yZWV4cGFuZCcsIHRoaXMsIGFuaW1hdGUpID09PSBmYWxzZSl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGRvQW5pbSA9IGFuaW1hdGUgPT09IHRydWUgfHwgKGFuaW1hdGUgIT09IGZhbHNlICYmIHRoaXMuYW5pbUNvbGxhcHNlKTsKICAgICAgICB0aGlzLmVsLnJlbW92ZUNsYXNzKHRoaXMuY29sbGFwc2VkQ2xzKTsKICAgICAgICB0aGlzLmJlZm9yZUVmZmVjdChkb0FuaW0pOwogICAgICAgIHRoaXMub25FeHBhbmQoZG9BbmltLCBhbmltYXRlKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBvbkV4cGFuZCA6IGZ1bmN0aW9uKGRvQW5pbSwgYW5pbUFyZyl7CiAgICAgICAgaWYoZG9BbmltKXsKICAgICAgICAgICAgdGhpc1t0aGlzLmNvbGxhcHNlRWxdLnNsaWRlSW4odGhpcy5zbGlkZUFuY2hvciwKICAgICAgICAgICAgICAgICAgICBFeHQuYXBwbHkodGhpcy5jcmVhdGVFZmZlY3QoYW5pbUFyZ3x8dHJ1ZSwgdGhpcy5hZnRlckV4cGFuZCwgdGhpcyksCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhwYW5kRGVmYXVsdHMpKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpc1t0aGlzLmNvbGxhcHNlRWxdLnNob3codGhpcy5oaWRlTW9kZSk7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJFeHBhbmQoZmFsc2UpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhZnRlckV4cGFuZCA6IGZ1bmN0aW9uKGFuaW0pewogICAgICAgIHRoaXMuY29sbGFwc2VkID0gZmFsc2U7CiAgICAgICAgaWYoYW5pbSAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzW3RoaXMuY29sbGFwc2VFbF0uc2hvdyh0aGlzLmhpZGVNb2RlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hZnRlckVmZmVjdChhbmltKTsKICAgICAgICBpZiAodGhpcy5kZWZlckxheW91dCkgewogICAgICAgICAgICBkZWxldGUgdGhpcy5kZWZlckxheW91dDsKICAgICAgICAgICAgdGhpcy5kb0xheW91dCh0cnVlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2V4cGFuZCcsIHRoaXMpOwogICAgfSwKCiAgICAKICAgIHRvZ2dsZUNvbGxhcHNlIDogZnVuY3Rpb24oYW5pbWF0ZSl7CiAgICAgICAgdGhpc1t0aGlzLmNvbGxhcHNlZCA/ICdleHBhbmQnIDogJ2NvbGxhcHNlJ10oYW5pbWF0ZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgb25EaXNhYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkICYmIHRoaXMubWFza0Rpc2FibGVkKXsKICAgICAgICAgICAgdGhpcy5lbC5tYXNrKCk7CiAgICAgICAgfQogICAgICAgIEV4dC5QYW5lbC5zdXBlcmNsYXNzLm9uRGlzYWJsZS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICAKICAgIG9uRW5hYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkICYmIHRoaXMubWFza0Rpc2FibGVkKXsKICAgICAgICAgICAgdGhpcy5lbC51bm1hc2soKTsKICAgICAgICB9CiAgICAgICAgRXh0LlBhbmVsLnN1cGVyY2xhc3Mub25FbmFibGUuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBvblJlc2l6ZSA6IGZ1bmN0aW9uKGFkaldpZHRoLCBhZGpIZWlnaHQsIHJhd1dpZHRoLCByYXdIZWlnaHQpewogICAgICAgIHZhciB3ID0gYWRqV2lkdGgsCiAgICAgICAgICAgIGggPSBhZGpIZWlnaHQ7CgogICAgICAgIGlmKEV4dC5pc0RlZmluZWQodykgfHwgRXh0LmlzRGVmaW5lZChoKSl7CiAgICAgICAgICAgIGlmKCF0aGlzLmNvbGxhcHNlZCl7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgaWYoRXh0LmlzTnVtYmVyKHcpKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJvZHkuc2V0V2lkdGgodyA9IHRoaXMuYWRqdXN0Qm9keVdpZHRoKHcgLSB0aGlzLmdldEZyYW1lV2lkdGgoKSkpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh3ID09ICdhdXRvJykgewogICAgICAgICAgICAgICAgICAgIHcgPSB0aGlzLmJvZHkuc2V0V2lkdGgoJ2F1dG8nKS5kb20ub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHcgPSB0aGlzLmJvZHkuZG9tLm9mZnNldFdpZHRoOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKHRoaXMudGJhcil7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50YmFyLnNldFdpZHRoKHcpOwogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMudG9wVG9vbGJhcil7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG9wVG9vbGJhci5zZXRTaXplKHcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKHRoaXMuYmJhcil7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYmFyLnNldFdpZHRoKHcpOwogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYm90dG9tVG9vbGJhcil7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYm90dG9tVG9vbGJhci5zZXRTaXplKHcpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEV4dC5pc0lFKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJiYXIuc2V0U3R5bGUoJ3Bvc2l0aW9uJywgJ3N0YXRpYycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5iYmFyLnNldFN0eWxlKCdwb3NpdGlvbicsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKHRoaXMuZm9vdGVyKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvb3Rlci5zZXRXaWR0aCh3KTsKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmZiYXIpewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZiYXIuc2V0U2l6ZShFeHQuaXNJRSA/ICh3IC0gdGhpcy5mb290ZXIuZ2V0RnJhbWVXaWR0aCgnbHInKSkgOiAnYXV0bycpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmKEV4dC5pc051bWJlcihoKSl7CiAgICAgICAgICAgICAgICAgICAgaCA9IE1hdGgubWF4KDAsIGggLSB0aGlzLmdldEZyYW1lSGVpZ2h0KCkpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuYm9keS5zZXRIZWlnaHQoaCk7CiAgICAgICAgICAgICAgICB9ZWxzZSBpZihoID09ICdhdXRvJyl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ib2R5LnNldEhlaWdodChoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZih0aGlzLmRpc2FibGVkICYmIHRoaXMuZWwuX21hc2spewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWwuX21hc2suc2V0U2l6ZSh0aGlzLmVsLmRvbS5jbGllbnRXaWR0aCwgdGhpcy5lbC5nZXRIZWlnaHQoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlZEJvZHlTaXplID0ge3dpZHRoOiB3LCBoZWlnaHQ6IGh9OwogICAgICAgICAgICAgICAgaWYoIXRoaXMucXVldWVkRXhwYW5kICYmIHRoaXMuYWxsb3dRdWV1ZWRFeHBhbmQgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlZEV4cGFuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMucXVldWVkRXhwYW5kOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uUmVzaXplKHRoaXMucXVldWVkQm9keVNpemUud2lkdGgsIHRoaXMucXVldWVkQm9keVNpemUuaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzLCB7c2luZ2xlOnRydWV9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm9uQm9keVJlc2l6ZSh3LCBoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zeW5jU2hhZG93KCk7CiAgICAgICAgRXh0LlBhbmVsLnN1cGVyY2xhc3Mub25SZXNpemUuY2FsbCh0aGlzLCBhZGpXaWR0aCwgYWRqSGVpZ2h0LCByYXdXaWR0aCwgcmF3SGVpZ2h0KTsKCiAgICB9LAoKICAgIAogICAgb25Cb2R5UmVzaXplOiBmdW5jdGlvbih3LCBoKXsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnYm9keXJlc2l6ZScsIHRoaXMsIHcsIGgpOwogICAgfSwKCiAgICAKICAgIGdldFRvb2xiYXJIZWlnaHQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGggPSAwOwogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICBFeHQuZWFjaCh0aGlzLnRvb2xiYXJzLCBmdW5jdGlvbih0Yil7CiAgICAgICAgICAgICAgICBoICs9IHRiLmdldEhlaWdodCgpOwogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGg7CiAgICB9LAoKICAgIAogICAgYWRqdXN0Qm9keUhlaWdodCA6IGZ1bmN0aW9uKGgpewogICAgICAgIHJldHVybiBoOwogICAgfSwKCiAgICAKICAgIGFkanVzdEJvZHlXaWR0aCA6IGZ1bmN0aW9uKHcpewogICAgICAgIHJldHVybiB3OwogICAgfSwKCiAgICAKICAgIG9uUG9zaXRpb24gOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuc3luY1NoYWRvdygpOwogICAgfSwKCiAgICAKICAgIGdldEZyYW1lV2lkdGggOiBmdW5jdGlvbigpewogICAgICAgIHZhciB3ID0gdGhpcy5lbC5nZXRGcmFtZVdpZHRoKCdscicpICsgdGhpcy5id3JhcC5nZXRGcmFtZVdpZHRoKCdscicpOwoKICAgICAgICBpZih0aGlzLmZyYW1lKXsKICAgICAgICAgICAgdmFyIGwgPSB0aGlzLmJ3cmFwLmRvbS5maXJzdENoaWxkOwogICAgICAgICAgICB3ICs9IChFeHQuZmx5KGwpLmdldEZyYW1lV2lkdGgoJ2wnKSArIEV4dC5mbHkobC5maXJzdENoaWxkKS5nZXRGcmFtZVdpZHRoKCdyJykpOwogICAgICAgICAgICB3ICs9IHRoaXMubWMuZ2V0RnJhbWVXaWR0aCgnbHInKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHc7CiAgICB9LAoKICAgIAogICAgZ2V0RnJhbWVIZWlnaHQgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaCAgPSB0aGlzLmVsLmdldEZyYW1lV2lkdGgoJ3RiJykgKyB0aGlzLmJ3cmFwLmdldEZyYW1lV2lkdGgoJ3RiJyk7CiAgICAgICAgaCArPSAodGhpcy50YmFyID8gdGhpcy50YmFyLmdldEhlaWdodCgpIDogMCkgKwogICAgICAgICAgICAgKHRoaXMuYmJhciA/IHRoaXMuYmJhci5nZXRIZWlnaHQoKSA6IDApOwoKICAgICAgICBpZih0aGlzLmZyYW1lKXsKICAgICAgICAgICAgaCArPSB0aGlzLmVsLmRvbS5maXJzdENoaWxkLm9mZnNldEhlaWdodCArIHRoaXMuZnQuZG9tLm9mZnNldEhlaWdodCArIHRoaXMubWMuZ2V0RnJhbWVXaWR0aCgndGInKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgaCArPSAodGhpcy5oZWFkZXIgPyB0aGlzLmhlYWRlci5nZXRIZWlnaHQoKSA6IDApICsKICAgICAgICAgICAgICAgICh0aGlzLmZvb3RlciA/IHRoaXMuZm9vdGVyLmdldEhlaWdodCgpIDogMCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBoOwogICAgfSwKCiAgICAKICAgIGdldElubmVyV2lkdGggOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmdldFNpemUoKS53aWR0aCAtIHRoaXMuZ2V0RnJhbWVXaWR0aCgpOwogICAgfSwKCiAgICAKICAgIGdldElubmVySGVpZ2h0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5ib2R5LmdldEhlaWdodCgpOwogICAgICAgIAogICAgfSwKCiAgICAKICAgIHN5bmNTaGFkb3cgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuZmxvYXRpbmcpewogICAgICAgICAgICB0aGlzLmVsLnN5bmModHJ1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldExheW91dFRhcmdldCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYm9keTsKICAgIH0sCgogICAgCiAgICBnZXRDb250ZW50VGFyZ2V0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5ib2R5OwogICAgfSwKCiAgICAKICAgIHNldFRpdGxlIDogZnVuY3Rpb24odGl0bGUsIGljb25DbHMpewogICAgICAgIHRoaXMudGl0bGUgPSB0aXRsZTsKICAgICAgICBpZih0aGlzLmhlYWRlciAmJiB0aGlzLmhlYWRlckFzVGV4dCl7CiAgICAgICAgICAgIHRoaXMuaGVhZGVyLmNoaWxkKCdzcGFuJykudXBkYXRlKHRpdGxlKTsKICAgICAgICB9CiAgICAgICAgaWYoaWNvbkNscyl7CiAgICAgICAgICAgIHRoaXMuc2V0SWNvbkNsYXNzKGljb25DbHMpOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgndGl0bGVjaGFuZ2UnLCB0aGlzLCB0aXRsZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZ2V0VXBkYXRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYm9keS5nZXRVcGRhdGVyKCk7CiAgICB9LAoKICAgICAKICAgIGxvYWQgOiBmdW5jdGlvbigpewogICAgICAgIHZhciB1bSA9IHRoaXMuYm9keS5nZXRVcGRhdGVyKCk7CiAgICAgICAgdW0udXBkYXRlLmFwcGx5KHVtLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGJlZm9yZURlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5QYW5lbC5zdXBlcmNsYXNzLmJlZm9yZURlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLmhlYWRlcil7CiAgICAgICAgICAgIHRoaXMuaGVhZGVyLnJlbW92ZUFsbExpc3RlbmVycygpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnRvb2xzKXsKICAgICAgICAgICAgZm9yKHZhciBrIGluIHRoaXMudG9vbHMpewogICAgICAgICAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy50b29sc1trXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYodGhpcy50b29sYmFycy5sZW5ndGggPiAwKXsKICAgICAgICAgICAgRXh0LmVhY2godGhpcy50b29sYmFycywgZnVuY3Rpb24odGIpewogICAgICAgICAgICAgICAgdGIudW4oJ2FmdGVybGF5b3V0JywgdGhpcy5zeW5jSGVpZ2h0LCB0aGlzKTsKICAgICAgICAgICAgICAgIHRiLnVuKCdyZW1vdmUnLCB0aGlzLnN5bmNIZWlnaHQsIHRoaXMpOwogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYoRXh0LmlzQXJyYXkodGhpcy5idXR0b25zKSl7CiAgICAgICAgICAgIHdoaWxlKHRoaXMuYnV0dG9ucy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIEV4dC5kZXN0cm95KHRoaXMuYnV0dG9uc1swXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIEV4dC5kZXN0cm95KAogICAgICAgICAgICAgICAgdGhpcy5mdCwKICAgICAgICAgICAgICAgIHRoaXMuaGVhZGVyLAogICAgICAgICAgICAgICAgdGhpcy5mb290ZXIsCiAgICAgICAgICAgICAgICB0aGlzLnRiYXIsCiAgICAgICAgICAgICAgICB0aGlzLmJiYXIsCiAgICAgICAgICAgICAgICB0aGlzLmJvZHksCiAgICAgICAgICAgICAgICB0aGlzLm1jLAogICAgICAgICAgICAgICAgdGhpcy5id3JhcCwKICAgICAgICAgICAgICAgIHRoaXMuZGQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKHRoaXMuZmJhcikgewogICAgICAgICAgICAgICAgRXh0LmRlc3Ryb3koCiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYmFyLAogICAgICAgICAgICAgICAgICAgIHRoaXMuZmJhci5lbAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBFeHQuZGVzdHJveSh0aGlzLnRvb2xiYXJzKTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVDbGFzc2VzIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmhlYWRlckNscyA9IHRoaXMuYmFzZUNscyArICctaGVhZGVyJzsKICAgICAgICB0aGlzLmhlYWRlclRleHRDbHMgPSB0aGlzLmJhc2VDbHMgKyAnLWhlYWRlci10ZXh0JzsKICAgICAgICB0aGlzLmJ3cmFwQ2xzID0gdGhpcy5iYXNlQ2xzICsgJy1id3JhcCc7CiAgICAgICAgdGhpcy50YmFyQ2xzID0gdGhpcy5iYXNlQ2xzICsgJy10YmFyJzsKICAgICAgICB0aGlzLmJvZHlDbHMgPSB0aGlzLmJhc2VDbHMgKyAnLWJvZHknOwogICAgICAgIHRoaXMuYmJhckNscyA9IHRoaXMuYmFzZUNscyArICctYmJhcic7CiAgICAgICAgdGhpcy5mb290ZXJDbHMgPSB0aGlzLmJhc2VDbHMgKyAnLWZvb3Rlcic7CiAgICB9LAoKICAgIAogICAgY3JlYXRlR2hvc3QgOiBmdW5jdGlvbihjbHMsIHVzZVNoaW0sIGFwcGVuZFRvKXsKICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBlbC5jbGFzc05hbWUgPSAneC1wYW5lbC1naG9zdCAnICsgKGNscyA/IGNscyA6ICcnKTsKICAgICAgICBpZih0aGlzLmhlYWRlcil7CiAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKHRoaXMuZWwuZG9tLmZpcnN0Q2hpbGQuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICB9CiAgICAgICAgRXh0LmZseShlbC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd1bCcpKSkuc2V0SGVpZ2h0KHRoaXMuYndyYXAuZ2V0SGVpZ2h0KCkpOwogICAgICAgIGVsLnN0eWxlLndpZHRoID0gdGhpcy5lbC5kb20ub2Zmc2V0V2lkdGggKyAncHgnOzsKICAgICAgICBpZighYXBwZW5kVG8pewogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5kb20uYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBFeHQuZ2V0RG9tKGFwcGVuZFRvKS5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgfQogICAgICAgIGlmKHVzZVNoaW0gIT09IGZhbHNlICYmIHRoaXMuZWwudXNlU2hpbSAhPT0gZmFsc2UpewogICAgICAgICAgICB2YXIgbGF5ZXIgPSBuZXcgRXh0LkxheWVyKHtzaGFkb3c6ZmFsc2UsIHVzZURpc3BsYXk6dHJ1ZSwgY29uc3RyYWluOmZhbHNlfSwgZWwpOwogICAgICAgICAgICBsYXllci5zaG93KCk7CiAgICAgICAgICAgIHJldHVybiBsYXllcjsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgcmV0dXJuIG5ldyBFeHQuRWxlbWVudChlbCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRvQXV0b0xvYWQgOiBmdW5jdGlvbigpewogICAgICAgIHZhciB1ID0gdGhpcy5ib2R5LmdldFVwZGF0ZXIoKTsKICAgICAgICBpZih0aGlzLnJlbmRlcmVyKXsKICAgICAgICAgICAgdS5zZXRSZW5kZXJlcih0aGlzLnJlbmRlcmVyKTsKICAgICAgICB9CiAgICAgICAgdS51cGRhdGUoRXh0LmlzT2JqZWN0KHRoaXMuYXV0b0xvYWQpID8gdGhpcy5hdXRvTG9hZCA6IHt1cmw6IHRoaXMuYXV0b0xvYWR9KTsKICAgIH0sCgogICAgCiAgICBnZXRUb29sIDogZnVuY3Rpb24oaWQpIHsKICAgICAgICByZXR1cm4gdGhpcy50b29sc1tpZF07CiAgICB9CgoKfSk7CkV4dC5yZWcoJ3BhbmVsJywgRXh0LlBhbmVsKTsKCkV4dC5FZGl0b3IgPSBmdW5jdGlvbihmaWVsZCwgY29uZmlnKXsKICAgIGlmKGZpZWxkLmZpZWxkKXsKICAgICAgICB0aGlzLmZpZWxkID0gRXh0LmNyZWF0ZShmaWVsZC5maWVsZCwgJ3RleHRmaWVsZCcpOwogICAgICAgIGNvbmZpZyA9IEV4dC5hcHBseSh7fSwgZmllbGQpOyAKICAgICAgICBkZWxldGUgY29uZmlnLmZpZWxkOwogICAgfWVsc2V7CiAgICAgICAgdGhpcy5maWVsZCA9IGZpZWxkOwogICAgfQogICAgRXh0LkVkaXRvci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgY29uZmlnKTsKfTsKCkV4dC5leHRlbmQoRXh0LkVkaXRvciwgRXh0LkNvbXBvbmVudCwgewogICAgCiAgICAKICAgIGFsbG93Qmx1cjogdHJ1ZSwKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICB2YWx1ZSA6ICIiLAogICAgCiAgICBhbGlnbm1lbnQ6ICJjLWM/IiwKICAgIAogICAgb2Zmc2V0czogWzAsIDBdLAogICAgCiAgICBzaGFkb3cgOiAiZnJhbWUiLAogICAgCiAgICBjb25zdHJhaW4gOiBmYWxzZSwKICAgIAogICAgc3dhbGxvd0tleXMgOiB0cnVlLAogICAgCiAgICBjb21wbGV0ZU9uRW50ZXIgOiB0cnVlLAogICAgCiAgICBjYW5jZWxPbkVzYyA6IHRydWUsCiAgICAKICAgIHVwZGF0ZUVsIDogZmFsc2UsCgogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LkVkaXRvci5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICJiZWZvcmVzdGFydGVkaXQiLAogICAgICAgICAgICAKICAgICAgICAgICAgInN0YXJ0ZWRpdCIsCiAgICAgICAgICAgIAogICAgICAgICAgICAiYmVmb3JlY29tcGxldGUiLAogICAgICAgICAgICAKICAgICAgICAgICAgImNvbXBsZXRlIiwKICAgICAgICAgICAgCiAgICAgICAgICAgICJjYW5jZWxlZGl0IiwKICAgICAgICAgICAgCiAgICAgICAgICAgICJzcGVjaWFsa2V5IgogICAgICAgICk7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIHRoaXMuZWwgPSBuZXcgRXh0LkxheWVyKHsKICAgICAgICAgICAgc2hhZG93OiB0aGlzLnNoYWRvdywKICAgICAgICAgICAgY2xzOiAieC1lZGl0b3IiLAogICAgICAgICAgICBwYXJlbnRFbCA6IGN0LAogICAgICAgICAgICBzaGltIDogdGhpcy5zaGltLAogICAgICAgICAgICBzaGFkb3dPZmZzZXQ6IHRoaXMuc2hhZG93T2Zmc2V0IHx8IDQsCiAgICAgICAgICAgIGlkOiB0aGlzLmlkLAogICAgICAgICAgICBjb25zdHJhaW46IHRoaXMuY29uc3RyYWluCiAgICAgICAgfSk7CiAgICAgICAgaWYodGhpcy56SW5kZXgpewogICAgICAgICAgICB0aGlzLmVsLnNldFpJbmRleCh0aGlzLnpJbmRleCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZWwuc2V0U3R5bGUoIm92ZXJmbG93IiwgRXh0LmlzR2Vja28gPyAiYXV0byIgOiAiaGlkZGVuIik7CiAgICAgICAgaWYodGhpcy5maWVsZC5tc2dUYXJnZXQgIT0gJ3RpdGxlJyl7CiAgICAgICAgICAgIHRoaXMuZmllbGQubXNnVGFyZ2V0ID0gJ3F0aXAnOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpZWxkLmluRWRpdG9yID0gdHJ1ZTsKICAgICAgICB0aGlzLm1vbih0aGlzLmZpZWxkLCB7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBibHVyOiB0aGlzLm9uQmx1ciwKICAgICAgICAgICAgc3BlY2lhbGtleTogdGhpcy5vblNwZWNpYWxLZXkKICAgICAgICB9KTsKICAgICAgICBpZih0aGlzLmZpZWxkLmdyb3cpewogICAgICAgICAgICB0aGlzLm1vbih0aGlzLmZpZWxkLCAiYXV0b3NpemUiLCB0aGlzLmVsLnN5bmMsICB0aGlzLmVsLCB7ZGVsYXk6MX0pOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpZWxkLnJlbmRlcih0aGlzLmVsKS5zaG93KCk7CiAgICAgICAgdGhpcy5maWVsZC5nZXRFbCgpLmRvbS5uYW1lID0gJyc7CiAgICAgICAgaWYodGhpcy5zd2FsbG93S2V5cyl7CiAgICAgICAgICAgIHRoaXMuZmllbGQuZWwuc3dhbGxvd0V2ZW50KFsKICAgICAgICAgICAgICAgICdrZXlwcmVzcycsIAogICAgICAgICAgICAgICAgJ2tleWRvd24nICAgCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblNwZWNpYWxLZXkgOiBmdW5jdGlvbihmaWVsZCwgZSl7CiAgICAgICAgdmFyIGtleSA9IGUuZ2V0S2V5KCksCiAgICAgICAgICAgIGNvbXBsZXRlID0gdGhpcy5jb21wbGV0ZU9uRW50ZXIgJiYga2V5ID09IGUuRU5URVIsCiAgICAgICAgICAgIGNhbmNlbCA9IHRoaXMuY2FuY2VsT25Fc2MgJiYga2V5ID09IGUuRVNDOwogICAgICAgIGlmKGNvbXBsZXRlIHx8IGNhbmNlbCl7CiAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgIGlmKGNvbXBsZXRlKXsKICAgICAgICAgICAgICAgIHRoaXMuY29tcGxldGVFZGl0KCk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy5jYW5jZWxFZGl0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZmllbGQudHJpZ2dlckJsdXIpewogICAgICAgICAgICAgICAgZmllbGQudHJpZ2dlckJsdXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgnc3BlY2lhbGtleScsIGZpZWxkLCBlKTsKICAgIH0sCgogICAgCiAgICBzdGFydEVkaXQgOiBmdW5jdGlvbihlbCwgdmFsdWUpewogICAgICAgIGlmKHRoaXMuZWRpdGluZyl7CiAgICAgICAgICAgIHRoaXMuY29tcGxldGVFZGl0KCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuYm91bmRFbCA9IEV4dC5nZXQoZWwpOwogICAgICAgIHZhciB2ID0gdmFsdWUgIT09IHVuZGVmaW5lZCA/IHZhbHVlIDogdGhpcy5ib3VuZEVsLmRvbS5pbm5lckhUTUw7CiAgICAgICAgaWYoIXRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLnJlbmRlcih0aGlzLnBhcmVudEVsIHx8IGRvY3VtZW50LmJvZHkpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgiYmVmb3Jlc3RhcnRlZGl0IiwgdGhpcywgdGhpcy5ib3VuZEVsLCB2KSAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLnN0YXJ0VmFsdWUgPSB2OwogICAgICAgICAgICB0aGlzLmZpZWxkLnJlc2V0KCk7CiAgICAgICAgICAgIHRoaXMuZmllbGQuc2V0VmFsdWUodik7CiAgICAgICAgICAgIHRoaXMucmVhbGlnbih0cnVlKTsKICAgICAgICAgICAgdGhpcy5lZGl0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zaG93KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRvQXV0b1NpemUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuYXV0b1NpemUpewogICAgICAgICAgICB2YXIgc3ogPSB0aGlzLmJvdW5kRWwuZ2V0U2l6ZSgpLAogICAgICAgICAgICAgICAgZnMgPSB0aGlzLmZpZWxkLmdldFNpemUoKTsKCiAgICAgICAgICAgIHN3aXRjaCh0aGlzLmF1dG9TaXplKXsKICAgICAgICAgICAgICAgIGNhc2UgIndpZHRoIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFNpemUoc3oud2lkdGgsIGZzLmhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJoZWlnaHQiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U2l6ZShmcy53aWR0aCwgc3ouaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgIm5vbmUiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0U2l6ZShmcy53aWR0aCwgZnMuaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRTaXplKHN6LndpZHRoLCBzei5oZWlnaHQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNldFNpemUgOiBmdW5jdGlvbih3LCBoKXsKICAgICAgICBkZWxldGUgdGhpcy5maWVsZC5sYXN0U2l6ZTsKICAgICAgICB0aGlzLmZpZWxkLnNldFNpemUodywgaCk7CiAgICAgICAgaWYodGhpcy5lbCl7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZihFeHQuaXNHZWNrbzIgfHwgRXh0LmlzT3BlcmEgfHwgKEV4dC5pc0lFNyAmJiBFeHQuaXNTdHJpY3QpKXsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5lbC5zZXRTaXplKHcsIGgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwuc3luYygpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZWFsaWduIDogZnVuY3Rpb24oYXV0b1NpemUpewogICAgICAgIGlmKGF1dG9TaXplID09PSB0cnVlKXsKICAgICAgICAgICAgdGhpcy5kb0F1dG9TaXplKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZWwuYWxpZ25Ubyh0aGlzLmJvdW5kRWwsIHRoaXMuYWxpZ25tZW50LCB0aGlzLm9mZnNldHMpOwogICAgfSwKCiAgICAKICAgIGNvbXBsZXRlRWRpdCA6IGZ1bmN0aW9uKHJlbWFpblZpc2libGUpewogICAgICAgIGlmKCF0aGlzLmVkaXRpbmcpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLmZpZWxkLmFzc2VydFZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuZmllbGQuYXNzZXJ0VmFsdWUoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHYgPSB0aGlzLmdldFZhbHVlKCk7CiAgICAgICAgaWYoIXRoaXMuZmllbGQuaXNWYWxpZCgpKXsKICAgICAgICAgICAgaWYodGhpcy5yZXZlcnRJbnZhbGlkICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbEVkaXQocmVtYWluVmlzaWJsZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihTdHJpbmcodikgPT09IFN0cmluZyh0aGlzLnN0YXJ0VmFsdWUpICYmIHRoaXMuaWdub3JlTm9DaGFuZ2UpewogICAgICAgICAgICB0aGlzLmhpZGVFZGl0KHJlbWFpblZpc2libGUpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCJiZWZvcmVjb21wbGV0ZSIsIHRoaXMsIHYsIHRoaXMuc3RhcnRWYWx1ZSkgIT09IGZhbHNlKXsKICAgICAgICAgICAgdiA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgaWYodGhpcy51cGRhdGVFbCAmJiB0aGlzLmJvdW5kRWwpewogICAgICAgICAgICAgICAgdGhpcy5ib3VuZEVsLnVwZGF0ZSh2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhpZGVFZGl0KHJlbWFpblZpc2libGUpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgiY29tcGxldGUiLCB0aGlzLCB2LCB0aGlzLnN0YXJ0VmFsdWUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblNob3cgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZWwuc2hvdygpOwogICAgICAgIGlmKHRoaXMuaGlkZUVsICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuYm91bmRFbC5oaWRlKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZmllbGQuc2hvdygpLmZvY3VzKGZhbHNlLCB0cnVlKTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgic3RhcnRlZGl0IiwgdGhpcy5ib3VuZEVsLCB0aGlzLnN0YXJ0VmFsdWUpOwogICAgfSwKCiAgICAKICAgIGNhbmNlbEVkaXQgOiBmdW5jdGlvbihyZW1haW5WaXNpYmxlKXsKICAgICAgICBpZih0aGlzLmVkaXRpbmcpewogICAgICAgICAgICB2YXIgdiA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZSh0aGlzLnN0YXJ0VmFsdWUpOwogICAgICAgICAgICB0aGlzLmhpZGVFZGl0KHJlbWFpblZpc2libGUpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgiY2FuY2VsZWRpdCIsIHRoaXMsIHYsIHRoaXMuc3RhcnRWYWx1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGhpZGVFZGl0OiBmdW5jdGlvbihyZW1haW5WaXNpYmxlKXsKICAgICAgICBpZihyZW1haW5WaXNpYmxlICE9PSB0cnVlKXsKICAgICAgICAgICAgdGhpcy5lZGl0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkJsdXIgOiBmdW5jdGlvbigpewogICAgICAgIAogICAgICAgIGlmKHRoaXMuYWxsb3dCbHVyID09PSB0cnVlICYmIHRoaXMuZWRpdGluZyAmJiB0aGlzLnNlbGVjdFNhbWVFZGl0b3IgIT09IHRydWUpewogICAgICAgICAgICB0aGlzLmNvbXBsZXRlRWRpdCgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkhpZGUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuZWRpdGluZyl7CiAgICAgICAgICAgIHRoaXMuY29tcGxldGVFZGl0KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5maWVsZC5ibHVyKCk7CiAgICAgICAgaWYodGhpcy5maWVsZC5jb2xsYXBzZSl7CiAgICAgICAgICAgIHRoaXMuZmllbGQuY29sbGFwc2UoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lbC5oaWRlKCk7CiAgICAgICAgaWYodGhpcy5oaWRlRWwgIT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5ib3VuZEVsLnNob3coKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0VmFsdWUgOiBmdW5jdGlvbih2KXsKICAgICAgICB0aGlzLmZpZWxkLnNldFZhbHVlKHYpOwogICAgfSwKCiAgICAKICAgIGdldFZhbHVlIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5maWVsZC5nZXRWYWx1ZSgpOwogICAgfSwKCiAgICBiZWZvcmVEZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZGVzdHJveU1lbWJlcnModGhpcywgJ2ZpZWxkJyk7CgogICAgICAgIGRlbGV0ZSB0aGlzLnBhcmVudEVsOwogICAgICAgIGRlbGV0ZSB0aGlzLmJvdW5kRWw7CiAgICB9Cn0pOwpFeHQucmVnKCdlZGl0b3InLCBFeHQuRWRpdG9yKTsKCkV4dC5Db2xvclBhbGV0dGUgPSBFeHQuZXh0ZW5kKEV4dC5Db21wb25lbnQsIHsKCQogICAgCiAgICBpdGVtQ2xzIDogJ3gtY29sb3ItcGFsZXR0ZScsCiAgICAKICAgIHZhbHVlIDogbnVsbCwKICAgIAogICAgY2xpY2tFdmVudCA6J2NsaWNrJywKICAgIAogICAgY3R5cGUgOiAnRXh0LkNvbG9yUGFsZXR0ZScsCgogICAgCiAgICBhbGxvd1Jlc2VsZWN0IDogZmFsc2UsCgogICAgCiAgICBjb2xvcnMgOiBbCiAgICAgICAgJzAwMDAwMCcsICc5OTMzMDAnLCAnMzMzMzAwJywgJzAwMzMwMCcsICcwMDMzNjYnLCAnMDAwMDgwJywgJzMzMzM5OScsICczMzMzMzMnLAogICAgICAgICc4MDAwMDAnLCAnRkY2NjAwJywgJzgwODAwMCcsICcwMDgwMDAnLCAnMDA4MDgwJywgJzAwMDBGRicsICc2NjY2OTknLCAnODA4MDgwJywKICAgICAgICAnRkYwMDAwJywgJ0ZGOTkwMCcsICc5OUNDMDAnLCAnMzM5OTY2JywgJzMzQ0NDQycsICczMzY2RkYnLCAnODAwMDgwJywgJzk2OTY5NicsCiAgICAgICAgJ0ZGMDBGRicsICdGRkNDMDAnLCAnRkZGRjAwJywgJzAwRkYwMCcsICcwMEZGRkYnLCAnMDBDQ0ZGJywgJzk5MzM2NicsICdDMEMwQzAnLAogICAgICAgICdGRjk5Q0MnLCAnRkZDQzk5JywgJ0ZGRkY5OScsICdDQ0ZGQ0MnLCAnQ0NGRkZGJywgJzk5Q0NGRicsICdDQzk5RkYnLCAnRkZGRkZGJwogICAgXSwKCiAgICAKICAgIAogICAgCiAgICAKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5Db2xvclBhbGV0dGUuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAnc2VsZWN0JwogICAgICAgICk7CgogICAgICAgIGlmKHRoaXMuaGFuZGxlcil7CiAgICAgICAgICAgIHRoaXMub24oJ3NlbGVjdCcsIHRoaXMuaGFuZGxlciwgdGhpcy5zY29wZSwgdHJ1ZSk7CiAgICAgICAgfSAgICAKICAgIH0sCgogICAgCiAgICBvblJlbmRlciA6IGZ1bmN0aW9uKGNvbnRhaW5lciwgcG9zaXRpb24pewogICAgICAgIHRoaXMuYXV0b0VsID0gewogICAgICAgICAgICB0YWc6ICdkaXYnLAogICAgICAgICAgICBjbHM6IHRoaXMuaXRlbUNscwogICAgICAgIH07CiAgICAgICAgRXh0LkNvbG9yUGFsZXR0ZS5zdXBlcmNsYXNzLm9uUmVuZGVyLmNhbGwodGhpcywgY29udGFpbmVyLCBwb3NpdGlvbik7CiAgICAgICAgdmFyIHQgPSB0aGlzLnRwbCB8fCBuZXcgRXh0LlhUZW1wbGF0ZSgKICAgICAgICAgICAgJzx0cGwgZm9yPSIuIj48YSBocmVmPSIjIiBjbGFzcz0iY29sb3Itey59IiBoaWRlZm9jdXM9Im9uIj48ZW0+PHNwYW4gc3R5bGU9ImJhY2tncm91bmQ6I3sufSIgdW5zZWxlY3RhYmxlPSJvbiI+JiMxNjA7PC9zcGFuPjwvZW0+PC9hPjwvdHBsPicKICAgICAgICApOwogICAgICAgIHQub3ZlcndyaXRlKHRoaXMuZWwsIHRoaXMuY29sb3JzKTsKICAgICAgICB0aGlzLm1vbih0aGlzLmVsLCB0aGlzLmNsaWNrRXZlbnQsIHRoaXMuaGFuZGxlQ2xpY2ssIHRoaXMsIHtkZWxlZ2F0ZTogJ2EnfSk7CiAgICAgICAgaWYodGhpcy5jbGlja0V2ZW50ICE9ICdjbGljaycpewogICAgICAgIAl0aGlzLm1vbih0aGlzLmVsLCAnY2xpY2snLCBFeHQuZW1wdHlGbiwgdGhpcywge2RlbGVnYXRlOiAnYScsIHByZXZlbnREZWZhdWx0OiB0cnVlfSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFmdGVyUmVuZGVyIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuQ29sb3JQYWxldHRlLnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLnZhbHVlKXsKICAgICAgICAgICAgdmFyIHMgPSB0aGlzLnZhbHVlOwogICAgICAgICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5zZWxlY3QocywgdHJ1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGhhbmRsZUNsaWNrIDogZnVuY3Rpb24oZSwgdCl7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGlmKCF0aGlzLmRpc2FibGVkKXsKICAgICAgICAgICAgdmFyIGMgPSB0LmNsYXNzTmFtZS5tYXRjaCgvKD86Xnxccyljb2xvci0oLns2fSkoPzpcc3wkKS8pWzFdOwogICAgICAgICAgICB0aGlzLnNlbGVjdChjLnRvVXBwZXJDYXNlKCkpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZWxlY3QgOiBmdW5jdGlvbihjb2xvciwgc3VwcHJlc3NFdmVudCl7CiAgICAgICAgY29sb3IgPSBjb2xvci5yZXBsYWNlKCcjJywgJycpOwogICAgICAgIGlmKGNvbG9yICE9IHRoaXMudmFsdWUgfHwgdGhpcy5hbGxvd1Jlc2VsZWN0KXsKICAgICAgICAgICAgdmFyIGVsID0gdGhpcy5lbDsKICAgICAgICAgICAgaWYodGhpcy52YWx1ZSl7CiAgICAgICAgICAgICAgICBlbC5jaGlsZCgnYS5jb2xvci0nK3RoaXMudmFsdWUpLnJlbW92ZUNsYXNzKCd4LWNvbG9yLXBhbGV0dGUtc2VsJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWwuY2hpbGQoJ2EuY29sb3ItJytjb2xvcikuYWRkQ2xhc3MoJ3gtY29sb3ItcGFsZXR0ZS1zZWwnKTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IGNvbG9yOwogICAgICAgICAgICBpZihzdXBwcmVzc0V2ZW50ICE9PSB0cnVlKXsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzZWxlY3QnLCB0aGlzLCBjb2xvcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgCn0pOwpFeHQucmVnKCdjb2xvcnBhbGV0dGUnLCBFeHQuQ29sb3JQYWxldHRlKTsKRXh0LkRhdGVQaWNrZXIgPSBFeHQuZXh0ZW5kKEV4dC5Cb3hDb21wb25lbnQsIHsKICAgIAogICAgdG9kYXlUZXh0IDogJ1RvZGF5JywKICAgIAogICAgb2tUZXh0IDogJyYjMTYwO09LJiMxNjA7JywKICAgIAogICAgY2FuY2VsVGV4dCA6ICdDYW5jZWwnLAogICAgCiAgICAKICAgIAogICAgdG9kYXlUaXAgOiAnezB9IChTcGFjZWJhciknLAogICAgCiAgICBtaW5UZXh0IDogJ1RoaXMgZGF0ZSBpcyBiZWZvcmUgdGhlIG1pbmltdW0gZGF0ZScsCiAgICAKICAgIG1heFRleHQgOiAnVGhpcyBkYXRlIGlzIGFmdGVyIHRoZSBtYXhpbXVtIGRhdGUnLAogICAgCiAgICBmb3JtYXQgOiAnbS9kL3knLAogICAgCiAgICBkaXNhYmxlZERheXNUZXh0IDogJ0Rpc2FibGVkJywKICAgIAogICAgZGlzYWJsZWREYXRlc1RleHQgOiAnRGlzYWJsZWQnLAogICAgCiAgICBtb250aE5hbWVzIDogRGF0ZS5tb250aE5hbWVzLAogICAgCiAgICBkYXlOYW1lcyA6IERhdGUuZGF5TmFtZXMsCiAgICAKICAgIG5leHRUZXh0IDogJ05leHQgTW9udGggKENvbnRyb2wrUmlnaHQpJywKICAgIAogICAgcHJldlRleHQgOiAnUHJldmlvdXMgTW9udGggKENvbnRyb2wrTGVmdCknLAogICAgCiAgICBtb250aFllYXJUZXh0IDogJ0Nob29zZSBhIG1vbnRoIChDb250cm9sK1VwL0Rvd24gdG8gbW92ZSB5ZWFycyknLAogICAgCiAgICBzdGFydERheSA6IDAsCiAgICAKICAgIHNob3dUb2RheSA6IHRydWUsCiAgICAKICAgIAogICAgCiAgICAKICAgIAoKICAgIAogICAgCiAgICBmb2N1c09uU2VsZWN0OiB0cnVlLAoKICAgIAogICAgCiAgICBpbml0SG91cjogMTIsIAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LkRhdGVQaWNrZXIuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CgogICAgICAgIHRoaXMudmFsdWUgPSB0aGlzLnZhbHVlID8KICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlLmNsZWFyVGltZSh0cnVlKSA6IG5ldyBEYXRlKCkuY2xlYXJUaW1lKCk7CgogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ3NlbGVjdCcKICAgICAgICApOwoKICAgICAgICBpZih0aGlzLmhhbmRsZXIpewogICAgICAgICAgICB0aGlzLm9uKCdzZWxlY3QnLCB0aGlzLmhhbmRsZXIsICB0aGlzLnNjb3BlIHx8IHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5pbml0RGlzYWJsZWREYXlzKCk7CiAgICB9LAoKICAgIAogICAgaW5pdERpc2FibGVkRGF5cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMuZGlzYWJsZWREYXRlc1JFICYmIHRoaXMuZGlzYWJsZWREYXRlcyl7CiAgICAgICAgICAgIHZhciBkZCA9IHRoaXMuZGlzYWJsZWREYXRlcywKICAgICAgICAgICAgICAgIGxlbiA9IGRkLmxlbmd0aCAtIDEsCiAgICAgICAgICAgICAgICByZSA9ICcoPzonOwoKICAgICAgICAgICAgRXh0LmVhY2goZGQsIGZ1bmN0aW9uKGQsIGkpewogICAgICAgICAgICAgICAgcmUgKz0gRXh0LmlzRGF0ZShkKSA/ICdeJyArIEV4dC5lc2NhcGVSZShkLmRhdGVGb3JtYXQodGhpcy5mb3JtYXQpKSArICckJyA6IGRkW2ldOwogICAgICAgICAgICAgICAgaWYoaSAhPSBsZW4pewogICAgICAgICAgICAgICAgICAgIHJlICs9ICd8JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuZGlzYWJsZWREYXRlc1JFID0gbmV3IFJlZ0V4cChyZSArICcpJyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNldERpc2FibGVkRGF0ZXMgOiBmdW5jdGlvbihkZCl7CiAgICAgICAgaWYoRXh0LmlzQXJyYXkoZGQpKXsKICAgICAgICAgICAgdGhpcy5kaXNhYmxlZERhdGVzID0gZGQ7CiAgICAgICAgICAgIHRoaXMuZGlzYWJsZWREYXRlc1JFID0gbnVsbDsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5kaXNhYmxlZERhdGVzUkUgPSBkZDsKICAgICAgICB9CiAgICAgICAgdGhpcy5pbml0RGlzYWJsZWREYXlzKCk7CiAgICAgICAgdGhpcy51cGRhdGUodGhpcy52YWx1ZSwgdHJ1ZSk7CiAgICB9LAoKICAgIAogICAgc2V0RGlzYWJsZWREYXlzIDogZnVuY3Rpb24oZGQpewogICAgICAgIHRoaXMuZGlzYWJsZWREYXlzID0gZGQ7CiAgICAgICAgdGhpcy51cGRhdGUodGhpcy52YWx1ZSwgdHJ1ZSk7CiAgICB9LAoKICAgIAogICAgc2V0TWluRGF0ZSA6IGZ1bmN0aW9uKGR0KXsKICAgICAgICB0aGlzLm1pbkRhdGUgPSBkdDsKICAgICAgICB0aGlzLnVwZGF0ZSh0aGlzLnZhbHVlLCB0cnVlKTsKICAgIH0sCgogICAgCiAgICBzZXRNYXhEYXRlIDogZnVuY3Rpb24oZHQpewogICAgICAgIHRoaXMubWF4RGF0ZSA9IGR0OwogICAgICAgIHRoaXMudXBkYXRlKHRoaXMudmFsdWUsIHRydWUpOwogICAgfSwKCiAgICAKICAgIHNldFZhbHVlIDogZnVuY3Rpb24odmFsdWUpewogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZS5jbGVhclRpbWUodHJ1ZSk7CiAgICAgICAgdGhpcy51cGRhdGUodGhpcy52YWx1ZSk7CiAgICB9LAoKICAgIAogICAgZ2V0VmFsdWUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnZhbHVlOwogICAgfSwKCiAgICAKICAgIGZvY3VzIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnVwZGF0ZSh0aGlzLmFjdGl2ZURhdGUpOwogICAgfSwKCiAgICAKICAgIG9uRW5hYmxlOiBmdW5jdGlvbihpbml0aWFsKXsKICAgICAgICBFeHQuRGF0ZVBpY2tlci5zdXBlcmNsYXNzLm9uRW5hYmxlLmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5kb0Rpc2FibGVkKGZhbHNlKTsKICAgICAgICB0aGlzLnVwZGF0ZShpbml0aWFsID8gdGhpcy52YWx1ZSA6IHRoaXMuYWN0aXZlRGF0ZSk7CiAgICAgICAgaWYoRXh0LmlzSUUpewogICAgICAgICAgICB0aGlzLmVsLnJlcGFpbnQoKTsKICAgICAgICB9CgogICAgfSwKCiAgICAKICAgIG9uRGlzYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LkRhdGVQaWNrZXIuc3VwZXJjbGFzcy5vbkRpc2FibGUuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmRvRGlzYWJsZWQodHJ1ZSk7CiAgICAgICAgaWYoRXh0LmlzSUUgJiYgIUV4dC5pc0lFOCl7CiAgICAgICAgICAgIAogICAgICAgICAgICAgRXh0LmVhY2goW10uY29uY2F0KHRoaXMudGV4dE5vZGVzLCB0aGlzLmVsLnF1ZXJ5KCd0aCBzcGFuJykpLCBmdW5jdGlvbihlbCl7CiAgICAgICAgICAgICAgICAgRXh0LmZseShlbCkucmVwYWludCgpOwogICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRvRGlzYWJsZWQgOiBmdW5jdGlvbihkaXNhYmxlZCl7CiAgICAgICAgdGhpcy5rZXlOYXYuc2V0RGlzYWJsZWQoZGlzYWJsZWQpOwogICAgICAgIHRoaXMucHJldlJlcGVhdGVyLnNldERpc2FibGVkKGRpc2FibGVkKTsKICAgICAgICB0aGlzLm5leHRSZXBlYXRlci5zZXREaXNhYmxlZChkaXNhYmxlZCk7CiAgICAgICAgaWYodGhpcy5zaG93VG9kYXkpewogICAgICAgICAgICB0aGlzLnRvZGF5S2V5TGlzdGVuZXIuc2V0RGlzYWJsZWQoZGlzYWJsZWQpOwogICAgICAgICAgICB0aGlzLnRvZGF5QnRuLnNldERpc2FibGVkKGRpc2FibGVkKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjb250YWluZXIsIHBvc2l0aW9uKXsKICAgICAgICB2YXIgbSA9IFsKICAgICAgICAgICAgICc8dGFibGUgY2VsbHNwYWNpbmc9IjAiPicsCiAgICAgICAgICAgICAgICAnPHRyPjx0ZCBjbGFzcz0ieC1kYXRlLWxlZnQiPjxhIGhyZWY9IiMiIHRpdGxlPSInLCB0aGlzLnByZXZUZXh0ICwnIj4mIzE2MDs8L2E+PC90ZD48dGQgY2xhc3M9IngtZGF0ZS1taWRkbGUiIGFsaWduPSJjZW50ZXIiPjwvdGQ+PHRkIGNsYXNzPSJ4LWRhdGUtcmlnaHQiPjxhIGhyZWY9IiMiIHRpdGxlPSInLCB0aGlzLm5leHRUZXh0ICwnIj4mIzE2MDs8L2E+PC90ZD48L3RyPicsCiAgICAgICAgICAgICAgICAnPHRyPjx0ZCBjb2xzcGFuPSIzIj48dGFibGUgY2xhc3M9IngtZGF0ZS1pbm5lciIgY2VsbHNwYWNpbmc9IjAiPjx0aGVhZD48dHI+J10sCiAgICAgICAgICAgICAgICBkbiA9IHRoaXMuZGF5TmFtZXMsCiAgICAgICAgICAgICAgICBpOwogICAgICAgIGZvcihpID0gMDsgaSA8IDc7IGkrKyl7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5zdGFydERheStpOwogICAgICAgICAgICBpZihkID4gNil7CiAgICAgICAgICAgICAgICBkID0gZC03OwogICAgICAgICAgICB9CiAgICAgICAgICAgIG0ucHVzaCgnPHRoPjxzcGFuPicsIGRuW2RdLnN1YnN0cigwLDEpLCAnPC9zcGFuPjwvdGg+Jyk7CiAgICAgICAgfQogICAgICAgIG1bbS5sZW5ndGhdID0gJzwvdHI+PC90aGVhZD48dGJvZHk+PHRyPic7CiAgICAgICAgZm9yKGkgPSAwOyBpIDwgNDI7IGkrKykgewogICAgICAgICAgICBpZihpICUgNyA9PT0gMCAmJiBpICE9PSAwKXsKICAgICAgICAgICAgICAgIG1bbS5sZW5ndGhdID0gJzwvdHI+PHRyPic7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbVttLmxlbmd0aF0gPSAnPHRkPjxhIGhyZWY9IiMiIGhpZGVmb2N1cz0ib24iIGNsYXNzPSJ4LWRhdGUtZGF0ZSIgdGFiSW5kZXg9IjEiPjxlbT48c3Bhbj48L3NwYW4+PC9lbT48L2E+PC90ZD4nOwogICAgICAgIH0KICAgICAgICBtLnB1c2goJzwvdHI+PC90Ym9keT48L3RhYmxlPjwvdGQ+PC90cj4nLAogICAgICAgICAgICAgICAgdGhpcy5zaG93VG9kYXkgPyAnPHRyPjx0ZCBjb2xzcGFuPSIzIiBjbGFzcz0ieC1kYXRlLWJvdHRvbSIgYWxpZ249ImNlbnRlciI+PC90ZD48L3RyPicgOiAnJywKICAgICAgICAgICAgICAgICc8L3RhYmxlPjxkaXYgY2xhc3M9IngtZGF0ZS1tcCI+PC9kaXY+Jyk7CgogICAgICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGVsLmNsYXNzTmFtZSA9ICd4LWRhdGUtcGlja2VyJzsKICAgICAgICBlbC5pbm5lckhUTUwgPSBtLmpvaW4oJycpOwoKICAgICAgICBjb250YWluZXIuZG9tLmluc2VydEJlZm9yZShlbCwgcG9zaXRpb24pOwoKICAgICAgICB0aGlzLmVsID0gRXh0LmdldChlbCk7CiAgICAgICAgdGhpcy5ldmVudEVsID0gRXh0LmdldChlbC5maXJzdENoaWxkKTsKCiAgICAgICAgdGhpcy5wcmV2UmVwZWF0ZXIgPSBuZXcgRXh0LnV0aWwuQ2xpY2tSZXBlYXRlcih0aGlzLmVsLmNoaWxkKCd0ZC54LWRhdGUtbGVmdCBhJyksIHsKICAgICAgICAgICAgaGFuZGxlcjogdGhpcy5zaG93UHJldk1vbnRoLAogICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6dHJ1ZSwKICAgICAgICAgICAgc3RvcERlZmF1bHQ6dHJ1ZQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLm5leHRSZXBlYXRlciA9IG5ldyBFeHQudXRpbC5DbGlja1JlcGVhdGVyKHRoaXMuZWwuY2hpbGQoJ3RkLngtZGF0ZS1yaWdodCBhJyksIHsKICAgICAgICAgICAgaGFuZGxlcjogdGhpcy5zaG93TmV4dE1vbnRoLAogICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6dHJ1ZSwKICAgICAgICAgICAgc3RvcERlZmF1bHQ6dHJ1ZQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLm1vbnRoUGlja2VyID0gdGhpcy5lbC5kb3duKCdkaXYueC1kYXRlLW1wJyk7CiAgICAgICAgdGhpcy5tb250aFBpY2tlci5lbmFibGVEaXNwbGF5TW9kZSgnYmxvY2snKTsKCiAgICAgICAgdGhpcy5rZXlOYXYgPSBuZXcgRXh0LktleU5hdih0aGlzLmV2ZW50RWwsIHsKICAgICAgICAgICAgJ2xlZnQnIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZihlLmN0cmxLZXkpewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1ByZXZNb250aCgpOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGUodGhpcy5hY3RpdmVEYXRlLmFkZCgnZCcsIC0xKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAncmlnaHQnIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZihlLmN0cmxLZXkpewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd05leHRNb250aCgpOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGUodGhpcy5hY3RpdmVEYXRlLmFkZCgnZCcsIDEpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICd1cCcgOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgIGlmKGUuY3RybEtleSl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TmV4dFllYXIoKTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKHRoaXMuYWN0aXZlRGF0ZS5hZGQoJ2QnLCAtNykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgJ2Rvd24nIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZihlLmN0cmxLZXkpewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1ByZXZZZWFyKCk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZSh0aGlzLmFjdGl2ZURhdGUuYWRkKCdkJywgNykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgJ3BhZ2VVcCcgOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd05leHRNb250aCgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgJ3BhZ2VEb3duJyA6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgdGhpcy5zaG93UHJldk1vbnRoKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAnZW50ZXInIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzY29wZSA6IHRoaXMKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5lbC51bnNlbGVjdGFibGUoKTsKCiAgICAgICAgdGhpcy5jZWxscyA9IHRoaXMuZWwuc2VsZWN0KCd0YWJsZS54LWRhdGUtaW5uZXIgdGJvZHkgdGQnKTsKICAgICAgICB0aGlzLnRleHROb2RlcyA9IHRoaXMuZWwucXVlcnkoJ3RhYmxlLngtZGF0ZS1pbm5lciB0Ym9keSBzcGFuJyk7CgogICAgICAgIHRoaXMubWJ0biA9IG5ldyBFeHQuQnV0dG9uKHsKICAgICAgICAgICAgdGV4dDogJyYjMTYwOycsCiAgICAgICAgICAgIHRvb2x0aXA6IHRoaXMubW9udGhZZWFyVGV4dCwKICAgICAgICAgICAgcmVuZGVyVG86IHRoaXMuZWwuY2hpbGQoJ3RkLngtZGF0ZS1taWRkbGUnLCB0cnVlKQogICAgICAgIH0pOwogICAgICAgIHRoaXMubWJ0bi5lbC5jaGlsZCgnZW0nKS5hZGRDbGFzcygneC1idG4tYXJyb3cnKTsKCiAgICAgICAgaWYodGhpcy5zaG93VG9kYXkpewogICAgICAgICAgICB0aGlzLnRvZGF5S2V5TGlzdGVuZXIgPSB0aGlzLmV2ZW50RWwuYWRkS2V5TGlzdGVuZXIoRXh0LkV2ZW50T2JqZWN0LlNQQUNFLCB0aGlzLnNlbGVjdFRvZGF5LCAgdGhpcyk7CiAgICAgICAgICAgIHZhciB0b2RheSA9IChuZXcgRGF0ZSgpKS5kYXRlRm9ybWF0KHRoaXMuZm9ybWF0KTsKICAgICAgICAgICAgdGhpcy50b2RheUJ0biA9IG5ldyBFeHQuQnV0dG9uKHsKICAgICAgICAgICAgICAgIHJlbmRlclRvOiB0aGlzLmVsLmNoaWxkKCd0ZC54LWRhdGUtYm90dG9tJywgdHJ1ZSksCiAgICAgICAgICAgICAgICB0ZXh0OiBTdHJpbmcuZm9ybWF0KHRoaXMudG9kYXlUZXh0LCB0b2RheSksCiAgICAgICAgICAgICAgICB0b29sdGlwOiBTdHJpbmcuZm9ybWF0KHRoaXMudG9kYXlUaXAsIHRvZGF5KSwKICAgICAgICAgICAgICAgIGhhbmRsZXI6IHRoaXMuc2VsZWN0VG9kYXksCiAgICAgICAgICAgICAgICBzY29wZTogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5tb24odGhpcy5ldmVudEVsLCAnbW91c2V3aGVlbCcsIHRoaXMuaGFuZGxlTW91c2VXaGVlbCwgdGhpcyk7CiAgICAgICAgdGhpcy5tb24odGhpcy5ldmVudEVsLCAnY2xpY2snLCB0aGlzLmhhbmRsZURhdGVDbGljaywgIHRoaXMsIHtkZWxlZ2F0ZTogJ2EueC1kYXRlLWRhdGUnfSk7CiAgICAgICAgdGhpcy5tb24odGhpcy5tYnRuLCAnY2xpY2snLCB0aGlzLnNob3dNb250aFBpY2tlciwgdGhpcyk7CiAgICAgICAgdGhpcy5vbkVuYWJsZSh0cnVlKTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVNb250aFBpY2tlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMubW9udGhQaWNrZXIuZG9tLmZpcnN0Q2hpbGQpewogICAgICAgICAgICB2YXIgYnVmID0gWyc8dGFibGUgYm9yZGVyPSIwIiBjZWxsc3BhY2luZz0iMCI+J107CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCA2OyBpKyspewogICAgICAgICAgICAgICAgYnVmLnB1c2goCiAgICAgICAgICAgICAgICAgICAgJzx0cj48dGQgY2xhc3M9IngtZGF0ZS1tcC1tb250aCI+PGEgaHJlZj0iIyI+JywgRGF0ZS5nZXRTaG9ydE1vbnRoTmFtZShpKSwgJzwvYT48L3RkPicsCiAgICAgICAgICAgICAgICAgICAgJzx0ZCBjbGFzcz0ieC1kYXRlLW1wLW1vbnRoIHgtZGF0ZS1tcC1zZXAiPjxhIGhyZWY9IiMiPicsIERhdGUuZ2V0U2hvcnRNb250aE5hbWUoaSArIDYpLCAnPC9hPjwvdGQ+JywKICAgICAgICAgICAgICAgICAgICBpID09PSAwID8KICAgICAgICAgICAgICAgICAgICAnPHRkIGNsYXNzPSJ4LWRhdGUtbXAteWJ0biIgYWxpZ249ImNlbnRlciI+PGEgY2xhc3M9IngtZGF0ZS1tcC1wcmV2Ij48L2E+PC90ZD48dGQgY2xhc3M9IngtZGF0ZS1tcC15YnRuIiBhbGlnbj0iY2VudGVyIj48YSBjbGFzcz0ieC1kYXRlLW1wLW5leHQiPjwvYT48L3RkPjwvdHI+JyA6CiAgICAgICAgICAgICAgICAgICAgJzx0ZCBjbGFzcz0ieC1kYXRlLW1wLXllYXIiPjxhIGhyZWY9IiMiPjwvYT48L3RkPjx0ZCBjbGFzcz0ieC1kYXRlLW1wLXllYXIiPjxhIGhyZWY9IiMiPjwvYT48L3RkPjwvdHI+JwogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWYucHVzaCgKICAgICAgICAgICAgICAgICc8dHIgY2xhc3M9IngtZGF0ZS1tcC1idG5zIj48dGQgY29sc3Bhbj0iNCI+PGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJ4LWRhdGUtbXAtb2siPicsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5va1RleHQsCiAgICAgICAgICAgICAgICAgICAgJzwvYnV0dG9uPjxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0ieC1kYXRlLW1wLWNhbmNlbCI+JywKICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbFRleHQsCiAgICAgICAgICAgICAgICAgICAgJzwvYnV0dG9uPjwvdGQ+PC90cj4nLAogICAgICAgICAgICAgICAgJzwvdGFibGU+JwogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLm1vbnRoUGlja2VyLnVwZGF0ZShidWYuam9pbignJykpOwoKICAgICAgICAgICAgdGhpcy5tb24odGhpcy5tb250aFBpY2tlciwgJ2NsaWNrJywgdGhpcy5vbk1vbnRoQ2xpY2ssIHRoaXMpOwogICAgICAgICAgICB0aGlzLm1vbih0aGlzLm1vbnRoUGlja2VyLCAnZGJsY2xpY2snLCB0aGlzLm9uTW9udGhEYmxDbGljaywgdGhpcyk7CgogICAgICAgICAgICB0aGlzLm1wTW9udGhzID0gdGhpcy5tb250aFBpY2tlci5zZWxlY3QoJ3RkLngtZGF0ZS1tcC1tb250aCcpOwogICAgICAgICAgICB0aGlzLm1wWWVhcnMgPSB0aGlzLm1vbnRoUGlja2VyLnNlbGVjdCgndGQueC1kYXRlLW1wLXllYXInKTsKCiAgICAgICAgICAgIHRoaXMubXBNb250aHMuZWFjaChmdW5jdGlvbihtLCBhLCBpKXsKICAgICAgICAgICAgICAgIGkgKz0gMTsKICAgICAgICAgICAgICAgIGlmKChpJTIpID09PSAwKXsKICAgICAgICAgICAgICAgICAgICBtLmRvbS54bW9udGggPSA1ICsgTWF0aC5yb3VuZChpICogMC41KTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIG0uZG9tLnhtb250aCA9IE1hdGgucm91bmQoKGktMSkgKiAwLjUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2hvd01vbnRoUGlja2VyIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5kaXNhYmxlZCl7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlTW9udGhQaWNrZXIoKTsKICAgICAgICAgICAgdmFyIHNpemUgPSB0aGlzLmVsLmdldFNpemUoKTsKICAgICAgICAgICAgdGhpcy5tb250aFBpY2tlci5zZXRTaXplKHNpemUpOwogICAgICAgICAgICB0aGlzLm1vbnRoUGlja2VyLmNoaWxkKCd0YWJsZScpLnNldFNpemUoc2l6ZSk7CgogICAgICAgICAgICB0aGlzLm1wU2VsTW9udGggPSAodGhpcy5hY3RpdmVEYXRlIHx8IHRoaXMudmFsdWUpLmdldE1vbnRoKCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlTVBNb250aCh0aGlzLm1wU2VsTW9udGgpOwogICAgICAgICAgICB0aGlzLm1wU2VsWWVhciA9ICh0aGlzLmFjdGl2ZURhdGUgfHwgdGhpcy52YWx1ZSkuZ2V0RnVsbFllYXIoKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVNUFllYXIodGhpcy5tcFNlbFllYXIpOwoKICAgICAgICAgICAgdGhpcy5tb250aFBpY2tlci5zbGlkZUluKCd0Jywge2R1cmF0aW9uOjAuMn0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICB1cGRhdGVNUFllYXIgOiBmdW5jdGlvbih5KXsKICAgICAgICB0aGlzLm1weWVhciA9IHk7CiAgICAgICAgdmFyIHlzID0gdGhpcy5tcFllYXJzLmVsZW1lbnRzOwogICAgICAgIGZvcih2YXIgaSA9IDE7IGkgPD0gMTA7IGkrKyl7CiAgICAgICAgICAgIHZhciB0ZCA9IHlzW2ktMV0sIHkyOwogICAgICAgICAgICBpZigoaSUyKSA9PT0gMCl7CiAgICAgICAgICAgICAgICB5MiA9IHkgKyBNYXRoLnJvdW5kKGkgKiAwLjUpOwogICAgICAgICAgICAgICAgdGQuZmlyc3RDaGlsZC5pbm5lckhUTUwgPSB5MjsKICAgICAgICAgICAgICAgIHRkLnh5ZWFyID0geTI7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgeTIgPSB5IC0gKDUtTWF0aC5yb3VuZChpICogMC41KSk7CiAgICAgICAgICAgICAgICB0ZC5maXJzdENoaWxkLmlubmVySFRNTCA9IHkyOwogICAgICAgICAgICAgICAgdGQueHllYXIgPSB5MjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm1wWWVhcnMuaXRlbShpLTEpW3kyID09IHRoaXMubXBTZWxZZWFyID8gJ2FkZENsYXNzJyA6ICdyZW1vdmVDbGFzcyddKCd4LWRhdGUtbXAtc2VsJyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHVwZGF0ZU1QTW9udGggOiBmdW5jdGlvbihzbSl7CiAgICAgICAgdGhpcy5tcE1vbnRocy5lYWNoKGZ1bmN0aW9uKG0sIGEsIGkpewogICAgICAgICAgICBtW20uZG9tLnhtb250aCA9PSBzbSA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnXSgneC1kYXRlLW1wLXNlbCcpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIHNlbGVjdE1QTW9udGggOiBmdW5jdGlvbihtKXsKCiAgICB9LAoKICAgIAogICAgb25Nb250aENsaWNrIDogZnVuY3Rpb24oZSwgdCl7CiAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICB2YXIgZWwgPSBuZXcgRXh0LkVsZW1lbnQodCksIHBuOwogICAgICAgIGlmKGVsLmlzKCdidXR0b24ueC1kYXRlLW1wLWNhbmNlbCcpKXsKICAgICAgICAgICAgdGhpcy5oaWRlTW9udGhQaWNrZXIoKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihlbC5pcygnYnV0dG9uLngtZGF0ZS1tcC1vaycpKXsKICAgICAgICAgICAgdmFyIGQgPSBuZXcgRGF0ZSh0aGlzLm1wU2VsWWVhciwgdGhpcy5tcFNlbE1vbnRoLCAodGhpcy5hY3RpdmVEYXRlIHx8IHRoaXMudmFsdWUpLmdldERhdGUoKSk7CiAgICAgICAgICAgIGlmKGQuZ2V0TW9udGgoKSAhPSB0aGlzLm1wU2VsTW9udGgpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBkID0gbmV3IERhdGUodGhpcy5tcFNlbFllYXIsIHRoaXMubXBTZWxNb250aCwgMSkuZ2V0TGFzdERhdGVPZk1vbnRoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy51cGRhdGUoZCk7CiAgICAgICAgICAgIHRoaXMuaGlkZU1vbnRoUGlja2VyKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoKHBuID0gZWwudXAoJ3RkLngtZGF0ZS1tcC1tb250aCcsIDIpKSl7CiAgICAgICAgICAgIHRoaXMubXBNb250aHMucmVtb3ZlQ2xhc3MoJ3gtZGF0ZS1tcC1zZWwnKTsKICAgICAgICAgICAgcG4uYWRkQ2xhc3MoJ3gtZGF0ZS1tcC1zZWwnKTsKICAgICAgICAgICAgdGhpcy5tcFNlbE1vbnRoID0gcG4uZG9tLnhtb250aDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZigocG4gPSBlbC51cCgndGQueC1kYXRlLW1wLXllYXInLCAyKSkpewogICAgICAgICAgICB0aGlzLm1wWWVhcnMucmVtb3ZlQ2xhc3MoJ3gtZGF0ZS1tcC1zZWwnKTsKICAgICAgICAgICAgcG4uYWRkQ2xhc3MoJ3gtZGF0ZS1tcC1zZWwnKTsKICAgICAgICAgICAgdGhpcy5tcFNlbFllYXIgPSBwbi5kb20ueHllYXI7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYoZWwuaXMoJ2EueC1kYXRlLW1wLXByZXYnKSl7CiAgICAgICAgICAgIHRoaXMudXBkYXRlTVBZZWFyKHRoaXMubXB5ZWFyLTEwKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihlbC5pcygnYS54LWRhdGUtbXAtbmV4dCcpKXsKICAgICAgICAgICAgdGhpcy51cGRhdGVNUFllYXIodGhpcy5tcHllYXIrMTApOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbk1vbnRoRGJsQ2xpY2sgOiBmdW5jdGlvbihlLCB0KXsKICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgIHZhciBlbCA9IG5ldyBFeHQuRWxlbWVudCh0KSwgcG47CiAgICAgICAgaWYoKHBuID0gZWwudXAoJ3RkLngtZGF0ZS1tcC1tb250aCcsIDIpKSl7CiAgICAgICAgICAgIHRoaXMudXBkYXRlKG5ldyBEYXRlKHRoaXMubXBTZWxZZWFyLCBwbi5kb20ueG1vbnRoLCAodGhpcy5hY3RpdmVEYXRlIHx8IHRoaXMudmFsdWUpLmdldERhdGUoKSkpOwogICAgICAgICAgICB0aGlzLmhpZGVNb250aFBpY2tlcigpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKChwbiA9IGVsLnVwKCd0ZC54LWRhdGUtbXAteWVhcicsIDIpKSl7CiAgICAgICAgICAgIHRoaXMudXBkYXRlKG5ldyBEYXRlKHBuLmRvbS54eWVhciwgdGhpcy5tcFNlbE1vbnRoLCAodGhpcy5hY3RpdmVEYXRlIHx8IHRoaXMudmFsdWUpLmdldERhdGUoKSkpOwogICAgICAgICAgICB0aGlzLmhpZGVNb250aFBpY2tlcigpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBoaWRlTW9udGhQaWNrZXIgOiBmdW5jdGlvbihkaXNhYmxlQW5pbSl7CiAgICAgICAgaWYodGhpcy5tb250aFBpY2tlcil7CiAgICAgICAgICAgIGlmKGRpc2FibGVBbmltID09PSB0cnVlKXsKICAgICAgICAgICAgICAgIHRoaXMubW9udGhQaWNrZXIuaGlkZSgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMubW9udGhQaWNrZXIuc2xpZGVPdXQoJ3QnLCB7ZHVyYXRpb246MC4yfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2hvd1ByZXZNb250aCA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMudXBkYXRlKHRoaXMuYWN0aXZlRGF0ZS5hZGQoJ21vJywgLTEpKTsKICAgIH0sCgogICAgCiAgICBzaG93TmV4dE1vbnRoIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy51cGRhdGUodGhpcy5hY3RpdmVEYXRlLmFkZCgnbW8nLCAxKSk7CiAgICB9LAoKICAgIAogICAgc2hvd1ByZXZZZWFyIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnVwZGF0ZSh0aGlzLmFjdGl2ZURhdGUuYWRkKCd5JywgLTEpKTsKICAgIH0sCgogICAgCiAgICBzaG93TmV4dFllYXIgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMudXBkYXRlKHRoaXMuYWN0aXZlRGF0ZS5hZGQoJ3knLCAxKSk7CiAgICB9LAoKICAgIAogICAgaGFuZGxlTW91c2VXaGVlbCA6IGZ1bmN0aW9uKGUpewogICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgaWYoIXRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICB2YXIgZGVsdGEgPSBlLmdldFdoZWVsRGVsdGEoKTsKICAgICAgICAgICAgaWYoZGVsdGEgPiAwKXsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd1ByZXZNb250aCgpOwogICAgICAgICAgICB9IGVsc2UgaWYoZGVsdGEgPCAwKXsKICAgICAgICAgICAgICAgIHRoaXMuc2hvd05leHRNb250aCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGhhbmRsZURhdGVDbGljayA6IGZ1bmN0aW9uKGUsIHQpewogICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgaWYoIXRoaXMuZGlzYWJsZWQgJiYgdC5kYXRlVmFsdWUgJiYgIUV4dC5mbHkodC5wYXJlbnROb2RlKS5oYXNDbGFzcygneC1kYXRlLWRpc2FibGVkJykpewogICAgICAgICAgICB0aGlzLmNhbmNlbEZvY3VzID0gdGhpcy5mb2N1c09uU2VsZWN0ID09PSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZShuZXcgRGF0ZSh0LmRhdGVWYWx1ZSkpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5jYW5jZWxGb2N1czsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3NlbGVjdCcsIHRoaXMsIHRoaXMudmFsdWUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZWxlY3RUb2RheSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy50b2RheUJ0biAmJiAhdGhpcy50b2RheUJ0bi5kaXNhYmxlZCl7CiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUobmV3IERhdGUoKS5jbGVhclRpbWUoKSk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzZWxlY3QnLCB0aGlzLCB0aGlzLnZhbHVlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdXBkYXRlIDogZnVuY3Rpb24oZGF0ZSwgZm9yY2VSZWZyZXNoKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdmFyIHZkID0gdGhpcy5hY3RpdmVEYXRlLCB2aXMgPSB0aGlzLmlzVmlzaWJsZSgpOwogICAgICAgICAgICB0aGlzLmFjdGl2ZURhdGUgPSBkYXRlOwogICAgICAgICAgICBpZighZm9yY2VSZWZyZXNoICYmIHZkICYmIHRoaXMuZWwpewogICAgICAgICAgICAgICAgdmFyIHQgPSBkYXRlLmdldFRpbWUoKTsKICAgICAgICAgICAgICAgIGlmKHZkLmdldE1vbnRoKCkgPT0gZGF0ZS5nZXRNb250aCgpICYmIHZkLmdldEZ1bGxZZWFyKCkgPT0gZGF0ZS5nZXRGdWxsWWVhcigpKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNlbGxzLnJlbW92ZUNsYXNzKCd4LWRhdGUtc2VsZWN0ZWQnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNlbGxzLmVhY2goZnVuY3Rpb24oYyl7CiAgICAgICAgICAgICAgICAgICAgICAgaWYoYy5kb20uZmlyc3RDaGlsZC5kYXRlVmFsdWUgPT0gdCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIGMuYWRkQ2xhc3MoJ3gtZGF0ZS1zZWxlY3RlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICBpZih2aXMgJiYgIXRoaXMuY2FuY2VsRm9jdXMpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRXh0LmZseShjLmRvbS5maXJzdENoaWxkKS5mb2N1cyg1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRheXMgPSBkYXRlLmdldERheXNJbk1vbnRoKCksCiAgICAgICAgICAgICAgICBmaXJzdE9mTW9udGggPSBkYXRlLmdldEZpcnN0RGF0ZU9mTW9udGgoKSwKICAgICAgICAgICAgICAgIHN0YXJ0aW5nUG9zID0gZmlyc3RPZk1vbnRoLmdldERheSgpLXRoaXMuc3RhcnREYXk7CgogICAgICAgICAgICBpZihzdGFydGluZ1BvcyA8IDApewogICAgICAgICAgICAgICAgc3RhcnRpbmdQb3MgKz0gNzsKICAgICAgICAgICAgfQogICAgICAgICAgICBkYXlzICs9IHN0YXJ0aW5nUG9zOwoKICAgICAgICAgICAgdmFyIHBtID0gZGF0ZS5hZGQoJ21vJywgLTEpLAogICAgICAgICAgICAgICAgcHJldlN0YXJ0ID0gcG0uZ2V0RGF5c0luTW9udGgoKS1zdGFydGluZ1BvcywKICAgICAgICAgICAgICAgIGNlbGxzID0gdGhpcy5jZWxscy5lbGVtZW50cywKICAgICAgICAgICAgICAgIHRleHRFbHMgPSB0aGlzLnRleHROb2RlcywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZCA9IChuZXcgRGF0ZShwbS5nZXRGdWxsWWVhcigpLCBwbS5nZXRNb250aCgpLCBwcmV2U3RhcnQsIHRoaXMuaW5pdEhvdXIpKSwKICAgICAgICAgICAgICAgIHRvZGF5ID0gbmV3IERhdGUoKS5jbGVhclRpbWUoKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICBzZWwgPSBkYXRlLmNsZWFyVGltZSh0cnVlKS5nZXRUaW1lKCksCiAgICAgICAgICAgICAgICBtaW4gPSB0aGlzLm1pbkRhdGUgPyB0aGlzLm1pbkRhdGUuY2xlYXJUaW1lKHRydWUpIDogTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLAogICAgICAgICAgICAgICAgbWF4ID0gdGhpcy5tYXhEYXRlID8gdGhpcy5tYXhEYXRlLmNsZWFyVGltZSh0cnVlKSA6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwKICAgICAgICAgICAgICAgIGRkTWF0Y2ggPSB0aGlzLmRpc2FibGVkRGF0ZXNSRSwKICAgICAgICAgICAgICAgIGRkVGV4dCA9IHRoaXMuZGlzYWJsZWREYXRlc1RleHQsCiAgICAgICAgICAgICAgICBkZGF5cyA9IHRoaXMuZGlzYWJsZWREYXlzID8gdGhpcy5kaXNhYmxlZERheXMuam9pbignJykgOiBmYWxzZSwKICAgICAgICAgICAgICAgIGRkYXlzVGV4dCA9IHRoaXMuZGlzYWJsZWREYXlzVGV4dCwKICAgICAgICAgICAgICAgIGZvcm1hdCA9IHRoaXMuZm9ybWF0OwoKICAgICAgICAgICAgaWYodGhpcy5zaG93VG9kYXkpewogICAgICAgICAgICAgICAgdmFyIHRkID0gbmV3IERhdGUoKS5jbGVhclRpbWUoKSwKICAgICAgICAgICAgICAgICAgICBkaXNhYmxlID0gKHRkIDwgbWluIHx8IHRkID4gbWF4IHx8CiAgICAgICAgICAgICAgICAgICAgKGRkTWF0Y2ggJiYgZm9ybWF0ICYmIGRkTWF0Y2gudGVzdCh0ZC5kYXRlRm9ybWF0KGZvcm1hdCkpKSB8fAogICAgICAgICAgICAgICAgICAgIChkZGF5cyAmJiBkZGF5cy5pbmRleE9mKHRkLmdldERheSgpKSAhPSAtMSkpOwoKICAgICAgICAgICAgICAgIGlmKCF0aGlzLmRpc2FibGVkKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRvZGF5QnRuLnNldERpc2FibGVkKGRpc2FibGUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudG9kYXlLZXlMaXN0ZW5lcltkaXNhYmxlID8gJ2Rpc2FibGUnIDogJ2VuYWJsZSddKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBzZXRDZWxsQ2xhc3MgPSBmdW5jdGlvbihjYWwsIGNlbGwpewogICAgICAgICAgICAgICAgY2VsbC50aXRsZSA9ICcnOwogICAgICAgICAgICAgICAgdmFyIHQgPSBkLmNsZWFyVGltZSh0cnVlKS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICBjZWxsLmZpcnN0Q2hpbGQuZGF0ZVZhbHVlID0gdDsKICAgICAgICAgICAgICAgIGlmKHQgPT0gdG9kYXkpewogICAgICAgICAgICAgICAgICAgIGNlbGwuY2xhc3NOYW1lICs9ICcgeC1kYXRlLXRvZGF5JzsKICAgICAgICAgICAgICAgICAgICBjZWxsLnRpdGxlID0gY2FsLnRvZGF5VGV4dDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKHQgPT0gc2VsKXsKICAgICAgICAgICAgICAgICAgICBjZWxsLmNsYXNzTmFtZSArPSAnIHgtZGF0ZS1zZWxlY3RlZCc7CiAgICAgICAgICAgICAgICAgICAgaWYodmlzKXsKICAgICAgICAgICAgICAgICAgICAgICAgRXh0LmZseShjZWxsLmZpcnN0Q2hpbGQpLmZvY3VzKDUwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmKHQgPCBtaW4pIHsKICAgICAgICAgICAgICAgICAgICBjZWxsLmNsYXNzTmFtZSA9ICcgeC1kYXRlLWRpc2FibGVkJzsKICAgICAgICAgICAgICAgICAgICBjZWxsLnRpdGxlID0gY2FsLm1pblRleHQ7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYodCA+IG1heCkgewogICAgICAgICAgICAgICAgICAgIGNlbGwuY2xhc3NOYW1lID0gJyB4LWRhdGUtZGlzYWJsZWQnOwogICAgICAgICAgICAgICAgICAgIGNlbGwudGl0bGUgPSBjYWwubWF4VGV4dDsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihkZGF5cyl7CiAgICAgICAgICAgICAgICAgICAgaWYoZGRheXMuaW5kZXhPZihkLmdldERheSgpKSAhPSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGwudGl0bGUgPSBkZGF5c1RleHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNlbGwuY2xhc3NOYW1lID0gJyB4LWRhdGUtZGlzYWJsZWQnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKGRkTWF0Y2ggJiYgZm9ybWF0KXsKICAgICAgICAgICAgICAgICAgICB2YXIgZnZhbHVlID0gZC5kYXRlRm9ybWF0KGZvcm1hdCk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGRNYXRjaC50ZXN0KGZ2YWx1ZSkpewogICAgICAgICAgICAgICAgICAgICAgICBjZWxsLnRpdGxlID0gZGRUZXh0LnJlcGxhY2UoJyUwJywgZnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2VsbC5jbGFzc05hbWUgPSAnIHgtZGF0ZS1kaXNhYmxlZCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICBmb3IoOyBpIDwgc3RhcnRpbmdQb3M7IGkrKykgewogICAgICAgICAgICAgICAgdGV4dEVsc1tpXS5pbm5lckhUTUwgPSAoKytwcmV2U3RhcnQpOwogICAgICAgICAgICAgICAgZC5zZXREYXRlKGQuZ2V0RGF0ZSgpKzEpOwogICAgICAgICAgICAgICAgY2VsbHNbaV0uY2xhc3NOYW1lID0gJ3gtZGF0ZS1wcmV2ZGF5JzsKICAgICAgICAgICAgICAgIHNldENlbGxDbGFzcyh0aGlzLCBjZWxsc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKDsgaSA8IGRheXM7IGkrKyl7CiAgICAgICAgICAgICAgICB2YXIgaW50RGF5ID0gaSAtIHN0YXJ0aW5nUG9zICsgMTsKICAgICAgICAgICAgICAgIHRleHRFbHNbaV0uaW5uZXJIVE1MID0gKGludERheSk7CiAgICAgICAgICAgICAgICBkLnNldERhdGUoZC5nZXREYXRlKCkrMSk7CiAgICAgICAgICAgICAgICBjZWxsc1tpXS5jbGFzc05hbWUgPSAneC1kYXRlLWFjdGl2ZSc7CiAgICAgICAgICAgICAgICBzZXRDZWxsQ2xhc3ModGhpcywgY2VsbHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleHRyYURheXMgPSAwOwogICAgICAgICAgICBmb3IoOyBpIDwgNDI7IGkrKykgewogICAgICAgICAgICAgICAgIHRleHRFbHNbaV0uaW5uZXJIVE1MID0gKCsrZXh0cmFEYXlzKTsKICAgICAgICAgICAgICAgICBkLnNldERhdGUoZC5nZXREYXRlKCkrMSk7CiAgICAgICAgICAgICAgICAgY2VsbHNbaV0uY2xhc3NOYW1lID0gJ3gtZGF0ZS1uZXh0ZGF5JzsKICAgICAgICAgICAgICAgICBzZXRDZWxsQ2xhc3ModGhpcywgY2VsbHNbaV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1idG4uc2V0VGV4dCh0aGlzLm1vbnRoTmFtZXNbZGF0ZS5nZXRNb250aCgpXSArICcgJyArIGRhdGUuZ2V0RnVsbFllYXIoKSk7CgogICAgICAgICAgICBpZighdGhpcy5pbnRlcm5hbFJlbmRlcil7CiAgICAgICAgICAgICAgICB2YXIgbWFpbiA9IHRoaXMuZWwuZG9tLmZpcnN0Q2hpbGQsCiAgICAgICAgICAgICAgICAgICAgdyA9IG1haW4ub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnNldFdpZHRoKHcgKyB0aGlzLmVsLmdldEJvcmRlcldpZHRoKCdscicpKTsKICAgICAgICAgICAgICAgIEV4dC5mbHkobWFpbikuc2V0V2lkdGgodyk7CiAgICAgICAgICAgICAgICB0aGlzLmludGVybmFsUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmKEV4dC5pc09wZXJhICYmICF0aGlzLnNlY29uZFBhc3MpewogICAgICAgICAgICAgICAgICAgIG1haW4ucm93c1swXS5jZWxsc1sxXS5zdHlsZS53aWR0aCA9ICh3IC0gKG1haW4ucm93c1swXS5jZWxsc1swXS5vZmZzZXRXaWR0aCttYWluLnJvd3NbMF0uY2VsbHNbMl0ub2Zmc2V0V2lkdGgpKSArICdweCc7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWNvbmRQYXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZS5kZWZlcigxMCwgdGhpcywgW2RhdGVdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBiZWZvcmVEZXN0cm95IDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIEV4dC5kZXN0cm95KAogICAgICAgICAgICAgICAgdGhpcy5rZXlOYXYsCiAgICAgICAgICAgICAgICB0aGlzLm1vbnRoUGlja2VyLAogICAgICAgICAgICAgICAgdGhpcy5ldmVudEVsLAogICAgICAgICAgICAgICAgdGhpcy5tYnRuLAogICAgICAgICAgICAgICAgdGhpcy5uZXh0UmVwZWF0ZXIsCiAgICAgICAgICAgICAgICB0aGlzLnByZXZSZXBlYXRlciwKICAgICAgICAgICAgICAgIHRoaXMuY2VsbHMuZWwsCiAgICAgICAgICAgICAgICB0aGlzLnRvZGF5QnRuCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRleHROb2RlczsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2VsbHMuZWxlbWVudHM7CiAgICAgICAgfQogICAgfQoKICAgIAp9KTsKCkV4dC5yZWcoJ2RhdGVwaWNrZXInLCBFeHQuRGF0ZVBpY2tlcik7CgpFeHQuTG9hZE1hc2sgPSBmdW5jdGlvbihlbCwgY29uZmlnKXsKICAgIHRoaXMuZWwgPSBFeHQuZ2V0KGVsKTsKICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwogICAgaWYodGhpcy5zdG9yZSl7CiAgICAgICAgdGhpcy5zdG9yZS5vbih7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBiZWZvcmVsb2FkOiB0aGlzLm9uQmVmb3JlTG9hZCwKICAgICAgICAgICAgbG9hZDogdGhpcy5vbkxvYWQsCiAgICAgICAgICAgIGV4Y2VwdGlvbjogdGhpcy5vbkxvYWQKICAgICAgICB9KTsKICAgICAgICB0aGlzLnJlbW92ZU1hc2sgPSBFeHQudmFsdWUodGhpcy5yZW1vdmVNYXNrLCBmYWxzZSk7CiAgICB9ZWxzZXsKICAgICAgICB2YXIgdW0gPSB0aGlzLmVsLmdldFVwZGF0ZXIoKTsKICAgICAgICB1bS5zaG93TG9hZEluZGljYXRvciA9IGZhbHNlOyAKICAgICAgICB1bS5vbih7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBiZWZvcmV1cGRhdGU6IHRoaXMub25CZWZvcmVMb2FkLAogICAgICAgICAgICB1cGRhdGU6IHRoaXMub25Mb2FkLAogICAgICAgICAgICBmYWlsdXJlOiB0aGlzLm9uTG9hZAogICAgICAgIH0pOwogICAgICAgIHRoaXMucmVtb3ZlTWFzayA9IEV4dC52YWx1ZSh0aGlzLnJlbW92ZU1hc2ssIHRydWUpOwogICAgfQp9OwoKRXh0LkxvYWRNYXNrLnByb3RvdHlwZSA9IHsKICAgIAogICAgCiAgICAKICAgIG1zZyA6ICdMb2FkaW5nLi4uJywKICAgIAogICAgbXNnQ2xzIDogJ3gtbWFzay1sb2FkaW5nJywKCiAgICAKICAgIGRpc2FibGVkOiBmYWxzZSwKCiAgICAKICAgIGRpc2FibGUgOiBmdW5jdGlvbigpewogICAgICAgdGhpcy5kaXNhYmxlZCA9IHRydWU7CiAgICB9LAoKICAgIAogICAgZW5hYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7CiAgICB9LAoKICAgIAogICAgb25Mb2FkIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmVsLnVubWFzayh0aGlzLnJlbW92ZU1hc2spOwogICAgfSwKCiAgICAKICAgIG9uQmVmb3JlTG9hZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICB0aGlzLmVsLm1hc2sodGhpcy5tc2csIHRoaXMubXNnQ2xzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2hvdzogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLm9uQmVmb3JlTG9hZCgpOwogICAgfSwKCiAgICAKICAgIGhpZGU6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5vbkxvYWQoKTsKICAgIH0sCgogICAgCiAgICBkZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnN0b3JlKXsKICAgICAgICAgICAgdGhpcy5zdG9yZS51bignYmVmb3JlbG9hZCcsIHRoaXMub25CZWZvcmVMb2FkLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5zdG9yZS51bignbG9hZCcsIHRoaXMub25Mb2FkLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5zdG9yZS51bignZXhjZXB0aW9uJywgdGhpcy5vbkxvYWQsIHRoaXMpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB2YXIgdW0gPSB0aGlzLmVsLmdldFVwZGF0ZXIoKTsKICAgICAgICAgICAgdW0udW4oJ2JlZm9yZXVwZGF0ZScsIHRoaXMub25CZWZvcmVMb2FkLCB0aGlzKTsKICAgICAgICAgICAgdW0udW4oJ3VwZGF0ZScsIHRoaXMub25Mb2FkLCB0aGlzKTsKICAgICAgICAgICAgdW0udW4oJ2ZhaWx1cmUnLCB0aGlzLm9uTG9hZCwgdGhpcyk7CiAgICAgICAgfQogICAgfQp9OwpFeHQuc2xpZGVyLlRodW1iID0gRXh0LmV4dGVuZChPYmplY3QsIHsKICAgIAogICAgCiAgICBkcmFnZ2luZzogZmFsc2UsCgogICAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgCiAgICAgICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyB8fCB7fSwgewogICAgICAgICAgICBjbHM6ICd4LXNsaWRlci10aHVtYicsCgogICAgICAgICAgICAKICAgICAgICAgICAgY29uc3RyYWluOiBmYWxzZQogICAgICAgIH0pOwoKICAgICAgICBFeHQuc2xpZGVyLlRodW1iLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBjb25maWcpOwoKICAgICAgICBpZiAodGhpcy5zbGlkZXIudmVydGljYWwpIHsKICAgICAgICAgICAgRXh0LmFwcGx5KHRoaXMsIEV4dC5zbGlkZXIuVGh1bWIuVmVydGljYWwpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZWwgPSB0aGlzLnNsaWRlci5pbm5lckVsLmluc2VydEZpcnN0KHtjbHM6IHRoaXMuY2xzfSk7CgogICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgfSwKCiAgICAKICAgIGVuYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3ModGhpcy5zbGlkZXIuZGlzYWJsZWRDbGFzcyk7CiAgICB9LAoKICAgIAogICAgZGlzYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5lbC5hZGRDbGFzcyh0aGlzLnNsaWRlci5kaXNhYmxlZENsYXNzKTsKICAgIH0sCgogICAgCiAgICBpbml0RXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZWwgPSB0aGlzLmVsOwoKICAgICAgICBlbC5hZGRDbGFzc09uT3ZlcigneC1zbGlkZXItdGh1bWItb3ZlcicpOwoKICAgICAgICB0aGlzLnRyYWNrZXIgPSBuZXcgRXh0LmRkLkRyYWdUcmFja2VyKHsKICAgICAgICAgICAgb25CZWZvcmVTdGFydDogdGhpcy5vbkJlZm9yZURyYWdTdGFydC5jcmVhdGVEZWxlZ2F0ZSh0aGlzKSwKICAgICAgICAgICAgb25TdGFydCAgICAgIDogdGhpcy5vbkRyYWdTdGFydC5jcmVhdGVEZWxlZ2F0ZSh0aGlzKSwKICAgICAgICAgICAgb25EcmFnICAgICAgIDogdGhpcy5vbkRyYWcuY3JlYXRlRGVsZWdhdGUodGhpcyksCiAgICAgICAgICAgIG9uRW5kICAgICAgICA6IHRoaXMub25EcmFnRW5kLmNyZWF0ZURlbGVnYXRlKHRoaXMpLAogICAgICAgICAgICB0b2xlcmFuY2UgICAgOiAzLAogICAgICAgICAgICBhdXRvU3RhcnQgICAgOiAzMDAKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy50cmFja2VyLmluaXRFbChlbCk7CiAgICB9LAoKICAgIAogICAgb25CZWZvcmVEcmFnU3RhcnQgOiBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyLnByb21vdGVUaHVtYih0aGlzKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uRHJhZ1N0YXJ0OiBmdW5jdGlvbihlKXsKICAgICAgICB0aGlzLmVsLmFkZENsYXNzKCd4LXNsaWRlci10aHVtYi1kcmFnJyk7CiAgICAgICAgdGhpcy5kcmFnZ2luZyA9IHRydWU7CiAgICAgICAgdGhpcy5kcmFnU3RhcnRWYWx1ZSA9IHRoaXMudmFsdWU7CgogICAgICAgIHRoaXMuc2xpZGVyLmZpcmVFdmVudCgnZHJhZ3N0YXJ0JywgdGhpcy5zbGlkZXIsIGUsIHRoaXMpOwogICAgfSwKCiAgICAKICAgIG9uRHJhZzogZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBzbGlkZXIgICA9IHRoaXMuc2xpZGVyLAogICAgICAgICAgICBpbmRleCAgICA9IHRoaXMuaW5kZXgsCiAgICAgICAgICAgIG5ld1ZhbHVlID0gdGhpcy5nZXROZXdWYWx1ZSgpOwoKICAgICAgICBpZiAodGhpcy5jb25zdHJhaW4pIHsKICAgICAgICAgICAgdmFyIGFib3ZlID0gc2xpZGVyLnRodW1ic1tpbmRleCArIDFdLAogICAgICAgICAgICAgICAgYmVsb3cgPSBzbGlkZXIudGh1bWJzW2luZGV4IC0gMV07CgogICAgICAgICAgICBpZiAoYmVsb3cgIT0gdW5kZWZpbmVkICYmIG5ld1ZhbHVlIDw9IGJlbG93LnZhbHVlKSBuZXdWYWx1ZSA9IGJlbG93LnZhbHVlOwogICAgICAgICAgICBpZiAoYWJvdmUgIT0gdW5kZWZpbmVkICYmIG5ld1ZhbHVlID49IGFib3ZlLnZhbHVlKSBuZXdWYWx1ZSA9IGFib3ZlLnZhbHVlOwogICAgICAgIH0KCiAgICAgICAgc2xpZGVyLnNldFZhbHVlKGluZGV4LCBuZXdWYWx1ZSwgZmFsc2UpOwogICAgICAgIHNsaWRlci5maXJlRXZlbnQoJ2RyYWcnLCBzbGlkZXIsIGUsIHRoaXMpOwogICAgfSwKCiAgICBnZXROZXdWYWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNsaWRlciAgID0gdGhpcy5zbGlkZXIsCiAgICAgICAgICAgIHBvcyAgICAgID0gc2xpZGVyLmlubmVyRWwudHJhbnNsYXRlUG9pbnRzKHRoaXMudHJhY2tlci5nZXRYWSgpKTsKCiAgICAgICAgcmV0dXJuIEV4dC51dGlsLkZvcm1hdC5yb3VuZChzbGlkZXIucmV2ZXJzZVZhbHVlKHBvcy5sZWZ0KSwgc2xpZGVyLmRlY2ltYWxQcmVjaXNpb24pOwogICAgfSwKCiAgICAKICAgIG9uRHJhZ0VuZDogZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBzbGlkZXIgPSB0aGlzLnNsaWRlciwKICAgICAgICAgICAgdmFsdWUgID0gdGhpcy52YWx1ZTsKCiAgICAgICAgdGhpcy5lbC5yZW1vdmVDbGFzcygneC1zbGlkZXItdGh1bWItZHJhZycpOwoKICAgICAgICB0aGlzLmRyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgc2xpZGVyLmZpcmVFdmVudCgnZHJhZ2VuZCcsIHNsaWRlciwgZSk7CgogICAgICAgIGlmICh0aGlzLmRyYWdTdGFydFZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgIHNsaWRlci5maXJlRXZlbnQoJ2NoYW5nZWNvbXBsZXRlJywgc2xpZGVyLCB2YWx1ZSwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBkZXN0cm95OiBmdW5jdGlvbigpewogICAgICAgIEV4dC5kZXN0cm95TWVtYmVycyh0aGlzLCAndHJhY2tlcicsICdlbCcpOwogICAgfQp9KTsKCgpFeHQuc2xpZGVyLk11bHRpU2xpZGVyID0gRXh0LmV4dGVuZChFeHQuQm94Q29tcG9uZW50LCB7CiAgICAKICAgIAogICAgdmVydGljYWw6IGZhbHNlLAogICAgCiAgICBtaW5WYWx1ZTogMCwKICAgIAogICAgbWF4VmFsdWU6IDEwMCwKICAgIAogICAgZGVjaW1hbFByZWNpc2lvbjogMCwKICAgIAogICAga2V5SW5jcmVtZW50OiAxLAogICAgCiAgICBpbmNyZW1lbnQ6IDAsCgogICAgCiAgICBjbGlja1JhbmdlOiBbNSwxNV0sCgogICAgCiAgICBjbGlja1RvQ2hhbmdlIDogdHJ1ZSwKICAgIAogICAgYW5pbWF0ZTogdHJ1ZSwKICAgIAogICAgY29uc3RyYWluVGh1bWJzOiB0cnVlLAoKICAgIAogICAgdG9wVGh1bWJaSW5kZXg6IDEwMDAwLAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIUV4dC5pc0RlZmluZWQodGhpcy52YWx1ZSkpewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy5taW5WYWx1ZTsKICAgICAgICB9CgogICAgICAgIAogICAgICAgIHRoaXMudGh1bWJzID0gW107CgogICAgICAgIEV4dC5zbGlkZXIuTXVsdGlTbGlkZXIuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CgogICAgICAgIHRoaXMua2V5SW5jcmVtZW50ID0gTWF0aC5tYXgodGhpcy5pbmNyZW1lbnQsIHRoaXMua2V5SW5jcmVtZW50KTsKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVjaGFuZ2UnLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICdjaGFuZ2UnLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICdjaGFuZ2Vjb21wbGV0ZScsCgogICAgICAgICAgICAKICAgICAgICAgICAgJ2RyYWdzdGFydCcsCgogICAgICAgICAgICAKICAgICAgICAgICAgJ2RyYWcnLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICdkcmFnZW5kJwogICAgICAgICk7CgogICAgICAgIAogICAgICAgIGlmICh0aGlzLnZhbHVlcyA9PSB1bmRlZmluZWQgfHwgRXh0LmlzRW1wdHkodGhpcy52YWx1ZXMpKSB0aGlzLnZhbHVlcyA9IFswXTsKCiAgICAgICAgdmFyIHZhbHVlcyA9IHRoaXMudmFsdWVzOwoKICAgICAgICBmb3IgKHZhciBpPTA7IGkgPCB2YWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5hZGRUaHVtYih2YWx1ZXNbaV0pOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy52ZXJ0aWNhbCl7CiAgICAgICAgICAgIEV4dC5hcHBseSh0aGlzLCBFeHQuc2xpZGVyLlZlcnRpY2FsKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYWRkVGh1bWI6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIHRodW1iID0gbmV3IEV4dC5zbGlkZXIuVGh1bWIoewogICAgICAgICAgICB2YWx1ZSAgICA6IHZhbHVlLAogICAgICAgICAgICBzbGlkZXIgICA6IHRoaXMsCiAgICAgICAgICAgIGluZGV4ICAgIDogdGhpcy50aHVtYnMubGVuZ3RoLAogICAgICAgICAgICBjb25zdHJhaW46IHRoaXMuY29uc3RyYWluVGh1bWJzCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy50aHVtYnMucHVzaCh0aHVtYik7CgogICAgICAgIAogICAgICAgIGlmICh0aGlzLnJlbmRlcmVkKSB0aHVtYi5yZW5kZXIoKTsKICAgIH0sCgogICAgCiAgICBwcm9tb3RlVGh1bWI6IGZ1bmN0aW9uKHRvcFRodW1iKSB7CiAgICAgICAgdmFyIHRodW1icyA9IHRoaXMudGh1bWJzLAogICAgICAgICAgICB6SW5kZXgsIHRodW1iOwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgaiA9IHRodW1icy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgdGh1bWIgPSB0aHVtYnNbaV07CgogICAgICAgICAgICBpZiAodGh1bWIgPT0gdG9wVGh1bWIpIHsKICAgICAgICAgICAgICAgIHpJbmRleCA9IHRoaXMudG9wVGh1bWJaSW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB6SW5kZXggPSAnJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGh1bWIuZWwuc2V0U3R5bGUoJ3pJbmRleCcsIHpJbmRleCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5hdXRvRWwgPSB7CiAgICAgICAgICAgIGNsczogJ3gtc2xpZGVyICcgKyAodGhpcy52ZXJ0aWNhbCA/ICd4LXNsaWRlci12ZXJ0JyA6ICd4LXNsaWRlci1ob3J6JyksCiAgICAgICAgICAgIGNuIDogewogICAgICAgICAgICAgICAgY2xzOiAneC1zbGlkZXItZW5kJywKICAgICAgICAgICAgICAgIGNuIDogewogICAgICAgICAgICAgICAgICAgIGNsczoneC1zbGlkZXItaW5uZXInLAogICAgICAgICAgICAgICAgICAgIGNuIDogW3t0YWc6J2EnLCBjbHM6J3gtc2xpZGVyLWZvY3VzJywgaHJlZjoiIyIsIHRhYkluZGV4OiAnLTEnLCBoaWRlZm9jdXM6J29uJ31dCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBFeHQuc2xpZGVyLk11bHRpU2xpZGVyLnN1cGVyY2xhc3Mub25SZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgdGhpcy5lbmRFbCAgID0gdGhpcy5lbC5maXJzdCgpOwogICAgICAgIHRoaXMuaW5uZXJFbCA9IHRoaXMuZW5kRWwuZmlyc3QoKTsKICAgICAgICB0aGlzLmZvY3VzRWwgPSB0aGlzLmlubmVyRWwuY2hpbGQoJy54LXNsaWRlci1mb2N1cycpOwoKICAgICAgICAKICAgICAgICBmb3IgKHZhciBpPTA7IGkgPCB0aGlzLnRodW1icy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0aGlzLnRodW1ic1tpXS5yZW5kZXIoKTsKICAgICAgICB9CgogICAgICAgIAogICAgICAgIHZhciB0aHVtYiAgICAgID0gdGhpcy5pbm5lckVsLmNoaWxkKCcueC1zbGlkZXItdGh1bWInKTsKICAgICAgICB0aGlzLmhhbGZUaHVtYiA9ICh0aGlzLnZlcnRpY2FsID8gdGh1bWIuZ2V0SGVpZ2h0KCkgOiB0aHVtYi5nZXRXaWR0aCgpKSAvIDI7CgogICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgfSwKCiAgICAKICAgIGluaXRFdmVudHMgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMubW9uKHRoaXMuZWwsIHsKICAgICAgICAgICAgc2NvcGUgICAgOiB0aGlzLAogICAgICAgICAgICBtb3VzZWRvd246IHRoaXMub25Nb3VzZURvd24sCiAgICAgICAgICAgIGtleWRvd24gIDogdGhpcy5vbktleURvd24KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5mb2N1c0VsLnN3YWxsb3dFdmVudCgiY2xpY2siLCB0cnVlKTsKICAgIH0sCgogICAgCiAgICBvbk1vdXNlRG93biA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKHRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICB2YXIgdGh1bWJDbGlja2VkID0gZmFsc2U7CiAgICAgICAgZm9yICh2YXIgaT0wOyBpIDwgdGhpcy50aHVtYnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdGh1bWJDbGlja2VkID0gdGh1bWJDbGlja2VkIHx8IGUudGFyZ2V0ID09IHRoaXMudGh1bWJzW2ldLmVsLmRvbTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNsaWNrVG9DaGFuZ2UgJiYgIXRodW1iQ2xpY2tlZCkgewogICAgICAgICAgICB2YXIgbG9jYWwgPSB0aGlzLmlubmVyRWwudHJhbnNsYXRlUG9pbnRzKGUuZ2V0WFkoKSk7CiAgICAgICAgICAgIHRoaXMub25DbGlja0NoYW5nZShsb2NhbCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZm9jdXMoKTsKICAgIH0sCgogICAgCiAgICBvbkNsaWNrQ2hhbmdlIDogZnVuY3Rpb24obG9jYWwpIHsKICAgICAgICBpZiAobG9jYWwudG9wID4gdGhpcy5jbGlja1JhbmdlWzBdICYmIGxvY2FsLnRvcCA8IHRoaXMuY2xpY2tSYW5nZVsxXSkgewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHRodW1iID0gdGhpcy5nZXROZWFyZXN0KGxvY2FsLCAnbGVmdCcpLAogICAgICAgICAgICAgICAgaW5kZXggPSB0aHVtYi5pbmRleDsKCiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUoaW5kZXgsIEV4dC51dGlsLkZvcm1hdC5yb3VuZCh0aGlzLnJldmVyc2VWYWx1ZShsb2NhbC5sZWZ0KSwgdGhpcy5kZWNpbWFsUHJlY2lzaW9uKSwgdW5kZWZpbmVkLCB0cnVlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0TmVhcmVzdDogZnVuY3Rpb24obG9jYWwsIHByb3ApIHsKICAgICAgICB2YXIgbG9jYWxWYWx1ZSA9IHByb3AgPT0gJ3RvcCcgPyB0aGlzLmlubmVyRWwuZ2V0SGVpZ2h0KCkgLSBsb2NhbFtwcm9wXSA6IGxvY2FsW3Byb3BdLAogICAgICAgICAgICBjbGlja1ZhbHVlID0gdGhpcy5yZXZlcnNlVmFsdWUobG9jYWxWYWx1ZSksCiAgICAgICAgICAgIG5lYXJlc3REaXN0YW5jZSA9ICh0aGlzLm1heFZhbHVlIC0gdGhpcy5taW5WYWx1ZSkgKyA1LCAKICAgICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgICBuZWFyZXN0ID0gbnVsbDsKCiAgICAgICAgZm9yICh2YXIgaT0wOyBpIDwgdGhpcy50aHVtYnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHRodW1iID0gdGhpcy50aHVtYnNbaV0sCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRodW1iLnZhbHVlLAogICAgICAgICAgICAgICAgZGlzdCAgPSBNYXRoLmFicyh2YWx1ZSAtIGNsaWNrVmFsdWUpOwoKICAgICAgICAgICAgaWYgKE1hdGguYWJzKGRpc3QgPD0gbmVhcmVzdERpc3RhbmNlKSkgewogICAgICAgICAgICAgICAgbmVhcmVzdCA9IHRodW1iOwogICAgICAgICAgICAgICAgaW5kZXggPSBpOwogICAgICAgICAgICAgICAgbmVhcmVzdERpc3RhbmNlID0gZGlzdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmVhcmVzdDsKICAgIH0sCgogICAgCiAgICBvbktleURvd24gOiBmdW5jdGlvbihlKXsKICAgICAgICAKICAgICAgICBpZih0aGlzLmRpc2FibGVkIHx8IHRoaXMudGh1bWJzLmxlbmd0aCAhPT0gMSl7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgayA9IGUuZ2V0S2V5KCksCiAgICAgICAgICAgIHZhbDsKICAgICAgICBzd2l0Y2goayl7CiAgICAgICAgICAgIGNhc2UgZS5VUDoKICAgICAgICAgICAgY2FzZSBlLlJJR0hUOgogICAgICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgICAgIHZhbCA9IGUuY3RybEtleSA/IHRoaXMubWF4VmFsdWUgOiB0aGlzLmdldFZhbHVlKDApICsgdGhpcy5rZXlJbmNyZW1lbnQ7CiAgICAgICAgICAgICAgICB0aGlzLnNldFZhbHVlKDAsIHZhbCwgdW5kZWZpbmVkLCB0cnVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgZS5ET1dOOgogICAgICAgICAgICBjYXNlIGUuTEVGVDoKICAgICAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgICAgICB2YWwgPSBlLmN0cmxLZXkgPyB0aGlzLm1pblZhbHVlIDogdGhpcy5nZXRWYWx1ZSgwKSAtIHRoaXMua2V5SW5jcmVtZW50OwogICAgICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZSgwLCB2YWwsIHVuZGVmaW5lZCwgdHJ1ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBkb1NuYXAgOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgaWYgKCEodGhpcy5pbmNyZW1lbnQgJiYgdmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIG5ld1ZhbHVlID0gdmFsdWUsCiAgICAgICAgICAgIGluYyA9IHRoaXMuaW5jcmVtZW50LAogICAgICAgICAgICBtID0gdmFsdWUgJSBpbmM7CiAgICAgICAgaWYgKG0gIT0gMCkgewogICAgICAgICAgICBuZXdWYWx1ZSAtPSBtOwogICAgICAgICAgICBpZiAobSAqIDIgPj0gaW5jKSB7CiAgICAgICAgICAgICAgICBuZXdWYWx1ZSArPSBpbmM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobSAqIDIgPCAtaW5jKSB7CiAgICAgICAgICAgICAgICBuZXdWYWx1ZSAtPSBpbmM7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1ZhbHVlLmNvbnN0cmFpbih0aGlzLm1pblZhbHVlLCAgdGhpcy5tYXhWYWx1ZSk7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJSZW5kZXIgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5zbGlkZXIuTXVsdGlTbGlkZXIuc3VwZXJjbGFzcy5hZnRlclJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICBmb3IgKHZhciBpPTA7IGkgPCB0aGlzLnRodW1icy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgdGh1bWIgPSB0aGlzLnRodW1ic1tpXTsKCiAgICAgICAgICAgIGlmICh0aHVtYi52YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB2YXIgdiA9IHRoaXMubm9ybWFsaXplVmFsdWUodGh1bWIudmFsdWUpOwoKICAgICAgICAgICAgICAgIGlmICh2ICE9PSB0aHVtYi52YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUoaSwgdiwgZmFsc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdmVUaHVtYihpLCB0aGlzLnRyYW5zbGF0ZVZhbHVlKHYpLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSwKCiAgICAKICAgIGdldFJhdGlvIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdyA9IHRoaXMuaW5uZXJFbC5nZXRXaWR0aCgpLAogICAgICAgICAgICB2ID0gdGhpcy5tYXhWYWx1ZSAtIHRoaXMubWluVmFsdWU7CiAgICAgICAgcmV0dXJuIHYgPT0gMCA/IHcgOiAody92KTsKICAgIH0sCgogICAgCiAgICBub3JtYWxpemVWYWx1ZSA6IGZ1bmN0aW9uKHYpewogICAgICAgIHYgPSB0aGlzLmRvU25hcCh2KTsKICAgICAgICB2ID0gRXh0LnV0aWwuRm9ybWF0LnJvdW5kKHYsIHRoaXMuZGVjaW1hbFByZWNpc2lvbik7CiAgICAgICAgdiA9IHYuY29uc3RyYWluKHRoaXMubWluVmFsdWUsIHRoaXMubWF4VmFsdWUpOwogICAgICAgIHJldHVybiB2OwogICAgfSwKCiAgICAKICAgIHNldE1pblZhbHVlIDogZnVuY3Rpb24odmFsKXsKICAgICAgICB0aGlzLm1pblZhbHVlID0gdmFsOwogICAgICAgIHZhciBpID0gMCwKICAgICAgICAgICAgdGh1bWJzID0gdGhpcy50aHVtYnMsCiAgICAgICAgICAgIGxlbiA9IHRodW1icy5sZW5ndGgsCiAgICAgICAgICAgIHQ7CiAgICAgICAgICAgIAogICAgICAgIGZvcig7IGkgPCBsZW47ICsraSl7CiAgICAgICAgICAgIHQgPSB0aHVtYnNbaV07CiAgICAgICAgICAgIHQudmFsdWUgPSB0LnZhbHVlIDwgdmFsID8gdmFsIDogdC52YWx1ZTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zeW5jVGh1bWIoKTsKICAgIH0sCgogICAgCiAgICBzZXRNYXhWYWx1ZSA6IGZ1bmN0aW9uKHZhbCl7CiAgICAgICAgdGhpcy5tYXhWYWx1ZSA9IHZhbDsKICAgICAgICB2YXIgaSA9IDAsCiAgICAgICAgICAgIHRodW1icyA9IHRoaXMudGh1bWJzLAogICAgICAgICAgICBsZW4gPSB0aHVtYnMubGVuZ3RoLAogICAgICAgICAgICB0OwogICAgICAgICAgICAKICAgICAgICBmb3IoOyBpIDwgbGVuOyArK2kpewogICAgICAgICAgICB0ID0gdGh1bWJzW2ldOwogICAgICAgICAgICB0LnZhbHVlID0gdC52YWx1ZSA+IHZhbCA/IHZhbCA6IHQudmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3luY1RodW1iKCk7CiAgICB9LAoKICAgIAogICAgc2V0VmFsdWUgOiBmdW5jdGlvbihpbmRleCwgdiwgYW5pbWF0ZSwgY2hhbmdlQ29tcGxldGUpIHsKICAgICAgICB2YXIgdGh1bWIgPSB0aGlzLnRodW1ic1tpbmRleF0sCiAgICAgICAgICAgIGVsICAgID0gdGh1bWIuZWw7CgogICAgICAgIHYgPSB0aGlzLm5vcm1hbGl6ZVZhbHVlKHYpOwoKICAgICAgICBpZiAodiAhPT0gdGh1bWIudmFsdWUgJiYgdGhpcy5maXJlRXZlbnQoJ2JlZm9yZWNoYW5nZScsIHRoaXMsIHYsIHRodW1iLnZhbHVlLCB0aHVtYikgIT09IGZhbHNlKSB7CiAgICAgICAgICAgIHRodW1iLnZhbHVlID0gdjsKICAgICAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgICAgICB0aGlzLm1vdmVUaHVtYihpbmRleCwgdGhpcy50cmFuc2xhdGVWYWx1ZSh2KSwgYW5pbWF0ZSAhPT0gZmFsc2UpOwogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2NoYW5nZScsIHRoaXMsIHYsIHRodW1iKTsKICAgICAgICAgICAgICAgIGlmKGNoYW5nZUNvbXBsZXRlKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnY2hhbmdlY29tcGxldGUnLCB0aGlzLCB2LCB0aHVtYik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdHJhbnNsYXRlVmFsdWUgOiBmdW5jdGlvbih2KSB7CiAgICAgICAgdmFyIHJhdGlvID0gdGhpcy5nZXRSYXRpbygpOwogICAgICAgIHJldHVybiAodiAqIHJhdGlvKSAtICh0aGlzLm1pblZhbHVlICogcmF0aW8pIC0gdGhpcy5oYWxmVGh1bWI7CiAgICB9LAoKICAgIAogICAgcmV2ZXJzZVZhbHVlIDogZnVuY3Rpb24ocG9zKXsKICAgICAgICB2YXIgcmF0aW8gPSB0aGlzLmdldFJhdGlvKCk7CiAgICAgICAgcmV0dXJuIChwb3MgKyAodGhpcy5taW5WYWx1ZSAqIHJhdGlvKSkgLyByYXRpbzsKICAgIH0sCgogICAgCiAgICBtb3ZlVGh1bWI6IGZ1bmN0aW9uKGluZGV4LCB2LCBhbmltYXRlKXsKICAgICAgICB2YXIgdGh1bWIgPSB0aGlzLnRodW1ic1tpbmRleF0uZWw7CgogICAgICAgIGlmKCFhbmltYXRlIHx8IHRoaXMuYW5pbWF0ZSA9PT0gZmFsc2UpewogICAgICAgICAgICB0aHVtYi5zZXRMZWZ0KHYpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aHVtYi5zaGlmdCh7bGVmdDogdiwgc3RvcEZ4OiB0cnVlLCBkdXJhdGlvbjouMzV9KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZm9jdXMgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZm9jdXNFbC5mb2N1cygxMCk7CiAgICB9LAoKICAgIAogICAgb25SZXNpemUgOiBmdW5jdGlvbih3LCBoKXsKICAgICAgICB2YXIgdGh1bWJzID0gdGhpcy50aHVtYnMsCiAgICAgICAgICAgIGxlbiA9IHRodW1icy5sZW5ndGgsCiAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAKICAgICAgICAKICAgICAgICBmb3IoOyBpIDwgbGVuOyArK2kpewogICAgICAgICAgICB0aHVtYnNbaV0uZWwuc3RvcEZ4KCk7ICAgIAogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZihFeHQuaXNOdW1iZXIodykpewogICAgICAgICAgICB0aGlzLmlubmVyRWwuc2V0V2lkdGgodyAtICh0aGlzLmVsLmdldFBhZGRpbmcoJ2wnKSArIHRoaXMuZW5kRWwuZ2V0UGFkZGluZygncicpKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3luY1RodW1iKCk7CiAgICAgICAgRXh0LnNsaWRlci5NdWx0aVNsaWRlci5zdXBlcmNsYXNzLm9uUmVzaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIAogICAgb25EaXNhYmxlOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5zbGlkZXIuTXVsdGlTbGlkZXIuc3VwZXJjbGFzcy5vbkRpc2FibGUuY2FsbCh0aGlzKTsKCiAgICAgICAgZm9yICh2YXIgaT0wOyBpIDwgdGhpcy50aHVtYnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHRodW1iID0gdGhpcy50aHVtYnNbaV0sCiAgICAgICAgICAgICAgICBlbCAgICA9IHRodW1iLmVsOwoKICAgICAgICAgICAgdGh1bWIuZGlzYWJsZSgpOwoKICAgICAgICAgICAgaWYoRXh0LmlzSUUpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciB4eSA9IGVsLmdldFhZKCk7CiAgICAgICAgICAgICAgICBlbC5oaWRlKCk7CgogICAgICAgICAgICAgICAgdGhpcy5pbm5lckVsLmFkZENsYXNzKHRoaXMuZGlzYWJsZWRDbGFzcykuZG9tLmRpc2FibGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBpZiAoIXRoaXMudGh1bWJIb2xkZXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRodW1iSG9sZGVyID0gdGhpcy5lbmRFbC5jcmVhdGVDaGlsZCh7Y2xzOiAneC1zbGlkZXItdGh1bWIgJyArIHRoaXMuZGlzYWJsZWRDbGFzc30pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMudGh1bWJIb2xkZXIuc2hvdygpLnNldFhZKHh5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkVuYWJsZTogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuc2xpZGVyLk11bHRpU2xpZGVyLnN1cGVyY2xhc3Mub25FbmFibGUuY2FsbCh0aGlzKTsKCiAgICAgICAgZm9yICh2YXIgaT0wOyBpIDwgdGhpcy50aHVtYnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIHRodW1iID0gdGhpcy50aHVtYnNbaV0sCiAgICAgICAgICAgICAgICBlbCAgICA9IHRodW1iLmVsOwoKICAgICAgICAgICAgdGh1bWIuZW5hYmxlKCk7CgogICAgICAgICAgICBpZiAoRXh0LmlzSUUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5uZXJFbC5yZW1vdmVDbGFzcyh0aGlzLmRpc2FibGVkQ2xhc3MpLmRvbS5kaXNhYmxlZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRodW1iSG9sZGVyKSB0aGlzLnRodW1iSG9sZGVyLmhpZGUoKTsKCiAgICAgICAgICAgICAgICBlbC5zaG93KCk7CiAgICAgICAgICAgICAgICB0aGlzLnN5bmNUaHVtYigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHN5bmNUaHVtYiA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnJlbmRlcmVkKSB7CiAgICAgICAgICAgIGZvciAodmFyIGk9MDsgaSA8IHRoaXMudGh1bWJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLm1vdmVUaHVtYihpLCB0aGlzLnRyYW5zbGF0ZVZhbHVlKHRoaXMudGh1bWJzW2ldLnZhbHVlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0VmFsdWUgOiBmdW5jdGlvbihpbmRleCkgewogICAgICAgIHJldHVybiB0aGlzLnRodW1ic1tpbmRleF0udmFsdWU7CiAgICB9LAoKICAgIAogICAgZ2V0VmFsdWVzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdmFsdWVzID0gW107CgogICAgICAgIGZvciAodmFyIGk9MDsgaSA8IHRoaXMudGh1bWJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhbHVlcy5wdXNoKHRoaXMudGh1bWJzW2ldLnZhbHVlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9LAoKICAgIAogICAgYmVmb3JlRGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHRodW1icyA9IHRoaXMudGh1bWJzOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IHRodW1icy5sZW5ndGg7IGkgPCBsZW47ICsraSl7CiAgICAgICAgICAgIHRodW1ic1tpXS5kZXN0cm95KCk7CiAgICAgICAgICAgIHRodW1ic1tpXSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIEV4dC5kZXN0cm95TWVtYmVycyh0aGlzLCAnZW5kRWwnLCAnaW5uZXJFbCcsICdmb2N1c0VsJywgJ3RodW1iSG9sZGVyJyk7CiAgICAgICAgRXh0LnNsaWRlci5NdWx0aVNsaWRlci5zdXBlcmNsYXNzLmJlZm9yZURlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0KfSk7CgpFeHQucmVnKCdtdWx0aXNsaWRlcicsIEV4dC5zbGlkZXIuTXVsdGlTbGlkZXIpOwoKCkV4dC5zbGlkZXIuU2luZ2xlU2xpZGVyID0gRXh0LmV4dGVuZChFeHQuc2xpZGVyLk11bHRpU2xpZGVyLCB7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTsKCiAgICAgIEV4dC5hcHBseUlmKGNvbmZpZywgewogICAgICAgICAgdmFsdWVzOiBbY29uZmlnLnZhbHVlIHx8IDBdCiAgICAgIH0pOwoKICAgICAgRXh0LnNsaWRlci5TaW5nbGVTbGlkZXIuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGNvbmZpZyk7CiAgICB9LAoKICAgIAogICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgIAogICAgICAgIHJldHVybiBFeHQuc2xpZGVyLlNpbmdsZVNsaWRlci5zdXBlcmNsYXNzLmdldFZhbHVlLmNhbGwodGhpcywgMCk7CiAgICB9LAoKICAgIAogICAgc2V0VmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBhbmltYXRlKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBFeHQudG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICBsZW4gID0gYXJncy5sZW5ndGg7CgogICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgIGlmIChsZW4gPT0gMSB8fCAobGVuIDw9IDMgJiYgdHlwZW9mIGFyZ3VtZW50c1sxXSAhPSAnbnVtYmVyJykpIHsKICAgICAgICAgICAgYXJncy51bnNoaWZ0KDApOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIEV4dC5zbGlkZXIuU2luZ2xlU2xpZGVyLnN1cGVyY2xhc3Muc2V0VmFsdWUuYXBwbHkodGhpcywgYXJncyk7CiAgICB9LAoKICAgIAogICAgc3luY1RodW1iIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIEV4dC5zbGlkZXIuU2luZ2xlU2xpZGVyLnN1cGVyY2xhc3Muc3luY1RodW1iLmFwcGx5KHRoaXMsIFswXS5jb25jYXQoYXJndW1lbnRzKSk7CiAgICB9LAogICAgCiAgICAKICAgIGdldE5lYXJlc3QgOiBmdW5jdGlvbigpewogICAgICAgIAogICAgICAgIHJldHVybiB0aGlzLnRodW1ic1swXTsgICAgCiAgICB9Cn0pOwoKCkV4dC5TbGlkZXIgPSBFeHQuc2xpZGVyLlNpbmdsZVNsaWRlcjsKCkV4dC5yZWcoJ3NsaWRlcicsIEV4dC5zbGlkZXIuU2luZ2xlU2xpZGVyKTsKCgpFeHQuc2xpZGVyLlZlcnRpY2FsID0gewogICAgb25SZXNpemUgOiBmdW5jdGlvbih3LCBoKXsKICAgICAgICB0aGlzLmlubmVyRWwuc2V0SGVpZ2h0KGggLSAodGhpcy5lbC5nZXRQYWRkaW5nKCd0JykgKyB0aGlzLmVuZEVsLmdldFBhZGRpbmcoJ2InKSkpOwogICAgICAgIHRoaXMuc3luY1RodW1iKCk7CiAgICB9LAoKICAgIGdldFJhdGlvIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgaCA9IHRoaXMuaW5uZXJFbC5nZXRIZWlnaHQoKSwKICAgICAgICAgICAgdiA9IHRoaXMubWF4VmFsdWUgLSB0aGlzLm1pblZhbHVlOwogICAgICAgIHJldHVybiBoL3Y7CiAgICB9LAoKICAgIG1vdmVUaHVtYjogZnVuY3Rpb24oaW5kZXgsIHYsIGFuaW1hdGUpIHsKICAgICAgICB2YXIgdGh1bWIgPSB0aGlzLnRodW1ic1tpbmRleF0sCiAgICAgICAgICAgIGVsICAgID0gdGh1bWIuZWw7CgogICAgICAgIGlmICghYW5pbWF0ZSB8fCB0aGlzLmFuaW1hdGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGVsLnNldEJvdHRvbSh2KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbC5zaGlmdCh7Ym90dG9tOiB2LCBzdG9wRng6IHRydWUsIGR1cmF0aW9uOi4zNX0pOwogICAgICAgIH0KICAgIH0sCgogICAgb25DbGlja0NoYW5nZSA6IGZ1bmN0aW9uKGxvY2FsKSB7CiAgICAgICAgaWYgKGxvY2FsLmxlZnQgPiB0aGlzLmNsaWNrUmFuZ2VbMF0gJiYgbG9jYWwubGVmdCA8IHRoaXMuY2xpY2tSYW5nZVsxXSkgewogICAgICAgICAgICB2YXIgdGh1bWIgPSB0aGlzLmdldE5lYXJlc3QobG9jYWwsICd0b3AnKSwKICAgICAgICAgICAgICAgIGluZGV4ID0gdGh1bWIuaW5kZXgsCiAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMubWluVmFsdWUgKyB0aGlzLnJldmVyc2VWYWx1ZSh0aGlzLmlubmVyRWwuZ2V0SGVpZ2h0KCkgLSBsb2NhbC50b3ApOwoKICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZShpbmRleCwgRXh0LnV0aWwuRm9ybWF0LnJvdW5kKHZhbHVlLCB0aGlzLmRlY2ltYWxQcmVjaXNpb24pLCB1bmRlZmluZWQsIHRydWUpOwogICAgICAgIH0KICAgIH0KfTsKCgpFeHQuc2xpZGVyLlRodW1iLlZlcnRpY2FsID0gewogICAgZ2V0TmV3VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzbGlkZXIgICA9IHRoaXMuc2xpZGVyLAogICAgICAgICAgICBpbm5lckVsICA9IHNsaWRlci5pbm5lckVsLAogICAgICAgICAgICBwb3MgICAgICA9IGlubmVyRWwudHJhbnNsYXRlUG9pbnRzKHRoaXMudHJhY2tlci5nZXRYWSgpKSwKICAgICAgICAgICAgYm90dG9tICAgPSBpbm5lckVsLmdldEhlaWdodCgpIC0gcG9zLnRvcDsKCiAgICAgICAgcmV0dXJuIHNsaWRlci5taW5WYWx1ZSArIEV4dC51dGlsLkZvcm1hdC5yb3VuZChib3R0b20gLyBzbGlkZXIuZ2V0UmF0aW8oKSwgc2xpZGVyLmRlY2ltYWxQcmVjaXNpb24pOwogICAgfQp9OwoKRXh0LlByb2dyZXNzQmFyID0gRXh0LmV4dGVuZChFeHQuQm94Q29tcG9uZW50LCB7CiAgIAogICAgYmFzZUNscyA6ICd4LXByb2dyZXNzJywKICAgIAogICAgCiAgICBhbmltYXRlIDogZmFsc2UsCgogICAgCiAgICB3YWl0VGltZXIgOiBudWxsLAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LlByb2dyZXNzQmFyLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgInVwZGF0ZSIKICAgICAgICApOwogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKXsKICAgICAgICB2YXIgdHBsID0gbmV3IEV4dC5UZW1wbGF0ZSgKICAgICAgICAgICAgJzxkaXYgY2xhc3M9IntjbHN9LXdyYXAiPicsCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ie2Nsc30taW5uZXIiPicsCiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9IntjbHN9LWJhciI+JywKICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9IntjbHN9LXRleHQiPicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdj4mIzE2MDs8L2Rpdj4nLAogICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JywKICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JywKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ie2Nsc30tdGV4dCB7Y2xzfS10ZXh0LWJhY2siPicsCiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2PiYjMTYwOzwvZGl2PicsCiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicsCiAgICAgICAgICAgICAgICAnPC9kaXY+JywKICAgICAgICAgICAgJzwvZGl2PicKICAgICAgICApOwoKICAgICAgICB0aGlzLmVsID0gcG9zaXRpb24gPyB0cGwuaW5zZXJ0QmVmb3JlKHBvc2l0aW9uLCB7Y2xzOiB0aGlzLmJhc2VDbHN9LCB0cnVlKQogICAgICAgICAgICA6IHRwbC5hcHBlbmQoY3QsIHtjbHM6IHRoaXMuYmFzZUNsc30sIHRydWUpOwogICAgICAgICAgICAgICAgCiAgICAgICAgaWYodGhpcy5pZCl7CiAgICAgICAgICAgIHRoaXMuZWwuZG9tLmlkID0gdGhpcy5pZDsKICAgICAgICB9CiAgICAgICAgdmFyIGlubmVyID0gdGhpcy5lbC5kb20uZmlyc3RDaGlsZDsKICAgICAgICB0aGlzLnByb2dyZXNzQmFyID0gRXh0LmdldChpbm5lci5maXJzdENoaWxkKTsKCiAgICAgICAgaWYodGhpcy50ZXh0RWwpewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy50ZXh0RWwgPSBFeHQuZ2V0KHRoaXMudGV4dEVsKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMudGV4dFRvcEVsOwogICAgICAgIH1lbHNlewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy50ZXh0VG9wRWwgPSBFeHQuZ2V0KHRoaXMucHJvZ3Jlc3NCYXIuZG9tLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICB2YXIgdGV4dEJhY2tFbCA9IEV4dC5nZXQoaW5uZXIuY2hpbGROb2Rlc1sxXSk7CiAgICAgICAgICAgIHRoaXMudGV4dFRvcEVsLnNldFN0eWxlKCJ6LWluZGV4IiwgOTkpLmFkZENsYXNzKCd4LWhpZGRlbicpOwogICAgICAgICAgICB0aGlzLnRleHRFbCA9IG5ldyBFeHQuQ29tcG9zaXRlRWxlbWVudChbdGhpcy50ZXh0VG9wRWwuZG9tLmZpcnN0Q2hpbGQsIHRleHRCYWNrRWwuZG9tLmZpcnN0Q2hpbGRdKTsKICAgICAgICAgICAgdGhpcy50ZXh0RWwuc2V0V2lkdGgoaW5uZXIub2Zmc2V0V2lkdGgpOwogICAgICAgIH0KICAgICAgICB0aGlzLnByb2dyZXNzQmFyLnNldEhlaWdodChpbm5lci5vZmZzZXRIZWlnaHQpOwogICAgfSwKICAgIAogICAgCiAgICBhZnRlclJlbmRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LlByb2dyZXNzQmFyLnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLnZhbHVlKXsKICAgICAgICAgICAgdGhpcy51cGRhdGVQcm9ncmVzcyh0aGlzLnZhbHVlLCB0aGlzLnRleHQpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLnVwZGF0ZVRleHQodGhpcy50ZXh0KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdXBkYXRlUHJvZ3Jlc3MgOiBmdW5jdGlvbih2YWx1ZSwgdGV4dCwgYW5pbWF0ZSl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlIHx8IDA7CiAgICAgICAgaWYodGV4dCl7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVGV4dCh0ZXh0KTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCAmJiAhdGhpcy5pc0Rlc3Ryb3llZCl7CiAgICAgICAgICAgIHZhciB3ID0gTWF0aC5mbG9vcih2YWx1ZSp0aGlzLmVsLmRvbS5maXJzdENoaWxkLm9mZnNldFdpZHRoKTsKICAgICAgICAgICAgdGhpcy5wcm9ncmVzc0Jhci5zZXRXaWR0aCh3LCBhbmltYXRlID09PSB0cnVlIHx8IChhbmltYXRlICE9PSBmYWxzZSAmJiB0aGlzLmFuaW1hdGUpKTsKICAgICAgICAgICAgaWYodGhpcy50ZXh0VG9wRWwpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLnRleHRUb3BFbC5yZW1vdmVDbGFzcygneC1oaWRkZW4nKS5zZXRXaWR0aCh3KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgndXBkYXRlJywgdGhpcywgdmFsdWUsIHRleHQpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHdhaXQgOiBmdW5jdGlvbihvKXsKICAgICAgICBpZighdGhpcy53YWl0VGltZXIpewogICAgICAgICAgICB2YXIgc2NvcGUgPSB0aGlzOwogICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgdGhpcy51cGRhdGVUZXh0KG8udGV4dCk7CiAgICAgICAgICAgIHRoaXMud2FpdFRpbWVyID0gRXh0LlRhc2tNZ3Iuc3RhcnQoewogICAgICAgICAgICAgICAgcnVuOiBmdW5jdGlvbihpKXsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5jID0gby5pbmNyZW1lbnQgfHwgMTA7CiAgICAgICAgICAgICAgICAgICAgaSAtPSAxOwogICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUHJvZ3Jlc3MoKCgoKGkraW5jKSVpbmMpKzEpKigxMDAvaW5jKSkqMC4wMSwgbnVsbCwgby5hbmltYXRlKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnRlcnZhbDogby5pbnRlcnZhbCB8fCAxMDAwLAogICAgICAgICAgICAgICAgZHVyYXRpb246IG8uZHVyYXRpb24sCiAgICAgICAgICAgICAgICBvblN0b3A6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYoby5mbil7CiAgICAgICAgICAgICAgICAgICAgICAgIG8uZm4uYXBwbHkoby5zY29wZSB8fCB0aGlzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldCgpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNjb3BlOiBzY29wZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgaXNXYWl0aW5nIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy53YWl0VGltZXIgIT09IG51bGw7CiAgICB9LAoKICAgIAogICAgdXBkYXRlVGV4dCA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgIHRoaXMudGV4dCA9IHRleHQgfHwgJyYjMTYwOyc7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMudGV4dEVsLnVwZGF0ZSh0aGlzLnRleHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAKICAgIAogICAgc3luY1Byb2dyZXNzQmFyIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnZhbHVlKXsKICAgICAgICAgICAgdGhpcy51cGRhdGVQcm9ncmVzcyh0aGlzLnZhbHVlLCB0aGlzLnRleHQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBzZXRTaXplIDogZnVuY3Rpb24odywgaCl7CiAgICAgICAgRXh0LlByb2dyZXNzQmFyLnN1cGVyY2xhc3Muc2V0U2l6ZS5jYWxsKHRoaXMsIHcsIGgpOwogICAgICAgIGlmKHRoaXMudGV4dFRvcEVsKXsKICAgICAgICAgICAgdmFyIGlubmVyID0gdGhpcy5lbC5kb20uZmlyc3RDaGlsZDsKICAgICAgICAgICAgdGhpcy50ZXh0RWwuc2V0U2l6ZShpbm5lci5vZmZzZXRXaWR0aCwgaW5uZXIub2Zmc2V0SGVpZ2h0KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zeW5jUHJvZ3Jlc3NCYXIoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICByZXNldCA6IGZ1bmN0aW9uKGhpZGUpewogICAgICAgIHRoaXMudXBkYXRlUHJvZ3Jlc3MoMCk7CiAgICAgICAgaWYodGhpcy50ZXh0VG9wRWwpewogICAgICAgICAgICB0aGlzLnRleHRUb3BFbC5hZGRDbGFzcygneC1oaWRkZW4nKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jbGVhclRpbWVyKCk7CiAgICAgICAgaWYoaGlkZSA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICAKICAgIAogICAgY2xlYXJUaW1lciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy53YWl0VGltZXIpewogICAgICAgICAgICB0aGlzLndhaXRUaW1lci5vblN0b3AgPSBudWxsOyAKICAgICAgICAgICAgRXh0LlRhc2tNZ3Iuc3RvcCh0aGlzLndhaXRUaW1lcik7CiAgICAgICAgICAgIHRoaXMud2FpdFRpbWVyID0gbnVsbDsKICAgICAgICB9CiAgICB9LAogICAgCiAgICBvbkRlc3Ryb3k6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5jbGVhclRpbWVyKCk7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIGlmKHRoaXMudGV4dEVsLmlzQ29tcG9zaXRlKXsKICAgICAgICAgICAgICAgIHRoaXMudGV4dEVsLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXh0LmRlc3Ryb3lNZW1iZXJzKHRoaXMsICd0ZXh0RWwnLCAncHJvZ3Jlc3NCYXInLCAndGV4dFRvcEVsJyk7CiAgICAgICAgfQogICAgICAgIEV4dC5Qcm9ncmVzc0Jhci5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgfQp9KTsKRXh0LnJlZygncHJvZ3Jlc3MnLCBFeHQuUHJvZ3Jlc3NCYXIpOwoKKGZ1bmN0aW9uKCkgewoKdmFyIEV2ZW50PUV4dC5FdmVudE1hbmFnZXI7CnZhciBEb209RXh0LmxpYi5Eb207CgoKRXh0LmRkLkRyYWdEcm9wID0gZnVuY3Rpb24oaWQsIHNHcm91cCwgY29uZmlnKSB7CiAgICBpZihpZCkgewogICAgICAgIHRoaXMuaW5pdChpZCwgc0dyb3VwLCBjb25maWcpOwogICAgfQp9OwoKRXh0LmRkLkRyYWdEcm9wLnByb3RvdHlwZSA9IHsKCiAgICAKCiAgICAKICAgIGlkOiBudWxsLAoKICAgIAogICAgY29uZmlnOiBudWxsLAoKICAgIAogICAgZHJhZ0VsSWQ6IG51bGwsCgogICAgCiAgICBoYW5kbGVFbElkOiBudWxsLAoKICAgIAogICAgaW52YWxpZEhhbmRsZVR5cGVzOiBudWxsLAoKICAgIAogICAgaW52YWxpZEhhbmRsZUlkczogbnVsbCwKCiAgICAKICAgIGludmFsaWRIYW5kbGVDbGFzc2VzOiBudWxsLAoKICAgIAogICAgc3RhcnRQYWdlWDogMCwKCiAgICAKICAgIHN0YXJ0UGFnZVk6IDAsCgogICAgCiAgICBncm91cHM6IG51bGwsCgogICAgCiAgICBsb2NrZWQ6IGZhbHNlLAoKICAgIAogICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sb2NrZWQgPSB0cnVlOwogICAgfSwKCiAgICAKICAgIG1vdmVPbmx5OiBmYWxzZSwKCiAgICAKICAgIHVubG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sb2NrZWQgPSBmYWxzZTsKICAgIH0sCgogICAgCiAgICBpc1RhcmdldDogdHJ1ZSwKCiAgICAKICAgIHBhZGRpbmc6IG51bGwsCgogICAgCiAgICBfZG9tUmVmOiBudWxsLAoKICAgIAogICAgX195Z0RyYWdEcm9wOiB0cnVlLAoKICAgIAogICAgY29uc3RyYWluWDogZmFsc2UsCgogICAgCiAgICBjb25zdHJhaW5ZOiBmYWxzZSwKCiAgICAKICAgIG1pblg6IDAsCgogICAgCiAgICBtYXhYOiAwLAoKICAgIAogICAgbWluWTogMCwKCiAgICAKICAgIG1heFk6IDAsCgogICAgCiAgICBtYWludGFpbk9mZnNldDogZmFsc2UsCgogICAgCiAgICB4VGlja3M6IG51bGwsCgogICAgCiAgICB5VGlja3M6IG51bGwsCgogICAgCiAgICBwcmltYXJ5QnV0dG9uT25seTogdHJ1ZSwKCiAgICAKICAgIGF2YWlsYWJsZTogZmFsc2UsCgogICAgCiAgICBoYXNPdXRlckhhbmRsZXM6IGZhbHNlLAoKICAgIAogICAgYjRTdGFydERyYWc6IGZ1bmN0aW9uKHgsIHkpIHsgfSwKCiAgICAKICAgIHN0YXJ0RHJhZzogZnVuY3Rpb24oeCwgeSkgeyAgfSwKCiAgICAKICAgIGI0RHJhZzogZnVuY3Rpb24oZSkgeyB9LAoKICAgIAogICAgb25EcmFnOiBmdW5jdGlvbihlKSB7ICB9LAoKICAgIAogICAgb25EcmFnRW50ZXI6IGZ1bmN0aW9uKGUsIGlkKSB7ICB9LAoKICAgIAogICAgYjREcmFnT3ZlcjogZnVuY3Rpb24oZSkgeyB9LAoKICAgIAogICAgb25EcmFnT3ZlcjogZnVuY3Rpb24oZSwgaWQpIHsgIH0sCgogICAgCiAgICBiNERyYWdPdXQ6IGZ1bmN0aW9uKGUpIHsgfSwKCiAgICAKICAgIG9uRHJhZ091dDogZnVuY3Rpb24oZSwgaWQpIHsgIH0sCgogICAgCiAgICBiNERyYWdEcm9wOiBmdW5jdGlvbihlKSB7IH0sCgogICAgCiAgICBvbkRyYWdEcm9wOiBmdW5jdGlvbihlLCBpZCkgeyAgfSwKCiAgICAKICAgIG9uSW52YWxpZERyb3A6IGZ1bmN0aW9uKGUpIHsgIH0sCgogICAgCiAgICBiNEVuZERyYWc6IGZ1bmN0aW9uKGUpIHsgfSwKCiAgICAKICAgIGVuZERyYWc6IGZ1bmN0aW9uKGUpIHsgIH0sCgogICAgCiAgICBiNE1vdXNlRG93bjogZnVuY3Rpb24oZSkgeyAgfSwKCiAgICAKICAgIG9uTW91c2VEb3duOiBmdW5jdGlvbihlKSB7ICB9LAoKICAgIAogICAgb25Nb3VzZVVwOiBmdW5jdGlvbihlKSB7ICB9LAoKICAgIAogICAgb25BdmFpbGFibGU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgCiAgICBkZWZhdWx0UGFkZGluZyA6IHtsZWZ0OjAsIHJpZ2h0OjAsIHRvcDowLCBib3R0b206MH0sCgogICAgCiAgICBjb25zdHJhaW5UbyA6IGZ1bmN0aW9uKGNvbnN0cmFpblRvLCBwYWQsIGluQ29udGVudCl7CiAgICAgICAgaWYoRXh0LmlzTnVtYmVyKHBhZCkpewogICAgICAgICAgICBwYWQgPSB7bGVmdDogcGFkLCByaWdodDpwYWQsIHRvcDpwYWQsIGJvdHRvbTpwYWR9OwogICAgICAgIH0KICAgICAgICBwYWQgPSBwYWQgfHwgdGhpcy5kZWZhdWx0UGFkZGluZzsKICAgICAgICB2YXIgYiA9IEV4dC5nZXQodGhpcy5nZXRFbCgpKS5nZXRCb3goKSwKICAgICAgICAgICAgY2UgPSBFeHQuZ2V0KGNvbnN0cmFpblRvKSwKICAgICAgICAgICAgcyA9IGNlLmdldFNjcm9sbCgpLAogICAgICAgICAgICBjLCAKICAgICAgICAgICAgY2QgPSBjZS5kb207CiAgICAgICAgaWYoY2QgPT0gZG9jdW1lbnQuYm9keSl7CiAgICAgICAgICAgIGMgPSB7IHg6IHMubGVmdCwgeTogcy50b3AsIHdpZHRoOiBFeHQubGliLkRvbS5nZXRWaWV3V2lkdGgoKSwgaGVpZ2h0OiBFeHQubGliLkRvbS5nZXRWaWV3SGVpZ2h0KCl9OwogICAgICAgIH1lbHNlewogICAgICAgICAgICB2YXIgeHkgPSBjZS5nZXRYWSgpOwogICAgICAgICAgICBjID0ge3ggOiB4eVswXSwgeTogeHlbMV0sIHdpZHRoOiBjZC5jbGllbnRXaWR0aCwgaGVpZ2h0OiBjZC5jbGllbnRIZWlnaHR9OwogICAgICAgIH0KCgogICAgICAgIHZhciB0b3BTcGFjZSA9IGIueSAtIGMueSwKICAgICAgICAgICAgbGVmdFNwYWNlID0gYi54IC0gYy54OwoKICAgICAgICB0aGlzLnJlc2V0Q29uc3RyYWludHMoKTsKICAgICAgICB0aGlzLnNldFhDb25zdHJhaW50KGxlZnRTcGFjZSAtIChwYWQubGVmdHx8MCksIAogICAgICAgICAgICAgICAgYy53aWR0aCAtIGxlZnRTcGFjZSAtIGIud2lkdGggLSAocGFkLnJpZ2h0fHwwKSwgCgkJCQl0aGlzLnhUaWNrU2l6ZQogICAgICAgICk7CiAgICAgICAgdGhpcy5zZXRZQ29uc3RyYWludCh0b3BTcGFjZSAtIChwYWQudG9wfHwwKSwgCiAgICAgICAgICAgICAgICBjLmhlaWdodCAtIHRvcFNwYWNlIC0gYi5oZWlnaHQgLSAocGFkLmJvdHRvbXx8MCksIAoJCQkJdGhpcy55VGlja1NpemUKICAgICAgICApOwogICAgfSwKCiAgICAKICAgIGdldEVsOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuX2RvbVJlZikgewogICAgICAgICAgICB0aGlzLl9kb21SZWYgPSBFeHQuZ2V0RG9tKHRoaXMuaWQpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX2RvbVJlZjsKICAgIH0sCgogICAgCiAgICBnZXREcmFnRWw6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBFeHQuZ2V0RG9tKHRoaXMuZHJhZ0VsSWQpOwogICAgfSwKCiAgICAKICAgIGluaXQ6IGZ1bmN0aW9uKGlkLCBzR3JvdXAsIGNvbmZpZykgewogICAgICAgIHRoaXMuaW5pdFRhcmdldChpZCwgc0dyb3VwLCBjb25maWcpOwogICAgICAgIEV2ZW50Lm9uKHRoaXMuaWQsICJtb3VzZWRvd24iLCB0aGlzLmhhbmRsZU1vdXNlRG93biwgdGhpcyk7CiAgICAgICAgCiAgICB9LAoKICAgIAogICAgaW5pdFRhcmdldDogZnVuY3Rpb24oaWQsIHNHcm91cCwgY29uZmlnKSB7CgogICAgICAgIAogICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnIHx8IHt9OwoKICAgICAgICAKICAgICAgICB0aGlzLkRETSA9IEV4dC5kZC5ERE07CiAgICAgICAgCiAgICAgICAgdGhpcy5ncm91cHMgPSB7fTsKCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgaWYgKHR5cGVvZiBpZCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWQgPSBFeHQuaWQoaWQpOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgdGhpcy5pZCA9IGlkOwoKICAgICAgICAKICAgICAgICB0aGlzLmFkZFRvR3JvdXAoKHNHcm91cCkgPyBzR3JvdXAgOiAiZGVmYXVsdCIpOwoKICAgICAgICAKICAgICAgICAKICAgICAgICB0aGlzLmhhbmRsZUVsSWQgPSBpZDsKCiAgICAgICAgCiAgICAgICAgdGhpcy5zZXREcmFnRWxJZChpZCk7CgogICAgICAgIAogICAgICAgIHRoaXMuaW52YWxpZEhhbmRsZVR5cGVzID0geyBBOiAiQSIgfTsKICAgICAgICB0aGlzLmludmFsaWRIYW5kbGVJZHMgPSB7fTsKICAgICAgICB0aGlzLmludmFsaWRIYW5kbGVDbGFzc2VzID0gW107CgogICAgICAgIHRoaXMuYXBwbHlDb25maWcoKTsKCiAgICAgICAgdGhpcy5oYW5kbGVPbkF2YWlsYWJsZSgpOwogICAgfSwKCiAgICAKICAgIGFwcGx5Q29uZmlnOiBmdW5jdGlvbigpIHsKCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdGhpcy5wYWRkaW5nICAgICAgICAgICA9IHRoaXMuY29uZmlnLnBhZGRpbmcgfHwgWzAsIDAsIDAsIDBdOwogICAgICAgIHRoaXMuaXNUYXJnZXQgICAgICAgICAgPSAodGhpcy5jb25maWcuaXNUYXJnZXQgIT09IGZhbHNlKTsKICAgICAgICB0aGlzLm1haW50YWluT2Zmc2V0ICAgID0gKHRoaXMuY29uZmlnLm1haW50YWluT2Zmc2V0KTsKICAgICAgICB0aGlzLnByaW1hcnlCdXR0b25Pbmx5ID0gKHRoaXMuY29uZmlnLnByaW1hcnlCdXR0b25Pbmx5ICE9PSBmYWxzZSk7CgogICAgfSwKCiAgICAKICAgIGhhbmRsZU9uQXZhaWxhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmF2YWlsYWJsZSA9IHRydWU7CiAgICAgICAgdGhpcy5yZXNldENvbnN0cmFpbnRzKCk7CiAgICAgICAgdGhpcy5vbkF2YWlsYWJsZSgpOwogICAgfSwKCiAgICAgCiAgICBzZXRQYWRkaW5nOiBmdW5jdGlvbihpVG9wLCBpUmlnaHQsIGlCb3QsIGlMZWZ0KSB7CiAgICAgICAgCiAgICAgICAgaWYgKCFpUmlnaHQgJiYgMCAhPT0gaVJpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMucGFkZGluZyA9IFtpVG9wLCBpVG9wLCBpVG9wLCBpVG9wXTsKICAgICAgICB9IGVsc2UgaWYgKCFpQm90ICYmIDAgIT09IGlCb3QpIHsKICAgICAgICAgICAgdGhpcy5wYWRkaW5nID0gW2lUb3AsIGlSaWdodCwgaVRvcCwgaVJpZ2h0XTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnBhZGRpbmcgPSBbaVRvcCwgaVJpZ2h0LCBpQm90LCBpTGVmdF07CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNldEluaXRQb3NpdGlvbjogZnVuY3Rpb24oZGlmZlgsIGRpZmZZKSB7CiAgICAgICAgdmFyIGVsID0gdGhpcy5nZXRFbCgpOwoKICAgICAgICBpZiAoIXRoaXMuRERNLnZlcmlmeUVsKGVsKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgZHggPSBkaWZmWCB8fCAwOwogICAgICAgIHZhciBkeSA9IGRpZmZZIHx8IDA7CgogICAgICAgIHZhciBwID0gRG9tLmdldFhZKCBlbCApOwoKICAgICAgICB0aGlzLmluaXRQYWdlWCA9IHBbMF0gLSBkeDsKICAgICAgICB0aGlzLmluaXRQYWdlWSA9IHBbMV0gLSBkeTsKCiAgICAgICAgdGhpcy5sYXN0UGFnZVggPSBwWzBdOwogICAgICAgIHRoaXMubGFzdFBhZ2VZID0gcFsxXTsKCiAgICAgICAgdGhpcy5zZXRTdGFydFBvc2l0aW9uKHApOwogICAgfSwKCiAgICAKICAgIHNldFN0YXJ0UG9zaXRpb246IGZ1bmN0aW9uKHBvcykgewogICAgICAgIHZhciBwID0gcG9zIHx8IERvbS5nZXRYWSggdGhpcy5nZXRFbCgpICk7CiAgICAgICAgdGhpcy5kZWx0YVNldFhZID0gbnVsbDsKCiAgICAgICAgdGhpcy5zdGFydFBhZ2VYID0gcFswXTsKICAgICAgICB0aGlzLnN0YXJ0UGFnZVkgPSBwWzFdOwogICAgfSwKCiAgICAKICAgIGFkZFRvR3JvdXA6IGZ1bmN0aW9uKHNHcm91cCkgewogICAgICAgIHRoaXMuZ3JvdXBzW3NHcm91cF0gPSB0cnVlOwogICAgICAgIHRoaXMuRERNLnJlZ0RyYWdEcm9wKHRoaXMsIHNHcm91cCk7CiAgICB9LAoKICAgIAogICAgcmVtb3ZlRnJvbUdyb3VwOiBmdW5jdGlvbihzR3JvdXApIHsKICAgICAgICBpZiAodGhpcy5ncm91cHNbc0dyb3VwXSkgewogICAgICAgICAgICBkZWxldGUgdGhpcy5ncm91cHNbc0dyb3VwXTsKICAgICAgICB9CgogICAgICAgIHRoaXMuRERNLnJlbW92ZURERnJvbUdyb3VwKHRoaXMsIHNHcm91cCk7CiAgICB9LAoKICAgIAogICAgc2V0RHJhZ0VsSWQ6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgdGhpcy5kcmFnRWxJZCA9IGlkOwogICAgfSwKCiAgICAKICAgIHNldEhhbmRsZUVsSWQ6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBpZCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWQgPSBFeHQuaWQoaWQpOwogICAgICAgIH0KICAgICAgICB0aGlzLmhhbmRsZUVsSWQgPSBpZDsKICAgICAgICB0aGlzLkRETS5yZWdIYW5kbGUodGhpcy5pZCwgaWQpOwogICAgfSwKCiAgICAKICAgIHNldE91dGVySGFuZGxlRWxJZDogZnVuY3Rpb24oaWQpIHsKICAgICAgICBpZiAodHlwZW9mIGlkICE9PSAic3RyaW5nIikgewogICAgICAgICAgICBpZCA9IEV4dC5pZChpZCk7CiAgICAgICAgfQogICAgICAgIEV2ZW50Lm9uKGlkLCAibW91c2Vkb3duIiwKICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlTW91c2VEb3duLCB0aGlzKTsKICAgICAgICB0aGlzLnNldEhhbmRsZUVsSWQoaWQpOwoKICAgICAgICB0aGlzLmhhc091dGVySGFuZGxlcyA9IHRydWU7CiAgICB9LAoKICAgIAogICAgdW5yZWc6IGZ1bmN0aW9uKCkgewogICAgICAgIEV2ZW50LnVuKHRoaXMuaWQsICJtb3VzZWRvd24iLAogICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVNb3VzZURvd24pOwogICAgICAgIHRoaXMuX2RvbVJlZiA9IG51bGw7CiAgICAgICAgdGhpcy5ERE0uX3JlbW92ZSh0aGlzKTsKICAgIH0sCgogICAgZGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy51bnJlZygpOwogICAgfSwKCiAgICAKICAgIGlzTG9ja2VkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gKHRoaXMuRERNLmlzTG9ja2VkKCkgfHwgdGhpcy5sb2NrZWQpOwogICAgfSwKCiAgICAKICAgIGhhbmRsZU1vdXNlRG93bjogZnVuY3Rpb24oZSwgb0REKXsKICAgICAgICBpZiAodGhpcy5wcmltYXJ5QnV0dG9uT25seSAmJiBlLmJ1dHRvbiAhPSAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmlzTG9ja2VkKCkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5ERE0ucmVmcmVzaENhY2hlKHRoaXMuZ3JvdXBzKTsKCiAgICAgICAgdmFyIHB0ID0gbmV3IEV4dC5saWIuUG9pbnQoRXh0LmxpYi5FdmVudC5nZXRQYWdlWChlKSwgRXh0LmxpYi5FdmVudC5nZXRQYWdlWShlKSk7CiAgICAgICAgaWYgKCF0aGlzLmhhc091dGVySGFuZGxlcyAmJiAhdGhpcy5ERE0uaXNPdmVyVGFyZ2V0KHB0LCB0aGlzKSApICB7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHRoaXMuY2xpY2tWYWxpZGF0b3IoZSkpIHsKCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhcnRQb3NpdGlvbigpOwoKICAgICAgICAgICAgICAgIHRoaXMuYjRNb3VzZURvd24oZSk7CiAgICAgICAgICAgICAgICB0aGlzLm9uTW91c2VEb3duKGUpOwoKICAgICAgICAgICAgICAgIHRoaXMuRERNLmhhbmRsZU1vdXNlRG93bihlLCB0aGlzKTsKCiAgICAgICAgICAgICAgICB0aGlzLkRETS5zdG9wRXZlbnQoZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CgoKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgY2xpY2tWYWxpZGF0b3I6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gZS5nZXRUYXJnZXQoKTsKICAgICAgICByZXR1cm4gKCB0aGlzLmlzVmFsaWRIYW5kbGVDaGlsZCh0YXJnZXQpICYmCiAgICAgICAgICAgICAgICAgICAgKHRoaXMuaWQgPT0gdGhpcy5oYW5kbGVFbElkIHx8CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuRERNLmhhbmRsZVdhc0NsaWNrZWQodGFyZ2V0LCB0aGlzLmlkKSkgKTsKICAgIH0sCgogICAgCiAgICBhZGRJbnZhbGlkSGFuZGxlVHlwZTogZnVuY3Rpb24odGFnTmFtZSkgewogICAgICAgIHZhciB0eXBlID0gdGFnTmFtZS50b1VwcGVyQ2FzZSgpOwogICAgICAgIHRoaXMuaW52YWxpZEhhbmRsZVR5cGVzW3R5cGVdID0gdHlwZTsKICAgIH0sCgogICAgCiAgICBhZGRJbnZhbGlkSGFuZGxlSWQ6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBpZCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWQgPSBFeHQuaWQoaWQpOwogICAgICAgIH0KICAgICAgICB0aGlzLmludmFsaWRIYW5kbGVJZHNbaWRdID0gaWQ7CiAgICB9LAoKICAgIAogICAgYWRkSW52YWxpZEhhbmRsZUNsYXNzOiBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICAgIHRoaXMuaW52YWxpZEhhbmRsZUNsYXNzZXMucHVzaChjc3NDbGFzcyk7CiAgICB9LAoKICAgIAogICAgcmVtb3ZlSW52YWxpZEhhbmRsZVR5cGU6IGZ1bmN0aW9uKHRhZ05hbWUpIHsKICAgICAgICB2YXIgdHlwZSA9IHRhZ05hbWUudG9VcHBlckNhc2UoKTsKICAgICAgICAKICAgICAgICBkZWxldGUgdGhpcy5pbnZhbGlkSGFuZGxlVHlwZXNbdHlwZV07CiAgICB9LAoKICAgIAogICAgcmVtb3ZlSW52YWxpZEhhbmRsZUlkOiBmdW5jdGlvbihpZCkgewogICAgICAgIGlmICh0eXBlb2YgaWQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGlkID0gRXh0LmlkKGlkKTsKICAgICAgICB9CiAgICAgICAgZGVsZXRlIHRoaXMuaW52YWxpZEhhbmRsZUlkc1tpZF07CiAgICB9LAoKICAgIAogICAgcmVtb3ZlSW52YWxpZEhhbmRsZUNsYXNzOiBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICAgIGZvciAodmFyIGk9MCwgbGVuPXRoaXMuaW52YWxpZEhhbmRsZUNsYXNzZXMubGVuZ3RoOyBpPGxlbjsgKytpKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmludmFsaWRIYW5kbGVDbGFzc2VzW2ldID09IGNzc0NsYXNzKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5pbnZhbGlkSGFuZGxlQ2xhc3Nlc1tpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBpc1ZhbGlkSGFuZGxlQ2hpbGQ6IGZ1bmN0aW9uKG5vZGUpIHsKCiAgICAgICAgdmFyIHZhbGlkID0gdHJ1ZTsKICAgICAgICAKICAgICAgICB2YXIgbm9kZU5hbWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKICAgICAgICB9CiAgICAgICAgdmFsaWQgPSB2YWxpZCAmJiAhdGhpcy5pbnZhbGlkSGFuZGxlVHlwZXNbbm9kZU5hbWVdOwogICAgICAgIHZhbGlkID0gdmFsaWQgJiYgIXRoaXMuaW52YWxpZEhhbmRsZUlkc1tub2RlLmlkXTsKCiAgICAgICAgZm9yICh2YXIgaT0wLCBsZW49dGhpcy5pbnZhbGlkSGFuZGxlQ2xhc3Nlcy5sZW5ndGg7IHZhbGlkICYmIGk8bGVuOyArK2kpIHsKICAgICAgICAgICAgdmFsaWQgPSAhRXh0LmZseShub2RlKS5oYXNDbGFzcyh0aGlzLmludmFsaWRIYW5kbGVDbGFzc2VzW2ldKTsKICAgICAgICB9CgoKICAgICAgICByZXR1cm4gdmFsaWQ7CgogICAgfSwKCiAgICAKICAgIHNldFhUaWNrczogZnVuY3Rpb24oaVN0YXJ0WCwgaVRpY2tTaXplKSB7CiAgICAgICAgdGhpcy54VGlja3MgPSBbXTsKICAgICAgICB0aGlzLnhUaWNrU2l6ZSA9IGlUaWNrU2l6ZTsKCiAgICAgICAgdmFyIHRpY2tNYXAgPSB7fTsKCiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuaW5pdFBhZ2VYOyBpID49IHRoaXMubWluWDsgaSA9IGkgLSBpVGlja1NpemUpIHsKICAgICAgICAgICAgaWYgKCF0aWNrTWFwW2ldKSB7CiAgICAgICAgICAgICAgICB0aGlzLnhUaWNrc1t0aGlzLnhUaWNrcy5sZW5ndGhdID0gaTsKICAgICAgICAgICAgICAgIHRpY2tNYXBbaV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKGkgPSB0aGlzLmluaXRQYWdlWDsgaSA8PSB0aGlzLm1heFg7IGkgPSBpICsgaVRpY2tTaXplKSB7CiAgICAgICAgICAgIGlmICghdGlja01hcFtpXSkgewogICAgICAgICAgICAgICAgdGhpcy54VGlja3NbdGhpcy54VGlja3MubGVuZ3RoXSA9IGk7CiAgICAgICAgICAgICAgICB0aWNrTWFwW2ldID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy54VGlja3Muc29ydCh0aGlzLkRETS5udW1lcmljU29ydCkgOwogICAgfSwKCiAgICAKICAgIHNldFlUaWNrczogZnVuY3Rpb24oaVN0YXJ0WSwgaVRpY2tTaXplKSB7CiAgICAgICAgdGhpcy55VGlja3MgPSBbXTsKICAgICAgICB0aGlzLnlUaWNrU2l6ZSA9IGlUaWNrU2l6ZTsKCiAgICAgICAgdmFyIHRpY2tNYXAgPSB7fTsKCiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuaW5pdFBhZ2VZOyBpID49IHRoaXMubWluWTsgaSA9IGkgLSBpVGlja1NpemUpIHsKICAgICAgICAgICAgaWYgKCF0aWNrTWFwW2ldKSB7CiAgICAgICAgICAgICAgICB0aGlzLnlUaWNrc1t0aGlzLnlUaWNrcy5sZW5ndGhdID0gaTsKICAgICAgICAgICAgICAgIHRpY2tNYXBbaV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKGkgPSB0aGlzLmluaXRQYWdlWTsgaSA8PSB0aGlzLm1heFk7IGkgPSBpICsgaVRpY2tTaXplKSB7CiAgICAgICAgICAgIGlmICghdGlja01hcFtpXSkgewogICAgICAgICAgICAgICAgdGhpcy55VGlja3NbdGhpcy55VGlja3MubGVuZ3RoXSA9IGk7CiAgICAgICAgICAgICAgICB0aWNrTWFwW2ldID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy55VGlja3Muc29ydCh0aGlzLkRETS5udW1lcmljU29ydCkgOwogICAgfSwKCiAgICAKICAgIHNldFhDb25zdHJhaW50OiBmdW5jdGlvbihpTGVmdCwgaVJpZ2h0LCBpVGlja1NpemUpIHsKICAgICAgICB0aGlzLmxlZnRDb25zdHJhaW50ID0gaUxlZnQ7CiAgICAgICAgdGhpcy5yaWdodENvbnN0cmFpbnQgPSBpUmlnaHQ7CgogICAgICAgIHRoaXMubWluWCA9IHRoaXMuaW5pdFBhZ2VYIC0gaUxlZnQ7CiAgICAgICAgdGhpcy5tYXhYID0gdGhpcy5pbml0UGFnZVggKyBpUmlnaHQ7CiAgICAgICAgaWYgKGlUaWNrU2l6ZSkgeyB0aGlzLnNldFhUaWNrcyh0aGlzLmluaXRQYWdlWCwgaVRpY2tTaXplKTsgfQoKICAgICAgICB0aGlzLmNvbnN0cmFpblggPSB0cnVlOwogICAgfSwKCiAgICAKICAgIGNsZWFyQ29uc3RyYWludHM6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuY29uc3RyYWluWCA9IGZhbHNlOwogICAgICAgIHRoaXMuY29uc3RyYWluWSA9IGZhbHNlOwogICAgICAgIHRoaXMuY2xlYXJUaWNrcygpOwogICAgfSwKCiAgICAKICAgIGNsZWFyVGlja3M6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMueFRpY2tzID0gbnVsbDsKICAgICAgICB0aGlzLnlUaWNrcyA9IG51bGw7CiAgICAgICAgdGhpcy54VGlja1NpemUgPSAwOwogICAgICAgIHRoaXMueVRpY2tTaXplID0gMDsKICAgIH0sCgogICAgCiAgICBzZXRZQ29uc3RyYWludDogZnVuY3Rpb24oaVVwLCBpRG93biwgaVRpY2tTaXplKSB7CiAgICAgICAgdGhpcy50b3BDb25zdHJhaW50ID0gaVVwOwogICAgICAgIHRoaXMuYm90dG9tQ29uc3RyYWludCA9IGlEb3duOwoKICAgICAgICB0aGlzLm1pblkgPSB0aGlzLmluaXRQYWdlWSAtIGlVcDsKICAgICAgICB0aGlzLm1heFkgPSB0aGlzLmluaXRQYWdlWSArIGlEb3duOwogICAgICAgIGlmIChpVGlja1NpemUpIHsgdGhpcy5zZXRZVGlja3ModGhpcy5pbml0UGFnZVksIGlUaWNrU2l6ZSk7IH0KCiAgICAgICAgdGhpcy5jb25zdHJhaW5ZID0gdHJ1ZTsKCiAgICB9LAoKICAgIAogICAgcmVzZXRDb25zdHJhaW50czogZnVuY3Rpb24oKSB7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuaW5pdFBhZ2VYIHx8IHRoaXMuaW5pdFBhZ2VYID09PSAwKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgZHggPSAodGhpcy5tYWludGFpbk9mZnNldCkgPyB0aGlzLmxhc3RQYWdlWCAtIHRoaXMuaW5pdFBhZ2VYIDogMDsKICAgICAgICAgICAgdmFyIGR5ID0gKHRoaXMubWFpbnRhaW5PZmZzZXQpID8gdGhpcy5sYXN0UGFnZVkgLSB0aGlzLmluaXRQYWdlWSA6IDA7CgogICAgICAgICAgICB0aGlzLnNldEluaXRQb3NpdGlvbihkeCwgZHkpOwoKICAgICAgICAKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNldEluaXRQb3NpdGlvbigpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29uc3RyYWluWCkgewogICAgICAgICAgICB0aGlzLnNldFhDb25zdHJhaW50KCB0aGlzLmxlZnRDb25zdHJhaW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJpZ2h0Q29uc3RyYWludCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy54VGlja1NpemUgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb25zdHJhaW5ZKSB7CiAgICAgICAgICAgIHRoaXMuc2V0WUNvbnN0cmFpbnQoIHRoaXMudG9wQ29uc3RyYWludCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ib3R0b21Db25zdHJhaW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnlUaWNrU2l6ZSAgICAgICAgICk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldFRpY2s6IGZ1bmN0aW9uKHZhbCwgdGlja0FycmF5KSB7CiAgICAgICAgaWYgKCF0aWNrQXJyYXkpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0gZWxzZSBpZiAodGlja0FycmF5WzBdID49IHZhbCkgewogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0aWNrQXJyYXlbMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgaT0wLCBsZW49dGlja0FycmF5Lmxlbmd0aDsgaTxsZW47ICsraSkgewogICAgICAgICAgICAgICAgdmFyIG5leHQgPSBpICsgMTsKICAgICAgICAgICAgICAgIGlmICh0aWNrQXJyYXlbbmV4dF0gJiYgdGlja0FycmF5W25leHRdID49IHZhbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkaWZmMSA9IHZhbCAtIHRpY2tBcnJheVtpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlmZjIgPSB0aWNrQXJyYXlbbmV4dF0gLSB2YWw7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChkaWZmMiA+IGRpZmYxKSA/IHRpY2tBcnJheVtpXSA6IHRpY2tBcnJheVtuZXh0XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdGlja0FycmF5W3RpY2tBcnJheS5sZW5ndGggLSAxXTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAoIkRyYWdEcm9wICIgKyB0aGlzLmlkKTsKICAgIH0KCn07Cgp9KSgpOwoKCgoKaWYgKCFFeHQuZGQuRHJhZ0Ryb3BNZ3IpIHsKCgpFeHQuZGQuRHJhZ0Ryb3BNZ3IgPSBmdW5jdGlvbigpIHsKCiAgICB2YXIgRXZlbnQgPSBFeHQuRXZlbnRNYW5hZ2VyOwoKICAgIHJldHVybiB7CgogICAgICAgIAogICAgICAgIGlkczoge30sCgogICAgICAgIAogICAgICAgIGhhbmRsZUlkczoge30sCgogICAgICAgIAogICAgICAgIGRyYWdDdXJyZW50OiBudWxsLAoKICAgICAgICAKICAgICAgICBkcmFnT3ZlcnM6IHt9LAoKICAgICAgICAKICAgICAgICBkZWx0YVg6IDAsCgogICAgICAgIAogICAgICAgIGRlbHRhWTogMCwKCiAgICAgICAgCiAgICAgICAgcHJldmVudERlZmF1bHQ6IHRydWUsCgogICAgICAgIAogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogdHJ1ZSwKCiAgICAgICAgCiAgICAgICAgaW5pdGlhbGl6ZWQ6IGZhbHNlLAoKICAgICAgICAKICAgICAgICBsb2NrZWQ6IGZhbHNlLAoKICAgICAgICAKICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgUE9JTlQ6IDAsCgogICAgICAgIAogICAgICAgIElOVEVSU0VDVDogMSwKCiAgICAgICAgCiAgICAgICAgbW9kZTogMCwKCiAgICAgICAgCiAgICAgICAgX2V4ZWNPbkFsbDogZnVuY3Rpb24oc01ldGhvZCwgYXJncykgewogICAgICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMuaWRzKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqIGluIHRoaXMuaWRzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9ERCA9IHRoaXMuaWRzW2ldW2pdOwogICAgICAgICAgICAgICAgICAgIGlmICghIHRoaXMuaXNUeXBlT2ZERChvREQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBvRERbc01ldGhvZF0uYXBwbHkob0RELCBhcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIF9vbkxvYWQ6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdGhpcy5pbml0KCk7CgoKICAgICAgICAgICAgRXZlbnQub24oZG9jdW1lbnQsICJtb3VzZXVwIiwgICB0aGlzLmhhbmRsZU1vdXNlVXAsIHRoaXMsIHRydWUpOwogICAgICAgICAgICBFdmVudC5vbihkb2N1bWVudCwgIm1vdXNlbW92ZSIsIHRoaXMuaGFuZGxlTW91c2VNb3ZlLCB0aGlzLCB0cnVlKTsKICAgICAgICAgICAgRXZlbnQub24od2luZG93LCAgICJ1bmxvYWQiLCAgICB0aGlzLl9vblVubG9hZCwgdGhpcywgdHJ1ZSk7CiAgICAgICAgICAgIEV2ZW50Lm9uKHdpbmRvdywgICAicmVzaXplIiwgICAgdGhpcy5fb25SZXNpemUsIHRoaXMsIHRydWUpOwogICAgICAgICAgICAKCiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgX29uUmVzaXplOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHRoaXMuX2V4ZWNPbkFsbCgicmVzZXRDb25zdHJhaW50cyIsIFtdKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBsb2NrOiBmdW5jdGlvbigpIHsgdGhpcy5sb2NrZWQgPSB0cnVlOyB9LAoKICAgICAgICAKICAgICAgICB1bmxvY2s6IGZ1bmN0aW9uKCkgeyB0aGlzLmxvY2tlZCA9IGZhbHNlOyB9LAoKICAgICAgICAKICAgICAgICBpc0xvY2tlZDogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLmxvY2tlZDsgfSwKCiAgICAgICAgCiAgICAgICAgbG9jYXRpb25DYWNoZToge30sCgogICAgICAgIAogICAgICAgIHVzZUNhY2hlOiB0cnVlLAoKICAgICAgICAKICAgICAgICBjbGlja1BpeGVsVGhyZXNoOiAzLAoKICAgICAgICAKICAgICAgICBjbGlja1RpbWVUaHJlc2g6IDM1MCwKCiAgICAgICAgCiAgICAgICAgZHJhZ1RocmVzaE1ldDogZmFsc2UsCgogICAgICAgIAogICAgICAgIGNsaWNrVGltZW91dDogbnVsbCwKCiAgICAgICAgCiAgICAgICAgc3RhcnRYOiAwLAoKICAgICAgICAKICAgICAgICBzdGFydFk6IDAsCgogICAgICAgIAogICAgICAgIHJlZ0RyYWdEcm9wOiBmdW5jdGlvbihvREQsIHNHcm91cCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaW5pdGlhbGl6ZWQpIHsgdGhpcy5pbml0KCk7IH0KCiAgICAgICAgICAgIGlmICghdGhpcy5pZHNbc0dyb3VwXSkgewogICAgICAgICAgICAgICAgdGhpcy5pZHNbc0dyb3VwXSA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaWRzW3NHcm91cF1bb0RELmlkXSA9IG9ERDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICByZW1vdmVEREZyb21Hcm91cDogZnVuY3Rpb24ob0RELCBzR3JvdXApIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlkc1tzR3JvdXBdKSB7CiAgICAgICAgICAgICAgICB0aGlzLmlkc1tzR3JvdXBdID0ge307CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBvYmogPSB0aGlzLmlkc1tzR3JvdXBdOwogICAgICAgICAgICBpZiAob2JqICYmIG9ialtvREQuaWRdKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgb2JqW29ERC5pZF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBfcmVtb3ZlOiBmdW5jdGlvbihvREQpIHsKICAgICAgICAgICAgZm9yICh2YXIgZyBpbiBvREQuZ3JvdXBzKSB7CiAgICAgICAgICAgICAgICBpZiAoZyAmJiB0aGlzLmlkc1tnXSAmJiB0aGlzLmlkc1tnXVtvREQuaWRdKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuaWRzW2ddW29ERC5pZF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIHRoaXMuaGFuZGxlSWRzW29ERC5pZF07CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcmVnSGFuZGxlOiBmdW5jdGlvbihzRERJZCwgc0hhbmRsZUlkKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5oYW5kbGVJZHNbc0RESWRdKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUlkc1tzRERJZF0gPSB7fTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhhbmRsZUlkc1tzRERJZF1bc0hhbmRsZUlkXSA9IHNIYW5kbGVJZDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBpc0RyYWdEcm9wOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICByZXR1cm4gKCB0aGlzLmdldEREQnlJZChpZCkgKSA/IHRydWUgOiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRSZWxhdGVkOiBmdW5jdGlvbihwX29ERCwgYlRhcmdldHNPbmx5KSB7CiAgICAgICAgICAgIHZhciBvRERzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gcF9vREQuZ3JvdXBzKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqIGluIHRoaXMuaWRzW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRkID0gdGhpcy5pZHNbaV1bal07CiAgICAgICAgICAgICAgICAgICAgaWYgKCEgdGhpcy5pc1R5cGVPZkREKGRkKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFiVGFyZ2V0c09ubHkgfHwgZGQuaXNUYXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb0REc1tvRERzLmxlbmd0aF0gPSBkZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvRERzOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGlzTGVnYWxUYXJnZXQ6IGZ1bmN0aW9uIChvREQsIG9UYXJnZXRERCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0cyA9IHRoaXMuZ2V0UmVsYXRlZChvREQsIHRydWUpOwogICAgICAgICAgICBmb3IgKHZhciBpPTAsIGxlbj10YXJnZXRzLmxlbmd0aDtpPGxlbjsrK2kpIHsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXRzW2ldLmlkID09IG9UYXJnZXRERC5pZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaXNUeXBlT2ZERDogZnVuY3Rpb24gKG9ERCkgewogICAgICAgICAgICByZXR1cm4gKG9ERCAmJiBvREQuX195Z0RyYWdEcm9wKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBpc0hhbmRsZTogZnVuY3Rpb24oc0RESWQsIHNIYW5kbGVJZCkgewogICAgICAgICAgICByZXR1cm4gKCB0aGlzLmhhbmRsZUlkc1tzRERJZF0gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlSWRzW3NERElkXVtzSGFuZGxlSWRdICk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0RERCeUlkOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMuaWRzKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pZHNbaV1baWRdKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaWRzW2ldW2lkXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBoYW5kbGVNb3VzZURvd246IGZ1bmN0aW9uKGUsIG9ERCkgewogICAgICAgICAgICBpZihFeHQuUXVpY2tUaXBzKXsKICAgICAgICAgICAgICAgIEV4dC5RdWlja1RpcHMuZGREaXNhYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5kcmFnQ3VycmVudCl7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVNb3VzZVVwKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmN1cnJlbnRUYXJnZXQgPSBlLmdldFRhcmdldCgpOwogICAgICAgICAgICB0aGlzLmRyYWdDdXJyZW50ID0gb0REOwoKICAgICAgICAgICAgdmFyIGVsID0gb0RELmdldEVsKCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGFydFggPSBlLmdldFBhZ2VYKCk7CiAgICAgICAgICAgIHRoaXMuc3RhcnRZID0gZS5nZXRQYWdlWSgpOwoKICAgICAgICAgICAgdGhpcy5kZWx0YVggPSB0aGlzLnN0YXJ0WCAtIGVsLm9mZnNldExlZnQ7CiAgICAgICAgICAgIHRoaXMuZGVsdGFZID0gdGhpcy5zdGFydFkgLSBlbC5vZmZzZXRUb3A7CgogICAgICAgICAgICB0aGlzLmRyYWdUaHJlc2hNZXQgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMuY2xpY2tUaW1lb3V0ID0gc2V0VGltZW91dCgKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIERETSA9IEV4dC5kZC5ERE07CiAgICAgICAgICAgICAgICAgICAgICAgIERETS5zdGFydERyYWcoRERNLnN0YXJ0WCwgRERNLnN0YXJ0WSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB0aGlzLmNsaWNrVGltZVRocmVzaCApOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHN0YXJ0RHJhZzogZnVuY3Rpb24oeCwgeSkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5jbGlja1RpbWVvdXQpOwogICAgICAgICAgICBpZiAodGhpcy5kcmFnQ3VycmVudCkgewogICAgICAgICAgICAgICAgdGhpcy5kcmFnQ3VycmVudC5iNFN0YXJ0RHJhZyh4LCB5KTsKICAgICAgICAgICAgICAgIHRoaXMuZHJhZ0N1cnJlbnQuc3RhcnREcmFnKHgsIHkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZHJhZ1RocmVzaE1ldCA9IHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaGFuZGxlTW91c2VVcDogZnVuY3Rpb24oZSkgewoKICAgICAgICAgICAgaWYoRXh0LlF1aWNrVGlwcyl7CiAgICAgICAgICAgICAgICBFeHQuUXVpY2tUaXBzLmRkRW5hYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEgdGhpcy5kcmFnQ3VycmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5jbGlja1RpbWVvdXQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ1RocmVzaE1ldCkgewogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnRzKGUsIHRydWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0b3BEcmFnKGUpOwoKICAgICAgICAgICAgdGhpcy5zdG9wRXZlbnQoZSk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgc3RvcEV2ZW50OiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgaWYodGhpcy5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBzdG9wRHJhZzogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ0N1cnJlbnQpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRyYWdUaHJlc2hNZXQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyYWdDdXJyZW50LmI0RW5kRHJhZyhlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyYWdDdXJyZW50LmVuZERyYWcoZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5kcmFnQ3VycmVudC5vbk1vdXNlVXAoZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZHJhZ0N1cnJlbnQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmRyYWdPdmVycyA9IHt9OwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGhhbmRsZU1vdXNlTW92ZTogZnVuY3Rpb24oZSkgewogICAgICAgICAgICBpZiAoISB0aGlzLmRyYWdDdXJyZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRXh0LmlzSUUgJiYgKGUuYnV0dG9uICE9PSAwICYmIGUuYnV0dG9uICE9PSAxICYmIGUuYnV0dG9uICE9PSAyKSkgewogICAgICAgICAgICAgICAgdGhpcy5zdG9wRXZlbnQoZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVNb3VzZVVwKGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRoaXMuZHJhZ1RocmVzaE1ldCkgewogICAgICAgICAgICAgICAgdmFyIGRpZmZYID0gTWF0aC5hYnModGhpcy5zdGFydFggLSBlLmdldFBhZ2VYKCkpOwogICAgICAgICAgICAgICAgdmFyIGRpZmZZID0gTWF0aC5hYnModGhpcy5zdGFydFkgLSBlLmdldFBhZ2VZKCkpOwogICAgICAgICAgICAgICAgaWYgKGRpZmZYID4gdGhpcy5jbGlja1BpeGVsVGhyZXNoIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmWSA+IHRoaXMuY2xpY2tQaXhlbFRocmVzaCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnREcmFnKHRoaXMuc3RhcnRYLCB0aGlzLnN0YXJ0WSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLmRyYWdUaHJlc2hNZXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZHJhZ0N1cnJlbnQuYjREcmFnKGUpOwogICAgICAgICAgICAgICAgdGhpcy5kcmFnQ3VycmVudC5vbkRyYWcoZSk7CiAgICAgICAgICAgICAgICBpZighdGhpcy5kcmFnQ3VycmVudC5tb3ZlT25seSl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnRzKGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zdG9wRXZlbnQoZSk7CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBmaXJlRXZlbnRzOiBmdW5jdGlvbihlLCBpc0Ryb3ApIHsKICAgICAgICAgICAgdmFyIGRjID0gdGhpcy5kcmFnQ3VycmVudDsKCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFkYyB8fCBkYy5pc0xvY2tlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBwdCA9IGUuZ2V0UG9pbnQoKTsKCiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgb2xkT3ZlcnMgPSBbXTsKCiAgICAgICAgICAgIHZhciBvdXRFdnRzICAgPSBbXTsKICAgICAgICAgICAgdmFyIG92ZXJFdnRzICA9IFtdOwogICAgICAgICAgICB2YXIgZHJvcEV2dHMgID0gW107CiAgICAgICAgICAgIHZhciBlbnRlckV2dHMgPSBbXTsKCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgZm9yICh2YXIgaSBpbiB0aGlzLmRyYWdPdmVycykgewoKICAgICAgICAgICAgICAgIHZhciBkZG8gPSB0aGlzLmRyYWdPdmVyc1tpXTsKCiAgICAgICAgICAgICAgICBpZiAoISB0aGlzLmlzVHlwZU9mREQoZGRvKSkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghIHRoaXMuaXNPdmVyVGFyZ2V0KHB0LCBkZG8sIHRoaXMubW9kZSkpIHsKICAgICAgICAgICAgICAgICAgICBvdXRFdnRzLnB1c2goIGRkbyApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG9sZE92ZXJzW2ldID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmRyYWdPdmVyc1tpXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgc0dyb3VwIGluIGRjLmdyb3VwcykgewoKICAgICAgICAgICAgICAgIGlmICgic3RyaW5nIiAhPSB0eXBlb2Ygc0dyb3VwKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIChpIGluIHRoaXMuaWRzW3NHcm91cF0pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb0REID0gdGhpcy5pZHNbc0dyb3VwXVtpXTsKICAgICAgICAgICAgICAgICAgICBpZiAoISB0aGlzLmlzVHlwZU9mREQob0REKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChvREQuaXNUYXJnZXQgJiYgIW9ERC5pc0xvY2tlZCgpICYmICgob0REICE9IGRjKSB8fCAoZGMuaWdub3JlU2VsZiA9PT0gZmFsc2UpKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc092ZXJUYXJnZXQocHQsIG9ERCwgdGhpcy5tb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNEcm9wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHJvcEV2dHMucHVzaCggb0REICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb2xkT3ZlcnNbb0RELmlkXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbnRlckV2dHMucHVzaCggb0REICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlckV2dHMucHVzaCggb0REICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRyYWdPdmVyc1tvREQuaWRdID0gb0REOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5tb2RlKSB7CiAgICAgICAgICAgICAgICBpZiAob3V0RXZ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBkYy5iNERyYWdPdXQoZSwgb3V0RXZ0cyk7CiAgICAgICAgICAgICAgICAgICAgZGMub25EcmFnT3V0KGUsIG91dEV2dHMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChlbnRlckV2dHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGMub25EcmFnRW50ZXIoZSwgZW50ZXJFdnRzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAob3ZlckV2dHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGMuYjREcmFnT3ZlcihlLCBvdmVyRXZ0cyk7CiAgICAgICAgICAgICAgICAgICAgZGMub25EcmFnT3ZlcihlLCBvdmVyRXZ0cyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGRyb3BFdnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGRjLmI0RHJhZ0Ryb3AoZSwgZHJvcEV2dHMpOwogICAgICAgICAgICAgICAgICAgIGRjLm9uRHJhZ0Ryb3AoZSwgZHJvcEV2dHMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdmFyIGxlbiA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKGk9MCwgbGVuPW91dEV2dHMubGVuZ3RoOyBpPGxlbjsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgZGMuYjREcmFnT3V0KGUsIG91dEV2dHNbaV0uaWQpOwogICAgICAgICAgICAgICAgICAgIGRjLm9uRHJhZ091dChlLCBvdXRFdnRzW2ldLmlkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAoaT0wLGxlbj1lbnRlckV2dHMubGVuZ3RoOyBpPGxlbjsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZGMub25EcmFnRW50ZXIoZSwgZW50ZXJFdnRzW2ldLmlkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAoaT0wLGxlbj1vdmVyRXZ0cy5sZW5ndGg7IGk8bGVuOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICBkYy5iNERyYWdPdmVyKGUsIG92ZXJFdnRzW2ldLmlkKTsKICAgICAgICAgICAgICAgICAgICBkYy5vbkRyYWdPdmVyKGUsIG92ZXJFdnRzW2ldLmlkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAoaT0wLCBsZW49ZHJvcEV2dHMubGVuZ3RoOyBpPGxlbjsgKytpKSB7CiAgICAgICAgICAgICAgICAgICAgZGMuYjREcmFnRHJvcChlLCBkcm9wRXZ0c1tpXS5pZCk7CiAgICAgICAgICAgICAgICAgICAgZGMub25EcmFnRHJvcChlLCBkcm9wRXZ0c1tpXS5pZCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGlzRHJvcCAmJiAhZHJvcEV2dHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBkYy5vbkludmFsaWREcm9wKGUpOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldEJlc3RNYXRjaDogZnVuY3Rpb24oZGRzKSB7CiAgICAgICAgICAgIHZhciB3aW5uZXIgPSBudWxsOwogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCgogICAgICAgICAgICB2YXIgbGVuID0gZGRzLmxlbmd0aDsKCiAgICAgICAgICAgIGlmIChsZW4gPT0gMSkgewogICAgICAgICAgICAgICAgd2lubmVyID0gZGRzWzBdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTA7IGk8bGVuOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGQgPSBkZHNbaV07CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGRkLmN1cnNvcklzT3ZlcikgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5uZXIgPSBkZDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3aW5uZXIgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbm5lci5vdmVybGFwLmdldEFyZWEoKSA8IGRkLm92ZXJsYXAuZ2V0QXJlYSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5uZXIgPSBkZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHdpbm5lcjsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICByZWZyZXNoQ2FjaGU6IGZ1bmN0aW9uKGdyb3VwcykgewogICAgICAgICAgICBmb3IgKHZhciBzR3JvdXAgaW4gZ3JvdXBzKSB7CiAgICAgICAgICAgICAgICBpZiAoInN0cmluZyIgIT0gdHlwZW9mIHNHcm91cCkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiB0aGlzLmlkc1tzR3JvdXBdKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9ERCA9IHRoaXMuaWRzW3NHcm91cF1baV07CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzVHlwZU9mREQob0REKSkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG9jID0gdGhpcy5nZXRMb2NhdGlvbihvREQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobG9jKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2F0aW9uQ2FjaGVbb0RELmlkXSA9IGxvYzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxvY2F0aW9uQ2FjaGVbb0RELmlkXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHZlcmlmeUVsOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnQ7CiAgICAgICAgICAgICAgICBpZihFeHQuaXNJRSl7CiAgICAgICAgICAgICAgICAgICAgdHJ5ewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBlbC5vZmZzZXRQYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGUpe30KICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IGVsLm9mZnNldFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldExvY2F0aW9uOiBmdW5jdGlvbihvREQpIHsKICAgICAgICAgICAgaWYgKCEgdGhpcy5pc1R5cGVPZkREKG9ERCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZWwgPSBvREQuZ2V0RWwoKSwgcG9zLCB4MSwgeDIsIHkxLCB5MiwgdCwgciwgYiwgbCwgcmVnaW9uOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHBvcz0gRXh0LmxpYi5Eb20uZ2V0WFkoZWwpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7IH0KCiAgICAgICAgICAgIGlmICghcG9zKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgeDEgPSBwb3NbMF07CiAgICAgICAgICAgIHgyID0geDEgKyBlbC5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgeTEgPSBwb3NbMV07CiAgICAgICAgICAgIHkyID0geTEgKyBlbC5vZmZzZXRIZWlnaHQ7CgogICAgICAgICAgICB0ID0geTEgLSBvREQucGFkZGluZ1swXTsKICAgICAgICAgICAgciA9IHgyICsgb0RELnBhZGRpbmdbMV07CiAgICAgICAgICAgIGIgPSB5MiArIG9ERC5wYWRkaW5nWzJdOwogICAgICAgICAgICBsID0geDEgLSBvREQucGFkZGluZ1szXTsKCiAgICAgICAgICAgIHJlZ2lvbiA9IG5ldyBFeHQubGliLlJlZ2lvbiggdCwgciwgYiwgbCApOwogICAgICAgICAgICAKICAgICAgICAgICAgZWwgPSBFeHQuZ2V0KGVsLnBhcmVudE5vZGUpOwogICAgICAgICAgICB3aGlsZSAoZWwgJiYgcmVnaW9uKSB7CgkgICAgICAgICAgICBpZiAoZWwuaXNTY3JvbGxhYmxlKCkpIHsKCSAgICAgICAgICAgICAgICAKCSAgICAgICAgICAgICAgICByZWdpb24gPSByZWdpb24uaW50ZXJzZWN0KGVsLmdldFJlZ2lvbigpKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsID0gZWwucGFyZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlZ2lvbjsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBpc092ZXJUYXJnZXQ6IGZ1bmN0aW9uKHB0LCBvVGFyZ2V0LCBpbnRlcnNlY3QpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uQ2FjaGVbb1RhcmdldC5pZF07CiAgICAgICAgICAgIGlmICghbG9jIHx8ICF0aGlzLnVzZUNhY2hlKSB7CiAgICAgICAgICAgICAgICBsb2MgPSB0aGlzLmdldExvY2F0aW9uKG9UYXJnZXQpOwogICAgICAgICAgICAgICAgdGhpcy5sb2NhdGlvbkNhY2hlW29UYXJnZXQuaWRdID0gbG9jOwoKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFsb2MpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb1RhcmdldC5jdXJzb3JJc092ZXIgPSBsb2MuY29udGFpbnMoIHB0ICk7CgogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBkYyA9IHRoaXMuZHJhZ0N1cnJlbnQ7CiAgICAgICAgICAgIGlmICghZGMgfHwgIWRjLmdldFRhcmdldENvb3JkIHx8CiAgICAgICAgICAgICAgICAgICAgKCFpbnRlcnNlY3QgJiYgIWRjLmNvbnN0cmFpblggJiYgIWRjLmNvbnN0cmFpblkpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb1RhcmdldC5jdXJzb3JJc092ZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9UYXJnZXQub3ZlcmxhcCA9IG51bGw7CgogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHBvcyA9IGRjLmdldFRhcmdldENvb3JkKHB0LngsIHB0LnkpOwoKICAgICAgICAgICAgdmFyIGVsID0gZGMuZ2V0RHJhZ0VsKCk7CiAgICAgICAgICAgIHZhciBjdXJSZWdpb24gPSBuZXcgRXh0LmxpYi5SZWdpb24oIHBvcy55LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueCArIGVsLm9mZnNldFdpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MueSArIGVsLm9mZnNldEhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zLnggKTsKCiAgICAgICAgICAgIHZhciBvdmVybGFwID0gY3VyUmVnaW9uLmludGVyc2VjdChsb2MpOwoKICAgICAgICAgICAgaWYgKG92ZXJsYXApIHsKICAgICAgICAgICAgICAgIG9UYXJnZXQub3ZlcmxhcCA9IG92ZXJsYXA7CiAgICAgICAgICAgICAgICByZXR1cm4gKGludGVyc2VjdCkgPyB0cnVlIDogb1RhcmdldC5jdXJzb3JJc092ZXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBfb25VbmxvYWQ6IGZ1bmN0aW9uKGUsIG1lKSB7CiAgICAgICAgICAgIEV2ZW50LnJlbW92ZUxpc3RlbmVyKGRvY3VtZW50LCAibW91c2V1cCIsICAgdGhpcy5oYW5kbGVNb3VzZVVwLCB0aGlzKTsKICAgICAgICAgICAgRXZlbnQucmVtb3ZlTGlzdGVuZXIoZG9jdW1lbnQsICJtb3VzZW1vdmUiLCB0aGlzLmhhbmRsZU1vdXNlTW92ZSwgdGhpcyk7CiAgICAgICAgICAgIEV2ZW50LnJlbW92ZUxpc3RlbmVyKHdpbmRvdywgICAicmVzaXplIiwgICAgdGhpcy5fb25SZXNpemUsIHRoaXMpOwogICAgICAgICAgICBFeHQuZGQuRHJhZ0Ryb3BNZ3IudW5yZWdBbGwoKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICB1bnJlZ0FsbDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICBpZiAodGhpcy5kcmFnQ3VycmVudCkgewogICAgICAgICAgICAgICAgdGhpcy5zdG9wRHJhZygpOwogICAgICAgICAgICAgICAgdGhpcy5kcmFnQ3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2V4ZWNPbkFsbCgidW5yZWciLCBbXSk7CgogICAgICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMuZWxlbWVudENhY2hlKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5lbGVtZW50Q2FjaGVbaV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZWxlbWVudENhY2hlID0ge307CiAgICAgICAgICAgIHRoaXMuaWRzID0ge307CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZWxlbWVudENhY2hlOiB7fSwKCiAgICAgICAgCiAgICAgICAgZ2V0RWxXcmFwcGVyOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB2YXIgb1dyYXBwZXIgPSB0aGlzLmVsZW1lbnRDYWNoZVtpZF07CiAgICAgICAgICAgIGlmICghb1dyYXBwZXIgfHwgIW9XcmFwcGVyLmVsKSB7CiAgICAgICAgICAgICAgICBvV3JhcHBlciA9IHRoaXMuZWxlbWVudENhY2hlW2lkXSA9CiAgICAgICAgICAgICAgICAgICAgbmV3IHRoaXMuRWxlbWVudFdyYXBwZXIoRXh0LmdldERvbShpZCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvV3JhcHBlcjsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRFbGVtZW50OiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICByZXR1cm4gRXh0LmdldERvbShpZCk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0Q3NzOiBmdW5jdGlvbihpZCkgewogICAgICAgICAgICB2YXIgZWwgPSBFeHQuZ2V0RG9tKGlkKTsKICAgICAgICAgICAgcmV0dXJuIChlbCkgPyBlbC5zdHlsZSA6IG51bGw7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgRWxlbWVudFdyYXBwZXI6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuZWwgPSBlbCB8fCBudWxsOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmlkID0gdGhpcy5lbCAmJiBlbC5pZDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5jc3MgPSB0aGlzLmVsICYmIGVsLnN0eWxlOwogICAgICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRQb3NYOiBmdW5jdGlvbihlbCkgewogICAgICAgICAgICByZXR1cm4gRXh0LmxpYi5Eb20uZ2V0WChlbCk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0UG9zWTogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgcmV0dXJuIEV4dC5saWIuRG9tLmdldFkoZWwpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHN3YXBOb2RlOiBmdW5jdGlvbihuMSwgbjIpIHsKICAgICAgICAgICAgaWYgKG4xLnN3YXBOb2RlKSB7CiAgICAgICAgICAgICAgICBuMS5zd2FwTm9kZShuMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcCA9IG4yLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICB2YXIgcyA9IG4yLm5leHRTaWJsaW5nOwoKICAgICAgICAgICAgICAgIGlmIChzID09IG4xKSB7CiAgICAgICAgICAgICAgICAgICAgcC5pbnNlcnRCZWZvcmUobjEsIG4yKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobjIgPT0gbjEubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgICAgICBwLmluc2VydEJlZm9yZShuMiwgbjEpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuMS5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChuMiwgbjEpOwogICAgICAgICAgICAgICAgICAgIHAuaW5zZXJ0QmVmb3JlKG4xLCBzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldFNjcm9sbDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdCwgbCwgZGRlPWRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZGI9ZG9jdW1lbnQuYm9keTsKICAgICAgICAgICAgaWYgKGRkZSAmJiAoZGRlLnNjcm9sbFRvcCB8fCBkZGUuc2Nyb2xsTGVmdCkpIHsKICAgICAgICAgICAgICAgIHQgPSBkZGUuc2Nyb2xsVG9wOwogICAgICAgICAgICAgICAgbCA9IGRkZS5zY3JvbGxMZWZ0OwogICAgICAgICAgICB9IGVsc2UgaWYgKGRiKSB7CiAgICAgICAgICAgICAgICB0ID0gZGIuc2Nyb2xsVG9wOwogICAgICAgICAgICAgICAgbCA9IGRiLnNjcm9sbExlZnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7IHRvcDogdCwgbGVmdDogbCB9OwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldFN0eWxlOiBmdW5jdGlvbihlbCwgc3R5bGVQcm9wKSB7CiAgICAgICAgICAgIHJldHVybiBFeHQuZmx5KGVsKS5nZXRTdHlsZShzdHlsZVByb3ApOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldFNjcm9sbFRvcDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTY3JvbGwoKS50b3A7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0U2Nyb2xsTGVmdDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTY3JvbGwoKS5sZWZ0OwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIG1vdmVUb0VsOiBmdW5jdGlvbiAobW92ZUVsLCB0YXJnZXRFbCkgewogICAgICAgICAgICB2YXIgYUNvb3JkID0gRXh0LmxpYi5Eb20uZ2V0WFkodGFyZ2V0RWwpOwogICAgICAgICAgICBFeHQubGliLkRvbS5zZXRYWShtb3ZlRWwsIGFDb29yZCk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgbnVtZXJpY1NvcnQ6IGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIChhIC0gYik7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgX3RpbWVvdXRDb3VudDogMCwKCiAgICAgICAgCiAgICAgICAgX2FkZExpc3RlbmVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBERE0gPSBFeHQuZGQuRERNOwogICAgICAgICAgICBpZiAoIEV4dC5saWIuRXZlbnQgJiYgZG9jdW1lbnQgKSB7CiAgICAgICAgICAgICAgICBERE0uX29uTG9hZCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKERETS5fdGltZW91dENvdW50ID4gMjAwMCkgewogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KERETS5fYWRkTGlzdGVuZXJzLCAxMCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50ICYmIGRvY3VtZW50LmJvZHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgRERNLl90aW1lb3V0Q291bnQgKz0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBoYW5kbGVXYXNDbGlja2VkOiBmdW5jdGlvbihub2RlLCBpZCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0hhbmRsZShpZCwgbm9kZS5pZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2YXIgcCA9IG5vZGUucGFyZW50Tm9kZTsKCiAgICAgICAgICAgICAgICB3aGlsZSAocCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzSGFuZGxlKGlkLCBwLmlkKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwID0gcC5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICB9OwoKfSgpOwoKCkV4dC5kZC5ERE0gPSBFeHQuZGQuRHJhZ0Ryb3BNZ3I7CkV4dC5kZC5ERE0uX2FkZExpc3RlbmVycygpOwoKfQoKCkV4dC5kZC5ERCA9IGZ1bmN0aW9uKGlkLCBzR3JvdXAsIGNvbmZpZykgewogICAgaWYgKGlkKSB7CiAgICAgICAgdGhpcy5pbml0KGlkLCBzR3JvdXAsIGNvbmZpZyk7CiAgICB9Cn07CgpFeHQuZXh0ZW5kKEV4dC5kZC5ERCwgRXh0LmRkLkRyYWdEcm9wLCB7CgogICAgCiAgICBzY3JvbGw6IHRydWUsCgogICAgCiAgICBhdXRvT2Zmc2V0OiBmdW5jdGlvbihpUGFnZVgsIGlQYWdlWSkgewogICAgICAgIHZhciB4ID0gaVBhZ2VYIC0gdGhpcy5zdGFydFBhZ2VYOwogICAgICAgIHZhciB5ID0gaVBhZ2VZIC0gdGhpcy5zdGFydFBhZ2VZOwogICAgICAgIHRoaXMuc2V0RGVsdGEoeCwgeSk7CiAgICB9LAoKICAgIAogICAgc2V0RGVsdGE6IGZ1bmN0aW9uKGlEZWx0YVgsIGlEZWx0YVkpIHsKICAgICAgICB0aGlzLmRlbHRhWCA9IGlEZWx0YVg7CiAgICAgICAgdGhpcy5kZWx0YVkgPSBpRGVsdGFZOwogICAgfSwKCiAgICAKICAgIHNldERyYWdFbFBvczogZnVuY3Rpb24oaVBhZ2VYLCBpUGFnZVkpIHsKICAgICAgICAKICAgICAgICAKCiAgICAgICAgdmFyIGVsID0gdGhpcy5nZXREcmFnRWwoKTsKICAgICAgICB0aGlzLmFsaWduRWxXaXRoTW91c2UoZWwsIGlQYWdlWCwgaVBhZ2VZKTsKICAgIH0sCgogICAgCiAgICBhbGlnbkVsV2l0aE1vdXNlOiBmdW5jdGlvbihlbCwgaVBhZ2VYLCBpUGFnZVkpIHsKICAgICAgICB2YXIgb0Nvb3JkID0gdGhpcy5nZXRUYXJnZXRDb29yZChpUGFnZVgsIGlQYWdlWSk7CiAgICAgICAgdmFyIGZseSA9IGVsLmRvbSA/IGVsIDogRXh0LmZseShlbCwgJ19kZCcpOwogICAgICAgIGlmICghdGhpcy5kZWx0YVNldFhZKSB7CiAgICAgICAgICAgIHZhciBhQ29vcmQgPSBbb0Nvb3JkLngsIG9Db29yZC55XTsKICAgICAgICAgICAgZmx5LnNldFhZKGFDb29yZCk7CiAgICAgICAgICAgIHZhciBuZXdMZWZ0ID0gZmx5LmdldExlZnQodHJ1ZSk7CiAgICAgICAgICAgIHZhciBuZXdUb3AgID0gZmx5LmdldFRvcCh0cnVlKTsKICAgICAgICAgICAgdGhpcy5kZWx0YVNldFhZID0gWyBuZXdMZWZ0IC0gb0Nvb3JkLngsIG5ld1RvcCAtIG9Db29yZC55IF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmx5LnNldExlZnRUb3Aob0Nvb3JkLnggKyB0aGlzLmRlbHRhU2V0WFlbMF0sIG9Db29yZC55ICsgdGhpcy5kZWx0YVNldFhZWzFdKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2FjaGVQb3NpdGlvbihvQ29vcmQueCwgb0Nvb3JkLnkpOwogICAgICAgIHRoaXMuYXV0b1Njcm9sbChvQ29vcmQueCwgb0Nvb3JkLnksIGVsLm9mZnNldEhlaWdodCwgZWwub2Zmc2V0V2lkdGgpOwogICAgICAgIHJldHVybiBvQ29vcmQ7CiAgICB9LAoKICAgIAogICAgY2FjaGVQb3NpdGlvbjogZnVuY3Rpb24oaVBhZ2VYLCBpUGFnZVkpIHsKICAgICAgICBpZiAoaVBhZ2VYKSB7CiAgICAgICAgICAgIHRoaXMubGFzdFBhZ2VYID0gaVBhZ2VYOwogICAgICAgICAgICB0aGlzLmxhc3RQYWdlWSA9IGlQYWdlWTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYUNvb3JkID0gRXh0LmxpYi5Eb20uZ2V0WFkodGhpcy5nZXRFbCgpKTsKICAgICAgICAgICAgdGhpcy5sYXN0UGFnZVggPSBhQ29vcmRbMF07CiAgICAgICAgICAgIHRoaXMubGFzdFBhZ2VZID0gYUNvb3JkWzFdOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhdXRvU2Nyb2xsOiBmdW5jdGlvbih4LCB5LCBoLCB3KSB7CgogICAgICAgIGlmICh0aGlzLnNjcm9sbCkgewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGNsaWVudEggPSBFeHQubGliLkRvbS5nZXRWaWV3SGVpZ2h0KCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGNsaWVudFcgPSBFeHQubGliLkRvbS5nZXRWaWV3V2lkdGgoKTsKCiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgc3QgPSB0aGlzLkRETS5nZXRTY3JvbGxUb3AoKTsKCiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgc2wgPSB0aGlzLkRETS5nZXRTY3JvbGxMZWZ0KCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGJvdCA9IGggKyB5OwoKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciByaWdodCA9IHcgKyB4OwoKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHRvQm90ID0gKGNsaWVudEggKyBzdCAtIHkgLSB0aGlzLmRlbHRhWSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHRvUmlnaHQgPSAoY2xpZW50VyArIHNsIC0geCAtIHRoaXMuZGVsdGFYKTsKCgogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciB0aHJlc2ggPSA0MDsKCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBzY3JBbXQgPSAoZG9jdW1lbnQuYWxsKSA/IDgwIDogMzA7CgogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICggYm90ID4gY2xpZW50SCAmJiB0b0JvdCA8IHRocmVzaCApIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbyhzbCwgc3QgKyBzY3JBbXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICggeSA8IHN0ICYmIHN0ID4gMCAmJiB5IC0gc3QgPCB0aHJlc2ggKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oc2wsIHN0IC0gc2NyQW10KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIHJpZ2h0ID4gY2xpZW50VyAmJiB0b1JpZ2h0IDwgdGhyZXNoICkgewogICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKHNsICsgc2NyQW10LCBzdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCB4IDwgc2wgJiYgc2wgPiAwICYmIHggLSBzbCA8IHRocmVzaCApIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbyhzbCAtIHNjckFtdCwgc3QpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldFRhcmdldENvb3JkOiBmdW5jdGlvbihpUGFnZVgsIGlQYWdlWSkgewogICAgICAgIHZhciB4ID0gaVBhZ2VYIC0gdGhpcy5kZWx0YVg7CiAgICAgICAgdmFyIHkgPSBpUGFnZVkgLSB0aGlzLmRlbHRhWTsKCiAgICAgICAgaWYgKHRoaXMuY29uc3RyYWluWCkgewogICAgICAgICAgICBpZiAoeCA8IHRoaXMubWluWCkgeyB4ID0gdGhpcy5taW5YOyB9CiAgICAgICAgICAgIGlmICh4ID4gdGhpcy5tYXhYKSB7IHggPSB0aGlzLm1heFg7IH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbnN0cmFpblkpIHsKICAgICAgICAgICAgaWYgKHkgPCB0aGlzLm1pblkpIHsgeSA9IHRoaXMubWluWTsgfQogICAgICAgICAgICBpZiAoeSA+IHRoaXMubWF4WSkgeyB5ID0gdGhpcy5tYXhZOyB9CiAgICAgICAgfQoKICAgICAgICB4ID0gdGhpcy5nZXRUaWNrKHgsIHRoaXMueFRpY2tzKTsKICAgICAgICB5ID0gdGhpcy5nZXRUaWNrKHksIHRoaXMueVRpY2tzKTsKCgogICAgICAgIHJldHVybiB7eDp4LCB5Onl9OwogICAgfSwKCiAgICAKICAgIGFwcGx5Q29uZmlnOiBmdW5jdGlvbigpIHsKICAgICAgICBFeHQuZGQuREQuc3VwZXJjbGFzcy5hcHBseUNvbmZpZy5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuc2Nyb2xsID0gKHRoaXMuY29uZmlnLnNjcm9sbCAhPT0gZmFsc2UpOwogICAgfSwKCiAgICAKICAgIGI0TW91c2VEb3duOiBmdW5jdGlvbihlKSB7CiAgICAgICAgCiAgICAgICAgdGhpcy5hdXRvT2Zmc2V0KGUuZ2V0UGFnZVgoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuZ2V0UGFnZVkoKSk7CiAgICB9LAoKICAgIAogICAgYjREcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdGhpcy5zZXREcmFnRWxQb3MoZS5nZXRQYWdlWCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5nZXRQYWdlWSgpKTsKICAgIH0sCgogICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAoIkREICIgKyB0aGlzLmlkKTsKICAgIH0KCiAgICAKICAgIAogICAgCiAgICAKCn0pOwoKRXh0LmRkLkREUHJveHkgPSBmdW5jdGlvbihpZCwgc0dyb3VwLCBjb25maWcpIHsKICAgIGlmIChpZCkgewogICAgICAgIHRoaXMuaW5pdChpZCwgc0dyb3VwLCBjb25maWcpOwogICAgICAgIHRoaXMuaW5pdEZyYW1lKCk7CiAgICB9Cn07CgoKRXh0LmRkLkREUHJveHkuZHJhZ0VsSWQgPSAieWdkZGZkaXYiOwoKRXh0LmV4dGVuZChFeHQuZGQuRERQcm94eSwgRXh0LmRkLkRELCB7CgogICAgCiAgICByZXNpemVGcmFtZTogdHJ1ZSwKCiAgICAKICAgIGNlbnRlckZyYW1lOiBmYWxzZSwKCiAgICAKICAgIGNyZWF0ZUZyYW1lOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIGJvZHkgPSBkb2N1bWVudC5ib2R5OwoKICAgICAgICBpZiAoIWJvZHkgfHwgIWJvZHkuZmlyc3RDaGlsZCkgewogICAgICAgICAgICBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsgc2VsZi5jcmVhdGVGcmFtZSgpOyB9LCA1MCApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgZGl2ID0gdGhpcy5nZXREcmFnRWwoKTsKCiAgICAgICAgaWYgKCFkaXYpIHsKICAgICAgICAgICAgZGl2ICAgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGRpdi5pZCA9IHRoaXMuZHJhZ0VsSWQ7CiAgICAgICAgICAgIHZhciBzICA9IGRpdi5zdHlsZTsKCiAgICAgICAgICAgIHMucG9zaXRpb24gICA9ICJhYnNvbHV0ZSI7CiAgICAgICAgICAgIHMudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgICAgICAgICBzLmN1cnNvciAgICAgPSAibW92ZSI7CiAgICAgICAgICAgIHMuYm9yZGVyICAgICA9ICIycHggc29saWQgI2FhYSI7CiAgICAgICAgICAgIHMuekluZGV4ICAgICA9IDk5OTsKCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGJvZHkuaW5zZXJ0QmVmb3JlKGRpdiwgYm9keS5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaW5pdEZyYW1lOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmNyZWF0ZUZyYW1lKCk7CiAgICB9LAoKICAgIGFwcGx5Q29uZmlnOiBmdW5jdGlvbigpIHsKICAgICAgICBFeHQuZGQuRERQcm94eS5zdXBlcmNsYXNzLmFwcGx5Q29uZmlnLmNhbGwodGhpcyk7CgogICAgICAgIHRoaXMucmVzaXplRnJhbWUgPSAodGhpcy5jb25maWcucmVzaXplRnJhbWUgIT09IGZhbHNlKTsKICAgICAgICB0aGlzLmNlbnRlckZyYW1lID0gKHRoaXMuY29uZmlnLmNlbnRlckZyYW1lKTsKICAgICAgICB0aGlzLnNldERyYWdFbElkKHRoaXMuY29uZmlnLmRyYWdFbElkIHx8IEV4dC5kZC5ERFByb3h5LmRyYWdFbElkKTsKICAgIH0sCgogICAgCiAgICBzaG93RnJhbWU6IGZ1bmN0aW9uKGlQYWdlWCwgaVBhZ2VZKSB7CiAgICAgICAgdmFyIGVsID0gdGhpcy5nZXRFbCgpOwogICAgICAgIHZhciBkcmFnRWwgPSB0aGlzLmdldERyYWdFbCgpOwogICAgICAgIHZhciBzID0gZHJhZ0VsLnN0eWxlOwoKICAgICAgICB0aGlzLl9yZXNpemVQcm94eSgpOwoKICAgICAgICBpZiAodGhpcy5jZW50ZXJGcmFtZSkgewogICAgICAgICAgICB0aGlzLnNldERlbHRhKCBNYXRoLnJvdW5kKHBhcnNlSW50KHMud2lkdGgsICAxMCkvMiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGgucm91bmQocGFyc2VJbnQocy5oZWlnaHQsIDEwKS8yKSApOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zZXREcmFnRWxQb3MoaVBhZ2VYLCBpUGFnZVkpOwoKICAgICAgICBFeHQuZmx5KGRyYWdFbCkuc2hvdygpOwogICAgfSwKCiAgICAKICAgIF9yZXNpemVQcm94eTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMucmVzaXplRnJhbWUpIHsKICAgICAgICAgICAgdmFyIGVsID0gdGhpcy5nZXRFbCgpOwogICAgICAgICAgICBFeHQuZmx5KHRoaXMuZ2V0RHJhZ0VsKCkpLnNldFNpemUoZWwub2Zmc2V0V2lkdGgsIGVsLm9mZnNldEhlaWdodCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGI0TW91c2VEb3duOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIHggPSBlLmdldFBhZ2VYKCk7CiAgICAgICAgdmFyIHkgPSBlLmdldFBhZ2VZKCk7CiAgICAgICAgdGhpcy5hdXRvT2Zmc2V0KHgsIHkpOwogICAgICAgIHRoaXMuc2V0RHJhZ0VsUG9zKHgsIHkpOwogICAgfSwKCiAgICAKICAgIGI0U3RhcnREcmFnOiBmdW5jdGlvbih4LCB5KSB7CiAgICAgICAgCiAgICAgICAgdGhpcy5zaG93RnJhbWUoeCwgeSk7CiAgICB9LAoKICAgIAogICAgYjRFbmREcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgICAgRXh0LmZseSh0aGlzLmdldERyYWdFbCgpKS5oaWRlKCk7CiAgICB9LAoKICAgIAogICAgCiAgICAKICAgIGVuZERyYWc6IGZ1bmN0aW9uKGUpIHsKCiAgICAgICAgdmFyIGxlbCA9IHRoaXMuZ2V0RWwoKTsKICAgICAgICB2YXIgZGVsID0gdGhpcy5nZXREcmFnRWwoKTsKCiAgICAgICAgCiAgICAgICAgZGVsLnN0eWxlLnZpc2liaWxpdHkgPSAiIjsKCiAgICAgICAgdGhpcy5iZWZvcmVNb3ZlKCk7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgbGVsLnN0eWxlLnZpc2liaWxpdHkgPSAiaGlkZGVuIjsKICAgICAgICBFeHQuZGQuRERNLm1vdmVUb0VsKGxlbCwgZGVsKTsKICAgICAgICBkZWwuc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgICAgIGxlbC5zdHlsZS52aXNpYmlsaXR5ID0gIiI7CgogICAgICAgIHRoaXMuYWZ0ZXJEcmFnKCk7CiAgICB9LAoKICAgIGJlZm9yZU1vdmUgOiBmdW5jdGlvbigpewoKICAgIH0sCgogICAgYWZ0ZXJEcmFnIDogZnVuY3Rpb24oKXsKCiAgICB9LAoKICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gKCJERFByb3h5ICIgKyB0aGlzLmlkKTsKICAgIH0KCn0pOwoKRXh0LmRkLkREVGFyZ2V0ID0gZnVuY3Rpb24oaWQsIHNHcm91cCwgY29uZmlnKSB7CiAgICBpZiAoaWQpIHsKICAgICAgICB0aGlzLmluaXRUYXJnZXQoaWQsIHNHcm91cCwgY29uZmlnKTsKICAgIH0KfTsKCgpFeHQuZXh0ZW5kKEV4dC5kZC5ERFRhcmdldCwgRXh0LmRkLkRyYWdEcm9wLCB7CiAgICAKICAgIGdldERyYWdFbDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGlzVmFsaWRIYW5kbGVDaGlsZDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIHN0YXJ0RHJhZzogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGVuZERyYWc6IEV4dC5lbXB0eUZuLAogICAgCiAgICBvbkRyYWc6IEV4dC5lbXB0eUZuLAogICAgCiAgICBvbkRyYWdEcm9wOiBFeHQuZW1wdHlGbiwKICAgIAogICAgb25EcmFnRW50ZXI6IEV4dC5lbXB0eUZuLAogICAgCiAgICBvbkRyYWdPdXQ6IEV4dC5lbXB0eUZuLAogICAgCiAgICBvbkRyYWdPdmVyOiBFeHQuZW1wdHlGbiwKICAgIAogICAgb25JbnZhbGlkRHJvcDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIG9uTW91c2VEb3duOiBFeHQuZW1wdHlGbiwKICAgIAogICAgb25Nb3VzZVVwOiBFeHQuZW1wdHlGbiwKICAgIAogICAgc2V0WENvbnN0cmFpbnQ6IEV4dC5lbXB0eUZuLAogICAgCiAgICBzZXRZQ29uc3RyYWludDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIHJlc2V0Q29uc3RyYWludHM6IEV4dC5lbXB0eUZuLAogICAgCiAgICBjbGVhckNvbnN0cmFpbnRzOiBFeHQuZW1wdHlGbiwKICAgIAogICAgY2xlYXJUaWNrczogRXh0LmVtcHR5Rm4sCiAgICAKICAgIHNldEluaXRQb3NpdGlvbjogRXh0LmVtcHR5Rm4sCiAgICAKICAgIHNldERyYWdFbElkOiBFeHQuZW1wdHlGbiwKICAgIAogICAgc2V0SGFuZGxlRWxJZDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIHNldE91dGVySGFuZGxlRWxJZDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGFkZEludmFsaWRIYW5kbGVDbGFzczogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGFkZEludmFsaWRIYW5kbGVJZDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGFkZEludmFsaWRIYW5kbGVUeXBlOiBFeHQuZW1wdHlGbiwKICAgIAogICAgcmVtb3ZlSW52YWxpZEhhbmRsZUNsYXNzOiBFeHQuZW1wdHlGbiwKICAgIAogICAgcmVtb3ZlSW52YWxpZEhhbmRsZUlkOiBFeHQuZW1wdHlGbiwKICAgIAogICAgcmVtb3ZlSW52YWxpZEhhbmRsZVR5cGU6IEV4dC5lbXB0eUZuLAoKICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gKCJERFRhcmdldCAiICsgdGhpcy5pZCk7CiAgICB9Cn0pOwpFeHQuZGQuRHJhZ1RyYWNrZXIgPSBFeHQuZXh0ZW5kKEV4dC51dGlsLk9ic2VydmFibGUsICB7ICAgIAogICAgCQogICAgYWN0aXZlOiBmYWxzZSwKICAgIAkKICAgIHRvbGVyYW5jZTogNSwKICAgIAkKICAgIGF1dG9TdGFydDogZmFsc2UsCiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKCSAgICB0aGlzLmFkZEV2ZW50cygKCSAgICAgICAgCgkgICAgICAgICdtb3VzZWRvd24nLAoJICAgICAgICAKCSAgICAgICAgJ21vdXNldXAnLAoJICAgICAgICAKCSAgICAgICAgJ21vdXNlbW92ZScsCgkgICAgICAgIAoJICAgICAgICAnZHJhZ3N0YXJ0JywKCSAgICAgICAgCgkgICAgICAgICdkcmFnZW5kJywKCSAgICAgICAgCgkgICAgICAgICdkcmFnJwoJICAgICk7CgkKCSAgICB0aGlzLmRyYWdSZWdpb24gPSBuZXcgRXh0LmxpYi5SZWdpb24oMCwwLDAsMCk7CgkKCSAgICBpZih0aGlzLmVsKXsKCSAgICAgICAgdGhpcy5pbml0RWwodGhpcy5lbCk7CgkgICAgfQogICAgICAgIEV4dC5kZC5EcmFnVHJhY2tlci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgY29uZmlnKTsKICAgIH0sCgogICAgaW5pdEVsOiBmdW5jdGlvbihlbCl7CiAgICAgICAgdGhpcy5lbCA9IEV4dC5nZXQoZWwpOwogICAgICAgIGVsLm9uKCdtb3VzZWRvd24nLCB0aGlzLm9uTW91c2VEb3duLCB0aGlzLAogICAgICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZSA/IHtkZWxlZ2F0ZTogdGhpcy5kZWxlZ2F0ZX0gOiB1bmRlZmluZWQpOwogICAgfSwKCiAgICBkZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmVsLnVuKCdtb3VzZWRvd24nLCB0aGlzLm9uTW91c2VEb3duLCB0aGlzKTsKICAgICAgICBkZWxldGUgdGhpcy5lbDsKICAgIH0sCgogICAgb25Nb3VzZURvd246IGZ1bmN0aW9uKGUsIHRhcmdldCl7CiAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoJ21vdXNlZG93bicsIHRoaXMsIGUpICE9PSBmYWxzZSAmJiB0aGlzLm9uQmVmb3JlU3RhcnQoZSkgIT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5zdGFydFhZID0gdGhpcy5sYXN0WFkgPSBlLmdldFhZKCk7CiAgICAgICAgICAgIHRoaXMuZHJhZ1RhcmdldCA9IHRoaXMuZGVsZWdhdGUgPyB0YXJnZXQgOiB0aGlzLmVsLmRvbTsKICAgICAgICAgICAgaWYodGhpcy5wcmV2ZW50RGVmYXVsdCAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEV4dC5nZXREb2MoKS5vbih7CiAgICAgICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgICAgIG1vdXNldXA6IHRoaXMub25Nb3VzZVVwLAogICAgICAgICAgICAgICAgbW91c2Vtb3ZlOiB0aGlzLm9uTW91c2VNb3ZlLAogICAgICAgICAgICAgICAgc2VsZWN0c3RhcnQ6IHRoaXMuc3RvcFNlbGVjdAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhpcy5hdXRvU3RhcnQpewogICAgICAgICAgICAgICAgdGhpcy50aW1lciA9IHRoaXMudHJpZ2dlclN0YXJ0LmRlZmVyKHRoaXMuYXV0b1N0YXJ0ID09PSB0cnVlID8gMTAwMCA6IHRoaXMuYXV0b1N0YXJ0LCB0aGlzLCBbZV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICBvbk1vdXNlTW92ZTogZnVuY3Rpb24oZSwgdGFyZ2V0KXsKICAgICAgICAKICAgICAgICBpZih0aGlzLmFjdGl2ZSAmJiBFeHQuaXNJRSAmJiAhZS5icm93c2VyRXZlbnQuYnV0dG9uKXsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB0aGlzLm9uTW91c2VVcChlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZhciB4eSA9IGUuZ2V0WFkoKSwgcyA9IHRoaXMuc3RhcnRYWTsKICAgICAgICB0aGlzLmxhc3RYWSA9IHh5OwogICAgICAgIGlmKCF0aGlzLmFjdGl2ZSl7CiAgICAgICAgICAgIGlmKE1hdGguYWJzKHNbMF0teHlbMF0pID4gdGhpcy50b2xlcmFuY2UgfHwgTWF0aC5hYnMoc1sxXS14eVsxXSkgPiB0aGlzLnRvbGVyYW5jZSl7CiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJTdGFydChlKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ21vdXNlbW92ZScsIHRoaXMsIGUpOwogICAgICAgIHRoaXMub25EcmFnKGUpOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdkcmFnJywgdGhpcywgZSk7CiAgICB9LAoKICAgIG9uTW91c2VVcDogZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBkb2MgPSBFeHQuZ2V0RG9jKCksCiAgICAgICAgICAgIHdhc0FjdGl2ZSA9IHRoaXMuYWN0aXZlOwogICAgICAgICAgICAKICAgICAgICBkb2MudW4oJ21vdXNlbW92ZScsIHRoaXMub25Nb3VzZU1vdmUsIHRoaXMpOwogICAgICAgIGRvYy51bignbW91c2V1cCcsIHRoaXMub25Nb3VzZVVwLCB0aGlzKTsKICAgICAgICBkb2MudW4oJ3NlbGVjdHN0YXJ0JywgdGhpcy5zdG9wU2VsZWN0LCB0aGlzKTsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdGhpcy5jbGVhclN0YXJ0KCk7CiAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICBkZWxldGUgdGhpcy5lbFJlZ2lvbjsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnbW91c2V1cCcsIHRoaXMsIGUpOwogICAgICAgIGlmKHdhc0FjdGl2ZSl7CiAgICAgICAgICAgIHRoaXMub25FbmQoZSk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdkcmFnZW5kJywgdGhpcywgZSk7CiAgICAgICAgfQogICAgfSwKCiAgICB0cmlnZ2VyU3RhcnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB0aGlzLmNsZWFyU3RhcnQoKTsKICAgICAgICB0aGlzLmFjdGl2ZSA9IHRydWU7CiAgICAgICAgdGhpcy5vblN0YXJ0KGUpOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdkcmFnc3RhcnQnLCB0aGlzLCBlKTsKICAgIH0sCgogICAgY2xlYXJTdGFydCA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmKHRoaXMudGltZXIpewogICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lcik7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRpbWVyOwogICAgICAgIH0KICAgIH0sCgogICAgc3RvcFNlbGVjdCA6IGZ1bmN0aW9uKGUpIHsKICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICAKICAgIAogICAgb25CZWZvcmVTdGFydCA6IGZ1bmN0aW9uKGUpIHsKCiAgICB9LAoKICAgIAogICAgb25TdGFydCA6IGZ1bmN0aW9uKHh5KSB7CgogICAgfSwKCiAgICAKICAgIG9uRHJhZyA6IGZ1bmN0aW9uKGUpIHsKCiAgICB9LAoKICAgIAogICAgb25FbmQgOiBmdW5jdGlvbihlKSB7CgogICAgfSwKCiAgICAKICAgIGdldERyYWdUYXJnZXQgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmRyYWdUYXJnZXQ7CiAgICB9LAoKICAgIGdldERyYWdDdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZWw7CiAgICB9LAoKICAgIGdldFhZIDogZnVuY3Rpb24oY29uc3RyYWluKXsKICAgICAgICByZXR1cm4gY29uc3RyYWluID8KICAgICAgICAgICAgICAgdGhpcy5jb25zdHJhaW5Nb2Rlc1tjb25zdHJhaW5dLmNhbGwodGhpcywgdGhpcy5sYXN0WFkpIDogdGhpcy5sYXN0WFk7CiAgICB9LAoKICAgIGdldE9mZnNldCA6IGZ1bmN0aW9uKGNvbnN0cmFpbil7CiAgICAgICAgdmFyIHh5ID0gdGhpcy5nZXRYWShjb25zdHJhaW4pLAogICAgICAgICAgICBzID0gdGhpcy5zdGFydFhZOwogICAgICAgIHJldHVybiBbc1swXS14eVswXSwgc1sxXS14eVsxXV07CiAgICB9LAoKICAgIGNvbnN0cmFpbk1vZGVzOiB7CiAgICAgICAgJ3BvaW50JyA6IGZ1bmN0aW9uKHh5KXsKCiAgICAgICAgICAgIGlmKCF0aGlzLmVsUmVnaW9uKXsKICAgICAgICAgICAgICAgIHRoaXMuZWxSZWdpb24gPSB0aGlzLmdldERyYWdDdCgpLmdldFJlZ2lvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZHIgPSB0aGlzLmRyYWdSZWdpb247CgogICAgICAgICAgICBkci5sZWZ0ID0geHlbMF07CiAgICAgICAgICAgIGRyLnRvcCA9IHh5WzFdOwogICAgICAgICAgICBkci5yaWdodCA9IHh5WzBdOwogICAgICAgICAgICBkci5ib3R0b20gPSB4eVsxXTsKCiAgICAgICAgICAgIGRyLmNvbnN0cmFpblRvKHRoaXMuZWxSZWdpb24pOwoKICAgICAgICAgICAgcmV0dXJuIFtkci5sZWZ0LCBkci50b3BdOwogICAgICAgIH0KICAgIH0KfSk7CkV4dC5kZC5TY3JvbGxNYW5hZ2VyID0gZnVuY3Rpb24oKXsKICAgIHZhciBkZG0gPSBFeHQuZGQuRHJhZ0Ryb3BNZ3I7CiAgICB2YXIgZWxzID0ge307CiAgICB2YXIgZHJhZ0VsID0gbnVsbDsKICAgIHZhciBwcm9jID0ge307CiAgICAKICAgIHZhciBvblN0b3AgPSBmdW5jdGlvbihlKXsKICAgICAgICBkcmFnRWwgPSBudWxsOwogICAgICAgIGNsZWFyUHJvYygpOwogICAgfTsKICAgIAogICAgdmFyIHRyaWdnZXJSZWZyZXNoID0gZnVuY3Rpb24oKXsKICAgICAgICBpZihkZG0uZHJhZ0N1cnJlbnQpewogICAgICAgICAgICAgZGRtLnJlZnJlc2hDYWNoZShkZG0uZHJhZ0N1cnJlbnQuZ3JvdXBzKTsKICAgICAgICB9CiAgICB9OwogICAgCiAgICB2YXIgZG9TY3JvbGwgPSBmdW5jdGlvbigpewogICAgICAgIGlmKGRkbS5kcmFnQ3VycmVudCl7CiAgICAgICAgICAgIHZhciBkZHMgPSBFeHQuZGQuU2Nyb2xsTWFuYWdlcjsKICAgICAgICAgICAgdmFyIGluYyA9IHByb2MuZWwuZGRTY3JvbGxDb25maWcgPwogICAgICAgICAgICAgICAgICAgICAgcHJvYy5lbC5kZFNjcm9sbENvbmZpZy5pbmNyZW1lbnQgOiBkZHMuaW5jcmVtZW50OwogICAgICAgICAgICBpZighZGRzLmFuaW1hdGUpewogICAgICAgICAgICAgICAgaWYocHJvYy5lbC5zY3JvbGwocHJvYy5kaXIsIGluYykpewogICAgICAgICAgICAgICAgICAgIHRyaWdnZXJSZWZyZXNoKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgcHJvYy5lbC5zY3JvbGwocHJvYy5kaXIsIGluYywgdHJ1ZSwgZGRzLmFuaW1EdXJhdGlvbiwgdHJpZ2dlclJlZnJlc2gpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIAogICAgdmFyIGNsZWFyUHJvYyA9IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYocHJvYy5pZCl7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocHJvYy5pZCk7CiAgICAgICAgfQogICAgICAgIHByb2MuaWQgPSAwOwogICAgICAgIHByb2MuZWwgPSBudWxsOwogICAgICAgIHByb2MuZGlyID0gIiI7CiAgICB9OwoKICAgIHZhciBzdGFydFByb2MgPSBmdW5jdGlvbihlbCwgZGlyKXsKICAgICAgICBjbGVhclByb2MoKTsKICAgICAgICBwcm9jLmVsID0gZWw7CiAgICAgICAgcHJvYy5kaXIgPSBkaXI7CiAgICAgICAgdmFyIGdyb3VwID0gZWwuZGRTY3JvbGxDb25maWcgPyBlbC5kZFNjcm9sbENvbmZpZy5kZEdyb3VwIDogdW5kZWZpbmVkLAogICAgICAgICAgICBmcmVxICA9IChlbC5kZFNjcm9sbENvbmZpZyAmJiBlbC5kZFNjcm9sbENvbmZpZy5mcmVxdWVuY3kpCiAgICAgICAgICAgICAgICAgID8gZWwuZGRTY3JvbGxDb25maWcuZnJlcXVlbmN5CiAgICAgICAgICAgICAgICAgIDogRXh0LmRkLlNjcm9sbE1hbmFnZXIuZnJlcXVlbmN5OwoKICAgICAgICBpZiAoZ3JvdXAgPT09IHVuZGVmaW5lZCB8fCBkZG0uZHJhZ0N1cnJlbnQuZGRHcm91cCA9PSBncm91cCkgewogICAgICAgICAgICBwcm9jLmlkID0gc2V0SW50ZXJ2YWwoZG9TY3JvbGwsIGZyZXEpOwogICAgICAgIH0KICAgIH07CiAgICAKICAgIHZhciBvbkZpcmUgPSBmdW5jdGlvbihlLCBpc0Ryb3ApewogICAgICAgIGlmKGlzRHJvcCB8fCAhZGRtLmRyYWdDdXJyZW50KXsgcmV0dXJuOyB9CiAgICAgICAgdmFyIGRkcyA9IEV4dC5kZC5TY3JvbGxNYW5hZ2VyOwogICAgICAgIGlmKCFkcmFnRWwgfHwgZHJhZ0VsICE9IGRkbS5kcmFnQ3VycmVudCl7CiAgICAgICAgICAgIGRyYWdFbCA9IGRkbS5kcmFnQ3VycmVudDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRkcy5yZWZyZXNoQ2FjaGUoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIHh5ID0gRXh0LmxpYi5FdmVudC5nZXRYWShlKTsKICAgICAgICB2YXIgcHQgPSBuZXcgRXh0LmxpYi5Qb2ludCh4eVswXSwgeHlbMV0pOwogICAgICAgIGZvcih2YXIgaWQgaW4gZWxzKXsKICAgICAgICAgICAgdmFyIGVsID0gZWxzW2lkXSwgciA9IGVsLl9yZWdpb247CiAgICAgICAgICAgIHZhciBjID0gZWwuZGRTY3JvbGxDb25maWcgPyBlbC5kZFNjcm9sbENvbmZpZyA6IGRkczsKICAgICAgICAgICAgaWYociAmJiByLmNvbnRhaW5zKHB0KSAmJiBlbC5pc1Njcm9sbGFibGUoKSl7CiAgICAgICAgICAgICAgICBpZihyLmJvdHRvbSAtIHB0LnkgPD0gYy52dGhyZXNoKXsKICAgICAgICAgICAgICAgICAgICBpZihwcm9jLmVsICE9IGVsKXsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRQcm9jKGVsLCAiZG93biIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9ZWxzZSBpZihyLnJpZ2h0IC0gcHQueCA8PSBjLmh0aHJlc2gpewogICAgICAgICAgICAgICAgICAgIGlmKHByb2MuZWwgIT0gZWwpewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydFByb2MoZWwsICJsZWZ0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH1lbHNlIGlmKHB0LnkgLSByLnRvcCA8PSBjLnZ0aHJlc2gpewogICAgICAgICAgICAgICAgICAgIGlmKHByb2MuZWwgIT0gZWwpewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydFByb2MoZWwsICJ1cCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9ZWxzZSBpZihwdC54IC0gci5sZWZ0IDw9IGMuaHRocmVzaCl7CiAgICAgICAgICAgICAgICAgICAgaWYocHJvYy5lbCAhPSBlbCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0UHJvYyhlbCwgInJpZ2h0Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjbGVhclByb2MoKTsKICAgIH07CiAgICAKICAgIGRkbS5maXJlRXZlbnRzID0gZGRtLmZpcmVFdmVudHMuY3JlYXRlU2VxdWVuY2Uob25GaXJlLCBkZG0pOwogICAgZGRtLnN0b3BEcmFnID0gZGRtLnN0b3BEcmFnLmNyZWF0ZVNlcXVlbmNlKG9uU3RvcCwgZGRtKTsKICAgIAogICAgcmV0dXJuIHsKICAgICAgICAKICAgICAgICByZWdpc3RlciA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICAgICAgaWYoRXh0LmlzQXJyYXkoZWwpKXsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGVsLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAJdGhpcy5yZWdpc3RlcihlbFtpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgZWwgPSBFeHQuZ2V0KGVsKTsKICAgICAgICAgICAgICAgIGVsc1tlbC5pZF0gPSBlbDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdW5yZWdpc3RlciA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICAgICAgaWYoRXh0LmlzQXJyYXkoZWwpKXsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGVsLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAJdGhpcy51bnJlZ2lzdGVyKGVsW2ldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBlbCA9IEV4dC5nZXQoZWwpOwogICAgICAgICAgICAgICAgZGVsZXRlIGVsc1tlbC5pZF07CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIAogICAgICAgIHZ0aHJlc2ggOiAyNSwKICAgICAgICAKICAgICAgICBodGhyZXNoIDogMjUsCgogICAgICAgIAogICAgICAgIGluY3JlbWVudCA6IDEwMCwKICAgICAgICAKICAgICAgICAKICAgICAgICBmcmVxdWVuY3kgOiA1MDAsCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgYW5pbWF0ZTogdHJ1ZSwKICAgICAgICAKICAgICAgICAKICAgICAgICBhbmltRHVyYXRpb246IC40LAogICAgICAgIAogICAgICAgIAogICAgICAgIGRkR3JvdXA6IHVuZGVmaW5lZCwKICAgICAgICAKICAgICAgICAKICAgICAgICByZWZyZXNoQ2FjaGUgOiBmdW5jdGlvbigpewogICAgICAgICAgICBmb3IodmFyIGlkIGluIGVscyl7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgZWxzW2lkXSA9PSAnb2JqZWN0Jyl7IAogICAgICAgICAgICAgICAgICAgIGVsc1tpZF0uX3JlZ2lvbiA9IGVsc1tpZF0uZ2V0UmVnaW9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KCk7CkV4dC5kZC5SZWdpc3RyeSA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgZWxlbWVudHMgPSB7fTsgCiAgICB2YXIgaGFuZGxlcyA9IHt9OyAKICAgIHZhciBhdXRvSWRTZWVkID0gMDsKCiAgICB2YXIgZ2V0SWQgPSBmdW5jdGlvbihlbCwgYXV0b2dlbil7CiAgICAgICAgaWYodHlwZW9mIGVsID09ICJzdHJpbmciKXsKICAgICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgIH0KICAgICAgICB2YXIgaWQgPSBlbC5pZDsKICAgICAgICBpZighaWQgJiYgYXV0b2dlbiAhPT0gZmFsc2UpewogICAgICAgICAgICBpZCA9ICJleHRkZC0iICsgKCsrYXV0b0lkU2VlZCk7CiAgICAgICAgICAgIGVsLmlkID0gaWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpZDsKICAgIH07CiAgICAKICAgIHJldHVybiB7CiAgICAKICAgICAgICByZWdpc3RlciA6IGZ1bmN0aW9uKGVsLCBkYXRhKXsKICAgICAgICAgICAgZGF0YSA9IGRhdGEgfHwge307CiAgICAgICAgICAgIGlmKHR5cGVvZiBlbCA9PSAic3RyaW5nIil7CiAgICAgICAgICAgICAgICBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkYXRhLmRkZWwgPSBlbDsKICAgICAgICAgICAgZWxlbWVudHNbZ2V0SWQoZWwpXSA9IGRhdGE7CiAgICAgICAgICAgIGlmKGRhdGEuaXNIYW5kbGUgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIGhhbmRsZXNbZGF0YS5kZGVsLmlkXSA9IGRhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZGF0YS5oYW5kbGVzKXsKICAgICAgICAgICAgICAgIHZhciBocyA9IGRhdGEuaGFuZGxlczsKICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGhzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIAloYW5kbGVzW2dldElkKGhzW2ldKV0gPSBkYXRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAKICAgICAgICB1bnJlZ2lzdGVyIDogZnVuY3Rpb24oZWwpewogICAgICAgICAgICB2YXIgaWQgPSBnZXRJZChlbCwgZmFsc2UpOwogICAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnRzW2lkXTsKICAgICAgICAgICAgaWYoZGF0YSl7CiAgICAgICAgICAgICAgICBkZWxldGUgZWxlbWVudHNbaWRdOwogICAgICAgICAgICAgICAgaWYoZGF0YS5oYW5kbGVzKXsKICAgICAgICAgICAgICAgICAgICB2YXIgaHMgPSBkYXRhLmhhbmRsZXM7CiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gaHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgICAgIAlkZWxldGUgaGFuZGxlc1tnZXRJZChoc1tpXSwgZmFsc2UpXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgIAogICAgICAgIGdldEhhbmRsZSA6IGZ1bmN0aW9uKGlkKXsKICAgICAgICAgICAgaWYodHlwZW9mIGlkICE9ICJzdHJpbmciKXsgCiAgICAgICAgICAgICAgICBpZCA9IGlkLmlkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBoYW5kbGVzW2lkXTsKICAgICAgICB9LAoKICAgIAogICAgICAgIGdldEhhbmRsZUZyb21FdmVudCA6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICB2YXIgdCA9IEV4dC5saWIuRXZlbnQuZ2V0VGFyZ2V0KGUpOwogICAgICAgICAgICByZXR1cm4gdCA/IGhhbmRsZXNbdC5pZF0gOiBudWxsOwogICAgICAgIH0sCgogICAgCiAgICAgICAgZ2V0VGFyZ2V0IDogZnVuY3Rpb24oaWQpewogICAgICAgICAgICBpZih0eXBlb2YgaWQgIT0gInN0cmluZyIpeyAKICAgICAgICAgICAgICAgIGlkID0gaWQuaWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnRzW2lkXTsKICAgICAgICB9LAoKICAgIAogICAgICAgIGdldFRhcmdldEZyb21FdmVudCA6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICB2YXIgdCA9IEV4dC5saWIuRXZlbnQuZ2V0VGFyZ2V0KGUpOwogICAgICAgICAgICByZXR1cm4gdCA/IGVsZW1lbnRzW3QuaWRdIHx8IGhhbmRsZXNbdC5pZF0gOiBudWxsOwogICAgICAgIH0KICAgIH07Cn0oKTsKRXh0LmRkLlN0YXR1c1Byb3h5ID0gZnVuY3Rpb24oY29uZmlnKXsKICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwogICAgdGhpcy5pZCA9IHRoaXMuaWQgfHwgRXh0LmlkKCk7CiAgICB0aGlzLmVsID0gbmV3IEV4dC5MYXllcih7CiAgICAgICAgZGg6IHsKICAgICAgICAgICAgaWQ6IHRoaXMuaWQsIHRhZzogImRpdiIsIGNsczogIngtZGQtZHJhZy1wcm94eSAiK3RoaXMuZHJvcE5vdEFsbG93ZWQsIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICB7dGFnOiAiZGl2IiwgY2xzOiAieC1kZC1kcm9wLWljb24ifSwKICAgICAgICAgICAgICAgIHt0YWc6ICJkaXYiLCBjbHM6ICJ4LWRkLWRyYWctZ2hvc3QifQogICAgICAgICAgICBdCiAgICAgICAgfSwgCiAgICAgICAgc2hhZG93OiAhY29uZmlnIHx8IGNvbmZpZy5zaGFkb3cgIT09IGZhbHNlCiAgICB9KTsKICAgIHRoaXMuZ2hvc3QgPSBFeHQuZ2V0KHRoaXMuZWwuZG9tLmNoaWxkTm9kZXNbMV0pOwogICAgdGhpcy5kcm9wU3RhdHVzID0gdGhpcy5kcm9wTm90QWxsb3dlZDsKfTsKCkV4dC5kZC5TdGF0dXNQcm94eS5wcm90b3R5cGUgPSB7CiAgICAKICAgIGRyb3BBbGxvd2VkIDogIngtZGQtZHJvcC1vayIsCiAgICAKICAgIGRyb3BOb3RBbGxvd2VkIDogIngtZGQtZHJvcC1ub2Ryb3AiLAoKICAgIAogICAgc2V0U3RhdHVzIDogZnVuY3Rpb24oY3NzQ2xhc3MpewogICAgICAgIGNzc0NsYXNzID0gY3NzQ2xhc3MgfHwgdGhpcy5kcm9wTm90QWxsb3dlZDsKICAgICAgICBpZih0aGlzLmRyb3BTdGF0dXMgIT0gY3NzQ2xhc3MpewogICAgICAgICAgICB0aGlzLmVsLnJlcGxhY2VDbGFzcyh0aGlzLmRyb3BTdGF0dXMsIGNzc0NsYXNzKTsKICAgICAgICAgICAgdGhpcy5kcm9wU3RhdHVzID0gY3NzQ2xhc3M7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHJlc2V0IDogZnVuY3Rpb24oY2xlYXJHaG9zdCl7CiAgICAgICAgdGhpcy5lbC5kb20uY2xhc3NOYW1lID0gIngtZGQtZHJhZy1wcm94eSAiICsgdGhpcy5kcm9wTm90QWxsb3dlZDsKICAgICAgICB0aGlzLmRyb3BTdGF0dXMgPSB0aGlzLmRyb3BOb3RBbGxvd2VkOwogICAgICAgIGlmKGNsZWFyR2hvc3QpewogICAgICAgICAgICB0aGlzLmdob3N0LnVwZGF0ZSgiIik7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHVwZGF0ZSA6IGZ1bmN0aW9uKGh0bWwpewogICAgICAgIGlmKHR5cGVvZiBodG1sID09ICJzdHJpbmciKXsKICAgICAgICAgICAgdGhpcy5naG9zdC51cGRhdGUoaHRtbCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuZ2hvc3QudXBkYXRlKCIiKTsKICAgICAgICAgICAgaHRtbC5zdHlsZS5tYXJnaW4gPSAiMCI7CiAgICAgICAgICAgIHRoaXMuZ2hvc3QuZG9tLmFwcGVuZENoaWxkKGh0bWwpOwogICAgICAgIH0KICAgICAgICB2YXIgZWwgPSB0aGlzLmdob3N0LmRvbS5maXJzdENoaWxkOyAKICAgICAgICBpZihlbCl7CiAgICAgICAgICAgIEV4dC5mbHkoZWwpLnNldFN0eWxlKCdmbG9hdCcsICdub25lJyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldEVsIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5lbDsKICAgIH0sCgogICAgCiAgICBnZXRHaG9zdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2hvc3Q7CiAgICB9LAoKICAgIAogICAgaGlkZSA6IGZ1bmN0aW9uKGNsZWFyKXsKICAgICAgICB0aGlzLmVsLmhpZGUoKTsKICAgICAgICBpZihjbGVhcil7CiAgICAgICAgICAgIHRoaXMucmVzZXQodHJ1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHN0b3AgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuYW5pbSAmJiB0aGlzLmFuaW0uaXNBbmltYXRlZCAmJiB0aGlzLmFuaW0uaXNBbmltYXRlZCgpKXsKICAgICAgICAgICAgdGhpcy5hbmltLnN0b3AoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2hvdyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5lbC5zaG93KCk7CiAgICB9LAoKICAgIAogICAgc3luYyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5lbC5zeW5jKCk7CiAgICB9LAoKICAgIAogICAgcmVwYWlyIDogZnVuY3Rpb24oeHksIGNhbGxiYWNrLCBzY29wZSl7CiAgICAgICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgIHRoaXMuc2NvcGUgPSBzY29wZTsKICAgICAgICBpZih4eSAmJiB0aGlzLmFuaW1SZXBhaXIgIT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5lbC5hZGRDbGFzcygieC1kZC1kcmFnLXJlcGFpciIpOwogICAgICAgICAgICB0aGlzLmVsLmhpZGVVbmRlcnModHJ1ZSk7CiAgICAgICAgICAgIHRoaXMuYW5pbSA9IHRoaXMuZWwuc2hpZnQoewogICAgICAgICAgICAgICAgZHVyYXRpb246IHRoaXMucmVwYWlyRHVyYXRpb24gfHwgLjUsCiAgICAgICAgICAgICAgICBlYXNpbmc6ICdlYXNlT3V0JywKICAgICAgICAgICAgICAgIHh5OiB4eSwKICAgICAgICAgICAgICAgIHN0b3BGeDogdHJ1ZSwKICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB0aGlzLmFmdGVyUmVwYWlyLAogICAgICAgICAgICAgICAgc2NvcGU6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJSZXBhaXIoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYWZ0ZXJSZXBhaXIgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuaGlkZSh0cnVlKTsKICAgICAgICBpZih0eXBlb2YgdGhpcy5jYWxsYmFjayA9PSAiZnVuY3Rpb24iKXsKICAgICAgICAgICAgdGhpcy5jYWxsYmFjay5jYWxsKHRoaXMuc2NvcGUgfHwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMuc2NvcGUgPSBudWxsOwogICAgfSwKICAgIAogICAgZGVzdHJveTogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZGVzdHJveSh0aGlzLmdob3N0LCB0aGlzLmVsKTsgICAgCiAgICB9Cn07CkV4dC5kZC5EcmFnU291cmNlID0gZnVuY3Rpb24oZWwsIGNvbmZpZyl7CiAgICB0aGlzLmVsID0gRXh0LmdldChlbCk7CiAgICBpZighdGhpcy5kcmFnRGF0YSl7CiAgICAgICAgdGhpcy5kcmFnRGF0YSA9IHt9OwogICAgfQogICAgCiAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKICAgIAogICAgaWYoIXRoaXMucHJveHkpewogICAgICAgIHRoaXMucHJveHkgPSBuZXcgRXh0LmRkLlN0YXR1c1Byb3h5KCk7CiAgICB9CiAgICBFeHQuZGQuRHJhZ1NvdXJjZS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgdGhpcy5lbC5kb20sIHRoaXMuZGRHcm91cCB8fCB0aGlzLmdyb3VwLCAKICAgICAgICAgIHtkcmFnRWxJZCA6IHRoaXMucHJveHkuaWQsIHJlc2l6ZUZyYW1lOiBmYWxzZSwgaXNUYXJnZXQ6IGZhbHNlLCBzY3JvbGw6IHRoaXMuc2Nyb2xsID09PSB0cnVlfSk7CiAgICAKICAgIHRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKfTsKCkV4dC5leHRlbmQoRXh0LmRkLkRyYWdTb3VyY2UsIEV4dC5kZC5ERFByb3h5LCB7CiAgICAKICAgIAogICAgZHJvcEFsbG93ZWQgOiAieC1kZC1kcm9wLW9rIiwKICAgIAogICAgZHJvcE5vdEFsbG93ZWQgOiAieC1kZC1kcm9wLW5vZHJvcCIsCgogICAgCiAgICBnZXREcmFnRGF0YSA6IGZ1bmN0aW9uKGUpewogICAgICAgIHJldHVybiB0aGlzLmRyYWdEYXRhOwogICAgfSwKCiAgICAKICAgIG9uRHJhZ0VudGVyIDogZnVuY3Rpb24oZSwgaWQpewogICAgICAgIHZhciB0YXJnZXQgPSBFeHQuZGQuRHJhZ0Ryb3BNZ3IuZ2V0RERCeUlkKGlkKTsKICAgICAgICB0aGlzLmNhY2hlZFRhcmdldCA9IHRhcmdldDsKICAgICAgICBpZih0aGlzLmJlZm9yZURyYWdFbnRlcih0YXJnZXQsIGUsIGlkKSAhPT0gZmFsc2UpewogICAgICAgICAgICBpZih0YXJnZXQuaXNOb3RpZnlUYXJnZXQpewogICAgICAgICAgICAgICAgdmFyIHN0YXR1cyA9IHRhcmdldC5ub3RpZnlFbnRlcih0aGlzLCBlLCB0aGlzLmRyYWdEYXRhKTsKICAgICAgICAgICAgICAgIHRoaXMucHJveHkuc2V0U3RhdHVzKHN0YXR1cyk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy5wcm94eS5zZXRTdGF0dXModGhpcy5kcm9wQWxsb3dlZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHRoaXMuYWZ0ZXJEcmFnRW50ZXIpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmFmdGVyRHJhZ0VudGVyKHRhcmdldCwgZSwgaWQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGJlZm9yZURyYWdFbnRlciA6IGZ1bmN0aW9uKHRhcmdldCwgZSwgaWQpewogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAKICAgIGFsaWduRWxXaXRoTW91c2U6IGZ1bmN0aW9uKCkgewogICAgICAgIEV4dC5kZC5EcmFnU291cmNlLnN1cGVyY2xhc3MuYWxpZ25FbFdpdGhNb3VzZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMucHJveHkuc3luYygpOwogICAgfSwKCiAgICAKICAgIG9uRHJhZ092ZXIgOiBmdW5jdGlvbihlLCBpZCl7CiAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMuY2FjaGVkVGFyZ2V0IHx8IEV4dC5kZC5EcmFnRHJvcE1nci5nZXREREJ5SWQoaWQpOwogICAgICAgIGlmKHRoaXMuYmVmb3JlRHJhZ092ZXIodGFyZ2V0LCBlLCBpZCkgIT09IGZhbHNlKXsKICAgICAgICAgICAgaWYodGFyZ2V0LmlzTm90aWZ5VGFyZ2V0KXsKICAgICAgICAgICAgICAgIHZhciBzdGF0dXMgPSB0YXJnZXQubm90aWZ5T3Zlcih0aGlzLCBlLCB0aGlzLmRyYWdEYXRhKTsKICAgICAgICAgICAgICAgIHRoaXMucHJveHkuc2V0U3RhdHVzKHN0YXR1cyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKHRoaXMuYWZ0ZXJEcmFnT3Zlcil7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuYWZ0ZXJEcmFnT3Zlcih0YXJnZXQsIGUsIGlkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBiZWZvcmVEcmFnT3ZlciA6IGZ1bmN0aW9uKHRhcmdldCwgZSwgaWQpewogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAKICAgIG9uRHJhZ091dCA6IGZ1bmN0aW9uKGUsIGlkKXsKICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcy5jYWNoZWRUYXJnZXQgfHwgRXh0LmRkLkRyYWdEcm9wTWdyLmdldEREQnlJZChpZCk7CiAgICAgICAgaWYodGhpcy5iZWZvcmVEcmFnT3V0KHRhcmdldCwgZSwgaWQpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIGlmKHRhcmdldC5pc05vdGlmeVRhcmdldCl7CiAgICAgICAgICAgICAgICB0YXJnZXQubm90aWZ5T3V0KHRoaXMsIGUsIHRoaXMuZHJhZ0RhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucHJveHkucmVzZXQoKTsKICAgICAgICAgICAgaWYodGhpcy5hZnRlckRyYWdPdXQpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmFmdGVyRHJhZ091dCh0YXJnZXQsIGUsIGlkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmNhY2hlZFRhcmdldCA9IG51bGw7CiAgICB9LAoKICAgIAogICAgYmVmb3JlRHJhZ091dCA6IGZ1bmN0aW9uKHRhcmdldCwgZSwgaWQpewogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIAogICAgCiAgICBvbkRyYWdEcm9wIDogZnVuY3Rpb24oZSwgaWQpewogICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLmNhY2hlZFRhcmdldCB8fCBFeHQuZGQuRHJhZ0Ryb3BNZ3IuZ2V0RERCeUlkKGlkKTsKICAgICAgICBpZih0aGlzLmJlZm9yZURyYWdEcm9wKHRhcmdldCwgZSwgaWQpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIGlmKHRhcmdldC5pc05vdGlmeVRhcmdldCl7CiAgICAgICAgICAgICAgICBpZih0YXJnZXQubm90aWZ5RHJvcCh0aGlzLCBlLCB0aGlzLmRyYWdEYXRhKSl7IAogICAgICAgICAgICAgICAgICAgIHRoaXMub25WYWxpZERyb3AodGFyZ2V0LCBlLCBpZCk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uSW52YWxpZERyb3AodGFyZ2V0LCBlLCBpZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy5vblZhbGlkRHJvcCh0YXJnZXQsIGUsIGlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYodGhpcy5hZnRlckRyYWdEcm9wKXsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5hZnRlckRyYWdEcm9wKHRhcmdldCwgZSwgaWQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGRlbGV0ZSB0aGlzLmNhY2hlZFRhcmdldDsKICAgIH0sCgogICAgCiAgICBiZWZvcmVEcmFnRHJvcCA6IGZ1bmN0aW9uKHRhcmdldCwgZSwgaWQpewogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAKICAgIG9uVmFsaWREcm9wIDogZnVuY3Rpb24odGFyZ2V0LCBlLCBpZCl7CiAgICAgICAgdGhpcy5oaWRlUHJveHkoKTsKICAgICAgICBpZih0aGlzLmFmdGVyVmFsaWREcm9wKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWZ0ZXJWYWxpZERyb3AodGFyZ2V0LCBlLCBpZCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldFJlcGFpclhZIDogZnVuY3Rpb24oZSwgZGF0YSl7CiAgICAgICAgcmV0dXJuIHRoaXMuZWwuZ2V0WFkoKTsgIAogICAgfSwKCiAgICAKICAgIG9uSW52YWxpZERyb3AgOiBmdW5jdGlvbih0YXJnZXQsIGUsIGlkKXsKICAgICAgICB0aGlzLmJlZm9yZUludmFsaWREcm9wKHRhcmdldCwgZSwgaWQpOwogICAgICAgIGlmKHRoaXMuY2FjaGVkVGFyZ2V0KXsKICAgICAgICAgICAgaWYodGhpcy5jYWNoZWRUYXJnZXQuaXNOb3RpZnlUYXJnZXQpewogICAgICAgICAgICAgICAgdGhpcy5jYWNoZWRUYXJnZXQubm90aWZ5T3V0KHRoaXMsIGUsIHRoaXMuZHJhZ0RhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY2FjaGVUYXJnZXQgPSBudWxsOwogICAgICAgIH0KICAgICAgICB0aGlzLnByb3h5LnJlcGFpcih0aGlzLmdldFJlcGFpclhZKGUsIHRoaXMuZHJhZ0RhdGEpLCB0aGlzLmFmdGVyUmVwYWlyLCB0aGlzKTsKCiAgICAgICAgaWYodGhpcy5hZnRlckludmFsaWREcm9wKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWZ0ZXJJbnZhbGlkRHJvcChlLCBpZCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFmdGVyUmVwYWlyIDogZnVuY3Rpb24oKXsKICAgICAgICBpZihFeHQuZW5hYmxlRngpewogICAgICAgICAgICB0aGlzLmVsLmhpZ2hsaWdodCh0aGlzLmhsQ29sb3IgfHwgImMzZGFmOSIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmRyYWdnaW5nID0gZmFsc2U7CiAgICB9LAoKICAgIAogICAgYmVmb3JlSW52YWxpZERyb3AgOiBmdW5jdGlvbih0YXJnZXQsIGUsIGlkKXsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgCiAgICBoYW5kbGVNb3VzZURvd24gOiBmdW5jdGlvbihlKXsKICAgICAgICBpZih0aGlzLmRyYWdnaW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmdldERyYWdEYXRhKGUpOwogICAgICAgIGlmKGRhdGEgJiYgdGhpcy5vbkJlZm9yZURyYWcoZGF0YSwgZSkgIT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5kcmFnRGF0YSA9IGRhdGE7CiAgICAgICAgICAgIHRoaXMucHJveHkuc3RvcCgpOwogICAgICAgICAgICBFeHQuZGQuRHJhZ1NvdXJjZS5zdXBlcmNsYXNzLmhhbmRsZU1vdXNlRG93bi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0gCiAgICB9LAoKICAgIAogICAgb25CZWZvcmVEcmFnIDogZnVuY3Rpb24oZGF0YSwgZSl7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIAogICAgb25TdGFydERyYWcgOiBFeHQuZW1wdHlGbiwKCiAgICAKICAgIHN0YXJ0RHJhZyA6IGZ1bmN0aW9uKHgsIHkpewogICAgICAgIHRoaXMucHJveHkucmVzZXQoKTsKICAgICAgICB0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLnByb3h5LnVwZGF0ZSgiIik7CiAgICAgICAgdGhpcy5vbkluaXREcmFnKHgsIHkpOwogICAgICAgIHRoaXMucHJveHkuc2hvdygpOwogICAgfSwKCiAgICAKICAgIG9uSW5pdERyYWcgOiBmdW5jdGlvbih4LCB5KXsKICAgICAgICB2YXIgY2xvbmUgPSB0aGlzLmVsLmRvbS5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgICAgY2xvbmUuaWQgPSBFeHQuaWQoKTsgCiAgICAgICAgdGhpcy5wcm94eS51cGRhdGUoY2xvbmUpOwogICAgICAgIHRoaXMub25TdGFydERyYWcoeCwgeSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIAogICAgZ2V0UHJveHkgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnByb3h5OyAgCiAgICB9LAoKICAgIAogICAgaGlkZVByb3h5IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnByb3h5LmhpZGUoKTsgIAogICAgICAgIHRoaXMucHJveHkucmVzZXQodHJ1ZSk7CiAgICAgICAgdGhpcy5kcmFnZ2luZyA9IGZhbHNlOwogICAgfSwKCiAgICAKICAgIHRyaWdnZXJDYWNoZVJlZnJlc2ggOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5kZC5ERE0ucmVmcmVzaENhY2hlKHRoaXMuZ3JvdXBzKTsKICAgIH0sCgogICAgCiAgICBiNEVuZERyYWc6IGZ1bmN0aW9uKGUpIHsKICAgIH0sCgogICAgCiAgICBlbmREcmFnIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy5vbkVuZERyYWcodGhpcy5kcmFnRGF0YSwgZSk7CiAgICB9LAoKICAgIAogICAgb25FbmREcmFnIDogZnVuY3Rpb24oZGF0YSwgZSl7CiAgICB9LAogICAgCiAgICAKICAgIGF1dG9PZmZzZXQgOiBmdW5jdGlvbih4LCB5KSB7CiAgICAgICAgdGhpcy5zZXREZWx0YSgtMTIsIC0yMCk7CiAgICB9LAogICAgCiAgICBkZXN0cm95OiBmdW5jdGlvbigpewogICAgICAgIEV4dC5kZC5EcmFnU291cmNlLnN1cGVyY2xhc3MuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIEV4dC5kZXN0cm95KHRoaXMucHJveHkpOwogICAgfQp9KTsKRXh0LmRkLkRyb3BUYXJnZXQgPSBFeHQuZXh0ZW5kKEV4dC5kZC5ERFRhcmdldCwgewogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGVsLCBjb25maWcpewogICAgICAgIHRoaXMuZWwgPSBFeHQuZ2V0KGVsKTsKICAgIAogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwogICAgCiAgICAgICAgaWYodGhpcy5jb250YWluZXJTY3JvbGwpewogICAgICAgICAgICBFeHQuZGQuU2Nyb2xsTWFuYWdlci5yZWdpc3Rlcih0aGlzLmVsKTsKICAgICAgICB9CiAgICAKICAgICAgICBFeHQuZGQuRHJvcFRhcmdldC5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgdGhpcy5lbC5kb20sIHRoaXMuZGRHcm91cCB8fCB0aGlzLmdyb3VwLCAKICAgICAgICAgICAgICB7aXNUYXJnZXQ6IHRydWV9KTsgICAgICAgIAogICAgfSwKICAgIAogICAgCiAgICAKICAgIAogICAgZHJvcEFsbG93ZWQgOiAieC1kZC1kcm9wLW9rIiwKICAgIAogICAgZHJvcE5vdEFsbG93ZWQgOiAieC1kZC1kcm9wLW5vZHJvcCIsCgogICAgCiAgICBpc1RhcmdldCA6IHRydWUsCgogICAgCiAgICBpc05vdGlmeVRhcmdldCA6IHRydWUsCgogICAgCiAgICBub3RpZnlFbnRlciA6IGZ1bmN0aW9uKGRkLCBlLCBkYXRhKXsKICAgICAgICBpZih0aGlzLm92ZXJDbGFzcyl7CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3ModGhpcy5vdmVyQ2xhc3MpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5kcm9wQWxsb3dlZDsKICAgIH0sCgogICAgCiAgICBub3RpZnlPdmVyIDogZnVuY3Rpb24oZGQsIGUsIGRhdGEpewogICAgICAgIHJldHVybiB0aGlzLmRyb3BBbGxvd2VkOwogICAgfSwKCiAgICAKICAgIG5vdGlmeU91dCA6IGZ1bmN0aW9uKGRkLCBlLCBkYXRhKXsKICAgICAgICBpZih0aGlzLm92ZXJDbGFzcyl7CiAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3ModGhpcy5vdmVyQ2xhc3MpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBub3RpZnlEcm9wIDogZnVuY3Rpb24oZGQsIGUsIGRhdGEpewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICAKICAgIGRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5kZC5Ecm9wVGFyZ2V0LnN1cGVyY2xhc3MuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIGlmKHRoaXMuY29udGFpbmVyU2Nyb2xsKXsKICAgICAgICAgICAgRXh0LmRkLlNjcm9sbE1hbmFnZXIudW5yZWdpc3Rlcih0aGlzLmVsKTsKICAgICAgICB9CiAgICB9Cn0pOwpFeHQuZGQuRHJhZ1pvbmUgPSBFeHQuZXh0ZW5kKEV4dC5kZC5EcmFnU291cmNlLCB7CiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oZWwsIGNvbmZpZyl7CiAgICAgICAgRXh0LmRkLkRyYWdab25lLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBlbCwgY29uZmlnKTsKICAgICAgICBpZih0aGlzLmNvbnRhaW5lclNjcm9sbCl7CiAgICAgICAgICAgIEV4dC5kZC5TY3JvbGxNYW5hZ2VyLnJlZ2lzdGVyKHRoaXMuZWwpOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgCiAgICAKCiAgICAKICAgIGdldERyYWdEYXRhIDogZnVuY3Rpb24oZSl7CiAgICAgICAgcmV0dXJuIEV4dC5kZC5SZWdpc3RyeS5nZXRIYW5kbGVGcm9tRXZlbnQoZSk7CiAgICB9LAogICAgCiAgICAKICAgIG9uSW5pdERyYWcgOiBmdW5jdGlvbih4LCB5KXsKICAgICAgICB0aGlzLnByb3h5LnVwZGF0ZSh0aGlzLmRyYWdEYXRhLmRkZWwuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICB0aGlzLm9uU3RhcnREcmFnKHgsIHkpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIAogICAgCiAgICBhZnRlclJlcGFpciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoRXh0LmVuYWJsZUZ4KXsKICAgICAgICAgICAgRXh0LkVsZW1lbnQuZmx5KHRoaXMuZHJhZ0RhdGEuZGRlbCkuaGlnaGxpZ2h0KHRoaXMuaGxDb2xvciB8fCAiYzNkYWY5Iik7CiAgICAgICAgfQogICAgICAgIHRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKICAgIH0sCgogICAgCiAgICBnZXRSZXBhaXJYWSA6IGZ1bmN0aW9uKGUpewogICAgICAgIHJldHVybiBFeHQuRWxlbWVudC5mbHkodGhpcy5kcmFnRGF0YS5kZGVsKS5nZXRYWSgpOyAgCiAgICB9LAogICAgCiAgICBkZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZGQuRHJhZ1pvbmUuc3VwZXJjbGFzcy5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgaWYodGhpcy5jb250YWluZXJTY3JvbGwpewogICAgICAgICAgICBFeHQuZGQuU2Nyb2xsTWFuYWdlci51bnJlZ2lzdGVyKHRoaXMuZWwpOwogICAgICAgIH0KICAgIH0KfSk7CkV4dC5kZC5Ecm9wWm9uZSA9IGZ1bmN0aW9uKGVsLCBjb25maWcpewogICAgRXh0LmRkLkRyb3Bab25lLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBlbCwgY29uZmlnKTsKfTsKCkV4dC5leHRlbmQoRXh0LmRkLkRyb3Bab25lLCBFeHQuZGQuRHJvcFRhcmdldCwgewogICAgCiAgICBnZXRUYXJnZXRGcm9tRXZlbnQgOiBmdW5jdGlvbihlKXsKICAgICAgICByZXR1cm4gRXh0LmRkLlJlZ2lzdHJ5LmdldFRhcmdldEZyb21FdmVudChlKTsKICAgIH0sCgogICAgCiAgICBvbk5vZGVFbnRlciA6IGZ1bmN0aW9uKG4sIGRkLCBlLCBkYXRhKXsKICAgICAgICAKICAgIH0sCgogICAgCiAgICBvbk5vZGVPdmVyIDogZnVuY3Rpb24obiwgZGQsIGUsIGRhdGEpewogICAgICAgIHJldHVybiB0aGlzLmRyb3BBbGxvd2VkOwogICAgfSwKCiAgICAKICAgIG9uTm9kZU91dCA6IGZ1bmN0aW9uKG4sIGRkLCBlLCBkYXRhKXsKICAgICAgICAKICAgIH0sCgogICAgCiAgICBvbk5vZGVEcm9wIDogZnVuY3Rpb24obiwgZGQsIGUsIGRhdGEpewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgCiAgICBvbkNvbnRhaW5lck92ZXIgOiBmdW5jdGlvbihkZCwgZSwgZGF0YSl7CiAgICAgICAgcmV0dXJuIHRoaXMuZHJvcE5vdEFsbG93ZWQ7CiAgICB9LAoKICAgIAogICAgb25Db250YWluZXJEcm9wIDogZnVuY3Rpb24oZGQsIGUsIGRhdGEpewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgCiAgICBub3RpZnlFbnRlciA6IGZ1bmN0aW9uKGRkLCBlLCBkYXRhKXsKICAgICAgICByZXR1cm4gdGhpcy5kcm9wTm90QWxsb3dlZDsKICAgIH0sCgogICAgCiAgICBub3RpZnlPdmVyIDogZnVuY3Rpb24oZGQsIGUsIGRhdGEpewogICAgICAgIHZhciBuID0gdGhpcy5nZXRUYXJnZXRGcm9tRXZlbnQoZSk7CiAgICAgICAgaWYoIW4peyAKICAgICAgICAgICAgaWYodGhpcy5sYXN0T3Zlck5vZGUpewogICAgICAgICAgICAgICAgdGhpcy5vbk5vZGVPdXQodGhpcy5sYXN0T3Zlck5vZGUsIGRkLCBlLCBkYXRhKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdE92ZXJOb2RlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5vbkNvbnRhaW5lck92ZXIoZGQsIGUsIGRhdGEpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmxhc3RPdmVyTm9kZSAhPSBuKXsKICAgICAgICAgICAgaWYodGhpcy5sYXN0T3Zlck5vZGUpewogICAgICAgICAgICAgICAgdGhpcy5vbk5vZGVPdXQodGhpcy5sYXN0T3Zlck5vZGUsIGRkLCBlLCBkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm9uTm9kZUVudGVyKG4sIGRkLCBlLCBkYXRhKTsKICAgICAgICAgICAgdGhpcy5sYXN0T3Zlck5vZGUgPSBuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5vbk5vZGVPdmVyKG4sIGRkLCBlLCBkYXRhKTsKICAgIH0sCgogICAgCiAgICBub3RpZnlPdXQgOiBmdW5jdGlvbihkZCwgZSwgZGF0YSl7CiAgICAgICAgaWYodGhpcy5sYXN0T3Zlck5vZGUpewogICAgICAgICAgICB0aGlzLm9uTm9kZU91dCh0aGlzLmxhc3RPdmVyTm9kZSwgZGQsIGUsIGRhdGEpOwogICAgICAgICAgICB0aGlzLmxhc3RPdmVyTm9kZSA9IG51bGw7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG5vdGlmeURyb3AgOiBmdW5jdGlvbihkZCwgZSwgZGF0YSl7CiAgICAgICAgaWYodGhpcy5sYXN0T3Zlck5vZGUpewogICAgICAgICAgICB0aGlzLm9uTm9kZU91dCh0aGlzLmxhc3RPdmVyTm9kZSwgZGQsIGUsIGRhdGEpOwogICAgICAgICAgICB0aGlzLmxhc3RPdmVyTm9kZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBuID0gdGhpcy5nZXRUYXJnZXRGcm9tRXZlbnQoZSk7CiAgICAgICAgcmV0dXJuIG4gPwogICAgICAgICAgICB0aGlzLm9uTm9kZURyb3AobiwgZGQsIGUsIGRhdGEpIDoKICAgICAgICAgICAgdGhpcy5vbkNvbnRhaW5lckRyb3AoZGQsIGUsIGRhdGEpOwogICAgfSwKCiAgICAKICAgIHRyaWdnZXJDYWNoZVJlZnJlc2ggOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5kZC5ERE0ucmVmcmVzaENhY2hlKHRoaXMuZ3JvdXBzKTsKICAgIH0gIAp9KTsKRXh0LkVsZW1lbnQuYWRkTWV0aG9kcyh7CiAgICAKICAgIGluaXRERCA6IGZ1bmN0aW9uKGdyb3VwLCBjb25maWcsIG92ZXJyaWRlcyl7CiAgICAgICAgdmFyIGRkID0gbmV3IEV4dC5kZC5ERChFeHQuaWQodGhpcy5kb20pLCBncm91cCwgY29uZmlnKTsKICAgICAgICByZXR1cm4gRXh0LmFwcGx5KGRkLCBvdmVycmlkZXMpOwogICAgfSwKCiAgICAKICAgIGluaXRERFByb3h5IDogZnVuY3Rpb24oZ3JvdXAsIGNvbmZpZywgb3ZlcnJpZGVzKXsKICAgICAgICB2YXIgZGQgPSBuZXcgRXh0LmRkLkREUHJveHkoRXh0LmlkKHRoaXMuZG9tKSwgZ3JvdXAsIGNvbmZpZyk7CiAgICAgICAgcmV0dXJuIEV4dC5hcHBseShkZCwgb3ZlcnJpZGVzKTsKICAgIH0sCgogICAgCiAgICBpbml0RERUYXJnZXQgOiBmdW5jdGlvbihncm91cCwgY29uZmlnLCBvdmVycmlkZXMpewogICAgICAgIHZhciBkZCA9IG5ldyBFeHQuZGQuRERUYXJnZXQoRXh0LmlkKHRoaXMuZG9tKSwgZ3JvdXAsIGNvbmZpZyk7CiAgICAgICAgcmV0dXJuIEV4dC5hcHBseShkZCwgb3ZlcnJpZGVzKTsKICAgIH0KfSk7CgpFeHQuZGF0YS5BcGkgPSAoZnVuY3Rpb24oKSB7CgogICAgCiAgICAKICAgIAogICAgCiAgICB2YXIgdmFsaWRBY3Rpb25zID0ge307CgogICAgcmV0dXJuIHsKICAgICAgICAKICAgICAgICBhY3Rpb25zIDogewogICAgICAgICAgICBjcmVhdGUgIDogJ2NyZWF0ZScsCiAgICAgICAgICAgIHJlYWQgICAgOiAncmVhZCcsCiAgICAgICAgICAgIHVwZGF0ZSAgOiAndXBkYXRlJywKICAgICAgICAgICAgZGVzdHJveSA6ICdkZXN0cm95JwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHJlc3RBY3Rpb25zIDogewogICAgICAgICAgICBjcmVhdGUgIDogJ1BPU1QnLAogICAgICAgICAgICByZWFkICAgIDogJ0dFVCcsCiAgICAgICAgICAgIHVwZGF0ZSAgOiAnUFVUJywKICAgICAgICAgICAgZGVzdHJveSA6ICdERUxFVEUnCiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaXNBY3Rpb24gOiBmdW5jdGlvbihhY3Rpb24pIHsKICAgICAgICAgICAgcmV0dXJuIChFeHQuZGF0YS5BcGkuYWN0aW9uc1thY3Rpb25dKSA/IHRydWUgOiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRWZXJiIDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAodmFsaWRBY3Rpb25zW25hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsaWRBY3Rpb25zW25hbWVdOyAgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgdmVyYiBpbiB0aGlzLmFjdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGlvbnNbdmVyYl0gPT09IG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZEFjdGlvbnNbbmFtZV0gPSB2ZXJiOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAodmFsaWRBY3Rpb25zW25hbWVdICE9PSB1bmRlZmluZWQpID8gdmFsaWRBY3Rpb25zW25hbWVdIDogbnVsbDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBpc1ZhbGlkIDogZnVuY3Rpb24oYXBpKXsKICAgICAgICAgICAgdmFyIGludmFsaWQgPSBbXTsKICAgICAgICAgICAgdmFyIGNydWQgPSB0aGlzLmFjdGlvbnM7IAogICAgICAgICAgICBmb3IgKHZhciBhY3Rpb24gaW4gYXBpKSB7CiAgICAgICAgICAgICAgICBpZiAoIShhY3Rpb24gaW4gY3J1ZCkpIHsKICAgICAgICAgICAgICAgICAgICBpbnZhbGlkLnB1c2goYWN0aW9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKCFpbnZhbGlkLmxlbmd0aCkgPyB0cnVlIDogaW52YWxpZDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBoYXNVbmlxdWVVcmwgOiBmdW5jdGlvbihwcm94eSwgdmVyYikgewogICAgICAgICAgICB2YXIgdXJsID0gKHByb3h5LmFwaVt2ZXJiXSkgPyBwcm94eS5hcGlbdmVyYl0udXJsIDogbnVsbDsKICAgICAgICAgICAgdmFyIHVuaXF1ZSA9IHRydWU7CiAgICAgICAgICAgIGZvciAodmFyIGFjdGlvbiBpbiBwcm94eS5hcGkpIHsKICAgICAgICAgICAgICAgIGlmICgodW5pcXVlID0gKGFjdGlvbiA9PT0gdmVyYikgPyB0cnVlIDogKHByb3h5LmFwaVthY3Rpb25dLnVybCAhPSB1cmwpID8gdHJ1ZSA6IGZhbHNlKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdW5pcXVlOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHByZXBhcmUgOiBmdW5jdGlvbihwcm94eSkgewogICAgICAgICAgICBpZiAoIXByb3h5LmFwaSkgewogICAgICAgICAgICAgICAgcHJveHkuYXBpID0ge307IAogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIHZlcmIgaW4gdGhpcy5hY3Rpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gdGhpcy5hY3Rpb25zW3ZlcmJdOwogICAgICAgICAgICAgICAgcHJveHkuYXBpW2FjdGlvbl0gPSBwcm94eS5hcGlbYWN0aW9uXSB8fCBwcm94eS51cmwgfHwgcHJveHkuZGlyZWN0Rm47CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mKHByb3h5LmFwaVthY3Rpb25dKSA9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHByb3h5LmFwaVthY3Rpb25dID0gewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHByb3h5LmFwaVthY3Rpb25dLAogICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IChwcm94eS5yZXN0ZnVsID09PSB0cnVlKSA/IEV4dC5kYXRhLkFwaS5yZXN0QWN0aW9uc1thY3Rpb25dIDogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHJlc3RpZnkgOiBmdW5jdGlvbihwcm94eSkgewogICAgICAgICAgICBwcm94eS5yZXN0ZnVsID0gdHJ1ZTsKICAgICAgICAgICAgZm9yICh2YXIgdmVyYiBpbiB0aGlzLnJlc3RBY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBwcm94eS5hcGlbdGhpcy5hY3Rpb25zW3ZlcmJdXS5tZXRob2QgfHwKICAgICAgICAgICAgICAgICAgICAocHJveHkuYXBpW3RoaXMuYWN0aW9uc1t2ZXJiXV0ubWV0aG9kID0gdGhpcy5yZXN0QWN0aW9uc1t2ZXJiXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBwcm94eS5vbldyaXRlID0gcHJveHkub25Xcml0ZS5jcmVhdGVJbnRlcmNlcHRvcihmdW5jdGlvbihhY3Rpb24sIG8sIHJlc3BvbnNlLCBycykgewogICAgICAgICAgICAgICAgdmFyIHJlYWRlciA9IG8ucmVhZGVyOwogICAgICAgICAgICAgICAgdmFyIHJlcyA9IG5ldyBFeHQuZGF0YS5SZXNwb25zZSh7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiBhY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgcmF3OiByZXNwb25zZQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgc3dpdGNoIChyZXNwb25zZS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIDIwMDogICAKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMjAxOiAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoRXh0LmlzRW1wdHkocmVzLnJhdy5yZXNwb25zZVRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzLnN1Y2Nlc3MgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMjA0OiAgCiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5zdWNjZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzLmRhdGEgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmVzLnN1Y2Nlc3MgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgid3JpdGUiLCB0aGlzLCBhY3Rpb24sIHJlcy5kYXRhLCByZXMsIHJzLCBvLnJlcXVlc3QuYXJnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2V4Y2VwdGlvbicsIHRoaXMsICdyZW1vdGUnLCBhY3Rpb24sIG8sIHJlcywgcnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgby5yZXF1ZXN0LmNhbGxiYWNrLmNhbGwoby5yZXF1ZXN0LnNjb3BlLCByZXMuZGF0YSwgcmVzLCByZXMuc3VjY2Vzcyk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAgIAogICAgICAgICAgICB9LCBwcm94eSk7CiAgICAgICAgfQogICAgfTsKfSkoKTsKCgpFeHQuZGF0YS5SZXNwb25zZSA9IGZ1bmN0aW9uKHBhcmFtcywgcmVzcG9uc2UpIHsKICAgIEV4dC5hcHBseSh0aGlzLCBwYXJhbXMsIHsKICAgICAgICByYXc6IHJlc3BvbnNlCiAgICB9KTsKfTsKRXh0LmRhdGEuUmVzcG9uc2UucHJvdG90eXBlID0gewogICAgbWVzc2FnZSA6IG51bGwsCiAgICBzdWNjZXNzIDogZmFsc2UsCiAgICBzdGF0dXMgOiBudWxsLAogICAgcm9vdCA6IG51bGwsCiAgICByYXcgOiBudWxsLAoKICAgIGdldE1lc3NhZ2UgOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5tZXNzYWdlOwogICAgfSwKICAgIGdldFN1Y2Nlc3MgOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdWNjZXNzOwogICAgfSwKICAgIGdldFN0YXR1cyA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0YXR1czsKICAgIH0sCiAgICBnZXRSb290IDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucm9vdDsKICAgIH0sCiAgICBnZXRSYXdSZXNwb25zZSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnJhdzsKICAgIH0KfTsKCgpFeHQuZGF0YS5BcGkuRXJyb3IgPSBFeHQuZXh0ZW5kKEV4dC5FcnJvciwgewogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihtZXNzYWdlLCBhcmcpIHsKICAgICAgICB0aGlzLmFyZyA9IGFyZzsKICAgICAgICBFeHQuRXJyb3IuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgIH0sCiAgICBuYW1lOiAnRXh0LmRhdGEuQXBpJwp9KTsKRXh0LmFwcGx5KEV4dC5kYXRhLkFwaS5FcnJvci5wcm90b3R5cGUsIHsKICAgIGxhbmc6IHsKICAgICAgICAnYWN0aW9uLXVybC11bmRlZmluZWQnOiAnTm8gZmFsbGJhY2sgdXJsIGRlZmluZWQgZm9yIHRoaXMgYWN0aW9uLiAgV2hlbiBkZWZpbmluZyBhIERhdGFQcm94eSBhcGksIHBsZWFzZSBiZSBzdXJlIHRvIGRlZmluZSBhbiB1cmwgZm9yIGVhY2ggQ1JVRCBhY3Rpb24gaW4gRXh0LmRhdGEuQXBpLmFjdGlvbnMgb3IgZGVmaW5lIGEgZGVmYXVsdCB1cmwgaW4gYWRkaXRpb24gdG8geW91ciBhcGktY29uZmlndXJhdGlvbi4nLAogICAgICAgICdpbnZhbGlkJzogJ3JlY2VpdmVkIGFuIGludmFsaWQgQVBJLWNvbmZpZ3VyYXRpb24uICBQbGVhc2UgZW5zdXJlIHlvdXIgcHJveHkgQVBJLWNvbmZpZ3VyYXRpb24gY29udGFpbnMgb25seSB0aGUgYWN0aW9ucyBkZWZpbmVkIGluIEV4dC5kYXRhLkFwaS5hY3Rpb25zJywKICAgICAgICAnaW52YWxpZC11cmwnOiAnSW52YWxpZCB1cmwuICBQbGVhc2UgcmV2aWV3IHlvdXIgcHJveHkgY29uZmlndXJhdGlvbi4nLAogICAgICAgICdleGVjdXRlJzogJ0F0dGVtcHRlZCB0byBleGVjdXRlIGFuIHVua25vd24gYWN0aW9uLiAgVmFsaWQgQVBJIGFjdGlvbnMgYXJlIGRlZmluZWQgaW4gRXh0LmRhdGEuQXBpLmFjdGlvbnMiJwogICAgfQp9KTsKCgoKCkV4dC5kYXRhLlNvcnRUeXBlcyA9IHsKICAgIAogICAgbm9uZSA6IGZ1bmN0aW9uKHMpewogICAgICAgIHJldHVybiBzOwogICAgfSwKICAgIAogICAgCiAgICBzdHJpcFRhZ3NSRSA6IC88XC8/W14+XSs+L2dpLAogICAgCiAgICAKICAgIGFzVGV4dCA6IGZ1bmN0aW9uKHMpewogICAgICAgIHJldHVybiBTdHJpbmcocykucmVwbGFjZSh0aGlzLnN0cmlwVGFnc1JFLCAiIik7CiAgICB9LAogICAgCiAgICAKICAgIGFzVUNUZXh0IDogZnVuY3Rpb24ocyl7CiAgICAgICAgcmV0dXJuIFN0cmluZyhzKS50b1VwcGVyQ2FzZSgpLnJlcGxhY2UodGhpcy5zdHJpcFRhZ3NSRSwgIiIpOwogICAgfSwKICAgIAogICAgCiAgICBhc1VDU3RyaW5nIDogZnVuY3Rpb24ocykgewogICAgCXJldHVybiBTdHJpbmcocykudG9VcHBlckNhc2UoKTsKICAgIH0sCiAgICAKICAgIAogICAgYXNEYXRlIDogZnVuY3Rpb24ocykgewogICAgICAgIGlmKCFzKXsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGlmKEV4dC5pc0RhdGUocykpewogICAgICAgICAgICByZXR1cm4gcy5nZXRUaW1lKCk7CiAgICAgICAgfQogICAgCXJldHVybiBEYXRlLnBhcnNlKFN0cmluZyhzKSk7CiAgICB9LAogICAgCiAgICAKICAgIGFzRmxvYXQgOiBmdW5jdGlvbihzKSB7CiAgICAJdmFyIHZhbCA9IHBhcnNlRmxvYXQoU3RyaW5nKHMpLnJlcGxhY2UoLywvZywgIiIpKTsKICAgIAlyZXR1cm4gaXNOYU4odmFsKSA/IDAgOiB2YWw7CiAgICB9LAogICAgCiAgICAKICAgIGFzSW50IDogZnVuY3Rpb24ocykgewogICAgICAgIHZhciB2YWwgPSBwYXJzZUludChTdHJpbmcocykucmVwbGFjZSgvLC9nLCAiIiksIDEwKTsKICAgICAgICByZXR1cm4gaXNOYU4odmFsKSA/IDAgOiB2YWw7CiAgICB9Cn07CkV4dC5kYXRhLlJlY29yZCA9IGZ1bmN0aW9uKGRhdGEsIGlkKXsKICAgIAogICAgdGhpcy5pZCA9IChpZCB8fCBpZCA9PT0gMCkgPyBpZCA6IEV4dC5kYXRhLlJlY29yZC5pZCh0aGlzKTsKICAgIHRoaXMuZGF0YSA9IGRhdGEgfHwge307Cn07CgoKRXh0LmRhdGEuUmVjb3JkLmNyZWF0ZSA9IGZ1bmN0aW9uKG8pewogICAgdmFyIGYgPSBFeHQuZXh0ZW5kKEV4dC5kYXRhLlJlY29yZCwge30pOwogICAgdmFyIHAgPSBmLnByb3RvdHlwZTsKICAgIHAuZmllbGRzID0gbmV3IEV4dC51dGlsLk1peGVkQ29sbGVjdGlvbihmYWxzZSwgZnVuY3Rpb24oZmllbGQpewogICAgICAgIHJldHVybiBmaWVsZC5uYW1lOwogICAgfSk7CiAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBvLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICBwLmZpZWxkcy5hZGQobmV3IEV4dC5kYXRhLkZpZWxkKG9baV0pKTsKICAgIH0KICAgIGYuZ2V0RmllbGQgPSBmdW5jdGlvbihuYW1lKXsKICAgICAgICByZXR1cm4gcC5maWVsZHMuZ2V0KG5hbWUpOwogICAgfTsKICAgIHJldHVybiBmOwp9OwoKRXh0LmRhdGEuUmVjb3JkLlBSRUZJWCA9ICdleHQtcmVjb3JkJzsKRXh0LmRhdGEuUmVjb3JkLkFVVE9fSUQgPSAxOwpFeHQuZGF0YS5SZWNvcmQuRURJVCA9ICdlZGl0JzsKRXh0LmRhdGEuUmVjb3JkLlJFSkVDVCA9ICdyZWplY3QnOwpFeHQuZGF0YS5SZWNvcmQuQ09NTUlUID0gJ2NvbW1pdCc7CgoKCkV4dC5kYXRhLlJlY29yZC5pZCA9IGZ1bmN0aW9uKHJlYykgewogICAgcmVjLnBoYW50b20gPSB0cnVlOwogICAgcmV0dXJuIFtFeHQuZGF0YS5SZWNvcmQuUFJFRklYLCAnLScsIEV4dC5kYXRhLlJlY29yZC5BVVRPX0lEKytdLmpvaW4oJycpOwp9OwoKRXh0LmRhdGEuUmVjb3JkLnByb3RvdHlwZSA9IHsKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIGRpcnR5IDogZmFsc2UsCiAgICBlZGl0aW5nIDogZmFsc2UsCiAgICBlcnJvciA6IG51bGwsCiAgICAKICAgIG1vZGlmaWVkIDogbnVsbCwKICAgIAogICAgcGhhbnRvbSA6IGZhbHNlLAoKICAgIAogICAgam9pbiA6IGZ1bmN0aW9uKHN0b3JlKXsKICAgICAgICAKICAgICAgICB0aGlzLnN0b3JlID0gc3RvcmU7CiAgICB9LAoKICAgIAogICAgc2V0IDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICAgIHZhciBlbmNvZGUgPSBFeHQuaXNQcmltaXRpdmUodmFsdWUpID8gU3RyaW5nIDogRXh0LmVuY29kZTsKICAgICAgICBpZihlbmNvZGUodGhpcy5kYXRhW25hbWVdKSA9PSBlbmNvZGUodmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9ICAgICAgICAKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgICAgICBpZighdGhpcy5tb2RpZmllZCl7CiAgICAgICAgICAgIHRoaXMubW9kaWZpZWQgPSB7fTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5tb2RpZmllZFtuYW1lXSA9PT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgdGhpcy5tb2RpZmllZFtuYW1lXSA9IHRoaXMuZGF0YVtuYW1lXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5kYXRhW25hbWVdID0gdmFsdWU7CiAgICAgICAgaWYoIXRoaXMuZWRpdGluZyl7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJFZGl0KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFmdGVyRWRpdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMuc3RvcmUgIT0gdW5kZWZpbmVkICYmIHR5cGVvZiB0aGlzLnN0b3JlLmFmdGVyRWRpdCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMuc3RvcmUuYWZ0ZXJFZGl0KHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhZnRlclJlamVjdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5zdG9yZSl7CiAgICAgICAgICAgIHRoaXMuc3RvcmUuYWZ0ZXJSZWplY3QodGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFmdGVyQ29tbWl0IDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnN0b3JlKXsKICAgICAgICAgICAgdGhpcy5zdG9yZS5hZnRlckNvbW1pdCh0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0IDogZnVuY3Rpb24obmFtZSl7CiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVtuYW1lXTsKICAgIH0sCgogICAgCiAgICBiZWdpbkVkaXQgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZWRpdGluZyA9IHRydWU7CiAgICAgICAgdGhpcy5tb2RpZmllZCA9IHRoaXMubW9kaWZpZWQgfHwge307CiAgICB9LAoKICAgIAogICAgY2FuY2VsRWRpdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5lZGl0aW5nID0gZmFsc2U7CiAgICAgICAgZGVsZXRlIHRoaXMubW9kaWZpZWQ7CiAgICB9LAoKICAgIAogICAgZW5kRWRpdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5lZGl0aW5nID0gZmFsc2U7CiAgICAgICAgaWYodGhpcy5kaXJ0eSl7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJFZGl0KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHJlamVjdCA6IGZ1bmN0aW9uKHNpbGVudCl7CiAgICAgICAgdmFyIG0gPSB0aGlzLm1vZGlmaWVkOwogICAgICAgIGZvcih2YXIgbiBpbiBtKXsKICAgICAgICAgICAgaWYodHlwZW9mIG1bbl0gIT0gImZ1bmN0aW9uIil7CiAgICAgICAgICAgICAgICB0aGlzLmRhdGFbbl0gPSBtW25dOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICBkZWxldGUgdGhpcy5tb2RpZmllZDsKICAgICAgICB0aGlzLmVkaXRpbmcgPSBmYWxzZTsKICAgICAgICBpZihzaWxlbnQgIT09IHRydWUpewogICAgICAgICAgICB0aGlzLmFmdGVyUmVqZWN0KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNvbW1pdCA6IGZ1bmN0aW9uKHNpbGVudCl7CiAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgIGRlbGV0ZSB0aGlzLm1vZGlmaWVkOwogICAgICAgIHRoaXMuZWRpdGluZyA9IGZhbHNlOwogICAgICAgIGlmKHNpbGVudCAhPT0gdHJ1ZSl7CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJDb21taXQoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0Q2hhbmdlcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG0gPSB0aGlzLm1vZGlmaWVkLCBjcyA9IHt9OwogICAgICAgIGZvcih2YXIgbiBpbiBtKXsKICAgICAgICAgICAgaWYobS5oYXNPd25Qcm9wZXJ0eShuKSl7CiAgICAgICAgICAgICAgICBjc1tuXSA9IHRoaXMuZGF0YVtuXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY3M7CiAgICB9LAoKICAgIAogICAgaGFzRXJyb3IgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmVycm9yICE9PSBudWxsOwogICAgfSwKCiAgICAKICAgIGNsZWFyRXJyb3IgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZXJyb3IgPSBudWxsOwogICAgfSwKCiAgICAKICAgIGNvcHkgOiBmdW5jdGlvbihuZXdJZCkgewogICAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3RvcihFeHQuYXBwbHkoe30sIHRoaXMuZGF0YSksIG5ld0lkIHx8IHRoaXMuaWQpOwogICAgfSwKCiAgICAKICAgIGlzTW9kaWZpZWQgOiBmdW5jdGlvbihmaWVsZE5hbWUpewogICAgICAgIHJldHVybiAhISh0aGlzLm1vZGlmaWVkICYmIHRoaXMubW9kaWZpZWQuaGFzT3duUHJvcGVydHkoZmllbGROYW1lKSk7CiAgICB9LAoKICAgIAogICAgaXNWYWxpZCA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmZpZWxkcy5maW5kKGZ1bmN0aW9uKGYpIHsKICAgICAgICAgICAgcmV0dXJuIChmLmFsbG93QmxhbmsgPT09IGZhbHNlICYmIEV4dC5pc0VtcHR5KHRoaXMuZGF0YVtmLm5hbWVdKSkgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgfSx0aGlzKSA/IGZhbHNlIDogdHJ1ZTsKICAgIH0sCgogICAgCiAgICBtYXJrRGlydHkgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIGlmKCF0aGlzLm1vZGlmaWVkKXsKICAgICAgICAgICAgdGhpcy5tb2RpZmllZCA9IHt9OwogICAgICAgIH0KICAgICAgICB0aGlzLmZpZWxkcy5lYWNoKGZ1bmN0aW9uKGYpIHsKICAgICAgICAgICAgdGhpcy5tb2RpZmllZFtmLm5hbWVdID0gdGhpcy5kYXRhW2YubmFtZV07CiAgICAgICAgfSx0aGlzKTsKICAgIH0KfTsKCkV4dC5TdG9yZU1nciA9IEV4dC5hcHBseShuZXcgRXh0LnV0aWwuTWl4ZWRDb2xsZWN0aW9uKCksIHsKICAgIAoKICAgIAogICAgcmVnaXN0ZXIgOiBmdW5jdGlvbigpewogICAgICAgIGZvcih2YXIgaSA9IDAsIHM7IChzID0gYXJndW1lbnRzW2ldKTsgaSsrKXsKICAgICAgICAgICAgdGhpcy5hZGQocyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHVucmVnaXN0ZXIgOiBmdW5jdGlvbigpewogICAgICAgIGZvcih2YXIgaSA9IDAsIHM7IChzID0gYXJndW1lbnRzW2ldKTsgaSsrKXsKICAgICAgICAgICAgdGhpcy5yZW1vdmUodGhpcy5sb29rdXAocykpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBsb29rdXAgOiBmdW5jdGlvbihpZCl7CiAgICAgICAgaWYoRXh0LmlzQXJyYXkoaWQpKXsKICAgICAgICAgICAgdmFyIGZpZWxkcyA9IFsnZmllbGQxJ10sIGV4cGFuZCA9ICFFeHQuaXNBcnJheShpZFswXSk7CiAgICAgICAgICAgIGlmKCFleHBhbmQpewogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMiwgbGVuID0gaWRbMF0ubGVuZ3RoOyBpIDw9IGxlbjsgKytpKXsKICAgICAgICAgICAgICAgICAgICBmaWVsZHMucHVzaCgnZmllbGQnICsgaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBFeHQuZGF0YS5BcnJheVN0b3JlKHsKICAgICAgICAgICAgICAgIGZpZWxkczogZmllbGRzLAogICAgICAgICAgICAgICAgZGF0YTogaWQsCiAgICAgICAgICAgICAgICBleHBhbmREYXRhOiBleHBhbmQsCiAgICAgICAgICAgICAgICBhdXRvRGVzdHJveTogdHJ1ZSwKICAgICAgICAgICAgICAgIGF1dG9DcmVhdGVkOiB0cnVlCgogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEV4dC5pc09iamVjdChpZCkgPyAoaWQuZXZlbnRzID8gaWQgOiBFeHQuY3JlYXRlKGlkLCAnc3RvcmUnKSkgOiB0aGlzLmdldChpZCk7CiAgICB9LAoKICAgIAogICAgZ2V0S2V5IDogZnVuY3Rpb24obyl7CiAgICAgICAgIHJldHVybiBvLnN0b3JlSWQ7CiAgICB9Cn0pOwpFeHQuZGF0YS5TdG9yZSA9IEV4dC5leHRlbmQoRXh0LnV0aWwuT2JzZXJ2YWJsZSwgewogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICB3cml0ZXIgOiB1bmRlZmluZWQsCiAgICAKICAgIAogICAgCiAgICByZW1vdGVTb3J0IDogZmFsc2UsCgogICAgCiAgICBhdXRvRGVzdHJveSA6IGZhbHNlLAoKICAgIAogICAgcHJ1bmVNb2RpZmllZFJlY29yZHMgOiBmYWxzZSwKCiAgICAKICAgIGxhc3RPcHRpb25zIDogbnVsbCwKCiAgICAKICAgIGF1dG9TYXZlIDogdHJ1ZSwKCiAgICAKICAgIGJhdGNoIDogdHJ1ZSwKCiAgICAKICAgIHJlc3RmdWw6IGZhbHNlLAoKICAgIAogICAgcGFyYW1OYW1lcyA6IHVuZGVmaW5lZCwKCiAgICAKICAgIGRlZmF1bHRQYXJhbU5hbWVzIDogewogICAgICAgIHN0YXJ0IDogJ3N0YXJ0JywKICAgICAgICBsaW1pdCA6ICdsaW1pdCcsCiAgICAgICAgc29ydCA6ICdzb3J0JywKICAgICAgICBkaXIgOiAnZGlyJwogICAgfSwKCiAgICBpc0Rlc3Ryb3llZDogZmFsc2UsICAgIAogICAgaGFzTXVsdGlTb3J0OiBmYWxzZSwKCiAgICAKICAgIGJhdGNoS2V5IDogJ19leHRfYmF0Y2hfJywKCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGNvbmZpZyl7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdGhpcy5kYXRhID0gbmV3IEV4dC51dGlsLk1peGVkQ29sbGVjdGlvbihmYWxzZSk7CiAgICAgICAgdGhpcy5kYXRhLmdldEtleSA9IGZ1bmN0aW9uKG8pewogICAgICAgICAgICByZXR1cm4gby5pZDsKICAgICAgICB9OwogICAgICAgIAoKICAgICAgICAKICAgICAgICB0aGlzLnJlbW92ZWQgPSBbXTsKCiAgICAgICAgaWYoY29uZmlnICYmIGNvbmZpZy5kYXRhKXsKICAgICAgICAgICAgdGhpcy5pbmxpbmVEYXRhID0gY29uZmlnLmRhdGE7CiAgICAgICAgICAgIGRlbGV0ZSBjb25maWcuZGF0YTsKICAgICAgICB9CgogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwoKICAgICAgICAKICAgICAgICB0aGlzLmJhc2VQYXJhbXMgPSBFeHQuaXNPYmplY3QodGhpcy5iYXNlUGFyYW1zKSA/IHRoaXMuYmFzZVBhcmFtcyA6IHt9OwoKICAgICAgICB0aGlzLnBhcmFtTmFtZXMgPSBFeHQuYXBwbHlJZih0aGlzLnBhcmFtTmFtZXMgfHwge30sIHRoaXMuZGVmYXVsdFBhcmFtTmFtZXMpOwoKICAgICAgICBpZigodGhpcy51cmwgfHwgdGhpcy5hcGkpICYmICF0aGlzLnByb3h5KXsKICAgICAgICAgICAgdGhpcy5wcm94eSA9IG5ldyBFeHQuZGF0YS5IdHRwUHJveHkoe3VybDogdGhpcy51cmwsIGFwaTogdGhpcy5hcGl9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMucmVzdGZ1bCA9PT0gdHJ1ZSAmJiB0aGlzLnByb3h5KSB7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5iYXRjaCA9IGZhbHNlOwogICAgICAgICAgICBFeHQuZGF0YS5BcGkucmVzdGlmeSh0aGlzLnByb3h5KTsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMucmVhZGVyKXsgCiAgICAgICAgICAgIGlmKCF0aGlzLnJlY29yZFR5cGUpewogICAgICAgICAgICAgICAgdGhpcy5yZWNvcmRUeXBlID0gdGhpcy5yZWFkZXIucmVjb3JkVHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLnJlYWRlci5vbk1ldGFDaGFuZ2UpewogICAgICAgICAgICAgICAgdGhpcy5yZWFkZXIub25NZXRhQ2hhbmdlID0gdGhpcy5yZWFkZXIub25NZXRhQ2hhbmdlLmNyZWF0ZVNlcXVlbmNlKHRoaXMub25NZXRhQ2hhbmdlLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy53cml0ZXIpIHsgCiAgICAgICAgICAgICAgICBpZiAodGhpcy53cml0ZXIgaW5zdGFuY2VvZihFeHQuZGF0YS5EYXRhV3JpdGVyKSA9PT0gZmFsc2UpIHsgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy53cml0ZXIgPSB0aGlzLmJ1aWxkV3JpdGVyKHRoaXMud3JpdGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMud3JpdGVyLm1ldGEgPSB0aGlzLnJlYWRlci5tZXRhOwogICAgICAgICAgICAgICAgdGhpcy5wcnVuZU1vZGlmaWVkUmVjb3JkcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIAoKICAgICAgICBpZih0aGlzLnJlY29yZFR5cGUpewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5maWVsZHMgPSB0aGlzLnJlY29yZFR5cGUucHJvdG90eXBlLmZpZWxkczsKICAgICAgICB9CiAgICAgICAgdGhpcy5tb2RpZmllZCA9IFtdOwoKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICdkYXRhY2hhbmdlZCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAnbWV0YWNoYW5nZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYWRkJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdyZW1vdmUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ3VwZGF0ZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnY2xlYXInLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2V4Y2VwdGlvbicsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYmVmb3JlbG9hZCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAnbG9hZCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAnbG9hZGV4Y2VwdGlvbicsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYmVmb3Jld3JpdGUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ3dyaXRlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVzYXZlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdzYXZlJwoKICAgICAgICApOwoKICAgICAgICBpZih0aGlzLnByb3h5KXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucmVsYXlFdmVudHModGhpcy5wcm94eSwgIFsnbG9hZGV4Y2VwdGlvbicsICdleGNlcHRpb24nXSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLndyaXRlcikgewogICAgICAgICAgICB0aGlzLm9uKHsKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgYWRkOiB0aGlzLmNyZWF0ZVJlY29yZHMsCiAgICAgICAgICAgICAgICByZW1vdmU6IHRoaXMuZGVzdHJveVJlY29yZCwKICAgICAgICAgICAgICAgIHVwZGF0ZTogdGhpcy51cGRhdGVSZWNvcmQsCiAgICAgICAgICAgICAgICBjbGVhcjogdGhpcy5vbkNsZWFyCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zb3J0VG9nZ2xlID0ge307CiAgICAgICAgaWYodGhpcy5zb3J0RmllbGQpewogICAgICAgICAgICB0aGlzLnNldERlZmF1bHRTb3J0KHRoaXMuc29ydEZpZWxkLCB0aGlzLnNvcnREaXIpOwogICAgICAgIH1lbHNlIGlmKHRoaXMuc29ydEluZm8pewogICAgICAgICAgICB0aGlzLnNldERlZmF1bHRTb3J0KHRoaXMuc29ydEluZm8uZmllbGQsIHRoaXMuc29ydEluZm8uZGlyZWN0aW9uKTsKICAgICAgICB9CgogICAgICAgIEV4dC5kYXRhLlN0b3JlLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsKCiAgICAgICAgaWYodGhpcy5pZCl7CiAgICAgICAgICAgIHRoaXMuc3RvcmVJZCA9IHRoaXMuaWQ7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmlkOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnN0b3JlSWQpewogICAgICAgICAgICBFeHQuU3RvcmVNZ3IucmVnaXN0ZXIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuaW5saW5lRGF0YSl7CiAgICAgICAgICAgIHRoaXMubG9hZERhdGEodGhpcy5pbmxpbmVEYXRhKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuaW5saW5lRGF0YTsKICAgICAgICB9ZWxzZSBpZih0aGlzLmF1dG9Mb2FkKXsKICAgICAgICAgICAgdGhpcy5sb2FkLmRlZmVyKDEwLCB0aGlzLCBbCiAgICAgICAgICAgICAgICB0eXBlb2YgdGhpcy5hdXRvTG9hZCA9PSAnb2JqZWN0JyA/CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdXRvTG9hZCA6IHVuZGVmaW5lZF0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLmJhdGNoQ291bnRlciA9IDA7CiAgICAgICAgdGhpcy5iYXRjaGVzID0ge307CiAgICB9LAoKICAgIAogICAgYnVpbGRXcml0ZXIgOiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICB2YXIga2xhc3MgPSB1bmRlZmluZWQsCiAgICAgICAgICAgIHR5cGUgPSAoY29uZmlnLmZvcm1hdCB8fCAnanNvbicpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgJ2pzb24nOgogICAgICAgICAgICAgICAga2xhc3MgPSBFeHQuZGF0YS5Kc29uV3JpdGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3htbCc6CiAgICAgICAgICAgICAgICBrbGFzcyA9IEV4dC5kYXRhLlhtbFdyaXRlcjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAga2xhc3MgPSBFeHQuZGF0YS5Kc29uV3JpdGVyOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IGtsYXNzKGNvbmZpZyk7CiAgICB9LAoKICAgIAogICAgZGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMuaXNEZXN0cm95ZWQpewogICAgICAgICAgICBpZih0aGlzLnN0b3JlSWQpewogICAgICAgICAgICAgICAgRXh0LlN0b3JlTWdyLnVucmVnaXN0ZXIodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jbGVhckRhdGEoKTsKICAgICAgICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy5wcm94eSk7CiAgICAgICAgICAgIHRoaXMucmVhZGVyID0gdGhpcy53cml0ZXIgPSBudWxsOwogICAgICAgICAgICB0aGlzLnB1cmdlTGlzdGVuZXJzKCk7CiAgICAgICAgICAgIHRoaXMuaXNEZXN0cm95ZWQgPSB0cnVlOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhZGQgOiBmdW5jdGlvbihyZWNvcmRzKSB7CiAgICAgICAgdmFyIGksIGxlbiwgcmVjb3JkLCBpbmRleDsKICAgICAgICAKICAgICAgICByZWNvcmRzID0gW10uY29uY2F0KHJlY29yZHMpOwogICAgICAgIGlmIChyZWNvcmRzLmxlbmd0aCA8IDEpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSByZWNvcmRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHJlY29yZCA9IHJlY29yZHNbaV07CiAgICAgICAgICAgIAogICAgICAgICAgICByZWNvcmQuam9pbih0aGlzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChyZWNvcmQuZGlydHkgfHwgcmVjb3JkLnBoYW50b20pIHsKICAgICAgICAgICAgICAgIHRoaXMubW9kaWZpZWQucHVzaChyZWNvcmQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGluZGV4ID0gdGhpcy5kYXRhLmxlbmd0aDsKICAgICAgICB0aGlzLmRhdGEuYWRkQWxsKHJlY29yZHMpOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLnNuYXBzaG90KSB7CiAgICAgICAgICAgIHRoaXMuc25hcHNob3QuYWRkQWxsKHJlY29yZHMpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLmZpcmVFdmVudCgnYWRkJywgdGhpcywgcmVjb3JkcywgaW5kZXgpOwogICAgfSwKCiAgICAKICAgIGFkZFNvcnRlZCA6IGZ1bmN0aW9uKHJlY29yZCl7CiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5maW5kSW5zZXJ0SW5kZXgocmVjb3JkKTsKICAgICAgICB0aGlzLmluc2VydChpbmRleCwgcmVjb3JkKTsKICAgIH0sCiAgICAKICAgIAogICAgZG9VcGRhdGU6IGZ1bmN0aW9uKHJlYyl7CiAgICAgICAgdmFyIGlkID0gcmVjLmlkOwogICAgICAgIAogICAgICAgIHRoaXMuZ2V0QnlJZChpZCkuam9pbihudWxsKTsKICAgICAgICAKICAgICAgICB0aGlzLmRhdGEucmVwbGFjZShpZCwgcmVjKTsKICAgICAgICBpZiAodGhpcy5zbmFwc2hvdCkgewogICAgICAgICAgICB0aGlzLnNuYXBzaG90LnJlcGxhY2UoaWQsIHJlYyk7CiAgICAgICAgfQogICAgICAgIHJlYy5qb2luKHRoaXMpOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCd1cGRhdGUnLCB0aGlzLCByZWMsIEV4dC5kYXRhLlJlY29yZC5DT01NSVQpOwogICAgfSwKCiAgICAKICAgIHJlbW92ZSA6IGZ1bmN0aW9uKHJlY29yZCl7CiAgICAgICAgaWYoRXh0LmlzQXJyYXkocmVjb3JkKSl7CiAgICAgICAgICAgIEV4dC5lYWNoKHJlY29yZCwgZnVuY3Rpb24ocil7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZShyKTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5kYXRhLmluZGV4T2YocmVjb3JkKTsKICAgICAgICBpZihpbmRleCA+IC0xKXsKICAgICAgICAgICAgcmVjb3JkLmpvaW4obnVsbCk7CiAgICAgICAgICAgIHRoaXMuZGF0YS5yZW1vdmVBdChpbmRleCk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMucHJ1bmVNb2RpZmllZFJlY29yZHMpewogICAgICAgICAgICB0aGlzLm1vZGlmaWVkLnJlbW92ZShyZWNvcmQpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnNuYXBzaG90KXsKICAgICAgICAgICAgdGhpcy5zbmFwc2hvdC5yZW1vdmUocmVjb3JkKTsKICAgICAgICB9CiAgICAgICAgaWYoaW5kZXggPiAtMSl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdyZW1vdmUnLCB0aGlzLCByZWNvcmQsIGluZGV4KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVtb3ZlQXQgOiBmdW5jdGlvbihpbmRleCl7CiAgICAgICAgdGhpcy5yZW1vdmUodGhpcy5nZXRBdChpbmRleCkpOwogICAgfSwKCiAgICAKICAgIHJlbW92ZUFsbCA6IGZ1bmN0aW9uKHNpbGVudCl7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKHJlYyl7CiAgICAgICAgICAgIGl0ZW1zLnB1c2gocmVjKTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLmNsZWFyRGF0YSgpOwogICAgICAgIGlmKHRoaXMuc25hcHNob3QpewogICAgICAgICAgICB0aGlzLnNuYXBzaG90LmNsZWFyKCk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMucHJ1bmVNb2RpZmllZFJlY29yZHMpewogICAgICAgICAgICB0aGlzLm1vZGlmaWVkID0gW107CiAgICAgICAgfQogICAgICAgIGlmIChzaWxlbnQgIT09IHRydWUpIHsgIAogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnY2xlYXInLCB0aGlzLCBpdGVtcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uQ2xlYXI6IGZ1bmN0aW9uKHN0b3JlLCByZWNvcmRzKXsKICAgICAgICBFeHQuZWFjaChyZWNvcmRzLCBmdW5jdGlvbihyZWMsIGluZGV4KXsKICAgICAgICAgICAgdGhpcy5kZXN0cm95UmVjb3JkKHRoaXMsIHJlYywgaW5kZXgpOwogICAgICAgIH0sIHRoaXMpOwogICAgfSwKCiAgICAKICAgIGluc2VydCA6IGZ1bmN0aW9uKGluZGV4LCByZWNvcmRzKSB7CiAgICAgICAgdmFyIGksIGxlbiwgcmVjb3JkOwogICAgICAgIAogICAgICAgIHJlY29yZHMgPSBbXS5jb25jYXQocmVjb3Jkcyk7CiAgICAgICAgZm9yIChpID0gMCwgbGVuID0gcmVjb3Jkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICByZWNvcmQgPSByZWNvcmRzW2ldOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kYXRhLmluc2VydChpbmRleCArIGksIHJlY29yZCk7CiAgICAgICAgICAgIHJlY29yZC5qb2luKHRoaXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHJlY29yZC5kaXJ0eSB8fCByZWNvcmQucGhhbnRvbSkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RpZmllZC5wdXNoKHJlY29yZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuc25hcHNob3QpIHsKICAgICAgICAgICAgdGhpcy5zbmFwc2hvdC5hZGRBbGwocmVjb3Jkcyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdhZGQnLCB0aGlzLCByZWNvcmRzLCBpbmRleCk7CiAgICB9LAoKICAgIAogICAgaW5kZXhPZiA6IGZ1bmN0aW9uKHJlY29yZCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YS5pbmRleE9mKHJlY29yZCk7CiAgICB9LAoKICAgIAogICAgaW5kZXhPZklkIDogZnVuY3Rpb24oaWQpewogICAgICAgIHJldHVybiB0aGlzLmRhdGEuaW5kZXhPZktleShpZCk7CiAgICB9LAoKICAgIAogICAgZ2V0QnlJZCA6IGZ1bmN0aW9uKGlkKXsKICAgICAgICByZXR1cm4gKHRoaXMuc25hcHNob3QgfHwgdGhpcy5kYXRhKS5rZXkoaWQpOwogICAgfSwKCiAgICAKICAgIGdldEF0IDogZnVuY3Rpb24oaW5kZXgpewogICAgICAgIHJldHVybiB0aGlzLmRhdGEuaXRlbUF0KGluZGV4KTsKICAgIH0sCgogICAgCiAgICBnZXRSYW5nZSA6IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpewogICAgICAgIHJldHVybiB0aGlzLmRhdGEuZ2V0UmFuZ2Uoc3RhcnQsIGVuZCk7CiAgICB9LAoKICAgIAogICAgc3RvcmVPcHRpb25zIDogZnVuY3Rpb24obyl7CiAgICAgICAgbyA9IEV4dC5hcHBseSh7fSwgbyk7CiAgICAgICAgZGVsZXRlIG8uY2FsbGJhY2s7CiAgICAgICAgZGVsZXRlIG8uc2NvcGU7CiAgICAgICAgdGhpcy5sYXN0T3B0aW9ucyA9IG87CiAgICB9LAoKICAgIAogICAgY2xlYXJEYXRhOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZGF0YS5lYWNoKGZ1bmN0aW9uKHJlYykgewogICAgICAgICAgICByZWMuam9pbihudWxsKTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLmRhdGEuY2xlYXIoKTsKICAgIH0sCgogICAgCiAgICBsb2FkIDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBFeHQuYXBwbHkoe30sIG9wdGlvbnMpOwogICAgICAgIHRoaXMuc3RvcmVPcHRpb25zKG9wdGlvbnMpOwogICAgICAgIGlmKHRoaXMuc29ydEluZm8gJiYgdGhpcy5yZW1vdGVTb3J0KXsKICAgICAgICAgICAgdmFyIHBuID0gdGhpcy5wYXJhbU5hbWVzOwogICAgICAgICAgICBvcHRpb25zLnBhcmFtcyA9IEV4dC5hcHBseSh7fSwgb3B0aW9ucy5wYXJhbXMpOwogICAgICAgICAgICBvcHRpb25zLnBhcmFtc1twbi5zb3J0XSA9IHRoaXMuc29ydEluZm8uZmllbGQ7CiAgICAgICAgICAgIG9wdGlvbnMucGFyYW1zW3BuLmRpcl0gPSB0aGlzLnNvcnRJbmZvLmRpcmVjdGlvbjsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXhlY3V0ZSgncmVhZCcsIG51bGwsIG9wdGlvbnMpOyAKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgdGhpcy5oYW5kbGVFeGNlcHRpb24oZSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdXBkYXRlUmVjb3JkIDogZnVuY3Rpb24oc3RvcmUsIHJlY29yZCwgYWN0aW9uKSB7CiAgICAgICAgaWYgKGFjdGlvbiA9PSBFeHQuZGF0YS5SZWNvcmQuRURJVCAmJiB0aGlzLmF1dG9TYXZlID09PSB0cnVlICYmICghcmVjb3JkLnBoYW50b20gfHwgKHJlY29yZC5waGFudG9tICYmIHJlY29yZC5pc1ZhbGlkKCkpKSkgewogICAgICAgICAgICB0aGlzLnNhdmUoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgY3JlYXRlUmVjb3JkcyA6IGZ1bmN0aW9uKHN0b3JlLCByZWNvcmRzLCBpbmRleCkgewogICAgICAgIHZhciBtb2RpZmllZCA9IHRoaXMubW9kaWZpZWQsCiAgICAgICAgICAgIGxlbmd0aCAgID0gcmVjb3Jkcy5sZW5ndGgsCiAgICAgICAgICAgIHJlY29yZCwgaTsKICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgcmVjb3JkID0gcmVjb3Jkc1tpXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChyZWNvcmQucGhhbnRvbSAmJiByZWNvcmQuaXNWYWxpZCgpKSB7CiAgICAgICAgICAgICAgICByZWNvcmQubWFya0RpcnR5KCk7ICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKG1vZGlmaWVkLmluZGV4T2YocmVjb3JkKSA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgIG1vZGlmaWVkLnB1c2gocmVjb3JkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5hdXRvU2F2ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLnNhdmUoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZGVzdHJveVJlY29yZCA6IGZ1bmN0aW9uKHN0b3JlLCByZWNvcmQsIGluZGV4KSB7CiAgICAgICAgaWYgKHRoaXMubW9kaWZpZWQuaW5kZXhPZihyZWNvcmQpICE9IC0xKSB7ICAKICAgICAgICAgICAgdGhpcy5tb2RpZmllZC5yZW1vdmUocmVjb3JkKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFyZWNvcmQucGhhbnRvbSkgewogICAgICAgICAgICB0aGlzLnJlbW92ZWQucHVzaChyZWNvcmQpOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgcmVjb3JkLmxhc3RJbmRleCA9IGluZGV4OwoKICAgICAgICAgICAgaWYgKHRoaXMuYXV0b1NhdmUgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGV4ZWN1dGUgOiBmdW5jdGlvbihhY3Rpb24sIHJzLCBvcHRpb25zLCAgYmF0Y2gpIHsKICAgICAgICAKICAgICAgICBpZiAoIUV4dC5kYXRhLkFwaS5pc0FjdGlvbihhY3Rpb24pKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFeHQuZGF0YS5BcGkuRXJyb3IoJ2V4ZWN1dGUnLCBhY3Rpb24pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBvcHRpb25zID0gRXh0LmFwcGx5SWYob3B0aW9uc3x8e30sIHsKICAgICAgICAgICAgcGFyYW1zOiB7fQogICAgICAgIH0pOwogICAgICAgIGlmKGJhdGNoICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICB0aGlzLmFkZFRvQmF0Y2goYmF0Y2gpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAKICAgICAgICB2YXIgZG9SZXF1ZXN0ID0gdHJ1ZTsKCiAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ3JlYWQnKSB7CiAgICAgICAgICAgIGRvUmVxdWVzdCA9IHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVsb2FkJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgICAgIEV4dC5hcHBseUlmKG9wdGlvbnMucGFyYW1zLCB0aGlzLmJhc2VQYXJhbXMpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy53cml0ZXIubGlzdGZ1bCA9PT0gdHJ1ZSAmJiB0aGlzLnJlc3RmdWwgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHJzID0gKEV4dC5pc0FycmF5KHJzKSkgPyBycyA6IFtyc107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2UgaWYgKEV4dC5pc0FycmF5KHJzKSAmJiBycy5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgcnMgPSBycy5zaGlmdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoKGRvUmVxdWVzdCA9IHRoaXMuZmlyZUV2ZW50KCdiZWZvcmV3cml0ZScsIHRoaXMsIGFjdGlvbiwgcnMsIG9wdGlvbnMpKSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMud3JpdGVyLmFwcGx5KG9wdGlvbnMucGFyYW1zLCB0aGlzLmJhc2VQYXJhbXMsIGFjdGlvbiwgcnMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkb1JlcXVlc3QgIT09IGZhbHNlKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy53cml0ZXIgJiYgdGhpcy5wcm94eS51cmwgJiYgIXRoaXMucHJveHkucmVzdGZ1bCAmJiAhRXh0LmRhdGEuQXBpLmhhc1VuaXF1ZVVybCh0aGlzLnByb3h5LCBhY3Rpb24pKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLnBhcmFtcy54YWN0aW9uID0gYWN0aW9uOyAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucHJveHkucmVxdWVzdChFeHQuZGF0YS5BcGkuYWN0aW9uc1thY3Rpb25dLCBycywgb3B0aW9ucy5wYXJhbXMsIHRoaXMucmVhZGVyLCB0aGlzLmNyZWF0ZUNhbGxiYWNrKGFjdGlvbiwgcnMsIGJhdGNoKSwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkb1JlcXVlc3Q7CiAgICB9LAoKICAgIAogICAgc2F2ZSA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy53cml0ZXIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEV4dC5kYXRhLlN0b3JlLkVycm9yKCd3cml0ZXItdW5kZWZpbmVkJyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcXVldWUgPSBbXSwKICAgICAgICAgICAgbGVuLAogICAgICAgICAgICB0cmFucywKICAgICAgICAgICAgYmF0Y2gsCiAgICAgICAgICAgIGRhdGEgPSB7fSwKICAgICAgICAgICAgaTsKICAgICAgICAKICAgICAgICBpZih0aGlzLnJlbW92ZWQubGVuZ3RoKXsKICAgICAgICAgICAgcXVldWUucHVzaChbJ2Rlc3Ryb3knLCB0aGlzLnJlbW92ZWRdKTsKICAgICAgICB9CgogICAgICAgIAogICAgICAgIHZhciBycyA9IFtdLmNvbmNhdCh0aGlzLmdldE1vZGlmaWVkUmVjb3JkcygpKTsKICAgICAgICBpZihycy5sZW5ndGgpewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHBoYW50b21zID0gW107CiAgICAgICAgICAgIGZvcihpID0gcnMubGVuZ3RoLTE7IGkgPj0gMDsgaS0tKXsKICAgICAgICAgICAgICAgIGlmKHJzW2ldLnBoYW50b20gPT09IHRydWUpewogICAgICAgICAgICAgICAgICAgIHZhciByZWMgPSBycy5zcGxpY2UoaSwgMSkuc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICBpZihyZWMuaXNWYWxpZCgpKXsKICAgICAgICAgICAgICAgICAgICAgICAgcGhhbnRvbXMucHVzaChyZWMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKCFyc1tpXS5pc1ZhbGlkKCkpeyAKICAgICAgICAgICAgICAgICAgICBycy5zcGxpY2UoaSwxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYocGhhbnRvbXMubGVuZ3RoKXsKICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goWydjcmVhdGUnLCBwaGFudG9tc10pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYocnMubGVuZ3RoKXsKICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goWyd1cGRhdGUnLCByc10pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxlbiA9IHF1ZXVlLmxlbmd0aDsKICAgICAgICBpZihsZW4pewogICAgICAgICAgICBiYXRjaCA9ICsrdGhpcy5iYXRjaENvdW50ZXI7CiAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IGxlbjsgKytpKXsKICAgICAgICAgICAgICAgIHRyYW5zID0gcXVldWVbaV07CiAgICAgICAgICAgICAgICBkYXRhW3RyYW5zWzBdXSA9IHRyYW5zWzFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVzYXZlJywgdGhpcywgZGF0YSkgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IGxlbjsgKytpKXsKICAgICAgICAgICAgICAgICAgICB0cmFucyA9IHF1ZXVlW2ldOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZG9UcmFuc2FjdGlvbih0cmFuc1swXSwgdHJhbnNbMV0sIGJhdGNoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBiYXRjaDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9LAoKICAgIAogICAgZG9UcmFuc2FjdGlvbiA6IGZ1bmN0aW9uKGFjdGlvbiwgcnMsIGJhdGNoKSB7CiAgICAgICAgZnVuY3Rpb24gdHJhbnNhY3Rpb24ocmVjb3JkcykgewogICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGUoYWN0aW9uLCByZWNvcmRzLCB1bmRlZmluZWQsIGJhdGNoKTsKICAgICAgICAgICAgfWNhdGNoIChlKXsKICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlRXhjZXB0aW9uKGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuYmF0Y2ggPT09IGZhbHNlKXsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gcnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgdHJhbnNhY3Rpb24uY2FsbCh0aGlzLCByc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdHJhbnNhY3Rpb24uY2FsbCh0aGlzLCBycyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFkZFRvQmF0Y2ggOiBmdW5jdGlvbihiYXRjaCl7CiAgICAgICAgdmFyIGIgPSB0aGlzLmJhdGNoZXMsCiAgICAgICAgICAgIGtleSA9IHRoaXMuYmF0Y2hLZXkgKyBiYXRjaCwKICAgICAgICAgICAgbyA9IGJba2V5XTsKCiAgICAgICAgaWYoIW8pewogICAgICAgICAgICBiW2tleV0gPSBvID0gewogICAgICAgICAgICAgICAgaWQ6IGJhdGNoLAogICAgICAgICAgICAgICAgY291bnQ6IDAsCiAgICAgICAgICAgICAgICBkYXRhOiB7fQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICArK28uY291bnQ7CiAgICB9LAoKICAgIHJlbW92ZUZyb21CYXRjaCA6IGZ1bmN0aW9uKGJhdGNoLCBhY3Rpb24sIGRhdGEpewogICAgICAgIHZhciBiID0gdGhpcy5iYXRjaGVzLAogICAgICAgICAgICBrZXkgPSB0aGlzLmJhdGNoS2V5ICsgYmF0Y2gsCiAgICAgICAgICAgIG8gPSBiW2tleV0sCiAgICAgICAgICAgIGFycjsKCgogICAgICAgIGlmKG8pewogICAgICAgICAgICBhcnIgPSBvLmRhdGFbYWN0aW9uXSB8fCBbXTsKICAgICAgICAgICAgby5kYXRhW2FjdGlvbl0gPSBhcnIuY29uY2F0KGRhdGEpOwogICAgICAgICAgICBpZihvLmNvdW50ID09PSAxKXsKICAgICAgICAgICAgICAgIGRhdGEgPSBvLmRhdGE7CiAgICAgICAgICAgICAgICBkZWxldGUgYltrZXldOwogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3NhdmUnLCB0aGlzLCBiYXRjaCwgZGF0YSk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgLS1vLmNvdW50OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIAogICAgY3JlYXRlQ2FsbGJhY2sgOiBmdW5jdGlvbihhY3Rpb24sIHJzLCBiYXRjaCkgewogICAgICAgIHZhciBhY3Rpb25zID0gRXh0LmRhdGEuQXBpLmFjdGlvbnM7CiAgICAgICAgcmV0dXJuIChhY3Rpb24gPT0gJ3JlYWQnKSA/IHRoaXMubG9hZFJlY29yZHMgOiBmdW5jdGlvbihkYXRhLCByZXNwb25zZSwgc3VjY2VzcykgewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpc1snb24nICsgRXh0LnV0aWwuRm9ybWF0LmNhcGl0YWxpemUoYWN0aW9uKSArICdSZWNvcmRzJ10oc3VjY2VzcywgcnMsIFtdLmNvbmNhdChkYXRhKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoc3VjY2VzcyA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3dyaXRlJywgdGhpcywgYWN0aW9uLCBkYXRhLCByZXNwb25zZSwgcnMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucmVtb3ZlRnJvbUJhdGNoKGJhdGNoLCBhY3Rpb24sIGRhdGEpOwogICAgICAgIH07CiAgICB9LAoKICAgIAogICAgCiAgICAKICAgIGNsZWFyTW9kaWZpZWQgOiBmdW5jdGlvbihycykgewogICAgICAgIGlmIChFeHQuaXNBcnJheShycykpIHsKICAgICAgICAgICAgZm9yICh2YXIgbj1ycy5sZW5ndGgtMTtuPj0wO24tLSkgewogICAgICAgICAgICAgICAgdGhpcy5tb2RpZmllZC5zcGxpY2UodGhpcy5tb2RpZmllZC5pbmRleE9mKHJzW25dKSwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLm1vZGlmaWVkLnNwbGljZSh0aGlzLm1vZGlmaWVkLmluZGV4T2YocnMpLCAxKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVNYXAgOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgICBpZiAoRXh0LmlzQXJyYXkocmVjb3JkKSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gcmVjb3JkLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlTWFwKHJlY29yZFtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkZWxldGUgdGhpcy5kYXRhLm1hcFtyZWNvcmQuX3BoaWRdOwogICAgICAgICAgICB0aGlzLmRhdGEubWFwW3JlY29yZC5pZF0gPSByZWNvcmQ7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuZGF0YS5rZXlzLmluZGV4T2YocmVjb3JkLl9waGlkKTsKICAgICAgICAgICAgdGhpcy5kYXRhLmtleXMuc3BsaWNlKGluZGV4LCAxLCByZWNvcmQuaWQpOwogICAgICAgICAgICBkZWxldGUgcmVjb3JkLl9waGlkOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkNyZWF0ZVJlY29yZHMgOiBmdW5jdGlvbihzdWNjZXNzLCBycywgZGF0YSkgewogICAgICAgIGlmIChzdWNjZXNzID09PSB0cnVlKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlYWRlci5yZWFsaXplKHJzLCBkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVFeGNlcHRpb24oZSk7CiAgICAgICAgICAgICAgICBpZiAoRXh0LmlzQXJyYXkocnMpKSB7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkNyZWF0ZVJlY29yZHMoc3VjY2VzcywgcnMsIGRhdGEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uVXBkYXRlUmVjb3JkcyA6IGZ1bmN0aW9uKHN1Y2Nlc3MsIHJzLCBkYXRhKSB7CiAgICAgICAgaWYgKHN1Y2Nlc3MgPT09IHRydWUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRoaXMucmVhZGVyLnVwZGF0ZShycywgZGF0YSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlRXhjZXB0aW9uKGUpOwogICAgICAgICAgICAgICAgaWYgKEV4dC5pc0FycmF5KHJzKSkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHRoaXMub25VcGRhdGVSZWNvcmRzKHN1Y2Nlc3MsIHJzLCBkYXRhKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkRlc3Ryb3lSZWNvcmRzIDogZnVuY3Rpb24oc3VjY2VzcywgcnMsIGRhdGEpIHsKICAgICAgICAKICAgICAgICBycyA9IChycyBpbnN0YW5jZW9mIEV4dC5kYXRhLlJlY29yZCkgPyBbcnNdIDogW10uY29uY2F0KHJzKTsKICAgICAgICBmb3IgKHZhciBpPTAsbGVuPXJzLmxlbmd0aDtpPGxlbjtpKyspIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVkLnNwbGljZSh0aGlzLnJlbW92ZWQuaW5kZXhPZihyc1tpXSksIDEpOwogICAgICAgIH0KICAgICAgICBpZiAoc3VjY2VzcyA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGk9cnMubGVuZ3RoLTE7aT49MDtpLS0pIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5zZXJ0KHJzW2ldLmxhc3RJbmRleCwgcnNbaV0pOyAgICAKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBoYW5kbGVFeGNlcHRpb24gOiBmdW5jdGlvbihlKSB7CiAgICAgICAgCiAgICAgICAgRXh0LmhhbmRsZUVycm9yKGUpOwogICAgfSwKCiAgICAKICAgIHJlbG9hZCA6IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgICAgIHRoaXMubG9hZChFeHQuYXBwbHlJZihvcHRpb25zfHx7fSwgdGhpcy5sYXN0T3B0aW9ucykpOwogICAgfSwKCiAgICAKICAgIAogICAgbG9hZFJlY29yZHMgOiBmdW5jdGlvbihvLCBvcHRpb25zLCBzdWNjZXNzKXsKICAgICAgICB2YXIgaSwgbGVuOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkID09PSB0cnVlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYoIW8gfHwgc3VjY2VzcyA9PT0gZmFsc2UpewogICAgICAgICAgICBpZihzdWNjZXNzICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnbG9hZCcsIHRoaXMsIFtdLCBvcHRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHRpb25zLmNhbGxiYWNrKXsKICAgICAgICAgICAgICAgIG9wdGlvbnMuY2FsbGJhY2suY2FsbChvcHRpb25zLnNjb3BlIHx8IHRoaXMsIFtdLCBvcHRpb25zLCBmYWxzZSwgbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgciA9IG8ucmVjb3JkcywgdCA9IG8udG90YWxSZWNvcmRzIHx8IHIubGVuZ3RoOwogICAgICAgIGlmKCFvcHRpb25zIHx8IG9wdGlvbnMuYWRkICE9PSB0cnVlKXsKICAgICAgICAgICAgaWYodGhpcy5wcnVuZU1vZGlmaWVkUmVjb3Jkcyl7CiAgICAgICAgICAgICAgICB0aGlzLm1vZGlmaWVkID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKGkgPSAwLCBsZW4gPSByLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIHJbaV0uam9pbih0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLnNuYXBzaG90KXsKICAgICAgICAgICAgICAgIHRoaXMuZGF0YSA9IHRoaXMuc25hcHNob3Q7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zbmFwc2hvdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNsZWFyRGF0YSgpOwogICAgICAgICAgICB0aGlzLmRhdGEuYWRkQWxsKHIpOwogICAgICAgICAgICB0aGlzLnRvdGFsTGVuZ3RoID0gdDsKICAgICAgICAgICAgdGhpcy5hcHBseVNvcnQoKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2RhdGFjaGFuZ2VkJywgdGhpcyk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHZhciB0b0FkZCA9IFtdLAogICAgICAgICAgICAgICAgcmVjLAogICAgICAgICAgICAgICAgY250ID0gMDsKICAgICAgICAgICAgZm9yKGkgPSAwLCBsZW4gPSByLmxlbmd0aDsgaSA8IGxlbjsgKytpKXsKICAgICAgICAgICAgICAgIHJlYyA9IHJbaV07CiAgICAgICAgICAgICAgICBpZih0aGlzLmluZGV4T2ZJZChyZWMuaWQpID4gLTEpewogICAgICAgICAgICAgICAgICAgIHRoaXMuZG9VcGRhdGUocmVjKTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIHRvQWRkLnB1c2gocmVjKTsKICAgICAgICAgICAgICAgICAgICArK2NudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnRvdGFsTGVuZ3RoID0gTWF0aC5tYXgodCwgdGhpcy5kYXRhLmxlbmd0aCArIGNudCk7CiAgICAgICAgICAgIHRoaXMuYWRkKHRvQWRkKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2xvYWQnLCB0aGlzLCByLCBvcHRpb25zKTsKICAgICAgICBpZihvcHRpb25zLmNhbGxiYWNrKXsKICAgICAgICAgICAgb3B0aW9ucy5jYWxsYmFjay5jYWxsKG9wdGlvbnMuc2NvcGUgfHwgdGhpcywgciwgb3B0aW9ucywgdHJ1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGxvYWREYXRhIDogZnVuY3Rpb24obywgYXBwZW5kKXsKICAgICAgICB2YXIgciA9IHRoaXMucmVhZGVyLnJlYWRSZWNvcmRzKG8pOwogICAgICAgIHRoaXMubG9hZFJlY29yZHMociwge2FkZDogYXBwZW5kfSwgdHJ1ZSk7CiAgICB9LAoKICAgIAogICAgZ2V0Q291bnQgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmRhdGEubGVuZ3RoIHx8IDA7CiAgICB9LAoKICAgIAogICAgZ2V0VG90YWxDb3VudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMudG90YWxMZW5ndGggfHwgMDsKICAgIH0sCgogICAgCiAgICBnZXRTb3J0U3RhdGUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnNvcnRJbmZvOwogICAgfSwKCiAgICAKICAgIGFwcGx5U29ydCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKCh0aGlzLnNvcnRJbmZvIHx8IHRoaXMubXVsdGlTb3J0SW5mbykgJiYgIXRoaXMucmVtb3RlU29ydCkgewogICAgICAgICAgICB0aGlzLnNvcnREYXRhKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNvcnREYXRhIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNvcnRJbmZvICA9IHRoaXMuaGFzTXVsdGlTb3J0ID8gdGhpcy5tdWx0aVNvcnRJbmZvIDogdGhpcy5zb3J0SW5mbywKICAgICAgICAgICAgZGlyZWN0aW9uID0gc29ydEluZm8uZGlyZWN0aW9uIHx8ICJBU0MiLAogICAgICAgICAgICBzb3J0ZXJzICAgPSBzb3J0SW5mby5zb3J0ZXJzLAogICAgICAgICAgICBzb3J0Rm5zICAgPSBbXTsKCiAgICAgICAgCiAgICAgICAgaWYgKCF0aGlzLmhhc011bHRpU29ydCkgewogICAgICAgICAgICBzb3J0ZXJzID0gW3tkaXJlY3Rpb246IGRpcmVjdGlvbiwgZmllbGQ6IHNvcnRJbmZvLmZpZWxkfV07CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBmb3IgKHZhciBpPTAsIGogPSBzb3J0ZXJzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICBzb3J0Rm5zLnB1c2godGhpcy5jcmVhdGVTb3J0RnVuY3Rpb24oc29ydGVyc1tpXS5maWVsZCwgc29ydGVyc1tpXS5kaXJlY3Rpb24pKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHNvcnRGbnMubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdmFyIGRpcmVjdGlvbk1vZGlmaWVyID0gZGlyZWN0aW9uLnRvVXBwZXJDYXNlKCkgPT0gIkRFU0MiID8gLTEgOiAxOwoKICAgICAgICAKICAgICAgICB2YXIgZm4gPSBmdW5jdGlvbihyMSwgcjIpIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBzb3J0Rm5zWzBdLmNhbGwodGhpcywgcjEsIHIyKTsKCiAgICAgICAgICAKICAgICAgICAgIGlmIChzb3J0Rm5zLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpPTEsIGogPSBzb3J0Rm5zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQgfHwgc29ydEZuc1tpXS5jYWxsKHRoaXMsIHIxLCByMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBkaXJlY3Rpb25Nb2RpZmllciAqIHJlc3VsdDsKICAgICAgICB9OwoKICAgICAgICAKICAgICAgICB0aGlzLmRhdGEuc29ydChkaXJlY3Rpb24sIGZuKTsKICAgICAgICBpZiAodGhpcy5zbmFwc2hvdCAmJiB0aGlzLnNuYXBzaG90ICE9IHRoaXMuZGF0YSkgewogICAgICAgICAgICB0aGlzLnNuYXBzaG90LnNvcnQoZGlyZWN0aW9uLCBmbik7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNyZWF0ZVNvcnRGdW5jdGlvbjogZnVuY3Rpb24oZmllbGQsIGRpcmVjdGlvbikgewogICAgICAgIGRpcmVjdGlvbiA9IGRpcmVjdGlvbiB8fCAiQVNDIjsKICAgICAgICB2YXIgZGlyZWN0aW9uTW9kaWZpZXIgPSBkaXJlY3Rpb24udG9VcHBlckNhc2UoKSA9PSAiREVTQyIgPyAtMSA6IDE7CgogICAgICAgIHZhciBzb3J0VHlwZSA9IHRoaXMuZmllbGRzLmdldChmaWVsZCkuc29ydFR5cGU7CgogICAgICAgIAogICAgICAgIAogICAgICAgIHJldHVybiBmdW5jdGlvbihyMSwgcjIpIHsKICAgICAgICAgICAgdmFyIHYxID0gc29ydFR5cGUocjEuZGF0YVtmaWVsZF0pLAogICAgICAgICAgICAgICAgdjIgPSBzb3J0VHlwZShyMi5kYXRhW2ZpZWxkXSk7CgogICAgICAgICAgICByZXR1cm4gZGlyZWN0aW9uTW9kaWZpZXIgKiAodjEgPiB2MiA/IDEgOiAodjEgPCB2MiA/IC0xIDogMCkpOwogICAgICAgIH07CiAgICB9LAoKICAgIAogICAgc2V0RGVmYXVsdFNvcnQgOiBmdW5jdGlvbihmaWVsZCwgZGlyKSB7CiAgICAgICAgZGlyID0gZGlyID8gZGlyLnRvVXBwZXJDYXNlKCkgOiAnQVNDJzsKICAgICAgICB0aGlzLnNvcnRJbmZvID0ge2ZpZWxkOiBmaWVsZCwgZGlyZWN0aW9uOiBkaXJ9OwogICAgICAgIHRoaXMuc29ydFRvZ2dsZVtmaWVsZF0gPSBkaXI7CiAgICB9LAoKICAgIAogICAgc29ydCA6IGZ1bmN0aW9uKGZpZWxkTmFtZSwgZGlyKSB7CiAgICAgICAgaWYgKEV4dC5pc0FycmF5KGFyZ3VtZW50c1swXSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubXVsdGlTb3J0LmNhbGwodGhpcywgZmllbGROYW1lLCBkaXIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNpbmdsZVNvcnQoZmllbGROYW1lLCBkaXIpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzaW5nbGVTb3J0OiBmdW5jdGlvbihmaWVsZE5hbWUsIGRpcikgewogICAgICAgIHZhciBmaWVsZCA9IHRoaXMuZmllbGRzLmdldChmaWVsZE5hbWUpOwogICAgICAgIGlmICghZmllbGQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5hbWUgICAgICAgPSBmaWVsZC5uYW1lLAogICAgICAgICAgICBzb3J0SW5mbyAgID0gdGhpcy5zb3J0SW5mbyB8fCBudWxsLAogICAgICAgICAgICBzb3J0VG9nZ2xlID0gdGhpcy5zb3J0VG9nZ2xlID8gdGhpcy5zb3J0VG9nZ2xlW25hbWVdIDogbnVsbDsKCiAgICAgICAgaWYgKCFkaXIpIHsKICAgICAgICAgICAgaWYgKHNvcnRJbmZvICYmIHNvcnRJbmZvLmZpZWxkID09IG5hbWUpIHsgCiAgICAgICAgICAgICAgICBkaXIgPSAodGhpcy5zb3J0VG9nZ2xlW25hbWVdIHx8ICdBU0MnKS50b2dnbGUoJ0FTQycsICdERVNDJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkaXIgPSBmaWVsZC5zb3J0RGlyOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNvcnRUb2dnbGVbbmFtZV0gPSBkaXI7CiAgICAgICAgdGhpcy5zb3J0SW5mbyA9IHtmaWVsZDogbmFtZSwgZGlyZWN0aW9uOiBkaXJ9OwogICAgICAgIHRoaXMuaGFzTXVsdGlTb3J0ID0gZmFsc2U7CgogICAgICAgIGlmICh0aGlzLnJlbW90ZVNvcnQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmxvYWQodGhpcy5sYXN0T3B0aW9ucykpIHsKICAgICAgICAgICAgICAgIGlmIChzb3J0VG9nZ2xlKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zb3J0VG9nZ2xlW25hbWVdID0gc29ydFRvZ2dsZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChzb3J0SW5mbykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc29ydEluZm8gPSBzb3J0SW5mbzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuYXBwbHlTb3J0KCk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdkYXRhY2hhbmdlZCcsIHRoaXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgCiAgICBtdWx0aVNvcnQ6IGZ1bmN0aW9uKHNvcnRlcnMsIGRpcmVjdGlvbikgewogICAgICAgIHRoaXMuaGFzTXVsdGlTb3J0ID0gdHJ1ZTsKICAgICAgICBkaXJlY3Rpb24gPSBkaXJlY3Rpb24gfHwgIkFTQyI7CgogICAgICAgIAogICAgICAgIGlmICh0aGlzLm11bHRpU29ydEluZm8gJiYgZGlyZWN0aW9uID09IHRoaXMubXVsdGlTb3J0SW5mby5kaXJlY3Rpb24pIHsKICAgICAgICAgICAgZGlyZWN0aW9uID0gZGlyZWN0aW9uLnRvZ2dsZSgiQVNDIiwgIkRFU0MiKTsKICAgICAgICB9CgogICAgICAgIAogICAgICAgIHRoaXMubXVsdGlTb3J0SW5mbyA9IHsKICAgICAgICAgICAgc29ydGVycyAgOiBzb3J0ZXJzLAogICAgICAgICAgICBkaXJlY3Rpb246IGRpcmVjdGlvbgogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMucmVtb3RlU29ydCkgewogICAgICAgICAgICB0aGlzLnNpbmdsZVNvcnQoc29ydGVyc1swXS5maWVsZCwgc29ydGVyc1swXS5kaXJlY3Rpb24pOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmFwcGx5U29ydCgpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZGF0YWNoYW5nZWQnLCB0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZWFjaCA6IGZ1bmN0aW9uKGZuLCBzY29wZSl7CiAgICAgICAgdGhpcy5kYXRhLmVhY2goZm4sIHNjb3BlKTsKICAgIH0sCgogICAgCiAgICBnZXRNb2RpZmllZFJlY29yZHMgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLm1vZGlmaWVkOwogICAgfSwKCiAgICAKICAgIHN1bSA6IGZ1bmN0aW9uKHByb3BlcnR5LCBzdGFydCwgZW5kKXsKICAgICAgICB2YXIgcnMgPSB0aGlzLmRhdGEuaXRlbXMsIHYgPSAwOwogICAgICAgIHN0YXJ0ID0gc3RhcnQgfHwgMDsKICAgICAgICBlbmQgPSAoZW5kIHx8IGVuZCA9PT0gMCkgPyBlbmQgOiBycy5sZW5ndGgtMTsKCiAgICAgICAgZm9yKHZhciBpID0gc3RhcnQ7IGkgPD0gZW5kOyBpKyspewogICAgICAgICAgICB2ICs9IChyc1tpXS5kYXRhW3Byb3BlcnR5XSB8fCAwKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHY7CiAgICB9LAoKICAgIAogICAgY3JlYXRlRmlsdGVyRm4gOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUsIGFueU1hdGNoLCBjYXNlU2Vuc2l0aXZlLCBleGFjdE1hdGNoKXsKICAgICAgICBpZihFeHQuaXNFbXB0eSh2YWx1ZSwgZmFsc2UpKXsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YWx1ZSA9IHRoaXMuZGF0YS5jcmVhdGVWYWx1ZU1hdGNoZXIodmFsdWUsIGFueU1hdGNoLCBjYXNlU2Vuc2l0aXZlLCBleGFjdE1hdGNoKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ocikgewogICAgICAgICAgICByZXR1cm4gdmFsdWUudGVzdChyLmRhdGFbcHJvcGVydHldKTsKICAgICAgICB9OwogICAgfSwKCiAgICAKICAgIGNyZWF0ZU11bHRpcGxlRmlsdGVyRm46IGZ1bmN0aW9uKGZpbHRlcnMpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgICAgICAgIHZhciBpc01hdGNoID0gdHJ1ZTsKCiAgICAgICAgICAgIGZvciAodmFyIGk9MCwgaiA9IGZpbHRlcnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgZmlsdGVyID0gZmlsdGVyc1tpXSwKICAgICAgICAgICAgICAgICAgICBmbiAgICAgPSBmaWx0ZXIuZm4sCiAgICAgICAgICAgICAgICAgICAgc2NvcGUgID0gZmlsdGVyLnNjb3BlOwoKICAgICAgICAgICAgICAgIGlzTWF0Y2ggPSBpc01hdGNoICYmIGZuLmNhbGwoc2NvcGUsIHJlY29yZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBpc01hdGNoOwogICAgICAgIH07CiAgICB9LAoKICAgIAogICAgZmlsdGVyIDogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlLCBhbnlNYXRjaCwgY2FzZVNlbnNpdGl2ZSwgZXhhY3RNYXRjaCl7CiAgICAgICAgdmFyIGZuOwogICAgICAgIAogICAgICAgIGlmIChFeHQuaXNPYmplY3QocHJvcGVydHkpKSB7CiAgICAgICAgICAgIHByb3BlcnR5ID0gW3Byb3BlcnR5XTsKICAgICAgICB9CgogICAgICAgIGlmIChFeHQuaXNBcnJheShwcm9wZXJ0eSkpIHsKICAgICAgICAgICAgdmFyIGZpbHRlcnMgPSBbXTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKHZhciBpPTAsIGogPSBwcm9wZXJ0eS5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBmaWx0ZXIgPSBwcm9wZXJ0eVtpXSwKICAgICAgICAgICAgICAgICAgICBmdW5jICAgPSBmaWx0ZXIuZm4sCiAgICAgICAgICAgICAgICAgICAgc2NvcGUgID0gZmlsdGVyLnNjb3BlIHx8IHRoaXM7CgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoIUV4dC5pc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgICAgICAgICAgICAgZnVuYyA9IHRoaXMuY3JlYXRlRmlsdGVyRm4oZmlsdGVyLnByb3BlcnR5LCBmaWx0ZXIudmFsdWUsIGZpbHRlci5hbnlNYXRjaCwgZmlsdGVyLmNhc2VTZW5zaXRpdmUsIGZpbHRlci5leGFjdE1hdGNoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmaWx0ZXJzLnB1c2goe2ZuOiBmdW5jLCBzY29wZTogc2NvcGV9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm4gPSB0aGlzLmNyZWF0ZU11bHRpcGxlRmlsdGVyRm4oZmlsdGVycyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZuID0gdGhpcy5jcmVhdGVGaWx0ZXJGbihwcm9wZXJ0eSwgdmFsdWUsIGFueU1hdGNoLCBjYXNlU2Vuc2l0aXZlLCBleGFjdE1hdGNoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmbiA/IHRoaXMuZmlsdGVyQnkoZm4pIDogdGhpcy5jbGVhckZpbHRlcigpOwogICAgfSwKCiAgICAKICAgIGZpbHRlckJ5IDogZnVuY3Rpb24oZm4sIHNjb3BlKXsKICAgICAgICB0aGlzLnNuYXBzaG90ID0gdGhpcy5zbmFwc2hvdCB8fCB0aGlzLmRhdGE7CiAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5xdWVyeUJ5KGZuLCBzY29wZSB8fCB0aGlzKTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnZGF0YWNoYW5nZWQnLCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBjbGVhckZpbHRlciA6IGZ1bmN0aW9uKHN1cHByZXNzRXZlbnQpewogICAgICAgIGlmKHRoaXMuaXNGaWx0ZXJlZCgpKXsKICAgICAgICAgICAgdGhpcy5kYXRhID0gdGhpcy5zbmFwc2hvdDsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuc25hcHNob3Q7CiAgICAgICAgICAgIGlmKHN1cHByZXNzRXZlbnQgIT09IHRydWUpewogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2RhdGFjaGFuZ2VkJywgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaXNGaWx0ZXJlZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuICEhdGhpcy5zbmFwc2hvdCAmJiB0aGlzLnNuYXBzaG90ICE9IHRoaXMuZGF0YTsKICAgIH0sCgogICAgCiAgICBxdWVyeSA6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSwgYW55TWF0Y2gsIGNhc2VTZW5zaXRpdmUpewogICAgICAgIHZhciBmbiA9IHRoaXMuY3JlYXRlRmlsdGVyRm4ocHJvcGVydHksIHZhbHVlLCBhbnlNYXRjaCwgY2FzZVNlbnNpdGl2ZSk7CiAgICAgICAgcmV0dXJuIGZuID8gdGhpcy5xdWVyeUJ5KGZuKSA6IHRoaXMuZGF0YS5jbG9uZSgpOwogICAgfSwKCiAgICAKICAgIHF1ZXJ5QnkgOiBmdW5jdGlvbihmbiwgc2NvcGUpewogICAgICAgIHZhciBkYXRhID0gdGhpcy5zbmFwc2hvdCB8fCB0aGlzLmRhdGE7CiAgICAgICAgcmV0dXJuIGRhdGEuZmlsdGVyQnkoZm4sIHNjb3BlfHx0aGlzKTsKICAgIH0sCgogICAgCiAgICBmaW5kIDogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlLCBzdGFydCwgYW55TWF0Y2gsIGNhc2VTZW5zaXRpdmUpewogICAgICAgIHZhciBmbiA9IHRoaXMuY3JlYXRlRmlsdGVyRm4ocHJvcGVydHksIHZhbHVlLCBhbnlNYXRjaCwgY2FzZVNlbnNpdGl2ZSk7CiAgICAgICAgcmV0dXJuIGZuID8gdGhpcy5kYXRhLmZpbmRJbmRleEJ5KGZuLCBudWxsLCBzdGFydCkgOiAtMTsKICAgIH0sCgogICAgCiAgICBmaW5kRXhhY3Q6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSwgc3RhcnQpewogICAgICAgIHJldHVybiB0aGlzLmRhdGEuZmluZEluZGV4QnkoZnVuY3Rpb24ocmVjKXsKICAgICAgICAgICAgcmV0dXJuIHJlYy5nZXQocHJvcGVydHkpID09PSB2YWx1ZTsKICAgICAgICB9LCB0aGlzLCBzdGFydCk7CiAgICB9LAoKICAgIAogICAgZmluZEJ5IDogZnVuY3Rpb24oZm4sIHNjb3BlLCBzdGFydCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YS5maW5kSW5kZXhCeShmbiwgc2NvcGUsIHN0YXJ0KTsKICAgIH0sCgogICAgCiAgICBjb2xsZWN0IDogZnVuY3Rpb24oZGF0YUluZGV4LCBhbGxvd051bGwsIGJ5cGFzc0ZpbHRlcil7CiAgICAgICAgdmFyIGQgPSAoYnlwYXNzRmlsdGVyID09PSB0cnVlICYmIHRoaXMuc25hcHNob3QpID8KICAgICAgICAgICAgICAgIHRoaXMuc25hcHNob3QuaXRlbXMgOiB0aGlzLmRhdGEuaXRlbXM7CiAgICAgICAgdmFyIHYsIHN2LCByID0gW10sIGwgPSB7fTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBkLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgdiA9IGRbaV0uZGF0YVtkYXRhSW5kZXhdOwogICAgICAgICAgICBzdiA9IFN0cmluZyh2KTsKICAgICAgICAgICAgaWYoKGFsbG93TnVsbCB8fCAhRXh0LmlzRW1wdHkodikpICYmICFsW3N2XSl7CiAgICAgICAgICAgICAgICBsW3N2XSA9IHRydWU7CiAgICAgICAgICAgICAgICByW3IubGVuZ3RoXSA9IHY7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHI7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJFZGl0IDogZnVuY3Rpb24ocmVjb3JkKXsKICAgICAgICBpZih0aGlzLm1vZGlmaWVkLmluZGV4T2YocmVjb3JkKSA9PSAtMSl7CiAgICAgICAgICAgIHRoaXMubW9kaWZpZWQucHVzaChyZWNvcmQpOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgndXBkYXRlJywgdGhpcywgcmVjb3JkLCBFeHQuZGF0YS5SZWNvcmQuRURJVCk7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJSZWplY3QgOiBmdW5jdGlvbihyZWNvcmQpewogICAgICAgIHRoaXMubW9kaWZpZWQucmVtb3ZlKHJlY29yZCk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3VwZGF0ZScsIHRoaXMsIHJlY29yZCwgRXh0LmRhdGEuUmVjb3JkLlJFSkVDVCk7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJDb21taXQgOiBmdW5jdGlvbihyZWNvcmQpewogICAgICAgIHRoaXMubW9kaWZpZWQucmVtb3ZlKHJlY29yZCk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3VwZGF0ZScsIHRoaXMsIHJlY29yZCwgRXh0LmRhdGEuUmVjb3JkLkNPTU1JVCk7CiAgICB9LAoKICAgIAogICAgY29tbWl0Q2hhbmdlcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG1vZGlmaWVkID0gdGhpcy5tb2RpZmllZC5zbGljZSgwKSwKICAgICAgICAgICAgbGVuZ3RoICAgPSBtb2RpZmllZC5sZW5ndGgsCiAgICAgICAgICAgIGk7CiAgICAgICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIG1vZGlmaWVkW2ldLmNvbW1pdCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLm1vZGlmaWVkID0gW107CiAgICAgICAgdGhpcy5yZW1vdmVkICA9IFtdOwogICAgfSwKCiAgICAKICAgIHJlamVjdENoYW5nZXMgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbW9kaWZpZWQgPSB0aGlzLm1vZGlmaWVkLnNsaWNlKDApLAogICAgICAgICAgICByZW1vdmVkICA9IHRoaXMucmVtb3ZlZC5zbGljZSgwKS5yZXZlcnNlKCksCiAgICAgICAgICAgIG1MZW5ndGggID0gbW9kaWZpZWQubGVuZ3RoLAogICAgICAgICAgICByTGVuZ3RoICA9IHJlbW92ZWQubGVuZ3RoLAogICAgICAgICAgICBpOwogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBtTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbW9kaWZpZWRbaV0ucmVqZWN0KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCByTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5pbnNlcnQocmVtb3ZlZFtpXS5sYXN0SW5kZXggfHwgMCwgcmVtb3ZlZFtpXSk7CiAgICAgICAgICAgIHJlbW92ZWRbaV0ucmVqZWN0KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMubW9kaWZpZWQgPSBbXTsKICAgICAgICB0aGlzLnJlbW92ZWQgID0gW107CiAgICB9LAoKICAgIAogICAgb25NZXRhQ2hhbmdlIDogZnVuY3Rpb24obWV0YSl7CiAgICAgICAgdGhpcy5yZWNvcmRUeXBlID0gdGhpcy5yZWFkZXIucmVjb3JkVHlwZTsKICAgICAgICB0aGlzLmZpZWxkcyA9IHRoaXMucmVjb3JkVHlwZS5wcm90b3R5cGUuZmllbGRzOwogICAgICAgIGRlbGV0ZSB0aGlzLnNuYXBzaG90OwogICAgICAgIGlmKHRoaXMucmVhZGVyLm1ldGEuc29ydEluZm8pewogICAgICAgICAgICB0aGlzLnNvcnRJbmZvID0gdGhpcy5yZWFkZXIubWV0YS5zb3J0SW5mbzsKICAgICAgICB9ZWxzZSBpZih0aGlzLnNvcnRJbmZvICAmJiAhdGhpcy5maWVsZHMuZ2V0KHRoaXMuc29ydEluZm8uZmllbGQpKXsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuc29ydEluZm87CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMud3JpdGVyKXsKICAgICAgICAgICAgdGhpcy53cml0ZXIubWV0YSA9IHRoaXMucmVhZGVyLm1ldGE7CiAgICAgICAgfQogICAgICAgIHRoaXMubW9kaWZpZWQgPSBbXTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnbWV0YWNoYW5nZScsIHRoaXMsIHRoaXMucmVhZGVyLm1ldGEpOwogICAgfSwKCiAgICAKICAgIGZpbmRJbnNlcnRJbmRleCA6IGZ1bmN0aW9uKHJlY29yZCl7CiAgICAgICAgdGhpcy5zdXNwZW5kRXZlbnRzKCk7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGEuY2xvbmUoKTsKICAgICAgICB0aGlzLmRhdGEuYWRkKHJlY29yZCk7CiAgICAgICAgdGhpcy5hcHBseVNvcnQoKTsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmRhdGEuaW5kZXhPZihyZWNvcmQpOwogICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICAgICAgdGhpcy5yZXN1bWVFdmVudHMoKTsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICB9LAoKICAgIAogICAgc2V0QmFzZVBhcmFtIDogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKXsKICAgICAgICB0aGlzLmJhc2VQYXJhbXMgPSB0aGlzLmJhc2VQYXJhbXMgfHwge307CiAgICAgICAgdGhpcy5iYXNlUGFyYW1zW25hbWVdID0gdmFsdWU7CiAgICB9Cn0pOwoKRXh0LnJlZygnc3RvcmUnLCBFeHQuZGF0YS5TdG9yZSk7CgoKRXh0LmRhdGEuU3RvcmUuRXJyb3IgPSBFeHQuZXh0ZW5kKEV4dC5FcnJvciwgewogICAgbmFtZTogJ0V4dC5kYXRhLlN0b3JlJwp9KTsKRXh0LmFwcGx5KEV4dC5kYXRhLlN0b3JlLkVycm9yLnByb3RvdHlwZSwgewogICAgbGFuZzogewogICAgICAgICd3cml0ZXItdW5kZWZpbmVkJyA6ICdBdHRlbXB0ZWQgdG8gZXhlY3V0ZSBhIHdyaXRlLWFjdGlvbiB3aXRob3V0IGEgRGF0YVdyaXRlciBpbnN0YWxsZWQuJwogICAgfQp9KTsKCkV4dC5kYXRhLkZpZWxkID0gRXh0LmV4dGVuZChPYmplY3QsIHsKICAgIAogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIGlmKEV4dC5pc1N0cmluZyhjb25maWcpKXsKICAgICAgICAgICAgY29uZmlnID0ge25hbWU6IGNvbmZpZ307CiAgICAgICAgfQogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwogICAgICAgIAogICAgICAgIHZhciB0eXBlcyA9IEV4dC5kYXRhLlR5cGVzLAogICAgICAgICAgICBzdCA9IHRoaXMuc29ydFR5cGUsCiAgICAgICAgICAgIHQ7CgogICAgICAgIGlmKHRoaXMudHlwZSl7CiAgICAgICAgICAgIGlmKEV4dC5pc1N0cmluZyh0aGlzLnR5cGUpKXsKICAgICAgICAgICAgICAgIHRoaXMudHlwZSA9IEV4dC5kYXRhLlR5cGVzW3RoaXMudHlwZS50b1VwcGVyQ2FzZSgpXSB8fCB0eXBlcy5BVVRPOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGVzLkFVVE87CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBpZihFeHQuaXNTdHJpbmcoc3QpKXsKICAgICAgICAgICAgdGhpcy5zb3J0VHlwZSA9IEV4dC5kYXRhLlNvcnRUeXBlc1tzdF07CiAgICAgICAgfWVsc2UgaWYoRXh0LmlzRW1wdHkoc3QpKXsKICAgICAgICAgICAgdGhpcy5zb3J0VHlwZSA9IHRoaXMudHlwZS5zb3J0VHlwZTsKICAgICAgICB9CgogICAgICAgIGlmKCF0aGlzLmNvbnZlcnQpewogICAgICAgICAgICB0aGlzLmNvbnZlcnQgPSB0aGlzLnR5cGUuY29udmVydDsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIGRhdGVGb3JtYXQ6IG51bGwsCiAgICAKICAgIAogICAgdXNlTnVsbDogZmFsc2UsCiAgICAKICAgIAogICAgZGVmYXVsdFZhbHVlOiAiIiwKICAgIAogICAgbWFwcGluZzogbnVsbCwKICAgIAogICAgc29ydFR5cGUgOiBudWxsLAogICAgCiAgICBzb3J0RGlyIDogIkFTQyIsCiAgICAKICAgIGFsbG93QmxhbmsgOiB0cnVlCn0pOwoKRXh0LmRhdGEuRGF0YVJlYWRlciA9IGZ1bmN0aW9uKG1ldGEsIHJlY29yZFR5cGUpewogICAgCiAgICB0aGlzLm1ldGEgPSBtZXRhOwogICAgCiAgICB0aGlzLnJlY29yZFR5cGUgPSBFeHQuaXNBcnJheShyZWNvcmRUeXBlKSA/CiAgICAgICAgRXh0LmRhdGEuUmVjb3JkLmNyZWF0ZShyZWNvcmRUeXBlKSA6IHJlY29yZFR5cGU7CgogICAgCiAgICBpZiAodGhpcy5yZWNvcmRUeXBlKXsKICAgICAgICB0aGlzLmJ1aWxkRXh0cmFjdG9ycygpOwogICAgfQp9OwoKRXh0LmRhdGEuRGF0YVJlYWRlci5wcm90b3R5cGUgPSB7CiAgICAKICAgIAogICAgZ2V0VG90YWw6IEV4dC5lbXB0eUZuLAogICAgCiAgICBnZXRSb290OiBFeHQuZW1wdHlGbiwKICAgIAogICAgZ2V0TWVzc2FnZTogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGdldFN1Y2Nlc3M6IEV4dC5lbXB0eUZuLAogICAgCiAgICBnZXRJZDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGJ1aWxkRXh0cmFjdG9ycyA6IEV4dC5lbXB0eUZuLAogICAgCiAgICBleHRyYWN0VmFsdWVzIDogRXh0LmVtcHR5Rm4sCgogICAgCiAgICByZWFsaXplOiBmdW5jdGlvbihycywgZGF0YSl7CiAgICAgICAgaWYgKEV4dC5pc0FycmF5KHJzKSkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKEV4dC5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWFsaXplKHJzLnNwbGljZShpLDEpLnNoaWZ0KCksIGRhdGEuc3BsaWNlKGksMSkuc2hpZnQoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlYWxpemUocnMuc3BsaWNlKGksMSkuc2hpZnQoKSwgZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRXh0LmlzQXJyYXkoZGF0YSkgJiYgZGF0YS5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEuc2hpZnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXRoaXMuaXNEYXRhKGRhdGEpKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEV4dC5kYXRhLkRhdGFSZWFkZXIuRXJyb3IoJ3JlYWxpemUnLCBycyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcnMucGhhbnRvbSA9IGZhbHNlOyAKICAgICAgICAgICAgcnMuX3BoaWQgPSBycy5pZDsgIAogICAgICAgICAgICBycy5pZCA9IHRoaXMuZ2V0SWQoZGF0YSk7CiAgICAgICAgICAgIHJzLmRhdGEgPSBkYXRhOwoKICAgICAgICAgICAgcnMuY29tbWl0KCk7CiAgICAgICAgICAgIHJzLnN0b3JlLnJlTWFwKHJzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdXBkYXRlIDogZnVuY3Rpb24ocnMsIGRhdGEpIHsKICAgICAgICBpZiAoRXh0LmlzQXJyYXkocnMpKSB7CiAgICAgICAgICAgIGZvciAodmFyIGk9cnMubGVuZ3RoLTE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICBpZiAoRXh0LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZShycy5zcGxpY2UoaSwxKS5zaGlmdCgpLCBkYXRhLnNwbGljZShpLDEpLnNoaWZ0KCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGUocnMuc3BsaWNlKGksMSkuc2hpZnQoKSwgZGF0YSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRXh0LmlzQXJyYXkoZGF0YSkgJiYgZGF0YS5sZW5ndGggPT0gMSkgewogICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEuc2hpZnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5pc0RhdGEoZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJzLmRhdGEgPSBFeHQuYXBwbHkocnMuZGF0YSwgZGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcnMuY29tbWl0KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGV4dHJhY3REYXRhIDogZnVuY3Rpb24ocm9vdCwgcmV0dXJuUmVjb3JkcykgewogICAgICAgIAogICAgICAgIHZhciByYXdOYW1lID0gKHRoaXMgaW5zdGFuY2VvZiBFeHQuZGF0YS5Kc29uUmVhZGVyKSA/ICdqc29uJyA6ICdub2RlJzsKCiAgICAgICAgdmFyIHJzID0gW107CgogICAgICAgIAogICAgICAgIAogICAgICAgIGlmICh0aGlzLmlzRGF0YShyb290KSAmJiAhKHRoaXMgaW5zdGFuY2VvZiBFeHQuZGF0YS5YbWxSZWFkZXIpKSB7CiAgICAgICAgICAgIHJvb3QgPSBbcm9vdF07CiAgICAgICAgfQogICAgICAgIHZhciBmICAgICAgID0gdGhpcy5yZWNvcmRUeXBlLnByb3RvdHlwZS5maWVsZHMsCiAgICAgICAgICAgIGZpICAgICAgPSBmLml0ZW1zLAogICAgICAgICAgICBmbCAgICAgID0gZi5sZW5ndGgsCiAgICAgICAgICAgIHJzICAgICAgPSBbXTsKICAgICAgICBpZiAocmV0dXJuUmVjb3JkcyA9PT0gdHJ1ZSkgewogICAgICAgICAgICB2YXIgUmVjb3JkID0gdGhpcy5yZWNvcmRUeXBlOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBuID0gcm9vdFtpXTsKICAgICAgICAgICAgICAgIHZhciByZWNvcmQgPSBuZXcgUmVjb3JkKHRoaXMuZXh0cmFjdFZhbHVlcyhuLCBmaSwgZmwpLCB0aGlzLmdldElkKG4pKTsKICAgICAgICAgICAgICAgIHJlY29yZFtyYXdOYW1lXSA9IG47ICAgIAogICAgICAgICAgICAgICAgcnMucHVzaChyZWNvcmQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvb3QubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy5leHRyYWN0VmFsdWVzKHJvb3RbaV0sIGZpLCBmbCk7CiAgICAgICAgICAgICAgICBkYXRhW3RoaXMubWV0YS5pZFByb3BlcnR5XSA9IHRoaXMuZ2V0SWQocm9vdFtpXSk7CiAgICAgICAgICAgICAgICBycy5wdXNoKGRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByczsKICAgIH0sCgogICAgCiAgICBpc0RhdGEgOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgcmV0dXJuIChkYXRhICYmIEV4dC5pc09iamVjdChkYXRhKSAmJiAhRXh0LmlzRW1wdHkodGhpcy5nZXRJZChkYXRhKSkpID8gdHJ1ZSA6IGZhbHNlOwogICAgfSwKCiAgICAKICAgIG9uTWV0YUNoYW5nZSA6IGZ1bmN0aW9uKG1ldGEpewogICAgICAgIGRlbGV0ZSB0aGlzLmVmOwogICAgICAgIHRoaXMubWV0YSA9IG1ldGE7CiAgICAgICAgdGhpcy5yZWNvcmRUeXBlID0gRXh0LmRhdGEuUmVjb3JkLmNyZWF0ZShtZXRhLmZpZWxkcyk7CiAgICAgICAgdGhpcy5idWlsZEV4dHJhY3RvcnMoKTsKICAgIH0KfTsKCgpFeHQuZGF0YS5EYXRhUmVhZGVyLkVycm9yID0gRXh0LmV4dGVuZChFeHQuRXJyb3IsIHsKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24obWVzc2FnZSwgYXJnKSB7CiAgICAgICAgdGhpcy5hcmcgPSBhcmc7CiAgICAgICAgRXh0LkVycm9yLmNhbGwodGhpcywgbWVzc2FnZSk7CiAgICB9LAogICAgbmFtZTogJ0V4dC5kYXRhLkRhdGFSZWFkZXInCn0pOwpFeHQuYXBwbHkoRXh0LmRhdGEuRGF0YVJlYWRlci5FcnJvci5wcm90b3R5cGUsIHsKICAgIGxhbmcgOiB7CiAgICAgICAgJ3VwZGF0ZSc6ICIjdXBkYXRlIHJlY2VpdmVkIGludmFsaWQgZGF0YSBmcm9tIHNlcnZlci4gIFBsZWFzZSBzZWUgZG9jcyBmb3IgRGF0YVJlYWRlciN1cGRhdGUgYW5kIHJldmlldyB5b3VyIERhdGFSZWFkZXIgY29uZmlndXJhdGlvbi4iLAogICAgICAgICdyZWFsaXplJzogIiNyZWFsaXplIHdhcyBjYWxsZWQgd2l0aCBpbnZhbGlkIHJlbW90ZS1kYXRhLiAgUGxlYXNlIHNlZSB0aGUgZG9jcyBmb3IgRGF0YVJlYWRlciNyZWFsaXplIGFuZCByZXZpZXcgeW91ciBEYXRhUmVhZGVyIGNvbmZpZ3VyYXRpb24uIiwKICAgICAgICAnaW52YWxpZC1yZXNwb25zZSc6ICIjcmVhZFJlc3BvbnNlIHJlY2VpdmVkIGFuIGludmFsaWQgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLiIKICAgIH0KfSk7CgpFeHQuZGF0YS5EYXRhV3JpdGVyID0gZnVuY3Rpb24oY29uZmlnKXsKICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwp9OwpFeHQuZGF0YS5EYXRhV3JpdGVyLnByb3RvdHlwZSA9IHsKCiAgICAKICAgIHdyaXRlQWxsRmllbGRzIDogZmFsc2UsCiAgICAKICAgIGxpc3RmdWwgOiBmYWxzZSwgICAgCgogICAgCiAgICBhcHBseSA6IGZ1bmN0aW9uKHBhcmFtcywgYmFzZVBhcmFtcywgYWN0aW9uLCBycykgewogICAgICAgIHZhciBkYXRhICAgID0gW10sCiAgICAgICAgcmVuZGVyZXIgICAgPSBhY3Rpb24gKyAnUmVjb3JkJzsKICAgICAgICAKICAgICAgICBpZiAoRXh0LmlzQXJyYXkocnMpKSB7CiAgICAgICAgICAgIEV4dC5lYWNoKHJzLCBmdW5jdGlvbihyZWMpewogICAgICAgICAgICAgICAgZGF0YS5wdXNoKHRoaXNbcmVuZGVyZXJdKHJlYykpOwogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocnMgaW5zdGFuY2VvZiBFeHQuZGF0YS5SZWNvcmQpIHsKICAgICAgICAgICAgZGF0YSA9IHRoaXNbcmVuZGVyZXJdKHJzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5yZW5kZXIocGFyYW1zLCBiYXNlUGFyYW1zLCBkYXRhKTsKICAgIH0sCgogICAgCiAgICByZW5kZXIgOiBFeHQuZW1wdHlGbiwKCiAgICAKICAgIHVwZGF0ZVJlY29yZCA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgY3JlYXRlUmVjb3JkIDogRXh0LmVtcHR5Rm4sCgogICAgCiAgICBkZXN0cm95UmVjb3JkIDogRXh0LmVtcHR5Rm4sCgogICAgCiAgICB0b0hhc2ggOiBmdW5jdGlvbihyZWMsIGNvbmZpZykgewogICAgICAgIHZhciBtYXAgPSByZWMuZmllbGRzLm1hcCwKICAgICAgICAgICAgZGF0YSA9IHt9LAogICAgICAgICAgICByYXcgPSAodGhpcy53cml0ZUFsbEZpZWxkcyA9PT0gZmFsc2UgJiYgcmVjLnBoYW50b20gPT09IGZhbHNlKSA/IHJlYy5nZXRDaGFuZ2VzKCkgOiByZWMuZGF0YSwKICAgICAgICAgICAgbTsKICAgICAgICBFeHQuaXRlcmF0ZShyYXcsIGZ1bmN0aW9uKHByb3AsIHZhbHVlKXsKICAgICAgICAgICAgaWYoKG0gPSBtYXBbcHJvcF0pKXsKICAgICAgICAgICAgICAgIGRhdGFbbS5tYXBwaW5nID8gbS5tYXBwaW5nIDogbS5uYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgaWYgKHJlYy5waGFudG9tKSB7CiAgICAgICAgICAgIGlmIChyZWMuZmllbGRzLmNvbnRhaW5zS2V5KHRoaXMubWV0YS5pZFByb3BlcnR5KSAmJiBFeHQuaXNFbXB0eShyZWMuZGF0YVt0aGlzLm1ldGEuaWRQcm9wZXJ0eV0pKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgZGF0YVt0aGlzLm1ldGEuaWRQcm9wZXJ0eV07CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkYXRhW3RoaXMubWV0YS5pZFByb3BlcnR5XSA9IHJlYy5pZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICB9LAoKICAgIAogICAgdG9BcnJheSA6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgZmllbGRzID0gW107CiAgICAgICAgRXh0Lml0ZXJhdGUoZGF0YSwgZnVuY3Rpb24oaywgdikge2ZpZWxkcy5wdXNoKHtuYW1lOiBrLCB2YWx1ZTogdn0pO30sdGhpcyk7CiAgICAgICAgcmV0dXJuIGZpZWxkczsKICAgIH0KfTsKRXh0LmRhdGEuRGF0YVByb3h5ID0gZnVuY3Rpb24oY29ubil7CiAgICAKICAgIAogICAgY29ubiA9IGNvbm4gfHwge307CgogICAgCiAgICAKICAgIAoKICAgIHRoaXMuYXBpICAgICA9IGNvbm4uYXBpOwogICAgdGhpcy51cmwgICAgID0gY29ubi51cmw7CiAgICB0aGlzLnJlc3RmdWwgPSBjb25uLnJlc3RmdWw7CiAgICB0aGlzLmxpc3RlbmVycyA9IGNvbm4ubGlzdGVuZXJzOwoKICAgIAogICAgdGhpcy5wcmV0dHlVcmxzID0gY29ubi5wcmV0dHlVcmxzOwoKICAgIAoKICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgIAogICAgICAgICdleGNlcHRpb24nLAogICAgICAgIAogICAgICAgICdiZWZvcmVsb2FkJywKICAgICAgICAKICAgICAgICAnbG9hZCcsCiAgICAgICAgCiAgICAgICAgJ2xvYWRleGNlcHRpb24nLAogICAgICAgIAogICAgICAgICdiZWZvcmV3cml0ZScsCiAgICAgICAgCiAgICAgICAgJ3dyaXRlJwogICAgKTsKICAgIEV4dC5kYXRhLkRhdGFQcm94eS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyk7CgogICAgCiAgICB0cnkgewogICAgICAgIEV4dC5kYXRhLkFwaS5wcmVwYXJlKHRoaXMpOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChlIGluc3RhbmNlb2YgRXh0LmRhdGEuQXBpLkVycm9yKSB7CiAgICAgICAgICAgIGUudG9Db25zb2xlKCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICBFeHQuZGF0YS5EYXRhUHJveHkucmVsYXlFdmVudHModGhpcywgWydiZWZvcmV3cml0ZScsICd3cml0ZScsICdleGNlcHRpb24nXSk7Cn07CgpFeHQuZXh0ZW5kKEV4dC5kYXRhLkRhdGFQcm94eSwgRXh0LnV0aWwuT2JzZXJ2YWJsZSwgewogICAgCiAgICByZXN0ZnVsOiBmYWxzZSwKCiAgICAKICAgIHNldEFwaSA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgdmFyIHZhbGlkID0gRXh0LmRhdGEuQXBpLmlzVmFsaWQoYXJndW1lbnRzWzBdKTsKICAgICAgICAgICAgaWYgKHZhbGlkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFwaSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeHQuZGF0YS5BcGkuRXJyb3IoJ2ludmFsaWQnLCB2YWxpZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAyKSB7CiAgICAgICAgICAgIGlmICghRXh0LmRhdGEuQXBpLmlzQWN0aW9uKGFyZ3VtZW50c1swXSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeHQuZGF0YS5BcGkuRXJyb3IoJ2ludmFsaWQnLCBhcmd1bWVudHNbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYXBpW2FyZ3VtZW50c1swXV0gPSBhcmd1bWVudHNbMV07CiAgICAgICAgfQogICAgICAgIEV4dC5kYXRhLkFwaS5wcmVwYXJlKHRoaXMpOwogICAgfSwKCiAgICAKICAgIGlzQXBpQWN0aW9uIDogZnVuY3Rpb24oYWN0aW9uKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLmFwaVthY3Rpb25dKSA/IHRydWUgOiBmYWxzZTsKICAgIH0sCgogICAgCiAgICByZXF1ZXN0IDogZnVuY3Rpb24oYWN0aW9uLCBycywgcGFyYW1zLCByZWFkZXIsIGNhbGxiYWNrLCBzY29wZSwgb3B0aW9ucykgewogICAgICAgIGlmICghdGhpcy5hcGlbYWN0aW9uXSAmJiAhdGhpcy5sb2FkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFeHQuZGF0YS5EYXRhUHJveHkuRXJyb3IoJ2FjdGlvbi11bmRlZmluZWQnLCBhY3Rpb24pOwogICAgICAgIH0KICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307CiAgICAgICAgaWYgKChhY3Rpb24gPT09IEV4dC5kYXRhLkFwaS5hY3Rpb25zLnJlYWQpID8gdGhpcy5maXJlRXZlbnQoImJlZm9yZWxvYWQiLCB0aGlzLCBwYXJhbXMpIDogdGhpcy5maXJlRXZlbnQoImJlZm9yZXdyaXRlIiwgdGhpcywgYWN0aW9uLCBycywgcGFyYW1zKSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy5kb1JlcXVlc3QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwoc2NvcGUgfHwgdGhpcywgbnVsbCwgb3B0aW9ucywgZmFsc2UpOwogICAgICAgIH0KICAgIH0sCgoKICAgIAogICAgbG9hZCA6IG51bGwsCgogICAgCiAgICBkb1JlcXVlc3QgOiBmdW5jdGlvbihhY3Rpb24sIHJzLCBwYXJhbXMsIHJlYWRlciwgY2FsbGJhY2ssIHNjb3BlLCBvcHRpb25zKSB7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdGhpcy5sb2FkKHBhcmFtcywgcmVhZGVyLCBjYWxsYmFjaywgc2NvcGUsIG9wdGlvbnMpOwogICAgfSwKCiAgICAKICAgIG9uUmVhZCA6IEV4dC5lbXB0eUZuLAogICAgCiAgICBvbldyaXRlIDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGJ1aWxkVXJsIDogZnVuY3Rpb24oYWN0aW9uLCByZWNvcmQpIHsKICAgICAgICByZWNvcmQgPSByZWNvcmQgfHwgbnVsbDsKCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdmFyIHVybCA9ICh0aGlzLmNvbm4gJiYgdGhpcy5jb25uLnVybCkgPyB0aGlzLmNvbm4udXJsIDogKHRoaXMuYXBpW2FjdGlvbl0pID8gdGhpcy5hcGlbYWN0aW9uXS51cmwgOiB0aGlzLnVybDsKICAgICAgICBpZiAoIXVybCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXh0LmRhdGEuQXBpLkVycm9yKCdpbnZhbGlkLXVybCcsIGFjdGlvbik7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICB2YXIgcHJvdmlkZXMgPSBudWxsOwogICAgICAgIHZhciBtID0gdXJsLm1hdGNoKC8oLiopKFwuanNvbnxcLnhtbHxcLmh0bWwpJC8pOwogICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgIHByb3ZpZGVzID0gbVsyXTsgICAgCiAgICAgICAgICAgIHVybCAgICAgID0gbVsxXTsgICAgCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICgodGhpcy5yZXN0ZnVsID09PSB0cnVlIHx8IHRoaXMucHJldHR5VXJscyA9PT0gdHJ1ZSkgJiYgcmVjb3JkIGluc3RhbmNlb2YgRXh0LmRhdGEuUmVjb3JkICYmICFyZWNvcmQucGhhbnRvbSkgewogICAgICAgICAgICB1cmwgKz0gJy8nICsgcmVjb3JkLmlkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKHByb3ZpZGVzID09PSBudWxsKSA/IHVybCA6IHVybCArIHByb3ZpZGVzOwogICAgfSwKCiAgICAKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5wdXJnZUxpc3RlbmVycygpOwogICAgfQp9KTsKCgoKRXh0LmFwcGx5KEV4dC5kYXRhLkRhdGFQcm94eSwgRXh0LnV0aWwuT2JzZXJ2YWJsZS5wcm90b3R5cGUpOwpFeHQudXRpbC5PYnNlcnZhYmxlLmNhbGwoRXh0LmRhdGEuRGF0YVByb3h5KTsKCgpFeHQuZGF0YS5EYXRhUHJveHkuRXJyb3IgPSBFeHQuZXh0ZW5kKEV4dC5FcnJvciwgewogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihtZXNzYWdlLCBhcmcpIHsKICAgICAgICB0aGlzLmFyZyA9IGFyZzsKICAgICAgICBFeHQuRXJyb3IuY2FsbCh0aGlzLCBtZXNzYWdlKTsKICAgIH0sCiAgICBuYW1lOiAnRXh0LmRhdGEuRGF0YVByb3h5Jwp9KTsKRXh0LmFwcGx5KEV4dC5kYXRhLkRhdGFQcm94eS5FcnJvci5wcm90b3R5cGUsIHsKICAgIGxhbmc6IHsKICAgICAgICAnYWN0aW9uLXVuZGVmaW5lZCc6ICJEYXRhUHJveHkgYXR0ZW1wdGVkIHRvIGV4ZWN1dGUgYW4gQVBJLWFjdGlvbiBidXQgZm91bmQgYW4gdW5kZWZpbmVkIHVybCAvIGZ1bmN0aW9uLiAgUGxlYXNlIHJldmlldyB5b3VyIFByb3h5IHVybC9hcGktY29uZmlndXJhdGlvbi4iLAogICAgICAgICdhcGktaW52YWxpZCc6ICdSZWNpZXZlZCBhbiBpbnZhbGlkIEFQSS1jb25maWd1cmF0aW9uLiAgUGxlYXNlIGVuc3VyZSB5b3VyIHByb3h5IEFQSS1jb25maWd1cmF0aW9uIGNvbnRhaW5zIG9ubHkgdGhlIGFjdGlvbnMgZnJvbSBFeHQuZGF0YS5BcGkuYWN0aW9ucy4nCiAgICB9Cn0pOwoKCgpFeHQuZGF0YS5SZXF1ZXN0ID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICBFeHQuYXBwbHkodGhpcywgcGFyYW1zKTsKfTsKRXh0LmRhdGEuUmVxdWVzdC5wcm90b3R5cGUgPSB7CiAgICAKICAgIGFjdGlvbiA6IHVuZGVmaW5lZCwKICAgIAogICAgcnMgOiB1bmRlZmluZWQsCiAgICAKICAgIHBhcmFtczogdW5kZWZpbmVkLAogICAgCiAgICBjYWxsYmFjayA6IEV4dC5lbXB0eUZuLAogICAgCiAgICBzY29wZSA6IHVuZGVmaW5lZCwKICAgIAogICAgcmVhZGVyIDogdW5kZWZpbmVkCn07CgpFeHQuZGF0YS5SZXNwb25zZSA9IGZ1bmN0aW9uKHBhcmFtcykgewogICAgRXh0LmFwcGx5KHRoaXMsIHBhcmFtcyk7Cn07CkV4dC5kYXRhLlJlc3BvbnNlLnByb3RvdHlwZSA9IHsKICAgIAogICAgYWN0aW9uOiB1bmRlZmluZWQsCiAgICAKICAgIHN1Y2Nlc3MgOiB1bmRlZmluZWQsCiAgICAKICAgIG1lc3NhZ2UgOiB1bmRlZmluZWQsCiAgICAKICAgIGRhdGE6IHVuZGVmaW5lZCwKICAgIAogICAgcmF3OiB1bmRlZmluZWQsCiAgICAKICAgIHJlY29yZHM6IHVuZGVmaW5lZAp9OwoKRXh0LmRhdGEuU2NyaXB0VGFnUHJveHkgPSBmdW5jdGlvbihjb25maWcpewogICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CgogICAgRXh0LmRhdGEuU2NyaXB0VGFnUHJveHkuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGNvbmZpZyk7CgogICAgdGhpcy5oZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXTsKCiAgICAKfTsKCkV4dC5kYXRhLlNjcmlwdFRhZ1Byb3h5LlRSQU5TX0lEID0gMTAwMDsKCkV4dC5leHRlbmQoRXh0LmRhdGEuU2NyaXB0VGFnUHJveHksIEV4dC5kYXRhLkRhdGFQcm94eSwgewogICAgCiAgICAKICAgIHRpbWVvdXQgOiAzMDAwMCwKICAgIAogICAgY2FsbGJhY2tQYXJhbSA6ICJjYWxsYmFjayIsCiAgICAKICAgIG5vY2FjaGUgOiB0cnVlLAoKICAgIAogICAgZG9SZXF1ZXN0IDogZnVuY3Rpb24oYWN0aW9uLCBycywgcGFyYW1zLCByZWFkZXIsIGNhbGxiYWNrLCBzY29wZSwgYXJnKSB7CiAgICAgICAgdmFyIHAgPSBFeHQudXJsRW5jb2RlKEV4dC5hcHBseShwYXJhbXMsIHRoaXMuZXh0cmFQYXJhbXMpKTsKCiAgICAgICAgdmFyIHVybCA9IHRoaXMuYnVpbGRVcmwoYWN0aW9uLCBycyk7CiAgICAgICAgaWYgKCF1cmwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEV4dC5kYXRhLkFwaS5FcnJvcignaW52YWxpZC11cmwnLCB1cmwpOwogICAgICAgIH0KICAgICAgICB1cmwgPSBFeHQudXJsQXBwZW5kKHVybCwgcCk7CgogICAgICAgIGlmKHRoaXMubm9jYWNoZSl7CiAgICAgICAgICAgIHVybCA9IEV4dC51cmxBcHBlbmQodXJsLCAnX2RjPScgKyAobmV3IERhdGUoKS5nZXRUaW1lKCkpKTsKICAgICAgICB9CiAgICAgICAgdmFyIHRyYW5zSWQgPSArK0V4dC5kYXRhLlNjcmlwdFRhZ1Byb3h5LlRSQU5TX0lEOwogICAgICAgIHZhciB0cmFucyA9IHsKICAgICAgICAgICAgaWQgOiB0cmFuc0lkLAogICAgICAgICAgICBhY3Rpb246IGFjdGlvbiwKICAgICAgICAgICAgY2IgOiAic3RjQ2FsbGJhY2siK3RyYW5zSWQsCiAgICAgICAgICAgIHNjcmlwdElkIDogInN0Y1NjcmlwdCIrdHJhbnNJZCwKICAgICAgICAgICAgcGFyYW1zIDogcGFyYW1zLAogICAgICAgICAgICBhcmcgOiBhcmcsCiAgICAgICAgICAgIHVybCA6IHVybCwKICAgICAgICAgICAgY2FsbGJhY2sgOiBjYWxsYmFjaywKICAgICAgICAgICAgc2NvcGUgOiBzY29wZSwKICAgICAgICAgICAgcmVhZGVyIDogcmVhZGVyCiAgICAgICAgfTsKICAgICAgICB3aW5kb3dbdHJhbnMuY2JdID0gdGhpcy5jcmVhdGVDYWxsYmFjayhhY3Rpb24sIHJzLCB0cmFucyk7CiAgICAgICAgdXJsICs9IFN0cmluZy5mb3JtYXQoIiZ7MH09ezF9IiwgdGhpcy5jYWxsYmFja1BhcmFtLCB0cmFucy5jYik7CiAgICAgICAgaWYodGhpcy5hdXRvQWJvcnQgIT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5hYm9ydCgpOwogICAgICAgIH0KCiAgICAgICAgdHJhbnMudGltZW91dElkID0gdGhpcy5oYW5kbGVGYWlsdXJlLmRlZmVyKHRoaXMudGltZW91dCwgdGhpcywgW3RyYW5zXSk7CgogICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICBzY3JpcHQuc2V0QXR0cmlidXRlKCJzcmMiLCB1cmwpOwogICAgICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAidGV4dC9qYXZhc2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgiaWQiLCB0cmFucy5zY3JpcHRJZCk7CiAgICAgICAgdGhpcy5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CgogICAgICAgIHRoaXMudHJhbnMgPSB0cmFuczsKICAgIH0sCgogICAgCiAgICBjcmVhdGVDYWxsYmFjayA6IGZ1bmN0aW9uKGFjdGlvbiwgcnMsIHRyYW5zKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgc2VsZi50cmFucyA9IGZhbHNlOwogICAgICAgICAgICBzZWxmLmRlc3Ryb3lUcmFucyh0cmFucywgdHJ1ZSk7CiAgICAgICAgICAgIGlmIChhY3Rpb24gPT09IEV4dC5kYXRhLkFwaS5hY3Rpb25zLnJlYWQpIHsKICAgICAgICAgICAgICAgIHNlbGYub25SZWFkLmNhbGwoc2VsZiwgYWN0aW9uLCB0cmFucywgcmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNlbGYub25Xcml0ZS5jYWxsKHNlbGYsIGFjdGlvbiwgdHJhbnMsIHJlcywgcnMpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0sCiAgICAKICAgIG9uUmVhZCA6IGZ1bmN0aW9uKGFjdGlvbiwgdHJhbnMsIHJlcykgewogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmVzdWx0ID0gdHJhbnMucmVhZGVyLnJlYWRSZWNvcmRzKHJlcyk7CiAgICAgICAgfWNhdGNoKGUpewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImxvYWRleGNlcHRpb24iLCB0aGlzLCB0cmFucywgcmVzLCBlKTsKCiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCB0aGlzLCAncmVzcG9uc2UnLCBhY3Rpb24sIHRyYW5zLCByZXMsIGUpOwogICAgICAgICAgICB0cmFucy5jYWxsYmFjay5jYWxsKHRyYW5zLnNjb3BlfHx3aW5kb3csIG51bGwsIHRyYW5zLmFyZywgZmFsc2UpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChyZXN1bHQuc3VjY2VzcyA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdsb2FkZXhjZXB0aW9uJywgdGhpcywgdHJhbnMsIHJlcyk7CgogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgdGhpcywgJ3JlbW90ZScsIGFjdGlvbiwgdHJhbnMsIHJlcywgbnVsbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImxvYWQiLCB0aGlzLCByZXMsIHRyYW5zLmFyZyk7CiAgICAgICAgfQogICAgICAgIHRyYW5zLmNhbGxiYWNrLmNhbGwodHJhbnMuc2NvcGV8fHdpbmRvdywgcmVzdWx0LCB0cmFucy5hcmcsIHJlc3VsdC5zdWNjZXNzKTsKICAgIH0sCiAgICAKICAgIG9uV3JpdGUgOiBmdW5jdGlvbihhY3Rpb24sIHRyYW5zLCByZXNwb25zZSwgcnMpIHsKICAgICAgICB2YXIgcmVhZGVyID0gdHJhbnMucmVhZGVyOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgcmVzID0gcmVhZGVyLnJlYWRSZXNwb25zZShhY3Rpb24sIHJlc3BvbnNlKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCB0aGlzLCAncmVzcG9uc2UnLCBhY3Rpb24sIHRyYW5zLCByZXMsIGUpOwogICAgICAgICAgICB0cmFucy5jYWxsYmFjay5jYWxsKHRyYW5zLnNjb3BlfHx3aW5kb3csIG51bGwsIHJlcywgZmFsc2UpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKCFyZXMuc3VjY2VzcyA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCB0aGlzLCAncmVtb3RlJywgYWN0aW9uLCB0cmFucywgcmVzLCBycyk7CiAgICAgICAgICAgIHRyYW5zLmNhbGxiYWNrLmNhbGwodHJhbnMuc2NvcGV8fHdpbmRvdywgbnVsbCwgcmVzLCBmYWxzZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5maXJlRXZlbnQoIndyaXRlIiwgdGhpcywgYWN0aW9uLCByZXMuZGF0YSwgcmVzLCBycywgdHJhbnMuYXJnICk7CiAgICAgICAgdHJhbnMuY2FsbGJhY2suY2FsbCh0cmFucy5zY29wZXx8d2luZG93LCByZXMuZGF0YSwgcmVzLCB0cnVlKTsKICAgIH0sCgogICAgCiAgICBpc0xvYWRpbmcgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnRyYW5zID8gdHJ1ZSA6IGZhbHNlOwogICAgfSwKCiAgICAKICAgIGFib3J0IDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmlzTG9hZGluZygpKXsKICAgICAgICAgICAgdGhpcy5kZXN0cm95VHJhbnModGhpcy50cmFucyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRlc3Ryb3lUcmFucyA6IGZ1bmN0aW9uKHRyYW5zLCBpc0xvYWRlZCl7CiAgICAgICAgdGhpcy5oZWFkLnJlbW92ZUNoaWxkKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRyYW5zLnNjcmlwdElkKSk7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRyYW5zLnRpbWVvdXRJZCk7CiAgICAgICAgaWYoaXNMb2FkZWQpewogICAgICAgICAgICB3aW5kb3dbdHJhbnMuY2JdID0gdW5kZWZpbmVkOwogICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICBkZWxldGUgd2luZG93W3RyYW5zLmNiXTsKICAgICAgICAgICAgfWNhdGNoKGUpe30KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdpbmRvd1t0cmFucy5jYl0gPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgd2luZG93W3RyYW5zLmNiXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgd2luZG93W3RyYW5zLmNiXTsKICAgICAgICAgICAgICAgIH1jYXRjaChlKXt9CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGhhbmRsZUZhaWx1cmUgOiBmdW5jdGlvbih0cmFucyl7CiAgICAgICAgdGhpcy50cmFucyA9IGZhbHNlOwogICAgICAgIHRoaXMuZGVzdHJveVRyYW5zKHRyYW5zLCBmYWxzZSk7CiAgICAgICAgaWYgKHRyYW5zLmFjdGlvbiA9PT0gRXh0LmRhdGEuQXBpLmFjdGlvbnMucmVhZCkgewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImxvYWRleGNlcHRpb24iLCB0aGlzLCBudWxsLCB0cmFucy5hcmcpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2V4Y2VwdGlvbicsIHRoaXMsICdyZXNwb25zZScsIHRyYW5zLmFjdGlvbiwgewogICAgICAgICAgICByZXNwb25zZTogbnVsbCwKICAgICAgICAgICAgb3B0aW9uczogdHJhbnMuYXJnCiAgICAgICAgfSk7CiAgICAgICAgdHJhbnMuY2FsbGJhY2suY2FsbCh0cmFucy5zY29wZXx8d2luZG93LCBudWxsLCB0cmFucy5hcmcsIGZhbHNlKTsKICAgIH0sCgogICAgCiAgICBkZXN0cm95OiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuYWJvcnQoKTsKICAgICAgICBFeHQuZGF0YS5TY3JpcHRUYWdQcm94eS5zdXBlcmNsYXNzLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0KfSk7CkV4dC5kYXRhLkh0dHBQcm94eSA9IGZ1bmN0aW9uKGNvbm4pewogICAgRXh0LmRhdGEuSHR0cFByb3h5LnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBjb25uKTsKCiAgICAKICAgIHRoaXMuY29ubiA9IGNvbm47CgogICAgCiAgICAKICAgIAogICAgCiAgICB0aGlzLmNvbm4udXJsID0gbnVsbDsKCiAgICB0aGlzLnVzZUFqYXggPSAhY29ubiB8fCAhY29ubi5ldmVudHM7CgogICAgCiAgICB2YXIgYWN0aW9ucyA9IEV4dC5kYXRhLkFwaS5hY3Rpb25zOwogICAgdGhpcy5hY3RpdmVSZXF1ZXN0ID0ge307CiAgICBmb3IgKHZhciB2ZXJiIGluIGFjdGlvbnMpIHsKICAgICAgICB0aGlzLmFjdGl2ZVJlcXVlc3RbYWN0aW9uc1t2ZXJiXV0gPSB1bmRlZmluZWQ7CiAgICB9Cn07CgpFeHQuZXh0ZW5kKEV4dC5kYXRhLkh0dHBQcm94eSwgRXh0LmRhdGEuRGF0YVByb3h5LCB7CiAgICAKICAgIGdldENvbm5lY3Rpb24gOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51c2VBamF4ID8gRXh0LkFqYXggOiB0aGlzLmNvbm47CiAgICB9LAoKICAgIAogICAgc2V0VXJsIDogZnVuY3Rpb24odXJsLCBtYWtlUGVybWFuZW50KSB7CiAgICAgICAgdGhpcy5jb25uLnVybCA9IHVybDsKICAgICAgICBpZiAobWFrZVBlcm1hbmVudCA9PT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLnVybCA9IHVybDsKICAgICAgICAgICAgdGhpcy5hcGkgPSBudWxsOwogICAgICAgICAgICBFeHQuZGF0YS5BcGkucHJlcGFyZSh0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZG9SZXF1ZXN0IDogZnVuY3Rpb24oYWN0aW9uLCBycywgcGFyYW1zLCByZWFkZXIsIGNiLCBzY29wZSwgYXJnKSB7CiAgICAgICAgdmFyICBvID0gewogICAgICAgICAgICBtZXRob2Q6ICh0aGlzLmFwaVthY3Rpb25dKSA/IHRoaXMuYXBpW2FjdGlvbl1bJ21ldGhvZCddIDogdW5kZWZpbmVkLAogICAgICAgICAgICByZXF1ZXN0OiB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA6IGNiLAogICAgICAgICAgICAgICAgc2NvcGUgOiBzY29wZSwKICAgICAgICAgICAgICAgIGFyZyA6IGFyZwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkZXI6IHJlYWRlciwKICAgICAgICAgICAgY2FsbGJhY2sgOiB0aGlzLmNyZWF0ZUNhbGxiYWNrKGFjdGlvbiwgcnMpLAogICAgICAgICAgICBzY29wZTogdGhpcwogICAgICAgIH07CgogICAgICAgIAogICAgICAgIAogICAgICAgIGlmIChwYXJhbXMuanNvbkRhdGEpIHsKICAgICAgICAgICAgby5qc29uRGF0YSA9IHBhcmFtcy5qc29uRGF0YTsKICAgICAgICB9IGVsc2UgaWYgKHBhcmFtcy54bWxEYXRhKSB7CiAgICAgICAgICAgIG8ueG1sRGF0YSA9IHBhcmFtcy54bWxEYXRhOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG8ucGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgICAgIH0KICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICB0aGlzLmNvbm4udXJsID0gdGhpcy5idWlsZFVybChhY3Rpb24sIHJzKTsKCiAgICAgICAgaWYodGhpcy51c2VBamF4KXsKCiAgICAgICAgICAgIEV4dC5hcHBseUlmKG8sIHRoaXMuY29ubik7CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlUmVxdWVzdFthY3Rpb25dKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWN0aXZlUmVxdWVzdFthY3Rpb25dID0gRXh0LkFqYXgucmVxdWVzdChvKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5jb25uLnJlcXVlc3Qobyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMuY29ubi51cmwgPSBudWxsOwogICAgfSwKCiAgICAKICAgIGNyZWF0ZUNhbGxiYWNrIDogZnVuY3Rpb24oYWN0aW9uLCBycykgewogICAgICAgIHJldHVybiBmdW5jdGlvbihvLCBzdWNjZXNzLCByZXNwb25zZSkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZVJlcXVlc3RbYWN0aW9uXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgaWYgKCFzdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uID09PSBFeHQuZGF0YS5BcGkuYWN0aW9ucy5yZWFkKSB7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2xvYWRleGNlcHRpb24nLCB0aGlzLCBvLCByZXNwb25zZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgdGhpcywgJ3Jlc3BvbnNlJywgYWN0aW9uLCBvLCByZXNwb25zZSk7CiAgICAgICAgICAgICAgICBvLnJlcXVlc3QuY2FsbGJhY2suY2FsbChvLnJlcXVlc3Quc2NvcGUsIG51bGwsIG8ucmVxdWVzdC5hcmcsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWN0aW9uID09PSBFeHQuZGF0YS5BcGkuYWN0aW9ucy5yZWFkKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9uUmVhZChhY3Rpb24sIG8sIHJlc3BvbnNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMub25Xcml0ZShhY3Rpb24sIG8sIHJlc3BvbnNlLCBycyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSwKCiAgICAKICAgIG9uUmVhZCA6IGZ1bmN0aW9uKGFjdGlvbiwgbywgcmVzcG9uc2UpIHsKICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJlc3VsdCA9IG8ucmVhZGVyLnJlYWQocmVzcG9uc2UpOwogICAgICAgIH1jYXRjaChlKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnbG9hZGV4Y2VwdGlvbicsIHRoaXMsIG8sIHJlc3BvbnNlLCBlKTsKCiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCB0aGlzLCAncmVzcG9uc2UnLCBhY3Rpb24sIG8sIHJlc3BvbnNlLCBlKTsKICAgICAgICAgICAgby5yZXF1ZXN0LmNhbGxiYWNrLmNhbGwoby5yZXF1ZXN0LnNjb3BlLCBudWxsLCBvLnJlcXVlc3QuYXJnLCBmYWxzZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHJlc3VsdC5zdWNjZXNzID09PSBmYWxzZSkgewogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdsb2FkZXhjZXB0aW9uJywgdGhpcywgbywgcmVzcG9uc2UpOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciByZXMgPSBvLnJlYWRlci5yZWFkUmVzcG9uc2UoYWN0aW9uLCByZXNwb25zZSk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCB0aGlzLCAncmVtb3RlJywgYWN0aW9uLCBvLCByZXMsIG51bGwpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2xvYWQnLCB0aGlzLCBvLCBvLnJlcXVlc3QuYXJnKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgby5yZXF1ZXN0LmNhbGxiYWNrLmNhbGwoby5yZXF1ZXN0LnNjb3BlLCByZXN1bHQsIG8ucmVxdWVzdC5hcmcsIHJlc3VsdC5zdWNjZXNzKTsKICAgIH0sCiAgICAKICAgIG9uV3JpdGUgOiBmdW5jdGlvbihhY3Rpb24sIG8sIHJlc3BvbnNlLCBycykgewogICAgICAgIHZhciByZWFkZXIgPSBvLnJlYWRlcjsKICAgICAgICB2YXIgcmVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJlcyA9IHJlYWRlci5yZWFkUmVzcG9uc2UoYWN0aW9uLCByZXNwb25zZSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgdGhpcywgJ3Jlc3BvbnNlJywgYWN0aW9uLCBvLCByZXNwb25zZSwgZSk7CiAgICAgICAgICAgIG8ucmVxdWVzdC5jYWxsYmFjay5jYWxsKG8ucmVxdWVzdC5zY29wZSwgbnVsbCwgby5yZXF1ZXN0LmFyZywgZmFsc2UpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChyZXMuc3VjY2VzcyA9PT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnd3JpdGUnLCB0aGlzLCBhY3Rpb24sIHJlcy5kYXRhLCByZXMsIHJzLCBvLnJlcXVlc3QuYXJnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgdGhpcywgJ3JlbW90ZScsIGFjdGlvbiwgbywgcmVzLCBycyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgIG8ucmVxdWVzdC5jYWxsYmFjay5jYWxsKG8ucmVxdWVzdC5zY29wZSwgcmVzLmRhdGEsIHJlcywgcmVzLnN1Y2Nlc3MpOwogICAgfSwKCiAgICAKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMudXNlQWpheCl7CiAgICAgICAgICAgIHRoaXMuY29ubi5hYm9ydCgpOwogICAgICAgIH1lbHNlIGlmKHRoaXMuYWN0aXZlUmVxdWVzdCl7CiAgICAgICAgICAgIHZhciBhY3Rpb25zID0gRXh0LmRhdGEuQXBpLmFjdGlvbnM7CiAgICAgICAgICAgIGZvciAodmFyIHZlcmIgaW4gYWN0aW9ucykgewogICAgICAgICAgICAgICAgaWYodGhpcy5hY3RpdmVSZXF1ZXN0W2FjdGlvbnNbdmVyYl1dKXsKICAgICAgICAgICAgICAgICAgICBFeHQuQWpheC5hYm9ydCh0aGlzLmFjdGl2ZVJlcXVlc3RbYWN0aW9uc1t2ZXJiXV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIEV4dC5kYXRhLkh0dHBQcm94eS5zdXBlcmNsYXNzLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0KfSk7CkV4dC5kYXRhLk1lbW9yeVByb3h5ID0gZnVuY3Rpb24oZGF0YSl7CiAgICAKICAgIHZhciBhcGkgPSB7fTsKICAgIGFwaVtFeHQuZGF0YS5BcGkuYWN0aW9ucy5yZWFkXSA9IHRydWU7CiAgICBFeHQuZGF0YS5NZW1vcnlQcm94eS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgewogICAgICAgIGFwaTogYXBpCiAgICB9KTsKICAgIHRoaXMuZGF0YSA9IGRhdGE7Cn07CgpFeHQuZXh0ZW5kKEV4dC5kYXRhLk1lbW9yeVByb3h5LCBFeHQuZGF0YS5EYXRhUHJveHksIHsKICAgIAoKICAgICAgIAogICAgZG9SZXF1ZXN0IDogZnVuY3Rpb24oYWN0aW9uLCBycywgcGFyYW1zLCByZWFkZXIsIGNhbGxiYWNrLCBzY29wZSwgYXJnKSB7CiAgICAgICAgCiAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9OwogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmVzdWx0ID0gcmVhZGVyLnJlYWRSZWNvcmRzKHRoaXMuZGF0YSk7CiAgICAgICAgfWNhdGNoKGUpewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImxvYWRleGNlcHRpb24iLCB0aGlzLCBudWxsLCBhcmcsIGUpOwoKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2V4Y2VwdGlvbicsIHRoaXMsICdyZXNwb25zZScsIGFjdGlvbiwgYXJnLCBudWxsLCBlKTsKICAgICAgICAgICAgY2FsbGJhY2suY2FsbChzY29wZSwgbnVsbCwgYXJnLCBmYWxzZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2suY2FsbChzY29wZSwgcmVzdWx0LCBhcmcsIHRydWUpOwogICAgfQp9KTsKRXh0LmRhdGEuVHlwZXMgPSBuZXcgZnVuY3Rpb24oKXsKICAgIHZhciBzdCA9IEV4dC5kYXRhLlNvcnRUeXBlczsKICAgIEV4dC5hcHBseSh0aGlzLCB7CiAgICAgICAgCiAgICAgICAgc3RyaXBSZTogL1tcJCwlXS9nLAogICAgICAgIAogICAgICAgIAogICAgICAgIEFVVE86IHsKICAgICAgICAgICAgY29udmVydDogZnVuY3Rpb24odil7IHJldHVybiB2OyB9LAogICAgICAgICAgICBzb3J0VHlwZTogc3Qubm9uZSwKICAgICAgICAgICAgdHlwZTogJ2F1dG8nCiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgU1RSSU5HOiB7CiAgICAgICAgICAgIGNvbnZlcnQ6IGZ1bmN0aW9uKHYpeyByZXR1cm4gKHYgPT09IHVuZGVmaW5lZCB8fCB2ID09PSBudWxsKSA/ICcnIDogU3RyaW5nKHYpOyB9LAogICAgICAgICAgICBzb3J0VHlwZTogc3QuYXNVQ1N0cmluZywKICAgICAgICAgICAgdHlwZTogJ3N0cmluZycKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBJTlQ6IHsKICAgICAgICAgICAgY29udmVydDogZnVuY3Rpb24odil7CiAgICAgICAgICAgICAgICByZXR1cm4gdiAhPT0gdW5kZWZpbmVkICYmIHYgIT09IG51bGwgJiYgdiAhPT0gJycgPwogICAgICAgICAgICAgICAgICAgIHBhcnNlSW50KFN0cmluZyh2KS5yZXBsYWNlKEV4dC5kYXRhLlR5cGVzLnN0cmlwUmUsICcnKSwgMTApIDogKHRoaXMudXNlTnVsbCA/IG51bGwgOiAwKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc29ydFR5cGU6IHN0Lm5vbmUsCiAgICAgICAgICAgIHR5cGU6ICdpbnQnCiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAKICAgICAgICBGTE9BVDogewogICAgICAgICAgICBjb252ZXJ0OiBmdW5jdGlvbih2KXsKICAgICAgICAgICAgICAgIHJldHVybiB2ICE9PSB1bmRlZmluZWQgJiYgdiAhPT0gbnVsbCAmJiB2ICE9PSAnJyA/CiAgICAgICAgICAgICAgICAgICAgcGFyc2VGbG9hdChTdHJpbmcodikucmVwbGFjZShFeHQuZGF0YS5UeXBlcy5zdHJpcFJlLCAnJyksIDEwKSA6ICh0aGlzLnVzZU51bGwgPyBudWxsIDogMCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNvcnRUeXBlOiBzdC5ub25lLAogICAgICAgICAgICB0eXBlOiAnZmxvYXQnCiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAKICAgICAgICBCT09MOiB7CiAgICAgICAgICAgIGNvbnZlcnQ6IGZ1bmN0aW9uKHYpeyByZXR1cm4gdiA9PT0gdHJ1ZSB8fCB2ID09PSAndHJ1ZScgfHwgdiA9PSAxOyB9LAogICAgICAgICAgICBzb3J0VHlwZTogc3Qubm9uZSwKICAgICAgICAgICAgdHlwZTogJ2Jvb2wnCiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAKICAgICAgICBEQVRFOiB7CiAgICAgICAgICAgIGNvbnZlcnQ6IGZ1bmN0aW9uKHYpewogICAgICAgICAgICAgICAgdmFyIGRmID0gdGhpcy5kYXRlRm9ybWF0OwogICAgICAgICAgICAgICAgaWYoIXYpewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoRXh0LmlzRGF0ZSh2KSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihkZil7CiAgICAgICAgICAgICAgICAgICAgaWYoZGYgPT0gJ3RpbWVzdGFtcCcpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodioxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYoZGYgPT0gJ3RpbWUnKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHBhcnNlSW50KHYsIDEwKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBEYXRlLnBhcnNlRGF0ZSh2LCBkZik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgcGFyc2VkID0gRGF0ZS5wYXJzZSh2KTsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZWQgPyBuZXcgRGF0ZShwYXJzZWQpIDogbnVsbDsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc29ydFR5cGU6IHN0LmFzRGF0ZSwKICAgICAgICAgICAgdHlwZTogJ2RhdGUnCiAgICAgICAgfQogICAgfSk7CiAgICAKICAgIEV4dC5hcHBseSh0aGlzLCB7CiAgICAgICAgCiAgICAgICAgQk9PTEVBTjogdGhpcy5CT09MLAogICAgICAgIAogICAgICAgIElOVEVHRVI6IHRoaXMuSU5ULAogICAgICAgIAogICAgICAgIE5VTUJFUjogdGhpcy5GTE9BVCAgICAKICAgIH0pOwp9OwpFeHQuZGF0YS5Kc29uV3JpdGVyID0gRXh0LmV4dGVuZChFeHQuZGF0YS5EYXRhV3JpdGVyLCB7CiAgICAKICAgIGVuY29kZSA6IHRydWUsCiAgICAKICAgIGVuY29kZURlbGV0ZTogZmFsc2UsCiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBFeHQuZGF0YS5Kc29uV3JpdGVyLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBjb25maWcpOyAgICAKICAgIH0sCgogICAgCiAgICByZW5kZXIgOiBmdW5jdGlvbihwYXJhbXMsIGJhc2VQYXJhbXMsIGRhdGEpIHsKICAgICAgICBpZiAodGhpcy5lbmNvZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIEV4dC5hcHBseShwYXJhbXMsIGJhc2VQYXJhbXMpOwogICAgICAgICAgICBwYXJhbXNbdGhpcy5tZXRhLnJvb3RdID0gRXh0LmVuY29kZShkYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGpkYXRhID0gRXh0LmFwcGx5KHt9LCBiYXNlUGFyYW1zKTsKICAgICAgICAgICAgamRhdGFbdGhpcy5tZXRhLnJvb3RdID0gZGF0YTsKICAgICAgICAgICAgcGFyYW1zLmpzb25EYXRhID0gamRhdGE7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgY3JlYXRlUmVjb3JkIDogZnVuY3Rpb24ocmVjKSB7CiAgICAgICByZXR1cm4gdGhpcy50b0hhc2gocmVjKTsKICAgIH0sCiAgICAKICAgIHVwZGF0ZVJlY29yZCA6IGZ1bmN0aW9uKHJlYykgewogICAgICAgIHJldHVybiB0aGlzLnRvSGFzaChyZWMpOwoKICAgIH0sCiAgICAKICAgIGRlc3Ryb3lSZWNvcmQgOiBmdW5jdGlvbihyZWMpewogICAgICAgIGlmKHRoaXMuZW5jb2RlRGVsZXRlKXsKICAgICAgICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgICAgICAgZGF0YVt0aGlzLm1ldGEuaWRQcm9wZXJ0eV0gPSByZWMuaWQ7CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgIH1lbHNlewogICAgICAgICAgICByZXR1cm4gcmVjLmlkOwogICAgICAgIH0KICAgIH0KfSk7CkV4dC5kYXRhLkpzb25SZWFkZXIgPSBmdW5jdGlvbihtZXRhLCByZWNvcmRUeXBlKXsKICAgIG1ldGEgPSBtZXRhIHx8IHt9OwogICAgCiAgICAKICAgIAogICAgCiAgICBFeHQuYXBwbHlJZihtZXRhLCB7CiAgICAgICAgaWRQcm9wZXJ0eTogJ2lkJywKICAgICAgICBzdWNjZXNzUHJvcGVydHk6ICdzdWNjZXNzJywKICAgICAgICB0b3RhbFByb3BlcnR5OiAndG90YWwnCiAgICB9KTsKCiAgICBFeHQuZGF0YS5Kc29uUmVhZGVyLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBtZXRhLCByZWNvcmRUeXBlIHx8IG1ldGEuZmllbGRzKTsKfTsKRXh0LmV4dGVuZChFeHQuZGF0YS5Kc29uUmVhZGVyLCBFeHQuZGF0YS5EYXRhUmVhZGVyLCB7CiAgICAKICAgIAogICAgcmVhZCA6IGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgICB2YXIganNvbiA9IHJlc3BvbnNlLnJlc3BvbnNlVGV4dDsKICAgICAgICB2YXIgbyA9IEV4dC5kZWNvZGUoanNvbik7CiAgICAgICAgaWYoIW8pIHsKICAgICAgICAgICAgdGhyb3cge21lc3NhZ2U6ICdKc29uUmVhZGVyLnJlYWQ6IEpzb24gb2JqZWN0IG5vdCBmb3VuZCd9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5yZWFkUmVjb3JkcyhvKTsKICAgIH0sCgogICAgCiAgICAKICAgIHJlYWRSZXNwb25zZSA6IGZ1bmN0aW9uKGFjdGlvbiwgcmVzcG9uc2UpIHsKICAgICAgICB2YXIgbyA9IChyZXNwb25zZS5yZXNwb25zZVRleHQgIT09IHVuZGVmaW5lZCkgPyBFeHQuZGVjb2RlKHJlc3BvbnNlLnJlc3BvbnNlVGV4dCkgOiByZXNwb25zZTsKICAgICAgICBpZighbykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXh0LmRhdGEuSnNvblJlYWRlci5FcnJvcigncmVzcG9uc2UnKTsKICAgICAgICB9CgogICAgICAgIHZhciByb290ID0gdGhpcy5nZXRSb290KG8pLAogICAgICAgICAgICBzdWNjZXNzID0gdGhpcy5nZXRTdWNjZXNzKG8pOwogICAgICAgIGlmIChzdWNjZXNzICYmIGFjdGlvbiA9PT0gRXh0LmRhdGEuQXBpLmFjdGlvbnMuY3JlYXRlKSB7CiAgICAgICAgICAgIHZhciBkZWYgPSBFeHQuaXNEZWZpbmVkKHJvb3QpOwogICAgICAgICAgICBpZiAoZGVmICYmIEV4dC5pc0VtcHR5KHJvb3QpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXh0LmRhdGEuSnNvblJlYWRlci5FcnJvcigncm9vdC1lbXB0eScsIHRoaXMubWV0YS5yb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICghZGVmKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXh0LmRhdGEuSnNvblJlYWRlci5FcnJvcigncm9vdC11bmRlZmluZWQtcmVzcG9uc2UnLCB0aGlzLm1ldGEucm9vdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIAogICAgICAgIHZhciByZXMgPSBuZXcgRXh0LmRhdGEuUmVzcG9uc2UoewogICAgICAgICAgICBhY3Rpb246IGFjdGlvbiwKICAgICAgICAgICAgc3VjY2Vzczogc3VjY2VzcywKICAgICAgICAgICAgZGF0YTogKHJvb3QpID8gdGhpcy5leHRyYWN0RGF0YShyb290LCBmYWxzZSkgOiBbXSwKICAgICAgICAgICAgbWVzc2FnZTogdGhpcy5nZXRNZXNzYWdlKG8pLAogICAgICAgICAgICByYXc6IG8KICAgICAgICB9KTsKCiAgICAgICAgCiAgICAgICAgaWYgKEV4dC5pc0VtcHR5KHJlcy5zdWNjZXNzKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXh0LmRhdGEuSnNvblJlYWRlci5FcnJvcignc3VjY2Vzc1Byb3BlcnR5LXJlc3BvbnNlJywgdGhpcy5tZXRhLnN1Y2Nlc3NQcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXM7CiAgICB9LAoKICAgIAogICAgcmVhZFJlY29yZHMgOiBmdW5jdGlvbihvKXsKICAgICAgICAKICAgICAgICB0aGlzLmpzb25EYXRhID0gbzsKICAgICAgICBpZihvLm1ldGFEYXRhKXsKICAgICAgICAgICAgdGhpcy5vbk1ldGFDaGFuZ2Uoby5tZXRhRGF0YSk7CiAgICAgICAgfQogICAgICAgIHZhciBzID0gdGhpcy5tZXRhLCBSZWNvcmQgPSB0aGlzLnJlY29yZFR5cGUsCiAgICAgICAgICAgIGYgPSBSZWNvcmQucHJvdG90eXBlLmZpZWxkcywgZmkgPSBmLml0ZW1zLCBmbCA9IGYubGVuZ3RoLCB2OwoKICAgICAgICB2YXIgcm9vdCA9IHRoaXMuZ2V0Um9vdChvKSwgYyA9IHJvb3QubGVuZ3RoLCB0b3RhbFJlY29yZHMgPSBjLCBzdWNjZXNzID0gdHJ1ZTsKICAgICAgICBpZihzLnRvdGFsUHJvcGVydHkpewogICAgICAgICAgICB2ID0gcGFyc2VJbnQodGhpcy5nZXRUb3RhbChvKSwgMTApOwogICAgICAgICAgICBpZighaXNOYU4odikpewogICAgICAgICAgICAgICAgdG90YWxSZWNvcmRzID0gdjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZihzLnN1Y2Nlc3NQcm9wZXJ0eSl7CiAgICAgICAgICAgIHYgPSB0aGlzLmdldFN1Y2Nlc3Mobyk7CiAgICAgICAgICAgIGlmKHYgPT09IGZhbHNlIHx8IHYgPT09ICdmYWxzZScpewogICAgICAgICAgICAgICAgc3VjY2VzcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzdWNjZXNzIDogc3VjY2VzcywKICAgICAgICAgICAgcmVjb3JkcyA6IHRoaXMuZXh0cmFjdERhdGEocm9vdCwgdHJ1ZSksIAogICAgICAgICAgICB0b3RhbFJlY29yZHMgOiB0b3RhbFJlY29yZHMKICAgICAgICB9OwogICAgfSwKCiAgICAKICAgIGJ1aWxkRXh0cmFjdG9ycyA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmKHRoaXMuZWYpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBzID0gdGhpcy5tZXRhLCBSZWNvcmQgPSB0aGlzLnJlY29yZFR5cGUsCiAgICAgICAgICAgIGYgPSBSZWNvcmQucHJvdG90eXBlLmZpZWxkcywgZmkgPSBmLml0ZW1zLCBmbCA9IGYubGVuZ3RoOwoKICAgICAgICBpZihzLnRvdGFsUHJvcGVydHkpIHsKICAgICAgICAgICAgdGhpcy5nZXRUb3RhbCA9IHRoaXMuY3JlYXRlQWNjZXNzb3Iocy50b3RhbFByb3BlcnR5KTsKICAgICAgICB9CiAgICAgICAgaWYocy5zdWNjZXNzUHJvcGVydHkpIHsKICAgICAgICAgICAgdGhpcy5nZXRTdWNjZXNzID0gdGhpcy5jcmVhdGVBY2Nlc3NvcihzLnN1Y2Nlc3NQcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIGlmIChzLm1lc3NhZ2VQcm9wZXJ0eSkgewogICAgICAgICAgICB0aGlzLmdldE1lc3NhZ2UgPSB0aGlzLmNyZWF0ZUFjY2Vzc29yKHMubWVzc2FnZVByb3BlcnR5KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5nZXRSb290ID0gcy5yb290ID8gdGhpcy5jcmVhdGVBY2Nlc3NvcihzLnJvb3QpIDogZnVuY3Rpb24ocCl7cmV0dXJuIHA7fTsKICAgICAgICBpZiAocy5pZCB8fCBzLmlkUHJvcGVydHkpIHsKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLmNyZWF0ZUFjY2Vzc29yKHMuaWQgfHwgcy5pZFByb3BlcnR5KTsKICAgICAgICAgICAgdGhpcy5nZXRJZCA9IGZ1bmN0aW9uKHJlYykgewogICAgICAgICAgICAgICAgdmFyIHIgPSBnKHJlYyk7CiAgICAgICAgICAgICAgICByZXR1cm4gKHIgPT09IHVuZGVmaW5lZCB8fCByID09PSAnJykgPyBudWxsIDogcjsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmdldElkID0gZnVuY3Rpb24oKXtyZXR1cm4gbnVsbDt9OwogICAgICAgIH0KICAgICAgICB2YXIgZWYgPSBbXTsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgZmw7IGkrKyl7CiAgICAgICAgICAgIGYgPSBmaVtpXTsKICAgICAgICAgICAgdmFyIG1hcCA9IChmLm1hcHBpbmcgIT09IHVuZGVmaW5lZCAmJiBmLm1hcHBpbmcgIT09IG51bGwpID8gZi5tYXBwaW5nIDogZi5uYW1lOwogICAgICAgICAgICBlZi5wdXNoKHRoaXMuY3JlYXRlQWNjZXNzb3IobWFwKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZWYgPSBlZjsKICAgIH0sCgogICAgCiAgICBzaW1wbGVBY2Nlc3MgOiBmdW5jdGlvbihvYmosIHN1YnNjKSB7CiAgICAgICAgcmV0dXJuIG9ialtzdWJzY107CiAgICB9LAoKICAgIAogICAgY3JlYXRlQWNjZXNzb3IgOiBmdW5jdGlvbigpewogICAgICAgIHZhciByZSA9IC9bXFtcLl0vOwogICAgICAgIHJldHVybiBmdW5jdGlvbihleHByKSB7CiAgICAgICAgICAgIGlmKEV4dC5pc0VtcHR5KGV4cHIpKXsKICAgICAgICAgICAgICAgIHJldHVybiBFeHQuZW1wdHlGbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihFeHQuaXNGdW5jdGlvbihleHByKSl7CiAgICAgICAgICAgICAgICByZXR1cm4gZXhwcjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaSA9IFN0cmluZyhleHByKS5zZWFyY2gocmUpOwogICAgICAgICAgICBpZihpID49IDApewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbignb2JqJywgJ3JldHVybiBvYmonICsgKGkgPiAwID8gJy4nIDogJycpICsgZXhwcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iail7CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqW2V4cHJdOwogICAgICAgICAgICB9OwoKICAgICAgICB9OwogICAgfSgpLAoKICAgIAogICAgZXh0cmFjdFZhbHVlcyA6IGZ1bmN0aW9uKGRhdGEsIGl0ZW1zLCBsZW4pIHsKICAgICAgICB2YXIgZiwgdmFsdWVzID0ge307CiAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IGxlbjsgaisrKXsKICAgICAgICAgICAgZiA9IGl0ZW1zW2pdOwogICAgICAgICAgICB2YXIgdiA9IHRoaXMuZWZbal0oZGF0YSk7CiAgICAgICAgICAgIHZhbHVlc1tmLm5hbWVdID0gZi5jb252ZXJ0KCh2ICE9PSB1bmRlZmluZWQpID8gdiA6IGYuZGVmYXVsdFZhbHVlLCBkYXRhKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0KfSk7CgoKRXh0LmRhdGEuSnNvblJlYWRlci5FcnJvciA9IEV4dC5leHRlbmQoRXh0LkVycm9yLCB7CiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKG1lc3NhZ2UsIGFyZykgewogICAgICAgIHRoaXMuYXJnID0gYXJnOwogICAgICAgIEV4dC5FcnJvci5jYWxsKHRoaXMsIG1lc3NhZ2UpOwogICAgfSwKICAgIG5hbWUgOiAnRXh0LmRhdGEuSnNvblJlYWRlcicKfSk7CkV4dC5hcHBseShFeHQuZGF0YS5Kc29uUmVhZGVyLkVycm9yLnByb3RvdHlwZSwgewogICAgbGFuZzogewogICAgICAgICdyZXNwb25zZSc6ICdBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSBqc29uLWRlY29kaW5nIHlvdXIgc2VydmVyIHJlc3BvbnNlJywKICAgICAgICAnc3VjY2Vzc1Byb3BlcnR5LXJlc3BvbnNlJzogJ0NvdWxkIG5vdCBsb2NhdGUgeW91ciAic3VjY2Vzc1Byb3BlcnR5IiBpbiB5b3VyIHNlcnZlciByZXNwb25zZS4gIFBsZWFzZSByZXZpZXcgeW91ciBKc29uUmVhZGVyIGNvbmZpZyB0byBlbnN1cmUgdGhlIGNvbmZpZy1wcm9wZXJ0eSAic3VjY2Vzc1Byb3BlcnR5IiBtYXRjaGVzIHRoZSBwcm9wZXJ0eSBpbiB5b3VyIHNlcnZlci1yZXNwb25zZS4gIFNlZSB0aGUgSnNvblJlYWRlciBkb2NzLicsCiAgICAgICAgJ3Jvb3QtdW5kZWZpbmVkLWNvbmZpZyc6ICdZb3VyIEpzb25SZWFkZXIgd2FzIGNvbmZpZ3VyZWQgd2l0aG91dCBhICJyb290IiBwcm9wZXJ0eS4gIFBsZWFzZSByZXZpZXcgeW91ciBKc29uUmVhZGVyIGNvbmZpZyBhbmQgbWFrZSBzdXJlIHRvIGRlZmluZSB0aGUgcm9vdCBwcm9wZXJ0eS4gIFNlZSB0aGUgSnNvblJlYWRlciBkb2NzLicsCiAgICAgICAgJ2lkUHJvcGVydHktdW5kZWZpbmVkJyA6ICdZb3VyIEpzb25SZWFkZXIgd2FzIGNvbmZpZ3VyZWQgd2l0aG91dCBhbiAiaWRQcm9wZXJ0eSIgIFBsZWFzZSByZXZpZXcgeW91ciBKc29uUmVhZGVyIGNvbmZpZ3VyYXRpb24gYW5kIGVuc3VyZSB0aGUgImlkUHJvcGVydHkiIGlzIHNldCAoZS5nLjogImlkIikuICBTZWUgdGhlIEpzb25SZWFkZXIgZG9jcy4nLAogICAgICAgICdyb290LWVtcHR5JzogJ0RhdGEgd2FzIGV4cGVjdGVkIHRvIGJlIHJldHVybmVkIGJ5IHRoZSBzZXJ2ZXIgaW4gdGhlICJyb290IiBwcm9wZXJ0eSBvZiB0aGUgcmVzcG9uc2UuICBQbGVhc2UgcmV2aWV3IHlvdXIgSnNvblJlYWRlciBjb25maWd1cmF0aW9uIHRvIGVuc3VyZSB0aGUgInJvb3QiIHByb3BlcnR5IG1hdGNoZXMgdGhhdCByZXR1cm5lZCBpbiB0aGUgc2VydmVyLXJlc3BvbnNlLiAgU2VlIEpzb25SZWFkZXIgZG9jcy4nCiAgICB9Cn0pOwoKRXh0LmRhdGEuQXJyYXlSZWFkZXIgPSBFeHQuZXh0ZW5kKEV4dC5kYXRhLkpzb25SZWFkZXIsIHsKICAgIAogICAgCiAgICAKICAgIAogICAgcmVhZFJlY29yZHMgOiBmdW5jdGlvbihvKXsKICAgICAgICB0aGlzLmFycmF5RGF0YSA9IG87CiAgICAgICAgdmFyIHMgPSB0aGlzLm1ldGEsCiAgICAgICAgICAgIHNpZCA9IHMgPyBFeHQubnVtKHMuaWRJbmRleCwgcy5pZCkgOiBudWxsLAogICAgICAgICAgICByZWNvcmRUeXBlID0gdGhpcy5yZWNvcmRUeXBlLAogICAgICAgICAgICBmaWVsZHMgPSByZWNvcmRUeXBlLnByb3RvdHlwZS5maWVsZHMsCiAgICAgICAgICAgIHJlY29yZHMgPSBbXSwKICAgICAgICAgICAgc3VjY2VzcyA9IHRydWUsCiAgICAgICAgICAgIHY7CgogICAgICAgIHZhciByb290ID0gdGhpcy5nZXRSb290KG8pOwoKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSByb290Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHZhciBuID0gcm9vdFtpXSwKICAgICAgICAgICAgICAgIHZhbHVlcyA9IHt9LAogICAgICAgICAgICAgICAgaWQgPSAoKHNpZCB8fCBzaWQgPT09IDApICYmIG5bc2lkXSAhPT0gdW5kZWZpbmVkICYmIG5bc2lkXSAhPT0gIiIgPyBuW3NpZF0gOiBudWxsKTsKICAgICAgICAgICAgZm9yKHZhciBqID0gMCwgamxlbiA9IGZpZWxkcy5sZW5ndGg7IGogPCBqbGVuOyBqKyspIHsKICAgICAgICAgICAgICAgIHZhciBmID0gZmllbGRzLml0ZW1zW2pdLAogICAgICAgICAgICAgICAgICAgIGsgPSBmLm1hcHBpbmcgIT09IHVuZGVmaW5lZCAmJiBmLm1hcHBpbmcgIT09IG51bGwgPyBmLm1hcHBpbmcgOiBqOwogICAgICAgICAgICAgICAgdiA9IG5ba10gIT09IHVuZGVmaW5lZCA/IG5ba10gOiBmLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgICAgIHYgPSBmLmNvbnZlcnQodiwgbik7CiAgICAgICAgICAgICAgICB2YWx1ZXNbZi5uYW1lXSA9IHY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlY29yZCA9IG5ldyByZWNvcmRUeXBlKHZhbHVlcywgaWQpOwogICAgICAgICAgICByZWNvcmQuanNvbiA9IG47CiAgICAgICAgICAgIHJlY29yZHNbcmVjb3Jkcy5sZW5ndGhdID0gcmVjb3JkOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRvdGFsUmVjb3JkcyA9IHJlY29yZHMubGVuZ3RoOwoKICAgICAgICBpZihzLnRvdGFsUHJvcGVydHkpIHsKICAgICAgICAgICAgdiA9IHBhcnNlSW50KHRoaXMuZ2V0VG90YWwobyksIDEwKTsKICAgICAgICAgICAgaWYoIWlzTmFOKHYpKSB7CiAgICAgICAgICAgICAgICB0b3RhbFJlY29yZHMgPSB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmKHMuc3VjY2Vzc1Byb3BlcnR5KXsKICAgICAgICAgICAgdiA9IHRoaXMuZ2V0U3VjY2VzcyhvKTsKICAgICAgICAgICAgaWYodiA9PT0gZmFsc2UgfHwgdiA9PT0gJ2ZhbHNlJyl7CiAgICAgICAgICAgICAgICBzdWNjZXNzID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHN1Y2Nlc3MgOiBzdWNjZXNzLAogICAgICAgICAgICByZWNvcmRzIDogcmVjb3JkcywKICAgICAgICAgICAgdG90YWxSZWNvcmRzIDogdG90YWxSZWNvcmRzCiAgICAgICAgfTsKICAgIH0KfSk7CkV4dC5kYXRhLkFycmF5U3RvcmUgPSBFeHQuZXh0ZW5kKEV4dC5kYXRhLlN0b3JlLCB7CiAgICAKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIEV4dC5kYXRhLkFycmF5U3RvcmUuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIEV4dC5hcHBseShjb25maWcsIHsKICAgICAgICAgICAgcmVhZGVyOiBuZXcgRXh0LmRhdGEuQXJyYXlSZWFkZXIoY29uZmlnKQogICAgICAgIH0pKTsKICAgIH0sCgogICAgbG9hZERhdGEgOiBmdW5jdGlvbihkYXRhLCBhcHBlbmQpewogICAgICAgIGlmKHRoaXMuZXhwYW5kRGF0YSA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHZhciByID0gW107CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGRhdGEubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgcltyLmxlbmd0aF0gPSBbZGF0YVtpXV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YSA9IHI7CiAgICAgICAgfQogICAgICAgIEV4dC5kYXRhLkFycmF5U3RvcmUuc3VwZXJjbGFzcy5sb2FkRGF0YS5jYWxsKHRoaXMsIGRhdGEsIGFwcGVuZCk7CiAgICB9Cn0pOwpFeHQucmVnKCdhcnJheXN0b3JlJywgRXh0LmRhdGEuQXJyYXlTdG9yZSk7CgoKRXh0LmRhdGEuU2ltcGxlU3RvcmUgPSBFeHQuZGF0YS5BcnJheVN0b3JlOwpFeHQucmVnKCdzaW1wbGVzdG9yZScsIEV4dC5kYXRhLlNpbXBsZVN0b3JlKTsKRXh0LmRhdGEuSnNvblN0b3JlID0gRXh0LmV4dGVuZChFeHQuZGF0YS5TdG9yZSwgewogICAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBFeHQuZGF0YS5Kc29uU3RvcmUuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIEV4dC5hcHBseShjb25maWcsIHsKICAgICAgICAgICAgcmVhZGVyOiBuZXcgRXh0LmRhdGEuSnNvblJlYWRlcihjb25maWcpCiAgICAgICAgfSkpOwogICAgfQp9KTsKRXh0LnJlZygnanNvbnN0b3JlJywgRXh0LmRhdGEuSnNvblN0b3JlKTsKRXh0LmRhdGEuWG1sV3JpdGVyID0gZnVuY3Rpb24ocGFyYW1zKSB7CiAgICBFeHQuZGF0YS5YbWxXcml0ZXIuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgCiAgICB0aGlzLnRwbCA9ICh0eXBlb2YodGhpcy50cGwpID09PSAnc3RyaW5nJykgPyBuZXcgRXh0LlhUZW1wbGF0ZSh0aGlzLnRwbCkuY29tcGlsZSgpIDogdGhpcy50cGwuY29tcGlsZSgpOwp9OwpFeHQuZXh0ZW5kKEV4dC5kYXRhLlhtbFdyaXRlciwgRXh0LmRhdGEuRGF0YVdyaXRlciwgewogICAgCiAgICBkb2N1bWVudFJvb3Q6ICd4cmVxdWVzdCcsCiAgICAKICAgIGZvcmNlRG9jdW1lbnRSb290OiBmYWxzZSwKICAgIAogICAgcm9vdDogJ3JlY29yZHMnLAogICAgCiAgICB4bWxWZXJzaW9uIDogJzEuMCcsCiAgICAKICAgIHhtbEVuY29kaW5nOiAnSVNPLTg4NTktMTUnLAogICAgCiAgICAKICAgIHRwbDogJzx0cGwgZm9yPSIuIj48XHUwMDNmeG1sIHZlcnNpb249Int2ZXJzaW9ufSIgZW5jb2Rpbmc9IntlbmNvZGluZ30iXHUwMDNmPjx0cGwgaWY9ImRvY3VtZW50Um9vdCI+PHtkb2N1bWVudFJvb3R9Pjx0cGwgZm9yPSJiYXNlUGFyYW1zIj48dHBsIGZvcj0iLiI+PHtuYW1lfT57dmFsdWV9PC97bmFtZX0+PC90cGw+PC90cGw+PC90cGw+PHRwbCBpZj0icmVjb3Jkcy5sZW5ndGgmZ3Q7MSI+PHtyb290fT48L3RwbD48dHBsIGZvcj0icmVjb3JkcyI+PHtwYXJlbnQucmVjb3JkfT48dHBsIGZvcj0iLiI+PHtuYW1lfT57dmFsdWV9PC97bmFtZX0+PC90cGw+PC97cGFyZW50LnJlY29yZH0+PC90cGw+PHRwbCBpZj0icmVjb3Jkcy5sZW5ndGgmZ3Q7MSI+PC97cm9vdH0+PC90cGw+PHRwbCBpZj0iZG9jdW1lbnRSb290Ij48L3tkb2N1bWVudFJvb3R9PjwvdHBsPjwvdHBsPicsCgoKICAgIAogICAgcmVuZGVyIDogZnVuY3Rpb24ocGFyYW1zLCBiYXNlUGFyYW1zLCBkYXRhKSB7CiAgICAgICAgYmFzZVBhcmFtcyA9IHRoaXMudG9BcnJheShiYXNlUGFyYW1zKTsKICAgICAgICBwYXJhbXMueG1sRGF0YSA9IHRoaXMudHBsLmFwcGx5VGVtcGxhdGUoewogICAgICAgICAgICB2ZXJzaW9uOiB0aGlzLnhtbFZlcnNpb24sCiAgICAgICAgICAgIGVuY29kaW5nOiB0aGlzLnhtbEVuY29kaW5nLAogICAgICAgICAgICBkb2N1bWVudFJvb3Q6IChiYXNlUGFyYW1zLmxlbmd0aCA+IDAgfHwgdGhpcy5mb3JjZURvY3VtZW50Um9vdCA9PT0gdHJ1ZSkgPyB0aGlzLmRvY3VtZW50Um9vdCA6IGZhbHNlLAogICAgICAgICAgICByZWNvcmQ6IHRoaXMubWV0YS5yZWNvcmQsCiAgICAgICAgICAgIHJvb3Q6IHRoaXMucm9vdCwKICAgICAgICAgICAgYmFzZVBhcmFtczogYmFzZVBhcmFtcywKICAgICAgICAgICAgcmVjb3JkczogKEV4dC5pc0FycmF5KGRhdGFbMF0pKSA/IGRhdGEgOiBbZGF0YV0KICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVSZWNvcmQgOiBmdW5jdGlvbihyZWMpIHsKICAgICAgICByZXR1cm4gdGhpcy50b0FycmF5KHRoaXMudG9IYXNoKHJlYykpOwogICAgfSwKCiAgICAKICAgIHVwZGF0ZVJlY29yZCA6IGZ1bmN0aW9uKHJlYykgewogICAgICAgIHJldHVybiB0aGlzLnRvQXJyYXkodGhpcy50b0hhc2gocmVjKSk7CgogICAgfSwKICAgIAogICAgZGVzdHJveVJlY29yZCA6IGZ1bmN0aW9uKHJlYykgewogICAgICAgIHZhciBkYXRhID0ge307CiAgICAgICAgZGF0YVt0aGlzLm1ldGEuaWRQcm9wZXJ0eV0gPSByZWMuaWQ7CiAgICAgICAgcmV0dXJuIHRoaXMudG9BcnJheShkYXRhKTsKICAgIH0KfSk7CgpFeHQuZGF0YS5YbWxSZWFkZXIgPSBmdW5jdGlvbihtZXRhLCByZWNvcmRUeXBlKXsKICAgIG1ldGEgPSBtZXRhIHx8IHt9OwoKICAgIAogICAgRXh0LmFwcGx5SWYobWV0YSwgewogICAgICAgIGlkUHJvcGVydHk6IG1ldGEuaWRQcm9wZXJ0eSB8fCBtZXRhLmlkUGF0aCB8fCBtZXRhLmlkLAogICAgICAgIHN1Y2Nlc3NQcm9wZXJ0eTogbWV0YS5zdWNjZXNzUHJvcGVydHkgfHwgbWV0YS5zdWNjZXNzCiAgICB9KTsKCiAgICBFeHQuZGF0YS5YbWxSZWFkZXIuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIG1ldGEsIHJlY29yZFR5cGUgfHwgbWV0YS5maWVsZHMpOwp9OwpFeHQuZXh0ZW5kKEV4dC5kYXRhLlhtbFJlYWRlciwgRXh0LmRhdGEuRGF0YVJlYWRlciwgewogICAgCiAgICByZWFkIDogZnVuY3Rpb24ocmVzcG9uc2UpewogICAgICAgIHZhciBkb2MgPSByZXNwb25zZS5yZXNwb25zZVhNTDsKICAgICAgICBpZighZG9jKSB7CiAgICAgICAgICAgIHRocm93IHttZXNzYWdlOiAiWG1sUmVhZGVyLnJlYWQ6IFhNTCBEb2N1bWVudCBub3QgYXZhaWxhYmxlIn07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLnJlYWRSZWNvcmRzKGRvYyk7CiAgICB9LAoKICAgIAogICAgcmVhZFJlY29yZHMgOiBmdW5jdGlvbihkb2MpewogICAgICAgIAogICAgICAgIHRoaXMueG1sRGF0YSA9IGRvYzsKCiAgICAgICAgdmFyIHJvb3QgICAgPSBkb2MuZG9jdW1lbnRFbGVtZW50IHx8IGRvYywKICAgICAgICAgICAgcSAgICAgICA9IEV4dC5Eb21RdWVyeSwKICAgICAgICAgICAgdG90YWxSZWNvcmRzID0gMCwKICAgICAgICAgICAgc3VjY2VzcyA9IHRydWU7CgogICAgICAgIGlmKHRoaXMubWV0YS50b3RhbFByb3BlcnR5KXsKICAgICAgICAgICAgdG90YWxSZWNvcmRzID0gdGhpcy5nZXRUb3RhbChyb290LCAwKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5tZXRhLnN1Y2Nlc3NQcm9wZXJ0eSl7CiAgICAgICAgICAgIHN1Y2Nlc3MgPSB0aGlzLmdldFN1Y2Nlc3Mocm9vdCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVjb3JkcyA9IHRoaXMuZXh0cmFjdERhdGEocS5zZWxlY3QodGhpcy5tZXRhLnJlY29yZCwgcm9vdCksIHRydWUpOyAKCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgc3VjY2VzcyA6IHN1Y2Nlc3MsCiAgICAgICAgICAgIHJlY29yZHMgOiByZWNvcmRzLAogICAgICAgICAgICB0b3RhbFJlY29yZHMgOiB0b3RhbFJlY29yZHMgfHwgcmVjb3Jkcy5sZW5ndGgKICAgICAgICB9OwogICAgfSwKCiAgICAKICAgIHJlYWRSZXNwb25zZSA6IGZ1bmN0aW9uKGFjdGlvbiwgcmVzcG9uc2UpIHsKICAgICAgICB2YXIgcSA9IEV4dC5Eb21RdWVyeSwKICAgICAgICAgICAgZG9jID0gcmVzcG9uc2UucmVzcG9uc2VYTUwsCiAgICAgICAgICAgIHJvb3QgPSBkb2MuZG9jdW1lbnRFbGVtZW50IHx8IGRvYzsKCiAgICAgICAgCiAgICAgICAgdmFyIHJlcyA9IG5ldyBFeHQuZGF0YS5SZXNwb25zZSh7CiAgICAgICAgICAgIGFjdGlvbjogYWN0aW9uLAogICAgICAgICAgICBzdWNjZXNzIDogdGhpcy5nZXRTdWNjZXNzKHJvb3QpLAogICAgICAgICAgICBtZXNzYWdlOiB0aGlzLmdldE1lc3NhZ2Uocm9vdCksCiAgICAgICAgICAgIGRhdGE6IHRoaXMuZXh0cmFjdERhdGEocS5zZWxlY3QodGhpcy5tZXRhLnJlY29yZCwgcm9vdCkgfHwgcS5zZWxlY3QodGhpcy5tZXRhLnJvb3QsIHJvb3QpLCBmYWxzZSksCiAgICAgICAgICAgIHJhdzogZG9jCiAgICAgICAgfSk7CgogICAgICAgIGlmIChFeHQuaXNFbXB0eShyZXMuc3VjY2VzcykpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEV4dC5kYXRhLkRhdGFSZWFkZXIuRXJyb3IoJ3N1Y2Nlc3NQcm9wZXJ0eS1yZXNwb25zZScsIHRoaXMubWV0YS5zdWNjZXNzUHJvcGVydHkpOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYgKGFjdGlvbiA9PT0gRXh0LmRhdGEuQXBpLmFjdGlvbnMuY3JlYXRlKSB7CiAgICAgICAgICAgIHZhciBkZWYgPSBFeHQuaXNEZWZpbmVkKHJlcy5kYXRhKTsKICAgICAgICAgICAgaWYgKGRlZiAmJiBFeHQuaXNFbXB0eShyZXMuZGF0YSkpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeHQuZGF0YS5Kc29uUmVhZGVyLkVycm9yKCdyb290LWVtcHR5JywgdGhpcy5tZXRhLnJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCFkZWYpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFeHQuZGF0YS5Kc29uUmVhZGVyLkVycm9yKCdyb290LXVuZGVmaW5lZC1yZXNwb25zZScsIHRoaXMubWV0YS5yb290KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzOwogICAgfSwKCiAgICBnZXRTdWNjZXNzIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIAogICAgYnVpbGRFeHRyYWN0b3JzIDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYodGhpcy5lZil7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHMgICAgICAgPSB0aGlzLm1ldGEsCiAgICAgICAgICAgIFJlY29yZCAgPSB0aGlzLnJlY29yZFR5cGUsCiAgICAgICAgICAgIGYgICAgICAgPSBSZWNvcmQucHJvdG90eXBlLmZpZWxkcywKICAgICAgICAgICAgZmkgICAgICA9IGYuaXRlbXMsCiAgICAgICAgICAgIGZsICAgICAgPSBmLmxlbmd0aDsKCiAgICAgICAgaWYocy50b3RhbFByb3BlcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZ2V0VG90YWwgPSB0aGlzLmNyZWF0ZUFjY2Vzc29yKHMudG90YWxQcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIGlmKHMuc3VjY2Vzc1Byb3BlcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZ2V0U3VjY2VzcyA9IHRoaXMuY3JlYXRlQWNjZXNzb3Iocy5zdWNjZXNzUHJvcGVydHkpOwogICAgICAgIH0KICAgICAgICBpZiAocy5tZXNzYWdlUHJvcGVydHkpIHsKICAgICAgICAgICAgdGhpcy5nZXRNZXNzYWdlID0gdGhpcy5jcmVhdGVBY2Nlc3NvcihzLm1lc3NhZ2VQcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZ2V0Um9vdCA9IGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICByZXR1cm4gKCFFeHQuaXNFbXB0eShyZXNbdGhpcy5tZXRhLnJlY29yZF0pKSA/IHJlc1t0aGlzLm1ldGEucmVjb3JkXSA6IHJlc1t0aGlzLm1ldGEucm9vdF07CiAgICAgICAgfTsKICAgICAgICBpZiAocy5pZFBhdGggfHwgcy5pZFByb3BlcnR5KSB7CiAgICAgICAgICAgIHZhciBnID0gdGhpcy5jcmVhdGVBY2Nlc3NvcihzLmlkUGF0aCB8fCBzLmlkUHJvcGVydHkpOwogICAgICAgICAgICB0aGlzLmdldElkID0gZnVuY3Rpb24ocmVjKSB7CiAgICAgICAgICAgICAgICB2YXIgaWQgPSBnKHJlYykgfHwgcmVjLmlkOwogICAgICAgICAgICAgICAgcmV0dXJuIChpZCA9PT0gdW5kZWZpbmVkIHx8IGlkID09PSAnJykgPyBudWxsIDogaWQ7CiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5nZXRJZCA9IGZ1bmN0aW9uKCl7cmV0dXJuIG51bGw7fTsKICAgICAgICB9CiAgICAgICAgdmFyIGVmID0gW107CiAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGZsOyBpKyspewogICAgICAgICAgICBmID0gZmlbaV07CiAgICAgICAgICAgIHZhciBtYXAgPSAoZi5tYXBwaW5nICE9PSB1bmRlZmluZWQgJiYgZi5tYXBwaW5nICE9PSBudWxsKSA/IGYubWFwcGluZyA6IGYubmFtZTsKICAgICAgICAgICAgZWYucHVzaCh0aGlzLmNyZWF0ZUFjY2Vzc29yKG1hcCkpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVmID0gZWY7CiAgICB9LAoKICAgIAogICAgY3JlYXRlQWNjZXNzb3IgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBxID0gRXh0LkRvbVF1ZXJ5OwogICAgICAgIHJldHVybiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgaWYgKEV4dC5pc0Z1bmN0aW9uKGtleSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoKGtleSkgewogICAgICAgICAgICAgICAgY2FzZSB0aGlzLm1ldGEudG90YWxQcm9wZXJ0eToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ocm9vdCwgZGVmKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHEuc2VsZWN0TnVtYmVyKGtleSwgcm9vdCwgZGVmKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSB0aGlzLm1ldGEuc3VjY2Vzc1Byb3BlcnR5OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihyb290LCBkZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN2ID0gcS5zZWxlY3RWYWx1ZShrZXksIHJvb3QsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3VjY2VzcyA9IHN2ICE9PSBmYWxzZSAmJiBzdiAhPT0gJ2ZhbHNlJzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1Y2Nlc3M7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHJvb3QsIGRlZikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcS5zZWxlY3RWYWx1ZShrZXksIHJvb3QsIGRlZik7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KCksCgogICAgCiAgICBleHRyYWN0VmFsdWVzIDogZnVuY3Rpb24oZGF0YSwgaXRlbXMsIGxlbikgewogICAgICAgIHZhciBmLCB2YWx1ZXMgPSB7fTsKICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbGVuOyBqKyspewogICAgICAgICAgICBmID0gaXRlbXNbal07CiAgICAgICAgICAgIHZhciB2ID0gdGhpcy5lZltqXShkYXRhKTsKICAgICAgICAgICAgdmFsdWVzW2YubmFtZV0gPSBmLmNvbnZlcnQoKHYgIT09IHVuZGVmaW5lZCkgPyB2IDogZi5kZWZhdWx0VmFsdWUsIGRhdGEpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgfQp9KTsKRXh0LmRhdGEuWG1sU3RvcmUgPSBFeHQuZXh0ZW5kKEV4dC5kYXRhLlN0b3JlLCB7CiAgICAKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIEV4dC5kYXRhLlhtbFN0b3JlLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBFeHQuYXBwbHkoY29uZmlnLCB7CiAgICAgICAgICAgIHJlYWRlcjogbmV3IEV4dC5kYXRhLlhtbFJlYWRlcihjb25maWcpCiAgICAgICAgfSkpOwogICAgfQp9KTsKRXh0LnJlZygneG1sc3RvcmUnLCBFeHQuZGF0YS5YbWxTdG9yZSk7CkV4dC5kYXRhLkdyb3VwaW5nU3RvcmUgPSBFeHQuZXh0ZW5kKEV4dC5kYXRhLlN0b3JlLCB7CgogICAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgY29uZmlnID0gY29uZmlnIHx8IHt9OwoKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICB0aGlzLmhhc011bHRpU29ydCAgPSB0cnVlOwogICAgICAgIHRoaXMubXVsdGlTb3J0SW5mbyA9IHRoaXMubXVsdGlTb3J0SW5mbyB8fCB7c29ydGVyczogW119OwoKICAgICAgICB2YXIgc29ydGVycyAgICA9IHRoaXMubXVsdGlTb3J0SW5mby5zb3J0ZXJzLAogICAgICAgICAgICBncm91cEZpZWxkID0gY29uZmlnLmdyb3VwRmllbGQgfHwgdGhpcy5ncm91cEZpZWxkLAogICAgICAgICAgICBzb3J0SW5mbyAgID0gY29uZmlnLnNvcnRJbmZvIHx8IHRoaXMuc29ydEluZm8sCiAgICAgICAgICAgIGdyb3VwRGlyICAgPSBjb25maWcuZ3JvdXBEaXIgfHwgdGhpcy5ncm91cERpcjsKCiAgICAgICAgCiAgICAgICAgaWYoZ3JvdXBGaWVsZCl7CiAgICAgICAgICAgIHNvcnRlcnMucHVzaCh7CiAgICAgICAgICAgICAgICBmaWVsZCAgICA6IGdyb3VwRmllbGQsCiAgICAgICAgICAgICAgICBkaXJlY3Rpb246IGdyb3VwRGlyCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYgKHNvcnRJbmZvKSB7CiAgICAgICAgICAgIHNvcnRlcnMucHVzaChzb3J0SW5mbyk7CiAgICAgICAgfQoKICAgICAgICBFeHQuZGF0YS5Hcm91cGluZ1N0b3JlLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBjb25maWcpOwoKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgIAogICAgICAgICAgJ2dyb3VwY2hhbmdlJwogICAgICAgICk7CgogICAgICAgIHRoaXMuYXBwbHlHcm91cEZpZWxkKCk7CiAgICB9LAoKICAgIAogICAgCiAgICByZW1vdGVHcm91cCA6IGZhbHNlLAogICAgCiAgICBncm91cE9uU29ydDpmYWxzZSwKCiAgICAKICAgIGdyb3VwRGlyIDogJ0FTQycsCgogICAgCiAgICBjbGVhckdyb3VwaW5nIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmdyb3VwRmllbGQgPSBmYWxzZTsKCiAgICAgICAgaWYodGhpcy5yZW1vdGVHcm91cCl7CiAgICAgICAgICAgIGlmKHRoaXMuYmFzZVBhcmFtcyl7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5iYXNlUGFyYW1zLmdyb3VwQnk7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5iYXNlUGFyYW1zLmdyb3VwRGlyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsbyA9IHRoaXMubGFzdE9wdGlvbnM7CiAgICAgICAgICAgIGlmKGxvICYmIGxvLnBhcmFtcyl7CiAgICAgICAgICAgICAgICBkZWxldGUgbG8ucGFyYW1zLmdyb3VwQnk7CiAgICAgICAgICAgICAgICBkZWxldGUgbG8ucGFyYW1zLmdyb3VwRGlyOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnJlbG9hZCgpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLnNvcnQoKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2RhdGFjaGFuZ2VkJywgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdyb3VwQnkgOiBmdW5jdGlvbihmaWVsZCwgZm9yY2VSZWdyb3VwLCBkaXJlY3Rpb24pIHsKICAgICAgICBkaXJlY3Rpb24gPSBkaXJlY3Rpb24gPyAoU3RyaW5nKGRpcmVjdGlvbikudG9VcHBlckNhc2UoKSA9PSAnREVTQycgPyAnREVTQycgOiAnQVNDJykgOiB0aGlzLmdyb3VwRGlyOwoKICAgICAgICBpZiAodGhpcy5ncm91cEZpZWxkID09IGZpZWxkICYmIHRoaXMuZ3JvdXBEaXIgPT0gZGlyZWN0aW9uICYmICFmb3JjZVJlZ3JvdXApIHsKICAgICAgICAgICAgcmV0dXJuOyAKICAgICAgICB9CgogICAgICAgIAogICAgICAgIAogICAgICAgIHZhciBzb3J0ZXJzID0gdGhpcy5tdWx0aVNvcnRJbmZvLnNvcnRlcnM7CiAgICAgICAgaWYgKHNvcnRlcnMubGVuZ3RoID4gMCAmJiBzb3J0ZXJzWzBdLmZpZWxkID09IHRoaXMuZ3JvdXBGaWVsZCkgewogICAgICAgICAgICBzb3J0ZXJzLnNoaWZ0KCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmdyb3VwRmllbGQgPSBmaWVsZDsKICAgICAgICB0aGlzLmdyb3VwRGlyID0gZGlyZWN0aW9uOwogICAgICAgIHRoaXMuYXBwbHlHcm91cEZpZWxkKCk7CgogICAgICAgIHZhciBmaXJlR3JvdXBFdmVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZ3JvdXBjaGFuZ2UnLCB0aGlzLCB0aGlzLmdldEdyb3VwU3RhdGUoKSk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKHRoaXMuZ3JvdXBPblNvcnQpIHsKICAgICAgICAgICAgdGhpcy5zb3J0KGZpZWxkLCBkaXJlY3Rpb24pOwogICAgICAgICAgICBmaXJlR3JvdXBFdmVudC5jYWxsKHRoaXMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5yZW1vdGVHcm91cCkgewogICAgICAgICAgICB0aGlzLm9uKCdsb2FkJywgZmlyZUdyb3VwRXZlbnQsIHRoaXMsIHtzaW5nbGU6IHRydWV9KTsKICAgICAgICAgICAgdGhpcy5yZWxvYWQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnNvcnQoc29ydGVycyk7CiAgICAgICAgICAgIGZpcmVHcm91cEV2ZW50LmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIAogICAgc29ydCA6IGZ1bmN0aW9uKGZpZWxkTmFtZSwgZGlyKSB7CiAgICAgICAgaWYgKHRoaXMucmVtb3RlU29ydCkgewogICAgICAgICAgICByZXR1cm4gRXh0LmRhdGEuR3JvdXBpbmdTdG9yZS5zdXBlcmNsYXNzLnNvcnQuY2FsbCh0aGlzLCBmaWVsZE5hbWUsIGRpcik7CiAgICAgICAgfQoKICAgICAgICB2YXIgc29ydGVycyA9IFtdOwoKICAgICAgICAKICAgICAgICBpZiAoRXh0LmlzQXJyYXkoYXJndW1lbnRzWzBdKSkgewogICAgICAgICAgICBzb3J0ZXJzID0gYXJndW1lbnRzWzBdOwogICAgICAgIH0gZWxzZSBpZiAoZmllbGROYW1lID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHNvcnRlcnMgPSB0aGlzLnNvcnRJbmZvID8gW3RoaXMuc29ydEluZm9dIDogW107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgZmllbGQgPSB0aGlzLmZpZWxkcy5nZXQoZmllbGROYW1lKTsKICAgICAgICAgICAgaWYgKCFmaWVsZCkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgdmFyIG5hbWUgICAgICAgPSBmaWVsZC5uYW1lLAogICAgICAgICAgICAgICAgc29ydEluZm8gICA9IHRoaXMuc29ydEluZm8gfHwgbnVsbCwKICAgICAgICAgICAgICAgIHNvcnRUb2dnbGUgPSB0aGlzLnNvcnRUb2dnbGUgPyB0aGlzLnNvcnRUb2dnbGVbbmFtZV0gOiBudWxsOwoKICAgICAgICAgICAgaWYgKCFkaXIpIHsKICAgICAgICAgICAgICAgIGlmIChzb3J0SW5mbyAmJiBzb3J0SW5mby5maWVsZCA9PSBuYW1lKSB7IAogICAgICAgICAgICAgICAgICAgIGRpciA9ICh0aGlzLnNvcnRUb2dnbGVbbmFtZV0gfHwgJ0FTQycpLnRvZ2dsZSgnQVNDJywgJ0RFU0MnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGlyID0gZmllbGQuc29ydERpcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zb3J0VG9nZ2xlW25hbWVdID0gZGlyOwogICAgICAgICAgICB0aGlzLnNvcnRJbmZvID0ge2ZpZWxkOiBuYW1lLCBkaXJlY3Rpb246IGRpcn07CgogICAgICAgICAgICBzb3J0ZXJzID0gW3RoaXMuc29ydEluZm9dOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuZ3JvdXBGaWVsZCkgewogICAgICAgICAgICBzb3J0ZXJzLnVuc2hpZnQoe2RpcmVjdGlvbjogdGhpcy5ncm91cERpciwgZmllbGQ6IHRoaXMuZ3JvdXBGaWVsZH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMubXVsdGlTb3J0LmNhbGwodGhpcywgc29ydGVycywgZGlyKTsKICAgIH0sCgogICAgCiAgICBhcHBseUdyb3VwRmllbGQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMucmVtb3RlR3JvdXApIHsKICAgICAgICAgICAgaWYoIXRoaXMuYmFzZVBhcmFtcyl7CiAgICAgICAgICAgICAgICB0aGlzLmJhc2VQYXJhbXMgPSB7fTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgRXh0LmFwcGx5KHRoaXMuYmFzZVBhcmFtcywgewogICAgICAgICAgICAgICAgZ3JvdXBCeSA6IHRoaXMuZ3JvdXBGaWVsZCwKICAgICAgICAgICAgICAgIGdyb3VwRGlyOiB0aGlzLmdyb3VwRGlyCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIGxvID0gdGhpcy5sYXN0T3B0aW9uczsKICAgICAgICAgICAgaWYgKGxvICYmIGxvLnBhcmFtcykgewogICAgICAgICAgICAgICAgbG8ucGFyYW1zLmdyb3VwRGlyID0gdGhpcy5ncm91cERpcjsKCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGRlbGV0ZSBsby5wYXJhbXMuZ3JvdXBCeTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhcHBseUdyb3VwaW5nIDogZnVuY3Rpb24oYWx3YXlzRmlyZUNoYW5nZSl7CiAgICAgICAgaWYodGhpcy5ncm91cEZpZWxkICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuZ3JvdXBCeSh0aGlzLmdyb3VwRmllbGQsIHRydWUsIHRoaXMuZ3JvdXBEaXIpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgaWYoYWx3YXlzRmlyZUNoYW5nZSA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZGF0YWNoYW5nZWQnLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldEdyb3VwU3RhdGUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmdyb3VwT25Tb3J0ICYmIHRoaXMuZ3JvdXBGaWVsZCAhPT0gZmFsc2UgPwogICAgICAgICAgICAgICAodGhpcy5zb3J0SW5mbyA/IHRoaXMuc29ydEluZm8uZmllbGQgOiB1bmRlZmluZWQpIDogdGhpcy5ncm91cEZpZWxkOwogICAgfQp9KTsKRXh0LnJlZygnZ3JvdXBpbmdzdG9yZScsIEV4dC5kYXRhLkdyb3VwaW5nU3RvcmUpOwoKRXh0LmRhdGEuRGlyZWN0UHJveHkgPSBmdW5jdGlvbihjb25maWcpewogICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CiAgICBpZih0eXBlb2YgdGhpcy5wYXJhbU9yZGVyID09ICdzdHJpbmcnKXsKICAgICAgICB0aGlzLnBhcmFtT3JkZXIgPSB0aGlzLnBhcmFtT3JkZXIuc3BsaXQoL1tccyx8XS8pOwogICAgfQogICAgRXh0LmRhdGEuRGlyZWN0UHJveHkuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGNvbmZpZyk7Cn07CgpFeHQuZXh0ZW5kKEV4dC5kYXRhLkRpcmVjdFByb3h5LCBFeHQuZGF0YS5EYXRhUHJveHksIHsKICAgIAogICAgcGFyYW1PcmRlcjogdW5kZWZpbmVkLAoKICAgIAogICAgcGFyYW1zQXNIYXNoOiB0cnVlLAoKICAgIAogICAgZGlyZWN0Rm4gOiB1bmRlZmluZWQsCgogICAgCiAgICBkb1JlcXVlc3QgOiBmdW5jdGlvbihhY3Rpb24sIHJzLCBwYXJhbXMsIHJlYWRlciwgY2FsbGJhY2ssIHNjb3BlLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgICAgZGlyZWN0Rm4gPSB0aGlzLmFwaVthY3Rpb25dIHx8IHRoaXMuZGlyZWN0Rm47CgogICAgICAgIHN3aXRjaCAoYWN0aW9uKSB7CiAgICAgICAgICAgIGNhc2UgRXh0LmRhdGEuQXBpLmFjdGlvbnMuY3JlYXRlOgogICAgICAgICAgICAgICAgYXJncy5wdXNoKHBhcmFtcy5qc29uRGF0YSk7CQkKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEV4dC5kYXRhLkFwaS5hY3Rpb25zLnJlYWQ6CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmKGRpcmVjdEZuLmRpcmVjdENmZy5tZXRob2QubGVuID4gMCl7CiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5wYXJhbU9yZGVyKXsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gdGhpcy5wYXJhbU9yZGVyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChwYXJhbXNbdGhpcy5wYXJhbU9yZGVyW2ldXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZih0aGlzLnBhcmFtc0FzSGFzaCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChwYXJhbXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEV4dC5kYXRhLkFwaS5hY3Rpb25zLnVwZGF0ZToKICAgICAgICAgICAgICAgIGFyZ3MucHVzaChwYXJhbXMuanNvbkRhdGEpOyAgICAgICAgCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBFeHQuZGF0YS5BcGkuYWN0aW9ucy5kZXN0cm95OgogICAgICAgICAgICAgICAgYXJncy5wdXNoKHBhcmFtcy5qc29uRGF0YSk7ICAgICAgICAKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRyYW5zID0gewogICAgICAgICAgICBwYXJhbXMgOiBwYXJhbXMgfHwge30sCiAgICAgICAgICAgIHJlcXVlc3Q6IHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrIDogY2FsbGJhY2ssCiAgICAgICAgICAgICAgICBzY29wZSA6IHNjb3BlLAogICAgICAgICAgICAgICAgYXJnIDogb3B0aW9ucwogICAgICAgICAgICB9LAogICAgICAgICAgICByZWFkZXI6IHJlYWRlcgogICAgICAgIH07CgogICAgICAgIGFyZ3MucHVzaCh0aGlzLmNyZWF0ZUNhbGxiYWNrKGFjdGlvbiwgcnMsIHRyYW5zKSwgdGhpcyk7CiAgICAgICAgZGlyZWN0Rm4uYXBwbHkod2luZG93LCBhcmdzKTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVDYWxsYmFjayA6IGZ1bmN0aW9uKGFjdGlvbiwgcnMsIHRyYW5zKSB7CiAgICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ocmVzdWx0LCByZXMpIHsKICAgICAgICAgICAgaWYgKCFyZXMuc3RhdHVzKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChhY3Rpb24gPT09IEV4dC5kYXRhLkFwaS5hY3Rpb25zLnJlYWQpIHsKICAgICAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoImxvYWRleGNlcHRpb24iLCBtZSwgdHJhbnMsIHJlcywgbnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtZS5maXJlRXZlbnQoJ2V4Y2VwdGlvbicsIG1lLCAncmVtb3RlJywgYWN0aW9uLCB0cmFucywgcmVzLCBudWxsKTsKICAgICAgICAgICAgICAgIHRyYW5zLnJlcXVlc3QuY2FsbGJhY2suY2FsbCh0cmFucy5yZXF1ZXN0LnNjb3BlLCBudWxsLCB0cmFucy5yZXF1ZXN0LmFyZywgZmFsc2UpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhY3Rpb24gPT09IEV4dC5kYXRhLkFwaS5hY3Rpb25zLnJlYWQpIHsKICAgICAgICAgICAgICAgIG1lLm9uUmVhZChhY3Rpb24sIHRyYW5zLCByZXN1bHQsIHJlcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZS5vbldyaXRlKGFjdGlvbiwgdHJhbnMsIHJlc3VsdCwgcmVzLCBycyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSwKCiAgICAKICAgIG9uUmVhZCA6IGZ1bmN0aW9uKGFjdGlvbiwgdHJhbnMsIHJlc3VsdCwgcmVzKSB7CiAgICAgICAgdmFyIHJlY29yZHM7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmVjb3JkcyA9IHRyYW5zLnJlYWRlci5yZWFkUmVjb3JkcyhyZXN1bHQpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJsb2FkZXhjZXB0aW9uIiwgdGhpcywgdHJhbnMsIHJlcywgZXgpOwoKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2V4Y2VwdGlvbicsIHRoaXMsICdyZXNwb25zZScsIGFjdGlvbiwgdHJhbnMsIHJlcywgZXgpOwogICAgICAgICAgICB0cmFucy5yZXF1ZXN0LmNhbGxiYWNrLmNhbGwodHJhbnMucmVxdWVzdC5zY29wZSwgbnVsbCwgdHJhbnMucmVxdWVzdC5hcmcsIGZhbHNlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgibG9hZCIsIHRoaXMsIHJlcywgdHJhbnMucmVxdWVzdC5hcmcpOwogICAgICAgIHRyYW5zLnJlcXVlc3QuY2FsbGJhY2suY2FsbCh0cmFucy5yZXF1ZXN0LnNjb3BlLCByZWNvcmRzLCB0cmFucy5yZXF1ZXN0LmFyZywgdHJ1ZSk7CiAgICB9LAogICAgCiAgICBvbldyaXRlIDogZnVuY3Rpb24oYWN0aW9uLCB0cmFucywgcmVzdWx0LCByZXMsIHJzKSB7CiAgICAgICAgdmFyIGRhdGEgPSB0cmFucy5yZWFkZXIuZXh0cmFjdERhdGEodHJhbnMucmVhZGVyLmdldFJvb3QocmVzdWx0KSwgZmFsc2UpOwogICAgICAgIHZhciBzdWNjZXNzID0gdHJhbnMucmVhZGVyLmdldFN1Y2Nlc3MocmVzdWx0KTsKICAgICAgICBzdWNjZXNzID0gKHN1Y2Nlc3MgIT09IGZhbHNlKTsKICAgICAgICBpZiAoc3VjY2Vzcyl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJ3cml0ZSIsIHRoaXMsIGFjdGlvbiwgZGF0YSwgcmVzLCBycywgdHJhbnMucmVxdWVzdC5hcmcpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgdGhpcywgJ3JlbW90ZScsIGFjdGlvbiwgdHJhbnMsIHJlc3VsdCwgcnMpOwogICAgICAgIH0KICAgICAgICB0cmFucy5yZXF1ZXN0LmNhbGxiYWNrLmNhbGwodHJhbnMucmVxdWVzdC5zY29wZSwgZGF0YSwgcmVzLCBzdWNjZXNzKTsKICAgIH0KfSk7CgpFeHQuZGF0YS5EaXJlY3RTdG9yZSA9IEV4dC5leHRlbmQoRXh0LmRhdGEuU3RvcmUsIHsKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICAKICAgICAgICB2YXIgYyA9IEV4dC5hcHBseSh7fSwgewogICAgICAgICAgICBiYXRjaFRyYW5zYWN0aW9uczogZmFsc2UKICAgICAgICB9LCBjb25maWcpOwogICAgICAgIEV4dC5kYXRhLkRpcmVjdFN0b3JlLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBFeHQuYXBwbHkoYywgewogICAgICAgICAgICBwcm94eTogRXh0LmlzRGVmaW5lZChjLnByb3h5KSA/IGMucHJveHkgOiBuZXcgRXh0LmRhdGEuRGlyZWN0UHJveHkoRXh0LmNvcHlUbyh7fSwgYywgJ3BhcmFtT3JkZXIscGFyYW1zQXNIYXNoLGRpcmVjdEZuLGFwaScpKSwKICAgICAgICAgICAgcmVhZGVyOiAoIUV4dC5pc0RlZmluZWQoYy5yZWFkZXIpICYmIGMuZmllbGRzKSA/IG5ldyBFeHQuZGF0YS5Kc29uUmVhZGVyKEV4dC5jb3B5VG8oe30sIGMsICd0b3RhbFByb3BlcnR5LHJvb3QsaWRQcm9wZXJ0eScpLCBjLmZpZWxkcykgOiBjLnJlYWRlcgogICAgICAgIH0pKTsKICAgIH0KfSk7CkV4dC5yZWcoJ2RpcmVjdHN0b3JlJywgRXh0LmRhdGEuRGlyZWN0U3RvcmUpOwoKRXh0LkRpcmVjdCA9IEV4dC5leHRlbmQoRXh0LnV0aWwuT2JzZXJ2YWJsZSwgewogICAgCgogICAgCiAgICBleGNlcHRpb25zOiB7CiAgICAgICAgVFJBTlNQT1JUOiAneGhyJywKICAgICAgICBQQVJTRTogJ3BhcnNlJywKICAgICAgICBMT0dJTjogJ2xvZ2luJywKICAgICAgICBTRVJWRVI6ICdleGNlcHRpb24nCiAgICB9LAoKICAgIAogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAnZXZlbnQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2V4Y2VwdGlvbicKICAgICAgICApOwogICAgICAgIHRoaXMudHJhbnNhY3Rpb25zID0ge307CiAgICAgICAgdGhpcy5wcm92aWRlcnMgPSB7fTsKICAgIH0sCgogICAgCiAgICBhZGRQcm92aWRlciA6IGZ1bmN0aW9uKHByb3ZpZGVyKXsKICAgICAgICB2YXIgYSA9IGFyZ3VtZW50czsKICAgICAgICBpZihhLmxlbmd0aCA+IDEpewogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBhLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIHRoaXMuYWRkUHJvdmlkZXIoYVtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYoIXByb3ZpZGVyLmV2ZW50cyl7CiAgICAgICAgICAgIHByb3ZpZGVyID0gbmV3IEV4dC5EaXJlY3QuUFJPVklERVJTW3Byb3ZpZGVyLnR5cGVdKHByb3ZpZGVyKTsKICAgICAgICB9CiAgICAgICAgcHJvdmlkZXIuaWQgPSBwcm92aWRlci5pZCB8fCBFeHQuaWQoKTsKICAgICAgICB0aGlzLnByb3ZpZGVyc1twcm92aWRlci5pZF0gPSBwcm92aWRlcjsKCiAgICAgICAgcHJvdmlkZXIub24oJ2RhdGEnLCB0aGlzLm9uUHJvdmlkZXJEYXRhLCB0aGlzKTsKICAgICAgICBwcm92aWRlci5vbignZXhjZXB0aW9uJywgdGhpcy5vblByb3ZpZGVyRXhjZXB0aW9uLCB0aGlzKTsKCgogICAgICAgIGlmKCFwcm92aWRlci5pc0Nvbm5lY3RlZCgpKXsKICAgICAgICAgICAgcHJvdmlkZXIuY29ubmVjdCgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHByb3ZpZGVyOwogICAgfSwKCiAgICAKICAgIGdldFByb3ZpZGVyIDogZnVuY3Rpb24oaWQpewogICAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyc1tpZF07CiAgICB9LAoKICAgIHJlbW92ZVByb3ZpZGVyIDogZnVuY3Rpb24oaWQpewogICAgICAgIHZhciBwcm92aWRlciA9IGlkLmlkID8gaWQgOiB0aGlzLnByb3ZpZGVyc1tpZF07CiAgICAgICAgcHJvdmlkZXIudW4oJ2RhdGEnLCB0aGlzLm9uUHJvdmlkZXJEYXRhLCB0aGlzKTsKICAgICAgICBwcm92aWRlci51bignZXhjZXB0aW9uJywgdGhpcy5vblByb3ZpZGVyRXhjZXB0aW9uLCB0aGlzKTsKICAgICAgICBkZWxldGUgdGhpcy5wcm92aWRlcnNbcHJvdmlkZXIuaWRdOwogICAgICAgIHJldHVybiBwcm92aWRlcjsKICAgIH0sCgogICAgYWRkVHJhbnNhY3Rpb246IGZ1bmN0aW9uKHQpewogICAgICAgIHRoaXMudHJhbnNhY3Rpb25zW3QudGlkXSA9IHQ7CiAgICAgICAgcmV0dXJuIHQ7CiAgICB9LAoKICAgIHJlbW92ZVRyYW5zYWN0aW9uOiBmdW5jdGlvbih0KXsKICAgICAgICBkZWxldGUgdGhpcy50cmFuc2FjdGlvbnNbdC50aWQgfHwgdF07CiAgICAgICAgcmV0dXJuIHQ7CiAgICB9LAoKICAgIGdldFRyYW5zYWN0aW9uOiBmdW5jdGlvbih0aWQpewogICAgICAgIHJldHVybiB0aGlzLnRyYW5zYWN0aW9uc1t0aWQudGlkIHx8IHRpZF07CiAgICB9LAoKICAgIG9uUHJvdmlkZXJEYXRhIDogZnVuY3Rpb24ocHJvdmlkZXIsIGUpewogICAgICAgIGlmKEV4dC5pc0FycmF5KGUpKXsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gZS5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICB0aGlzLm9uUHJvdmlkZXJEYXRhKHByb3ZpZGVyLCBlW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGUubmFtZSAmJiBlLm5hbWUgIT0gJ2V2ZW50JyAmJiBlLm5hbWUgIT0gJ2V4Y2VwdGlvbicpewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudChlLm5hbWUsIGUpOwogICAgICAgIH1lbHNlIGlmKGUudHlwZSA9PSAnZXhjZXB0aW9uJyl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCBlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2V2ZW50JywgZSwgcHJvdmlkZXIpOwogICAgfSwKCiAgICBjcmVhdGVFdmVudCA6IGZ1bmN0aW9uKHJlc3BvbnNlLCBleHRyYVByb3BzKXsKICAgICAgICByZXR1cm4gbmV3IEV4dC5EaXJlY3QuZXZlbnRUeXBlc1tyZXNwb25zZS50eXBlXShFeHQuYXBwbHkocmVzcG9uc2UsIGV4dHJhUHJvcHMpKTsKICAgIH0KfSk7CgpFeHQuRGlyZWN0ID0gbmV3IEV4dC5EaXJlY3QoKTsKCkV4dC5EaXJlY3QuVElEID0gMTsKRXh0LkRpcmVjdC5QUk9WSURFUlMgPSB7fTsKRXh0LkRpcmVjdC5UcmFuc2FjdGlvbiA9IGZ1bmN0aW9uKGNvbmZpZyl7CiAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKICAgIHRoaXMudGlkID0gKytFeHQuRGlyZWN0LlRJRDsKICAgIHRoaXMucmV0cnlDb3VudCA9IDA7Cn07CkV4dC5EaXJlY3QuVHJhbnNhY3Rpb24ucHJvdG90eXBlID0gewogICAgc2VuZDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnByb3ZpZGVyLnF1ZXVlVHJhbnNhY3Rpb24odGhpcyk7CiAgICB9LAoKICAgIHJldHJ5OiBmdW5jdGlvbigpewogICAgICAgIHRoaXMucmV0cnlDb3VudCsrOwogICAgICAgIHRoaXMuc2VuZCgpOwogICAgfSwKCiAgICBnZXRQcm92aWRlcjogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5wcm92aWRlcjsKICAgIH0KfTtFeHQuRGlyZWN0LkV2ZW50ID0gZnVuY3Rpb24oY29uZmlnKXsKICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwp9OwoKRXh0LkRpcmVjdC5FdmVudC5wcm90b3R5cGUgPSB7CiAgICBzdGF0dXM6IHRydWUsCiAgICBnZXREYXRhOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmRhdGE7CiAgICB9Cn07CgpFeHQuRGlyZWN0LlJlbW90aW5nRXZlbnQgPSBFeHQuZXh0ZW5kKEV4dC5EaXJlY3QuRXZlbnQsIHsKICAgIHR5cGU6ICdycGMnLAogICAgZ2V0VHJhbnNhY3Rpb246IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb24gfHwgRXh0LkRpcmVjdC5nZXRUcmFuc2FjdGlvbih0aGlzLnRpZCk7CiAgICB9Cn0pOwoKRXh0LkRpcmVjdC5FeGNlcHRpb25FdmVudCA9IEV4dC5leHRlbmQoRXh0LkRpcmVjdC5SZW1vdGluZ0V2ZW50LCB7CiAgICBzdGF0dXM6IGZhbHNlLAogICAgdHlwZTogJ2V4Y2VwdGlvbicKfSk7CgpFeHQuRGlyZWN0LmV2ZW50VHlwZXMgPSB7CiAgICAncnBjJzogIEV4dC5EaXJlY3QuUmVtb3RpbmdFdmVudCwKICAgICdldmVudCc6ICBFeHQuRGlyZWN0LkV2ZW50LAogICAgJ2V4Y2VwdGlvbic6ICBFeHQuRGlyZWN0LkV4Y2VwdGlvbkV2ZW50Cn07CgpFeHQuZGlyZWN0LlByb3ZpZGVyID0gRXh0LmV4dGVuZChFeHQudXRpbC5PYnNlcnZhYmxlLCB7ICAgIAogICAgCiAgICAgICAgCiAgICAgICAgCiAgICBwcmlvcml0eTogMSwKCiAgICAgICAgCiAKICAgIAogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgJ2Nvbm5lY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgJ2Rpc2Nvbm5lY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgJ2RhdGEnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgJ2V4Y2VwdGlvbicKICAgICAgICApOwogICAgICAgIEV4dC5kaXJlY3QuUHJvdmlkZXIuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGNvbmZpZyk7CiAgICB9LAoKICAgIAogICAgaXNDb25uZWN0ZWQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAKICAgIGNvbm5lY3Q6IEV4dC5lbXB0eUZuLAogICAgCiAgICAKICAgIGRpc2Nvbm5lY3Q6IEV4dC5lbXB0eUZuCn0pOwoKRXh0LmRpcmVjdC5Kc29uUHJvdmlkZXIgPSBFeHQuZXh0ZW5kKEV4dC5kaXJlY3QuUHJvdmlkZXIsIHsKICAgIHBhcnNlUmVzcG9uc2U6IGZ1bmN0aW9uKHhocil7CiAgICAgICAgaWYoIUV4dC5pc0VtcHR5KHhoci5yZXNwb25zZVRleHQpKXsKICAgICAgICAgICAgaWYodHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT0gJ29iamVjdCcpewogICAgICAgICAgICAgICAgcmV0dXJuIHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIEV4dC5kZWNvZGUoeGhyLnJlc3BvbnNlVGV4dCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICBnZXRFdmVudHM6IGZ1bmN0aW9uKHhocil7CiAgICAgICAgdmFyIGRhdGEgPSBudWxsOwogICAgICAgIHRyeXsKICAgICAgICAgICAgZGF0YSA9IHRoaXMucGFyc2VSZXNwb25zZSh4aHIpOwogICAgICAgIH1jYXRjaChlKXsKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IEV4dC5EaXJlY3QuRXhjZXB0aW9uRXZlbnQoewogICAgICAgICAgICAgICAgZGF0YTogZSwKICAgICAgICAgICAgICAgIHhocjogeGhyLAogICAgICAgICAgICAgICAgY29kZTogRXh0LkRpcmVjdC5leGNlcHRpb25zLlBBUlNFLAogICAgICAgICAgICAgICAgbWVzc2FnZTogJ0Vycm9yIHBhcnNpbmcganNvbiByZXNwb25zZTogXG5cbiAnICsgZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIFtldmVudF07CiAgICAgICAgfQogICAgICAgIHZhciBldmVudHMgPSBbXTsKICAgICAgICBpZihFeHQuaXNBcnJheShkYXRhKSl7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGRhdGEubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgZXZlbnRzLnB1c2goRXh0LkRpcmVjdC5jcmVhdGVFdmVudChkYXRhW2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgZXZlbnRzLnB1c2goRXh0LkRpcmVjdC5jcmVhdGVFdmVudChkYXRhKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBldmVudHM7CiAgICB9Cn0pOwpFeHQuZGlyZWN0LlBvbGxpbmdQcm92aWRlciA9IEV4dC5leHRlbmQoRXh0LmRpcmVjdC5Kc29uUHJvdmlkZXIsIHsKICAgIAogICAgCiAgICBwcmlvcml0eTogMywKICAgIAogICAgCiAgICBpbnRlcnZhbDogMzAwMCwKCiAgICAKICAgIAogICAgCgogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGNvbmZpZyl7CiAgICAgICAgRXh0LmRpcmVjdC5Qb2xsaW5nUHJvdmlkZXIuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGNvbmZpZyk7CiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAnYmVmb3JlcG9sbCcsICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAncG9sbCcKICAgICAgICApOwogICAgfSwKCiAgICAKICAgIGlzQ29ubmVjdGVkOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiAhIXRoaXMucG9sbFRhc2s7CiAgICB9LAoKICAgIAogICAgY29ubmVjdDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnVybCAmJiAhdGhpcy5wb2xsVGFzayl7CiAgICAgICAgICAgIHRoaXMucG9sbFRhc2sgPSBFeHQuVGFza01nci5zdGFydCh7CiAgICAgICAgICAgICAgICBydW46IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoJ2JlZm9yZXBvbGwnLCB0aGlzKSAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgICAgICAgICBpZih0eXBlb2YgdGhpcy51cmwgPT0gJ2Z1bmN0aW9uJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVybCh0aGlzLmJhc2VQYXJhbXMpOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEV4dC5BamF4LnJlcXVlc3QoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdGhpcy51cmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHRoaXMub25EYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtczogdGhpcy5iYXNlUGFyYW1zCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBpbnRlcnZhbDogdGhpcy5pbnRlcnZhbCwKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnY29ubmVjdCcsIHRoaXMpOwogICAgICAgIH1lbHNlIGlmKCF0aGlzLnVybCl7CiAgICAgICAgICAgIHRocm93ICdFcnJvciBpbml0aWFsaXppbmcgUG9sbGluZ1Byb3ZpZGVyLCBubyB1cmwgY29uZmlndXJlZC4nOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBkaXNjb25uZWN0OiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMucG9sbFRhc2spewogICAgICAgICAgICBFeHQuVGFza01nci5zdG9wKHRoaXMucG9sbFRhc2spOwogICAgICAgICAgICBkZWxldGUgdGhpcy5wb2xsVGFzazsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2Rpc2Nvbm5lY3QnLCB0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25EYXRhOiBmdW5jdGlvbihvcHQsIHN1Y2Nlc3MsIHhocil7CiAgICAgICAgaWYoc3VjY2Vzcyl7CiAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmdldEV2ZW50cyh4aHIpOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBldmVudHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgdmFyIGUgPSBldmVudHNbaV07CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZGF0YScsIHRoaXMsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHZhciBlID0gbmV3IEV4dC5EaXJlY3QuRXhjZXB0aW9uRXZlbnQoewogICAgICAgICAgICAgICAgZGF0YTogZSwKICAgICAgICAgICAgICAgIGNvZGU6IEV4dC5EaXJlY3QuZXhjZXB0aW9ucy5UUkFOU1BPUlQsCiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnVW5hYmxlIHRvIGNvbm5lY3QgdG8gdGhlIHNlcnZlci4nLAogICAgICAgICAgICAgICAgeGhyOiB4aHIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdkYXRhJywgdGhpcywgZSk7CiAgICAgICAgfQogICAgfQp9KTsKCkV4dC5EaXJlY3QuUFJPVklERVJTWydwb2xsaW5nJ10gPSBFeHQuZGlyZWN0LlBvbGxpbmdQcm92aWRlcjsKRXh0LmRpcmVjdC5SZW1vdGluZ1Byb3ZpZGVyID0gRXh0LmV4dGVuZChFeHQuZGlyZWN0Lkpzb25Qcm92aWRlciwgeyAgICAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIGVuYWJsZUJ1ZmZlcjogMTAsCiAgICAKICAgIAogICAgbWF4UmV0cmllczogMSwKICAgIAogICAgCiAgICB0aW1lb3V0OiB1bmRlZmluZWQsCgogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIEV4dC5kaXJlY3QuUmVtb3RpbmdQcm92aWRlci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgY29uZmlnKTsKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVjYWxsJywgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICdjYWxsJwogICAgICAgICk7CiAgICAgICAgdGhpcy5uYW1lc3BhY2UgPSAoRXh0LmlzU3RyaW5nKHRoaXMubmFtZXNwYWNlKSkgPyBFeHQubnModGhpcy5uYW1lc3BhY2UpIDogdGhpcy5uYW1lc3BhY2UgfHwgd2luZG93OwogICAgICAgIHRoaXMudHJhbnNhY3Rpb25zID0ge307CiAgICAgICAgdGhpcy5jYWxsQnVmZmVyID0gW107CiAgICB9LAoKICAgIAogICAgaW5pdEFQSSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG8gPSB0aGlzLmFjdGlvbnM7CiAgICAgICAgZm9yKHZhciBjIGluIG8pewogICAgICAgICAgICB2YXIgY2xzID0gdGhpcy5uYW1lc3BhY2VbY10gfHwgKHRoaXMubmFtZXNwYWNlW2NdID0ge30pLAogICAgICAgICAgICAgICAgbXMgPSBvW2NdOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICB2YXIgbSA9IG1zW2ldOwogICAgICAgICAgICAgICAgY2xzW20ubmFtZV0gPSB0aGlzLmNyZWF0ZU1ldGhvZChjLCBtKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBpc0Nvbm5lY3RlZDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gISF0aGlzLmNvbm5lY3RlZDsKICAgIH0sCgogICAgY29ubmVjdDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnVybCl7CiAgICAgICAgICAgIHRoaXMuaW5pdEFQSSgpOwogICAgICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjb25uZWN0JywgdGhpcyk7CiAgICAgICAgfWVsc2UgaWYoIXRoaXMudXJsKXsKICAgICAgICAgICAgdGhyb3cgJ0Vycm9yIGluaXRpYWxpemluZyBSZW1vdGluZ1Byb3ZpZGVyLCBubyB1cmwgY29uZmlndXJlZC4nOwogICAgICAgIH0KICAgIH0sCgogICAgZGlzY29ubmVjdDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmNvbm5lY3RlZCl7CiAgICAgICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdkaXNjb25uZWN0JywgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBvbkRhdGE6IGZ1bmN0aW9uKG9wdCwgc3VjY2VzcywgeGhyKXsKICAgICAgICBpZihzdWNjZXNzKXsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuZ2V0RXZlbnRzKHhocik7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGV2ZW50cy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICB2YXIgZSA9IGV2ZW50c1tpXSwKICAgICAgICAgICAgICAgICAgICB0ID0gdGhpcy5nZXRUcmFuc2FjdGlvbihlKTsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdkYXRhJywgdGhpcywgZSk7CiAgICAgICAgICAgICAgICBpZih0KXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRvQ2FsbGJhY2sodCwgZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgRXh0LkRpcmVjdC5yZW1vdmVUcmFuc2FjdGlvbih0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH1lbHNlewogICAgICAgICAgICB2YXIgdHMgPSBbXS5jb25jYXQob3B0LnRzKTsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gdHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLmdldFRyYW5zYWN0aW9uKHRzW2ldKTsKICAgICAgICAgICAgICAgIGlmKHQgJiYgdC5yZXRyeUNvdW50IDwgdGhpcy5tYXhSZXRyaWVzKXsKICAgICAgICAgICAgICAgICAgICB0LnJldHJ5KCk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICB2YXIgZSA9IG5ldyBFeHQuRGlyZWN0LkV4Y2VwdGlvbkV2ZW50KHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogZSwKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb246IHQsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IEV4dC5EaXJlY3QuZXhjZXB0aW9ucy5UUkFOU1BPUlQsCiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdVbmFibGUgdG8gY29ubmVjdCB0byB0aGUgc2VydmVyLicsCiAgICAgICAgICAgICAgICAgICAgICAgIHhocjogeGhyCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2RhdGEnLCB0aGlzLCBlKTsKICAgICAgICAgICAgICAgICAgICBpZih0KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kb0NhbGxiYWNrKHQsIGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgRXh0LkRpcmVjdC5yZW1vdmVUcmFuc2FjdGlvbih0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIGdldENhbGxEYXRhOiBmdW5jdGlvbih0KXsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBhY3Rpb246IHQuYWN0aW9uLAogICAgICAgICAgICBtZXRob2Q6IHQubWV0aG9kLAogICAgICAgICAgICBkYXRhOiB0LmRhdGEsCiAgICAgICAgICAgIHR5cGU6ICdycGMnLAogICAgICAgICAgICB0aWQ6IHQudGlkCiAgICAgICAgfTsKICAgIH0sCgogICAgZG9TZW5kIDogZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgdmFyIG8gPSB7CiAgICAgICAgICAgIHVybDogdGhpcy51cmwsCiAgICAgICAgICAgIGNhbGxiYWNrOiB0aGlzLm9uRGF0YSwKICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgIHRzOiBkYXRhLAogICAgICAgICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQKICAgICAgICB9LCBjYWxsRGF0YTsKCiAgICAgICAgaWYoRXh0LmlzQXJyYXkoZGF0YSkpewogICAgICAgICAgICBjYWxsRGF0YSA9IFtdOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBkYXRhLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIGNhbGxEYXRhLnB1c2godGhpcy5nZXRDYWxsRGF0YShkYXRhW2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgY2FsbERhdGEgPSB0aGlzLmdldENhbGxEYXRhKGRhdGEpOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5lbmFibGVVcmxFbmNvZGUpewogICAgICAgICAgICB2YXIgcGFyYW1zID0ge307CiAgICAgICAgICAgIHBhcmFtc1tFeHQuaXNTdHJpbmcodGhpcy5lbmFibGVVcmxFbmNvZGUpID8gdGhpcy5lbmFibGVVcmxFbmNvZGUgOiAnZGF0YSddID0gRXh0LmVuY29kZShjYWxsRGF0YSk7CiAgICAgICAgICAgIG8ucGFyYW1zID0gcGFyYW1zOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBvLmpzb25EYXRhID0gY2FsbERhdGE7CiAgICAgICAgfQogICAgICAgIEV4dC5BamF4LnJlcXVlc3Qobyk7CiAgICB9LAoKICAgIGNvbWJpbmVBbmRTZW5kIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgbGVuID0gdGhpcy5jYWxsQnVmZmVyLmxlbmd0aDsKICAgICAgICBpZihsZW4gPiAwKXsKICAgICAgICAgICAgdGhpcy5kb1NlbmQobGVuID09IDEgPyB0aGlzLmNhbGxCdWZmZXJbMF0gOiB0aGlzLmNhbGxCdWZmZXIpOwogICAgICAgICAgICB0aGlzLmNhbGxCdWZmZXIgPSBbXTsKICAgICAgICB9CiAgICB9LAoKICAgIHF1ZXVlVHJhbnNhY3Rpb246IGZ1bmN0aW9uKHQpewogICAgICAgIGlmKHQuZm9ybSl7CiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0Zvcm0odCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5jYWxsQnVmZmVyLnB1c2godCk7CiAgICAgICAgaWYodGhpcy5lbmFibGVCdWZmZXIpewogICAgICAgICAgICBpZighdGhpcy5jYWxsVGFzayl7CiAgICAgICAgICAgICAgICB0aGlzLmNhbGxUYXNrID0gbmV3IEV4dC51dGlsLkRlbGF5ZWRUYXNrKHRoaXMuY29tYmluZUFuZFNlbmQsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY2FsbFRhc2suZGVsYXkoRXh0LmlzTnVtYmVyKHRoaXMuZW5hYmxlQnVmZmVyKSA/IHRoaXMuZW5hYmxlQnVmZmVyIDogMTApOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmNvbWJpbmVBbmRTZW5kKCk7CiAgICAgICAgfQogICAgfSwKCiAgICBkb0NhbGwgOiBmdW5jdGlvbihjLCBtLCBhcmdzKXsKICAgICAgICB2YXIgZGF0YSA9IG51bGwsIGhzID0gYXJnc1ttLmxlbl0sIHNjb3BlID0gYXJnc1ttLmxlbisxXTsKCiAgICAgICAgaWYobS5sZW4gIT09IDApewogICAgICAgICAgICBkYXRhID0gYXJncy5zbGljZSgwLCBtLmxlbik7CiAgICAgICAgfQoKICAgICAgICB2YXIgdCA9IG5ldyBFeHQuRGlyZWN0LlRyYW5zYWN0aW9uKHsKICAgICAgICAgICAgcHJvdmlkZXI6IHRoaXMsCiAgICAgICAgICAgIGFyZ3M6IGFyZ3MsCiAgICAgICAgICAgIGFjdGlvbjogYywKICAgICAgICAgICAgbWV0aG9kOiBtLm5hbWUsCiAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgIGNiOiBzY29wZSAmJiBFeHQuaXNGdW5jdGlvbihocykgPyBocy5jcmVhdGVEZWxlZ2F0ZShzY29wZSkgOiBocwogICAgICAgIH0pOwoKICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3JlY2FsbCcsIHRoaXMsIHQsIG0pICE9PSBmYWxzZSl7CiAgICAgICAgICAgIEV4dC5EaXJlY3QuYWRkVHJhbnNhY3Rpb24odCk7CiAgICAgICAgICAgIHRoaXMucXVldWVUcmFuc2FjdGlvbih0KTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2NhbGwnLCB0aGlzLCB0LCBtKTsKICAgICAgICB9CiAgICB9LAoKICAgIGRvRm9ybSA6IGZ1bmN0aW9uKGMsIG0sIGZvcm0sIGNhbGxiYWNrLCBzY29wZSl7CiAgICAgICAgdmFyIHQgPSBuZXcgRXh0LkRpcmVjdC5UcmFuc2FjdGlvbih7CiAgICAgICAgICAgIHByb3ZpZGVyOiB0aGlzLAogICAgICAgICAgICBhY3Rpb246IGMsCiAgICAgICAgICAgIG1ldGhvZDogbS5uYW1lLAogICAgICAgICAgICBhcmdzOltmb3JtLCBjYWxsYmFjaywgc2NvcGVdLAogICAgICAgICAgICBjYjogc2NvcGUgJiYgRXh0LmlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2suY3JlYXRlRGVsZWdhdGUoc2NvcGUpIDogY2FsbGJhY2ssCiAgICAgICAgICAgIGlzRm9ybTogdHJ1ZQogICAgICAgIH0pOwoKICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3JlY2FsbCcsIHRoaXMsIHQsIG0pICE9PSBmYWxzZSl7CiAgICAgICAgICAgIEV4dC5EaXJlY3QuYWRkVHJhbnNhY3Rpb24odCk7CiAgICAgICAgICAgIHZhciBpc1VwbG9hZCA9IFN0cmluZyhmb3JtLmdldEF0dHJpYnV0ZSgiZW5jdHlwZSIpKS50b0xvd2VyQ2FzZSgpID09ICdtdWx0aXBhcnQvZm9ybS1kYXRhJywKICAgICAgICAgICAgICAgIHBhcmFtcyA9IHsKICAgICAgICAgICAgICAgICAgICBleHRUSUQ6IHQudGlkLAogICAgICAgICAgICAgICAgICAgIGV4dEFjdGlvbjogYywKICAgICAgICAgICAgICAgICAgICBleHRNZXRob2Q6IG0ubmFtZSwKICAgICAgICAgICAgICAgICAgICBleHRUeXBlOiAncnBjJywKICAgICAgICAgICAgICAgICAgICBleHRVcGxvYWQ6IFN0cmluZyhpc1VwbG9hZCkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIEV4dC5hcHBseSh0LCB7CiAgICAgICAgICAgICAgICBmb3JtOiBFeHQuZ2V0RG9tKGZvcm0pLAogICAgICAgICAgICAgICAgaXNVcGxvYWQ6IGlzVXBsb2FkLAogICAgICAgICAgICAgICAgcGFyYW1zOiBjYWxsYmFjayAmJiBFeHQuaXNPYmplY3QoY2FsbGJhY2sucGFyYW1zKSA/IEV4dC5hcHBseShwYXJhbXMsIGNhbGxiYWNrLnBhcmFtcykgOiBwYXJhbXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjYWxsJywgdGhpcywgdCwgbSk7CiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0Zvcm0odCk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgcHJvY2Vzc0Zvcm06IGZ1bmN0aW9uKHQpewogICAgICAgIEV4dC5BamF4LnJlcXVlc3QoewogICAgICAgICAgICB1cmw6IHRoaXMudXJsLAogICAgICAgICAgICBwYXJhbXM6IHQucGFyYW1zLAogICAgICAgICAgICBjYWxsYmFjazogdGhpcy5vbkRhdGEsCiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBmb3JtOiB0LmZvcm0sCiAgICAgICAgICAgIGlzVXBsb2FkOiB0LmlzVXBsb2FkLAogICAgICAgICAgICB0czogdAogICAgICAgIH0pOwogICAgfSwKCiAgICBjcmVhdGVNZXRob2QgOiBmdW5jdGlvbihjLCBtKXsKICAgICAgICB2YXIgZjsKICAgICAgICBpZighbS5mb3JtSGFuZGxlcil7CiAgICAgICAgICAgIGYgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgdGhpcy5kb0NhbGwoYywgbSwgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7CiAgICAgICAgICAgIH0uY3JlYXRlRGVsZWdhdGUodGhpcyk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGYgPSBmdW5jdGlvbihmb3JtLCBjYWxsYmFjaywgc2NvcGUpewogICAgICAgICAgICAgICAgdGhpcy5kb0Zvcm0oYywgbSwgZm9ybSwgY2FsbGJhY2ssIHNjb3BlKTsKICAgICAgICAgICAgfS5jcmVhdGVEZWxlZ2F0ZSh0aGlzKTsKICAgICAgICB9CiAgICAgICAgZi5kaXJlY3RDZmcgPSB7CiAgICAgICAgICAgIGFjdGlvbjogYywKICAgICAgICAgICAgbWV0aG9kOiBtCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZjsKICAgIH0sCgogICAgZ2V0VHJhbnNhY3Rpb246IGZ1bmN0aW9uKG9wdCl7CiAgICAgICAgcmV0dXJuIG9wdCAmJiBvcHQudGlkID8gRXh0LkRpcmVjdC5nZXRUcmFuc2FjdGlvbihvcHQudGlkKSA6IG51bGw7CiAgICB9LAoKICAgIGRvQ2FsbGJhY2s6IGZ1bmN0aW9uKHQsIGUpewogICAgICAgIHZhciBmbiA9IGUuc3RhdHVzID8gJ3N1Y2Nlc3MnIDogJ2ZhaWx1cmUnOwogICAgICAgIGlmKHQgJiYgdC5jYil7CiAgICAgICAgICAgIHZhciBocyA9IHQuY2IsCiAgICAgICAgICAgICAgICByZXN1bHQgPSBFeHQuaXNEZWZpbmVkKGUucmVzdWx0KSA/IGUucmVzdWx0IDogZS5kYXRhOwogICAgICAgICAgICBpZihFeHQuaXNGdW5jdGlvbihocykpewogICAgICAgICAgICAgICAgaHMocmVzdWx0LCBlKTsKICAgICAgICAgICAgfSBlbHNlewogICAgICAgICAgICAgICAgRXh0LmNhbGxiYWNrKGhzW2ZuXSwgaHMuc2NvcGUsIFtyZXN1bHQsIGVdKTsKICAgICAgICAgICAgICAgIEV4dC5jYWxsYmFjayhocy5jYWxsYmFjaywgaHMuc2NvcGUsIFtyZXN1bHQsIGVdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfSk7CkV4dC5EaXJlY3QuUFJPVklERVJTWydyZW1vdGluZyddID0gRXh0LmRpcmVjdC5SZW1vdGluZ1Byb3ZpZGVyOwpFeHQuUmVzaXphYmxlID0gRXh0LmV4dGVuZChFeHQudXRpbC5PYnNlcnZhYmxlLCB7CgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGVsLCBjb25maWcpewogICAgICAgIHRoaXMuZWwgPSBFeHQuZ2V0KGVsKTsKICAgICAgICBpZihjb25maWcgJiYgY29uZmlnLndyYXApewogICAgICAgICAgICBjb25maWcucmVzaXplQ2hpbGQgPSB0aGlzLmVsOwogICAgICAgICAgICB0aGlzLmVsID0gdGhpcy5lbC53cmFwKHR5cGVvZiBjb25maWcud3JhcCA9PSAnb2JqZWN0JyA/IGNvbmZpZy53cmFwIDoge2NsczoneHJlc2l6YWJsZS13cmFwJ30pOwogICAgICAgICAgICB0aGlzLmVsLmlkID0gdGhpcy5lbC5kb20uaWQgPSBjb25maWcucmVzaXplQ2hpbGQuaWQgKyAnLXJ6d3JhcCc7CiAgICAgICAgICAgIHRoaXMuZWwuc2V0U3R5bGUoJ292ZXJmbG93JywgJ2hpZGRlbicpOwogICAgICAgICAgICB0aGlzLmVsLnNldFBvc2l0aW9uaW5nKGNvbmZpZy5yZXNpemVDaGlsZC5nZXRQb3NpdGlvbmluZygpKTsKICAgICAgICAgICAgY29uZmlnLnJlc2l6ZUNoaWxkLmNsZWFyUG9zaXRpb25pbmcoKTsKICAgICAgICAgICAgaWYoIWNvbmZpZy53aWR0aCB8fCAhY29uZmlnLmhlaWdodCl7CiAgICAgICAgICAgICAgICB2YXIgY3NpemUgPSBjb25maWcucmVzaXplQ2hpbGQuZ2V0U2l6ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5lbC5zZXRTaXplKGNzaXplLndpZHRoLCBjc2l6ZS5oZWlnaHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGNvbmZpZy5waW5uZWQgJiYgIWNvbmZpZy5hZGp1c3RtZW50cyl7CiAgICAgICAgICAgICAgICBjb25maWcuYWRqdXN0bWVudHMgPSAnYXV0byc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIAogICAgICAgIHRoaXMucHJveHkgPSB0aGlzLmVsLmNyZWF0ZVByb3h5KHt0YWc6ICdkaXYnLCBjbHM6ICd4LXJlc2l6YWJsZS1wcm94eScsIGlkOiB0aGlzLmVsLmlkICsgJy1yenByb3h5J30sIEV4dC5nZXRCb2R5KCkpOwogICAgICAgIHRoaXMucHJveHkudW5zZWxlY3RhYmxlKCk7CiAgICAgICAgdGhpcy5wcm94eS5lbmFibGVEaXNwbGF5TW9kZSgnYmxvY2snKTsKCiAgICAgICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CgogICAgICAgIGlmKHRoaXMucGlubmVkKXsKICAgICAgICAgICAgdGhpcy5kaXNhYmxlVHJhY2tPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5lbC5hZGRDbGFzcygneC1yZXNpemFibGUtcGlubmVkJyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciBwb3NpdGlvbiA9IHRoaXMuZWwuZ2V0U3R5bGUoJ3Bvc2l0aW9uJyk7CiAgICAgICAgaWYocG9zaXRpb24gIT0gJ2Fic29sdXRlJyAmJiBwb3NpdGlvbiAhPSAnZml4ZWQnKXsKICAgICAgICAgICAgdGhpcy5lbC5zZXRTdHlsZSgncG9zaXRpb24nLCAncmVsYXRpdmUnKTsKICAgICAgICB9CiAgICAgICAgaWYoIXRoaXMuaGFuZGxlcyl7IAogICAgICAgICAgICB0aGlzLmhhbmRsZXMgPSAncyxlLHNlJzsKICAgICAgICAgICAgaWYodGhpcy5tdWx0aURpcmVjdGlvbmFsKXsKICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlcyArPSAnLG4sdyc7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYodGhpcy5oYW5kbGVzID09ICdhbGwnKXsKICAgICAgICAgICAgdGhpcy5oYW5kbGVzID0gJ24gcyBlIHcgbmUgbncgc2Ugc3cnOwogICAgICAgIH0KICAgICAgICB2YXIgaHMgPSB0aGlzLmhhbmRsZXMuc3BsaXQoL1xzKj9bLDtdXHMqP3wgLyk7CiAgICAgICAgdmFyIHBzID0gRXh0LlJlc2l6YWJsZS5wb3NpdGlvbnM7CiAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gaHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICBpZihoc1tpXSAmJiBwc1toc1tpXV0pewogICAgICAgICAgICAgICAgdmFyIHBvcyA9IHBzW2hzW2ldXTsKICAgICAgICAgICAgICAgIHRoaXNbcG9zXSA9IG5ldyBFeHQuUmVzaXphYmxlLkhhbmRsZSh0aGlzLCBwb3MsIHRoaXMuZGlzYWJsZVRyYWNrT3ZlciwgdGhpcy50cmFuc3BhcmVudCwgdGhpcy5oYW5kbGVDbHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMuY29ybmVyID0gdGhpcy5zb3V0aGVhc3Q7CgogICAgICAgIGlmKHRoaXMuaGFuZGxlcy5pbmRleE9mKCduJykgIT0gLTEgfHwgdGhpcy5oYW5kbGVzLmluZGV4T2YoJ3cnKSAhPSAtMSl7CiAgICAgICAgICAgIHRoaXMudXBkYXRlQm94ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuYWN0aXZlSGFuZGxlID0gbnVsbDsKCiAgICAgICAgaWYodGhpcy5yZXNpemVDaGlsZCl7CiAgICAgICAgICAgIGlmKHR5cGVvZiB0aGlzLnJlc2l6ZUNoaWxkID09ICdib29sZWFuJyl7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2l6ZUNoaWxkID0gRXh0LmdldCh0aGlzLmVsLmRvbS5maXJzdENoaWxkLCB0cnVlKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2l6ZUNoaWxkID0gRXh0LmdldCh0aGlzLnJlc2l6ZUNoaWxkLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5hZGp1c3RtZW50cyA9PSAnYXV0bycpewogICAgICAgICAgICB2YXIgcmMgPSB0aGlzLnJlc2l6ZUNoaWxkOwogICAgICAgICAgICB2YXIgaHcgPSB0aGlzLndlc3QsIGhlID0gdGhpcy5lYXN0LCBobiA9IHRoaXMubm9ydGgsIGhzID0gdGhpcy5zb3V0aDsKICAgICAgICAgICAgaWYocmMgJiYgKGh3IHx8IGhuKSl7CiAgICAgICAgICAgICAgICByYy5wb3NpdGlvbigncmVsYXRpdmUnKTsKICAgICAgICAgICAgICAgIHJjLnNldExlZnQoaHcgPyBody5lbC5nZXRXaWR0aCgpIDogMCk7CiAgICAgICAgICAgICAgICByYy5zZXRUb3AoaG4gPyBobi5lbC5nZXRIZWlnaHQoKSA6IDApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWRqdXN0bWVudHMgPSBbCiAgICAgICAgICAgICAgICAoaGUgPyAtaGUuZWwuZ2V0V2lkdGgoKSA6IDApICsgKGh3ID8gLWh3LmVsLmdldFdpZHRoKCkgOiAwKSwKICAgICAgICAgICAgICAgIChobiA/IC1obi5lbC5nZXRIZWlnaHQoKSA6IDApICsgKGhzID8gLWhzLmVsLmdldEhlaWdodCgpIDogMCkgLTEKICAgICAgICAgICAgXTsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuZHJhZ2dhYmxlKXsKICAgICAgICAgICAgdGhpcy5kZCA9IHRoaXMuZHluYW1pYyA/CiAgICAgICAgICAgICAgICB0aGlzLmVsLmluaXRERChudWxsKSA6IHRoaXMuZWwuaW5pdEREUHJveHkobnVsbCwge2RyYWdFbElkOiB0aGlzLnByb3h5LmlkfSk7CiAgICAgICAgICAgIHRoaXMuZGQuc2V0SGFuZGxlRWxJZCh0aGlzLnJlc2l6ZUNoaWxkID8gdGhpcy5yZXNpemVDaGlsZC5pZCA6IHRoaXMuZWwuaWQpOwogICAgICAgICAgICBpZih0aGlzLmNvbnN0cmFpblRvKXsKICAgICAgICAgICAgICAgIHRoaXMuZGQuY29uc3RyYWluVG8odGhpcy5jb25zdHJhaW5Ubyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZXJlc2l6ZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAncmVzaXplJwogICAgICAgICk7CgogICAgICAgIGlmKHRoaXMud2lkdGggIT09IG51bGwgJiYgdGhpcy5oZWlnaHQgIT09IG51bGwpewogICAgICAgICAgICB0aGlzLnJlc2l6ZVRvKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy51cGRhdGVDaGlsZFNpemUoKTsKICAgICAgICB9CiAgICAgICAgaWYoRXh0LmlzSUUpewogICAgICAgICAgICB0aGlzLmVsLmRvbS5zdHlsZS56b29tID0gMTsKICAgICAgICB9CiAgICAgICAgRXh0LlJlc2l6YWJsZS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgYWRqdXN0bWVudHMgOiBbMCwgMF0sCiAgICAKICAgIGFuaW1hdGUgOiBmYWxzZSwKICAgIAogICAgCiAgICBkaXNhYmxlVHJhY2tPdmVyIDogZmFsc2UsCiAgICAKICAgIGRyYWdnYWJsZTogZmFsc2UsCiAgICAKICAgIGR1cmF0aW9uIDogMC4zNSwKICAgIAogICAgZHluYW1pYyA6IGZhbHNlLAogICAgCiAgICBlYXNpbmcgOiAnZWFzZU91dFN0cm9uZycsCiAgICAKICAgIGVuYWJsZWQgOiB0cnVlLAogICAgCiAgICAKICAgIGhhbmRsZXMgOiBmYWxzZSwKICAgIAogICAgbXVsdGlEaXJlY3Rpb25hbCA6IGZhbHNlLAogICAgCiAgICBoZWlnaHQgOiBudWxsLAogICAgCiAgICB3aWR0aCA6IG51bGwsCiAgICAKICAgIGhlaWdodEluY3JlbWVudCA6IDAsCiAgICAKICAgIHdpZHRoSW5jcmVtZW50IDogMCwKICAgIAogICAgbWluSGVpZ2h0IDogNSwKICAgIAogICAgbWluV2lkdGggOiA1LAogICAgCiAgICBtYXhIZWlnaHQgOiAxMDAwMCwKICAgIAogICAgbWF4V2lkdGggOiAxMDAwMCwKICAgIAogICAgbWluWDogMCwKICAgIAogICAgbWluWTogMCwKICAgIAogICAgcGlubmVkIDogZmFsc2UsCiAgICAKICAgIHByZXNlcnZlUmF0aW8gOiBmYWxzZSwKICAgIAogICAgcmVzaXplQ2hpbGQgOiBmYWxzZSwKICAgIAogICAgdHJhbnNwYXJlbnQ6IGZhbHNlLAogICAgCiAgICAKICAgIAoKCiAgICAKICAgIHJlc2l6ZVRvIDogZnVuY3Rpb24od2lkdGgsIGhlaWdodCl7CiAgICAgICAgdGhpcy5lbC5zZXRTaXplKHdpZHRoLCBoZWlnaHQpOwogICAgICAgIHRoaXMudXBkYXRlQ2hpbGRTaXplKCk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3Jlc2l6ZScsIHRoaXMsIHdpZHRoLCBoZWlnaHQsIG51bGwpOwogICAgfSwKCiAgICAKICAgIHN0YXJ0U2l6aW5nIDogZnVuY3Rpb24oZSwgaGFuZGxlKXsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnYmVmb3JlcmVzaXplJywgdGhpcywgZSk7CiAgICAgICAgaWYodGhpcy5lbmFibGVkKXsgCgogICAgICAgICAgICBpZighdGhpcy5vdmVybGF5KXsKICAgICAgICAgICAgICAgIHRoaXMub3ZlcmxheSA9IHRoaXMuZWwuY3JlYXRlUHJveHkoe3RhZzogJ2RpdicsIGNsczogJ3gtcmVzaXphYmxlLW92ZXJsYXknLCBodG1sOiAnJiMxNjA7J30sIEV4dC5nZXRCb2R5KCkpOwogICAgICAgICAgICAgICAgdGhpcy5vdmVybGF5LnVuc2VsZWN0YWJsZSgpOwogICAgICAgICAgICAgICAgdGhpcy5vdmVybGF5LmVuYWJsZURpc3BsYXlNb2RlKCdibG9jaycpOwogICAgICAgICAgICAgICAgdGhpcy5vdmVybGF5Lm9uKHsKICAgICAgICAgICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgICAgICAgICBtb3VzZW1vdmU6IHRoaXMub25Nb3VzZU1vdmUsCiAgICAgICAgICAgICAgICAgICAgbW91c2V1cDogdGhpcy5vbk1vdXNlVXAKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMub3ZlcmxheS5zZXRTdHlsZSgnY3Vyc29yJywgaGFuZGxlLmVsLmdldFN0eWxlKCdjdXJzb3InKSk7CgogICAgICAgICAgICB0aGlzLnJlc2l6aW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zdGFydEJveCA9IHRoaXMuZWwuZ2V0Qm94KCk7CiAgICAgICAgICAgIHRoaXMuc3RhcnRQb2ludCA9IGUuZ2V0WFkoKTsKICAgICAgICAgICAgdGhpcy5vZmZzZXRzID0gWyh0aGlzLnN0YXJ0Qm94LnggKyB0aGlzLnN0YXJ0Qm94LndpZHRoKSAtIHRoaXMuc3RhcnRQb2ludFswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0aGlzLnN0YXJ0Qm94LnkgKyB0aGlzLnN0YXJ0Qm94LmhlaWdodCkgLSB0aGlzLnN0YXJ0UG9pbnRbMV1dOwoKICAgICAgICAgICAgdGhpcy5vdmVybGF5LnNldFNpemUoRXh0LmxpYi5Eb20uZ2V0Vmlld1dpZHRoKHRydWUpLCBFeHQubGliLkRvbS5nZXRWaWV3SGVpZ2h0KHRydWUpKTsKICAgICAgICAgICAgdGhpcy5vdmVybGF5LnNob3coKTsKCiAgICAgICAgICAgIGlmKHRoaXMuY29uc3RyYWluVG8pIHsKICAgICAgICAgICAgICAgIHZhciBjdCA9IEV4dC5nZXQodGhpcy5jb25zdHJhaW5Ubyk7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2l6ZVJlZ2lvbiA9IGN0LmdldFJlZ2lvbigpLmFkanVzdCgKICAgICAgICAgICAgICAgICAgICBjdC5nZXRGcmFtZVdpZHRoKCd0JyksCiAgICAgICAgICAgICAgICAgICAgY3QuZ2V0RnJhbWVXaWR0aCgnbCcpLAogICAgICAgICAgICAgICAgICAgIC1jdC5nZXRGcmFtZVdpZHRoKCdiJyksCiAgICAgICAgICAgICAgICAgICAgLWN0LmdldEZyYW1lV2lkdGgoJ3InKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wcm94eS5zZXRTdHlsZSgndmlzaWJpbGl0eScsICdoaWRkZW4nKTsgCiAgICAgICAgICAgIHRoaXMucHJveHkuc2hvdygpOwogICAgICAgICAgICB0aGlzLnByb3h5LnNldEJveCh0aGlzLnN0YXJ0Qm94KTsKICAgICAgICAgICAgaWYoIXRoaXMuZHluYW1pYyl7CiAgICAgICAgICAgICAgICB0aGlzLnByb3h5LnNldFN0eWxlKCd2aXNpYmlsaXR5JywgJ3Zpc2libGUnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbk1vdXNlRG93biA6IGZ1bmN0aW9uKGhhbmRsZSwgZSl7CiAgICAgICAgaWYodGhpcy5lbmFibGVkKXsKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVIYW5kbGUgPSBoYW5kbGU7CiAgICAgICAgICAgIHRoaXMuc3RhcnRTaXppbmcoZSwgaGFuZGxlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25Nb3VzZVVwIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy5hY3RpdmVIYW5kbGUgPSBudWxsOwogICAgICAgIHZhciBzaXplID0gdGhpcy5yZXNpemVFbGVtZW50KCk7CiAgICAgICAgdGhpcy5yZXNpemluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuaGFuZGxlT3V0KCk7CiAgICAgICAgdGhpcy5vdmVybGF5LmhpZGUoKTsKICAgICAgICB0aGlzLnByb3h5LmhpZGUoKTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgncmVzaXplJywgdGhpcywgc2l6ZS53aWR0aCwgc2l6ZS5oZWlnaHQsIGUpOwogICAgfSwKCiAgICAKICAgIHVwZGF0ZUNoaWxkU2l6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5yZXNpemVDaGlsZCl7CiAgICAgICAgICAgIHZhciBlbCA9IHRoaXMuZWw7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXMucmVzaXplQ2hpbGQ7CiAgICAgICAgICAgIHZhciBhZGogPSB0aGlzLmFkanVzdG1lbnRzOwogICAgICAgICAgICBpZihlbC5kb20ub2Zmc2V0V2lkdGgpewogICAgICAgICAgICAgICAgdmFyIGIgPSBlbC5nZXRTaXplKHRydWUpOwogICAgICAgICAgICAgICAgY2hpbGQuc2V0U2l6ZShiLndpZHRoK2FkalswXSwgYi5oZWlnaHQrYWRqWzFdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYoRXh0LmlzSUUpewogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIGlmKGVsLmRvbS5vZmZzZXRXaWR0aCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiID0gZWwuZ2V0U2l6ZSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQuc2V0U2l6ZShiLndpZHRoK2FkalswXSwgYi5oZWlnaHQrYWRqWzFdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc25hcCA6IGZ1bmN0aW9uKHZhbHVlLCBpbmMsIG1pbil7CiAgICAgICAgaWYoIWluYyB8fCAhdmFsdWUpewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBuZXdWYWx1ZSA9IHZhbHVlOwogICAgICAgIHZhciBtID0gdmFsdWUgJSBpbmM7CiAgICAgICAgaWYobSA+IDApewogICAgICAgICAgICBpZihtID4gKGluYy8yKSl7CiAgICAgICAgICAgICAgICBuZXdWYWx1ZSA9IHZhbHVlICsgKGluYy1tKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBuZXdWYWx1ZSA9IHZhbHVlIC0gbTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gTWF0aC5tYXgobWluLCBuZXdWYWx1ZSk7CiAgICB9LAoKICAgIAogICAgcmVzaXplRWxlbWVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGJveCA9IHRoaXMucHJveHkuZ2V0Qm94KCk7CiAgICAgICAgaWYodGhpcy51cGRhdGVCb3gpewogICAgICAgICAgICB0aGlzLmVsLnNldEJveChib3gsIGZhbHNlLCB0aGlzLmFuaW1hdGUsIHRoaXMuZHVyYXRpb24sIG51bGwsIHRoaXMuZWFzaW5nKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5lbC5zZXRTaXplKGJveC53aWR0aCwgYm94LmhlaWdodCwgdGhpcy5hbmltYXRlLCB0aGlzLmR1cmF0aW9uLCBudWxsLCB0aGlzLmVhc2luZyk7CiAgICAgICAgfQogICAgICAgIHRoaXMudXBkYXRlQ2hpbGRTaXplKCk7CiAgICAgICAgaWYoIXRoaXMuZHluYW1pYyl7CiAgICAgICAgICAgIHRoaXMucHJveHkuaGlkZSgpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmRyYWdnYWJsZSAmJiB0aGlzLmNvbnN0cmFpblRvKXsKICAgICAgICAgICAgdGhpcy5kZC5yZXNldENvbnN0cmFpbnRzKCk7CiAgICAgICAgICAgIHRoaXMuZGQuY29uc3RyYWluVG8odGhpcy5jb25zdHJhaW5Ubyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBib3g7CiAgICB9LAoKICAgIAogICAgY29uc3RyYWluIDogZnVuY3Rpb24odiwgZGlmZiwgbSwgbXgpewogICAgICAgIGlmKHYgLSBkaWZmIDwgbSl7CiAgICAgICAgICAgIGRpZmYgPSB2IC0gbTsKICAgICAgICB9ZWxzZSBpZih2IC0gZGlmZiA+IG14KXsKICAgICAgICAgICAgZGlmZiA9IHYgLSBteDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRpZmY7CiAgICB9LAoKICAgIAogICAgb25Nb3VzZU1vdmUgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZih0aGlzLmVuYWJsZWQgJiYgdGhpcy5hY3RpdmVIYW5kbGUpewogICAgICAgICAgICB0cnl7CgogICAgICAgICAgICBpZih0aGlzLnJlc2l6ZVJlZ2lvbiAmJiAhdGhpcy5yZXNpemVSZWdpb24uY29udGFpbnMoZS5nZXRQb2ludCgpKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGN1clNpemUgPSB0aGlzLmN1clNpemUgfHwgdGhpcy5zdGFydEJveCwKICAgICAgICAgICAgICAgIHggPSB0aGlzLnN0YXJ0Qm94LngsIHkgPSB0aGlzLnN0YXJ0Qm94LnksCiAgICAgICAgICAgICAgICBveCA9IHgsCiAgICAgICAgICAgICAgICBveSA9IHksCiAgICAgICAgICAgICAgICB3ID0gY3VyU2l6ZS53aWR0aCwKICAgICAgICAgICAgICAgIGggPSBjdXJTaXplLmhlaWdodCwKICAgICAgICAgICAgICAgIG93ID0gdywKICAgICAgICAgICAgICAgIG9oID0gaCwKICAgICAgICAgICAgICAgIG13ID0gdGhpcy5taW5XaWR0aCwKICAgICAgICAgICAgICAgIG1oID0gdGhpcy5taW5IZWlnaHQsCiAgICAgICAgICAgICAgICBteHcgPSB0aGlzLm1heFdpZHRoLAogICAgICAgICAgICAgICAgbXhoID0gdGhpcy5tYXhIZWlnaHQsCiAgICAgICAgICAgICAgICB3aSA9IHRoaXMud2lkdGhJbmNyZW1lbnQsCiAgICAgICAgICAgICAgICBoaSA9IHRoaXMuaGVpZ2h0SW5jcmVtZW50LAogICAgICAgICAgICAgICAgZXZlbnRYWSA9IGUuZ2V0WFkoKSwKICAgICAgICAgICAgICAgIGRpZmZYID0gLSh0aGlzLnN0YXJ0UG9pbnRbMF0gLSBNYXRoLm1heCh0aGlzLm1pblgsIGV2ZW50WFlbMF0pKSwKICAgICAgICAgICAgICAgIGRpZmZZID0gLSh0aGlzLnN0YXJ0UG9pbnRbMV0gLSBNYXRoLm1heCh0aGlzLm1pblksIGV2ZW50WFlbMV0pKSwKICAgICAgICAgICAgICAgIHBvcyA9IHRoaXMuYWN0aXZlSGFuZGxlLnBvc2l0aW9uLAogICAgICAgICAgICAgICAgdHcsCiAgICAgICAgICAgICAgICB0aDsKCiAgICAgICAgICAgIHN3aXRjaChwb3MpewogICAgICAgICAgICAgICAgY2FzZSAnZWFzdCc6CiAgICAgICAgICAgICAgICAgICAgdyArPSBkaWZmWDsKICAgICAgICAgICAgICAgICAgICB3ID0gTWF0aC5taW4oTWF0aC5tYXgobXcsIHcpLCBteHcpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnc291dGgnOgogICAgICAgICAgICAgICAgICAgIGggKz0gZGlmZlk7CiAgICAgICAgICAgICAgICAgICAgaCA9IE1hdGgubWluKE1hdGgubWF4KG1oLCBoKSwgbXhoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ3NvdXRoZWFzdCc6CiAgICAgICAgICAgICAgICAgICAgdyArPSBkaWZmWDsKICAgICAgICAgICAgICAgICAgICBoICs9IGRpZmZZOwogICAgICAgICAgICAgICAgICAgIHcgPSBNYXRoLm1pbihNYXRoLm1heChtdywgdyksIG14dyk7CiAgICAgICAgICAgICAgICAgICAgaCA9IE1hdGgubWluKE1hdGgubWF4KG1oLCBoKSwgbXhoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgJ25vcnRoJzoKICAgICAgICAgICAgICAgICAgICBkaWZmWSA9IHRoaXMuY29uc3RyYWluKGgsIGRpZmZZLCBtaCwgbXhoKTsKICAgICAgICAgICAgICAgICAgICB5ICs9IGRpZmZZOwogICAgICAgICAgICAgICAgICAgIGggLT0gZGlmZlk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICd3ZXN0JzoKICAgICAgICAgICAgICAgICAgICBkaWZmWCA9IHRoaXMuY29uc3RyYWluKHcsIGRpZmZYLCBtdywgbXh3KTsKICAgICAgICAgICAgICAgICAgICB4ICs9IGRpZmZYOwogICAgICAgICAgICAgICAgICAgIHcgLT0gZGlmZlg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdub3J0aGVhc3QnOgogICAgICAgICAgICAgICAgICAgIHcgKz0gZGlmZlg7CiAgICAgICAgICAgICAgICAgICAgdyA9IE1hdGgubWluKE1hdGgubWF4KG13LCB3KSwgbXh3KTsKICAgICAgICAgICAgICAgICAgICBkaWZmWSA9IHRoaXMuY29uc3RyYWluKGgsIGRpZmZZLCBtaCwgbXhoKTsKICAgICAgICAgICAgICAgICAgICB5ICs9IGRpZmZZOwogICAgICAgICAgICAgICAgICAgIGggLT0gZGlmZlk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICdub3J0aHdlc3QnOgogICAgICAgICAgICAgICAgICAgIGRpZmZYID0gdGhpcy5jb25zdHJhaW4odywgZGlmZlgsIG13LCBteHcpOwogICAgICAgICAgICAgICAgICAgIGRpZmZZID0gdGhpcy5jb25zdHJhaW4oaCwgZGlmZlksIG1oLCBteGgpOwogICAgICAgICAgICAgICAgICAgIHkgKz0gZGlmZlk7CiAgICAgICAgICAgICAgICAgICAgaCAtPSBkaWZmWTsKICAgICAgICAgICAgICAgICAgICB4ICs9IGRpZmZYOwogICAgICAgICAgICAgICAgICAgIHcgLT0gZGlmZlg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgIGNhc2UgJ3NvdXRod2VzdCc6CiAgICAgICAgICAgICAgICAgICAgZGlmZlggPSB0aGlzLmNvbnN0cmFpbih3LCBkaWZmWCwgbXcsIG14dyk7CiAgICAgICAgICAgICAgICAgICAgaCArPSBkaWZmWTsKICAgICAgICAgICAgICAgICAgICBoID0gTWF0aC5taW4oTWF0aC5tYXgobWgsIGgpLCBteGgpOwogICAgICAgICAgICAgICAgICAgIHggKz0gZGlmZlg7CiAgICAgICAgICAgICAgICAgICAgdyAtPSBkaWZmWDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHN3ID0gdGhpcy5zbmFwKHcsIHdpLCBtdyk7CiAgICAgICAgICAgIHZhciBzaCA9IHRoaXMuc25hcChoLCBoaSwgbWgpOwogICAgICAgICAgICBpZihzdyAhPSB3IHx8IHNoICE9IGgpewogICAgICAgICAgICAgICAgc3dpdGNoKHBvcyl7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbm9ydGhlYXN0JzoKICAgICAgICAgICAgICAgICAgICAgICAgeSAtPSBzaCAtIGg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbm9ydGgnOgogICAgICAgICAgICAgICAgICAgICAgICB5IC09IHNoIC0gaDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc291dGh3ZXN0JzoKICAgICAgICAgICAgICAgICAgICAgICAgeCAtPSBzdyAtIHc7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnd2VzdCc6CiAgICAgICAgICAgICAgICAgICAgICAgIHggLT0gc3cgLSB3OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdub3J0aHdlc3QnOgogICAgICAgICAgICAgICAgICAgICAgICB4IC09IHN3IC0gdzsKICAgICAgICAgICAgICAgICAgICAgICAgeSAtPSBzaCAtIGg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3ID0gc3c7CiAgICAgICAgICAgICAgICBoID0gc2g7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKHRoaXMucHJlc2VydmVSYXRpbyl7CiAgICAgICAgICAgICAgICBzd2l0Y2gocG9zKXsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzb3V0aGVhc3QnOgogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Vhc3QnOgogICAgICAgICAgICAgICAgICAgICAgICBoID0gb2ggKiAody9vdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGggPSBNYXRoLm1pbihNYXRoLm1heChtaCwgaCksIG14aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHcgPSBvdyAqIChoL29oKTsKICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzb3V0aCc6CiAgICAgICAgICAgICAgICAgICAgICAgIHcgPSBvdyAqIChoL29oKTsKICAgICAgICAgICAgICAgICAgICAgICAgdyA9IE1hdGgubWluKE1hdGgubWF4KG13LCB3KSwgbXh3KTsKICAgICAgICAgICAgICAgICAgICAgICAgaCA9IG9oICogKHcvb3cpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdub3J0aGVhc3QnOgogICAgICAgICAgICAgICAgICAgICAgICB3ID0gb3cgKiAoaC9vaCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHcgPSBNYXRoLm1pbihNYXRoLm1heChtdywgdyksIG14dyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGggPSBvaCAqICh3L293KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdub3J0aCc6CiAgICAgICAgICAgICAgICAgICAgICAgIHR3ID0gdzsKICAgICAgICAgICAgICAgICAgICAgICAgdyA9IG93ICogKGgvb2gpOwogICAgICAgICAgICAgICAgICAgICAgICB3ID0gTWF0aC5taW4oTWF0aC5tYXgobXcsIHcpLCBteHcpOwogICAgICAgICAgICAgICAgICAgICAgICBoID0gb2ggKiAody9vdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHggKz0gKHR3IC0gdykgLyAyOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzb3V0aHdlc3QnOgogICAgICAgICAgICAgICAgICAgICAgICBoID0gb2ggKiAody9vdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGggPSBNYXRoLm1pbihNYXRoLm1heChtaCwgaCksIG14aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHR3ID0gdzsKICAgICAgICAgICAgICAgICAgICAgICAgdyA9IG93ICogKGgvb2gpOwogICAgICAgICAgICAgICAgICAgICAgICB4ICs9IHR3IC0gdzsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnd2VzdCc6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoID0gaDsKICAgICAgICAgICAgICAgICAgICAgICAgaCA9IG9oICogKHcvb3cpOwogICAgICAgICAgICAgICAgICAgICAgICBoID0gTWF0aC5taW4oTWF0aC5tYXgobWgsIGgpLCBteGgpOwogICAgICAgICAgICAgICAgICAgICAgICB5ICs9ICh0aCAtIGgpIC8gMjsKICAgICAgICAgICAgICAgICAgICAgICAgdHcgPSB3OwogICAgICAgICAgICAgICAgICAgICAgICB3ID0gb3cgKiAoaC9vaCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHggKz0gdHcgLSB3OwogICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ25vcnRod2VzdCc6CiAgICAgICAgICAgICAgICAgICAgICAgIHR3ID0gdzsKICAgICAgICAgICAgICAgICAgICAgICAgdGggPSBoOwogICAgICAgICAgICAgICAgICAgICAgICBoID0gb2ggKiAody9vdyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGggPSBNYXRoLm1pbihNYXRoLm1heChtaCwgaCksIG14aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHcgPSBvdyAqIChoL29oKTsKICAgICAgICAgICAgICAgICAgICAgICAgeSArPSB0aCAtIGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHggKz0gdHcgLSB3OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5wcm94eS5zZXRCb3VuZHMoeCwgeSwgdywgaCk7CiAgICAgICAgICAgIGlmKHRoaXMuZHluYW1pYyl7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2l6ZUVsZW1lbnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB9Y2F0Y2goZXgpe30KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaGFuZGxlT3ZlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5lbmFibGVkKXsKICAgICAgICAgICAgdGhpcy5lbC5hZGRDbGFzcygneC1yZXNpemFibGUtb3ZlcicpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBoYW5kbGVPdXQgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLnJlc2l6aW5nKXsKICAgICAgICAgICAgdGhpcy5lbC5yZW1vdmVDbGFzcygneC1yZXNpemFibGUtb3ZlcicpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRFbCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZWw7CiAgICB9LAoKICAgIAogICAgZ2V0UmVzaXplQ2hpbGQgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnJlc2l6ZUNoaWxkOwogICAgfSwKCiAgICAKICAgIGRlc3Ryb3kgOiBmdW5jdGlvbihyZW1vdmVFbCl7CiAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy5kZCwgdGhpcy5vdmVybGF5LCB0aGlzLnByb3h5KTsKICAgICAgICB0aGlzLm92ZXJsYXkgPSBudWxsOwogICAgICAgIHRoaXMucHJveHkgPSBudWxsOwoKICAgICAgICB2YXIgcHMgPSBFeHQuUmVzaXphYmxlLnBvc2l0aW9uczsKICAgICAgICBmb3IodmFyIGsgaW4gcHMpewogICAgICAgICAgICBpZih0eXBlb2YgcHNba10gIT0gJ2Z1bmN0aW9uJyAmJiB0aGlzW3BzW2tdXSl7CiAgICAgICAgICAgICAgICB0aGlzW3BzW2tdXS5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYocmVtb3ZlRWwpewogICAgICAgICAgICB0aGlzLmVsLnVwZGF0ZSgnJyk7CiAgICAgICAgICAgIEV4dC5kZXN0cm95KHRoaXMuZWwpOwogICAgICAgICAgICB0aGlzLmVsID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgdGhpcy5wdXJnZUxpc3RlbmVycygpOwogICAgfSwKCiAgICBzeW5jSGFuZGxlSGVpZ2h0IDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgaCA9IHRoaXMuZWwuZ2V0SGVpZ2h0KHRydWUpOwogICAgICAgIGlmKHRoaXMud2VzdCl7CiAgICAgICAgICAgIHRoaXMud2VzdC5lbC5zZXRIZWlnaHQoaCk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuZWFzdCl7CiAgICAgICAgICAgIHRoaXMuZWFzdC5lbC5zZXRIZWlnaHQoaCk7CiAgICAgICAgfQogICAgfQp9KTsKCgoKRXh0LlJlc2l6YWJsZS5wb3NpdGlvbnMgPSB7CiAgICBuOiAnbm9ydGgnLCBzOiAnc291dGgnLCBlOiAnZWFzdCcsIHc6ICd3ZXN0Jywgc2U6ICdzb3V0aGVhc3QnLCBzdzogJ3NvdXRod2VzdCcsIG53OiAnbm9ydGh3ZXN0JywgbmU6ICdub3J0aGVhc3QnCn07CgpFeHQuUmVzaXphYmxlLkhhbmRsZSA9IEV4dC5leHRlbmQoT2JqZWN0LCB7CiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKHJ6LCBwb3MsIGRpc2FibGVUcmFja092ZXIsIHRyYW5zcGFyZW50LCBjbHMpewogICAgICAgaWYoIXRoaXMudHBsKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciB0cGwgPSBFeHQuRG9tSGVscGVyLmNyZWF0ZVRlbXBsYXRlKAogICAgICAgICAgICAgICAge3RhZzogJ2RpdicsIGNsczogJ3gtcmVzaXphYmxlLWhhbmRsZSB4LXJlc2l6YWJsZS1oYW5kbGUtezB9J30KICAgICAgICAgICAgKTsKICAgICAgICAgICAgdHBsLmNvbXBpbGUoKTsKICAgICAgICAgICAgRXh0LlJlc2l6YWJsZS5IYW5kbGUucHJvdG90eXBlLnRwbCA9IHRwbDsKICAgICAgICB9CiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHBvczsKICAgICAgICB0aGlzLnJ6ID0gcno7CiAgICAgICAgdGhpcy5lbCA9IHRoaXMudHBsLmFwcGVuZChyei5lbC5kb20sIFt0aGlzLnBvc2l0aW9uXSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5lbC51bnNlbGVjdGFibGUoKTsKICAgICAgICBpZih0cmFuc3BhcmVudCl7CiAgICAgICAgICAgIHRoaXMuZWwuc2V0T3BhY2l0eSgwKTsKICAgICAgICB9CiAgICAgICAgaWYoIUV4dC5pc0VtcHR5KGNscykpewogICAgICAgICAgICB0aGlzLmVsLmFkZENsYXNzKGNscyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZWwub24oJ21vdXNlZG93bicsIHRoaXMub25Nb3VzZURvd24sIHRoaXMpOwogICAgICAgIGlmKCFkaXNhYmxlVHJhY2tPdmVyKXsKICAgICAgICAgICAgdGhpcy5lbC5vbih7CiAgICAgICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgICAgIG1vdXNlb3ZlcjogdGhpcy5vbk1vdXNlT3ZlciwKICAgICAgICAgICAgICAgIG1vdXNlb3V0OiB0aGlzLm9uTW91c2VPdXQKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFmdGVyUmVzaXplIDogZnVuY3Rpb24ocnopewogICAgICAgIAogICAgfSwKICAgIAogICAgb25Nb3VzZURvd24gOiBmdW5jdGlvbihlKXsKICAgICAgICB0aGlzLnJ6Lm9uTW91c2VEb3duKHRoaXMsIGUpOwogICAgfSwKICAgIAogICAgb25Nb3VzZU92ZXIgOiBmdW5jdGlvbihlKXsKICAgICAgICB0aGlzLnJ6LmhhbmRsZU92ZXIodGhpcywgZSk7CiAgICB9LAogICAgCiAgICBvbk1vdXNlT3V0IDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy5yei5oYW5kbGVPdXQodGhpcywgZSk7CiAgICB9LAogICAgCiAgICBkZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZGVzdHJveSh0aGlzLmVsKTsKICAgICAgICB0aGlzLmVsID0gbnVsbDsKICAgIH0KfSk7CgpFeHQuV2luZG93ID0gRXh0LmV4dGVuZChFeHQuUGFuZWwsIHsKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAoKICAgIAogICAgYmFzZUNscyA6ICd4LXdpbmRvdycsCiAgICAKICAgIHJlc2l6YWJsZSA6IHRydWUsCiAgICAKICAgIGRyYWdnYWJsZSA6IHRydWUsCiAgICAKICAgIGNsb3NhYmxlIDogdHJ1ZSwKICAgIAogICAgY2xvc2VBY3Rpb24gOiAnY2xvc2UnLAogICAgCiAgICBjb25zdHJhaW4gOiBmYWxzZSwKICAgIAogICAgY29uc3RyYWluSGVhZGVyIDogZmFsc2UsCiAgICAKICAgIHBsYWluIDogZmFsc2UsCiAgICAKICAgIG1pbmltaXphYmxlIDogZmFsc2UsCiAgICAKICAgIG1heGltaXphYmxlIDogZmFsc2UsCiAgICAKICAgIG1pbkhlaWdodCA6IDEwMCwKICAgIAogICAgbWluV2lkdGggOiAyMDAsCiAgICAKICAgIGV4cGFuZE9uU2hvdyA6IHRydWUsCiAgICAKICAgIAogICAgc2hvd0FuaW1EdXJhdGlvbjogMC4yNSwKICAgIAogICAgCiAgICBoaWRlQW5pbUR1cmF0aW9uOiAwLjI1LAoKICAgIAogICAgY29sbGFwc2libGUgOiBmYWxzZSwKCiAgICAKICAgIGluaXRIaWRkZW4gOiB1bmRlZmluZWQsCgogICAgCiAgICBoaWRkZW4gOiB0cnVlLAoKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICBlbGVtZW50cyA6ICdoZWFkZXIsYm9keScsCiAgICAKICAgIGZyYW1lIDogdHJ1ZSwKICAgIAogICAgZmxvYXRpbmcgOiB0cnVlLAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5pbml0VG9vbHMoKTsKICAgICAgICBFeHQuV2luZG93LnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAncmVzaXplJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdtYXhpbWl6ZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnbWluaW1pemUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ3Jlc3RvcmUnCiAgICAgICAgKTsKICAgICAgICAKICAgICAgICBpZihFeHQuaXNEZWZpbmVkKHRoaXMuaW5pdEhpZGRlbikpewogICAgICAgICAgICB0aGlzLmhpZGRlbiA9IHRoaXMuaW5pdEhpZGRlbjsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5oaWRkZW4gPT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5oaWRkZW4gPSB0cnVlOwogICAgICAgICAgICB0aGlzLnNob3coKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0U3RhdGUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiBFeHQuYXBwbHkoRXh0LldpbmRvdy5zdXBlcmNsYXNzLmdldFN0YXRlLmNhbGwodGhpcykgfHwge30sIHRoaXMuZ2V0Qm94KHRydWUpKTsKICAgIH0sCgogICAgCiAgICBvblJlbmRlciA6IGZ1bmN0aW9uKGN0LCBwb3NpdGlvbil7CiAgICAgICAgRXh0LldpbmRvdy5zdXBlcmNsYXNzLm9uUmVuZGVyLmNhbGwodGhpcywgY3QsIHBvc2l0aW9uKTsKCiAgICAgICAgaWYodGhpcy5wbGFpbil7CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3MoJ3gtd2luZG93LXBsYWluJyk7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICB0aGlzLmZvY3VzRWwgPSB0aGlzLmVsLmNyZWF0ZUNoaWxkKHsKICAgICAgICAgICAgICAgICAgICB0YWc6ICdhJywgaHJlZjonIycsIGNsczoneC1kbGctZm9jdXMnLAogICAgICAgICAgICAgICAgICAgIHRhYkluZGV4OictMScsIGh0bWw6ICcmIzE2MDsnfSk7CiAgICAgICAgdGhpcy5mb2N1c0VsLnN3YWxsb3dFdmVudCgnY2xpY2snLCB0cnVlKTsKCiAgICAgICAgdGhpcy5wcm94eSA9IHRoaXMuZWwuY3JlYXRlUHJveHkoJ3gtd2luZG93LXByb3h5Jyk7CiAgICAgICAgdGhpcy5wcm94eS5lbmFibGVEaXNwbGF5TW9kZSgnYmxvY2snKTsKCiAgICAgICAgaWYodGhpcy5tb2RhbCl7CiAgICAgICAgICAgIHRoaXMubWFzayA9IHRoaXMuY29udGFpbmVyLmNyZWF0ZUNoaWxkKHtjbHM6J2V4dC1lbC1tYXNrJ30sIHRoaXMuZWwuZG9tKTsKICAgICAgICAgICAgdGhpcy5tYXNrLmVuYWJsZURpc3BsYXlNb2RlKCdibG9jaycpOwogICAgICAgICAgICB0aGlzLm1hc2suaGlkZSgpOwogICAgICAgICAgICB0aGlzLm1vbih0aGlzLm1hc2ssICdjbGljaycsIHRoaXMuZm9jdXMsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLm1heGltaXphYmxlKXsKICAgICAgICAgICAgdGhpcy5tb24odGhpcy5oZWFkZXIsICdkYmxjbGljaycsIHRoaXMudG9nZ2xlTWF4aW1pemUsIHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBpbml0RXZlbnRzIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuV2luZG93LnN1cGVyY2xhc3MuaW5pdEV2ZW50cy5jYWxsKHRoaXMpOwogICAgICAgIGlmKHRoaXMuYW5pbWF0ZVRhcmdldCl7CiAgICAgICAgICAgIHRoaXMuc2V0QW5pbWF0ZVRhcmdldCh0aGlzLmFuaW1hdGVUYXJnZXQpOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5yZXNpemFibGUpewogICAgICAgICAgICB0aGlzLnJlc2l6ZXIgPSBuZXcgRXh0LlJlc2l6YWJsZSh0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICBtaW5XaWR0aDogdGhpcy5taW5XaWR0aCwKICAgICAgICAgICAgICAgIG1pbkhlaWdodDp0aGlzLm1pbkhlaWdodCwKICAgICAgICAgICAgICAgIGhhbmRsZXM6IHRoaXMucmVzaXplSGFuZGxlcyB8fCAnYWxsJywKICAgICAgICAgICAgICAgIHBpbm5lZDogdHJ1ZSwKICAgICAgICAgICAgICAgIHJlc2l6ZUVsZW1lbnQgOiB0aGlzLnJlc2l6ZXJBY3Rpb24sCiAgICAgICAgICAgICAgICBoYW5kbGVDbHM6ICd4LXdpbmRvdy1oYW5kbGUnCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLnJlc2l6ZXIud2luZG93ID0gdGhpczsKICAgICAgICAgICAgdGhpcy5tb24odGhpcy5yZXNpemVyLCAnYmVmb3JlcmVzaXplJywgdGhpcy5iZWZvcmVSZXNpemUsIHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5kcmFnZ2FibGUpewogICAgICAgICAgICB0aGlzLmhlYWRlci5hZGRDbGFzcygneC13aW5kb3ctZHJhZ2dhYmxlJyk7CiAgICAgICAgfQogICAgICAgIHRoaXMubW9uKHRoaXMuZWwsICdtb3VzZWRvd24nLCB0aGlzLnRvRnJvbnQsIHRoaXMpOwogICAgICAgIHRoaXMubWFuYWdlciA9IHRoaXMubWFuYWdlciB8fCBFeHQuV2luZG93TWdyOwogICAgICAgIHRoaXMubWFuYWdlci5yZWdpc3Rlcih0aGlzKTsKICAgICAgICBpZih0aGlzLm1heGltaXplZCl7CiAgICAgICAgICAgIHRoaXMubWF4aW1pemVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMubWF4aW1pemUoKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5jbG9zYWJsZSl7CiAgICAgICAgICAgIHZhciBrbSA9IHRoaXMuZ2V0S2V5TWFwKCk7CiAgICAgICAgICAgIGttLm9uKDI3LCB0aGlzLm9uRXNjLCB0aGlzKTsKICAgICAgICAgICAga20uZGlzYWJsZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgaW5pdERyYWdnYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgCiAgICAgICAgdGhpcy5kZCA9IG5ldyBFeHQuV2luZG93LkREKHRoaXMpOwogICAgfSwKCiAgIAogICAgb25Fc2MgOiBmdW5jdGlvbihrLCBlKXsKICAgICAgICBpZiAodGhpcy5hY3RpdmVHaG9zdCkgewogICAgICAgICAgICB0aGlzLnVuZ2hvc3QoKTsKICAgICAgICB9CiAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICB0aGlzW3RoaXMuY2xvc2VBY3Rpb25dKCk7CiAgICB9LAoKICAgIAogICAgYmVmb3JlRGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICB0aGlzLmNsZWFyQW5jaG9yKCk7CiAgICAgICAgICAgIEV4dC5kZXN0cm95KAogICAgICAgICAgICAgICAgdGhpcy5mb2N1c0VsLAogICAgICAgICAgICAgICAgdGhpcy5yZXNpemVyLAogICAgICAgICAgICAgICAgdGhpcy5kZCwKICAgICAgICAgICAgICAgIHRoaXMucHJveHksCiAgICAgICAgICAgICAgICB0aGlzLm1hc2sKICAgICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgRXh0LldpbmRvdy5zdXBlcmNsYXNzLmJlZm9yZURlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBvbkRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMubWFuYWdlcil7CiAgICAgICAgICAgIHRoaXMubWFuYWdlci51bnJlZ2lzdGVyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBFeHQuV2luZG93LnN1cGVyY2xhc3Mub25EZXN0cm95LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgaW5pdFRvb2xzIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLm1pbmltaXphYmxlKXsKICAgICAgICAgICAgdGhpcy5hZGRUb29sKHsKICAgICAgICAgICAgICAgIGlkOiAnbWluaW1pemUnLAogICAgICAgICAgICAgICAgaGFuZGxlcjogdGhpcy5taW5pbWl6ZS5jcmVhdGVEZWxlZ2F0ZSh0aGlzLCBbXSkKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMubWF4aW1pemFibGUpewogICAgICAgICAgICB0aGlzLmFkZFRvb2woewogICAgICAgICAgICAgICAgaWQ6ICdtYXhpbWl6ZScsCiAgICAgICAgICAgICAgICBoYW5kbGVyOiB0aGlzLm1heGltaXplLmNyZWF0ZURlbGVnYXRlKHRoaXMsIFtdKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5hZGRUb29sKHsKICAgICAgICAgICAgICAgIGlkOiAncmVzdG9yZScsCiAgICAgICAgICAgICAgICBoYW5kbGVyOiB0aGlzLnJlc3RvcmUuY3JlYXRlRGVsZWdhdGUodGhpcywgW10pLAogICAgICAgICAgICAgICAgaGlkZGVuOnRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuY2xvc2FibGUpewogICAgICAgICAgICB0aGlzLmFkZFRvb2woewogICAgICAgICAgICAgICAgaWQ6ICdjbG9zZScsCiAgICAgICAgICAgICAgICBoYW5kbGVyOiB0aGlzW3RoaXMuY2xvc2VBY3Rpb25dLmNyZWF0ZURlbGVnYXRlKHRoaXMsIFtdKQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVzaXplckFjdGlvbiA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGJveCA9IHRoaXMucHJveHkuZ2V0Qm94KCk7CiAgICAgICAgdGhpcy5wcm94eS5oaWRlKCk7CiAgICAgICAgdGhpcy53aW5kb3cuaGFuZGxlUmVzaXplKGJveCk7CiAgICAgICAgcmV0dXJuIGJveDsKICAgIH0sCgogICAgCiAgICBiZWZvcmVSZXNpemUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMucmVzaXplci5taW5IZWlnaHQgPSBNYXRoLm1heCh0aGlzLm1pbkhlaWdodCwgdGhpcy5nZXRGcmFtZUhlaWdodCgpICsgNDApOyAKICAgICAgICB0aGlzLnJlc2l6ZXIubWluV2lkdGggPSBNYXRoLm1heCh0aGlzLm1pbldpZHRoLCB0aGlzLmdldEZyYW1lV2lkdGgoKSArIDQwKTsKICAgICAgICB0aGlzLnJlc2l6ZUJveCA9IHRoaXMuZWwuZ2V0Qm94KCk7CiAgICB9LAoKICAgIAogICAgdXBkYXRlSGFuZGxlcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoRXh0LmlzSUUgJiYgdGhpcy5yZXNpemVyKXsKICAgICAgICAgICAgdGhpcy5yZXNpemVyLnN5bmNIYW5kbGVIZWlnaHQoKTsKICAgICAgICAgICAgdGhpcy5lbC5yZXBhaW50KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGhhbmRsZVJlc2l6ZSA6IGZ1bmN0aW9uKGJveCl7CiAgICAgICAgdmFyIHJ6ID0gdGhpcy5yZXNpemVCb3g7CiAgICAgICAgaWYocnoueCAhPSBib3gueCB8fCByei55ICE9IGJveC55KXsKICAgICAgICAgICAgdGhpcy51cGRhdGVCb3goYm94KTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5zZXRTaXplKGJveCk7CiAgICAgICAgICAgIGlmIChFeHQuaXNJRTYgJiYgRXh0LmlzU3RyaWN0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmRvTGF5b3V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5mb2N1cygpOwogICAgICAgIHRoaXMudXBkYXRlSGFuZGxlcygpOwogICAgICAgIHRoaXMuc2F2ZVN0YXRlKCk7CiAgICB9LAoKICAgIAogICAgZm9jdXMgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBmID0gdGhpcy5mb2N1c0VsLAogICAgICAgICAgICBkYiA9IHRoaXMuZGVmYXVsdEJ1dHRvbiwKICAgICAgICAgICAgdCA9IHR5cGVvZiBkYiwKICAgICAgICAgICAgZWwsCiAgICAgICAgICAgIGN0OwogICAgICAgIGlmKEV4dC5pc0RlZmluZWQoZGIpKXsKICAgICAgICAgICAgaWYoRXh0LmlzTnVtYmVyKGRiKSAmJiB0aGlzLmZiYXIpewogICAgICAgICAgICAgICAgZiA9IHRoaXMuZmJhci5pdGVtcy5nZXQoZGIpOwogICAgICAgICAgICB9ZWxzZSBpZihFeHQuaXNTdHJpbmcoZGIpKXsKICAgICAgICAgICAgICAgIGYgPSBFeHQuZ2V0Q21wKGRiKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBmID0gZGI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWwgPSBmLmdldEVsKCk7CiAgICAgICAgICAgIGN0ID0gRXh0LmdldERvbSh0aGlzLmNvbnRhaW5lcik7CiAgICAgICAgICAgIGlmIChlbCAmJiBjdCkgewogICAgICAgICAgICAgICAgaWYgKGN0ICE9IGRvY3VtZW50LmJvZHkgJiYgIUV4dC5saWIuUmVnaW9uLmdldFJlZ2lvbihjdCkuY29udGFpbnMoRXh0LmxpYi5SZWdpb24uZ2V0UmVnaW9uKGVsLmRvbSkpKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZiA9IGYgfHwgdGhpcy5mb2N1c0VsOwogICAgICAgIGYuZm9jdXMuZGVmZXIoMTAsIGYpOwogICAgfSwKCiAgICAKICAgIHNldEFuaW1hdGVUYXJnZXQgOiBmdW5jdGlvbihlbCl7CiAgICAgICAgZWwgPSBFeHQuZ2V0KGVsKTsKICAgICAgICB0aGlzLmFuaW1hdGVUYXJnZXQgPSBlbDsKICAgIH0sCgogICAgCiAgICBiZWZvcmVTaG93IDogZnVuY3Rpb24oKXsKICAgICAgICBkZWxldGUgdGhpcy5lbC5sYXN0WFk7CiAgICAgICAgZGVsZXRlIHRoaXMuZWwubGFzdExUOwogICAgICAgIGlmKHRoaXMueCA9PT0gdW5kZWZpbmVkIHx8IHRoaXMueSA9PT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgdmFyIHh5ID0gdGhpcy5lbC5nZXRBbGlnblRvWFkodGhpcy5jb250YWluZXIsICdjLWMnKTsKICAgICAgICAgICAgdmFyIHBvcyA9IHRoaXMuZWwudHJhbnNsYXRlUG9pbnRzKHh5WzBdLCB4eVsxXSk7CiAgICAgICAgICAgIHRoaXMueCA9IHRoaXMueCA9PT0gdW5kZWZpbmVkPyBwb3MubGVmdCA6IHRoaXMueDsKICAgICAgICAgICAgdGhpcy55ID0gdGhpcy55ID09PSB1bmRlZmluZWQ/IHBvcy50b3AgOiB0aGlzLnk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZWwuc2V0TGVmdFRvcCh0aGlzLngsIHRoaXMueSk7CgogICAgICAgIGlmKHRoaXMuZXhwYW5kT25TaG93KXsKICAgICAgICAgICAgdGhpcy5leHBhbmQoZmFsc2UpOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5tb2RhbCl7CiAgICAgICAgICAgIEV4dC5nZXRCb2R5KCkuYWRkQ2xhc3MoJ3gtYm9keS1tYXNrZWQnKTsKICAgICAgICAgICAgdGhpcy5tYXNrLnNldFNpemUoRXh0LmxpYi5Eb20uZ2V0Vmlld1dpZHRoKHRydWUpLCBFeHQubGliLkRvbS5nZXRWaWV3SGVpZ2h0KHRydWUpKTsKICAgICAgICAgICAgdGhpcy5tYXNrLnNob3coKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2hvdyA6IGZ1bmN0aW9uKGFuaW1hdGVUYXJnZXQsIGNiLCBzY29wZSl7CiAgICAgICAgaWYoIXRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLnJlbmRlcihFeHQuZ2V0Qm9keSgpKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5oaWRkZW4gPT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy50b0Zyb250KCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3Jlc2hvdycsIHRoaXMpID09PSBmYWxzZSl7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBpZihjYil7CiAgICAgICAgICAgIHRoaXMub24oJ3Nob3cnLCBjYiwgc2NvcGUsIHtzaW5nbGU6dHJ1ZX0pOwogICAgICAgIH0KICAgICAgICB0aGlzLmhpZGRlbiA9IGZhbHNlOwogICAgICAgIGlmKEV4dC5pc0RlZmluZWQoYW5pbWF0ZVRhcmdldCkpewogICAgICAgICAgICB0aGlzLnNldEFuaW1hdGVUYXJnZXQoYW5pbWF0ZVRhcmdldCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuYmVmb3JlU2hvdygpOwogICAgICAgIGlmKHRoaXMuYW5pbWF0ZVRhcmdldCl7CiAgICAgICAgICAgIHRoaXMuYW5pbVNob3coKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5hZnRlclNob3coKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJTaG93IDogZnVuY3Rpb24oaXNBbmltKXsKICAgICAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCl7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdGhpcy5wcm94eS5oaWRlKCk7CiAgICAgICAgdGhpcy5lbC5zZXRTdHlsZSgnZGlzcGxheScsICdibG9jaycpOwogICAgICAgIHRoaXMuZWwuc2hvdygpOwogICAgICAgIGlmKHRoaXMubWF4aW1pemVkKXsKICAgICAgICAgICAgdGhpcy5maXRDb250YWluZXIoKTsKICAgICAgICB9CiAgICAgICAgaWYoRXh0LmlzTWFjICYmIEV4dC5pc0dlY2tvMil7IAogICAgICAgICAgICB0aGlzLmNhc2NhZGUodGhpcy5zZXRBdXRvU2Nyb2xsKTsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMubW9uaXRvclJlc2l6ZSB8fCB0aGlzLm1vZGFsIHx8IHRoaXMuY29uc3RyYWluIHx8IHRoaXMuY29uc3RyYWluSGVhZGVyKXsKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5vbldpbmRvd1Jlc2l6ZSh0aGlzLm9uV2luZG93UmVzaXplLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5kb0NvbnN0cmFpbigpOwogICAgICAgIHRoaXMuZG9MYXlvdXQoKTsKICAgICAgICBpZih0aGlzLmtleU1hcCl7CiAgICAgICAgICAgIHRoaXMua2V5TWFwLmVuYWJsZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLnRvRnJvbnQoKTsKICAgICAgICB0aGlzLnVwZGF0ZUhhbmRsZXMoKTsKICAgICAgICBpZihpc0FuaW0gJiYgKEV4dC5pc0lFIHx8IEV4dC5pc1dlYktpdCkpewogICAgICAgICAgICB2YXIgc3ogPSB0aGlzLmdldFNpemUoKTsKICAgICAgICAgICAgdGhpcy5vblJlc2l6ZShzei53aWR0aCwgc3ouaGVpZ2h0KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5vblNob3coKTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnc2hvdycsIHRoaXMpOwogICAgfSwKCiAgICAKICAgIGFuaW1TaG93IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnByb3h5LnNob3coKTsKICAgICAgICB0aGlzLnByb3h5LnNldEJveCh0aGlzLmFuaW1hdGVUYXJnZXQuZ2V0Qm94KCkpOwogICAgICAgIHRoaXMucHJveHkuc2V0T3BhY2l0eSgwKTsKICAgICAgICB2YXIgYiA9IHRoaXMuZ2V0Qm94KCk7CiAgICAgICAgdGhpcy5lbC5zZXRTdHlsZSgnZGlzcGxheScsICdub25lJyk7CiAgICAgICAgdGhpcy5wcm94eS5zaGlmdChFeHQuYXBwbHkoYiwgewogICAgICAgICAgICBjYWxsYmFjazogdGhpcy5hZnRlclNob3cuY3JlYXRlRGVsZWdhdGUodGhpcywgW3RydWVdLCBmYWxzZSksCiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBlYXNpbmc6ICdlYXNlTm9uZScsCiAgICAgICAgICAgIGR1cmF0aW9uOiB0aGlzLnNob3dBbmltRHVyYXRpb24sCiAgICAgICAgICAgIG9wYWNpdHk6IDAuNQogICAgICAgIH0pKTsKICAgIH0sCgogICAgCiAgICBoaWRlIDogZnVuY3Rpb24oYW5pbWF0ZVRhcmdldCwgY2IsIHNjb3BlKXsKICAgICAgICBpZih0aGlzLmhpZGRlbiB8fCB0aGlzLmZpcmVFdmVudCgnYmVmb3JlaGlkZScsIHRoaXMpID09PSBmYWxzZSl7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgICBpZihjYil7CiAgICAgICAgICAgIHRoaXMub24oJ2hpZGUnLCBjYiwgc2NvcGUsIHtzaW5nbGU6dHJ1ZX0pOwogICAgICAgIH0KICAgICAgICB0aGlzLmhpZGRlbiA9IHRydWU7CiAgICAgICAgaWYoYW5pbWF0ZVRhcmdldCAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgdGhpcy5zZXRBbmltYXRlVGFyZ2V0KGFuaW1hdGVUYXJnZXQpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLm1vZGFsKXsKICAgICAgICAgICAgdGhpcy5tYXNrLmhpZGUoKTsKICAgICAgICAgICAgRXh0LmdldEJvZHkoKS5yZW1vdmVDbGFzcygneC1ib2R5LW1hc2tlZCcpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmFuaW1hdGVUYXJnZXQpewogICAgICAgICAgICB0aGlzLmFuaW1IaWRlKCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuZWwuaGlkZSgpOwogICAgICAgICAgICB0aGlzLmFmdGVySGlkZSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBhZnRlckhpZGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMucHJveHkuaGlkZSgpOwogICAgICAgIGlmKHRoaXMubW9uaXRvclJlc2l6ZSB8fCB0aGlzLm1vZGFsIHx8IHRoaXMuY29uc3RyYWluIHx8IHRoaXMuY29uc3RyYWluSGVhZGVyKXsKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5yZW1vdmVSZXNpemVMaXN0ZW5lcih0aGlzLm9uV2luZG93UmVzaXplLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5rZXlNYXApewogICAgICAgICAgICB0aGlzLmtleU1hcC5kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMub25IaWRlKCk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2hpZGUnLCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBhbmltSGlkZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5wcm94eS5zZXRPcGFjaXR5KDAuNSk7CiAgICAgICAgdGhpcy5wcm94eS5zaG93KCk7CiAgICAgICAgdmFyIHRiID0gdGhpcy5nZXRCb3goZmFsc2UpOwogICAgICAgIHRoaXMucHJveHkuc2V0Qm94KHRiKTsKICAgICAgICB0aGlzLmVsLmhpZGUoKTsKICAgICAgICB0aGlzLnByb3h5LnNoaWZ0KEV4dC5hcHBseSh0aGlzLmFuaW1hdGVUYXJnZXQuZ2V0Qm94KCksIHsKICAgICAgICAgICAgY2FsbGJhY2s6IHRoaXMuYWZ0ZXJIaWRlLAogICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgZHVyYXRpb246IHRoaXMuaGlkZUFuaW1EdXJhdGlvbiwKICAgICAgICAgICAgZWFzaW5nOiAnZWFzZU5vbmUnLAogICAgICAgICAgICBvcGFjaXR5OiAwCiAgICAgICAgfSkpOwogICAgfSwKCiAgICAKICAgIG9uU2hvdyA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgb25IaWRlIDogRXh0LmVtcHR5Rm4sCgogICAgCiAgICBvbldpbmRvd1Jlc2l6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5tYXhpbWl6ZWQpewogICAgICAgICAgICB0aGlzLmZpdENvbnRhaW5lcigpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLm1vZGFsKXsKICAgICAgICAgICAgdGhpcy5tYXNrLnNldFNpemUoJzEwMCUnLCAnMTAwJScpOwogICAgICAgICAgICB2YXIgZm9yY2UgPSB0aGlzLm1hc2suZG9tLm9mZnNldEhlaWdodDsKICAgICAgICAgICAgdGhpcy5tYXNrLnNldFNpemUoRXh0LmxpYi5Eb20uZ2V0Vmlld1dpZHRoKHRydWUpLCBFeHQubGliLkRvbS5nZXRWaWV3SGVpZ2h0KHRydWUpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5kb0NvbnN0cmFpbigpOwogICAgfSwKCiAgICAKICAgIGRvQ29uc3RyYWluIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmNvbnN0cmFpbiB8fCB0aGlzLmNvbnN0cmFpbkhlYWRlcil7CiAgICAgICAgICAgIHZhciBvZmZzZXRzOwogICAgICAgICAgICBpZih0aGlzLmNvbnN0cmFpbil7CiAgICAgICAgICAgICAgICBvZmZzZXRzID0gewogICAgICAgICAgICAgICAgICAgIHJpZ2h0OnRoaXMuZWwuc2hhZG93T2Zmc2V0LAogICAgICAgICAgICAgICAgICAgIGxlZnQ6dGhpcy5lbC5zaGFkb3dPZmZzZXQsCiAgICAgICAgICAgICAgICAgICAgYm90dG9tOnRoaXMuZWwuc2hhZG93T2Zmc2V0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9ZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHRoaXMuZ2V0U2l6ZSgpOwogICAgICAgICAgICAgICAgb2Zmc2V0cyA9IHsKICAgICAgICAgICAgICAgICAgICByaWdodDotKHMud2lkdGggLSAxMDApLAogICAgICAgICAgICAgICAgICAgIGJvdHRvbTotKHMuaGVpZ2h0IC0gMjUgKyB0aGlzLmVsLmdldENvbnN0cmFpbk9mZnNldCgpKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHh5ID0gdGhpcy5lbC5nZXRDb25zdHJhaW5Ub1hZKHRoaXMuY29udGFpbmVyLCB0cnVlLCBvZmZzZXRzKTsKICAgICAgICAgICAgaWYoeHkpewogICAgICAgICAgICAgICAgdGhpcy5zZXRQb3NpdGlvbih4eVswXSwgeHlbMV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdob3N0IDogZnVuY3Rpb24oY2xzKXsKICAgICAgICB2YXIgZ2hvc3QgPSB0aGlzLmNyZWF0ZUdob3N0KGNscyk7CiAgICAgICAgdmFyIGJveCA9IHRoaXMuZ2V0Qm94KHRydWUpOwogICAgICAgIGdob3N0LnNldExlZnRUb3AoYm94LngsIGJveC55KTsKICAgICAgICBnaG9zdC5zZXRXaWR0aChib3gud2lkdGgpOwogICAgICAgIHRoaXMuZWwuaGlkZSgpOwogICAgICAgIHRoaXMuYWN0aXZlR2hvc3QgPSBnaG9zdDsKICAgICAgICByZXR1cm4gZ2hvc3Q7CiAgICB9LAoKICAgIAogICAgdW5naG9zdCA6IGZ1bmN0aW9uKHNob3csIG1hdGNoUG9zaXRpb24pewogICAgICAgIGlmKCF0aGlzLmFjdGl2ZUdob3N0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYoc2hvdyAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLmVsLnNob3coKTsKICAgICAgICAgICAgdGhpcy5mb2N1cy5kZWZlcigxMCwgdGhpcyk7CiAgICAgICAgICAgIGlmKEV4dC5pc01hYyAmJiBFeHQuaXNHZWNrbzIpeyAKICAgICAgICAgICAgICAgIHRoaXMuY2FzY2FkZSh0aGlzLnNldEF1dG9TY3JvbGwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmKG1hdGNoUG9zaXRpb24gIT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5zZXRQb3NpdGlvbih0aGlzLmFjdGl2ZUdob3N0LmdldExlZnQodHJ1ZSksIHRoaXMuYWN0aXZlR2hvc3QuZ2V0VG9wKHRydWUpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hY3RpdmVHaG9zdC5oaWRlKCk7CiAgICAgICAgdGhpcy5hY3RpdmVHaG9zdC5yZW1vdmUoKTsKICAgICAgICBkZWxldGUgdGhpcy5hY3RpdmVHaG9zdDsKICAgIH0sCgogICAgCiAgICBtaW5pbWl6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ21pbmltaXplJywgdGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgY2xvc2UgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVjbG9zZScsIHRoaXMpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIGlmKHRoaXMuaGlkZGVuKXsKICAgICAgICAgICAgICAgIHRoaXMuZG9DbG9zZSgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZShudWxsLCB0aGlzLmRvQ2xvc2UsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRvQ2xvc2UgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjbG9zZScsIHRoaXMpOwogICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgfSwKCiAgICAKICAgIG1heGltaXplIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5tYXhpbWl6ZWQpewogICAgICAgICAgICB0aGlzLmV4cGFuZChmYWxzZSk7CiAgICAgICAgICAgIHRoaXMucmVzdG9yZVNpemUgPSB0aGlzLmdldFNpemUoKTsKICAgICAgICAgICAgdGhpcy5yZXN0b3JlUG9zID0gdGhpcy5nZXRQb3NpdGlvbih0cnVlKTsKICAgICAgICAgICAgaWYgKHRoaXMubWF4aW1pemFibGUpewogICAgICAgICAgICAgICAgdGhpcy50b29scy5tYXhpbWl6ZS5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLnRvb2xzLnJlc3RvcmUuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubWF4aW1pemVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5lbC5kaXNhYmxlU2hhZG93KCk7CgogICAgICAgICAgICBpZih0aGlzLmRkKXsKICAgICAgICAgICAgICAgIHRoaXMuZGQubG9jaygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMuY29sbGFwc2libGUpewogICAgICAgICAgICAgICAgdGhpcy50b29scy50b2dnbGUuaGlkZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3MoJ3gtd2luZG93LW1heGltaXplZCcpOwogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcygneC13aW5kb3ctbWF4aW1pemVkLWN0Jyk7CgogICAgICAgICAgICB0aGlzLnNldFBvc2l0aW9uKDAsIDApOwogICAgICAgICAgICB0aGlzLmZpdENvbnRhaW5lcigpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnbWF4aW1pemUnLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgcmVzdG9yZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5tYXhpbWl6ZWQpewogICAgICAgICAgICB2YXIgdCA9IHRoaXMudG9vbHM7CiAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3MoJ3gtd2luZG93LW1heGltaXplZCcpOwogICAgICAgICAgICBpZih0LnJlc3RvcmUpewogICAgICAgICAgICAgICAgdC5yZXN0b3JlLmhpZGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0Lm1heGltaXplKXsKICAgICAgICAgICAgICAgIHQubWF4aW1pemUuc2hvdygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy5yZXN0b3JlUG9zWzBdLCB0aGlzLnJlc3RvcmVQb3NbMV0pOwogICAgICAgICAgICB0aGlzLnNldFNpemUodGhpcy5yZXN0b3JlU2l6ZS53aWR0aCwgdGhpcy5yZXN0b3JlU2l6ZS5oZWlnaHQpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5yZXN0b3JlUG9zOwogICAgICAgICAgICBkZWxldGUgdGhpcy5yZXN0b3JlU2l6ZTsKICAgICAgICAgICAgdGhpcy5tYXhpbWl6ZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbC5lbmFibGVTaGFkb3codHJ1ZSk7CgogICAgICAgICAgICBpZih0aGlzLmRkKXsKICAgICAgICAgICAgICAgIHRoaXMuZGQudW5sb2NrKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5jb2xsYXBzaWJsZSAmJiB0LnRvZ2dsZSl7CiAgICAgICAgICAgICAgICB0LnRvZ2dsZS5zaG93KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jb250YWluZXIucmVtb3ZlQ2xhc3MoJ3gtd2luZG93LW1heGltaXplZC1jdCcpOwoKICAgICAgICAgICAgdGhpcy5kb0NvbnN0cmFpbigpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgncmVzdG9yZScsIHRoaXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICB0b2dnbGVNYXhpbWl6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXNbdGhpcy5tYXhpbWl6ZWQgPyAncmVzdG9yZScgOiAnbWF4aW1pemUnXSgpOwogICAgfSwKCiAgICAKICAgIGZpdENvbnRhaW5lciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHZzID0gdGhpcy5jb250YWluZXIuZ2V0Vmlld1NpemUoZmFsc2UpOwogICAgICAgIHRoaXMuc2V0U2l6ZSh2cy53aWR0aCwgdnMuaGVpZ2h0KTsKICAgIH0sCgogICAgCiAgICAKICAgIHNldFpJbmRleCA6IGZ1bmN0aW9uKGluZGV4KXsKICAgICAgICBpZih0aGlzLm1vZGFsKXsKICAgICAgICAgICAgdGhpcy5tYXNrLnNldFN0eWxlKCd6LWluZGV4JywgaW5kZXgpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsLnNldFpJbmRleCgrK2luZGV4KTsKICAgICAgICBpbmRleCArPSA1OwoKICAgICAgICBpZih0aGlzLnJlc2l6ZXIpewogICAgICAgICAgICB0aGlzLnJlc2l6ZXIucHJveHkuc2V0U3R5bGUoJ3otaW5kZXgnLCArK2luZGV4KTsKICAgICAgICB9CgogICAgICAgIHRoaXMubGFzdFpJbmRleCA9IGluZGV4OwogICAgfSwKCiAgICAKICAgIGFsaWduVG8gOiBmdW5jdGlvbihlbGVtZW50LCBwb3NpdGlvbiwgb2Zmc2V0cyl7CiAgICAgICAgdmFyIHh5ID0gdGhpcy5lbC5nZXRBbGlnblRvWFkoZWxlbWVudCwgcG9zaXRpb24sIG9mZnNldHMpOwogICAgICAgIHRoaXMuc2V0UGFnZVBvc2l0aW9uKHh5WzBdLCB4eVsxXSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgYW5jaG9yVG8gOiBmdW5jdGlvbihlbCwgYWxpZ25tZW50LCBvZmZzZXRzLCBtb25pdG9yU2Nyb2xsKXsKICAgICAgICB0aGlzLmNsZWFyQW5jaG9yKCk7CiAgICAgICAgdGhpcy5hbmNob3JUYXJnZXQgPSB7CiAgICAgICAgICAgIGVsOiBlbCwKICAgICAgICAgICAgYWxpZ25tZW50OiBhbGlnbm1lbnQsCiAgICAgICAgICAgIG9mZnNldHM6IG9mZnNldHMKICAgICAgICB9OwoKICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLm9uV2luZG93UmVzaXplKHRoaXMuZG9BbmNob3IsIHRoaXMpOwogICAgICAgIHZhciB0bSA9IHR5cGVvZiBtb25pdG9yU2Nyb2xsOwogICAgICAgIGlmKHRtICE9ICd1bmRlZmluZWQnKXsKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5vbih3aW5kb3csICdzY3JvbGwnLCB0aGlzLmRvQW5jaG9yLCB0aGlzLAogICAgICAgICAgICAgICAge2J1ZmZlcjogdG0gPT0gJ251bWJlcicgPyBtb25pdG9yU2Nyb2xsIDogNTB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuZG9BbmNob3IoKTsKICAgIH0sCgogICAgCiAgICBkb0FuY2hvciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG8gPSB0aGlzLmFuY2hvclRhcmdldDsKICAgICAgICB0aGlzLmFsaWduVG8oby5lbCwgby5hbGlnbm1lbnQsIG8ub2Zmc2V0cyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgY2xlYXJBbmNob3IgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuYW5jaG9yVGFyZ2V0KXsKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5yZW1vdmVSZXNpemVMaXN0ZW5lcih0aGlzLmRvQW5jaG9yLCB0aGlzKTsKICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci51bih3aW5kb3csICdzY3JvbGwnLCB0aGlzLmRvQW5jaG9yLCB0aGlzKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuYW5jaG9yVGFyZ2V0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICB0b0Zyb250IDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYodGhpcy5tYW5hZ2VyLmJyaW5nVG9Gcm9udCh0aGlzKSl7CiAgICAgICAgICAgIGlmKCFlIHx8ICFlLmdldFRhcmdldCgpLmZvY3VzKXsKICAgICAgICAgICAgICAgIHRoaXMuZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBzZXRBY3RpdmUgOiBmdW5jdGlvbihhY3RpdmUpewogICAgICAgIGlmKGFjdGl2ZSl7CiAgICAgICAgICAgIGlmKCF0aGlzLm1heGltaXplZCl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLmVuYWJsZVNoYWRvdyh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnYWN0aXZhdGUnLCB0aGlzKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5lbC5kaXNhYmxlU2hhZG93KCk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdkZWFjdGl2YXRlJywgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHRvQmFjayA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5tYW5hZ2VyLnNlbmRUb0JhY2sodGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgY2VudGVyIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgeHkgPSB0aGlzLmVsLmdldEFsaWduVG9YWSh0aGlzLmNvbnRhaW5lciwgJ2MtYycpOwogICAgICAgIHRoaXMuc2V0UGFnZVBvc2l0aW9uKHh5WzBdLCB4eVsxXSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgCn0pOwpFeHQucmVnKCd3aW5kb3cnLCBFeHQuV2luZG93KTsKCgpFeHQuV2luZG93LkREID0gRXh0LmV4dGVuZChFeHQuZGQuREQsIHsKICAgIAogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbih3aW4pewogICAgICAgIHRoaXMud2luID0gd2luOwogICAgICAgIEV4dC5XaW5kb3cuREQuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIHdpbi5lbC5pZCwgJ1dpbmRvd0RELScrd2luLmlkKTsKICAgICAgICB0aGlzLnNldEhhbmRsZUVsSWQod2luLmhlYWRlci5pZCk7CiAgICAgICAgdGhpcy5zY3JvbGwgPSBmYWxzZTsgICAgICAgIAogICAgfSwKICAgIAogICAgbW92ZU9ubHk6dHJ1ZSwKICAgIGhlYWRlck9mZnNldHM6WzEwMCwgMjVdLAogICAgc3RhcnREcmFnIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdyA9IHRoaXMud2luOwogICAgICAgIHRoaXMucHJveHkgPSB3Lmdob3N0KHcuaW5pdGlhbENvbmZpZy5jbHMpOwogICAgICAgIGlmKHcuY29uc3RyYWluICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHZhciBzbyA9IHcuZWwuc2hhZG93T2Zmc2V0OwogICAgICAgICAgICB0aGlzLmNvbnN0cmFpblRvKHcuY29udGFpbmVyLCB7cmlnaHQ6IHNvLCBsZWZ0OiBzbywgYm90dG9tOiBzb30pOwogICAgICAgIH1lbHNlIGlmKHcuY29uc3RyYWluSGVhZGVyICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHZhciBzID0gdGhpcy5wcm94eS5nZXRTaXplKCk7CiAgICAgICAgICAgIHRoaXMuY29uc3RyYWluVG8ody5jb250YWluZXIsIHtyaWdodDogLShzLndpZHRoLXRoaXMuaGVhZGVyT2Zmc2V0c1swXSksIGJvdHRvbTogLShzLmhlaWdodC10aGlzLmhlYWRlck9mZnNldHNbMV0pfSk7CiAgICAgICAgfQogICAgfSwKICAgIGI0RHJhZyA6IEV4dC5lbXB0eUZuLAoKICAgIG9uRHJhZyA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMuYWxpZ25FbFdpdGhNb3VzZSh0aGlzLnByb3h5LCBlLmdldFBhZ2VYKCksIGUuZ2V0UGFnZVkoKSk7CiAgICB9LAoKICAgIGVuZERyYWcgOiBmdW5jdGlvbihlKXsKICAgICAgICB0aGlzLndpbi51bmdob3N0KCk7CiAgICAgICAgdGhpcy53aW4uc2F2ZVN0YXRlKCk7CiAgICB9Cn0pOwoKRXh0LldpbmRvd0dyb3VwID0gZnVuY3Rpb24oKXsKICAgIHZhciBsaXN0ID0ge307CiAgICB2YXIgYWNjZXNzTGlzdCA9IFtdOwogICAgdmFyIGZyb250ID0gbnVsbDsKCiAgICAKICAgIHZhciBzb3J0V2luZG93cyA9IGZ1bmN0aW9uKGQxLCBkMil7CiAgICAgICAgcmV0dXJuICghZDEuX2xhc3RBY2Nlc3MgfHwgZDEuX2xhc3RBY2Nlc3MgPCBkMi5fbGFzdEFjY2VzcykgPyAtMSA6IDE7CiAgICB9OwoKICAgIAogICAgdmFyIG9yZGVyV2luZG93cyA9IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGEgPSBhY2Nlc3NMaXN0LCBsZW4gPSBhLmxlbmd0aDsKICAgICAgICBpZihsZW4gPiAwKXsKICAgICAgICAgICAgYS5zb3J0KHNvcnRXaW5kb3dzKTsKICAgICAgICAgICAgdmFyIHNlZWQgPSBhWzBdLm1hbmFnZXIuenNlZWQ7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICB2YXIgd2luID0gYVtpXTsKICAgICAgICAgICAgICAgIGlmKHdpbiAmJiAhd2luLmhpZGRlbil7CiAgICAgICAgICAgICAgICAgICAgd2luLnNldFpJbmRleChzZWVkICsgKGkqMTApKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBhY3RpdmF0ZUxhc3QoKTsKICAgIH07CgogICAgCiAgICB2YXIgc2V0QWN0aXZlV2luID0gZnVuY3Rpb24od2luKXsKICAgICAgICBpZih3aW4gIT0gZnJvbnQpewogICAgICAgICAgICBpZihmcm9udCl7CiAgICAgICAgICAgICAgICBmcm9udC5zZXRBY3RpdmUoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZyb250ID0gd2luOwogICAgICAgICAgICBpZih3aW4pewogICAgICAgICAgICAgICAgd2luLnNldEFjdGl2ZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgCiAgICB2YXIgYWN0aXZhdGVMYXN0ID0gZnVuY3Rpb24oKXsKICAgICAgICBmb3IodmFyIGkgPSBhY2Nlc3NMaXN0Lmxlbmd0aC0xOyBpID49MDsgLS1pKSB7CiAgICAgICAgICAgIGlmKCFhY2Nlc3NMaXN0W2ldLmhpZGRlbil7CiAgICAgICAgICAgICAgICBzZXRBY3RpdmVXaW4oYWNjZXNzTGlzdFtpXSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2V0QWN0aXZlV2luKG51bGwpOwogICAgfTsKCiAgICByZXR1cm4gewogICAgICAgIAogICAgICAgIHpzZWVkIDogOTAwMCwKCiAgICAgICAgCiAgICAgICAgcmVnaXN0ZXIgOiBmdW5jdGlvbih3aW4pewogICAgICAgICAgICBpZih3aW4ubWFuYWdlcil7CiAgICAgICAgICAgICAgICB3aW4ubWFuYWdlci51bnJlZ2lzdGVyKHdpbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2luLm1hbmFnZXIgPSB0aGlzOwoKICAgICAgICAgICAgbGlzdFt3aW4uaWRdID0gd2luOwogICAgICAgICAgICBhY2Nlc3NMaXN0LnB1c2god2luKTsKICAgICAgICAgICAgd2luLm9uKCdoaWRlJywgYWN0aXZhdGVMYXN0KTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICB1bnJlZ2lzdGVyIDogZnVuY3Rpb24od2luKXsKICAgICAgICAgICAgZGVsZXRlIHdpbi5tYW5hZ2VyOwogICAgICAgICAgICBkZWxldGUgbGlzdFt3aW4uaWRdOwogICAgICAgICAgICB3aW4udW4oJ2hpZGUnLCBhY3RpdmF0ZUxhc3QpOwogICAgICAgICAgICBhY2Nlc3NMaXN0LnJlbW92ZSh3aW4pOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGdldCA6IGZ1bmN0aW9uKGlkKXsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBpZCA9PSAib2JqZWN0IiA/IGlkIDogbGlzdFtpZF07CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgYnJpbmdUb0Zyb250IDogZnVuY3Rpb24od2luKXsKICAgICAgICAgICAgd2luID0gdGhpcy5nZXQod2luKTsKICAgICAgICAgICAgaWYod2luICE9IGZyb250KXsKICAgICAgICAgICAgICAgIHdpbi5fbGFzdEFjY2VzcyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICAgICAgICAgICAgb3JkZXJXaW5kb3dzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgc2VuZFRvQmFjayA6IGZ1bmN0aW9uKHdpbil7CiAgICAgICAgICAgIHdpbiA9IHRoaXMuZ2V0KHdpbik7CiAgICAgICAgICAgIHdpbi5fbGFzdEFjY2VzcyA9IC0obmV3IERhdGUoKS5nZXRUaW1lKCkpOwogICAgICAgICAgICBvcmRlcldpbmRvd3MoKTsKICAgICAgICAgICAgcmV0dXJuIHdpbjsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBoaWRlQWxsIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgZm9yKHZhciBpZCBpbiBsaXN0KXsKICAgICAgICAgICAgICAgIGlmKGxpc3RbaWRdICYmIHR5cGVvZiBsaXN0W2lkXSAhPSAiZnVuY3Rpb24iICYmIGxpc3RbaWRdLmlzVmlzaWJsZSgpKXsKICAgICAgICAgICAgICAgICAgICBsaXN0W2lkXS5oaWRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRBY3RpdmUgOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gZnJvbnQ7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0QnkgOiBmdW5jdGlvbihmbiwgc2NvcGUpewogICAgICAgICAgICB2YXIgciA9IFtdOwogICAgICAgICAgICBmb3IodmFyIGkgPSBhY2Nlc3NMaXN0Lmxlbmd0aC0xOyBpID49MDsgLS1pKSB7CiAgICAgICAgICAgICAgICB2YXIgd2luID0gYWNjZXNzTGlzdFtpXTsKICAgICAgICAgICAgICAgIGlmKGZuLmNhbGwoc2NvcGV8fHdpbiwgd2luKSAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgICAgIHIucHVzaCh3aW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGVhY2ggOiBmdW5jdGlvbihmbiwgc2NvcGUpewogICAgICAgICAgICBmb3IodmFyIGlkIGluIGxpc3QpewogICAgICAgICAgICAgICAgaWYobGlzdFtpZF0gJiYgdHlwZW9mIGxpc3RbaWRdICE9ICJmdW5jdGlvbiIpewogICAgICAgICAgICAgICAgICAgIGlmKGZuLmNhbGwoc2NvcGUgfHwgbGlzdFtpZF0sIGxpc3RbaWRdKSA9PT0gZmFsc2UpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKfTsKCgoKRXh0LldpbmRvd01nciA9IG5ldyBFeHQuV2luZG93R3JvdXAoKTsKRXh0Lk1lc3NhZ2VCb3ggPSBmdW5jdGlvbigpewogICAgdmFyIGRsZywgb3B0LCBtYXNrLCB3YWl0VGltZXIsCiAgICAgICAgYm9keUVsLCBtc2dFbCwgdGV4dGJveEVsLCB0ZXh0YXJlYUVsLCBwcm9ncmVzc0JhciwgcHAsIGljb25FbCwgc3BhY2VyRWwsCiAgICAgICAgYnV0dG9ucywgYWN0aXZlVGV4dEVsLCBid2lkdGgsIGJ1ZmZlckljb24gPSAnJywgaWNvbkNscyA9ICcnLAogICAgICAgIGJ1dHRvbk5hbWVzID0gWydvaycsICd5ZXMnLCAnbm8nLCAnY2FuY2VsJ107CgogICAgCiAgICB2YXIgaGFuZGxlQnV0dG9uID0gZnVuY3Rpb24oYnV0dG9uKXsKICAgICAgICBidXR0b25zW2J1dHRvbl0uYmx1cigpOwogICAgICAgIGlmKGRsZy5pc1Zpc2libGUoKSl7CiAgICAgICAgICAgIGRsZy5oaWRlKCk7CiAgICAgICAgICAgIGhhbmRsZUhpZGUoKTsKICAgICAgICAgICAgRXh0LmNhbGxiYWNrKG9wdC5mbiwgb3B0LnNjb3BlfHx3aW5kb3csIFtidXR0b24sIGFjdGl2ZVRleHRFbC5kb20udmFsdWUsIG9wdF0sIDEpOwogICAgICAgIH0KICAgIH07CgogICAgCiAgICB2YXIgaGFuZGxlSGlkZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYob3B0ICYmIG9wdC5jbHMpewogICAgICAgICAgICBkbGcuZWwucmVtb3ZlQ2xhc3Mob3B0LmNscyk7CiAgICAgICAgfQogICAgICAgIHByb2dyZXNzQmFyLnJlc2V0KCk7ICAgICAgICAKICAgIH07CgogICAgCiAgICB2YXIgaGFuZGxlRXNjID0gZnVuY3Rpb24oZCwgaywgZSl7CiAgICAgICAgaWYob3B0ICYmIG9wdC5jbG9zYWJsZSAhPT0gZmFsc2UpewogICAgICAgICAgICBkbGcuaGlkZSgpOwogICAgICAgICAgICBoYW5kbGVIaWRlKCk7CiAgICAgICAgfQogICAgICAgIGlmKGUpewogICAgICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgIH0KICAgIH07CgogICAgCiAgICB2YXIgdXBkYXRlQnV0dG9ucyA9IGZ1bmN0aW9uKGIpewogICAgICAgIHZhciB3aWR0aCA9IDAsCiAgICAgICAgICAgIGNmZzsKICAgICAgICBpZighYil7CiAgICAgICAgICAgIEV4dC5lYWNoKGJ1dHRvbk5hbWVzLCBmdW5jdGlvbihuYW1lKXsKICAgICAgICAgICAgICAgIGJ1dHRvbnNbbmFtZV0uaGlkZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHdpZHRoOwogICAgICAgIH0KICAgICAgICBkbGcuZm9vdGVyLmRvbS5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgRXh0Lml0ZXJhdGUoYnV0dG9ucywgZnVuY3Rpb24obmFtZSwgYnRuKXsKICAgICAgICAgICAgY2ZnID0gYltuYW1lXTsKICAgICAgICAgICAgaWYoY2ZnKXsKICAgICAgICAgICAgICAgIGJ0bi5zaG93KCk7CiAgICAgICAgICAgICAgICBidG4uc2V0VGV4dChFeHQuaXNTdHJpbmcoY2ZnKSA/IGNmZyA6IEV4dC5NZXNzYWdlQm94LmJ1dHRvblRleHRbbmFtZV0pOwogICAgICAgICAgICAgICAgd2lkdGggKz0gYnRuLmdldEVsKCkuZ2V0V2lkdGgoKSArIDE1OwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGJ0bi5oaWRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gd2lkdGg7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgICAgCiAgICAgICAgZ2V0RGlhbG9nIDogZnVuY3Rpb24odGl0bGVUZXh0KXsKICAgICAgICAgICBpZighZGxnKXsKICAgICAgICAgICAgICAgIHZhciBidG5zID0gW107CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGJ1dHRvbnMgPSB7fTsKICAgICAgICAgICAgICAgIEV4dC5lYWNoKGJ1dHRvbk5hbWVzLCBmdW5jdGlvbihuYW1lKXsKICAgICAgICAgICAgICAgICAgICBidG5zLnB1c2goYnV0dG9uc1tuYW1lXSA9IG5ldyBFeHQuQnV0dG9uKHsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogdGhpcy5idXR0b25UZXh0W25hbWVdLAogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVCdXR0b24uY3JlYXRlQ2FsbGJhY2sobmFtZSksCiAgICAgICAgICAgICAgICAgICAgICAgIGhpZGVNb2RlOiAnb2Zmc2V0cycKICAgICAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgICAgIGRsZyA9IG5ldyBFeHQuV2luZG93KHsKICAgICAgICAgICAgICAgICAgICBhdXRvQ3JlYXRlIDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICB0aXRsZTp0aXRsZVRleHQsCiAgICAgICAgICAgICAgICAgICAgcmVzaXphYmxlOmZhbHNlLAogICAgICAgICAgICAgICAgICAgIGNvbnN0cmFpbjp0cnVlLAogICAgICAgICAgICAgICAgICAgIGNvbnN0cmFpbkhlYWRlcjp0cnVlLAogICAgICAgICAgICAgICAgICAgIG1pbmltaXphYmxlIDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgbWF4aW1pemFibGUgOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBzdGF0ZWZ1bDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgbW9kYWw6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgc2hpbTp0cnVlLAogICAgICAgICAgICAgICAgICAgIGJ1dHRvbkFsaWduOiJjZW50ZXIiLAogICAgICAgICAgICAgICAgICAgIHdpZHRoOjQwMCwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6MTAwLAogICAgICAgICAgICAgICAgICAgIG1pbkhlaWdodDogODAsCiAgICAgICAgICAgICAgICAgICAgcGxhaW46dHJ1ZSwKICAgICAgICAgICAgICAgICAgICBmb290ZXI6dHJ1ZSwKICAgICAgICAgICAgICAgICAgICBjbG9zYWJsZTp0cnVlLAogICAgICAgICAgICAgICAgICAgIGNsb3NlIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYob3B0ICYmIG9wdC5idXR0b25zICYmIG9wdC5idXR0b25zLm5vICYmICFvcHQuYnV0dG9ucy5jYW5jZWwpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQnV0dG9uKCJubyIpOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUJ1dHRvbigiY2FuY2VsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGZiYXI6IG5ldyBFeHQuVG9vbGJhcih7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiBidG5zLAogICAgICAgICAgICAgICAgICAgICAgICBlbmFibGVPdmVyZmxvdzogZmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBkbGcucmVuZGVyKGRvY3VtZW50LmJvZHkpOwogICAgICAgICAgICAgICAgZGxnLmdldEVsKCkuYWRkQ2xhc3MoJ3gtd2luZG93LWRsZycpOwogICAgICAgICAgICAgICAgbWFzayA9IGRsZy5tYXNrOwogICAgICAgICAgICAgICAgYm9keUVsID0gZGxnLmJvZHkuY3JlYXRlQ2hpbGQoewogICAgICAgICAgICAgICAgICAgIGh0bWw6JzxkaXYgY2xhc3M9ImV4dC1tYi1pY29uIj48L2Rpdj48ZGl2IGNsYXNzPSJleHQtbWItY29udGVudCI+PHNwYW4gY2xhc3M9ImV4dC1tYi10ZXh0Ij48L3NwYW4+PGJyIC8+PGRpdiBjbGFzcz0iZXh0LW1iLWZpeC1jdXJzb3IiPjxpbnB1dCB0eXBlPSJ0ZXh0IiBjbGFzcz0iZXh0LW1iLWlucHV0IiAvPjx0ZXh0YXJlYSBjbGFzcz0iZXh0LW1iLXRleHRhcmVhIj48L3RleHRhcmVhPjwvZGl2PjwvZGl2PicKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWNvbkVsID0gRXh0LmdldChib2R5RWwuZG9tLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgdmFyIGNvbnRlbnRFbCA9IGJvZHlFbC5kb20uY2hpbGROb2Rlc1sxXTsKICAgICAgICAgICAgICAgIG1zZ0VsID0gRXh0LmdldChjb250ZW50RWwuZmlyc3RDaGlsZCk7CiAgICAgICAgICAgICAgICB0ZXh0Ym94RWwgPSBFeHQuZ2V0KGNvbnRlbnRFbC5jaGlsZE5vZGVzWzJdLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgdGV4dGJveEVsLmVuYWJsZURpc3BsYXlNb2RlKCk7CiAgICAgICAgICAgICAgICB0ZXh0Ym94RWwuYWRkS2V5TGlzdGVuZXIoWzEwLDEzXSwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBpZihkbGcuaXNWaXNpYmxlKCkgJiYgb3B0ICYmIG9wdC5idXR0b25zKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYob3B0LmJ1dHRvbnMub2spewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQnV0dG9uKCJvayIpOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihvcHQuYnV0dG9ucy55ZXMpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQnV0dG9uKCJ5ZXMiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGV4dGFyZWFFbCA9IEV4dC5nZXQoY29udGVudEVsLmNoaWxkTm9kZXNbMl0uY2hpbGROb2Rlc1sxXSk7CiAgICAgICAgICAgICAgICB0ZXh0YXJlYUVsLmVuYWJsZURpc3BsYXlNb2RlKCk7CiAgICAgICAgICAgICAgICBwcm9ncmVzc0JhciA9IG5ldyBFeHQuUHJvZ3Jlc3NCYXIoewogICAgICAgICAgICAgICAgICAgIHJlbmRlclRvOmJvZHlFbAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgIGJvZHlFbC5jcmVhdGVDaGlsZCh7Y2xzOid4LWNsZWFyJ30pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkbGc7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgdXBkYXRlVGV4dCA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgICAgICBpZighZGxnLmlzVmlzaWJsZSgpICYmICFvcHQud2lkdGgpewogICAgICAgICAgICAgICAgZGxnLnNldFNpemUodGhpcy5tYXhXaWR0aCwgMTAwKTsgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIG1zZ0VsLnVwZGF0ZSh0ZXh0ID8gdGV4dCArICcgJyA6ICcmIzE2MDsnKTsKCiAgICAgICAgICAgIHZhciBpdyA9IGljb25DbHMgIT0gJycgPyAoaWNvbkVsLmdldFdpZHRoKCkgKyBpY29uRWwuZ2V0TWFyZ2lucygnbHInKSkgOiAwLAogICAgICAgICAgICAgICAgbXcgPSBtc2dFbC5nZXRXaWR0aCgpICsgbXNnRWwuZ2V0TWFyZ2lucygnbHInKSwKICAgICAgICAgICAgICAgIGZ3ID0gZGxnLmdldEZyYW1lV2lkdGgoJ2xyJyksCiAgICAgICAgICAgICAgICBidyA9IGRsZy5ib2R5LmdldEZyYW1lV2lkdGgoJ2xyJyksCiAgICAgICAgICAgICAgICB3OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHcgPSBNYXRoLm1heChNYXRoLm1pbihvcHQud2lkdGggfHwgaXcrbXcrZncrYncsIG9wdC5tYXhXaWR0aCB8fCB0aGlzLm1heFdpZHRoKSwKICAgICAgICAgICAgICAgICAgICBNYXRoLm1heChvcHQubWluV2lkdGggfHwgdGhpcy5taW5XaWR0aCwgYndpZHRoIHx8IDApKTsKCiAgICAgICAgICAgIGlmKG9wdC5wcm9tcHQgPT09IHRydWUpewogICAgICAgICAgICAgICAgYWN0aXZlVGV4dEVsLnNldFdpZHRoKHctaXctZnctYncpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKG9wdC5wcm9ncmVzcyA9PT0gdHJ1ZSB8fCBvcHQud2FpdCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICBwcm9ncmVzc0Jhci5zZXRTaXplKHctaXctZnctYncpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKEV4dC5pc0lFICYmIHcgPT0gYndpZHRoKXsKICAgICAgICAgICAgICAgIHcgKz0gNDsgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbXNnRWwudXBkYXRlKHRleHQgfHwgJyYjMTYwOycpOwogICAgICAgICAgICBkbGcuc2V0U2l6ZSh3LCAnYXV0bycpLmNlbnRlcigpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICB1cGRhdGVQcm9ncmVzcyA6IGZ1bmN0aW9uKHZhbHVlLCBwcm9ncmVzc1RleHQsIG1zZyl7CiAgICAgICAgICAgIHByb2dyZXNzQmFyLnVwZGF0ZVByb2dyZXNzKHZhbHVlLCBwcm9ncmVzc1RleHQpOwogICAgICAgICAgICBpZihtc2cpewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVUZXh0KG1zZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaXNWaXNpYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIGRsZyAmJiBkbGcuaXNWaXNpYmxlKCk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgaGlkZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBwcm94eSA9IGRsZyA/IGRsZy5hY3RpdmVHaG9zdCA6IG51bGw7CiAgICAgICAgICAgIGlmKHRoaXMuaXNWaXNpYmxlKCkgfHwgcHJveHkpewogICAgICAgICAgICAgICAgZGxnLmhpZGUoKTsKICAgICAgICAgICAgICAgIGhhbmRsZUhpZGUoKTsKICAgICAgICAgICAgICAgIGlmIChwcm94eSl7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZGxnLnVuZ2hvc3QoZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgc2hvdyA6IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgICAgICAgICBpZih0aGlzLmlzVmlzaWJsZSgpKXsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdCA9IG9wdGlvbnM7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5nZXREaWFsb2cob3B0LnRpdGxlIHx8ICImIzE2MDsiKTsKCiAgICAgICAgICAgIGQuc2V0VGl0bGUob3B0LnRpdGxlIHx8ICImIzE2MDsiKTsKICAgICAgICAgICAgdmFyIGFsbG93Q2xvc2UgPSAob3B0LmNsb3NhYmxlICE9PSBmYWxzZSAmJiBvcHQucHJvZ3Jlc3MgIT09IHRydWUgJiYgb3B0LndhaXQgIT09IHRydWUpOwogICAgICAgICAgICBkLnRvb2xzLmNsb3NlLnNldERpc3BsYXllZChhbGxvd0Nsb3NlKTsKICAgICAgICAgICAgYWN0aXZlVGV4dEVsID0gdGV4dGJveEVsOwogICAgICAgICAgICBvcHQucHJvbXB0ID0gb3B0LnByb21wdCB8fCAob3B0Lm11bHRpbGluZSA/IHRydWUgOiBmYWxzZSk7CiAgICAgICAgICAgIGlmKG9wdC5wcm9tcHQpewogICAgICAgICAgICAgICAgaWYob3B0Lm11bHRpbGluZSl7CiAgICAgICAgICAgICAgICAgICAgdGV4dGJveEVsLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0YXJlYUVsLnNob3coKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0YXJlYUVsLnNldEhlaWdodChFeHQuaXNOdW1iZXIob3B0Lm11bHRpbGluZSkgPyBvcHQubXVsdGlsaW5lIDogdGhpcy5kZWZhdWx0VGV4dEhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZlVGV4dEVsID0gdGV4dGFyZWFFbDsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIHRleHRib3hFbC5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgdGV4dGFyZWFFbC5oaWRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGV4dGJveEVsLmhpZGUoKTsKICAgICAgICAgICAgICAgIHRleHRhcmVhRWwuaGlkZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdGl2ZVRleHRFbC5kb20udmFsdWUgPSBvcHQudmFsdWUgfHwgIiI7CiAgICAgICAgICAgIGlmKG9wdC5wcm9tcHQpewogICAgICAgICAgICAgICAgZC5mb2N1c0VsID0gYWN0aXZlVGV4dEVsOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHZhciBicyA9IG9wdC5idXR0b25zOwogICAgICAgICAgICAgICAgdmFyIGRiID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmKGJzICYmIGJzLm9rKXsKICAgICAgICAgICAgICAgICAgICBkYiA9IGJ1dHRvbnNbIm9rIl07CiAgICAgICAgICAgICAgICB9ZWxzZSBpZihicyAmJiBicy55ZXMpewogICAgICAgICAgICAgICAgICAgIGRiID0gYnV0dG9uc1sieWVzIl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZGIpewogICAgICAgICAgICAgICAgICAgIGQuZm9jdXNFbCA9IGRiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKEV4dC5pc0RlZmluZWQob3B0Lmljb25DbHMpKXsKICAgICAgICAgICAgICBkLnNldEljb25DbGFzcyhvcHQuaWNvbkNscyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZXRJY29uKEV4dC5pc0RlZmluZWQob3B0Lmljb24pID8gb3B0Lmljb24gOiBidWZmZXJJY29uKTsKICAgICAgICAgICAgYndpZHRoID0gdXBkYXRlQnV0dG9ucyhvcHQuYnV0dG9ucyk7CiAgICAgICAgICAgIHByb2dyZXNzQmFyLnNldFZpc2libGUob3B0LnByb2dyZXNzID09PSB0cnVlIHx8IG9wdC53YWl0ID09PSB0cnVlKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVQcm9ncmVzcygwLCBvcHQucHJvZ3Jlc3NUZXh0KTsKICAgICAgICAgICAgdGhpcy51cGRhdGVUZXh0KG9wdC5tc2cpOwogICAgICAgICAgICBpZihvcHQuY2xzKXsKICAgICAgICAgICAgICAgIGQuZWwuYWRkQ2xhc3Mob3B0LmNscyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZC5wcm94eURyYWcgPSBvcHQucHJveHlEcmFnID09PSB0cnVlOwogICAgICAgICAgICBkLm1vZGFsID0gb3B0Lm1vZGFsICE9PSBmYWxzZTsKICAgICAgICAgICAgZC5tYXNrID0gb3B0Lm1vZGFsICE9PSBmYWxzZSA/IG1hc2sgOiBmYWxzZTsKICAgICAgICAgICAgaWYoIWQuaXNWaXNpYmxlKCkpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRsZy5lbC5kb20pOwogICAgICAgICAgICAgICAgZC5zZXRBbmltYXRlVGFyZ2V0KG9wdC5hbmltRWwpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBkLm9uKCdzaG93JywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBpZihhbGxvd0Nsb3NlID09PSB0cnVlKXsKICAgICAgICAgICAgICAgICAgICAgICAgZC5rZXlNYXAuZW5hYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIGQua2V5TWFwLmRpc2FibGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCB0aGlzLCB7c2luZ2xlOnRydWV9KTsKICAgICAgICAgICAgICAgIGQuc2hvdyhvcHQuYW5pbUVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvcHQud2FpdCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICBwcm9ncmVzc0Jhci53YWl0KG9wdC53YWl0Q29uZmlnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBzZXRJY29uIDogZnVuY3Rpb24oaWNvbil7CiAgICAgICAgICAgIGlmKCFkbGcpewogICAgICAgICAgICAgICAgYnVmZmVySWNvbiA9IGljb247CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnVmZmVySWNvbiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgaWYoaWNvbiAmJiBpY29uICE9ICcnKXsKICAgICAgICAgICAgICAgIGljb25FbC5yZW1vdmVDbGFzcygneC1oaWRkZW4nKTsKICAgICAgICAgICAgICAgIGljb25FbC5yZXBsYWNlQ2xhc3MoaWNvbkNscywgaWNvbik7CiAgICAgICAgICAgICAgICBib2R5RWwuYWRkQ2xhc3MoJ3gtZGxnLWljb24nKTsKICAgICAgICAgICAgICAgIGljb25DbHMgPSBpY29uOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGljb25FbC5yZXBsYWNlQ2xhc3MoaWNvbkNscywgJ3gtaGlkZGVuJyk7CiAgICAgICAgICAgICAgICBib2R5RWwucmVtb3ZlQ2xhc3MoJ3gtZGxnLWljb24nKTsKICAgICAgICAgICAgICAgIGljb25DbHMgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBwcm9ncmVzcyA6IGZ1bmN0aW9uKHRpdGxlLCBtc2csIHByb2dyZXNzVGV4dCl7CiAgICAgICAgICAgIHRoaXMuc2hvdyh7CiAgICAgICAgICAgICAgICB0aXRsZSA6IHRpdGxlLAogICAgICAgICAgICAgICAgbXNnIDogbXNnLAogICAgICAgICAgICAgICAgYnV0dG9uczogZmFsc2UsCiAgICAgICAgICAgICAgICBwcm9ncmVzczp0cnVlLAogICAgICAgICAgICAgICAgY2xvc2FibGU6ZmFsc2UsCiAgICAgICAgICAgICAgICBtaW5XaWR0aDogdGhpcy5taW5Qcm9ncmVzc1dpZHRoLAogICAgICAgICAgICAgICAgcHJvZ3Jlc3NUZXh0OiBwcm9ncmVzc1RleHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHdhaXQgOiBmdW5jdGlvbihtc2csIHRpdGxlLCBjb25maWcpewogICAgICAgICAgICB0aGlzLnNob3coewogICAgICAgICAgICAgICAgdGl0bGUgOiB0aXRsZSwKICAgICAgICAgICAgICAgIG1zZyA6IG1zZywKICAgICAgICAgICAgICAgIGJ1dHRvbnM6IGZhbHNlLAogICAgICAgICAgICAgICAgY2xvc2FibGU6ZmFsc2UsCiAgICAgICAgICAgICAgICB3YWl0OnRydWUsCiAgICAgICAgICAgICAgICBtb2RhbDp0cnVlLAogICAgICAgICAgICAgICAgbWluV2lkdGg6IHRoaXMubWluUHJvZ3Jlc3NXaWR0aCwKICAgICAgICAgICAgICAgIHdhaXRDb25maWc6IGNvbmZpZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgYWxlcnQgOiBmdW5jdGlvbih0aXRsZSwgbXNnLCBmbiwgc2NvcGUpewogICAgICAgICAgICB0aGlzLnNob3coewogICAgICAgICAgICAgICAgdGl0bGUgOiB0aXRsZSwKICAgICAgICAgICAgICAgIG1zZyA6IG1zZywKICAgICAgICAgICAgICAgIGJ1dHRvbnM6IHRoaXMuT0ssCiAgICAgICAgICAgICAgICBmbjogZm4sCiAgICAgICAgICAgICAgICBzY29wZSA6IHNjb3BlLAogICAgICAgICAgICAgICAgbWluV2lkdGg6IHRoaXMubWluV2lkdGgKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGNvbmZpcm0gOiBmdW5jdGlvbih0aXRsZSwgbXNnLCBmbiwgc2NvcGUpewogICAgICAgICAgICB0aGlzLnNob3coewogICAgICAgICAgICAgICAgdGl0bGUgOiB0aXRsZSwKICAgICAgICAgICAgICAgIG1zZyA6IG1zZywKICAgICAgICAgICAgICAgIGJ1dHRvbnM6IHRoaXMuWUVTTk8sCiAgICAgICAgICAgICAgICBmbjogZm4sCiAgICAgICAgICAgICAgICBzY29wZSA6IHNjb3BlLAogICAgICAgICAgICAgICAgaWNvbjogdGhpcy5RVUVTVElPTiwKICAgICAgICAgICAgICAgIG1pbldpZHRoOiB0aGlzLm1pbldpZHRoCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBwcm9tcHQgOiBmdW5jdGlvbih0aXRsZSwgbXNnLCBmbiwgc2NvcGUsIG11bHRpbGluZSwgdmFsdWUpewogICAgICAgICAgICB0aGlzLnNob3coewogICAgICAgICAgICAgICAgdGl0bGUgOiB0aXRsZSwKICAgICAgICAgICAgICAgIG1zZyA6IG1zZywKICAgICAgICAgICAgICAgIGJ1dHRvbnM6IHRoaXMuT0tDQU5DRUwsCiAgICAgICAgICAgICAgICBmbjogZm4sCiAgICAgICAgICAgICAgICBtaW5XaWR0aDogdGhpcy5taW5Qcm9tcHRXaWR0aCwKICAgICAgICAgICAgICAgIHNjb3BlIDogc2NvcGUsCiAgICAgICAgICAgICAgICBwcm9tcHQ6dHJ1ZSwKICAgICAgICAgICAgICAgIG11bHRpbGluZTogbXVsdGlsaW5lLAogICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBPSyA6IHtvazp0cnVlfSwKICAgICAgICAKICAgICAgICBDQU5DRUwgOiB7Y2FuY2VsOnRydWV9LAogICAgICAgIAogICAgICAgIE9LQ0FOQ0VMIDoge29rOnRydWUsIGNhbmNlbDp0cnVlfSwKICAgICAgICAKICAgICAgICBZRVNOTyA6IHt5ZXM6dHJ1ZSwgbm86dHJ1ZX0sCiAgICAgICAgCiAgICAgICAgWUVTTk9DQU5DRUwgOiB7eWVzOnRydWUsIG5vOnRydWUsIGNhbmNlbDp0cnVlfSwKICAgICAgICAKICAgICAgICBJTkZPIDogJ2V4dC1tYi1pbmZvJywKICAgICAgICAKICAgICAgICBXQVJOSU5HIDogJ2V4dC1tYi13YXJuaW5nJywKICAgICAgICAKICAgICAgICBRVUVTVElPTiA6ICdleHQtbWItcXVlc3Rpb24nLAogICAgICAgIAogICAgICAgIEVSUk9SIDogJ2V4dC1tYi1lcnJvcicsCgogICAgICAgIAogICAgICAgIGRlZmF1bHRUZXh0SGVpZ2h0IDogNzUsCiAgICAgICAgCiAgICAgICAgbWF4V2lkdGggOiA2MDAsCiAgICAgICAgCiAgICAgICAgbWluV2lkdGggOiAxMDAsCiAgICAgICAgCiAgICAgICAgbWluUHJvZ3Jlc3NXaWR0aCA6IDI1MCwKICAgICAgICAKICAgICAgICBtaW5Qcm9tcHRXaWR0aDogMjUwLAogICAgICAgIAogICAgICAgIGJ1dHRvblRleHQgOiB7CiAgICAgICAgICAgIG9rIDogIk9LIiwKICAgICAgICAgICAgY2FuY2VsIDogIkNhbmNlbCIsCiAgICAgICAgICAgIHllcyA6ICJZZXMiLAogICAgICAgICAgICBubyA6ICJObyIKICAgICAgICB9CiAgICB9Owp9KCk7CgoKRXh0Lk1zZyA9IEV4dC5NZXNzYWdlQm94OwpFeHQuZGQuUGFuZWxQcm94eSAgPSBFeHQuZXh0ZW5kKE9iamVjdCwgewogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKHBhbmVsLCBjb25maWcpewogICAgICAgIHRoaXMucGFuZWwgPSBwYW5lbDsKICAgICAgICB0aGlzLmlkID0gdGhpcy5wYW5lbC5pZCArJy1kZHByb3h5JzsKICAgICAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsgICAgICAgIAogICAgfSwKICAgIAogICAgCiAgICBpbnNlcnRQcm94eSA6IHRydWUsCgogICAgCiAgICBzZXRTdGF0dXMgOiBFeHQuZW1wdHlGbiwKICAgIHJlc2V0IDogRXh0LmVtcHR5Rm4sCiAgICB1cGRhdGUgOiBFeHQuZW1wdHlGbiwKICAgIHN0b3AgOiBFeHQuZW1wdHlGbiwKICAgIHN5bmM6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgZ2V0RWwgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmdob3N0OwogICAgfSwKCiAgICAKICAgIGdldEdob3N0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5naG9zdDsKICAgIH0sCgogICAgCiAgICBnZXRQcm94eSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMucHJveHk7CiAgICB9LAoKICAgIAogICAgaGlkZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5naG9zdCl7CiAgICAgICAgICAgIGlmKHRoaXMucHJveHkpewogICAgICAgICAgICAgICAgdGhpcy5wcm94eS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnByb3h5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucGFuZWwuZWwuZG9tLnN0eWxlLmRpc3BsYXkgPSAnJzsKICAgICAgICAgICAgdGhpcy5naG9zdC5yZW1vdmUoKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuZ2hvc3Q7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNob3cgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLmdob3N0KXsKICAgICAgICAgICAgdGhpcy5naG9zdCA9IHRoaXMucGFuZWwuY3JlYXRlR2hvc3QodGhpcy5wYW5lbC5pbml0aWFsQ29uZmlnLmNscywgdW5kZWZpbmVkLCBFeHQuZ2V0Qm9keSgpKTsKICAgICAgICAgICAgdGhpcy5naG9zdC5zZXRYWSh0aGlzLnBhbmVsLmVsLmdldFhZKCkpOwogICAgICAgICAgICBpZih0aGlzLmluc2VydFByb3h5KXsKICAgICAgICAgICAgICAgIHRoaXMucHJveHkgPSB0aGlzLnBhbmVsLmVsLmluc2VydFNpYmxpbmcoe2NsczoneC1wYW5lbC1kZC1zcGFjZXInfSk7CiAgICAgICAgICAgICAgICB0aGlzLnByb3h5LnNldFNpemUodGhpcy5wYW5lbC5nZXRTaXplKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucGFuZWwuZWwuZG9tLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHJlcGFpciA6IGZ1bmN0aW9uKHh5LCBjYWxsYmFjaywgc2NvcGUpewogICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgIGlmKHR5cGVvZiBjYWxsYmFjayA9PSAiZnVuY3Rpb24iKXsKICAgICAgICAgICAgY2FsbGJhY2suY2FsbChzY29wZSB8fCB0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgbW92ZVByb3h5IDogZnVuY3Rpb24ocGFyZW50Tm9kZSwgYmVmb3JlKXsKICAgICAgICBpZih0aGlzLnByb3h5KXsKICAgICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGhpcy5wcm94eS5kb20sIGJlZm9yZSk7CiAgICAgICAgfQogICAgfQp9KTsKCgpFeHQuUGFuZWwuREQgPSBFeHQuZXh0ZW5kKEV4dC5kZC5EcmFnU291cmNlLCB7CiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24ocGFuZWwsIGNmZyl7CiAgICAgICAgdGhpcy5wYW5lbCA9IHBhbmVsOwogICAgICAgIHRoaXMuZHJhZ0RhdGEgPSB7cGFuZWw6IHBhbmVsfTsKICAgICAgICB0aGlzLnByb3h5ID0gbmV3IEV4dC5kZC5QYW5lbFByb3h5KHBhbmVsLCBjZmcpOwogICAgICAgIEV4dC5QYW5lbC5ERC5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgcGFuZWwuZWwsIGNmZyk7CiAgICAgICAgdmFyIGggPSBwYW5lbC5oZWFkZXIsCiAgICAgICAgICAgIGVsID0gcGFuZWwuYm9keTsKICAgICAgICBpZihoKXsKICAgICAgICAgICAgdGhpcy5zZXRIYW5kbGVFbElkKGguaWQpOwogICAgICAgICAgICBlbCA9IHBhbmVsLmhlYWRlcjsKICAgICAgICB9CiAgICAgICAgZWwuc2V0U3R5bGUoJ2N1cnNvcicsICdtb3ZlJyk7CiAgICAgICAgdGhpcy5zY3JvbGwgPSBmYWxzZTsgICAgICAgIAogICAgfSwKICAgIAogICAgc2hvd0ZyYW1lOiBFeHQuZW1wdHlGbiwKICAgIHN0YXJ0RHJhZzogRXh0LmVtcHR5Rm4sCiAgICBiNFN0YXJ0RHJhZzogZnVuY3Rpb24oeCwgeSkgewogICAgICAgIHRoaXMucHJveHkuc2hvdygpOwogICAgfSwKICAgIGI0TW91c2VEb3duOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIHggPSBlLmdldFBhZ2VYKCksCiAgICAgICAgICAgIHkgPSBlLmdldFBhZ2VZKCk7CiAgICAgICAgdGhpcy5hdXRvT2Zmc2V0KHgsIHkpOwogICAgfSwKICAgIG9uSW5pdERyYWcgOiBmdW5jdGlvbih4LCB5KXsKICAgICAgICB0aGlzLm9uU3RhcnREcmFnKHgsIHkpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIGNyZWF0ZUZyYW1lIDogRXh0LmVtcHR5Rm4sCiAgICBnZXREcmFnRWwgOiBmdW5jdGlvbihlKXsKICAgICAgICByZXR1cm4gdGhpcy5wcm94eS5naG9zdC5kb207CiAgICB9LAogICAgZW5kRHJhZyA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMucHJveHkuaGlkZSgpOwogICAgICAgIHRoaXMucGFuZWwuc2F2ZVN0YXRlKCk7CiAgICB9LAoKICAgIGF1dG9PZmZzZXQgOiBmdW5jdGlvbih4LCB5KSB7CiAgICAgICAgeCAtPSB0aGlzLnN0YXJ0UGFnZVg7CiAgICAgICAgeSAtPSB0aGlzLnN0YXJ0UGFnZVk7CiAgICAgICAgdGhpcy5zZXREZWx0YSh4LCB5KTsKICAgIH0KfSk7CkV4dC5zdGF0ZS5Qcm92aWRlciA9IEV4dC5leHRlbmQoRXh0LnV0aWwuT2JzZXJ2YWJsZSwgewogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgCiAgICAgICAgdGhpcy5hZGRFdmVudHMoInN0YXRlY2hhbmdlIik7CiAgICAgICAgdGhpcy5zdGF0ZSA9IHt9OwogICAgICAgIEV4dC5zdGF0ZS5Qcm92aWRlci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyk7CiAgICB9LAogICAgCiAgICAKICAgIGdldCA6IGZ1bmN0aW9uKG5hbWUsIGRlZmF1bHRWYWx1ZSl7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB0aGlzLnN0YXRlW25hbWVdID09ICJ1bmRlZmluZWQiID8KICAgICAgICAgICAgZGVmYXVsdFZhbHVlIDogdGhpcy5zdGF0ZVtuYW1lXTsKICAgIH0sCgogICAgCiAgICBjbGVhciA6IGZ1bmN0aW9uKG5hbWUpewogICAgICAgIGRlbGV0ZSB0aGlzLnN0YXRlW25hbWVdOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCJzdGF0ZWNoYW5nZSIsIHRoaXMsIG5hbWUsIG51bGwpOwogICAgfSwKCiAgICAKICAgIHNldCA6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKICAgICAgICB0aGlzLnN0YXRlW25hbWVdID0gdmFsdWU7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoInN0YXRlY2hhbmdlIiwgdGhpcywgbmFtZSwgdmFsdWUpOwogICAgfSwKCiAgICAKICAgIGRlY29kZVZhbHVlIDogZnVuY3Rpb24oY29va2llKXsKICAgICAgICAKICAgICAgICB2YXIgcmUgPSAvXihhfG58ZHxifHN8b3xlKVw6KC4qKSQvLAogICAgICAgICAgICBtYXRjaGVzID0gcmUuZXhlYyh1bmVzY2FwZShjb29raWUpKSwKICAgICAgICAgICAgYWxsLAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICB2LAogICAgICAgICAgICBrdjsKICAgICAgICBpZighbWF0Y2hlcyB8fCAhbWF0Y2hlc1sxXSl7CiAgICAgICAgICAgIHJldHVybjsgCiAgICAgICAgfQogICAgICAgIHR5cGUgPSBtYXRjaGVzWzFdOwogICAgICAgIHYgPSBtYXRjaGVzWzJdOwogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSAnZSc6CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSAnbic6CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdCh2KTsKICAgICAgICAgICAgY2FzZSAnZCc6CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoRGF0ZS5wYXJzZSh2KSk7CiAgICAgICAgICAgIGNhc2UgJ2InOgogICAgICAgICAgICAgICAgcmV0dXJuICh2ID09ICcxJyk7CiAgICAgICAgICAgIGNhc2UgJ2EnOgogICAgICAgICAgICAgICAgYWxsID0gW107CiAgICAgICAgICAgICAgICBpZih2ICE9ICcnKXsKICAgICAgICAgICAgICAgICAgICBFeHQuZWFjaCh2LnNwbGl0KCdeJyksIGZ1bmN0aW9uKHZhbCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGFsbC5wdXNoKHRoaXMuZGVjb2RlVmFsdWUodmFsKSk7CiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gYWxsOwogICAgICAgICAgIGNhc2UgJ28nOgogICAgICAgICAgICAgICAgYWxsID0ge307CiAgICAgICAgICAgICAgICBpZih2ICE9ICcnKXsKICAgICAgICAgICAgICAgICAgICBFeHQuZWFjaCh2LnNwbGl0KCdeJyksIGZ1bmN0aW9uKHZhbCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGt2ID0gdmFsLnNwbGl0KCc9Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFsbFtrdlswXV0gPSB0aGlzLmRlY29kZVZhbHVlKGt2WzFdKTsKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBhbGw7CiAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBlbmNvZGVWYWx1ZSA6IGZ1bmN0aW9uKHYpewogICAgICAgIHZhciBlbmMsCiAgICAgICAgICAgIGZsYXQgPSAnJywKICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgIGxlbiwKICAgICAgICAgICAga2V5OwogICAgICAgIGlmKHYgPT0gbnVsbCl7CiAgICAgICAgICAgIHJldHVybiAnZToxJzsgICAgCiAgICAgICAgfWVsc2UgaWYodHlwZW9mIHYgPT0gJ251bWJlcicpewogICAgICAgICAgICBlbmMgPSAnbjonICsgdjsKICAgICAgICB9ZWxzZSBpZih0eXBlb2YgdiA9PSAnYm9vbGVhbicpewogICAgICAgICAgICBlbmMgPSAnYjonICsgKHYgPyAnMScgOiAnMCcpOwogICAgICAgIH1lbHNlIGlmKEV4dC5pc0RhdGUodikpewogICAgICAgICAgICBlbmMgPSAnZDonICsgdi50b0dNVFN0cmluZygpOwogICAgICAgIH1lbHNlIGlmKEV4dC5pc0FycmF5KHYpKXsKICAgICAgICAgICAgZm9yKGxlbiA9IHYubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgZmxhdCArPSB0aGlzLmVuY29kZVZhbHVlKHZbaV0pOwogICAgICAgICAgICAgICAgaWYoaSAhPSBsZW4gLSAxKXsKICAgICAgICAgICAgICAgICAgICBmbGF0ICs9ICdeJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbmMgPSAnYTonICsgZmxhdDsKICAgICAgICB9ZWxzZSBpZih0eXBlb2YgdiA9PSAnb2JqZWN0Jyl7CiAgICAgICAgICAgIGZvcihrZXkgaW4gdil7CiAgICAgICAgICAgICAgICBpZih0eXBlb2YgdltrZXldICE9ICdmdW5jdGlvbicgJiYgdltrZXldICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgICAgIGZsYXQgKz0ga2V5ICsgJz0nICsgdGhpcy5lbmNvZGVWYWx1ZSh2W2tleV0pICsgJ14nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuYyA9ICdvOicgKyBmbGF0LnN1YnN0cmluZygwLCBmbGF0Lmxlbmd0aC0xKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgZW5jID0gJ3M6JyArIHY7CiAgICAgICAgfQogICAgICAgIHJldHVybiBlc2NhcGUoZW5jKTsKICAgIH0KfSk7CgpFeHQuc3RhdGUuTWFuYWdlciA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgcHJvdmlkZXIgPSBuZXcgRXh0LnN0YXRlLlByb3ZpZGVyKCk7CgogICAgcmV0dXJuIHsKICAgICAgICAKICAgICAgICBzZXRQcm92aWRlciA6IGZ1bmN0aW9uKHN0YXRlUHJvdmlkZXIpewogICAgICAgICAgICBwcm92aWRlciA9IHN0YXRlUHJvdmlkZXI7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0IDogZnVuY3Rpb24oa2V5LCBkZWZhdWx0VmFsdWUpewogICAgICAgICAgICByZXR1cm4gcHJvdmlkZXIuZ2V0KGtleSwgZGVmYXVsdFZhbHVlKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICAgc2V0IDogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CiAgICAgICAgICAgIHByb3ZpZGVyLnNldChrZXksIHZhbHVlKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBjbGVhciA6IGZ1bmN0aW9uKGtleSl7CiAgICAgICAgICAgIHByb3ZpZGVyLmNsZWFyKGtleSk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0UHJvdmlkZXIgOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gcHJvdmlkZXI7CiAgICAgICAgfQogICAgfTsKfSgpOwoKRXh0LnN0YXRlLkNvb2tpZVByb3ZpZGVyID0gRXh0LmV4dGVuZChFeHQuc3RhdGUuUHJvdmlkZXIsIHsKICAgIAogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIEV4dC5zdGF0ZS5Db29raWVQcm92aWRlci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5wYXRoID0gIi8iOwogICAgICAgIHRoaXMuZXhwaXJlcyA9IG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0VGltZSgpKygxMDAwKjYwKjYwKjI0KjcpKTsgCiAgICAgICAgdGhpcy5kb21haW4gPSBudWxsOwogICAgICAgIHRoaXMuc2VjdXJlID0gZmFsc2U7CiAgICAgICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CiAgICAgICAgdGhpcy5zdGF0ZSA9IHRoaXMucmVhZENvb2tpZXMoKTsKICAgIH0sCiAgICAKICAgIAogICAgc2V0IDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICAgIGlmKHR5cGVvZiB2YWx1ZSA9PSAidW5kZWZpbmVkIiB8fCB2YWx1ZSA9PT0gbnVsbCl7CiAgICAgICAgICAgIHRoaXMuY2xlYXIobmFtZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZXRDb29raWUobmFtZSwgdmFsdWUpOwogICAgICAgIEV4dC5zdGF0ZS5Db29raWVQcm92aWRlci5zdXBlcmNsYXNzLnNldC5jYWxsKHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgIH0sCgogICAgCiAgICBjbGVhciA6IGZ1bmN0aW9uKG5hbWUpewogICAgICAgIHRoaXMuY2xlYXJDb29raWUobmFtZSk7CiAgICAgICAgRXh0LnN0YXRlLkNvb2tpZVByb3ZpZGVyLnN1cGVyY2xhc3MuY2xlYXIuY2FsbCh0aGlzLCBuYW1lKTsKICAgIH0sCgogICAgCiAgICByZWFkQ29va2llcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGNvb2tpZXMgPSB7fSwKICAgICAgICAgICAgYyA9IGRvY3VtZW50LmNvb2tpZSArICI7IiwKICAgICAgICAgICAgcmUgPSAvXHM/KC4qPyk9KC4qPyk7L2csCiAgICAJICAgIG1hdGNoZXMsCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIHZhbHVlOwogICAgCXdoaWxlKChtYXRjaGVzID0gcmUuZXhlYyhjKSkgIT0gbnVsbCl7CiAgICAgICAgICAgIG5hbWUgPSBtYXRjaGVzWzFdOwogICAgICAgICAgICB2YWx1ZSA9IG1hdGNoZXNbMl07CiAgICAgICAgICAgIGlmKG5hbWUgJiYgbmFtZS5zdWJzdHJpbmcoMCwzKSA9PSAieXMtIil7CiAgICAgICAgICAgICAgICBjb29raWVzW25hbWUuc3Vic3RyKDMpXSA9IHRoaXMuZGVjb2RlVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb29raWVzOwogICAgfSwKCiAgICAKICAgIHNldENvb2tpZSA6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKICAgICAgICBkb2N1bWVudC5jb29raWUgPSAieXMtIisgbmFtZSArICI9IiArIHRoaXMuZW5jb2RlVmFsdWUodmFsdWUpICsKICAgICAgICAgICAoKHRoaXMuZXhwaXJlcyA9PSBudWxsKSA/ICIiIDogKCI7IGV4cGlyZXM9IiArIHRoaXMuZXhwaXJlcy50b0dNVFN0cmluZygpKSkgKwogICAgICAgICAgICgodGhpcy5wYXRoID09IG51bGwpID8gIiIgOiAoIjsgcGF0aD0iICsgdGhpcy5wYXRoKSkgKwogICAgICAgICAgICgodGhpcy5kb21haW4gPT0gbnVsbCkgPyAiIiA6ICgiOyBkb21haW49IiArIHRoaXMuZG9tYWluKSkgKwogICAgICAgICAgICgodGhpcy5zZWN1cmUgPT0gdHJ1ZSkgPyAiOyBzZWN1cmUiIDogIiIpOwogICAgfSwKCiAgICAKICAgIGNsZWFyQ29va2llIDogZnVuY3Rpb24obmFtZSl7CiAgICAgICAgZG9jdW1lbnQuY29va2llID0gInlzLSIgKyBuYW1lICsgIj1udWxsOyBleHBpcmVzPVRodSwgMDEtSmFuLTcwIDAwOjAwOjAxIEdNVCIgKwogICAgICAgICAgICgodGhpcy5wYXRoID09IG51bGwpID8gIiIgOiAoIjsgcGF0aD0iICsgdGhpcy5wYXRoKSkgKwogICAgICAgICAgICgodGhpcy5kb21haW4gPT0gbnVsbCkgPyAiIiA6ICgiOyBkb21haW49IiArIHRoaXMuZG9tYWluKSkgKwogICAgICAgICAgICgodGhpcy5zZWN1cmUgPT0gdHJ1ZSkgPyAiOyBzZWN1cmUiIDogIiIpOwogICAgfQp9KTsKRXh0LkRhdGFWaWV3ID0gRXh0LmV4dGVuZChFeHQuQm94Q29tcG9uZW50LCB7CiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICBzZWxlY3RlZENsYXNzIDogIngtdmlldy1zZWxlY3RlZCIsCiAgICAKICAgIGVtcHR5VGV4dCA6ICIiLAoKICAgIAogICAgZGVmZXJFbXB0eVRleHQ6IHRydWUsCiAgICAKICAgIHRyYWNrT3ZlcjogZmFsc2UsCiAgICAKICAgIAogICAgYmxvY2tSZWZyZXNoOiBmYWxzZSwKCiAgICAKICAgIGxhc3Q6IGZhbHNlLAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LkRhdGFWaWV3LnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIGlmKEV4dC5pc1N0cmluZyh0aGlzLnRwbCkgfHwgRXh0LmlzQXJyYXkodGhpcy50cGwpKXsKICAgICAgICAgICAgdGhpcy50cGwgPSBuZXcgRXh0LlhUZW1wbGF0ZSh0aGlzLnRwbCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICJiZWZvcmVjbGljayIsCiAgICAgICAgICAgIAogICAgICAgICAgICAiY2xpY2siLAogICAgICAgICAgICAKICAgICAgICAgICAgIm1vdXNlZW50ZXIiLAogICAgICAgICAgICAKICAgICAgICAgICAgIm1vdXNlbGVhdmUiLAogICAgICAgICAgICAKICAgICAgICAgICAgImNvbnRhaW5lcmNsaWNrIiwKICAgICAgICAgICAgCiAgICAgICAgICAgICJkYmxjbGljayIsCiAgICAgICAgICAgIAogICAgICAgICAgICAiY29udGV4dG1lbnUiLAogICAgICAgICAgICAKICAgICAgICAgICAgImNvbnRhaW5lcmNvbnRleHRtZW51IiwKICAgICAgICAgICAgCiAgICAgICAgICAgICJzZWxlY3Rpb25jaGFuZ2UiLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICJiZWZvcmVzZWxlY3QiCiAgICAgICAgKTsKCiAgICAgICAgdGhpcy5zdG9yZSA9IEV4dC5TdG9yZU1nci5sb29rdXAodGhpcy5zdG9yZSk7CiAgICAgICAgdGhpcy5hbGwgPSBuZXcgRXh0LkNvbXBvc2l0ZUVsZW1lbnRMaXRlKCk7CiAgICAgICAgdGhpcy5zZWxlY3RlZCA9IG5ldyBFeHQuQ29tcG9zaXRlRWxlbWVudExpdGUoKTsKICAgIH0sCgogICAgCiAgICBhZnRlclJlbmRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LkRhdGFWaWV3LnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKCgkJdGhpcy5tb24odGhpcy5nZXRUZW1wbGF0ZVRhcmdldCgpLCB7CiAgICAgICAgICAgICJjbGljayI6IHRoaXMub25DbGljaywKICAgICAgICAgICAgImRibGNsaWNrIjogdGhpcy5vbkRibENsaWNrLAogICAgICAgICAgICAiY29udGV4dG1lbnUiOiB0aGlzLm9uQ29udGV4dE1lbnUsCiAgICAgICAgICAgIHNjb3BlOnRoaXMKICAgICAgICB9KTsKCiAgICAgICAgaWYodGhpcy5vdmVyQ2xhc3MgfHwgdGhpcy50cmFja092ZXIpewogICAgICAgICAgICB0aGlzLm1vbih0aGlzLmdldFRlbXBsYXRlVGFyZ2V0KCksIHsKICAgICAgICAgICAgICAgICJtb3VzZW92ZXIiOiB0aGlzLm9uTW91c2VPdmVyLAogICAgICAgICAgICAgICAgIm1vdXNlb3V0IjogdGhpcy5vbk1vdXNlT3V0LAogICAgICAgICAgICAgICAgc2NvcGU6dGhpcwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuc3RvcmUpewogICAgICAgICAgICB0aGlzLmJpbmRTdG9yZSh0aGlzLnN0b3JlLCB0cnVlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVmcmVzaCA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuY2xlYXJTZWxlY3Rpb25zKGZhbHNlLCB0cnVlKTsKICAgICAgICB2YXIgZWwgPSB0aGlzLmdldFRlbXBsYXRlVGFyZ2V0KCksCiAgICAgICAgICAgIHJlY29yZHMgPSB0aGlzLnN0b3JlLmdldFJhbmdlKCk7CiAgICAgICAgICAgIAogICAgICAgIGVsLnVwZGF0ZSgnJyk7CiAgICAgICAgaWYocmVjb3Jkcy5sZW5ndGggPCAxKXsKICAgICAgICAgICAgaWYoIXRoaXMuZGVmZXJFbXB0eVRleHQgfHwgdGhpcy5oYXNTa2lwcGVkRW1wdHlUZXh0KXsKICAgICAgICAgICAgICAgIGVsLnVwZGF0ZSh0aGlzLmVtcHR5VGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hbGwuY2xlYXIoKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy50cGwub3ZlcndyaXRlKGVsLCB0aGlzLmNvbGxlY3REYXRhKHJlY29yZHMsIDApKTsKICAgICAgICAgICAgdGhpcy5hbGwuZmlsbChFeHQucXVlcnkodGhpcy5pdGVtU2VsZWN0b3IsIGVsLmRvbSkpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZUluZGV4ZXMoMCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaGFzU2tpcHBlZEVtcHR5VGV4dCA9IHRydWU7CiAgICB9LAoKICAgIGdldFRlbXBsYXRlVGFyZ2V0OiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmVsOwogICAgfSwKCiAgICAKICAgIHByZXBhcmVEYXRhIDogZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICB9LAoKICAgIAogICAgY29sbGVjdERhdGEgOiBmdW5jdGlvbihyZWNvcmRzLCBzdGFydEluZGV4KXsKICAgICAgICB2YXIgciA9IFtdLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gcmVjb3Jkcy5sZW5ndGg7CiAgICAgICAgZm9yKDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgcltyLmxlbmd0aF0gPSB0aGlzLnByZXBhcmVEYXRhKHJlY29yZHNbaV0uZGF0YSwgc3RhcnRJbmRleCArIGksIHJlY29yZHNbaV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcjsKICAgIH0sCgogICAgCiAgICBidWZmZXJSZW5kZXIgOiBmdW5jdGlvbihyZWNvcmRzLCBpbmRleCl7CiAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHRoaXMudHBsLm92ZXJ3cml0ZShkaXYsIHRoaXMuY29sbGVjdERhdGEocmVjb3JkcywgaW5kZXgpKTsKICAgICAgICByZXR1cm4gRXh0LnF1ZXJ5KHRoaXMuaXRlbVNlbGVjdG9yLCBkaXYpOwogICAgfSwKCiAgICAKICAgIG9uVXBkYXRlIDogZnVuY3Rpb24oZHMsIHJlY29yZCl7CiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5zdG9yZS5pbmRleE9mKHJlY29yZCk7CiAgICAgICAgaWYoaW5kZXggPiAtMSl7CiAgICAgICAgICAgIHZhciBzZWwgPSB0aGlzLmlzU2VsZWN0ZWQoaW5kZXgpLAogICAgICAgICAgICAgICAgb3JpZ2luYWwgPSB0aGlzLmFsbC5lbGVtZW50c1tpbmRleF0sCiAgICAgICAgICAgICAgICBub2RlID0gdGhpcy5idWZmZXJSZW5kZXIoW3JlY29yZF0sIGluZGV4KVswXTsKCiAgICAgICAgICAgIHRoaXMuYWxsLnJlcGxhY2VFbGVtZW50KGluZGV4LCBub2RlLCB0cnVlKTsKICAgICAgICAgICAgaWYoc2VsKXsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQucmVwbGFjZUVsZW1lbnQob3JpZ2luYWwsIG5vZGUpOwogICAgICAgICAgICAgICAgdGhpcy5hbGwuaXRlbShpbmRleCkuYWRkQ2xhc3ModGhpcy5zZWxlY3RlZENsYXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVwZGF0ZUluZGV4ZXMoaW5kZXgsIGluZGV4KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25BZGQgOiBmdW5jdGlvbihkcywgcmVjb3JkcywgaW5kZXgpewogICAgICAgIGlmKHRoaXMuYWxsLmdldENvdW50KCkgPT09IDApewogICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgbm9kZXMgPSB0aGlzLmJ1ZmZlclJlbmRlcihyZWNvcmRzLCBpbmRleCksIG4sIGEgPSB0aGlzLmFsbC5lbGVtZW50czsKICAgICAgICBpZihpbmRleCA8IHRoaXMuYWxsLmdldENvdW50KCkpewogICAgICAgICAgICBuID0gdGhpcy5hbGwuaXRlbShpbmRleCkuaW5zZXJ0U2libGluZyhub2RlcywgJ2JlZm9yZScsIHRydWUpOwogICAgICAgICAgICBhLnNwbGljZS5hcHBseShhLCBbaW5kZXgsIDBdLmNvbmNhdChub2RlcykpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBuID0gdGhpcy5hbGwubGFzdCgpLmluc2VydFNpYmxpbmcobm9kZXMsICdhZnRlcicsIHRydWUpOwogICAgICAgICAgICBhLnB1c2guYXBwbHkoYSwgbm9kZXMpOwogICAgICAgIH0KICAgICAgICB0aGlzLnVwZGF0ZUluZGV4ZXMoaW5kZXgpOwogICAgfSwKCiAgICAKICAgIG9uUmVtb3ZlIDogZnVuY3Rpb24oZHMsIHJlY29yZCwgaW5kZXgpewogICAgICAgIHRoaXMuZGVzZWxlY3QoaW5kZXgpOwogICAgICAgIHRoaXMuYWxsLnJlbW92ZUVsZW1lbnQoaW5kZXgsIHRydWUpOwogICAgICAgIHRoaXMudXBkYXRlSW5kZXhlcyhpbmRleCk7CiAgICAgICAgaWYgKHRoaXMuc3RvcmUuZ2V0Q291bnQoKSA9PT0gMCl7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZWZyZXNoTm9kZSA6IGZ1bmN0aW9uKGluZGV4KXsKICAgICAgICB0aGlzLm9uVXBkYXRlKHRoaXMuc3RvcmUsIHRoaXMuc3RvcmUuZ2V0QXQoaW5kZXgpKTsKICAgIH0sCgogICAgCiAgICB1cGRhdGVJbmRleGVzIDogZnVuY3Rpb24oc3RhcnRJbmRleCwgZW5kSW5kZXgpewogICAgICAgIHZhciBucyA9IHRoaXMuYWxsLmVsZW1lbnRzOwogICAgICAgIHN0YXJ0SW5kZXggPSBzdGFydEluZGV4IHx8IDA7CiAgICAgICAgZW5kSW5kZXggPSBlbmRJbmRleCB8fCAoKGVuZEluZGV4ID09PSAwKSA/IDAgOiAobnMubGVuZ3RoIC0gMSkpOwogICAgICAgIGZvcih2YXIgaSA9IHN0YXJ0SW5kZXg7IGkgPD0gZW5kSW5kZXg7IGkrKyl7CiAgICAgICAgICAgIG5zW2ldLnZpZXdJbmRleCA9IGk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBnZXRTdG9yZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmU7CiAgICB9LAoKICAgIAogICAgYmluZFN0b3JlIDogZnVuY3Rpb24oc3RvcmUsIGluaXRpYWwpewogICAgICAgIGlmKCFpbml0aWFsICYmIHRoaXMuc3RvcmUpewogICAgICAgICAgICBpZihzdG9yZSAhPT0gdGhpcy5zdG9yZSAmJiB0aGlzLnN0b3JlLmF1dG9EZXN0cm95KXsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUuZGVzdHJveSgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oImJlZm9yZWxvYWQiLCB0aGlzLm9uQmVmb3JlTG9hZCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JlLnVuKCJkYXRhY2hhbmdlZCIsIHRoaXMub25EYXRhQ2hhbmdlZCwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JlLnVuKCJhZGQiLCB0aGlzLm9uQWRkLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oInJlbW92ZSIsIHRoaXMub25SZW1vdmUsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5zdG9yZS51bigidXBkYXRlIiwgdGhpcy5vblVwZGF0ZSwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JlLnVuKCJjbGVhciIsIHRoaXMucmVmcmVzaCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXN0b3JlKXsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmKHN0b3JlKXsKICAgICAgICAgICAgc3RvcmUgPSBFeHQuU3RvcmVNZ3IubG9va3VwKHN0b3JlKTsKICAgICAgICAgICAgc3RvcmUub24oewogICAgICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgICAgICBiZWZvcmVsb2FkOiB0aGlzLm9uQmVmb3JlTG9hZCwKICAgICAgICAgICAgICAgIGRhdGFjaGFuZ2VkOiB0aGlzLm9uRGF0YUNoYW5nZWQsCiAgICAgICAgICAgICAgICBhZGQ6IHRoaXMub25BZGQsCiAgICAgICAgICAgICAgICByZW1vdmU6IHRoaXMub25SZW1vdmUsCiAgICAgICAgICAgICAgICB1cGRhdGU6IHRoaXMub25VcGRhdGUsCiAgICAgICAgICAgICAgICBjbGVhcjogdGhpcy5yZWZyZXNoCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB0aGlzLnN0b3JlID0gc3RvcmU7CiAgICAgICAgaWYoc3RvcmUpewogICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIG9uRGF0YUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmJsb2NrUmVmcmVzaCAhPT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLnJlZnJlc2guYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZmluZEl0ZW1Gcm9tQ2hpbGQgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICByZXR1cm4gRXh0LmZseShub2RlKS5maW5kUGFyZW50KHRoaXMuaXRlbVNlbGVjdG9yLCB0aGlzLmdldFRlbXBsYXRlVGFyZ2V0KCkpOwogICAgfSwKCiAgICAKICAgIG9uQ2xpY2sgOiBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgaXRlbSA9IGUuZ2V0VGFyZ2V0KHRoaXMuaXRlbVNlbGVjdG9yLCB0aGlzLmdldFRlbXBsYXRlVGFyZ2V0KCkpLAogICAgICAgICAgICBpbmRleDsKICAgICAgICBpZihpdGVtKXsKICAgICAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YoaXRlbSk7CiAgICAgICAgICAgIGlmKHRoaXMub25JdGVtQ2xpY2soaXRlbSwgaW5kZXgsIGUpICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgiY2xpY2siLCB0aGlzLCBpbmRleCwgaXRlbSwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoImNvbnRhaW5lcmNsaWNrIiwgdGhpcywgZSkgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIHRoaXMub25Db250YWluZXJDbGljayhlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgb25Db250YWluZXJDbGljayA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMuY2xlYXJTZWxlY3Rpb25zKCk7CiAgICB9LAoKICAgIAogICAgb25Db250ZXh0TWVudSA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciBpdGVtID0gZS5nZXRUYXJnZXQodGhpcy5pdGVtU2VsZWN0b3IsIHRoaXMuZ2V0VGVtcGxhdGVUYXJnZXQoKSk7CiAgICAgICAgaWYoaXRlbSl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJjb250ZXh0bWVudSIsIHRoaXMsIHRoaXMuaW5kZXhPZihpdGVtKSwgaXRlbSwgZSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJjb250YWluZXJjb250ZXh0bWVudSIsIHRoaXMsIGUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkRibENsaWNrIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIGl0ZW0gPSBlLmdldFRhcmdldCh0aGlzLml0ZW1TZWxlY3RvciwgdGhpcy5nZXRUZW1wbGF0ZVRhcmdldCgpKTsKICAgICAgICBpZihpdGVtKXsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImRibGNsaWNrIiwgdGhpcywgdGhpcy5pbmRleE9mKGl0ZW0pLCBpdGVtLCBlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25Nb3VzZU92ZXIgOiBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgaXRlbSA9IGUuZ2V0VGFyZ2V0KHRoaXMuaXRlbVNlbGVjdG9yLCB0aGlzLmdldFRlbXBsYXRlVGFyZ2V0KCkpOwogICAgICAgIGlmKGl0ZW0gJiYgaXRlbSAhPT0gdGhpcy5sYXN0SXRlbSl7CiAgICAgICAgICAgIHRoaXMubGFzdEl0ZW0gPSBpdGVtOwogICAgICAgICAgICBFeHQuZmx5KGl0ZW0pLmFkZENsYXNzKHRoaXMub3ZlckNsYXNzKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoIm1vdXNlZW50ZXIiLCB0aGlzLCB0aGlzLmluZGV4T2YoaXRlbSksIGl0ZW0sIGUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbk1vdXNlT3V0IDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYodGhpcy5sYXN0SXRlbSl7CiAgICAgICAgICAgIGlmKCFlLndpdGhpbih0aGlzLmxhc3RJdGVtLCB0cnVlLCB0cnVlKSl7CiAgICAgICAgICAgICAgICBFeHQuZmx5KHRoaXMubGFzdEl0ZW0pLnJlbW92ZUNsYXNzKHRoaXMub3ZlckNsYXNzKTsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJtb3VzZWxlYXZlIiwgdGhpcywgdGhpcy5pbmRleE9mKHRoaXMubGFzdEl0ZW0pLCB0aGlzLmxhc3RJdGVtLCBlKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxhc3RJdGVtOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uSXRlbUNsaWNrIDogZnVuY3Rpb24oaXRlbSwgaW5kZXgsIGUpewogICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCJiZWZvcmVjbGljayIsIHRoaXMsIGluZGV4LCBpdGVtLCBlKSA9PT0gZmFsc2UpewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMubXVsdGlTZWxlY3QpewogICAgICAgICAgICB0aGlzLmRvTXVsdGlTZWxlY3Rpb24oaXRlbSwgaW5kZXgsIGUpOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfWVsc2UgaWYodGhpcy5zaW5nbGVTZWxlY3QpewogICAgICAgICAgICB0aGlzLmRvU2luZ2xlU2VsZWN0aW9uKGl0ZW0sIGluZGV4LCBlKTsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgCiAgICBkb1NpbmdsZVNlbGVjdGlvbiA6IGZ1bmN0aW9uKGl0ZW0sIGluZGV4LCBlKXsKICAgICAgICBpZihlLmN0cmxLZXkgJiYgdGhpcy5pc1NlbGVjdGVkKGluZGV4KSl7CiAgICAgICAgICAgIHRoaXMuZGVzZWxlY3QoaW5kZXgpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLnNlbGVjdChpbmRleCwgZmFsc2UpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBkb011bHRpU2VsZWN0aW9uIDogZnVuY3Rpb24oaXRlbSwgaW5kZXgsIGUpewogICAgICAgIGlmKGUuc2hpZnRLZXkgJiYgdGhpcy5sYXN0ICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHZhciBsYXN0ID0gdGhpcy5sYXN0OwogICAgICAgICAgICB0aGlzLnNlbGVjdFJhbmdlKGxhc3QsIGluZGV4LCBlLmN0cmxLZXkpOwogICAgICAgICAgICB0aGlzLmxhc3QgPSBsYXN0OyAKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgaWYoKGUuY3RybEtleXx8dGhpcy5zaW1wbGVTZWxlY3QpICYmIHRoaXMuaXNTZWxlY3RlZChpbmRleCkpewogICAgICAgICAgICAgICAgdGhpcy5kZXNlbGVjdChpbmRleCk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3QoaW5kZXgsIGUuY3RybEtleSB8fCBlLnNoaWZ0S2V5IHx8IHRoaXMuc2ltcGxlU2VsZWN0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRTZWxlY3Rpb25Db3VudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0ZWQuZ2V0Q291bnQoKTsKICAgIH0sCgogICAgCiAgICBnZXRTZWxlY3RlZE5vZGVzIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZC5lbGVtZW50czsKICAgIH0sCgogICAgCiAgICBnZXRTZWxlY3RlZEluZGV4ZXMgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBpbmRleGVzID0gW10sIAogICAgICAgICAgICBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQuZWxlbWVudHMsCiAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICBsZW4gPSBzZWxlY3RlZC5sZW5ndGg7CiAgICAgICAgICAgIAogICAgICAgIGZvcig7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGluZGV4ZXMucHVzaChzZWxlY3RlZFtpXS52aWV3SW5kZXgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5kZXhlczsKICAgIH0sCgogICAgCiAgICBnZXRTZWxlY3RlZFJlY29yZHMgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmdldFJlY29yZHModGhpcy5zZWxlY3RlZC5lbGVtZW50cyk7CiAgICB9LAoKICAgIAogICAgZ2V0UmVjb3JkcyA6IGZ1bmN0aW9uKG5vZGVzKXsKICAgICAgICB2YXIgcmVjb3JkcyA9IFtdLCAKICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgIGxlbiA9IG5vZGVzLmxlbmd0aDsKICAgICAgICAgICAgCiAgICAgICAgZm9yKDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgcmVjb3Jkc1tyZWNvcmRzLmxlbmd0aF0gPSB0aGlzLnN0b3JlLmdldEF0KG5vZGVzW2ldLnZpZXdJbmRleCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZWNvcmRzOwogICAgfSwKCiAgICAKICAgIGdldFJlY29yZCA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHJldHVybiB0aGlzLnN0b3JlLmdldEF0KG5vZGUudmlld0luZGV4KTsKICAgIH0sCgogICAgCiAgICBjbGVhclNlbGVjdGlvbnMgOiBmdW5jdGlvbihzdXBwcmVzc0V2ZW50LCBza2lwVXBkYXRlKXsKICAgICAgICBpZigodGhpcy5tdWx0aVNlbGVjdCB8fCB0aGlzLnNpbmdsZVNlbGVjdCkgJiYgdGhpcy5zZWxlY3RlZC5nZXRDb3VudCgpID4gMCl7CiAgICAgICAgICAgIGlmKCFza2lwVXBkYXRlKXsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQucmVtb3ZlQ2xhc3ModGhpcy5zZWxlY3RlZENsYXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNlbGVjdGVkLmNsZWFyKCk7CiAgICAgICAgICAgIHRoaXMubGFzdCA9IGZhbHNlOwogICAgICAgICAgICBpZighc3VwcHJlc3NFdmVudCl7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgic2VsZWN0aW9uY2hhbmdlIiwgdGhpcywgdGhpcy5zZWxlY3RlZC5lbGVtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaXNTZWxlY3RlZCA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHJldHVybiB0aGlzLnNlbGVjdGVkLmNvbnRhaW5zKHRoaXMuZ2V0Tm9kZShub2RlKSk7CiAgICB9LAoKICAgIAogICAgZGVzZWxlY3QgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICBpZih0aGlzLmlzU2VsZWN0ZWQobm9kZSkpewogICAgICAgICAgICBub2RlID0gdGhpcy5nZXROb2RlKG5vZGUpOwogICAgICAgICAgICB0aGlzLnNlbGVjdGVkLnJlbW92ZUVsZW1lbnQobm9kZSk7CiAgICAgICAgICAgIGlmKHRoaXMubGFzdCA9PSBub2RlLnZpZXdJbmRleCl7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3QgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFeHQuZmx5KG5vZGUpLnJlbW92ZUNsYXNzKHRoaXMuc2VsZWN0ZWRDbGFzcyk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJzZWxlY3Rpb25jaGFuZ2UiLCB0aGlzLCB0aGlzLnNlbGVjdGVkLmVsZW1lbnRzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2VsZWN0IDogZnVuY3Rpb24obm9kZUluZm8sIGtlZXBFeGlzdGluZywgc3VwcHJlc3NFdmVudCl7CiAgICAgICAgaWYoRXh0LmlzQXJyYXkobm9kZUluZm8pKXsKICAgICAgICAgICAgaWYoIWtlZXBFeGlzdGluZyl7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyU2VsZWN0aW9ucyh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBub2RlSW5mby5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdChub2RlSW5mb1tpXSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXN1cHByZXNzRXZlbnQpewogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoInNlbGVjdGlvbmNoYW5nZSIsIHRoaXMsIHRoaXMuc2VsZWN0ZWQuZWxlbWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlewogICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMuZ2V0Tm9kZShub2RlSW5mbyk7CiAgICAgICAgICAgIGlmKCFrZWVwRXhpc3RpbmcpewogICAgICAgICAgICAgICAgdGhpcy5jbGVhclNlbGVjdGlvbnModHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYobm9kZSAmJiAhdGhpcy5pc1NlbGVjdGVkKG5vZGUpKXsKICAgICAgICAgICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCJiZWZvcmVzZWxlY3QiLCB0aGlzLCBub2RlLCB0aGlzLnNlbGVjdGVkLmVsZW1lbnRzKSAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgICAgIEV4dC5mbHkobm9kZSkuYWRkQ2xhc3ModGhpcy5zZWxlY3RlZENsYXNzKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkLmFkZChub2RlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3QgPSBub2RlLnZpZXdJbmRleDsKICAgICAgICAgICAgICAgICAgICBpZighc3VwcHJlc3NFdmVudCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJzZWxlY3Rpb25jaGFuZ2UiLCB0aGlzLCB0aGlzLnNlbGVjdGVkLmVsZW1lbnRzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2VsZWN0UmFuZ2UgOiBmdW5jdGlvbihzdGFydCwgZW5kLCBrZWVwRXhpc3RpbmcpewogICAgICAgIGlmKCFrZWVwRXhpc3RpbmcpewogICAgICAgICAgICB0aGlzLmNsZWFyU2VsZWN0aW9ucyh0cnVlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZWxlY3QodGhpcy5nZXROb2RlcyhzdGFydCwgZW5kKSwgdHJ1ZSk7CiAgICB9LAoKICAgIAogICAgZ2V0Tm9kZSA6IGZ1bmN0aW9uKG5vZGVJbmZvKXsKICAgICAgICBpZihFeHQuaXNTdHJpbmcobm9kZUluZm8pKXsKICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG5vZGVJbmZvKTsKICAgICAgICB9ZWxzZSBpZihFeHQuaXNOdW1iZXIobm9kZUluZm8pKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWxsLmVsZW1lbnRzW25vZGVJbmZvXTsKICAgICAgICB9ZWxzZSBpZihub2RlSW5mbyBpbnN0YW5jZW9mIEV4dC5kYXRhLlJlY29yZCl7CiAgICAgICAgICAgIHZhciBpZHggPSB0aGlzLnN0b3JlLmluZGV4T2Yobm9kZUluZm8pOwogICAgICAgICAgICByZXR1cm4gdGhpcy5hbGwuZWxlbWVudHNbaWR4XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5vZGVJbmZvOwogICAgfSwKCiAgICAKICAgIGdldE5vZGVzIDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CiAgICAgICAgdmFyIG5zID0gdGhpcy5hbGwuZWxlbWVudHMsCiAgICAgICAgICAgIG5vZGVzID0gW10sCiAgICAgICAgICAgIGk7CiAgICAgICAgICAgIAogICAgICAgIHN0YXJ0ID0gc3RhcnQgfHwgMDsKICAgICAgICBlbmQgPSAhRXh0LmlzRGVmaW5lZChlbmQpID8gTWF0aC5tYXgobnMubGVuZ3RoIC0gMSwgMCkgOiBlbmQ7CiAgICAgICAgaWYoc3RhcnQgPD0gZW5kKXsKICAgICAgICAgICAgZm9yKGkgPSBzdGFydDsgaSA8PSBlbmQgJiYgbnNbaV07IGkrKyl7CiAgICAgICAgICAgICAgICBub2Rlcy5wdXNoKG5zW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZXsKICAgICAgICAgICAgZm9yKGkgPSBzdGFydDsgaSA+PSBlbmQgJiYgbnNbaV07IGktLSl7CiAgICAgICAgICAgICAgICBub2Rlcy5wdXNoKG5zW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbm9kZXM7CiAgICB9LAoKICAgIAogICAgaW5kZXhPZiA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIG5vZGUgPSB0aGlzLmdldE5vZGUobm9kZSk7CiAgICAgICAgaWYoRXh0LmlzTnVtYmVyKG5vZGUudmlld0luZGV4KSl7CiAgICAgICAgICAgIHJldHVybiBub2RlLnZpZXdJbmRleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuYWxsLmluZGV4T2Yobm9kZSk7CiAgICB9LAoKICAgIAogICAgb25CZWZvcmVMb2FkIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmxvYWRpbmdUZXh0KXsKICAgICAgICAgICAgdGhpcy5jbGVhclNlbGVjdGlvbnMoZmFsc2UsIHRydWUpOwogICAgICAgICAgICB0aGlzLmdldFRlbXBsYXRlVGFyZ2V0KCkudXBkYXRlKCc8ZGl2IGNsYXNzPSJsb2FkaW5nLWluZGljYXRvciI+Jyt0aGlzLmxvYWRpbmdUZXh0Kyc8L2Rpdj4nKTsKICAgICAgICAgICAgdGhpcy5hbGwuY2xlYXIoKTsKICAgICAgICB9CiAgICB9LAoKICAgIG9uRGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5hbGwuY2xlYXIoKTsKICAgICAgICB0aGlzLnNlbGVjdGVkLmNsZWFyKCk7CiAgICAgICAgRXh0LkRhdGFWaWV3LnN1cGVyY2xhc3Mub25EZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5iaW5kU3RvcmUobnVsbCk7CiAgICB9Cn0pOwoKCkV4dC5EYXRhVmlldy5wcm90b3R5cGUuc2V0U3RvcmUgPSBFeHQuRGF0YVZpZXcucHJvdG90eXBlLmJpbmRTdG9yZTsKCkV4dC5yZWcoJ2RhdGF2aWV3JywgRXh0LkRhdGFWaWV3KTsKCkV4dC5saXN0Lkxpc3RWaWV3ID0gRXh0LmV4dGVuZChFeHQuRGF0YVZpZXcsIHsKICAgIAogICAgCiAgICAKICAgIGl0ZW1TZWxlY3RvcjogJ2RsJywKICAgIAogICAgc2VsZWN0ZWRDbGFzczoneC1saXN0LXNlbGVjdGVkJywKICAgIAogICAgb3ZlckNsYXNzOid4LWxpc3Qtb3ZlcicsCiAgICAKICAgIAogICAgc2Nyb2xsT2Zmc2V0IDogdW5kZWZpbmVkLAogICAgCiAgICBjb2x1bW5SZXNpemU6IHRydWUsCiAgICAKICAgIAogICAgY29sdW1uU29ydDogdHJ1ZSwKICAgIAoKICAgIAogICAgbWF4Q29sdW1uV2lkdGg6IEV4dC5pc0lFID8gOTkgOiAxMDAsCgogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5jb2x1bW5SZXNpemUpewogICAgICAgICAgICB0aGlzLmNvbFJlc2l6ZXIgPSBuZXcgRXh0Lmxpc3QuQ29sdW1uUmVzaXplcih0aGlzLmNvbFJlc2l6ZXIpOwogICAgICAgICAgICB0aGlzLmNvbFJlc2l6ZXIuaW5pdCh0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5jb2x1bW5Tb3J0KXsKICAgICAgICAgICAgdGhpcy5jb2xTb3J0ZXIgPSBuZXcgRXh0Lmxpc3QuU29ydGVyKHRoaXMuY29sdW1uU29ydCk7CiAgICAgICAgICAgIHRoaXMuY29sU29ydGVyLmluaXQodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmKCF0aGlzLmludGVybmFsVHBsKXsKICAgICAgICAgICAgdGhpcy5pbnRlcm5hbFRwbCA9IG5ldyBFeHQuWFRlbXBsYXRlKAogICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9IngtbGlzdC1oZWFkZXIiPjxkaXYgY2xhc3M9IngtbGlzdC1oZWFkZXItaW5uZXIiPicsCiAgICAgICAgICAgICAgICAgICAgJzx0cGwgZm9yPSJjb2x1bW5zIj4nLAogICAgICAgICAgICAgICAgICAgICc8ZGl2IHN0eWxlPSJ3aWR0aDp7W3ZhbHVlcy53aWR0aCoxMDBdfSU7dGV4dC1hbGlnbjp7YWxpZ259OyI+PGVtIHVuc2VsZWN0YWJsZT0ib24iIGlkPSInLHRoaXMuaWQsICcteGxoZC17I30iPicsCiAgICAgICAgICAgICAgICAgICAgICAgICd7aGVhZGVyfScsCiAgICAgICAgICAgICAgICAgICAgJzwvZW0+PC9kaXY+JywKICAgICAgICAgICAgICAgICAgICAnPC90cGw+JywKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1jbGVhciI+PC9kaXY+JywKICAgICAgICAgICAgICAgICc8L2Rpdj48L2Rpdj4nLAogICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9IngtbGlzdC1ib2R5Ij48ZGl2IGNsYXNzPSJ4LWxpc3QtYm9keS1pbm5lciI+JywKICAgICAgICAgICAgICAgICc8L2Rpdj48L2Rpdj4nCiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmKCF0aGlzLnRwbCl7CiAgICAgICAgICAgIHRoaXMudHBsID0gbmV3IEV4dC5YVGVtcGxhdGUoCiAgICAgICAgICAgICAgICAnPHRwbCBmb3I9InJvd3MiPicsCiAgICAgICAgICAgICAgICAgICAgJzxkbD4nLAogICAgICAgICAgICAgICAgICAgICAgICAnPHRwbCBmb3I9InBhcmVudC5jb2x1bW5zIj4nLAogICAgICAgICAgICAgICAgICAgICAgICAnPGR0IHN0eWxlPSJ3aWR0aDp7W3ZhbHVlcy53aWR0aCoxMDBdfSU7dGV4dC1hbGlnbjp7YWxpZ259OyI+JywKICAgICAgICAgICAgICAgICAgICAgICAgJzxlbSB1bnNlbGVjdGFibGU9Im9uIjx0cGwgaWY9ImNscyI+IGNsYXNzPSJ7Y2xzfTwvdHBsPiI+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7W3ZhbHVlcy50cGwuYXBwbHkocGFyZW50KV19JywKICAgICAgICAgICAgICAgICAgICAgICAgJzwvZW0+PC9kdD4nLAogICAgICAgICAgICAgICAgICAgICAgICAnPC90cGw+JywKICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9IngtY2xlYXIiPjwvZGl2PicsCiAgICAgICAgICAgICAgICAgICAgJzwvZGw+JywKICAgICAgICAgICAgICAgICc8L3RwbD4nCiAgICAgICAgICAgICk7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGNzID0gdGhpcy5jb2x1bW5zLAogICAgICAgICAgICBhbGxvY2F0ZWRXaWR0aCA9IDAsCiAgICAgICAgICAgIGNvbHNXaXRoV2lkdGggPSAwLAogICAgICAgICAgICBsZW4gPSBjcy5sZW5ndGgsCiAgICAgICAgICAgIGNvbHVtbnMgPSBbXTsKCiAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgdmFyIGMgPSBjc1tpXTsKICAgICAgICAgICAgaWYoIWMuaXNDb2x1bW4pIHsKICAgICAgICAgICAgICAgIGMueHR5cGUgPSBjLnh0eXBlID8gKC9ebHYvLnRlc3QoYy54dHlwZSkgPyBjLnh0eXBlIDogJ2x2JyArIGMueHR5cGUpIDogJ2x2Y29sdW1uJzsKICAgICAgICAgICAgICAgIGMgPSBFeHQuY3JlYXRlKGMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGMud2lkdGgpIHsKICAgICAgICAgICAgICAgIGFsbG9jYXRlZFdpZHRoICs9IGMud2lkdGgqMTAwOwogICAgICAgICAgICAgICAgaWYoYWxsb2NhdGVkV2lkdGggPiB0aGlzLm1heENvbHVtbldpZHRoKXsKICAgICAgICAgICAgICAgICAgICBjLndpZHRoIC09IChhbGxvY2F0ZWRXaWR0aCAtIHRoaXMubWF4Q29sdW1uV2lkdGgpIC8gMTAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29sc1dpdGhXaWR0aCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbHVtbnMucHVzaChjKTsKICAgICAgICB9CgogICAgICAgIGNzID0gdGhpcy5jb2x1bW5zID0gY29sdW1uczsKCiAgICAgICAgCiAgICAgICAgaWYoY29sc1dpdGhXaWR0aCA8IGxlbil7CiAgICAgICAgICAgIHZhciByZW1haW5pbmcgPSBsZW4gLSBjb2xzV2l0aFdpZHRoOwogICAgICAgICAgICBpZihhbGxvY2F0ZWRXaWR0aCA8IHRoaXMubWF4Q29sdW1uV2lkdGgpewogICAgICAgICAgICAgICAgdmFyIHBlckNvbCA9ICgodGhpcy5tYXhDb2x1bW5XaWR0aC1hbGxvY2F0ZWRXaWR0aCkgLyByZW1haW5pbmcpLzEwMDsKICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBsZW47IGorKyl7CiAgICAgICAgICAgICAgICAgICAgdmFyIGMgPSBjc1tqXTsKICAgICAgICAgICAgICAgICAgICBpZighYy53aWR0aCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGMud2lkdGggPSBwZXJDb2w7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIEV4dC5saXN0Lkxpc3RWaWV3LnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgfSwKCiAgICBvblJlbmRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5hdXRvRWwgPSB7CiAgICAgICAgICAgIGNsczogJ3gtbGlzdC13cmFwJwogICAgICAgIH07CiAgICAgICAgRXh0Lmxpc3QuTGlzdFZpZXcuc3VwZXJjbGFzcy5vblJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICB0aGlzLmludGVybmFsVHBsLm92ZXJ3cml0ZSh0aGlzLmVsLCB7Y29sdW1uczogdGhpcy5jb2x1bW5zfSk7CgogICAgICAgIHRoaXMuaW5uZXJCb2R5ID0gRXh0LmdldCh0aGlzLmVsLmRvbS5jaGlsZE5vZGVzWzFdLmZpcnN0Q2hpbGQpOwogICAgICAgIHRoaXMuaW5uZXJIZCA9IEV4dC5nZXQodGhpcy5lbC5kb20uZmlyc3RDaGlsZC5maXJzdENoaWxkKTsKCiAgICAgICAgaWYodGhpcy5oaWRlSGVhZGVycyl7CiAgICAgICAgICAgIHRoaXMuZWwuZG9tLmZpcnN0Q2hpbGQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICB9CiAgICB9LAoKICAgIGdldFRlbXBsYXRlVGFyZ2V0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pbm5lckJvZHk7CiAgICB9LAoKICAgIAogICAgY29sbGVjdERhdGEgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBycyA9IEV4dC5saXN0Lkxpc3RWaWV3LnN1cGVyY2xhc3MuY29sbGVjdERhdGEuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjb2x1bW5zOiB0aGlzLmNvbHVtbnMsCiAgICAgICAgICAgIHJvd3M6IHJzCiAgICAgICAgfTsKICAgIH0sCgogICAgdmVyaWZ5SW50ZXJuYWxTaXplIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmxhc3RTaXplKXsKICAgICAgICAgICAgdGhpcy5vblJlc2l6ZSh0aGlzLmxhc3RTaXplLndpZHRoLCB0aGlzLmxhc3RTaXplLmhlaWdodCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uUmVzaXplIDogZnVuY3Rpb24odywgaCl7CiAgICAgICAgdmFyIGJvZHkgPSB0aGlzLmlubmVyQm9keS5kb20sCiAgICAgICAgICAgIGhlYWRlciA9IHRoaXMuaW5uZXJIZC5kb20sCiAgICAgICAgICAgIHNjcm9sbFdpZHRoID0gdyAtIEV4dC5udW0odGhpcy5zY3JvbGxPZmZzZXQsIEV4dC5nZXRTY3JvbGxCYXJXaWR0aCgpKSArICdweCcsCiAgICAgICAgICAgIHBhcmVudE5vZGU7CiAgICAgICAgICAgIAogICAgICAgIGlmKCFib2R5KXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBwYXJlbnROb2RlID0gYm9keS5wYXJlbnROb2RlOwogICAgICAgIGlmKEV4dC5pc051bWJlcih3KSl7CiAgICAgICAgICAgIGlmKHRoaXMucmVzZXJ2ZVNjcm9sbE9mZnNldCB8fCAoKHBhcmVudE5vZGUub2Zmc2V0V2lkdGggLSBwYXJlbnROb2RlLmNsaWVudFdpZHRoKSA+IDEwKSl7CiAgICAgICAgICAgICAgICBib2R5LnN0eWxlLndpZHRoID0gc2Nyb2xsV2lkdGg7CiAgICAgICAgICAgICAgICBoZWFkZXIuc3R5bGUud2lkdGggPSBzY3JvbGxXaWR0aDsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBib2R5LnN0eWxlLndpZHRoID0gdyArICdweCc7CiAgICAgICAgICAgICAgICBoZWFkZXIuc3R5bGUud2lkdGggPSB3ICsgJ3B4JzsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBpZigocGFyZW50Tm9kZS5vZmZzZXRXaWR0aCAtIHBhcmVudE5vZGUuY2xpZW50V2lkdGgpID4gMTApewogICAgICAgICAgICAgICAgICAgICAgICBib2R5LnN0eWxlLndpZHRoID0gc2Nyb2xsV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlci5zdHlsZS53aWR0aCA9IHNjcm9sbFdpZHRoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZihFeHQuaXNOdW1iZXIoaCkpewogICAgICAgICAgICBwYXJlbnROb2RlLnN0eWxlLmhlaWdodCA9IE1hdGgubWF4KDAsIGggLSBoZWFkZXIucGFyZW50Tm9kZS5vZmZzZXRIZWlnaHQpICsgJ3B4JzsKICAgICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZUluZGV4ZXMgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5saXN0Lkxpc3RWaWV3LnN1cGVyY2xhc3MudXBkYXRlSW5kZXhlcy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMudmVyaWZ5SW50ZXJuYWxTaXplKCk7CiAgICB9LAoKICAgIGZpbmRIZWFkZXJJbmRleCA6IGZ1bmN0aW9uKGhlYWRlcil7CiAgICAgICAgaGVhZGVyID0gaGVhZGVyLmRvbSB8fCBoZWFkZXI7CiAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBoZWFkZXIucGFyZW50Tm9kZSwgCiAgICAgICAgICAgIGNoaWxkcmVuID0gcGFyZW50Tm9kZS5wYXJlbnROb2RlLmNoaWxkTm9kZXMsCiAgICAgICAgICAgIGkgPSAwLAogICAgICAgICAgICBjOwogICAgICAgIGZvcig7IGMgPSBjaGlsZHJlbltpXTsgaSsrKXsKICAgICAgICAgICAgaWYoYyA9PSBwYXJlbnROb2RlKXsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgIH0sCgogICAgc2V0SGRXaWR0aHMgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBlbHMgPSB0aGlzLmlubmVySGQuZG9tLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkaXYnKSwKICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgIGNvbHVtbnMgPSB0aGlzLmNvbHVtbnMsCiAgICAgICAgICAgIGxlbiA9IGNvbHVtbnMubGVuZ3RoOwogICAgICAgICAgICAKICAgICAgICBmb3IoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICBlbHNbaV0uc3R5bGUud2lkdGggPSAoY29sdW1uc1tpXS53aWR0aCoxMDApICsgJyUnOwogICAgICAgIH0KICAgIH0KfSk7CgpFeHQucmVnKCdsaXN0dmlldycsIEV4dC5saXN0Lkxpc3RWaWV3KTsKCgpFeHQuTGlzdFZpZXcgPSBFeHQubGlzdC5MaXN0VmlldzsKRXh0Lmxpc3QuQ29sdW1uID0gRXh0LmV4dGVuZChPYmplY3QsIHsKICAgIAogICAgaXNDb2x1bW46IHRydWUsCiAgICAKICAgICAgICAgICAgCiAgICBhbGlnbjogJ2xlZnQnLAogICAgICAgIAogICAgaGVhZGVyOiAnJywKICAgIAogICAgICAgIAogICAgd2lkdGg6IG51bGwsCgogICAgCiAgICBjbHM6ICcnLAogICAgCiAgICAKCiAgICAKICAgIAogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjKXsKICAgICAgICBpZighYy50cGwpewogICAgICAgICAgICBjLnRwbCA9IG5ldyBFeHQuWFRlbXBsYXRlKCd7JyArIGMuZGF0YUluZGV4ICsgJ30nKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZihFeHQuaXNTdHJpbmcoYy50cGwpKXsKICAgICAgICAgICAgYy50cGwgPSBuZXcgRXh0LlhUZW1wbGF0ZShjLnRwbCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjKTsKICAgIH0KfSk7CgpFeHQucmVnKCdsdmNvbHVtbicsIEV4dC5saXN0LkNvbHVtbik7CgoKRXh0Lmxpc3QuTnVtYmVyQ29sdW1uID0gRXh0LmV4dGVuZChFeHQubGlzdC5Db2x1bW4sIHsKICAgICAgICAKICAgIGZvcm1hdDogJzAsMDAwLjAwJywKICAgIAogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjKSB7CiAgICAgICAgYy50cGwgPSBjLnRwbCB8fCBuZXcgRXh0LlhUZW1wbGF0ZSgneycgKyBjLmRhdGFJbmRleCArICc6bnVtYmVyKCInICsgKGMuZm9ybWF0IHx8IHRoaXMuZm9ybWF0KSArICciKX0nKTsgICAgICAgCiAgICAgICAgRXh0Lmxpc3QuTnVtYmVyQ29sdW1uLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBjKTsKICAgIH0KfSk7CgpFeHQucmVnKCdsdm51bWJlcmNvbHVtbicsIEV4dC5saXN0Lk51bWJlckNvbHVtbik7CgoKRXh0Lmxpc3QuRGF0ZUNvbHVtbiA9IEV4dC5leHRlbmQoRXh0Lmxpc3QuQ29sdW1uLCB7CiAgICBmb3JtYXQ6ICdtL2QvWScsCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGMpIHsKICAgICAgICBjLnRwbCA9IGMudHBsIHx8IG5ldyBFeHQuWFRlbXBsYXRlKCd7JyArIGMuZGF0YUluZGV4ICsgJzpkYXRlKCInICsgKGMuZm9ybWF0IHx8IHRoaXMuZm9ybWF0KSArICciKX0nKTsgICAgICAKICAgICAgICBFeHQubGlzdC5EYXRlQ29sdW1uLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBjKTsKICAgIH0KfSk7CkV4dC5yZWcoJ2x2ZGF0ZWNvbHVtbicsIEV4dC5saXN0LkRhdGVDb2x1bW4pOwoKCkV4dC5saXN0LkJvb2xlYW5Db2x1bW4gPSBFeHQuZXh0ZW5kKEV4dC5saXN0LkNvbHVtbiwgewogICAgCiAgICB0cnVlVGV4dDogJ3RydWUnLAogICAgCiAgICBmYWxzZVRleHQ6ICdmYWxzZScsCiAgICAKICAgIHVuZGVmaW5lZFRleHQ6ICcmIzE2MDsnLAogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGMpIHsKICAgICAgICBjLnRwbCA9IGMudHBsIHx8IG5ldyBFeHQuWFRlbXBsYXRlKCd7JyArIGMuZGF0YUluZGV4ICsgJzp0aGlzLmZvcm1hdH0nKTsKICAgICAgICAKICAgICAgICB2YXIgdCA9IHRoaXMudHJ1ZVRleHQsIGYgPSB0aGlzLmZhbHNlVGV4dCwgdSA9IHRoaXMudW5kZWZpbmVkVGV4dDsKICAgICAgICBjLnRwbC5mb3JtYXQgPSBmdW5jdGlvbih2KXsKICAgICAgICAgICAgaWYodiA9PT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIHJldHVybiB1OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCF2IHx8IHYgPT09ICdmYWxzZScpewogICAgICAgICAgICAgICAgcmV0dXJuIGY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHQ7CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICBFeHQubGlzdC5EYXRlQ29sdW1uLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBjKTsKICAgIH0KfSk7CgpFeHQucmVnKCdsdmJvb2xlYW5jb2x1bW4nLCBFeHQubGlzdC5Cb29sZWFuQ29sdW1uKTsKRXh0Lmxpc3QuQ29sdW1uUmVzaXplciA9IEV4dC5leHRlbmQoRXh0LnV0aWwuT2JzZXJ2YWJsZSwgewogICAgCiAgICBtaW5QY3Q6IC4wNSwKCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKICAgICAgICBFeHQubGlzdC5Db2x1bW5SZXNpemVyLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsKICAgIH0sCiAgICBpbml0IDogZnVuY3Rpb24obGlzdFZpZXcpewogICAgICAgIHRoaXMudmlldyA9IGxpc3RWaWV3OwogICAgICAgIGxpc3RWaWV3Lm9uKCdyZW5kZXInLCB0aGlzLmluaXRFdmVudHMsIHRoaXMpOwogICAgfSwKCiAgICBpbml0RXZlbnRzIDogZnVuY3Rpb24odmlldyl7CiAgICAgICAgdmlldy5tb24odmlldy5pbm5lckhkLCAnbW91c2Vtb3ZlJywgdGhpcy5oYW5kbGVIZE1vdmUsIHRoaXMpOwogICAgICAgIHRoaXMudHJhY2tlciA9IG5ldyBFeHQuZGQuRHJhZ1RyYWNrZXIoewogICAgICAgICAgICBvbkJlZm9yZVN0YXJ0OiB0aGlzLm9uQmVmb3JlU3RhcnQuY3JlYXRlRGVsZWdhdGUodGhpcyksCiAgICAgICAgICAgIG9uU3RhcnQ6IHRoaXMub25TdGFydC5jcmVhdGVEZWxlZ2F0ZSh0aGlzKSwKICAgICAgICAgICAgb25EcmFnOiB0aGlzLm9uRHJhZy5jcmVhdGVEZWxlZ2F0ZSh0aGlzKSwKICAgICAgICAgICAgb25FbmQ6IHRoaXMub25FbmQuY3JlYXRlRGVsZWdhdGUodGhpcyksCiAgICAgICAgICAgIHRvbGVyYW5jZTogMywKICAgICAgICAgICAgYXV0b1N0YXJ0OiAzMDAKICAgICAgICB9KTsKICAgICAgICB0aGlzLnRyYWNrZXIuaW5pdEVsKHZpZXcuaW5uZXJIZCk7CiAgICAgICAgdmlldy5vbignYmVmb3JlZGVzdHJveScsIHRoaXMudHJhY2tlci5kZXN0cm95LCB0aGlzLnRyYWNrZXIpOwogICAgfSwKCiAgICBoYW5kbGVIZE1vdmUgOiBmdW5jdGlvbihlLCB0KXsKICAgICAgICB2YXIgaGFuZGxlV2lkdGggPSA1LAogICAgICAgICAgICB4ID0gZS5nZXRQYWdlWCgpLAogICAgICAgICAgICBoZWFkZXIgPSBlLmdldFRhcmdldCgnZW0nLCAzLCB0cnVlKTsKICAgICAgICBpZihoZWFkZXIpewogICAgICAgICAgICB2YXIgcmVnaW9uID0gaGVhZGVyLmdldFJlZ2lvbigpLAogICAgICAgICAgICAgICAgc3R5bGUgPSBoZWFkZXIuZG9tLnN0eWxlLAogICAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGhlYWRlci5kb20ucGFyZW50Tm9kZTsKCiAgICAgICAgICAgIGlmKHggLSByZWdpb24ubGVmdCA8PSBoYW5kbGVXaWR0aCAmJiBwYXJlbnROb2RlICE9IHBhcmVudE5vZGUucGFyZW50Tm9kZS5maXJzdENoaWxkKXsKICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlSGQgPSBFeHQuZ2V0KHBhcmVudE5vZGUucHJldmlvdXNTaWJsaW5nLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgc3R5bGUuY3Vyc29yID0gRXh0LmlzV2ViS2l0ID8gJ2UtcmVzaXplJyA6ICdjb2wtcmVzaXplJzsKICAgICAgICAgICAgfSBlbHNlIGlmKHJlZ2lvbi5yaWdodCAtIHggPD0gaGFuZGxlV2lkdGggJiYgcGFyZW50Tm9kZSAhPSBwYXJlbnROb2RlLnBhcmVudE5vZGUubGFzdENoaWxkLnByZXZpb3VzU2libGluZyl7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUhkID0gaGVhZGVyOwogICAgICAgICAgICAgICAgc3R5bGUuY3Vyc29yID0gRXh0LmlzV2ViS2l0ID8gJ3ctcmVzaXplJyA6ICdjb2wtcmVzaXplJzsKICAgICAgICAgICAgfSBlbHNlewogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuYWN0aXZlSGQ7CiAgICAgICAgICAgICAgICBzdHlsZS5jdXJzb3IgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgb25CZWZvcmVTdGFydCA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMuZHJhZ0hkID0gdGhpcy5hY3RpdmVIZDsKICAgICAgICByZXR1cm4gISF0aGlzLmRyYWdIZDsKICAgIH0sCgogICAgb25TdGFydDogZnVuY3Rpb24oZSl7CiAgICAgICAgCiAgICAgICAgdmFyIG1lID0gdGhpcywKICAgICAgICAgICAgdmlldyA9IG1lLnZpZXcsCiAgICAgICAgICAgIGRyYWdIZWFkZXIgPSBtZS5kcmFnSGQsCiAgICAgICAgICAgIHggPSBtZS50cmFja2VyLmdldFhZKClbMF07ICAgICAgICAgICAgCiAgICAgICAgCiAgICAgICAgbWUucHJveHkgPSB2aWV3LmVsLmNyZWF0ZUNoaWxkKHtjbHM6J3gtbGlzdC1yZXNpemVyJ30pOwogICAgICAgIG1lLmRyYWdYID0gZHJhZ0hlYWRlci5nZXRYKCk7CiAgICAgICAgbWUuaGVhZGVySW5kZXggPSB2aWV3LmZpbmRIZWFkZXJJbmRleChkcmFnSGVhZGVyKTsKICAgICAgICAKICAgICAgICBtZS5oZWFkZXJzRGlzYWJsZWQgPSB2aWV3LmRpc2FibGVIZWFkZXJzOwogICAgICAgIHZpZXcuZGlzYWJsZUhlYWRlcnMgPSB0cnVlOwogICAgICAgIAogICAgICAgIG1lLnByb3h5LnNldEhlaWdodCh2aWV3LmVsLmdldEhlaWdodCgpKTsKICAgICAgICBtZS5wcm94eS5zZXRYKG1lLmRyYWdYKTsKICAgICAgICBtZS5wcm94eS5zZXRXaWR0aCh4IC0gbWUuZHJhZ1gpOwogICAgICAgIAogICAgICAgIHRoaXMuc2V0Qm91bmRhcmllcygpOwogICAgICAgIAogICAgfSwKICAgIAogICAgCiAgICBzZXRCb3VuZGFyaWVzOiBmdW5jdGlvbihyZWxhdGl2ZVgpewogICAgICAgIHZhciB2aWV3ID0gdGhpcy52aWV3LAogICAgICAgICAgICBoZWFkZXJJbmRleCA9IHRoaXMuaGVhZGVySW5kZXgsCiAgICAgICAgICAgIHdpZHRoID0gdmlldy5pbm5lckhkLmdldFdpZHRoKCksCiAgICAgICAgICAgIHJlbGF0aXZlWCA9IHZpZXcuaW5uZXJIZC5nZXRYKCksCiAgICAgICAgICAgIG1pbldpZHRoID0gTWF0aC5jZWlsKHdpZHRoICogdGhpcy5taW5QY3QpLAogICAgICAgICAgICBtYXhXaWR0aCA9IHdpZHRoIC0gbWluV2lkdGgsCiAgICAgICAgICAgIG51bUNvbHVtbnMgPSB2aWV3LmNvbHVtbnMubGVuZ3RoLAogICAgICAgICAgICBoZWFkZXJzID0gdmlldy5pbm5lckhkLnNlbGVjdCgnZW0nLCB0cnVlKSwKICAgICAgICAgICAgbWluWCA9IG1pbldpZHRoICsgcmVsYXRpdmVYLAogICAgICAgICAgICBtYXhYID0gbWF4V2lkdGggKyByZWxhdGl2ZVgsCiAgICAgICAgICAgIGhlYWRlcjsKICAgICAgICAgIAogICAgICAgIGlmIChudW1Db2x1bW5zID09IDIpIHsKICAgICAgICAgICAgdGhpcy5taW5YID0gbWluWDsKICAgICAgICAgICAgdGhpcy5tYXhYID0gbWF4WDsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgaGVhZGVyID0gaGVhZGVycy5pdGVtKGhlYWRlckluZGV4ICsgMik7CiAgICAgICAgICAgIHRoaXMubWluWCA9IGhlYWRlcnMuaXRlbShoZWFkZXJJbmRleCkuZ2V0WCgpICsgbWluV2lkdGg7CiAgICAgICAgICAgIHRoaXMubWF4WCA9IGhlYWRlciA/IGhlYWRlci5nZXRYKCkgLSBtaW5XaWR0aCA6IG1heFg7CiAgICAgICAgICAgIGlmIChoZWFkZXJJbmRleCA9PSAwKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMubWluWCA9IG1pblg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaGVhZGVySW5kZXggPT0gbnVtQ29sdW1ucyAtIDIpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5tYXhYID0gbWF4WDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgb25EcmFnOiBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgbWUgPSB0aGlzLAogICAgICAgICAgICBjdXJzb3JYID0gbWUudHJhY2tlci5nZXRYWSgpWzBdLmNvbnN0cmFpbihtZS5taW5YLCBtZS5tYXhYKTsKICAgICAgICAgICAgCiAgICAgICAgbWUucHJveHkuc2V0V2lkdGgoY3Vyc29yWCAtIHRoaXMuZHJhZ1gpOwogICAgfSwKCiAgICBvbkVuZDogZnVuY3Rpb24oZSl7CiAgICAgICAgCiAgICAgICAgdmFyIG5ld1dpZHRoID0gdGhpcy5wcm94eS5nZXRXaWR0aCgpLAogICAgICAgICAgICBpbmRleCA9IHRoaXMuaGVhZGVySW5kZXgsCiAgICAgICAgICAgIHZpZXcgPSB0aGlzLnZpZXcsCiAgICAgICAgICAgIGNvbHVtbnMgPSB2aWV3LmNvbHVtbnMsCiAgICAgICAgICAgIHdpZHRoID0gdmlldy5pbm5lckhkLmdldFdpZHRoKCksCiAgICAgICAgICAgIG5ld1BlcmNlbnQgPSBNYXRoLmNlaWwobmV3V2lkdGggKiB2aWV3Lm1heENvbHVtbldpZHRoIC8gd2lkdGgpIC8gMTAwLAogICAgICAgICAgICBkaXNhYmxlZCA9IHRoaXMuaGVhZGVyc0Rpc2FibGVkLAogICAgICAgICAgICBoZWFkZXJDb2wgPSBjb2x1bW5zW2luZGV4XSwKICAgICAgICAgICAgb3RoZXJDb2wgPSBjb2x1bW5zW2luZGV4ICsgMV0sCiAgICAgICAgICAgIHRvdGFsUGVyY2VudCA9IGhlYWRlckNvbC53aWR0aCArIG90aGVyQ29sLndpZHRoOwoKICAgICAgICB0aGlzLnByb3h5LnJlbW92ZSgpOwoKICAgICAgICBoZWFkZXJDb2wud2lkdGggPSBuZXdQZXJjZW50OwogICAgICAgIG90aGVyQ29sLndpZHRoID0gdG90YWxQZXJjZW50IC0gbmV3UGVyY2VudDsKICAgICAgCiAgICAgICAgZGVsZXRlIHRoaXMuZHJhZ0hkOwogICAgICAgIHZpZXcuc2V0SGRXaWR0aHMoKTsKICAgICAgICB2aWV3LnJlZnJlc2goKTsKICAgICAgICAKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZpZXcuZGlzYWJsZUhlYWRlcnMgPSBkaXNhYmxlZDsKICAgICAgICB9LCAxMDApOwogICAgfQp9KTsKCgpFeHQuTGlzdFZpZXcuQ29sdW1uUmVzaXplciA9IEV4dC5saXN0LkNvbHVtblJlc2l6ZXI7CkV4dC5saXN0LlNvcnRlciA9IEV4dC5leHRlbmQoRXh0LnV0aWwuT2JzZXJ2YWJsZSwgewogICAgCiAgICBzb3J0Q2xhc3NlcyA6IFsic29ydC1hc2MiLCAic29ydC1kZXNjIl0sCgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNvbmZpZyl7CiAgICAgICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CiAgICAgICAgRXh0Lmxpc3QuU29ydGVyLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgaW5pdCA6IGZ1bmN0aW9uKGxpc3RWaWV3KXsKICAgICAgICB0aGlzLnZpZXcgPSBsaXN0VmlldzsKICAgICAgICBsaXN0Vmlldy5vbigncmVuZGVyJywgdGhpcy5pbml0RXZlbnRzLCB0aGlzKTsKICAgIH0sCgogICAgaW5pdEV2ZW50cyA6IGZ1bmN0aW9uKHZpZXcpewogICAgICAgIHZpZXcubW9uKHZpZXcuaW5uZXJIZCwgJ2NsaWNrJywgdGhpcy5vbkhkQ2xpY2ssIHRoaXMpOwogICAgICAgIHZpZXcuaW5uZXJIZC5zZXRTdHlsZSgnY3Vyc29yJywgJ3BvaW50ZXInKTsKICAgICAgICB2aWV3Lm1vbih2aWV3LnN0b3JlLCAnZGF0YWNoYW5nZWQnLCB0aGlzLnVwZGF0ZVNvcnRTdGF0ZSwgdGhpcyk7CiAgICAgICAgdGhpcy51cGRhdGVTb3J0U3RhdGUuZGVmZXIoMTAsIHRoaXMsIFt2aWV3LnN0b3JlXSk7CiAgICB9LAoKICAgIHVwZGF0ZVNvcnRTdGF0ZSA6IGZ1bmN0aW9uKHN0b3JlKXsKICAgICAgICB2YXIgc3RhdGUgPSBzdG9yZS5nZXRTb3J0U3RhdGUoKTsKICAgICAgICBpZighc3RhdGUpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuc29ydFN0YXRlID0gc3RhdGU7CiAgICAgICAgdmFyIGNzID0gdGhpcy52aWV3LmNvbHVtbnMsIHNvcnRDb2x1bW4gPSAtMTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBjcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGlmKGNzW2ldLmRhdGFJbmRleCA9PSBzdGF0ZS5maWVsZCl7CiAgICAgICAgICAgICAgICBzb3J0Q29sdW1uID0gaTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmKHNvcnRDb2x1bW4gIT0gLTEpewogICAgICAgICAgICB2YXIgc29ydERpciA9IHN0YXRlLmRpcmVjdGlvbjsKICAgICAgICAgICAgdGhpcy51cGRhdGVTb3J0SWNvbihzb3J0Q29sdW1uLCBzb3J0RGlyKTsKICAgICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZVNvcnRJY29uIDogZnVuY3Rpb24oY29sLCBkaXIpewogICAgICAgIHZhciBzYyA9IHRoaXMuc29ydENsYXNzZXM7CiAgICAgICAgdmFyIGhkcyA9IHRoaXMudmlldy5pbm5lckhkLnNlbGVjdCgnZW0nKS5yZW1vdmVDbGFzcyhzYyk7CiAgICAgICAgaGRzLml0ZW0oY29sKS5hZGRDbGFzcyhzY1tkaXIgPT0gIkRFU0MiID8gMSA6IDBdKTsKICAgIH0sCgogICAgb25IZENsaWNrIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIGhkID0gZS5nZXRUYXJnZXQoJ2VtJywgMyk7CiAgICAgICAgaWYoaGQgJiYgIXRoaXMudmlldy5kaXNhYmxlSGVhZGVycyl7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMudmlldy5maW5kSGVhZGVySW5kZXgoaGQpOwogICAgICAgICAgICB0aGlzLnZpZXcuc3RvcmUuc29ydCh0aGlzLnZpZXcuY29sdW1uc1tpbmRleF0uZGF0YUluZGV4KTsKICAgICAgICB9CiAgICB9Cn0pOwoKCkV4dC5MaXN0Vmlldy5Tb3J0ZXIgPSBFeHQubGlzdC5Tb3J0ZXI7CkV4dC5UYWJQYW5lbCA9IEV4dC5leHRlbmQoRXh0LlBhbmVsLCAgewogICAgCiAgICAKICAgIAogICAgZGVmZXJyZWRSZW5kZXIgOiB0cnVlLAogICAgCiAgICB0YWJXaWR0aCA6IDEyMCwKICAgIAogICAgbWluVGFiV2lkdGggOiAzMCwKICAgIAogICAgcmVzaXplVGFicyA6IGZhbHNlLAogICAgCiAgICBlbmFibGVUYWJTY3JvbGwgOiBmYWxzZSwKICAgIAogICAgc2Nyb2xsSW5jcmVtZW50IDogMCwKICAgIAogICAgc2Nyb2xsUmVwZWF0SW50ZXJ2YWwgOiA0MDAsCiAgICAKICAgIHNjcm9sbER1cmF0aW9uIDogMC4zNSwKICAgIAogICAgYW5pbVNjcm9sbCA6IHRydWUsCiAgICAKICAgIHRhYlBvc2l0aW9uIDogJ3RvcCcsCiAgICAKICAgIGJhc2VDbHMgOiAneC10YWItcGFuZWwnLAogICAgCiAgICBhdXRvVGFicyA6IGZhbHNlLAogICAgCiAgICBhdXRvVGFiU2VsZWN0b3IgOiAnZGl2LngtdGFiJywKICAgIAogICAgYWN0aXZlVGFiIDogdW5kZWZpbmVkLAogICAgCiAgICB0YWJNYXJnaW4gOiAyLAogICAgCiAgICBwbGFpbiA6IGZhbHNlLAogICAgCiAgICB3aGVlbEluY3JlbWVudCA6IDIwLAoKICAgIAogICAgaWREZWxpbWl0ZXIgOiAnX18nLAoKICAgIAogICAgaXRlbUNscyA6ICd4LXRhYi1pdGVtJywKCiAgICAKICAgIGVsZW1lbnRzIDogJ2JvZHknLAogICAgaGVhZGVyQXNUZXh0IDogZmFsc2UsCiAgICBmcmFtZSA6IGZhbHNlLAogICAgaGlkZUJvcmRlcnMgOnRydWUsCgogICAgCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmZyYW1lID0gZmFsc2U7CiAgICAgICAgRXh0LlRhYlBhbmVsLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZXRhYmNoYW5nZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAndGFiY2hhbmdlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjb250ZXh0bWVudScKICAgICAgICApOwogICAgICAgIAogICAgICAgIHRoaXMuc2V0TGF5b3V0KG5ldyBFeHQubGF5b3V0LkNhcmRMYXlvdXQoRXh0LmFwcGx5KHsKICAgICAgICAgICAgbGF5b3V0T25DYXJkQ2hhbmdlOiB0aGlzLmxheW91dE9uVGFiQ2hhbmdlLAogICAgICAgICAgICBkZWZlcnJlZFJlbmRlcjogdGhpcy5kZWZlcnJlZFJlbmRlcgogICAgICAgIH0sIHRoaXMubGF5b3V0Q29uZmlnKSkpOwoKICAgICAgICBpZih0aGlzLnRhYlBvc2l0aW9uID09ICd0b3AnKXsKICAgICAgICAgICAgdGhpcy5lbGVtZW50cyArPSAnLGhlYWRlcic7CiAgICAgICAgICAgIHRoaXMuc3RyaXBUYXJnZXQgPSAnaGVhZGVyJzsKICAgICAgICB9ZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudHMgKz0gJyxmb290ZXInOwogICAgICAgICAgICB0aGlzLnN0cmlwVGFyZ2V0ID0gJ2Zvb3Rlcic7CiAgICAgICAgfQogICAgICAgIGlmKCF0aGlzLnN0YWNrKXsKICAgICAgICAgICAgdGhpcy5zdGFjayA9IEV4dC5UYWJQYW5lbC5BY2Nlc3NTdGFjaygpOwogICAgICAgIH0KICAgICAgICB0aGlzLmluaXRJdGVtcygpOwogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKXsKICAgICAgICBFeHQuVGFiUGFuZWwuc3VwZXJjbGFzcy5vblJlbmRlci5jYWxsKHRoaXMsIGN0LCBwb3NpdGlvbik7CgogICAgICAgIGlmKHRoaXMucGxhaW4pewogICAgICAgICAgICB2YXIgcG9zID0gdGhpcy50YWJQb3NpdGlvbiA9PSAndG9wJyA/ICdoZWFkZXInIDogJ2Zvb3Rlcic7CiAgICAgICAgICAgIHRoaXNbcG9zXS5hZGRDbGFzcygneC10YWItcGFuZWwtJytwb3MrJy1wbGFpbicpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHN0ID0gdGhpc1t0aGlzLnN0cmlwVGFyZ2V0XTsKCiAgICAgICAgdGhpcy5zdHJpcFdyYXAgPSBzdC5jcmVhdGVDaGlsZCh7Y2xzOid4LXRhYi1zdHJpcC13cmFwJywgY246ewogICAgICAgICAgICB0YWc6J3VsJywgY2xzOid4LXRhYi1zdHJpcCB4LXRhYi1zdHJpcC0nK3RoaXMudGFiUG9zaXRpb259fSk7CgogICAgICAgIHZhciBiZWZvcmVFbCA9ICh0aGlzLnRhYlBvc2l0aW9uPT0nYm90dG9tJyA/IHRoaXMuc3RyaXBXcmFwIDogbnVsbCk7CiAgICAgICAgc3QuY3JlYXRlQ2hpbGQoe2NsczoneC10YWItc3RyaXAtc3BhY2VyJ30sIGJlZm9yZUVsKTsKICAgICAgICB0aGlzLnN0cmlwID0gbmV3IEV4dC5FbGVtZW50KHRoaXMuc3RyaXBXcmFwLmRvbS5maXJzdENoaWxkKTsKCiAgICAgICAgCiAgICAgICAgdGhpcy5lZGdlID0gdGhpcy5zdHJpcC5jcmVhdGVDaGlsZCh7dGFnOidsaScsIGNsczoneC10YWItZWRnZScsIGNuOiBbe3RhZzogJ3NwYW4nLCBjbHM6ICd4LXRhYi1zdHJpcC10ZXh0JywgY246ICcmIzE2MDsnfV19KTsKICAgICAgICB0aGlzLnN0cmlwLmNyZWF0ZUNoaWxkKHtjbHM6J3gtY2xlYXInfSk7CgogICAgICAgIHRoaXMuYm9keS5hZGRDbGFzcygneC10YWItcGFuZWwtYm9keS0nK3RoaXMudGFiUG9zaXRpb24pOwoKICAgICAgICAKICAgICAgICBpZighdGhpcy5pdGVtVHBsKXsKICAgICAgICAgICAgdmFyIHR0ID0gbmV3IEV4dC5UZW1wbGF0ZSgKICAgICAgICAgICAgICAgICAnPGxpIGNsYXNzPSJ7Y2xzfSIgaWQ9IntpZH0iPjxhIGNsYXNzPSJ4LXRhYi1zdHJpcC1jbG9zZSI+PC9hPicsCiAgICAgICAgICAgICAgICAgJzxhIGNsYXNzPSJ4LXRhYi1yaWdodCIgaHJlZj0iIyI+PGVtIGNsYXNzPSJ4LXRhYi1sZWZ0Ij4nLAogICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz0ieC10YWItc3RyaXAtaW5uZXIiPjxzcGFuIGNsYXNzPSJ4LXRhYi1zdHJpcC10ZXh0IHtpY29uQ2xzfSI+e3RleHR9PC9zcGFuPjwvc3Bhbj4nLAogICAgICAgICAgICAgICAgICc8L2VtPjwvYT48L2xpPicKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdHQuZGlzYWJsZUZvcm1hdHMgPSB0cnVlOwogICAgICAgICAgICB0dC5jb21waWxlKCk7CiAgICAgICAgICAgIEV4dC5UYWJQYW5lbC5wcm90b3R5cGUuaXRlbVRwbCA9IHR0OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5pdGVtcy5lYWNoKHRoaXMuaW5pdFRhYiwgdGhpcyk7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJSZW5kZXIgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5UYWJQYW5lbC5zdXBlcmNsYXNzLmFmdGVyUmVuZGVyLmNhbGwodGhpcyk7CiAgICAgICAgaWYodGhpcy5hdXRvVGFicyl7CiAgICAgICAgICAgIHRoaXMucmVhZFRhYnMoZmFsc2UpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmFjdGl2ZVRhYiAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBFeHQuaXNPYmplY3QodGhpcy5hY3RpdmVUYWIpID8gdGhpcy5hY3RpdmVUYWIgOiB0aGlzLml0ZW1zLmdldCh0aGlzLmFjdGl2ZVRhYik7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFjdGl2ZVRhYjsKICAgICAgICAgICAgdGhpcy5zZXRBY3RpdmVUYWIoaXRlbSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGluaXRFdmVudHMgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5UYWJQYW5lbC5zdXBlcmNsYXNzLmluaXRFdmVudHMuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm1vbih0aGlzLnN0cmlwLCB7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBtb3VzZWRvd246IHRoaXMub25TdHJpcE1vdXNlRG93biwKICAgICAgICAgICAgY29udGV4dG1lbnU6IHRoaXMub25TdHJpcENvbnRleHRNZW51CiAgICAgICAgfSk7CiAgICAgICAgaWYodGhpcy5lbmFibGVUYWJTY3JvbGwpewogICAgICAgICAgICB0aGlzLm1vbih0aGlzLnN0cmlwLCAnbW91c2V3aGVlbCcsIHRoaXMub25XaGVlbCwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGZpbmRUYXJnZXRzIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIGl0ZW0gPSBudWxsLAogICAgICAgICAgICBpdGVtRWwgPSBlLmdldFRhcmdldCgnbGk6bm90KC54LXRhYi1lZGdlKScsIHRoaXMuc3RyaXApOwoKICAgICAgICBpZihpdGVtRWwpewogICAgICAgICAgICBpdGVtID0gdGhpcy5nZXRDb21wb25lbnQoaXRlbUVsLmlkLnNwbGl0KHRoaXMuaWREZWxpbWl0ZXIpWzFdKTsKICAgICAgICAgICAgaWYoaXRlbS5kaXNhYmxlZCl7CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgIGNsb3NlIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBpdGVtIDogbnVsbCwKICAgICAgICAgICAgICAgICAgICBlbCA6IG51bGwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgY2xvc2UgOiBlLmdldFRhcmdldCgnLngtdGFiLXN0cmlwLWNsb3NlJywgdGhpcy5zdHJpcCksCiAgICAgICAgICAgIGl0ZW0gOiBpdGVtLAogICAgICAgICAgICBlbCA6IGl0ZW1FbAogICAgICAgIH07CiAgICB9LAoKICAgIAogICAgb25TdHJpcE1vdXNlRG93biA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKGUuYnV0dG9uICE9PSAwKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdmFyIHQgPSB0aGlzLmZpbmRUYXJnZXRzKGUpOwogICAgICAgIGlmKHQuY2xvc2UpewogICAgICAgICAgICBpZiAodC5pdGVtLmZpcmVFdmVudCgnYmVmb3JlY2xvc2UnLCB0Lml0ZW0pICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgdC5pdGVtLmZpcmVFdmVudCgnY2xvc2UnLCB0Lml0ZW0pOwogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUodC5pdGVtKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKHQuaXRlbSAmJiB0Lml0ZW0gIT0gdGhpcy5hY3RpdmVUYWIpewogICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVRhYih0Lml0ZW0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblN0cmlwQ29udGV4dE1lbnUgOiBmdW5jdGlvbihlKXsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdmFyIHQgPSB0aGlzLmZpbmRUYXJnZXRzKGUpOwogICAgICAgIGlmKHQuaXRlbSl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjb250ZXh0bWVudScsIHRoaXMsIHQuaXRlbSwgZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHJlYWRUYWJzIDogZnVuY3Rpb24ocmVtb3ZlRXhpc3RpbmcpewogICAgICAgIGlmKHJlbW92ZUV4aXN0aW5nID09PSB0cnVlKXsKICAgICAgICAgICAgdGhpcy5pdGVtcy5lYWNoKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoaXRlbSk7CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0KICAgICAgICB2YXIgdGFicyA9IHRoaXMuZWwucXVlcnkodGhpcy5hdXRvVGFiU2VsZWN0b3IpOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IHRhYnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICB2YXIgdGFiID0gdGFic1tpXSwKICAgICAgICAgICAgICAgIHRpdGxlID0gdGFiLmdldEF0dHJpYnV0ZSgndGl0bGUnKTsKICAgICAgICAgICAgdGFiLnJlbW92ZUF0dHJpYnV0ZSgndGl0bGUnKTsKICAgICAgICAgICAgdGhpcy5hZGQoewogICAgICAgICAgICAgICAgdGl0bGU6IHRpdGxlLAogICAgICAgICAgICAgICAgY29udGVudEVsOiB0YWIKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGluaXRUYWIgOiBmdW5jdGlvbihpdGVtLCBpbmRleCl7CiAgICAgICAgdmFyIGJlZm9yZSA9IHRoaXMuc3RyaXAuZG9tLmNoaWxkTm9kZXNbaW5kZXhdLAogICAgICAgICAgICBwID0gdGhpcy5nZXRUZW1wbGF0ZUFyZ3MoaXRlbSksCiAgICAgICAgICAgIGVsID0gYmVmb3JlID8KICAgICAgICAgICAgICAgICB0aGlzLml0ZW1UcGwuaW5zZXJ0QmVmb3JlKGJlZm9yZSwgcCkgOgogICAgICAgICAgICAgICAgIHRoaXMuaXRlbVRwbC5hcHBlbmQodGhpcy5zdHJpcCwgcCksCiAgICAgICAgICAgIGNscyA9ICd4LXRhYi1zdHJpcC1vdmVyJywKICAgICAgICAgICAgdGFiRWwgPSBFeHQuZ2V0KGVsKTsKCiAgICAgICAgdGFiRWwuaG92ZXIoZnVuY3Rpb24oKXsKICAgICAgICAgICAgaWYoIWl0ZW0uZGlzYWJsZWQpewogICAgICAgICAgICAgICAgdGFiRWwuYWRkQ2xhc3MoY2xzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRhYkVsLnJlbW92ZUNsYXNzKGNscyk7CiAgICAgICAgfSk7CgogICAgICAgIGlmKGl0ZW0udGFiVGlwKXsKICAgICAgICAgICAgdGFiRWwuY2hpbGQoJ3NwYW4ueC10YWItc3RyaXAtdGV4dCcsIHRydWUpLnF0aXAgPSBpdGVtLnRhYlRpcDsKICAgICAgICB9CiAgICAgICAgaXRlbS50YWJFbCA9IGVsOwoKICAgICAgICAKICAgICAgICB0YWJFbC5zZWxlY3QoJ2EnKS5vbignY2xpY2snLCBmdW5jdGlvbihlKXsKICAgICAgICAgICAgaWYoIWUuZ2V0UGFnZVgoKSl7CiAgICAgICAgICAgICAgICB0aGlzLm9uU3RyaXBNb3VzZURvd24oZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB0aGlzLCB7cHJldmVudERlZmF1bHQ6IHRydWV9KTsKCiAgICAgICAgaXRlbS5vbih7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBkaXNhYmxlOiB0aGlzLm9uSXRlbURpc2FibGVkLAogICAgICAgICAgICBlbmFibGU6IHRoaXMub25JdGVtRW5hYmxlZCwKICAgICAgICAgICAgdGl0bGVjaGFuZ2U6IHRoaXMub25JdGVtVGl0bGVDaGFuZ2VkLAogICAgICAgICAgICBpY29uY2hhbmdlOiB0aGlzLm9uSXRlbUljb25DaGFuZ2VkLAogICAgICAgICAgICBiZWZvcmVzaG93OiB0aGlzLm9uQmVmb3JlU2hvd0l0ZW0KICAgICAgICB9KTsKICAgIH0sCgoKCiAgICAKICAgIGdldFRlbXBsYXRlQXJncyA6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICB2YXIgY2xzID0gaXRlbS5jbG9zYWJsZSA/ICd4LXRhYi1zdHJpcC1jbG9zYWJsZScgOiAnJzsKICAgICAgICBpZihpdGVtLmRpc2FibGVkKXsKICAgICAgICAgICAgY2xzICs9ICcgeC1pdGVtLWRpc2FibGVkJzsKICAgICAgICB9CiAgICAgICAgaWYoaXRlbS5pY29uQ2xzKXsKICAgICAgICAgICAgY2xzICs9ICcgeC10YWItd2l0aC1pY29uJzsKICAgICAgICB9CiAgICAgICAgaWYoaXRlbS50YWJDbHMpewogICAgICAgICAgICBjbHMgKz0gJyAnICsgaXRlbS50YWJDbHM7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBpZDogdGhpcy5pZCArIHRoaXMuaWREZWxpbWl0ZXIgKyBpdGVtLmdldEl0ZW1JZCgpLAogICAgICAgICAgICB0ZXh0OiBpdGVtLnRpdGxlLAogICAgICAgICAgICBjbHM6IGNscywKICAgICAgICAgICAgaWNvbkNsczogaXRlbS5pY29uQ2xzIHx8ICcnCiAgICAgICAgfTsKICAgIH0sCgogICAgCiAgICBvbkFkZCA6IGZ1bmN0aW9uKGMpewogICAgICAgIEV4dC5UYWJQYW5lbC5zdXBlcmNsYXNzLm9uQWRkLmNhbGwodGhpcywgYyk7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHZhciBpdGVtcyA9IHRoaXMuaXRlbXM7CiAgICAgICAgICAgIHRoaXMuaW5pdFRhYihjLCBpdGVtcy5pbmRleE9mKGMpKTsKICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZVVwZGF0ZXMoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25CZWZvcmVBZGQgOiBmdW5jdGlvbihpdGVtKXsKICAgICAgICB2YXIgZXhpc3RpbmcgPSBpdGVtLmV2ZW50cyA/ICh0aGlzLml0ZW1zLmNvbnRhaW5zS2V5KGl0ZW0uZ2V0SXRlbUlkKCkpID8gaXRlbSA6IG51bGwpIDogdGhpcy5pdGVtcy5nZXQoaXRlbSk7CiAgICAgICAgaWYoZXhpc3RpbmcpewogICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVRhYihpdGVtKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBFeHQuVGFiUGFuZWwuc3VwZXJjbGFzcy5vbkJlZm9yZUFkZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHZhciBlcyA9IGl0ZW0uZWxlbWVudHM7CiAgICAgICAgaXRlbS5lbGVtZW50cyA9IGVzID8gZXMucmVwbGFjZSgnLGhlYWRlcicsICcnKSA6IGVzOwogICAgICAgIGl0ZW0uYm9yZGVyID0gKGl0ZW0uYm9yZGVyID09PSB0cnVlKTsKICAgIH0sCgogICAgCiAgICBvblJlbW92ZSA6IGZ1bmN0aW9uKGMpewogICAgICAgIHZhciB0ZSA9IEV4dC5nZXQoYy50YWJFbCk7CiAgICAgICAgCiAgICAgICAgaWYodGUpewogICAgICAgICAgICB0ZS5zZWxlY3QoJ2EnKS5yZW1vdmVBbGxMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgRXh0LmRlc3Ryb3kodGUpOwogICAgICAgIH0KICAgICAgICBFeHQuVGFiUGFuZWwuc3VwZXJjbGFzcy5vblJlbW92ZS5jYWxsKHRoaXMsIGMpOwogICAgICAgIHRoaXMuc3RhY2sucmVtb3ZlKGMpOwogICAgICAgIGRlbGV0ZSBjLnRhYkVsOwogICAgICAgIGMudW4oJ2Rpc2FibGUnLCB0aGlzLm9uSXRlbURpc2FibGVkLCB0aGlzKTsKICAgICAgICBjLnVuKCdlbmFibGUnLCB0aGlzLm9uSXRlbUVuYWJsZWQsIHRoaXMpOwogICAgICAgIGMudW4oJ3RpdGxlY2hhbmdlJywgdGhpcy5vbkl0ZW1UaXRsZUNoYW5nZWQsIHRoaXMpOwogICAgICAgIGMudW4oJ2ljb25jaGFuZ2UnLCB0aGlzLm9uSXRlbUljb25DaGFuZ2VkLCB0aGlzKTsKICAgICAgICBjLnVuKCdiZWZvcmVzaG93JywgdGhpcy5vbkJlZm9yZVNob3dJdGVtLCB0aGlzKTsKICAgICAgICBpZihjID09IHRoaXMuYWN0aXZlVGFiKXsKICAgICAgICAgICAgdmFyIG5leHQgPSB0aGlzLnN0YWNrLm5leHQoKTsKICAgICAgICAgICAgaWYobmV4dCl7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVRhYihuZXh0KTsKICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5pdGVtcy5nZXRDb3VudCgpID4gMCl7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVRhYigwKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVRhYihudWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZighdGhpcy5kZXN0cm95aW5nKXsKICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZVVwZGF0ZXMoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25CZWZvcmVTaG93SXRlbSA6IGZ1bmN0aW9uKGl0ZW0pewogICAgICAgIGlmKGl0ZW0gIT0gdGhpcy5hY3RpdmVUYWIpewogICAgICAgICAgICB0aGlzLnNldEFjdGl2ZVRhYihpdGVtKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkl0ZW1EaXNhYmxlZCA6IGZ1bmN0aW9uKGl0ZW0pewogICAgICAgIHZhciBlbCA9IHRoaXMuZ2V0VGFiRWwoaXRlbSk7CiAgICAgICAgaWYoZWwpewogICAgICAgICAgICBFeHQuZmx5KGVsKS5hZGRDbGFzcygneC1pdGVtLWRpc2FibGVkJyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RhY2sucmVtb3ZlKGl0ZW0pOwogICAgfSwKCiAgICAKICAgIG9uSXRlbUVuYWJsZWQgOiBmdW5jdGlvbihpdGVtKXsKICAgICAgICB2YXIgZWwgPSB0aGlzLmdldFRhYkVsKGl0ZW0pOwogICAgICAgIGlmKGVsKXsKICAgICAgICAgICAgRXh0LmZseShlbCkucmVtb3ZlQ2xhc3MoJ3gtaXRlbS1kaXNhYmxlZCcpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkl0ZW1UaXRsZUNoYW5nZWQgOiBmdW5jdGlvbihpdGVtKXsKICAgICAgICB2YXIgZWwgPSB0aGlzLmdldFRhYkVsKGl0ZW0pOwogICAgICAgIGlmKGVsKXsKICAgICAgICAgICAgRXh0LmZseShlbCkuY2hpbGQoJ3NwYW4ueC10YWItc3RyaXAtdGV4dCcsIHRydWUpLmlubmVySFRNTCA9IGl0ZW0udGl0bGU7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uSXRlbUljb25DaGFuZ2VkIDogZnVuY3Rpb24oaXRlbSwgaWNvbkNscywgb2xkQ2xzKXsKICAgICAgICB2YXIgZWwgPSB0aGlzLmdldFRhYkVsKGl0ZW0pOwogICAgICAgIGlmKGVsKXsKICAgICAgICAgICAgZWwgPSBFeHQuZ2V0KGVsKTsKICAgICAgICAgICAgZWwuY2hpbGQoJ3NwYW4ueC10YWItc3RyaXAtdGV4dCcpLnJlcGxhY2VDbGFzcyhvbGRDbHMsIGljb25DbHMpOwogICAgICAgICAgICBlbFtFeHQuaXNFbXB0eShpY29uQ2xzKSA/ICdyZW1vdmVDbGFzcycgOiAnYWRkQ2xhc3MnXSgneC10YWItd2l0aC1pY29uJyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldFRhYkVsIDogZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgdmFyIGMgPSB0aGlzLmdldENvbXBvbmVudChpdGVtKTsKICAgICAgICByZXR1cm4gYyA/IGMudGFiRWwgOiBudWxsOwogICAgfSwKCiAgICAKICAgIG9uUmVzaXplIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuVGFiUGFuZWwuc3VwZXJjbGFzcy5vblJlc2l6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMuZGVsZWdhdGVVcGRhdGVzKCk7CiAgICB9LAoKICAgIAogICAgYmVnaW5VcGRhdGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuc3VzcGVuZFVwZGF0ZXMgPSB0cnVlOwogICAgfSwKCiAgICAKICAgIGVuZFVwZGF0ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zdXNwZW5kVXBkYXRlcyA9IGZhbHNlOwogICAgICAgIHRoaXMuZGVsZWdhdGVVcGRhdGVzKCk7CiAgICB9LAoKICAgIAogICAgaGlkZVRhYlN0cmlwSXRlbSA6IGZ1bmN0aW9uKGl0ZW0pewogICAgICAgIGl0ZW0gPSB0aGlzLmdldENvbXBvbmVudChpdGVtKTsKICAgICAgICB2YXIgZWwgPSB0aGlzLmdldFRhYkVsKGl0ZW0pOwogICAgICAgIGlmKGVsKXsKICAgICAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgdGhpcy5kZWxlZ2F0ZVVwZGF0ZXMoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdGFjay5yZW1vdmUoaXRlbSk7CiAgICB9LAoKICAgIAogICAgdW5oaWRlVGFiU3RyaXBJdGVtIDogZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgaXRlbSA9IHRoaXMuZ2V0Q29tcG9uZW50KGl0ZW0pOwogICAgICAgIHZhciBlbCA9IHRoaXMuZ2V0VGFiRWwoaXRlbSk7CiAgICAgICAgaWYoZWwpewogICAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgICAgIHRoaXMuZGVsZWdhdGVVcGRhdGVzKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRlbGVnYXRlVXBkYXRlcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHJlbmRlcmVkID0gdGhpcy5yZW5kZXJlZDsKICAgICAgICBpZih0aGlzLnN1c3BlbmRVcGRhdGVzKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnJlc2l6ZVRhYnMgJiYgcmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLmF1dG9TaXplVGFicygpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmVuYWJsZVRhYlNjcm9sbCAmJiByZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuYXV0b1Njcm9sbFRhYnMoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYXV0b1NpemVUYWJzIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY291bnQgPSB0aGlzLml0ZW1zLmxlbmd0aCwKICAgICAgICAgICAgY2UgPSB0aGlzLnRhYlBvc2l0aW9uICE9ICdib3R0b20nID8gJ2hlYWRlcicgOiAnZm9vdGVyJywKICAgICAgICAgICAgb3cgPSB0aGlzW2NlXS5kb20ub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgIGF3ID0gdGhpc1tjZV0uZG9tLmNsaWVudFdpZHRoOwoKICAgICAgICBpZighdGhpcy5yZXNpemVUYWJzIHx8IGNvdW50IDwgMSB8fCAhYXcpeyAKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVhY2ggPSBNYXRoLm1heChNYXRoLm1pbihNYXRoLmZsb29yKChhdy00KSAvIGNvdW50KSAtIHRoaXMudGFiTWFyZ2luLCB0aGlzLnRhYldpZHRoKSwgdGhpcy5taW5UYWJXaWR0aCk7IAogICAgICAgIHRoaXMubGFzdFRhYldpZHRoID0gZWFjaDsKICAgICAgICB2YXIgbGlzID0gdGhpcy5zdHJpcC5xdWVyeSgnbGk6bm90KC54LXRhYi1lZGdlKScpOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGxpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICB2YXIgbGkgPSBsaXNbaV0sCiAgICAgICAgICAgICAgICBpbm5lciA9IEV4dC5mbHkobGkpLmNoaWxkKCcueC10YWItc3RyaXAtaW5uZXInLCB0cnVlKSwKICAgICAgICAgICAgICAgIHR3ID0gbGkub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgICBpdyA9IGlubmVyLm9mZnNldFdpZHRoOwogICAgICAgICAgICBpbm5lci5zdHlsZS53aWR0aCA9IChlYWNoIC0gKHR3LWl3KSkgKyAncHgnOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhZGp1c3RCb2R5V2lkdGggOiBmdW5jdGlvbih3KXsKICAgICAgICBpZih0aGlzLmhlYWRlcil7CiAgICAgICAgICAgIHRoaXMuaGVhZGVyLnNldFdpZHRoKHcpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmZvb3Rlcil7CiAgICAgICAgICAgIHRoaXMuZm9vdGVyLnNldFdpZHRoKHcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdzsKICAgIH0sCgogICAgCiAgICBzZXRBY3RpdmVUYWIgOiBmdW5jdGlvbihpdGVtKXsKICAgICAgICBpdGVtID0gdGhpcy5nZXRDb21wb25lbnQoaXRlbSk7CiAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoJ2JlZm9yZXRhYmNoYW5nZScsIHRoaXMsIGl0ZW0sIHRoaXMuYWN0aXZlVGFiKSA9PT0gZmFsc2UpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKCF0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy5hY3RpdmVUYWIgPSBpdGVtOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuYWN0aXZlVGFiICE9IGl0ZW0pewogICAgICAgICAgICBpZih0aGlzLmFjdGl2ZVRhYil7CiAgICAgICAgICAgICAgICB2YXIgb2xkRWwgPSB0aGlzLmdldFRhYkVsKHRoaXMuYWN0aXZlVGFiKTsKICAgICAgICAgICAgICAgIGlmKG9sZEVsKXsKICAgICAgICAgICAgICAgICAgICBFeHQuZmx5KG9sZEVsKS5yZW1vdmVDbGFzcygneC10YWItc3RyaXAtYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVUYWIgPSBpdGVtOwogICAgICAgICAgICBpZihpdGVtKXsKICAgICAgICAgICAgICAgIHZhciBlbCA9IHRoaXMuZ2V0VGFiRWwoaXRlbSk7CiAgICAgICAgICAgICAgICBFeHQuZmx5KGVsKS5hZGRDbGFzcygneC10YWItc3RyaXAtYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB0aGlzLnN0YWNrLmFkZChpdGVtKTsKCiAgICAgICAgICAgICAgICB0aGlzLmxheW91dC5zZXRBY3RpdmVJdGVtKGl0ZW0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmRlbGVnYXRlVXBkYXRlcygpOwogICAgICAgICAgICAgICAgaWYodGhpcy5zY3JvbGxpbmcpewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9UYWIoaXRlbSwgdGhpcy5hbmltU2Nyb2xsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgndGFiY2hhbmdlJywgdGhpcywgaXRlbSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldEFjdGl2ZVRhYiA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYWN0aXZlVGFiIHx8IG51bGw7CiAgICB9LAoKICAgIAogICAgZ2V0SXRlbSA6IGZ1bmN0aW9uKGl0ZW0pewogICAgICAgIHJldHVybiB0aGlzLmdldENvbXBvbmVudChpdGVtKTsKICAgIH0sCgogICAgCiAgICBhdXRvU2Nyb2xsVGFicyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5wb3MgPSB0aGlzLnRhYlBvc2l0aW9uPT0nYm90dG9tJyA/IHRoaXMuZm9vdGVyIDogdGhpcy5oZWFkZXI7CiAgICAgICAgdmFyIGNvdW50ID0gdGhpcy5pdGVtcy5sZW5ndGgsCiAgICAgICAgICAgIG93ID0gdGhpcy5wb3MuZG9tLm9mZnNldFdpZHRoLAogICAgICAgICAgICB0dyA9IHRoaXMucG9zLmRvbS5jbGllbnRXaWR0aCwKICAgICAgICAgICAgd3JhcCA9IHRoaXMuc3RyaXBXcmFwLAogICAgICAgICAgICB3ZCA9IHdyYXAuZG9tLAogICAgICAgICAgICBjdyA9IHdkLm9mZnNldFdpZHRoLAogICAgICAgICAgICBwb3MgPSB0aGlzLmdldFNjcm9sbFBvcygpLAogICAgICAgICAgICBsID0gdGhpcy5lZGdlLmdldE9mZnNldHNUbyh0aGlzLnN0cmlwV3JhcClbMF0gKyBwb3M7CgogICAgICAgIGlmKCF0aGlzLmVuYWJsZVRhYlNjcm9sbCB8fCBjdyA8IDIwKXsgCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYoY291bnQgPT0gMCB8fCBsIDw9IHR3KXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdkLnNjcm9sbExlZnQgPSAwOwogICAgICAgICAgICB3cmFwLnNldFdpZHRoKHR3KTsKICAgICAgICAgICAgaWYodGhpcy5zY3JvbGxpbmcpewogICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMucG9zLnJlbW92ZUNsYXNzKCd4LXRhYi1zY3JvbGxpbmcnKTsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsTGVmdC5oaWRlKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFJpZ2h0LmhpZGUoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYoRXh0LmlzQWlyIHx8IEV4dC5pc1dlYktpdCl7CiAgICAgICAgICAgICAgICAgICAgd2Quc3R5bGUubWFyZ2luTGVmdCA9ICcnOwogICAgICAgICAgICAgICAgICAgIHdkLnN0eWxlLm1hcmdpblJpZ2h0ID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgaWYoIXRoaXMuc2Nyb2xsaW5nKXsKICAgICAgICAgICAgICAgIHRoaXMucG9zLmFkZENsYXNzKCd4LXRhYi1zY3JvbGxpbmcnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYoRXh0LmlzQWlyIHx8IEV4dC5pc1dlYktpdCl7CiAgICAgICAgICAgICAgICAgICAgd2Quc3R5bGUubWFyZ2luTGVmdCA9ICcxOHB4JzsKICAgICAgICAgICAgICAgICAgICB3ZC5zdHlsZS5tYXJnaW5SaWdodCA9ICcxOHB4JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0dyAtPSB3cmFwLmdldE1hcmdpbnMoJ2xyJyk7CiAgICAgICAgICAgIHdyYXAuc2V0V2lkdGgodHcgPiAyMCA/IHR3IDogMjApOwogICAgICAgICAgICBpZighdGhpcy5zY3JvbGxpbmcpewogICAgICAgICAgICAgICAgaWYoIXRoaXMuc2Nyb2xsTGVmdCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVTY3JvbGxlcnMoKTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsTGVmdC5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zY3JvbGxSaWdodC5zaG93KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zY3JvbGxpbmcgPSB0cnVlOwogICAgICAgICAgICBpZihwb3MgPiAobC10dykpeyAKICAgICAgICAgICAgICAgIHdkLnNjcm9sbExlZnQgPSBsLXR3OwogICAgICAgICAgICB9ZWxzZXsgCiAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvVGFiKHRoaXMuYWN0aXZlVGFiLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy51cGRhdGVTY3JvbGxCdXR0b25zKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNyZWF0ZVNjcm9sbGVycyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5wb3MuYWRkQ2xhc3MoJ3gtdGFiLXNjcm9sbGluZy0nICsgdGhpcy50YWJQb3NpdGlvbik7CiAgICAgICAgdmFyIGggPSB0aGlzLnN0cmlwV3JhcC5kb20ub2Zmc2V0SGVpZ2h0OwoKICAgICAgICAKICAgICAgICB2YXIgc2wgPSB0aGlzLnBvcy5pbnNlcnRGaXJzdCh7CiAgICAgICAgICAgIGNsczoneC10YWItc2Nyb2xsZXItbGVmdCcKICAgICAgICB9KTsKICAgICAgICBzbC5zZXRIZWlnaHQoaCk7CiAgICAgICAgc2wuYWRkQ2xhc3NPbk92ZXIoJ3gtdGFiLXNjcm9sbGVyLWxlZnQtb3ZlcicpOwogICAgICAgIHRoaXMubGVmdFJlcGVhdGVyID0gbmV3IEV4dC51dGlsLkNsaWNrUmVwZWF0ZXIoc2wsIHsKICAgICAgICAgICAgaW50ZXJ2YWwgOiB0aGlzLnNjcm9sbFJlcGVhdEludGVydmFsLAogICAgICAgICAgICBoYW5kbGVyOiB0aGlzLm9uU2Nyb2xsTGVmdCwKICAgICAgICAgICAgc2NvcGU6IHRoaXMKICAgICAgICB9KTsKICAgICAgICB0aGlzLnNjcm9sbExlZnQgPSBzbDsKCiAgICAgICAgCiAgICAgICAgdmFyIHNyID0gdGhpcy5wb3MuaW5zZXJ0Rmlyc3QoewogICAgICAgICAgICBjbHM6J3gtdGFiLXNjcm9sbGVyLXJpZ2h0JwogICAgICAgIH0pOwogICAgICAgIHNyLnNldEhlaWdodChoKTsKICAgICAgICBzci5hZGRDbGFzc09uT3ZlcigneC10YWItc2Nyb2xsZXItcmlnaHQtb3ZlcicpOwogICAgICAgIHRoaXMucmlnaHRSZXBlYXRlciA9IG5ldyBFeHQudXRpbC5DbGlja1JlcGVhdGVyKHNyLCB7CiAgICAgICAgICAgIGludGVydmFsIDogdGhpcy5zY3JvbGxSZXBlYXRJbnRlcnZhbCwKICAgICAgICAgICAgaGFuZGxlcjogdGhpcy5vblNjcm9sbFJpZ2h0LAogICAgICAgICAgICBzY29wZTogdGhpcwogICAgICAgIH0pOwogICAgICAgIHRoaXMuc2Nyb2xsUmlnaHQgPSBzcjsKICAgIH0sCgogICAgCiAgICBnZXRTY3JvbGxXaWR0aCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZWRnZS5nZXRPZmZzZXRzVG8odGhpcy5zdHJpcFdyYXApWzBdICsgdGhpcy5nZXRTY3JvbGxQb3MoKTsKICAgIH0sCgogICAgCiAgICBnZXRTY3JvbGxQb3MgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiBwYXJzZUludCh0aGlzLnN0cmlwV3JhcC5kb20uc2Nyb2xsTGVmdCwgMTApIHx8IDA7CiAgICB9LAoKICAgIAogICAgZ2V0U2Nyb2xsQXJlYSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHBhcnNlSW50KHRoaXMuc3RyaXBXcmFwLmRvbS5jbGllbnRXaWR0aCwgMTApIHx8IDA7CiAgICB9LAoKICAgIAogICAgZ2V0U2Nyb2xsQW5pbSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHtkdXJhdGlvbjp0aGlzLnNjcm9sbER1cmF0aW9uLCBjYWxsYmFjazogdGhpcy51cGRhdGVTY3JvbGxCdXR0b25zLCBzY29wZTogdGhpc307CiAgICB9LAoKICAgIAogICAgZ2V0U2Nyb2xsSW5jcmVtZW50IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxJbmNyZW1lbnQgfHwgKHRoaXMucmVzaXplVGFicyA/IHRoaXMubGFzdFRhYldpZHRoKzIgOiAxMDApOwogICAgfSwKCiAgICAKCiAgICBzY3JvbGxUb1RhYiA6IGZ1bmN0aW9uKGl0ZW0sIGFuaW1hdGUpewogICAgICAgIGlmKCFpdGVtKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgZWwgPSB0aGlzLmdldFRhYkVsKGl0ZW0pLAogICAgICAgICAgICBwb3MgPSB0aGlzLmdldFNjcm9sbFBvcygpLAogICAgICAgICAgICBhcmVhID0gdGhpcy5nZXRTY3JvbGxBcmVhKCksCiAgICAgICAgICAgIGxlZnQgPSBFeHQuZmx5KGVsKS5nZXRPZmZzZXRzVG8odGhpcy5zdHJpcFdyYXApWzBdICsgcG9zLAogICAgICAgICAgICByaWdodCA9IGxlZnQgKyBlbC5vZmZzZXRXaWR0aDsKICAgICAgICBpZihsZWZ0IDwgcG9zKXsKICAgICAgICAgICAgdGhpcy5zY3JvbGxUbyhsZWZ0LCBhbmltYXRlKTsKICAgICAgICB9ZWxzZSBpZihyaWdodCA+IChwb3MgKyBhcmVhKSl7CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG8ocmlnaHQgLSBhcmVhLCBhbmltYXRlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2Nyb2xsVG8gOiBmdW5jdGlvbihwb3MsIGFuaW1hdGUpewogICAgICAgIHRoaXMuc3RyaXBXcmFwLnNjcm9sbFRvKCdsZWZ0JywgcG9zLCBhbmltYXRlID8gdGhpcy5nZXRTY3JvbGxBbmltKCkgOiBmYWxzZSk7CiAgICAgICAgaWYoIWFuaW1hdGUpewogICAgICAgICAgICB0aGlzLnVwZGF0ZVNjcm9sbEJ1dHRvbnMoKTsKICAgICAgICB9CiAgICB9LAoKICAgIG9uV2hlZWwgOiBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgZCA9IGUuZ2V0V2hlZWxEZWx0YSgpKnRoaXMud2hlZWxJbmNyZW1lbnQqLTE7CiAgICAgICAgZS5zdG9wRXZlbnQoKTsKCiAgICAgICAgdmFyIHBvcyA9IHRoaXMuZ2V0U2Nyb2xsUG9zKCksCiAgICAgICAgICAgIG5ld3BvcyA9IHBvcyArIGQsCiAgICAgICAgICAgIHN3ID0gdGhpcy5nZXRTY3JvbGxXaWR0aCgpLXRoaXMuZ2V0U2Nyb2xsQXJlYSgpOwoKICAgICAgICB2YXIgcyA9IE1hdGgubWF4KDAsIE1hdGgubWluKHN3LCBuZXdwb3MpKTsKICAgICAgICBpZihzICE9IHBvcyl7CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG8ocywgZmFsc2UpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblNjcm9sbFJpZ2h0IDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgc3cgPSB0aGlzLmdldFNjcm9sbFdpZHRoKCktdGhpcy5nZXRTY3JvbGxBcmVhKCksCiAgICAgICAgICAgIHBvcyA9IHRoaXMuZ2V0U2Nyb2xsUG9zKCksCiAgICAgICAgICAgIHMgPSBNYXRoLm1pbihzdywgcG9zICsgdGhpcy5nZXRTY3JvbGxJbmNyZW1lbnQoKSk7CiAgICAgICAgaWYocyAhPSBwb3MpewogICAgICAgICAgICB0aGlzLnNjcm9sbFRvKHMsIHRoaXMuYW5pbVNjcm9sbCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uU2Nyb2xsTGVmdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHBvcyA9IHRoaXMuZ2V0U2Nyb2xsUG9zKCksCiAgICAgICAgICAgIHMgPSBNYXRoLm1heCgwLCBwb3MgLSB0aGlzLmdldFNjcm9sbEluY3JlbWVudCgpKTsKICAgICAgICBpZihzICE9IHBvcyl7CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG8ocywgdGhpcy5hbmltU2Nyb2xsKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdXBkYXRlU2Nyb2xsQnV0dG9ucyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHBvcyA9IHRoaXMuZ2V0U2Nyb2xsUG9zKCk7CiAgICAgICAgdGhpcy5zY3JvbGxMZWZ0W3BvcyA9PT0gMCA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnXSgneC10YWItc2Nyb2xsZXItbGVmdC1kaXNhYmxlZCcpOwogICAgICAgIHRoaXMuc2Nyb2xsUmlnaHRbcG9zID49ICh0aGlzLmdldFNjcm9sbFdpZHRoKCktdGhpcy5nZXRTY3JvbGxBcmVhKCkpID8gJ2FkZENsYXNzJyA6ICdyZW1vdmVDbGFzcyddKCd4LXRhYi1zY3JvbGxlci1yaWdodC1kaXNhYmxlZCcpOwogICAgfSwKCiAgICAKICAgIGJlZm9yZURlc3Ryb3kgOiBmdW5jdGlvbigpIHsKICAgICAgICBFeHQuZGVzdHJveSh0aGlzLmxlZnRSZXBlYXRlciwgdGhpcy5yaWdodFJlcGVhdGVyKTsKICAgICAgICB0aGlzLmRlbGV0ZU1lbWJlcnMoJ3N0cmlwJywgJ2VkZ2UnLCAnc2Nyb2xsTGVmdCcsICdzY3JvbGxSaWdodCcsICdzdHJpcFdyYXAnKTsKICAgICAgICB0aGlzLmFjdGl2ZVRhYiA9IG51bGw7CiAgICAgICAgRXh0LlRhYlBhbmVsLnN1cGVyY2xhc3MuYmVmb3JlRGVzdHJveS5hcHBseSh0aGlzKTsKICAgIH0KCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCn0pOwpFeHQucmVnKCd0YWJwYW5lbCcsIEV4dC5UYWJQYW5lbCk7CgoKRXh0LlRhYlBhbmVsLnByb3RvdHlwZS5hY3RpdmF0ZSA9IEV4dC5UYWJQYW5lbC5wcm90b3R5cGUuc2V0QWN0aXZlVGFiOwoKCkV4dC5UYWJQYW5lbC5BY2Nlc3NTdGFjayA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgaXRlbXMgPSBbXTsKICAgIHJldHVybiB7CiAgICAgICAgYWRkIDogZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgIGl0ZW1zLnB1c2goaXRlbSk7CiAgICAgICAgICAgIGlmKGl0ZW1zLmxlbmd0aCA+IDEwKXsKICAgICAgICAgICAgICAgIGl0ZW1zLnNoaWZ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICByZW1vdmUgOiBmdW5jdGlvbihpdGVtKXsKICAgICAgICAgICAgdmFyIHMgPSBbXTsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gaXRlbXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmKGl0ZW1zW2ldICE9IGl0ZW0pewogICAgICAgICAgICAgICAgICAgIHMucHVzaChpdGVtc1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbXMgPSBzOwogICAgICAgIH0sCgogICAgICAgIG5leHQgOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gaXRlbXMucG9wKCk7CiAgICAgICAgfQogICAgfTsKfTsKCkV4dC5CdXR0b24gPSBFeHQuZXh0ZW5kKEV4dC5Cb3hDb21wb25lbnQsIHsKICAgIAogICAgaGlkZGVuIDogZmFsc2UsCiAgICAKICAgIGRpc2FibGVkIDogZmFsc2UsCiAgICAKICAgIHByZXNzZWQgOiBmYWxzZSwKCiAgICAKCiAgICAKCiAgICAKICAgIGVuYWJsZVRvZ2dsZSA6IGZhbHNlLAogICAgCiAgICAKICAgIAogICAgbWVudUFsaWduIDogJ3RsLWJsPycsCgogICAgCiAgICAKICAgIAogICAgdHlwZSA6ICdidXR0b24nLAoKICAgIAogICAgbWVudUNsYXNzVGFyZ2V0IDogJ3RyOm50aCgyKScsCgogICAgCiAgICBjbGlja0V2ZW50IDogJ2NsaWNrJywKCiAgICAKICAgIGhhbmRsZU1vdXNlRXZlbnRzIDogdHJ1ZSwKCiAgICAKICAgIHRvb2x0aXBUeXBlIDogJ3F0aXAnLAoKICAgIAogICAgYnV0dG9uU2VsZWN0b3IgOiAnYnV0dG9uOmZpcnN0LWNoaWxkJywKCiAgICAKICAgIHNjYWxlIDogJ3NtYWxsJywKCiAgICAKCiAgICAKICAgIGljb25BbGlnbiA6ICdsZWZ0JywKCiAgICAKICAgIGFycm93QWxpZ24gOiAncmlnaHQnLAoKICAgIAogICAgCiAgICAKICAgIAoKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMubWVudSl7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEV4dC5pc0FycmF5KHRoaXMubWVudSkpewogICAgICAgICAgICAgICAgdGhpcy5tZW51ID0geyBpdGVtczogdGhpcy5tZW51IH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEV4dC5pc09iamVjdCh0aGlzLm1lbnUpKXsKICAgICAgICAgICAgICAgIHRoaXMubWVudS5vd25lckN0ID0gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZW51ID0gRXh0Lm1lbnUuTWVudU1nci5nZXQodGhpcy5tZW51KTsKICAgICAgICAgICAgdGhpcy5tZW51Lm93bmVyQ3QgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEV4dC5CdXR0b24uc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CgogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICd0b2dnbGUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ21vdXNlb3ZlcicsCiAgICAgICAgICAgIAogICAgICAgICAgICAnbW91c2VvdXQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ21lbnVzaG93JywKICAgICAgICAgICAgCiAgICAgICAgICAgICdtZW51aGlkZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnbWVudXRyaWdnZXJvdmVyJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdtZW51dHJpZ2dlcm91dCcKICAgICAgICApOwogICAgICAgIAogICAgICAgIGlmKEV4dC5pc1N0cmluZyh0aGlzLnRvZ2dsZUdyb3VwKSl7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlVG9nZ2xlID0gdHJ1ZTsKICAgICAgICB9CiAgICB9LAoKCiAgICBnZXRUZW1wbGF0ZUFyZ3MgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiBbdGhpcy50eXBlLCAneC1idG4tJyArIHRoaXMuc2NhbGUgKyAnIHgtYnRuLWljb24tJyArIHRoaXMuc2NhbGUgKyAnLScgKyB0aGlzLmljb25BbGlnbiwgdGhpcy5nZXRNZW51Q2xhc3MoKSwgdGhpcy5jbHMsIHRoaXMuaWRdOwogICAgfSwKCiAgICAKICAgIHNldEJ1dHRvbkNsYXNzIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnVzZVNldENsYXNzKXsKICAgICAgICAgICAgaWYoIUV4dC5pc0VtcHR5KHRoaXMub2xkQ2xzKSl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUNsYXNzKFt0aGlzLm9sZENscywgJ3gtYnRuLXByZXNzZWQnXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vbGRDbHMgPSAodGhpcy5pY29uQ2xzIHx8IHRoaXMuaWNvbikgPyAodGhpcy50ZXh0ID8gJ3gtYnRuLXRleHQtaWNvbicgOiAneC1idG4taWNvbicpIDogJ3gtYnRuLW5vaWNvbic7CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3MoW3RoaXMub2xkQ2xzLCB0aGlzLnByZXNzZWQgPyAneC1idG4tcHJlc3NlZCcgOiBudWxsXSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldE1lbnVDbGFzcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMubWVudSA/ICh0aGlzLmFycm93QWxpZ24gIT0gJ2JvdHRvbScgPyAneC1idG4tYXJyb3cnIDogJ3gtYnRuLWFycm93LWJvdHRvbScpIDogJyc7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIGlmKCF0aGlzLnRlbXBsYXRlKXsKICAgICAgICAgICAgaWYoIUV4dC5CdXR0b24uYnV0dG9uVGVtcGxhdGUpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBFeHQuQnV0dG9uLmJ1dHRvblRlbXBsYXRlID0gbmV3IEV4dC5UZW1wbGF0ZSgKICAgICAgICAgICAgICAgICAgICAnPHRhYmxlIGlkPSJ7NH0iIGNlbGxzcGFjaW5nPSIwIiBjbGFzcz0ieC1idG4gezN9Ij48dGJvZHkgY2xhc3M9InsxfSI+JywKICAgICAgICAgICAgICAgICAgICAnPHRyPjx0ZCBjbGFzcz0ieC1idG4tdGwiPjxpPiYjMTYwOzwvaT48L3RkPjx0ZCBjbGFzcz0ieC1idG4tdGMiPjwvdGQ+PHRkIGNsYXNzPSJ4LWJ0bi10ciI+PGk+JiMxNjA7PC9pPjwvdGQ+PC90cj4nLAogICAgICAgICAgICAgICAgICAgICc8dHI+PHRkIGNsYXNzPSJ4LWJ0bi1tbCI+PGk+JiMxNjA7PC9pPjwvdGQ+PHRkIGNsYXNzPSJ4LWJ0bi1tYyI+PGVtIGNsYXNzPSJ7Mn0iIHVuc2VsZWN0YWJsZT0ib24iPjxidXR0b24gdHlwZT0iezB9Ij48L2J1dHRvbj48L2VtPjwvdGQ+PHRkIGNsYXNzPSJ4LWJ0bi1tciI+PGk+JiMxNjA7PC9pPjwvdGQ+PC90cj4nLAogICAgICAgICAgICAgICAgICAgICc8dHI+PHRkIGNsYXNzPSJ4LWJ0bi1ibCI+PGk+JiMxNjA7PC9pPjwvdGQ+PHRkIGNsYXNzPSJ4LWJ0bi1iYyI+PC90ZD48dGQgY2xhc3M9IngtYnRuLWJyIj48aT4mIzE2MDs8L2k+PC90ZD48L3RyPicsCiAgICAgICAgICAgICAgICAgICAgJzwvdGJvZHk+PC90YWJsZT4nKTsKICAgICAgICAgICAgICAgIEV4dC5CdXR0b24uYnV0dG9uVGVtcGxhdGUuY29tcGlsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSBFeHQuQnV0dG9uLmJ1dHRvblRlbXBsYXRlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGJ0biwgdGFyZ3MgPSB0aGlzLmdldFRlbXBsYXRlQXJncygpOwoKICAgICAgICBpZihwb3NpdGlvbil7CiAgICAgICAgICAgIGJ0biA9IHRoaXMudGVtcGxhdGUuaW5zZXJ0QmVmb3JlKHBvc2l0aW9uLCB0YXJncywgdHJ1ZSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGJ0biA9IHRoaXMudGVtcGxhdGUuYXBwZW5kKGN0LCB0YXJncywgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMuYnRuRWwgPSBidG4uY2hpbGQodGhpcy5idXR0b25TZWxlY3Rvcik7CiAgICAgICAgdGhpcy5tb24odGhpcy5idG5FbCwgewogICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgZm9jdXM6IHRoaXMub25Gb2N1cywKICAgICAgICAgICAgYmx1cjogdGhpcy5vbkJsdXIKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5pbml0QnV0dG9uRWwoYnRuLCB0aGlzLmJ0bkVsKTsKCiAgICAgICAgRXh0LkJ1dHRvblRvZ2dsZU1nci5yZWdpc3Rlcih0aGlzKTsKICAgIH0sCgogICAgCiAgICBpbml0QnV0dG9uRWwgOiBmdW5jdGlvbihidG4sIGJ0bkVsKXsKICAgICAgICB0aGlzLmVsID0gYnRuOwogICAgICAgIHRoaXMuc2V0SWNvbih0aGlzLmljb24pOwogICAgICAgIHRoaXMuc2V0VGV4dCh0aGlzLnRleHQpOwogICAgICAgIHRoaXMuc2V0SWNvbkNsYXNzKHRoaXMuaWNvbkNscyk7CiAgICAgICAgaWYoRXh0LmlzRGVmaW5lZCh0aGlzLnRhYkluZGV4KSl7CiAgICAgICAgICAgIGJ0bkVsLmRvbS50YWJJbmRleCA9IHRoaXMudGFiSW5kZXg7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMudG9vbHRpcCl7CiAgICAgICAgICAgIHRoaXMuc2V0VG9vbHRpcCh0aGlzLnRvb2x0aXAsIHRydWUpOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5oYW5kbGVNb3VzZUV2ZW50cyl7CiAgICAgICAgICAgIHRoaXMubW9uKGJ0biwgewogICAgICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgICAgICBtb3VzZW92ZXI6IHRoaXMub25Nb3VzZU92ZXIsCiAgICAgICAgICAgICAgICBtb3VzZWRvd246IHRoaXMub25Nb3VzZURvd24KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLm1lbnUpewogICAgICAgICAgICB0aGlzLm1vbih0aGlzLm1lbnUsIHsKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgc2hvdzogdGhpcy5vbk1lbnVTaG93LAogICAgICAgICAgICAgICAgaGlkZTogdGhpcy5vbk1lbnVIaWRlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5yZXBlYXQpewogICAgICAgICAgICB2YXIgcmVwZWF0ZXIgPSBuZXcgRXh0LnV0aWwuQ2xpY2tSZXBlYXRlcihidG4sIEV4dC5pc09iamVjdCh0aGlzLnJlcGVhdCkgPyB0aGlzLnJlcGVhdCA6IHt9KTsKICAgICAgICAgICAgdGhpcy5tb24ocmVwZWF0ZXIsICdjbGljaycsIHRoaXMub25SZXBlYXRDbGljaywgdGhpcyk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMubW9uKGJ0biwgdGhpcy5jbGlja0V2ZW50LCB0aGlzLm9uQ2xpY2ssIHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBhZnRlclJlbmRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LkJ1dHRvbi5zdXBlcmNsYXNzLmFmdGVyUmVuZGVyLmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy51c2VTZXRDbGFzcyA9IHRydWU7CiAgICAgICAgdGhpcy5zZXRCdXR0b25DbGFzcygpOwogICAgICAgIHRoaXMuZG9jID0gRXh0LmdldERvYygpOwogICAgICAgIHRoaXMuZG9BdXRvV2lkdGgoKTsKICAgIH0sCgogICAgCiAgICBzZXRJY29uQ2xhc3MgOiBmdW5jdGlvbihjbHMpewogICAgICAgIHRoaXMuaWNvbkNscyA9IGNsczsKICAgICAgICBpZih0aGlzLmVsKXsKICAgICAgICAgICAgdGhpcy5idG5FbC5kb20uY2xhc3NOYW1lID0gJyc7CiAgICAgICAgICAgIHRoaXMuYnRuRWwuYWRkQ2xhc3MoWyd4LWJ0bi10ZXh0JywgY2xzIHx8ICcnXSk7CiAgICAgICAgICAgIHRoaXMuc2V0QnV0dG9uQ2xhc3MoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgc2V0VG9vbHRpcCA6IGZ1bmN0aW9uKHRvb2x0aXAsICBpbml0aWFsKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgaWYoIWluaXRpYWwpewogICAgICAgICAgICAgICAgdGhpcy5jbGVhclRpcCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKEV4dC5pc09iamVjdCh0b29sdGlwKSl7CiAgICAgICAgICAgICAgICBFeHQuUXVpY2tUaXBzLnJlZ2lzdGVyKEV4dC5hcHBseSh7CiAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IHRoaXMuYnRuRWwuaWQKICAgICAgICAgICAgICAgIH0sIHRvb2x0aXApKTsKICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcCA9IHRvb2x0aXA7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy5idG5FbC5kb21bdGhpcy50b29sdGlwVHlwZV0gPSB0b29sdGlwOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMudG9vbHRpcCA9IHRvb2x0aXA7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGNsZWFyVGlwIDogZnVuY3Rpb24oKXsKICAgICAgICBpZihFeHQuaXNPYmplY3QodGhpcy50b29sdGlwKSl7CiAgICAgICAgICAgIEV4dC5RdWlja1RpcHMudW5yZWdpc3Rlcih0aGlzLmJ0bkVsKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYmVmb3JlRGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuY2xlYXJUaXAoKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5tZW51ICYmIHRoaXMuZGVzdHJveU1lbnUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgIEV4dC5kZXN0cm95KHRoaXMuYnRuRWwsIHRoaXMubWVudSk7CiAgICAgICAgfQogICAgICAgIEV4dC5kZXN0cm95KHRoaXMucmVwZWF0ZXIpOwogICAgfSwKCiAgICAKICAgIG9uRGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuZG9jLnVuKCdtb3VzZW92ZXInLCB0aGlzLm1vbml0b3JNb3VzZU92ZXIsIHRoaXMpOwogICAgICAgICAgICB0aGlzLmRvYy51bignbW91c2V1cCcsIHRoaXMub25Nb3VzZVVwLCB0aGlzKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuZG9jOwogICAgICAgICAgICBkZWxldGUgdGhpcy5idG5FbDsKICAgICAgICAgICAgRXh0LkJ1dHRvblRvZ2dsZU1nci51bnJlZ2lzdGVyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBFeHQuQnV0dG9uLnN1cGVyY2xhc3Mub25EZXN0cm95LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgZG9BdXRvV2lkdGggOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuYXV0b1dpZHRoICE9PSBmYWxzZSAmJiB0aGlzLmVsICYmIHRoaXMudGV4dCAmJiB0aGlzLndpZHRoID09PSB1bmRlZmluZWQpewogICAgICAgICAgICB0aGlzLmVsLnNldFdpZHRoKCdhdXRvJyk7CiAgICAgICAgICAgIGlmKEV4dC5pc0lFNyAmJiBFeHQuaXNTdHJpY3QpewogICAgICAgICAgICAgICAgdmFyIGliID0gdGhpcy5idG5FbDsKICAgICAgICAgICAgICAgIGlmKGliICYmIGliLmdldFdpZHRoKCkgPiAyMCl7CiAgICAgICAgICAgICAgICAgICAgaWIuY2xpcCgpOwogICAgICAgICAgICAgICAgICAgIGliLnNldFdpZHRoKEV4dC51dGlsLlRleHRNZXRyaWNzLm1lYXN1cmUoaWIsIHRoaXMudGV4dCkud2lkdGgraWIuZ2V0RnJhbWVXaWR0aCgnbHInKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5taW5XaWR0aCl7CiAgICAgICAgICAgICAgICBpZih0aGlzLmVsLmdldFdpZHRoKCkgPCB0aGlzLm1pbldpZHRoKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLnNldFdpZHRoKHRoaXMubWluV2lkdGgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNldEhhbmRsZXIgOiBmdW5jdGlvbihoYW5kbGVyLCBzY29wZSl7CiAgICAgICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlcjsKICAgICAgICB0aGlzLnNjb3BlID0gc2NvcGU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgc2V0VGV4dCA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgIHRoaXMudGV4dCA9IHRleHQ7CiAgICAgICAgaWYodGhpcy5lbCl7CiAgICAgICAgICAgIHRoaXMuYnRuRWwudXBkYXRlKHRleHQgfHwgJyYjMTYwOycpOwogICAgICAgICAgICB0aGlzLnNldEJ1dHRvbkNsYXNzKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZG9BdXRvV2lkdGgoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBzZXRJY29uIDogZnVuY3Rpb24oaWNvbil7CiAgICAgICAgdGhpcy5pY29uID0gaWNvbjsKICAgICAgICBpZih0aGlzLmVsKXsKICAgICAgICAgICAgdGhpcy5idG5FbC5zZXRTdHlsZSgnYmFja2dyb3VuZC1pbWFnZScsIGljb24gPyAndXJsKCcgKyBpY29uICsgJyknIDogJycpOwogICAgICAgICAgICB0aGlzLnNldEJ1dHRvbkNsYXNzKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGdldFRleHQgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnRleHQ7CiAgICB9LAoKICAgIAogICAgdG9nZ2xlIDogZnVuY3Rpb24oc3RhdGUsIHN1cHByZXNzRXZlbnQpewogICAgICAgIHN0YXRlID0gc3RhdGUgPT09IHVuZGVmaW5lZCA/ICF0aGlzLnByZXNzZWQgOiAhIXN0YXRlOwogICAgICAgIGlmKHN0YXRlICE9IHRoaXMucHJlc3NlZCl7CiAgICAgICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICAgICAgdGhpcy5lbFtzdGF0ZSA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnXSgneC1idG4tcHJlc3NlZCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucHJlc3NlZCA9IHN0YXRlOwogICAgICAgICAgICBpZighc3VwcHJlc3NFdmVudCl7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgndG9nZ2xlJywgdGhpcywgc3RhdGUpOwogICAgICAgICAgICAgICAgaWYodGhpcy50b2dnbGVIYW5kbGVyKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRvZ2dsZUhhbmRsZXIuY2FsbCh0aGlzLnNjb3BlIHx8IHRoaXMsIHRoaXMsIHN0YXRlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBvbkRpc2FibGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMub25EaXNhYmxlQ2hhbmdlKHRydWUpOwogICAgfSwKCiAgICAKICAgIG9uRW5hYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLm9uRGlzYWJsZUNoYW5nZShmYWxzZSk7CiAgICB9LAoKICAgIG9uRGlzYWJsZUNoYW5nZSA6IGZ1bmN0aW9uKGRpc2FibGVkKXsKICAgICAgICBpZih0aGlzLmVsKXsKICAgICAgICAgICAgaWYoIUV4dC5pc0lFNiB8fCAhdGhpcy50ZXh0KXsKICAgICAgICAgICAgICAgIHRoaXMuZWxbZGlzYWJsZWQgPyAnYWRkQ2xhc3MnIDogJ3JlbW92ZUNsYXNzJ10odGhpcy5kaXNhYmxlZENsYXNzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsLmRvbS5kaXNhYmxlZCA9IGRpc2FibGVkOwogICAgICAgIH0KICAgICAgICB0aGlzLmRpc2FibGVkID0gZGlzYWJsZWQ7CiAgICB9LAoKICAgIAogICAgc2hvd01lbnUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMucmVuZGVyZWQgJiYgdGhpcy5tZW51KXsKICAgICAgICAgICAgaWYodGhpcy50b29sdGlwKXsKICAgICAgICAgICAgICAgIEV4dC5RdWlja1RpcHMuZ2V0UXVpY2tUaXAoKS5jYW5jZWxTaG93KHRoaXMuYnRuRWwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMubWVudS5pc1Zpc2libGUoKSl7CiAgICAgICAgICAgICAgICB0aGlzLm1lbnUuaGlkZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMubWVudS5vd25lckN0ID0gdGhpczsKICAgICAgICAgICAgdGhpcy5tZW51LnNob3codGhpcy5lbCwgdGhpcy5tZW51QWxpZ24pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBoaWRlTWVudSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5oYXNWaXNpYmxlTWVudSgpKXsKICAgICAgICAgICAgdGhpcy5tZW51LmhpZGUoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgaGFzVmlzaWJsZU1lbnUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLm1lbnUgJiYgdGhpcy5tZW51Lm93bmVyQ3QgPT0gdGhpcyAmJiB0aGlzLm1lbnUuaXNWaXNpYmxlKCk7CiAgICB9LAogICAgCiAgICAKICAgIG9uUmVwZWF0Q2xpY2sgOiBmdW5jdGlvbihyZXBlYXQsIGUpewogICAgICAgIHRoaXMub25DbGljayhlKTsKICAgIH0sCgogICAgCiAgICBvbkNsaWNrIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYoZSl7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CiAgICAgICAgaWYoZS5idXR0b24gIT09IDApewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKCF0aGlzLmRpc2FibGVkKXsKICAgICAgICAgICAgdGhpcy5kb1RvZ2dsZSgpOwogICAgICAgICAgICBpZih0aGlzLm1lbnUgJiYgIXRoaXMuaGFzVmlzaWJsZU1lbnUoKSAmJiAhdGhpcy5pZ25vcmVOZXh0Q2xpY2spewogICAgICAgICAgICAgICAgdGhpcy5zaG93TWVudSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjbGljaycsIHRoaXMsIGUpOwogICAgICAgICAgICBpZih0aGlzLmhhbmRsZXIpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZXIuY2FsbCh0aGlzLnNjb3BlIHx8IHRoaXMsIHRoaXMsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBkb1RvZ2dsZTogZnVuY3Rpb24oKXsKICAgICAgICBpZiAodGhpcy5lbmFibGVUb2dnbGUgJiYgKHRoaXMuYWxsb3dEZXByZXNzICE9PSBmYWxzZSB8fCAhdGhpcy5wcmVzc2VkKSkgewogICAgICAgICAgICB0aGlzLnRvZ2dsZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBpc01lbnVUcmlnZ2VyT3ZlciA6IGZ1bmN0aW9uKGUsIGludGVybmFsKXsKICAgICAgICByZXR1cm4gdGhpcy5tZW51ICYmICFpbnRlcm5hbDsKICAgIH0sCgogICAgCiAgICBpc01lbnVUcmlnZ2VyT3V0IDogZnVuY3Rpb24oZSwgaW50ZXJuYWwpewogICAgICAgIHJldHVybiB0aGlzLm1lbnUgJiYgIWludGVybmFsOwogICAgfSwKCiAgICAKICAgIG9uTW91c2VPdmVyIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYoIXRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICB2YXIgaW50ZXJuYWwgPSBlLndpdGhpbih0aGlzLmVsLCAgdHJ1ZSk7CiAgICAgICAgICAgIGlmKCFpbnRlcm5hbCl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLmFkZENsYXNzKCd4LWJ0bi1vdmVyJyk7CiAgICAgICAgICAgICAgICBpZighdGhpcy5tb25pdG9yaW5nTW91c2VPdmVyKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRvYy5vbignbW91c2VvdmVyJywgdGhpcy5tb25pdG9yTW91c2VPdmVyLCB0aGlzKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1vbml0b3JpbmdNb3VzZU92ZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ21vdXNlb3ZlcicsIHRoaXMsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMuaXNNZW51VHJpZ2dlck92ZXIoZSwgaW50ZXJuYWwpKXsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdtZW51dHJpZ2dlcm92ZXInLCB0aGlzLCB0aGlzLm1lbnUsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG1vbml0b3JNb3VzZU92ZXIgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZihlLnRhcmdldCAhPSB0aGlzLmVsLmRvbSAmJiAhZS53aXRoaW4odGhpcy5lbCkpewogICAgICAgICAgICBpZih0aGlzLm1vbml0b3JpbmdNb3VzZU92ZXIpewogICAgICAgICAgICAgICAgdGhpcy5kb2MudW4oJ21vdXNlb3ZlcicsIHRoaXMubW9uaXRvck1vdXNlT3ZlciwgdGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLm1vbml0b3JpbmdNb3VzZU92ZXIgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm9uTW91c2VPdXQoZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uTW91c2VPdXQgOiBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgaW50ZXJuYWwgPSBlLndpdGhpbih0aGlzLmVsKSAmJiBlLnRhcmdldCAhPSB0aGlzLmVsLmRvbTsKICAgICAgICB0aGlzLmVsLnJlbW92ZUNsYXNzKCd4LWJ0bi1vdmVyJyk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ21vdXNlb3V0JywgdGhpcywgZSk7CiAgICAgICAgaWYodGhpcy5pc01lbnVUcmlnZ2VyT3V0KGUsIGludGVybmFsKSl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdtZW51dHJpZ2dlcm91dCcsIHRoaXMsIHRoaXMubWVudSwgZSk7CiAgICAgICAgfQogICAgfSwKCiAgICBmb2N1cyA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYnRuRWwuZm9jdXMoKTsKICAgIH0sCgogICAgYmx1ciA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYnRuRWwuYmx1cigpOwogICAgfSwKCiAgICAKICAgIG9uRm9jdXMgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZighdGhpcy5kaXNhYmxlZCl7CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3MoJ3gtYnRuLWZvY3VzJyk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgb25CbHVyIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy5lbC5yZW1vdmVDbGFzcygneC1idG4tZm9jdXMnKTsKICAgIH0sCgogICAgCiAgICBnZXRDbGlja0VsIDogZnVuY3Rpb24oZSwgaXNVcCl7CiAgICAgICByZXR1cm4gdGhpcy5lbDsKICAgIH0sCgogICAgCiAgICBvbk1vdXNlRG93biA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKCF0aGlzLmRpc2FibGVkICYmIGUuYnV0dG9uID09PSAwKXsKICAgICAgICAgICAgdGhpcy5nZXRDbGlja0VsKGUpLmFkZENsYXNzKCd4LWJ0bi1jbGljaycpOwogICAgICAgICAgICB0aGlzLmRvYy5vbignbW91c2V1cCcsIHRoaXMub25Nb3VzZVVwLCB0aGlzKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICBvbk1vdXNlVXAgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZihlLmJ1dHRvbiA9PT0gMCl7CiAgICAgICAgICAgIHRoaXMuZ2V0Q2xpY2tFbChlLCB0cnVlKS5yZW1vdmVDbGFzcygneC1idG4tY2xpY2snKTsKICAgICAgICAgICAgdGhpcy5kb2MudW4oJ21vdXNldXAnLCB0aGlzLm9uTW91c2VVcCwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgb25NZW51U2hvdyA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKHRoaXMubWVudS5vd25lckN0ID09IHRoaXMpewogICAgICAgICAgICB0aGlzLm1lbnUub3duZXJDdCA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuaWdub3JlTmV4dENsaWNrID0gMDsKICAgICAgICAgICAgdGhpcy5lbC5hZGRDbGFzcygneC1idG4tbWVudS1hY3RpdmUnKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ21lbnVzaG93JywgdGhpcywgdGhpcy5tZW51KTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICBvbk1lbnVIaWRlIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYodGhpcy5tZW51Lm93bmVyQ3QgPT0gdGhpcyl7CiAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3MoJ3gtYnRuLW1lbnUtYWN0aXZlJyk7CiAgICAgICAgICAgIHRoaXMuaWdub3JlTmV4dENsaWNrID0gdGhpcy5yZXN0b3JlQ2xpY2suZGVmZXIoMjUwLCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ21lbnVoaWRlJywgdGhpcywgdGhpcy5tZW51KTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubWVudS5vd25lckN0OwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZXN0b3JlQ2xpY2sgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuaWdub3JlTmV4dENsaWNrID0gMDsKICAgIH0KCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCn0pOwpFeHQucmVnKCdidXR0b24nLCBFeHQuQnV0dG9uKTsKCgpFeHQuQnV0dG9uVG9nZ2xlTWdyID0gZnVuY3Rpb24oKXsKICAgdmFyIGdyb3VwcyA9IHt9OwoKICAgZnVuY3Rpb24gdG9nZ2xlR3JvdXAoYnRuLCBzdGF0ZSl7CiAgICAgICBpZihzdGF0ZSl7CiAgICAgICAgICAgdmFyIGcgPSBncm91cHNbYnRuLnRvZ2dsZUdyb3VwXTsKICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsID0gZy5sZW5ndGg7IGkgPCBsOyBpKyspewogICAgICAgICAgICAgICBpZihnW2ldICE9IGJ0bil7CiAgICAgICAgICAgICAgICAgICBnW2ldLnRvZ2dsZShmYWxzZSk7CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICB9CiAgICAgICB9CiAgIH0KCiAgIHJldHVybiB7CiAgICAgICByZWdpc3RlciA6IGZ1bmN0aW9uKGJ0bil7CiAgICAgICAgICAgaWYoIWJ0bi50b2dnbGVHcm91cCl7CiAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICB9CiAgICAgICAgICAgdmFyIGcgPSBncm91cHNbYnRuLnRvZ2dsZUdyb3VwXTsKICAgICAgICAgICBpZighZyl7CiAgICAgICAgICAgICAgIGcgPSBncm91cHNbYnRuLnRvZ2dsZUdyb3VwXSA9IFtdOwogICAgICAgICAgIH0KICAgICAgICAgICBnLnB1c2goYnRuKTsKICAgICAgICAgICBidG4ub24oJ3RvZ2dsZScsIHRvZ2dsZUdyb3VwKTsKICAgICAgIH0sCgogICAgICAgdW5yZWdpc3RlciA6IGZ1bmN0aW9uKGJ0bil7CiAgICAgICAgICAgaWYoIWJ0bi50b2dnbGVHcm91cCl7CiAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICB9CiAgICAgICAgICAgdmFyIGcgPSBncm91cHNbYnRuLnRvZ2dsZUdyb3VwXTsKICAgICAgICAgICBpZihnKXsKICAgICAgICAgICAgICAgZy5yZW1vdmUoYnRuKTsKICAgICAgICAgICAgICAgYnRuLnVuKCd0b2dnbGUnLCB0b2dnbGVHcm91cCk7CiAgICAgICAgICAgfQogICAgICAgfSwKCiAgICAgICAKICAgICAgIGdldFByZXNzZWQgOiBmdW5jdGlvbihncm91cCl7CiAgICAgICAgICAgdmFyIGcgPSBncm91cHNbZ3JvdXBdOwogICAgICAgICAgIGlmKGcpewogICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBnLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgIGlmKGdbaV0ucHJlc3NlZCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdbaV07CiAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICB9CiAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICB9CiAgIH07Cn0oKTsKCkV4dC5TcGxpdEJ1dHRvbiA9IEV4dC5leHRlbmQoRXh0LkJ1dHRvbiwgewoJCiAgICBhcnJvd1NlbGVjdG9yIDogJ2VtJywKICAgIHNwbGl0OiB0cnVlLAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LlNwbGl0QnV0dG9uLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIAogICAgICAgIHRoaXMuYWRkRXZlbnRzKCJhcnJvd2NsaWNrIik7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5TcGxpdEJ1dHRvbi5zdXBlcmNsYXNzLm9uUmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgaWYodGhpcy5hcnJvd1Rvb2x0aXApewogICAgICAgICAgICB0aGlzLmVsLmNoaWxkKHRoaXMuYXJyb3dTZWxlY3RvcikuZG9tW3RoaXMudG9vbHRpcFR5cGVdID0gdGhpcy5hcnJvd1Rvb2x0aXA7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNldEFycm93SGFuZGxlciA6IGZ1bmN0aW9uKGhhbmRsZXIsIHNjb3BlKXsKICAgICAgICB0aGlzLmFycm93SGFuZGxlciA9IGhhbmRsZXI7CiAgICAgICAgdGhpcy5zY29wZSA9IHNjb3BlOwogICAgfSwKCiAgICBnZXRNZW51Q2xhc3MgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiAneC1idG4tc3BsaXQnICsgKHRoaXMuYXJyb3dBbGlnbiA9PSAnYm90dG9tJyA/ICctYm90dG9tJyA6ICcnKTsKICAgIH0sCgogICAgaXNDbGlja09uQXJyb3cgOiBmdW5jdGlvbihlKXsKCWlmICh0aGlzLmFycm93QWxpZ24gIT0gJ2JvdHRvbScpIHsKCSAgICB2YXIgdmlzQnRuID0gdGhpcy5lbC5jaGlsZCgnZW0ueC1idG4tc3BsaXQnKTsKCSAgICB2YXIgcmlnaHQgPSB2aXNCdG4uZ2V0UmVnaW9uKCkucmlnaHQgLSB2aXNCdG4uZ2V0UGFkZGluZygncicpOwoJICAgIHJldHVybiBlLmdldFBhZ2VYKCkgPiByaWdodDsKCX0gZWxzZSB7CgkgICAgcmV0dXJuIGUuZ2V0UGFnZVkoKSA+IHRoaXMuYnRuRWwuZ2V0UmVnaW9uKCkuYm90dG9tOwoJfQogICAgfSwKCiAgICAKICAgIG9uQ2xpY2sgOiBmdW5jdGlvbihlLCB0KXsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgaWYoIXRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICBpZih0aGlzLmlzQ2xpY2tPbkFycm93KGUpKXsKICAgICAgICAgICAgICAgIGlmKHRoaXMubWVudSAmJiAhdGhpcy5tZW51LmlzVmlzaWJsZSgpICYmICF0aGlzLmlnbm9yZU5leHRDbGljayl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93TWVudSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImFycm93Y2xpY2siLCB0aGlzLCBlKTsKICAgICAgICAgICAgICAgIGlmKHRoaXMuYXJyb3dIYW5kbGVyKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFycm93SGFuZGxlci5jYWxsKHRoaXMuc2NvcGUgfHwgdGhpcywgdGhpcywgZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy5kb1RvZ2dsZSgpOwogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImNsaWNrIiwgdGhpcywgZSk7CiAgICAgICAgICAgICAgICBpZih0aGlzLmhhbmRsZXIpewogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlci5jYWxsKHRoaXMuc2NvcGUgfHwgdGhpcywgdGhpcywgZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaXNNZW51VHJpZ2dlck92ZXIgOiBmdW5jdGlvbihlKXsKICAgICAgICByZXR1cm4gdGhpcy5tZW51ICYmIGUudGFyZ2V0LnRhZ05hbWUgPT0gdGhpcy5hcnJvd1NlbGVjdG9yOwogICAgfSwKCiAgICAKICAgIGlzTWVudVRyaWdnZXJPdXQgOiBmdW5jdGlvbihlLCBpbnRlcm5hbCl7CiAgICAgICAgcmV0dXJuIHRoaXMubWVudSAmJiBlLnRhcmdldC50YWdOYW1lICE9IHRoaXMuYXJyb3dTZWxlY3RvcjsKICAgIH0KfSk7CgpFeHQucmVnKCdzcGxpdGJ1dHRvbicsIEV4dC5TcGxpdEJ1dHRvbik7CkV4dC5DeWNsZUJ1dHRvbiA9IEV4dC5leHRlbmQoRXh0LlNwbGl0QnV0dG9uLCB7CiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCgogICAgCiAgICBnZXRJdGVtVGV4dCA6IGZ1bmN0aW9uKGl0ZW0pewogICAgICAgIGlmKGl0ZW0gJiYgdGhpcy5zaG93VGV4dCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHZhciB0ZXh0ID0gJyc7CiAgICAgICAgICAgIGlmKHRoaXMucHJlcGVuZFRleHQpewogICAgICAgICAgICAgICAgdGV4dCArPSB0aGlzLnByZXBlbmRUZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRleHQgKz0gaXRlbS50ZXh0OwogICAgICAgICAgICByZXR1cm4gdGV4dDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0sCgogICAgCiAgICBzZXRBY3RpdmVJdGVtIDogZnVuY3Rpb24oaXRlbSwgc3VwcHJlc3NFdmVudCl7CiAgICAgICAgaWYoIUV4dC5pc09iamVjdChpdGVtKSl7CiAgICAgICAgICAgIGl0ZW0gPSB0aGlzLm1lbnUuZ2V0Q29tcG9uZW50KGl0ZW0pOwogICAgICAgIH0KICAgICAgICBpZihpdGVtKXsKICAgICAgICAgICAgaWYoIXRoaXMucmVuZGVyZWQpewogICAgICAgICAgICAgICAgdGhpcy50ZXh0ID0gdGhpcy5nZXRJdGVtVGV4dChpdGVtKTsKICAgICAgICAgICAgICAgIHRoaXMuaWNvbkNscyA9IGl0ZW0uaWNvbkNsczsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuZ2V0SXRlbVRleHQoaXRlbSk7CiAgICAgICAgICAgICAgICBpZih0KXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldFRleHQodCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnNldEljb25DbGFzcyhpdGVtLmljb25DbHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWN0aXZlSXRlbSA9IGl0ZW07CiAgICAgICAgICAgIGlmKCFpdGVtLmNoZWNrZWQpewogICAgICAgICAgICAgICAgaXRlbS5zZXRDaGVja2VkKHRydWUsIHN1cHByZXNzRXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMuZm9yY2VJY29uKXsKICAgICAgICAgICAgICAgIHRoaXMuc2V0SWNvbkNsYXNzKHRoaXMuZm9yY2VJY29uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighc3VwcHJlc3NFdmVudCl7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnY2hhbmdlJywgdGhpcywgaXRlbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0QWN0aXZlSXRlbSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYWN0aXZlSXRlbTsKICAgIH0sCgogICAgCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICJjaGFuZ2UiCiAgICAgICAgKTsKCiAgICAgICAgaWYodGhpcy5jaGFuZ2VIYW5kbGVyKXsKICAgICAgICAgICAgdGhpcy5vbignY2hhbmdlJywgdGhpcy5jaGFuZ2VIYW5kbGVyLCB0aGlzLnNjb3BlfHx0aGlzKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlSGFuZGxlcjsKICAgICAgICB9CgogICAgICAgIHRoaXMuaXRlbUNvdW50ID0gdGhpcy5pdGVtcy5sZW5ndGg7CgogICAgICAgIHRoaXMubWVudSA9IHtjbHM6J3gtY3ljbGUtbWVudScsIGl0ZW1zOltdfTsKICAgICAgICB2YXIgY2hlY2tlZCA9IDA7CiAgICAgICAgRXh0LmVhY2godGhpcy5pdGVtcywgZnVuY3Rpb24oaXRlbSwgaSl7CiAgICAgICAgICAgIEV4dC5hcHBseShpdGVtLCB7CiAgICAgICAgICAgICAgICBncm91cDogaXRlbS5ncm91cCB8fCB0aGlzLmlkLAogICAgICAgICAgICAgICAgaXRlbUluZGV4OiBpLAogICAgICAgICAgICAgICAgY2hlY2tIYW5kbGVyOiB0aGlzLmNoZWNrSGFuZGxlciwKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgY2hlY2tlZDogaXRlbS5jaGVja2VkIHx8IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm1lbnUuaXRlbXMucHVzaChpdGVtKTsKICAgICAgICAgICAgaWYoaXRlbS5jaGVja2VkKXsKICAgICAgICAgICAgICAgIGNoZWNrZWQgPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgRXh0LkN5Y2xlQnV0dG9uLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMub24oJ2NsaWNrJywgdGhpcy50b2dnbGVTZWxlY3RlZCwgdGhpcyk7CiAgICAgICAgdGhpcy5zZXRBY3RpdmVJdGVtKGNoZWNrZWQsIHRydWUpOwogICAgfSwKCiAgICAKICAgIGNoZWNrSGFuZGxlciA6IGZ1bmN0aW9uKGl0ZW0sIHByZXNzZWQpewogICAgICAgIGlmKHByZXNzZWQpewogICAgICAgICAgICB0aGlzLnNldEFjdGl2ZUl0ZW0oaXRlbSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHRvZ2dsZVNlbGVjdGVkIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgbSA9IHRoaXMubWVudTsKICAgICAgICBtLnJlbmRlcigpOwogICAgICAgIAogICAgICAgIGlmKCFtLmhhc0xheW91dCl7CiAgICAgICAgICAgIG0uZG9MYXlvdXQoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIG5leHRJZHgsIGNoZWNrSXRlbTsKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRoaXMuaXRlbUNvdW50OyBpKyspIHsKICAgICAgICAgICAgbmV4dElkeCA9ICh0aGlzLmFjdGl2ZUl0ZW0uaXRlbUluZGV4ICsgaSkgJSB0aGlzLml0ZW1Db3VudDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNoZWNrSXRlbSA9IG0uaXRlbXMuaXRlbUF0KG5leHRJZHgpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFjaGVja0l0ZW0uZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgIGNoZWNrSXRlbS5zZXRDaGVja2VkKHRydWUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0pOwpFeHQucmVnKCdjeWNsZScsIEV4dC5DeWNsZUJ1dHRvbik7CkV4dC5Ub29sYmFyID0gZnVuY3Rpb24oY29uZmlnKXsKICAgIGlmKEV4dC5pc0FycmF5KGNvbmZpZykpewogICAgICAgIGNvbmZpZyA9IHtpdGVtczogY29uZmlnLCBsYXlvdXQ6ICd0b29sYmFyJ307CiAgICB9IGVsc2UgewogICAgICAgIGNvbmZpZyA9IEV4dC5hcHBseSh7CiAgICAgICAgICAgIGxheW91dDogJ3Rvb2xiYXInCiAgICAgICAgfSwgY29uZmlnKTsKICAgICAgICBpZihjb25maWcuYnV0dG9ucykgewogICAgICAgICAgICBjb25maWcuaXRlbXMgPSBjb25maWcuYnV0dG9uczsKICAgICAgICB9CiAgICB9CiAgICBFeHQuVG9vbGJhci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgY29uZmlnKTsKfTsKCihmdW5jdGlvbigpewoKdmFyIFQgPSBFeHQuVG9vbGJhcjsKCkV4dC5leHRlbmQoVCwgRXh0LkNvbnRhaW5lciwgewoKICAgIGRlZmF1bHRUeXBlOiAnYnV0dG9uJywKCiAgICAKCiAgICBlbmFibGVPdmVyZmxvdyA6IGZhbHNlLAoKICAgIAogICAgCgogICAgdHJhY2tNZW51cyA6IHRydWUsCiAgICBpbnRlcm5hbERlZmF1bHRzOiB7cmVtb3ZlTW9kZTogJ2NvbnRhaW5lcicsIGhpZGVQYXJlbnQ6IHRydWV9LAogICAgdG9vbGJhckNsczogJ3gtdG9vbGJhcicsCgogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgVC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKCiAgICAgICAgCiAgICAgICAgdGhpcy5hZGRFdmVudHMoJ292ZXJmbG93Y2hhbmdlJyk7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIGlmKCF0aGlzLmVsKXsKICAgICAgICAgICAgaWYoIXRoaXMuYXV0b0NyZWF0ZSl7CiAgICAgICAgICAgICAgICB0aGlzLmF1dG9DcmVhdGUgPSB7CiAgICAgICAgICAgICAgICAgICAgY2xzOiB0aGlzLnRvb2xiYXJDbHMgKyAnIHgtc21hbGwtZWRpdG9yJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsID0gY3QuY3JlYXRlQ2hpbGQoRXh0LmFwcGx5KHsgaWQ6IHRoaXMuaWQgfSx0aGlzLmF1dG9DcmVhdGUpLCBwb3NpdGlvbik7CiAgICAgICAgICAgIEV4dC5Ub29sYmFyLnN1cGVyY2xhc3Mub25SZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAoKICAgIAogICAgbG9va3VwQ29tcG9uZW50IDogZnVuY3Rpb24oYyl7CiAgICAgICAgaWYoRXh0LmlzU3RyaW5nKGMpKXsKICAgICAgICAgICAgaWYoYyA9PSAnLScpewogICAgICAgICAgICAgICAgYyA9IG5ldyBULlNlcGFyYXRvcigpOwogICAgICAgICAgICB9ZWxzZSBpZihjID09ICcgJyl7CiAgICAgICAgICAgICAgICBjID0gbmV3IFQuU3BhY2VyKCk7CiAgICAgICAgICAgIH1lbHNlIGlmKGMgPT0gJy0+Jyl7CiAgICAgICAgICAgICAgICBjID0gbmV3IFQuRmlsbCgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGMgPSBuZXcgVC5UZXh0SXRlbShjKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmFwcGx5RGVmYXVsdHMoYyk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGlmKGMuaXNGb3JtRmllbGQgfHwgYy5yZW5kZXIpeyAKICAgICAgICAgICAgICAgIGMgPSB0aGlzLmNyZWF0ZUNvbXBvbmVudChjKTsKICAgICAgICAgICAgfWVsc2UgaWYoYy50YWcpeyAKICAgICAgICAgICAgICAgIGMgPSBuZXcgVC5JdGVtKHthdXRvRWw6IGN9KTsKICAgICAgICAgICAgfWVsc2UgaWYoYy50YWdOYW1lKXsgCiAgICAgICAgICAgICAgICBjID0gbmV3IFQuSXRlbSh7ZWw6Y30pOwogICAgICAgICAgICB9ZWxzZSBpZihFeHQuaXNPYmplY3QoYykpeyAKICAgICAgICAgICAgICAgIGMgPSBjLnh0eXBlID8gdGhpcy5jcmVhdGVDb21wb25lbnQoYykgOiB0aGlzLmNvbnN0cnVjdEJ1dHRvbihjKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYzsKICAgIH0sCgogICAgCiAgICBhcHBseURlZmF1bHRzIDogZnVuY3Rpb24oYyl7CiAgICAgICAgaWYoIUV4dC5pc1N0cmluZyhjKSl7CiAgICAgICAgICAgIGMgPSBFeHQuVG9vbGJhci5zdXBlcmNsYXNzLmFwcGx5RGVmYXVsdHMuY2FsbCh0aGlzLCBjKTsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLmludGVybmFsRGVmYXVsdHM7CiAgICAgICAgICAgIGlmKGMuZXZlbnRzKXsKICAgICAgICAgICAgICAgIEV4dC5hcHBseUlmKGMuaW5pdGlhbENvbmZpZywgZCk7CiAgICAgICAgICAgICAgICBFeHQuYXBwbHkoYywgZCk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgRXh0LmFwcGx5SWYoYywgZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGM7CiAgICB9LAoKICAgIAogICAgYWRkU2VwYXJhdG9yIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5hZGQobmV3IFQuU2VwYXJhdG9yKCkpOwogICAgfSwKCiAgICAKICAgIGFkZFNwYWNlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkKG5ldyBULlNwYWNlcigpKTsKICAgIH0sCgogICAgCiAgICBhZGRGaWxsIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmFkZChuZXcgVC5GaWxsKCkpOwogICAgfSwKCiAgICAKICAgIGFkZEVsZW1lbnQgOiBmdW5jdGlvbihlbCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkSXRlbShuZXcgVC5JdGVtKHtlbDplbH0pKTsKICAgIH0sCgogICAgCiAgICBhZGRJdGVtIDogZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIAogICAgYWRkQnV0dG9uIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBpZihFeHQuaXNBcnJheShjb25maWcpKXsKICAgICAgICAgICAgdmFyIGJ1dHRvbnMgPSBbXTsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gY29uZmlnLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBidXR0b25zLnB1c2godGhpcy5hZGRCdXR0b24oY29uZmlnW2ldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJ1dHRvbnM7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmFkZCh0aGlzLmNvbnN0cnVjdEJ1dHRvbihjb25maWcpKTsKICAgIH0sCgogICAgCiAgICBhZGRUZXh0IDogZnVuY3Rpb24odGV4dCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkSXRlbShuZXcgVC5UZXh0SXRlbSh0ZXh0KSk7CiAgICB9LAoKICAgIAogICAgYWRkRG9tIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICByZXR1cm4gdGhpcy5hZGQobmV3IFQuSXRlbSh7YXV0b0VsOiBjb25maWd9KSk7CiAgICB9LAoKICAgIAogICAgYWRkRmllbGQgOiBmdW5jdGlvbihmaWVsZCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkKGZpZWxkKTsKICAgIH0sCgogICAgCiAgICBpbnNlcnRCdXR0b24gOiBmdW5jdGlvbihpbmRleCwgaXRlbSl7CiAgICAgICAgaWYoRXh0LmlzQXJyYXkoaXRlbSkpewogICAgICAgICAgICB2YXIgYnV0dG9ucyA9IFtdOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBpdGVtLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgIGJ1dHRvbnMucHVzaCh0aGlzLmluc2VydEJ1dHRvbihpbmRleCArIGksIGl0ZW1baV0pKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYnV0dG9uczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEV4dC5Ub29sYmFyLnN1cGVyY2xhc3MuaW5zZXJ0LmNhbGwodGhpcywgaW5kZXgsIGl0ZW0pOwogICAgfSwKCiAgICAKICAgIHRyYWNrTWVudSA6IGZ1bmN0aW9uKGl0ZW0sIHJlbW92ZSl7CiAgICAgICAgaWYodGhpcy50cmFja01lbnVzICYmIGl0ZW0ubWVudSl7CiAgICAgICAgICAgIHZhciBtZXRob2QgPSByZW1vdmUgPyAnbXVuJyA6ICdtb24nOwogICAgICAgICAgICB0aGlzW21ldGhvZF0oaXRlbSwgJ21lbnV0cmlnZ2Vyb3ZlcicsIHRoaXMub25CdXR0b25UcmlnZ2VyT3ZlciwgdGhpcyk7CiAgICAgICAgICAgIHRoaXNbbWV0aG9kXShpdGVtLCAnbWVudXNob3cnLCB0aGlzLm9uQnV0dG9uTWVudVNob3csIHRoaXMpOwogICAgICAgICAgICB0aGlzW21ldGhvZF0oaXRlbSwgJ21lbnVoaWRlJywgdGhpcy5vbkJ1dHRvbk1lbnVIaWRlLCB0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgY29uc3RydWN0QnV0dG9uIDogZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgdmFyIGIgPSBpdGVtLmV2ZW50cyA/IGl0ZW0gOiB0aGlzLmNyZWF0ZUNvbXBvbmVudChpdGVtLCBpdGVtLnNwbGl0ID8gJ3NwbGl0YnV0dG9uJyA6IHRoaXMuZGVmYXVsdFR5cGUpOwogICAgICAgIHJldHVybiBiOwogICAgfSwKCiAgICAKICAgIG9uQWRkIDogZnVuY3Rpb24oYyl7CiAgICAgICAgRXh0LlRvb2xiYXIuc3VwZXJjbGFzcy5vbkFkZC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMudHJhY2tNZW51KGMpOwogICAgICAgIGlmKHRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICBjLmRpc2FibGUoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25SZW1vdmUgOiBmdW5jdGlvbihjKXsKICAgICAgICBFeHQuVG9vbGJhci5zdXBlcmNsYXNzLm9uUmVtb3ZlLmNhbGwodGhpcyk7CiAgICAgICAgaWYgKGMgPT0gdGhpcy5hY3RpdmVNZW51QnRuKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFjdGl2ZU1lbnVCdG47CiAgICAgICAgfQogICAgICAgIHRoaXMudHJhY2tNZW51KGMsIHRydWUpOwogICAgfSwKCiAgICAKICAgIG9uRGlzYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5pdGVtcy5lYWNoKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICAgaWYoaXRlbS5kaXNhYmxlKXsKICAgICAgICAgICAgICAgICBpdGVtLmRpc2FibGUoKTsKICAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICBvbkVuYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5pdGVtcy5lYWNoKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICAgaWYoaXRlbS5lbmFibGUpewogICAgICAgICAgICAgICAgIGl0ZW0uZW5hYmxlKCk7CiAgICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LAoKICAgIAogICAgb25CdXR0b25UcmlnZ2VyT3ZlciA6IGZ1bmN0aW9uKGJ0bil7CiAgICAgICAgaWYodGhpcy5hY3RpdmVNZW51QnRuICYmIHRoaXMuYWN0aXZlTWVudUJ0biAhPSBidG4pewogICAgICAgICAgICB0aGlzLmFjdGl2ZU1lbnVCdG4uaGlkZU1lbnUoKTsKICAgICAgICAgICAgYnRuLnNob3dNZW51KCk7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlTWVudUJ0biA9IGJ0bjsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25CdXR0b25NZW51U2hvdyA6IGZ1bmN0aW9uKGJ0bil7CiAgICAgICAgdGhpcy5hY3RpdmVNZW51QnRuID0gYnRuOwogICAgfSwKCiAgICAKICAgIG9uQnV0dG9uTWVudUhpZGUgOiBmdW5jdGlvbihidG4pewogICAgICAgIGRlbGV0ZSB0aGlzLmFjdGl2ZU1lbnVCdG47CiAgICB9Cn0pOwpFeHQucmVnKCd0b29sYmFyJywgRXh0LlRvb2xiYXIpOwoKClQuSXRlbSA9IEV4dC5leHRlbmQoRXh0LkJveENvbXBvbmVudCwgewogICAgaGlkZVBhcmVudDogdHJ1ZSwgCiAgICBlbmFibGU6RXh0LmVtcHR5Rm4sCiAgICBkaXNhYmxlOkV4dC5lbXB0eUZuLAogICAgZm9jdXM6RXh0LmVtcHR5Rm4KICAgIAp9KTsKRXh0LnJlZygndGJpdGVtJywgVC5JdGVtKTsKCgpULlNlcGFyYXRvciA9IEV4dC5leHRlbmQoVC5JdGVtLCB7CiAgICBvblJlbmRlciA6IGZ1bmN0aW9uKGN0LCBwb3NpdGlvbil7CiAgICAgICAgdGhpcy5lbCA9IGN0LmNyZWF0ZUNoaWxkKHt0YWc6J3NwYW4nLCBjbHM6J3h0Yi1zZXAnfSwgcG9zaXRpb24pOwogICAgfQp9KTsKRXh0LnJlZygndGJzZXBhcmF0b3InLCBULlNlcGFyYXRvcik7CgoKVC5TcGFjZXIgPSBFeHQuZXh0ZW5kKFQuSXRlbSwgewogICAgCgogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIHRoaXMuZWwgPSBjdC5jcmVhdGVDaGlsZCh7dGFnOidkaXYnLCBjbHM6J3h0Yi1zcGFjZXInLCBzdHlsZTogdGhpcy53aWR0aD8nd2lkdGg6Jyt0aGlzLndpZHRoKydweCc6Jyd9LCBwb3NpdGlvbik7CiAgICB9Cn0pOwpFeHQucmVnKCd0YnNwYWNlcicsIFQuU3BhY2VyKTsKCgpULkZpbGwgPSBFeHQuZXh0ZW5kKFQuSXRlbSwgewogICAgCiAgICByZW5kZXIgOiBFeHQuZW1wdHlGbiwKICAgIGlzRmlsbCA6IHRydWUKfSk7CkV4dC5yZWcoJ3RiZmlsbCcsIFQuRmlsbCk7CgoKVC5UZXh0SXRlbSA9IEV4dC5leHRlbmQoVC5JdGVtLCB7CiAgICAKCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBULlRleHRJdGVtLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBFeHQuaXNTdHJpbmcoY29uZmlnKSA/IHt0ZXh0OiBjb25maWd9IDogY29uZmlnKTsKICAgIH0sCgogICAgCiAgICBvblJlbmRlciA6IGZ1bmN0aW9uKGN0LCBwb3NpdGlvbikgewogICAgICAgIHRoaXMuYXV0b0VsID0ge2NsczogJ3h0Yi10ZXh0JywgaHRtbDogdGhpcy50ZXh0IHx8ICcnfTsKICAgICAgICBULlRleHRJdGVtLnN1cGVyY2xhc3Mub25SZW5kZXIuY2FsbCh0aGlzLCBjdCwgcG9zaXRpb24pOwogICAgfSwKCiAgICAKICAgIHNldFRleHQgOiBmdW5jdGlvbih0KSB7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuZWwudXBkYXRlKHQpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLnRleHQgPSB0OwogICAgICAgIH0KICAgIH0KfSk7CkV4dC5yZWcoJ3RidGV4dCcsIFQuVGV4dEl0ZW0pOwoKClQuQnV0dG9uID0gRXh0LmV4dGVuZChFeHQuQnV0dG9uLCB7fSk7ClQuU3BsaXRCdXR0b24gPSBFeHQuZXh0ZW5kKEV4dC5TcGxpdEJ1dHRvbiwge30pOwpFeHQucmVnKCd0YmJ1dHRvbicsIFQuQnV0dG9uKTsKRXh0LnJlZygndGJzcGxpdCcsIFQuU3BsaXRCdXR0b24pOwoKfSkoKTsKCkV4dC5CdXR0b25Hcm91cCA9IEV4dC5leHRlbmQoRXh0LlBhbmVsLCB7CiAgICAKICAgIAogICAgYmFzZUNsczogJ3gtYnRuLWdyb3VwJywKICAgIAogICAgbGF5b3V0Oid0YWJsZScsCiAgICBkZWZhdWx0VHlwZTogJ2J1dHRvbicsCiAgICAKICAgIGZyYW1lOiB0cnVlLAogICAgaW50ZXJuYWxEZWZhdWx0czoge3JlbW92ZU1vZGU6ICdjb250YWluZXInLCBoaWRlUGFyZW50OiB0cnVlfSwKCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmxheW91dENvbmZpZyA9IHRoaXMubGF5b3V0Q29uZmlnIHx8IHt9OwogICAgICAgIEV4dC5hcHBseUlmKHRoaXMubGF5b3V0Q29uZmlnLCB7CiAgICAgICAgICAgIGNvbHVtbnMgOiB0aGlzLmNvbHVtbnMKICAgICAgICB9KTsKICAgICAgICBpZighdGhpcy50aXRsZSl7CiAgICAgICAgICAgIHRoaXMuYWRkQ2xhc3MoJ3gtYnRuLWdyb3VwLW5vdGl0bGUnKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5vbignYWZ0ZXJsYXlvdXQnLCB0aGlzLm9uQWZ0ZXJMYXlvdXQsIHRoaXMpOwogICAgICAgIEV4dC5CdXR0b25Hcm91cC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgYXBwbHlEZWZhdWx0cyA6IGZ1bmN0aW9uKGMpewogICAgICAgIGMgPSBFeHQuQnV0dG9uR3JvdXAuc3VwZXJjbGFzcy5hcHBseURlZmF1bHRzLmNhbGwodGhpcywgYyk7CiAgICAgICAgdmFyIGQgPSB0aGlzLmludGVybmFsRGVmYXVsdHM7CiAgICAgICAgaWYoYy5ldmVudHMpewogICAgICAgICAgICBFeHQuYXBwbHlJZihjLmluaXRpYWxDb25maWcsIGQpOwogICAgICAgICAgICBFeHQuYXBwbHkoYywgZCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIEV4dC5hcHBseUlmKGMsIGQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYzsKICAgIH0sCgogICAgb25BZnRlckxheW91dCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGJvZHlXaWR0aCA9IHRoaXMuYm9keS5nZXRGcmFtZVdpZHRoKCdscicpICsgdGhpcy5ib2R5LmRvbS5maXJzdENoaWxkLm9mZnNldFdpZHRoOwogICAgICAgIHRoaXMuYm9keS5zZXRXaWR0aChib2R5V2lkdGgpOwogICAgICAgIHRoaXMuZWwuc2V0V2lkdGgoYm9keVdpZHRoICsgdGhpcy5nZXRGcmFtZVdpZHRoKCkpOwogICAgfQogICAgCn0pOwoKRXh0LnJlZygnYnV0dG9uZ3JvdXAnLCBFeHQuQnV0dG9uR3JvdXApOwoKKGZ1bmN0aW9uKCkgewoKdmFyIFQgPSBFeHQuVG9vbGJhcjsKCkV4dC5QYWdpbmdUb29sYmFyID0gRXh0LmV4dGVuZChFeHQuVG9vbGJhciwgewogICAgCiAgICAKICAgIAogICAgcGFnZVNpemUgOiAyMCwKICAgIAogICAgCiAgICBkaXNwbGF5TXNnIDogJ0Rpc3BsYXlpbmcgezB9IC0gezF9IG9mIHsyfScsCiAgICAKICAgIGVtcHR5TXNnIDogJ05vIGRhdGEgdG8gZGlzcGxheScsCiAgICAKICAgIGJlZm9yZVBhZ2VUZXh0IDogJ1BhZ2UnLAogICAgCiAgICBhZnRlclBhZ2VUZXh0IDogJ29mIHswfScsCiAgICAKICAgIGZpcnN0VGV4dCA6ICdGaXJzdCBQYWdlJywKICAgIAogICAgcHJldlRleHQgOiAnUHJldmlvdXMgUGFnZScsCiAgICAKICAgIG5leHRUZXh0IDogJ05leHQgUGFnZScsCiAgICAKICAgIGxhc3RUZXh0IDogJ0xhc3QgUGFnZScsCiAgICAKICAgIHJlZnJlc2hUZXh0IDogJ1JlZnJlc2gnLAoKICAgIAoKICAgIAoKICAgIAoKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBwYWdpbmdJdGVtcyA9IFt0aGlzLmZpcnN0ID0gbmV3IFQuQnV0dG9uKHsKICAgICAgICAgICAgdG9vbHRpcDogdGhpcy5maXJzdFRleHQsCiAgICAgICAgICAgIG92ZXJmbG93VGV4dDogdGhpcy5maXJzdFRleHQsCiAgICAgICAgICAgIGljb25DbHM6ICd4LXRiYXItcGFnZS1maXJzdCcsCiAgICAgICAgICAgIGRpc2FibGVkOiB0cnVlLAogICAgICAgICAgICBoYW5kbGVyOiB0aGlzLm1vdmVGaXJzdCwKICAgICAgICAgICAgc2NvcGU6IHRoaXMKICAgICAgICB9KSwgdGhpcy5wcmV2ID0gbmV3IFQuQnV0dG9uKHsKICAgICAgICAgICAgdG9vbHRpcDogdGhpcy5wcmV2VGV4dCwKICAgICAgICAgICAgb3ZlcmZsb3dUZXh0OiB0aGlzLnByZXZUZXh0LAogICAgICAgICAgICBpY29uQ2xzOiAneC10YmFyLXBhZ2UtcHJldicsCiAgICAgICAgICAgIGRpc2FibGVkOiB0cnVlLAogICAgICAgICAgICBoYW5kbGVyOiB0aGlzLm1vdmVQcmV2aW91cywKICAgICAgICAgICAgc2NvcGU6IHRoaXMKICAgICAgICB9KSwgJy0nLCB0aGlzLmJlZm9yZVBhZ2VUZXh0LAogICAgICAgIHRoaXMuaW5wdXRJdGVtID0gbmV3IEV4dC5mb3JtLk51bWJlckZpZWxkKHsKICAgICAgICAgICAgY2xzOiAneC10YmFyLXBhZ2UtbnVtYmVyJywKICAgICAgICAgICAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgICAgICAgICAgIGFsbG93TmVnYXRpdmU6IGZhbHNlLAogICAgICAgICAgICBlbmFibGVLZXlFdmVudHM6IHRydWUsCiAgICAgICAgICAgIHNlbGVjdE9uRm9jdXM6IHRydWUsCiAgICAgICAgICAgIHN1Ym1pdFZhbHVlOiBmYWxzZSwKICAgICAgICAgICAgbGlzdGVuZXJzOiB7CiAgICAgICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgICAgIGtleWRvd246IHRoaXMub25QYWdpbmdLZXlEb3duLAogICAgICAgICAgICAgICAgYmx1cjogdGhpcy5vblBhZ2luZ0JsdXIKICAgICAgICAgICAgfQogICAgICAgIH0pLCB0aGlzLmFmdGVyVGV4dEl0ZW0gPSBuZXcgVC5UZXh0SXRlbSh7CiAgICAgICAgICAgIHRleHQ6IFN0cmluZy5mb3JtYXQodGhpcy5hZnRlclBhZ2VUZXh0LCAxKQogICAgICAgIH0pLCAnLScsIHRoaXMubmV4dCA9IG5ldyBULkJ1dHRvbih7CiAgICAgICAgICAgIHRvb2x0aXA6IHRoaXMubmV4dFRleHQsCiAgICAgICAgICAgIG92ZXJmbG93VGV4dDogdGhpcy5uZXh0VGV4dCwKICAgICAgICAgICAgaWNvbkNsczogJ3gtdGJhci1wYWdlLW5leHQnLAogICAgICAgICAgICBkaXNhYmxlZDogdHJ1ZSwKICAgICAgICAgICAgaGFuZGxlcjogdGhpcy5tb3ZlTmV4dCwKICAgICAgICAgICAgc2NvcGU6IHRoaXMKICAgICAgICB9KSwgdGhpcy5sYXN0ID0gbmV3IFQuQnV0dG9uKHsKICAgICAgICAgICAgdG9vbHRpcDogdGhpcy5sYXN0VGV4dCwKICAgICAgICAgICAgb3ZlcmZsb3dUZXh0OiB0aGlzLmxhc3RUZXh0LAogICAgICAgICAgICBpY29uQ2xzOiAneC10YmFyLXBhZ2UtbGFzdCcsCiAgICAgICAgICAgIGRpc2FibGVkOiB0cnVlLAogICAgICAgICAgICBoYW5kbGVyOiB0aGlzLm1vdmVMYXN0LAogICAgICAgICAgICBzY29wZTogdGhpcwogICAgICAgIH0pLCAnLScsIHRoaXMucmVmcmVzaCA9IG5ldyBULkJ1dHRvbih7CiAgICAgICAgICAgIHRvb2x0aXA6IHRoaXMucmVmcmVzaFRleHQsCiAgICAgICAgICAgIG92ZXJmbG93VGV4dDogdGhpcy5yZWZyZXNoVGV4dCwKICAgICAgICAgICAgaWNvbkNsczogJ3gtdGJhci1sb2FkaW5nJywKICAgICAgICAgICAgaGFuZGxlcjogdGhpcy5kb1JlZnJlc2gsCiAgICAgICAgICAgIHNjb3BlOiB0aGlzCiAgICAgICAgfSldOwoKCiAgICAgICAgdmFyIHVzZXJJdGVtcyA9IHRoaXMuaXRlbXMgfHwgdGhpcy5idXR0b25zIHx8IFtdOwogICAgICAgIGlmICh0aGlzLnByZXBlbmRCdXR0b25zKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXMgPSB1c2VySXRlbXMuY29uY2F0KHBhZ2luZ0l0ZW1zKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5pdGVtcyA9IHBhZ2luZ0l0ZW1zLmNvbmNhdCh1c2VySXRlbXMpOwogICAgICAgIH0KICAgICAgICBkZWxldGUgdGhpcy5idXR0b25zOwogICAgICAgIGlmKHRoaXMuZGlzcGxheUluZm8pewogICAgICAgICAgICB0aGlzLml0ZW1zLnB1c2goJy0+Jyk7CiAgICAgICAgICAgIHRoaXMuaXRlbXMucHVzaCh0aGlzLmRpc3BsYXlJdGVtID0gbmV3IFQuVGV4dEl0ZW0oe30pKTsKICAgICAgICB9CiAgICAgICAgRXh0LlBhZ2luZ1Rvb2xiYXIuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAnY2hhbmdlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVjaGFuZ2UnCiAgICAgICAgKTsKICAgICAgICB0aGlzLm9uKCdhZnRlcmxheW91dCcsIHRoaXMub25GaXJzdExheW91dCwgdGhpcywge3NpbmdsZTogdHJ1ZX0pOwogICAgICAgIHRoaXMuY3Vyc29yID0gMDsKICAgICAgICB0aGlzLmJpbmRTdG9yZSh0aGlzLnN0b3JlLCB0cnVlKTsKICAgIH0sCgogICAgCiAgICBvbkZpcnN0TGF5b3V0IDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmRzTG9hZGVkKXsKICAgICAgICAgICAgdGhpcy5vbkxvYWQuYXBwbHkodGhpcywgdGhpcy5kc0xvYWRlZCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHVwZGF0ZUluZm8gOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuZGlzcGxheUl0ZW0pewogICAgICAgICAgICB2YXIgY291bnQgPSB0aGlzLnN0b3JlLmdldENvdW50KCk7CiAgICAgICAgICAgIHZhciBtc2cgPSBjb3VudCA9PSAwID8KICAgICAgICAgICAgICAgIHRoaXMuZW1wdHlNc2cgOgogICAgICAgICAgICAgICAgU3RyaW5nLmZvcm1hdCgKICAgICAgICAgICAgICAgICAgICB0aGlzLmRpc3BsYXlNc2csCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJzb3IrMSwgdGhpcy5jdXJzb3IrY291bnQsIHRoaXMuc3RvcmUuZ2V0VG90YWxDb3VudCgpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLmRpc3BsYXlJdGVtLnNldFRleHQobXNnKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25Mb2FkIDogZnVuY3Rpb24oc3RvcmUsIHIsIG8pewogICAgICAgIGlmKCF0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy5kc0xvYWRlZCA9IFtzdG9yZSwgciwgb107CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHAgPSB0aGlzLmdldFBhcmFtcygpOwogICAgICAgIHRoaXMuY3Vyc29yID0gKG8ucGFyYW1zICYmIG8ucGFyYW1zW3Auc3RhcnRdKSA/IG8ucGFyYW1zW3Auc3RhcnRdIDogMDsKICAgICAgICB2YXIgZCA9IHRoaXMuZ2V0UGFnZURhdGEoKSwgYXAgPSBkLmFjdGl2ZVBhZ2UsIHBzID0gZC5wYWdlczsKCiAgICAgICAgdGhpcy5hZnRlclRleHRJdGVtLnNldFRleHQoU3RyaW5nLmZvcm1hdCh0aGlzLmFmdGVyUGFnZVRleHQsIGQucGFnZXMpKTsKICAgICAgICB0aGlzLmlucHV0SXRlbS5zZXRWYWx1ZShhcCk7CiAgICAgICAgdGhpcy5maXJzdC5zZXREaXNhYmxlZChhcCA9PSAxKTsKICAgICAgICB0aGlzLnByZXYuc2V0RGlzYWJsZWQoYXAgPT0gMSk7CiAgICAgICAgdGhpcy5uZXh0LnNldERpc2FibGVkKGFwID09IHBzKTsKICAgICAgICB0aGlzLmxhc3Quc2V0RGlzYWJsZWQoYXAgPT0gcHMpOwogICAgICAgIHRoaXMucmVmcmVzaC5lbmFibGUoKTsKICAgICAgICB0aGlzLnVwZGF0ZUluZm8oKTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnY2hhbmdlJywgdGhpcywgZCk7CiAgICB9LAoKICAgIAogICAgZ2V0UGFnZURhdGEgOiBmdW5jdGlvbigpewogICAgICAgIHZhciB0b3RhbCA9IHRoaXMuc3RvcmUuZ2V0VG90YWxDb3VudCgpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHRvdGFsIDogdG90YWwsCiAgICAgICAgICAgIGFjdGl2ZVBhZ2UgOiBNYXRoLmNlaWwoKHRoaXMuY3Vyc29yK3RoaXMucGFnZVNpemUpL3RoaXMucGFnZVNpemUpLAogICAgICAgICAgICBwYWdlcyA6ICB0b3RhbCA8IHRoaXMucGFnZVNpemUgPyAxIDogTWF0aC5jZWlsKHRvdGFsL3RoaXMucGFnZVNpemUpCiAgICAgICAgfTsKICAgIH0sCgogICAgCiAgICBjaGFuZ2VQYWdlIDogZnVuY3Rpb24ocGFnZSl7CiAgICAgICAgdGhpcy5kb0xvYWQoKChwYWdlLTEpICogdGhpcy5wYWdlU2l6ZSkuY29uc3RyYWluKDAsIHRoaXMuc3RvcmUuZ2V0VG90YWxDb3VudCgpKSk7CiAgICB9LAoKICAgIAogICAgb25Mb2FkRXJyb3IgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLnJlZnJlc2guZW5hYmxlKCk7CiAgICB9LAoKICAgIAogICAgcmVhZFBhZ2UgOiBmdW5jdGlvbihkKXsKICAgICAgICB2YXIgdiA9IHRoaXMuaW5wdXRJdGVtLmdldFZhbHVlKCksIHBhZ2VOdW07CiAgICAgICAgaWYgKCF2IHx8IGlzTmFOKHBhZ2VOdW0gPSBwYXJzZUludCh2LCAxMCkpKSB7CiAgICAgICAgICAgIHRoaXMuaW5wdXRJdGVtLnNldFZhbHVlKGQuYWN0aXZlUGFnZSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBhZ2VOdW07CiAgICB9LAoKICAgIG9uUGFnaW5nRm9jdXMgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuaW5wdXRJdGVtLnNlbGVjdCgpOwogICAgfSwKCiAgICAKICAgIG9uUGFnaW5nQmx1ciA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMuaW5wdXRJdGVtLnNldFZhbHVlKHRoaXMuZ2V0UGFnZURhdGEoKS5hY3RpdmVQYWdlKTsKICAgIH0sCgogICAgCiAgICBvblBhZ2luZ0tleURvd24gOiBmdW5jdGlvbihmaWVsZCwgZSl7CiAgICAgICAgdmFyIGsgPSBlLmdldEtleSgpLCBkID0gdGhpcy5nZXRQYWdlRGF0YSgpLCBwYWdlTnVtOwogICAgICAgIGlmIChrID09IGUuUkVUVVJOKSB7CiAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgIHBhZ2VOdW0gPSB0aGlzLnJlYWRQYWdlKGQpOwogICAgICAgICAgICBpZihwYWdlTnVtICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICBwYWdlTnVtID0gTWF0aC5taW4oTWF0aC5tYXgoMSwgcGFnZU51bSksIGQucGFnZXMpIC0gMTsKICAgICAgICAgICAgICAgIHRoaXMuZG9Mb2FkKHBhZ2VOdW0gKiB0aGlzLnBhZ2VTaXplKTsKICAgICAgICAgICAgfQogICAgICAgIH1lbHNlIGlmIChrID09IGUuSE9NRSB8fCBrID09IGUuRU5EKXsKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgcGFnZU51bSA9IGsgPT0gZS5IT01FID8gMSA6IGQucGFnZXM7CiAgICAgICAgICAgIGZpZWxkLnNldFZhbHVlKHBhZ2VOdW0pOwogICAgICAgIH1lbHNlIGlmIChrID09IGUuVVAgfHwgayA9PSBlLlBBR0VVUCB8fCBrID09IGUuRE9XTiB8fCBrID09IGUuUEFHRURPV04pewogICAgICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgICAgICBpZigocGFnZU51bSA9IHRoaXMucmVhZFBhZ2UoZCkpKXsKICAgICAgICAgICAgICAgIHZhciBpbmNyZW1lbnQgPSBlLnNoaWZ0S2V5ID8gMTAgOiAxOwogICAgICAgICAgICAgICAgaWYoayA9PSBlLkRPV04gfHwgayA9PSBlLlBBR0VET1dOKXsKICAgICAgICAgICAgICAgICAgICBpbmNyZW1lbnQgKj0gLTE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYWdlTnVtICs9IGluY3JlbWVudDsKICAgICAgICAgICAgICAgIGlmKHBhZ2VOdW0gPj0gMSAmIHBhZ2VOdW0gPD0gZC5wYWdlcyl7CiAgICAgICAgICAgICAgICAgICAgZmllbGQuc2V0VmFsdWUocGFnZU51bSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0UGFyYW1zIDogZnVuY3Rpb24oKXsKICAgICAgICAKICAgICAgICByZXR1cm4gdGhpcy5wYXJhbU5hbWVzIHx8IHRoaXMuc3RvcmUucGFyYW1OYW1lczsKICAgIH0sCgogICAgCiAgICBiZWZvcmVMb2FkIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkICYmIHRoaXMucmVmcmVzaCl7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaC5kaXNhYmxlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRvTG9hZCA6IGZ1bmN0aW9uKHN0YXJ0KXsKICAgICAgICB2YXIgbyA9IHt9LCBwbiA9IHRoaXMuZ2V0UGFyYW1zKCk7CiAgICAgICAgb1twbi5zdGFydF0gPSBzdGFydDsKICAgICAgICBvW3BuLmxpbWl0XSA9IHRoaXMucGFnZVNpemU7CiAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoJ2JlZm9yZWNoYW5nZScsIHRoaXMsIG8pICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuc3RvcmUubG9hZCh7cGFyYW1zOm99KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgbW92ZUZpcnN0IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmRvTG9hZCgwKTsKICAgIH0sCgogICAgCiAgICBtb3ZlUHJldmlvdXMgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZG9Mb2FkKE1hdGgubWF4KDAsIHRoaXMuY3Vyc29yLXRoaXMucGFnZVNpemUpKTsKICAgIH0sCgogICAgCiAgICBtb3ZlTmV4dCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5kb0xvYWQodGhpcy5jdXJzb3IrdGhpcy5wYWdlU2l6ZSk7CiAgICB9LAoKICAgIAogICAgbW92ZUxhc3QgOiBmdW5jdGlvbigpewogICAgICAgIHZhciB0b3RhbCA9IHRoaXMuc3RvcmUuZ2V0VG90YWxDb3VudCgpLAogICAgICAgICAgICBleHRyYSA9IHRvdGFsICUgdGhpcy5wYWdlU2l6ZTsKCiAgICAgICAgdGhpcy5kb0xvYWQoZXh0cmEgPyAodG90YWwgLSBleHRyYSkgOiB0b3RhbCAtIHRoaXMucGFnZVNpemUpOwogICAgfSwKCiAgICAKICAgIGRvUmVmcmVzaCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5kb0xvYWQodGhpcy5jdXJzb3IpOwogICAgfSwKCiAgICAKICAgIGJpbmRTdG9yZSA6IGZ1bmN0aW9uKHN0b3JlLCBpbml0aWFsKXsKICAgICAgICB2YXIgZG9Mb2FkOwogICAgICAgIGlmKCFpbml0aWFsICYmIHRoaXMuc3RvcmUpewogICAgICAgICAgICBpZihzdG9yZSAhPT0gdGhpcy5zdG9yZSAmJiB0aGlzLnN0b3JlLmF1dG9EZXN0cm95KXsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUuZGVzdHJveSgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oJ2JlZm9yZWxvYWQnLCB0aGlzLmJlZm9yZUxvYWQsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5zdG9yZS51bignbG9hZCcsIHRoaXMub25Mb2FkLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oJ2V4Y2VwdGlvbicsIHRoaXMub25Mb2FkRXJyb3IsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzdG9yZSl7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZihzdG9yZSl7CiAgICAgICAgICAgIHN0b3JlID0gRXh0LlN0b3JlTWdyLmxvb2t1cChzdG9yZSk7CiAgICAgICAgICAgIHN0b3JlLm9uKHsKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgYmVmb3JlbG9hZDogdGhpcy5iZWZvcmVMb2FkLAogICAgICAgICAgICAgICAgbG9hZDogdGhpcy5vbkxvYWQsCiAgICAgICAgICAgICAgICBleGNlcHRpb246IHRoaXMub25Mb2FkRXJyb3IKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRvTG9hZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZTsKICAgICAgICBpZihkb0xvYWQpewogICAgICAgICAgICB0aGlzLm9uTG9hZChzdG9yZSwgbnVsbCwge30pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICB1bmJpbmQgOiBmdW5jdGlvbihzdG9yZSl7CiAgICAgICAgdGhpcy5iaW5kU3RvcmUobnVsbCk7CiAgICB9LAoKICAgIAogICAgYmluZCA6IGZ1bmN0aW9uKHN0b3JlKXsKICAgICAgICB0aGlzLmJpbmRTdG9yZShzdG9yZSk7CiAgICB9LAoKICAgIAogICAgb25EZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmJpbmRTdG9yZShudWxsKTsKICAgICAgICBFeHQuUGFnaW5nVG9vbGJhci5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgfQp9KTsKCn0pKCk7CkV4dC5yZWcoJ3BhZ2luZycsIEV4dC5QYWdpbmdUb29sYmFyKTsKRXh0Lkhpc3RvcnkgPSAoZnVuY3Rpb24gKCkgewogICAgdmFyIGlmcmFtZSwgaGlkZGVuRmllbGQ7CiAgICB2YXIgcmVhZHkgPSBmYWxzZTsKICAgIHZhciBjdXJyZW50VG9rZW47CgogICAgZnVuY3Rpb24gZ2V0SGFzaCgpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYsIGkgPSBocmVmLmluZGV4T2YoIiMiKSwKICAgICAgICAgICAgaGFzaCA9IGkgPj0gMCA/IGhyZWYuc3Vic3RyKGkgKyAxKSA6IG51bGw7CiAgICAgICAgICAgICAKICAgICAgICBpZiAoRXh0LmlzR2Vja28pIHsKICAgICAgICAgICAgaGFzaCA9IGRlY29kZVVSSUNvbXBvbmVudChoYXNoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGhhc2g7CiAgICB9CgogICAgZnVuY3Rpb24gZG9TYXZlKCkgewogICAgICAgIGhpZGRlbkZpZWxkLnZhbHVlID0gY3VycmVudFRva2VuOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZVN0YXRlQ2hhbmdlKHRva2VuKSB7CiAgICAgICAgY3VycmVudFRva2VuID0gdG9rZW47CiAgICAgICAgRXh0Lkhpc3RvcnkuZmlyZUV2ZW50KCdjaGFuZ2UnLCB0b2tlbik7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlSUZyYW1lICh0b2tlbikgewogICAgICAgIHZhciBodG1sID0gWyc8aHRtbD48Ym9keT48ZGl2IGlkPSJzdGF0ZSI+JyxFeHQudXRpbC5Gb3JtYXQuaHRtbEVuY29kZSh0b2tlbiksJzwvZGl2PjwvYm9keT48L2h0bWw+J10uam9pbignJyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGRvYyA9IGlmcmFtZS5jb250ZW50V2luZG93LmRvY3VtZW50OwogICAgICAgICAgICBkb2Mub3BlbigpOwogICAgICAgICAgICBkb2Mud3JpdGUoaHRtbCk7CiAgICAgICAgICAgIGRvYy5jbG9zZSgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tJRnJhbWUoKSB7CiAgICAgICAgaWYgKCFpZnJhbWUuY29udGVudFdpbmRvdyB8fCAhaWZyYW1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQpIHsKICAgICAgICAgICAgc2V0VGltZW91dChjaGVja0lGcmFtZSwgMTApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgZG9jID0gaWZyYW1lLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7CiAgICAgICAgdmFyIGVsZW0gPSBkb2MuZ2V0RWxlbWVudEJ5SWQoInN0YXRlIik7CiAgICAgICAgdmFyIHRva2VuID0gZWxlbSA/IGVsZW0uaW5uZXJUZXh0IDogbnVsbDsKCiAgICAgICAgdmFyIGhhc2ggPSBnZXRIYXNoKCk7CgogICAgICAgIHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIGRvYyA9IGlmcmFtZS5jb250ZW50V2luZG93LmRvY3VtZW50OwogICAgICAgICAgICBlbGVtID0gZG9jLmdldEVsZW1lbnRCeUlkKCJzdGF0ZSIpOwoKICAgICAgICAgICAgdmFyIG5ld3Rva2VuID0gZWxlbSA/IGVsZW0uaW5uZXJUZXh0IDogbnVsbDsKCiAgICAgICAgICAgIHZhciBuZXdIYXNoID0gZ2V0SGFzaCgpOwoKICAgICAgICAgICAgaWYgKG5ld3Rva2VuICE9PSB0b2tlbikgewogICAgICAgICAgICAgICAgdG9rZW4gPSBuZXd0b2tlbjsKICAgICAgICAgICAgICAgIGhhbmRsZVN0YXRlQ2hhbmdlKHRva2VuKTsKICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhhc2ggPSB0b2tlbjsKICAgICAgICAgICAgICAgIGhhc2ggPSB0b2tlbjsKICAgICAgICAgICAgICAgIGRvU2F2ZSgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5ld0hhc2ggIT09IGhhc2gpIHsKICAgICAgICAgICAgICAgIGhhc2ggPSBuZXdIYXNoOwogICAgICAgICAgICAgICAgdXBkYXRlSUZyYW1lKG5ld0hhc2gpOwogICAgICAgICAgICB9CgogICAgICAgIH0sIDUwKTsKCiAgICAgICAgcmVhZHkgPSB0cnVlOwoKICAgICAgICBFeHQuSGlzdG9yeS5maXJlRXZlbnQoJ3JlYWR5JywgRXh0Lkhpc3RvcnkpOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0YXJ0VXAoKSB7CiAgICAgICAgY3VycmVudFRva2VuID0gaGlkZGVuRmllbGQudmFsdWUgPyBoaWRkZW5GaWVsZC52YWx1ZSA6IGdldEhhc2goKTsKCiAgICAgICAgaWYgKEV4dC5pc0lFKSB7CiAgICAgICAgICAgIGNoZWNrSUZyYW1lKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGhhc2ggPSBnZXRIYXNoKCk7CiAgICAgICAgICAgIHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBuZXdIYXNoID0gZ2V0SGFzaCgpOwogICAgICAgICAgICAgICAgaWYgKG5ld0hhc2ggIT09IGhhc2gpIHsKICAgICAgICAgICAgICAgICAgICBoYXNoID0gbmV3SGFzaDsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVTdGF0ZUNoYW5nZShoYXNoKTsKICAgICAgICAgICAgICAgICAgICBkb1NhdmUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICByZWFkeSA9IHRydWU7CiAgICAgICAgICAgIEV4dC5IaXN0b3J5LmZpcmVFdmVudCgncmVhZHknLCBFeHQuSGlzdG9yeSk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgICAgCiAgICAgICAgZmllbGRJZDogJ3gtaGlzdG9yeS1maWVsZCcsCiAgICAgICAgCiAgICAgICAgaWZyYW1lSWQ6ICd4LWhpc3RvcnktZnJhbWUnLAoKICAgICAgICBldmVudHM6e30sCgogICAgICAgIAogICAgICAgIGluaXQ6IGZ1bmN0aW9uIChvblJlYWR5LCBzY29wZSkgewogICAgICAgICAgICBpZihyZWFkeSkgewogICAgICAgICAgICAgICAgRXh0LmNhbGxiYWNrKG9uUmVhZHksIHNjb3BlLCBbdGhpc10pOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFFeHQuaXNSZWFkeSl7CiAgICAgICAgICAgICAgICBFeHQub25SZWFkeShmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIEV4dC5IaXN0b3J5LmluaXQob25SZWFkeSwgc2NvcGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGlkZGVuRmllbGQgPSBFeHQuZ2V0RG9tKEV4dC5IaXN0b3J5LmZpZWxkSWQpOwogICAgICAgICAgICBpZiAoRXh0LmlzSUUpIHsKICAgICAgICAgICAgICAgIGlmcmFtZSA9IEV4dC5nZXREb20oRXh0Lkhpc3RvcnkuaWZyYW1lSWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAncmVhZHknLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAnY2hhbmdlJwogICAgICAgICAgICApOwogICAgICAgICAgICBpZihvblJlYWR5KXsKICAgICAgICAgICAgICAgIHRoaXMub24oJ3JlYWR5Jywgb25SZWFkeSwgc2NvcGUsIHtzaW5nbGU6dHJ1ZX0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0YXJ0VXAoKTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBhZGQ6IGZ1bmN0aW9uICh0b2tlbiwgcHJldmVudER1cCkgewogICAgICAgICAgICBpZihwcmV2ZW50RHVwICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICBpZih0aGlzLmdldFRva2VuKCkgPT0gdG9rZW4pewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChFeHQuaXNJRSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlGcmFtZSh0b2tlbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsb2NhdGlvbi5oYXNoID0gdG9rZW47CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGJhY2s6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGhpc3RvcnkuZ28oLTEpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIGZvcndhcmQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGhpc3RvcnkuZ28oMSk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZ2V0VG9rZW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gcmVhZHkgPyBjdXJyZW50VG9rZW4gOiBnZXRIYXNoKCk7CiAgICAgICAgfQogICAgfTsKfSkoKTsKRXh0LmFwcGx5KEV4dC5IaXN0b3J5LCBuZXcgRXh0LnV0aWwuT2JzZXJ2YWJsZSgpKTsKRXh0LlRpcCA9IEV4dC5leHRlbmQoRXh0LlBhbmVsLCB7CiAgICAKICAgIAogICAgCiAgICBtaW5XaWR0aCA6IDQwLAogICAgCiAgICBtYXhXaWR0aCA6IDMwMCwKICAgIAogICAgc2hhZG93IDogInNpZGVzIiwKICAgIAogICAgZGVmYXVsdEFsaWduIDogInRsLWJsPyIsCiAgICBhdXRvUmVuZGVyOiB0cnVlLAogICAgcXVpY2tTaG93SW50ZXJ2YWwgOiAyNTAsCgogICAgCiAgICBmcmFtZTp0cnVlLAogICAgaGlkZGVuOnRydWUsCiAgICBiYXNlQ2xzOiAneC10aXAnLAogICAgZmxvYXRpbmc6e3NoYWRvdzp0cnVlLHNoaW06dHJ1ZSx1c2VEaXNwbGF5OnRydWUsY29uc3RyYWluOmZhbHNlfSwKICAgIGF1dG9IZWlnaHQ6dHJ1ZSwKCiAgICBjbG9zZUFjdGlvbjogJ2hpZGUnLAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LlRpcC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLmNsb3NhYmxlICYmICF0aGlzLnRpdGxlKXsKICAgICAgICAgICAgdGhpcy5lbGVtZW50cyArPSAnLGhlYWRlcic7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFmdGVyUmVuZGVyIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuVGlwLnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLmNsb3NhYmxlKXsKICAgICAgICAgICAgdGhpcy5hZGRUb29sKHsKICAgICAgICAgICAgICAgIGlkOiAnY2xvc2UnLAogICAgICAgICAgICAgICAgaGFuZGxlcjogdGhpc1t0aGlzLmNsb3NlQWN0aW9uXSwKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzaG93QXQgOiBmdW5jdGlvbih4eSl7CiAgICAgICAgRXh0LlRpcC5zdXBlcmNsYXNzLnNob3cuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLm1lYXN1cmVXaWR0aCAhPT0gZmFsc2UgJiYgKCF0aGlzLmluaXRpYWxDb25maWcgfHwgdHlwZW9mIHRoaXMuaW5pdGlhbENvbmZpZy53aWR0aCAhPSAnbnVtYmVyJykpewogICAgICAgICAgICB0aGlzLmRvQXV0b1dpZHRoKCk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuY29uc3RyYWluUG9zaXRpb24pewogICAgICAgICAgICB4eSA9IHRoaXMuZWwuYWRqdXN0Rm9yQ29uc3RyYWludHMoeHkpOwogICAgICAgIH0KICAgICAgICB0aGlzLnNldFBhZ2VQb3NpdGlvbih4eVswXSwgeHlbMV0pOwogICAgfSwKCiAgICAKICAgIGRvQXV0b1dpZHRoIDogZnVuY3Rpb24oYWRqdXN0KXsKICAgICAgICBhZGp1c3QgPSBhZGp1c3QgfHwgMDsKICAgICAgICB2YXIgYncgPSB0aGlzLmJvZHkuZ2V0VGV4dFdpZHRoKCk7CiAgICAgICAgaWYodGhpcy50aXRsZSl7CiAgICAgICAgICAgIGJ3ID0gTWF0aC5tYXgoYncsIHRoaXMuaGVhZGVyLmNoaWxkKCdzcGFuJykuZ2V0VGV4dFdpZHRoKHRoaXMudGl0bGUpKTsKICAgICAgICB9CiAgICAgICAgYncgKz0gdGhpcy5nZXRGcmFtZVdpZHRoKCkgKyAodGhpcy5jbG9zYWJsZSA/IDIwIDogMCkgKyB0aGlzLmJvZHkuZ2V0UGFkZGluZygibHIiKSArIGFkanVzdDsKICAgICAgICB0aGlzLnNldFdpZHRoKGJ3LmNvbnN0cmFpbih0aGlzLm1pbldpZHRoLCB0aGlzLm1heFdpZHRoKSk7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgaWYoRXh0LmlzSUU3ICYmICF0aGlzLnJlcGFpbnRlZCl7CiAgICAgICAgICAgIHRoaXMuZWwucmVwYWludCgpOwogICAgICAgICAgICB0aGlzLnJlcGFpbnRlZCA9IHRydWU7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNob3dCeSA6IGZ1bmN0aW9uKGVsLCBwb3MpewogICAgICAgIGlmKCF0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy5yZW5kZXIoRXh0LmdldEJvZHkoKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2hvd0F0KHRoaXMuZWwuZ2V0QWxpZ25Ub1hZKGVsLCBwb3MgfHwgdGhpcy5kZWZhdWx0QWxpZ24pKTsKICAgIH0sCgogICAgaW5pdERyYWdnYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5kZCA9IG5ldyBFeHQuVGlwLkREKHRoaXMsIHR5cGVvZiB0aGlzLmRyYWdnYWJsZSA9PSAnYm9vbGVhbicgPyBudWxsIDogdGhpcy5kcmFnZ2FibGUpOwogICAgICAgIHRoaXMuaGVhZGVyLmFkZENsYXNzKCd4LXRpcC1kcmFnZ2FibGUnKTsKICAgIH0KfSk7CgpFeHQucmVnKCd0aXAnLCBFeHQuVGlwKTsKCgpFeHQuVGlwLkREID0gZnVuY3Rpb24odGlwLCBjb25maWcpewogICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CiAgICB0aGlzLnRpcCA9IHRpcDsKICAgIEV4dC5UaXAuREQuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIHRpcC5lbC5pZCwgJ1dpbmRvd0RELScrdGlwLmlkKTsKICAgIHRoaXMuc2V0SGFuZGxlRWxJZCh0aXAuaGVhZGVyLmlkKTsKICAgIHRoaXMuc2Nyb2xsID0gZmFsc2U7Cn07CgpFeHQuZXh0ZW5kKEV4dC5UaXAuREQsIEV4dC5kZC5ERCwgewogICAgbW92ZU9ubHk6dHJ1ZSwKICAgIHNjcm9sbDpmYWxzZSwKICAgIGhlYWRlck9mZnNldHM6WzEwMCwgMjVdLAogICAgc3RhcnREcmFnIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnRpcC5lbC5kaXNhYmxlU2hhZG93KCk7CiAgICB9LAogICAgZW5kRHJhZyA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMudGlwLmVsLmVuYWJsZVNoYWRvdyh0cnVlKTsKICAgIH0KfSk7CkV4dC5Ub29sVGlwID0gRXh0LmV4dGVuZChFeHQuVGlwLCB7CiAgICAKICAgIAogICAgCiAgICAKICAgIHNob3dEZWxheSA6IDUwMCwKICAgIAogICAgaGlkZURlbGF5IDogMjAwLAogICAgCiAgICBkaXNtaXNzRGVsYXkgOiA1MDAwLAogICAgCiAgICAKICAgIHRyYWNrTW91c2UgOiBmYWxzZSwKICAgIAogICAgYW5jaG9yVG9UYXJnZXQgOiB0cnVlLAogICAgCiAgICBhbmNob3JPZmZzZXQgOiAwLAogICAgCgogICAgCiAgICB0YXJnZXRDb3VudGVyIDogMCwKCiAgICBjb25zdHJhaW5Qb3NpdGlvbiA6IGZhbHNlLAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LlRvb2xUaXAuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5sYXN0QWN0aXZlID0gbmV3IERhdGUoKTsKICAgICAgICB0aGlzLmluaXRUYXJnZXQodGhpcy50YXJnZXQpOwogICAgICAgIHRoaXMub3JpZ0FuY2hvciA9IHRoaXMuYW5jaG9yOwogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKXsKICAgICAgICBFeHQuVG9vbFRpcC5zdXBlcmNsYXNzLm9uUmVuZGVyLmNhbGwodGhpcywgY3QsIHBvc2l0aW9uKTsKICAgICAgICB0aGlzLmFuY2hvckNscyA9ICd4LXRpcC1hbmNob3ItJyArIHRoaXMuZ2V0QW5jaG9yUG9zaXRpb24oKTsKICAgICAgICB0aGlzLmFuY2hvckVsID0gdGhpcy5lbC5jcmVhdGVDaGlsZCh7CiAgICAgICAgICAgIGNsczogJ3gtdGlwLWFuY2hvciAnICsgdGhpcy5hbmNob3JDbHMKICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICBhZnRlclJlbmRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LlRvb2xUaXAuc3VwZXJjbGFzcy5hZnRlclJlbmRlci5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYW5jaG9yRWwuc2V0U3R5bGUoJ3otaW5kZXgnLCB0aGlzLmVsLmdldFpJbmRleCgpICsgMSkuc2V0VmlzaWJpbGl0eU1vZGUoRXh0LkVsZW1lbnQuRElTUExBWSk7CiAgICB9LAoKICAgIAogICAgaW5pdFRhcmdldCA6IGZ1bmN0aW9uKHRhcmdldCl7CiAgICAgICAgdmFyIHQ7CiAgICAgICAgaWYoKHQgPSBFeHQuZ2V0KHRhcmdldCkpKXsKICAgICAgICAgICAgaWYodGhpcy50YXJnZXQpewogICAgICAgICAgICAgICAgdmFyIHRnID0gRXh0LmdldCh0aGlzLnRhcmdldCk7CiAgICAgICAgICAgICAgICB0aGlzLm11bih0ZywgJ21vdXNlb3ZlcicsIHRoaXMub25UYXJnZXRPdmVyLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubXVuKHRnLCAnbW91c2VvdXQnLCB0aGlzLm9uVGFyZ2V0T3V0LCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMubXVuKHRnLCAnbW91c2Vtb3ZlJywgdGhpcy5vbk1vdXNlTW92ZSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5tb24odCwgewogICAgICAgICAgICAgICAgbW91c2VvdmVyOiB0aGlzLm9uVGFyZ2V0T3ZlciwKICAgICAgICAgICAgICAgIG1vdXNlb3V0OiB0aGlzLm9uVGFyZ2V0T3V0LAogICAgICAgICAgICAgICAgbW91c2Vtb3ZlOiB0aGlzLm9uTW91c2VNb3ZlLAogICAgICAgICAgICAgICAgc2NvcGU6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gdDsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5hbmNob3IpewogICAgICAgICAgICB0aGlzLmFuY2hvclRhcmdldCA9IHRoaXMudGFyZ2V0OwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbk1vdXNlTW92ZSA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciB0ID0gdGhpcy5kZWxlZ2F0ZSA/IGUuZ2V0VGFyZ2V0KHRoaXMuZGVsZWdhdGUpIDogdGhpcy50cmlnZ2VyRWxlbWVudCA9IHRydWU7CiAgICAgICAgaWYgKHQpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXRYWSA9IGUuZ2V0WFkoKTsKICAgICAgICAgICAgaWYgKHQgPT09IHRoaXMudHJpZ2dlckVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGlmKCF0aGlzLmhpZGRlbiAmJiB0aGlzLnRyYWNrTW91c2UpewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0UGFnZVBvc2l0aW9uKHRoaXMuZ2V0VGFyZ2V0WFkoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdEFjdGl2ZSA9IG5ldyBEYXRlKDApOwogICAgICAgICAgICAgICAgdGhpcy5vblRhcmdldE92ZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmNsb3NhYmxlICYmIHRoaXMuaXNWaXNpYmxlKCkpIHsKICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldFRhcmdldFhZIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmRlbGVnYXRlKXsKICAgICAgICAgICAgdGhpcy5hbmNob3JUYXJnZXQgPSB0aGlzLnRyaWdnZXJFbGVtZW50OwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmFuY2hvcil7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0Q291bnRlcisrOwogICAgICAgICAgICB2YXIgb2Zmc2V0cyA9IHRoaXMuZ2V0T2Zmc2V0cygpLAogICAgICAgICAgICAgICAgeHkgPSAodGhpcy5hbmNob3JUb1RhcmdldCAmJiAhdGhpcy50cmFja01vdXNlKSA/IHRoaXMuZWwuZ2V0QWxpZ25Ub1hZKHRoaXMuYW5jaG9yVGFyZ2V0LCB0aGlzLmdldEFuY2hvckFsaWduKCkpIDogdGhpcy50YXJnZXRYWSwKICAgICAgICAgICAgICAgIGR3ID0gRXh0LmxpYi5Eb20uZ2V0Vmlld1dpZHRoKCkgLSA1LAogICAgICAgICAgICAgICAgZGggPSBFeHQubGliLkRvbS5nZXRWaWV3SGVpZ2h0KCkgLSA1LAogICAgICAgICAgICAgICAgZGUgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCiAgICAgICAgICAgICAgICBiZCA9IGRvY3VtZW50LmJvZHksCiAgICAgICAgICAgICAgICBzY3JvbGxYID0gKGRlLnNjcm9sbExlZnQgfHwgYmQuc2Nyb2xsTGVmdCB8fCAwKSArIDUsCiAgICAgICAgICAgICAgICBzY3JvbGxZID0gKGRlLnNjcm9sbFRvcCB8fCBiZC5zY3JvbGxUb3AgfHwgMCkgKyA1LAogICAgICAgICAgICAgICAgYXh5ID0gW3h5WzBdICsgb2Zmc2V0c1swXSwgeHlbMV0gKyBvZmZzZXRzWzFdXSwKICAgICAgICAgICAgICAgIHN6ID0gdGhpcy5nZXRTaXplKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5hbmNob3JFbC5yZW1vdmVDbGFzcyh0aGlzLmFuY2hvckNscyk7CgogICAgICAgICAgICBpZih0aGlzLnRhcmdldENvdW50ZXIgPCAyKXsKICAgICAgICAgICAgICAgIGlmKGF4eVswXSA8IHNjcm9sbFgpewogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYW5jaG9yVG9UYXJnZXQpewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBbGlnbiA9ICdsLXInOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLm1vdXNlT2Zmc2V0KXt0aGlzLm1vdXNlT2Zmc2V0WzBdICo9IC0xO30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmNob3IgPSAnbGVmdCc7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VGFyZ2V0WFkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKGF4eVswXStzei53aWR0aCA+IGR3KXsKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmFuY2hvclRvVGFyZ2V0KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0QWxpZ24gPSAnci1sJzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5tb3VzZU9mZnNldCl7dGhpcy5tb3VzZU9mZnNldFswXSAqPSAtMTt9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuYW5jaG9yID0gJ3JpZ2h0JzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXJnZXRYWSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoYXh5WzFdIDwgc2Nyb2xsWSl7CiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5hbmNob3JUb1RhcmdldCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdEFsaWduID0gJ3QtYic7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMubW91c2VPZmZzZXQpe3RoaXMubW91c2VPZmZzZXRbMV0gKj0gLTE7fQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmFuY2hvciA9ICd0b3AnOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFRhcmdldFhZKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihheHlbMV0rc3ouaGVpZ2h0ID4gZGgpewogICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuYW5jaG9yVG9UYXJnZXQpewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmF1bHRBbGlnbiA9ICdiLXQnOwogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGlzLm1vdXNlT2Zmc2V0KXt0aGlzLm1vdXNlT2Zmc2V0WzFdICo9IC0xO30KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbmNob3IgPSAnYm90dG9tJzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRUYXJnZXRYWSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmFuY2hvckNscyA9ICd4LXRpcC1hbmNob3ItJyt0aGlzLmdldEFuY2hvclBvc2l0aW9uKCk7CiAgICAgICAgICAgIHRoaXMuYW5jaG9yRWwuYWRkQ2xhc3ModGhpcy5hbmNob3JDbHMpOwogICAgICAgICAgICB0aGlzLnRhcmdldENvdW50ZXIgPSAwOwogICAgICAgICAgICByZXR1cm4gYXh5OwogICAgICAgIH1lbHNlewogICAgICAgICAgICB2YXIgbW91c2VPZmZzZXQgPSB0aGlzLmdldE1vdXNlT2Zmc2V0KCk7CiAgICAgICAgICAgIHJldHVybiBbdGhpcy50YXJnZXRYWVswXSttb3VzZU9mZnNldFswXSwgdGhpcy50YXJnZXRYWVsxXSttb3VzZU9mZnNldFsxXV07CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRNb3VzZU9mZnNldCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG9mZnNldCA9IHRoaXMuYW5jaG9yID8gWzAsMF0gOiBbMTUsMThdOwogICAgICAgIGlmKHRoaXMubW91c2VPZmZzZXQpewogICAgICAgICAgICBvZmZzZXRbMF0gKz0gdGhpcy5tb3VzZU9mZnNldFswXTsKICAgICAgICAgICAgb2Zmc2V0WzFdICs9IHRoaXMubW91c2VPZmZzZXRbMV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICB9LAoKICAgIAogICAgZ2V0QW5jaG9yUG9zaXRpb24gOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuYW5jaG9yKXsKICAgICAgICAgICAgdGhpcy50aXBBbmNob3IgPSB0aGlzLmFuY2hvci5jaGFyQXQoMCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHZhciBtID0gdGhpcy5kZWZhdWx0QWxpZ24ubWF0Y2goL14oW2Etel0rKS0oW2Etel0rKShcPyk/JC8pOwogICAgICAgICAgICBpZighbSl7CiAgICAgICAgICAgICAgIHRocm93ICdBbmNob3JUaXAuZGVmYXVsdEFsaWduIGlzIGludmFsaWQnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudGlwQW5jaG9yID0gbVsxXS5jaGFyQXQoMCk7CiAgICAgICAgfQoKICAgICAgICBzd2l0Y2godGhpcy50aXBBbmNob3IpewogICAgICAgICAgICBjYXNlICd0JzogcmV0dXJuICd0b3AnOwogICAgICAgICAgICBjYXNlICdiJzogcmV0dXJuICdib3R0b20nOwogICAgICAgICAgICBjYXNlICdyJzogcmV0dXJuICdyaWdodCc7CiAgICAgICAgfQogICAgICAgIHJldHVybiAnbGVmdCc7CiAgICB9LAoKICAgIAogICAgZ2V0QW5jaG9yQWxpZ24gOiBmdW5jdGlvbigpewogICAgICAgIHN3aXRjaCh0aGlzLmFuY2hvcil7CiAgICAgICAgICAgIGNhc2UgJ3RvcCcgIDogcmV0dXJuICd0bC1ibCc7CiAgICAgICAgICAgIGNhc2UgJ2xlZnQnIDogcmV0dXJuICd0bC10cic7CiAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzogcmV0dXJuICd0ci10bCc7CiAgICAgICAgICAgIGRlZmF1bHQgICAgIDogcmV0dXJuICdibC10bCc7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldE9mZnNldHMgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBvZmZzZXRzLCAKICAgICAgICAgICAgYXAgPSB0aGlzLmdldEFuY2hvclBvc2l0aW9uKCkuY2hhckF0KDApOwogICAgICAgIGlmKHRoaXMuYW5jaG9yVG9UYXJnZXQgJiYgIXRoaXMudHJhY2tNb3VzZSl7CiAgICAgICAgICAgIHN3aXRjaChhcCl7CiAgICAgICAgICAgICAgICBjYXNlICd0JzoKICAgICAgICAgICAgICAgICAgICBvZmZzZXRzID0gWzAsIDldOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnYic6CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0cyA9IFswLCAtMTNdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAncic6CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0cyA9IFstMTMsIDBdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBvZmZzZXRzID0gWzksIDBdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHN3aXRjaChhcCl7CiAgICAgICAgICAgICAgICBjYXNlICd0JzoKICAgICAgICAgICAgICAgICAgICBvZmZzZXRzID0gWy0xNS10aGlzLmFuY2hvck9mZnNldCwgMzBdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAnYic6CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0cyA9IFstMTktdGhpcy5hbmNob3JPZmZzZXQsIC0xMy10aGlzLmVsLmRvbS5vZmZzZXRIZWlnaHRdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAncic6CiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0cyA9IFstMTUtdGhpcy5lbC5kb20ub2Zmc2V0V2lkdGgsIC0xMy10aGlzLmFuY2hvck9mZnNldF07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIG9mZnNldHMgPSBbMjUsIC0xMy10aGlzLmFuY2hvck9mZnNldF07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG1vdXNlT2Zmc2V0ID0gdGhpcy5nZXRNb3VzZU9mZnNldCgpOwogICAgICAgIG9mZnNldHNbMF0gKz0gbW91c2VPZmZzZXRbMF07CiAgICAgICAgb2Zmc2V0c1sxXSArPSBtb3VzZU9mZnNldFsxXTsKCiAgICAgICAgcmV0dXJuIG9mZnNldHM7CiAgICB9LAoKICAgIAogICAgb25UYXJnZXRPdmVyIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYodGhpcy5kaXNhYmxlZCB8fCBlLndpdGhpbih0aGlzLnRhcmdldC5kb20sIHRydWUpKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgdCA9IGUuZ2V0VGFyZ2V0KHRoaXMuZGVsZWdhdGUpOwogICAgICAgIGlmICh0KSB7CiAgICAgICAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnQgPSB0OwogICAgICAgICAgICB0aGlzLmNsZWFyVGltZXIoJ2hpZGUnKTsKICAgICAgICAgICAgdGhpcy50YXJnZXRYWSA9IGUuZ2V0WFkoKTsKICAgICAgICAgICAgdGhpcy5kZWxheVNob3coKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZGVsYXlTaG93IDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmhpZGRlbiAmJiAhdGhpcy5zaG93VGltZXIpewogICAgICAgICAgICBpZih0aGlzLmxhc3RBY3RpdmUuZ2V0RWxhcHNlZCgpIDwgdGhpcy5xdWlja1Nob3dJbnRlcnZhbCl7CiAgICAgICAgICAgICAgICB0aGlzLnNob3coKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICB0aGlzLnNob3dUaW1lciA9IHRoaXMuc2hvdy5kZWZlcih0aGlzLnNob3dEZWxheSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZSBpZighdGhpcy5oaWRkZW4gJiYgdGhpcy5hdXRvSGlkZSAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLnNob3coKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25UYXJnZXRPdXQgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZih0aGlzLmRpc2FibGVkIHx8IGUud2l0aGluKHRoaXMudGFyZ2V0LmRvbSwgdHJ1ZSkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXJUaW1lcignc2hvdycpOwogICAgICAgIGlmKHRoaXMuYXV0b0hpZGUgIT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5kZWxheUhpZGUoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZGVsYXlIaWRlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5oaWRkZW4gJiYgIXRoaXMuaGlkZVRpbWVyKXsKICAgICAgICAgICAgdGhpcy5oaWRlVGltZXIgPSB0aGlzLmhpZGUuZGVmZXIodGhpcy5oaWRlRGVsYXksIHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBoaWRlOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuY2xlYXJUaW1lcignZGlzbWlzcycpOwogICAgICAgIHRoaXMubGFzdEFjdGl2ZSA9IG5ldyBEYXRlKCk7CiAgICAgICAgaWYodGhpcy5hbmNob3JFbCl7CiAgICAgICAgICAgIHRoaXMuYW5jaG9yRWwuaGlkZSgpOwogICAgICAgIH0KICAgICAgICBFeHQuVG9vbFRpcC5zdXBlcmNsYXNzLmhpZGUuY2FsbCh0aGlzKTsKICAgICAgICBkZWxldGUgdGhpcy50cmlnZ2VyRWxlbWVudDsKICAgIH0sCgogICAgCiAgICBzaG93IDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmFuY2hvcil7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zaG93QXQoWy0xMDAwLC0xMDAwXSk7CiAgICAgICAgICAgIHRoaXMub3JpZ0NvbnN0cmFpblBvc2l0aW9uID0gdGhpcy5jb25zdHJhaW5Qb3NpdGlvbjsKICAgICAgICAgICAgdGhpcy5jb25zdHJhaW5Qb3NpdGlvbiA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmFuY2hvciA9IHRoaXMub3JpZ0FuY2hvcjsKICAgICAgICB9CiAgICAgICAgdGhpcy5zaG93QXQodGhpcy5nZXRUYXJnZXRYWSgpKTsKCiAgICAgICAgaWYodGhpcy5hbmNob3IpewogICAgICAgICAgICB0aGlzLmFuY2hvckVsLnNob3coKTsKICAgICAgICAgICAgdGhpcy5zeW5jQW5jaG9yKCk7CiAgICAgICAgICAgIHRoaXMuY29uc3RyYWluUG9zaXRpb24gPSB0aGlzLm9yaWdDb25zdHJhaW5Qb3NpdGlvbjsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5hbmNob3JFbC5oaWRlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNob3dBdCA6IGZ1bmN0aW9uKHh5KXsKICAgICAgICB0aGlzLmxhc3RBY3RpdmUgPSBuZXcgRGF0ZSgpOwogICAgICAgIHRoaXMuY2xlYXJUaW1lcnMoKTsKICAgICAgICBFeHQuVG9vbFRpcC5zdXBlcmNsYXNzLnNob3dBdC5jYWxsKHRoaXMsIHh5KTsKICAgICAgICBpZih0aGlzLmRpc21pc3NEZWxheSAmJiB0aGlzLmF1dG9IaWRlICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuZGlzbWlzc1RpbWVyID0gdGhpcy5oaWRlLmRlZmVyKHRoaXMuZGlzbWlzc0RlbGF5LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5hbmNob3IgJiYgIXRoaXMuYW5jaG9yRWwuaXNWaXNpYmxlKCkpewogICAgICAgICAgICB0aGlzLnN5bmNBbmNob3IoKTsKICAgICAgICAgICAgdGhpcy5hbmNob3JFbC5zaG93KCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuYW5jaG9yRWwuaGlkZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzeW5jQW5jaG9yIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgYW5jaG9yUG9zLCB0YXJnZXRQb3MsIG9mZnNldDsKICAgICAgICBzd2l0Y2godGhpcy50aXBBbmNob3IuY2hhckF0KDApKXsKICAgICAgICAgICAgY2FzZSAndCc6CiAgICAgICAgICAgICAgICBhbmNob3JQb3MgPSAnYic7CiAgICAgICAgICAgICAgICB0YXJnZXRQb3MgPSAndGwnOwogICAgICAgICAgICAgICAgb2Zmc2V0ID0gWzIwK3RoaXMuYW5jaG9yT2Zmc2V0LCAyXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdyJzoKICAgICAgICAgICAgICAgIGFuY2hvclBvcyA9ICdsJzsKICAgICAgICAgICAgICAgIHRhcmdldFBvcyA9ICd0cic7CiAgICAgICAgICAgICAgICBvZmZzZXQgPSBbLTIsIDExK3RoaXMuYW5jaG9yT2Zmc2V0XTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdiJzoKICAgICAgICAgICAgICAgIGFuY2hvclBvcyA9ICd0JzsKICAgICAgICAgICAgICAgIHRhcmdldFBvcyA9ICdibCc7CiAgICAgICAgICAgICAgICBvZmZzZXQgPSBbMjArdGhpcy5hbmNob3JPZmZzZXQsIC0yXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgYW5jaG9yUG9zID0gJ3InOwogICAgICAgICAgICAgICAgdGFyZ2V0UG9zID0gJ3RsJzsKICAgICAgICAgICAgICAgIG9mZnNldCA9IFsyLCAxMSt0aGlzLmFuY2hvck9mZnNldF07CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgdGhpcy5hbmNob3JFbC5hbGlnblRvKHRoaXMuZWwsIGFuY2hvclBvcysnLScrdGFyZ2V0UG9zLCBvZmZzZXQpOwogICAgfSwKCiAgICAKICAgIHNldFBhZ2VQb3NpdGlvbiA6IGZ1bmN0aW9uKHgsIHkpewogICAgICAgIEV4dC5Ub29sVGlwLnN1cGVyY2xhc3Muc2V0UGFnZVBvc2l0aW9uLmNhbGwodGhpcywgeCwgeSk7CiAgICAgICAgaWYodGhpcy5hbmNob3IpewogICAgICAgICAgICB0aGlzLnN5bmNBbmNob3IoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgY2xlYXJUaW1lciA6IGZ1bmN0aW9uKG5hbWUpewogICAgICAgIG5hbWUgPSBuYW1lICsgJ1RpbWVyJzsKICAgICAgICBjbGVhclRpbWVvdXQodGhpc1tuYW1lXSk7CiAgICAgICAgZGVsZXRlIHRoaXNbbmFtZV07CiAgICB9LAoKICAgIAogICAgY2xlYXJUaW1lcnMgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuY2xlYXJUaW1lcignc2hvdycpOwogICAgICAgIHRoaXMuY2xlYXJUaW1lcignZGlzbWlzcycpOwogICAgICAgIHRoaXMuY2xlYXJUaW1lcignaGlkZScpOwogICAgfSwKCiAgICAKICAgIG9uU2hvdyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LlRvb2xUaXAuc3VwZXJjbGFzcy5vblNob3cuY2FsbCh0aGlzKTsKICAgICAgICBFeHQuZ2V0RG9jKCkub24oJ21vdXNlZG93bicsIHRoaXMub25Eb2NNb3VzZURvd24sIHRoaXMpOwogICAgfSwKCiAgICAKICAgIG9uSGlkZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LlRvb2xUaXAuc3VwZXJjbGFzcy5vbkhpZGUuY2FsbCh0aGlzKTsKICAgICAgICBFeHQuZ2V0RG9jKCkudW4oJ21vdXNlZG93bicsIHRoaXMub25Eb2NNb3VzZURvd24sIHRoaXMpOwogICAgfSwKCiAgICAKICAgIG9uRG9jTW91c2VEb3duIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYodGhpcy5hdXRvSGlkZSAhPT0gdHJ1ZSAmJiAhdGhpcy5jbG9zYWJsZSAmJiAhZS53aXRoaW4odGhpcy5lbC5kb20pKXsKICAgICAgICAgICAgdGhpcy5kaXNhYmxlKCk7CiAgICAgICAgICAgIHRoaXMuZG9FbmFibGUuZGVmZXIoMTAwLCB0aGlzKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIGRvRW5hYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5pc0Rlc3Ryb3llZCl7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uRGlzYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5jbGVhclRpbWVycygpOwogICAgICAgIHRoaXMuaGlkZSgpOwogICAgfSwKCiAgICAKICAgIGFkanVzdFBvc2l0aW9uIDogZnVuY3Rpb24oeCwgeSl7CiAgICAgICAgaWYodGhpcy5jb25zdHJhaW5Qb3NpdGlvbil7CiAgICAgICAgICAgIHZhciBheSA9IHRoaXMudGFyZ2V0WFlbMV0sIGggPSB0aGlzLmdldFNpemUoKS5oZWlnaHQ7CiAgICAgICAgICAgIGlmKHkgPD0gYXkgJiYgKHkraCkgPj0gYXkpewogICAgICAgICAgICAgICAgeSA9IGF5LWgtNTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4ge3ggOiB4LCB5OiB5fTsKICAgIH0sCiAgICAKICAgIGJlZm9yZURlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuY2xlYXJUaW1lcnMoKTsKICAgICAgICBFeHQuZGVzdHJveSh0aGlzLmFuY2hvckVsKTsKICAgICAgICBkZWxldGUgdGhpcy5hbmNob3JFbDsKICAgICAgICBkZWxldGUgdGhpcy50YXJnZXQ7CiAgICAgICAgZGVsZXRlIHRoaXMuYW5jaG9yVGFyZ2V0OwogICAgICAgIGRlbGV0ZSB0aGlzLnRyaWdnZXJFbGVtZW50OwogICAgICAgIEV4dC5Ub29sVGlwLnN1cGVyY2xhc3MuYmVmb3JlRGVzdHJveS5jYWxsKHRoaXMpOyAgICAKICAgIH0sCgogICAgCiAgICBvbkRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5nZXREb2MoKS51bignbW91c2Vkb3duJywgdGhpcy5vbkRvY01vdXNlRG93biwgdGhpcyk7CiAgICAgICAgRXh0LlRvb2xUaXAuc3VwZXJjbGFzcy5vbkRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0KfSk7CgpFeHQucmVnKCd0b29sdGlwJywgRXh0LlRvb2xUaXApOwpFeHQuUXVpY2tUaXAgPSBFeHQuZXh0ZW5kKEV4dC5Ub29sVGlwLCB7CiAgICAKICAgIAogICAgaW50ZXJjZXB0VGl0bGVzIDogZmFsc2UsCgogICAgCiAgICB0YWdDb25maWcgOiB7CiAgICAgICAgbmFtZXNwYWNlIDogImV4dCIsCiAgICAgICAgYXR0cmlidXRlIDogInF0aXAiLAogICAgICAgIHdpZHRoIDogInF3aWR0aCIsCiAgICAgICAgdGFyZ2V0IDogInRhcmdldCIsCiAgICAgICAgdGl0bGUgOiAicXRpdGxlIiwKICAgICAgICBoaWRlIDogImhpZGUiLAogICAgICAgIGNscyA6ICJxY2xhc3MiLAogICAgICAgIGFsaWduIDogInFhbGlnbiIsCiAgICAgICAgYW5jaG9yIDogImFuY2hvciIKICAgIH0sCgogICAgCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnRhcmdldCA9IHRoaXMudGFyZ2V0IHx8IEV4dC5nZXREb2MoKTsKICAgICAgICB0aGlzLnRhcmdldHMgPSB0aGlzLnRhcmdldHMgfHwge307CiAgICAgICAgRXh0LlF1aWNrVGlwLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgfSwKCiAgICAKICAgIHJlZ2lzdGVyIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICB2YXIgY3MgPSBFeHQuaXNBcnJheShjb25maWcpID8gY29uZmlnIDogYXJndW1lbnRzOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGNzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgdmFyIGMgPSBjc1tpXTsKICAgICAgICAgICAgdmFyIHRhcmdldCA9IGMudGFyZ2V0OwogICAgICAgICAgICBpZih0YXJnZXQpewogICAgICAgICAgICAgICAgaWYoRXh0LmlzQXJyYXkodGFyZ2V0KSl7CiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMCwgamxlbiA9IHRhcmdldC5sZW5ndGg7IGogPCBqbGVuOyBqKyspewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhcmdldHNbRXh0LmlkKHRhcmdldFtqXSldID0gYzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2V7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRzW0V4dC5pZCh0YXJnZXQpXSA9IGM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdW5yZWdpc3RlciA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICBkZWxldGUgdGhpcy50YXJnZXRzW0V4dC5pZChlbCldOwogICAgfSwKICAgIAogICAgCiAgICBjYW5jZWxTaG93OiBmdW5jdGlvbihlbCl7CiAgICAgICAgdmFyIGF0ID0gdGhpcy5hY3RpdmVUYXJnZXQ7CiAgICAgICAgZWwgPSBFeHQuZ2V0KGVsKS5kb207CiAgICAgICAgaWYodGhpcy5pc1Zpc2libGUoKSl7CiAgICAgICAgICAgIGlmKGF0ICYmIGF0LmVsID09IGVsKXsKICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2UgaWYoYXQgJiYgYXQuZWwgPT0gZWwpewogICAgICAgICAgICB0aGlzLmNsZWFyVGltZXIoJ3Nob3cnKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICBnZXRUaXBDZmc6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB2YXIgdCA9IGUuZ2V0VGFyZ2V0KCksIAogICAgICAgICAgICB0dHAsIAogICAgICAgICAgICBjZmc7CiAgICAgICAgaWYodGhpcy5pbnRlcmNlcHRUaXRsZXMgJiYgdC50aXRsZSAmJiBFeHQuaXNTdHJpbmcodC50aXRsZSkpewogICAgICAgICAgICB0dHAgPSB0LnRpdGxlOwogICAgICAgICAgICB0LnF0aXAgPSB0dHA7CiAgICAgICAgICAgIHQucmVtb3ZlQXR0cmlidXRlKCJ0aXRsZSIpOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGNmZyA9IHRoaXMudGFnQ29uZmlnOwogICAgICAgICAgICB0dHAgPSB0LnF0aXAgfHwgRXh0LmZseSh0KS5nZXRBdHRyaWJ1dGUoY2ZnLmF0dHJpYnV0ZSwgY2ZnLm5hbWVzcGFjZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0dHA7CiAgICB9LAoKICAgIAogICAgb25UYXJnZXRPdmVyIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYodGhpcy5kaXNhYmxlZCl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy50YXJnZXRYWSA9IGUuZ2V0WFkoKTsKICAgICAgICB2YXIgdCA9IGUuZ2V0VGFyZ2V0KCk7CiAgICAgICAgaWYoIXQgfHwgdC5ub2RlVHlwZSAhPT0gMSB8fCB0ID09IGRvY3VtZW50IHx8IHQgPT0gZG9jdW1lbnQuYm9keSl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5hY3RpdmVUYXJnZXQgJiYgKCh0ID09IHRoaXMuYWN0aXZlVGFyZ2V0LmVsKSB8fCBFeHQuZmx5KHRoaXMuYWN0aXZlVGFyZ2V0LmVsKS5jb250YWlucyh0KSkpewogICAgICAgICAgICB0aGlzLmNsZWFyVGltZXIoJ2hpZGUnKTsKICAgICAgICAgICAgdGhpcy5zaG93KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYodCAmJiB0aGlzLnRhcmdldHNbdC5pZF0pewogICAgICAgICAgICB0aGlzLmFjdGl2ZVRhcmdldCA9IHRoaXMudGFyZ2V0c1t0LmlkXTsKICAgICAgICAgICAgdGhpcy5hY3RpdmVUYXJnZXQuZWwgPSB0OwogICAgICAgICAgICB0aGlzLmFuY2hvciA9IHRoaXMuYWN0aXZlVGFyZ2V0LmFuY2hvcjsKICAgICAgICAgICAgaWYodGhpcy5hbmNob3IpewogICAgICAgICAgICAgICAgdGhpcy5hbmNob3JUYXJnZXQgPSB0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGVsYXlTaG93KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHR0cCwgZXQgPSBFeHQuZmx5KHQpLCBjZmcgPSB0aGlzLnRhZ0NvbmZpZywgbnMgPSBjZmcubmFtZXNwYWNlOwogICAgICAgIGlmKHR0cCA9IHRoaXMuZ2V0VGlwQ2ZnKGUpKXsKICAgICAgICAgICAgdmFyIGF1dG9IaWRlID0gZXQuZ2V0QXR0cmlidXRlKGNmZy5oaWRlLCBucyk7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlVGFyZ2V0ID0gewogICAgICAgICAgICAgICAgZWw6IHQsCiAgICAgICAgICAgICAgICB0ZXh0OiB0dHAsCiAgICAgICAgICAgICAgICB3aWR0aDogZXQuZ2V0QXR0cmlidXRlKGNmZy53aWR0aCwgbnMpLAogICAgICAgICAgICAgICAgYXV0b0hpZGU6IGF1dG9IaWRlICE9ICJ1c2VyIiAmJiBhdXRvSGlkZSAhPT0gJ2ZhbHNlJywKICAgICAgICAgICAgICAgIHRpdGxlOiBldC5nZXRBdHRyaWJ1dGUoY2ZnLnRpdGxlLCBucyksCiAgICAgICAgICAgICAgICBjbHM6IGV0LmdldEF0dHJpYnV0ZShjZmcuY2xzLCBucyksCiAgICAgICAgICAgICAgICBhbGlnbjogZXQuZ2V0QXR0cmlidXRlKGNmZy5hbGlnbiwgbnMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5hbmNob3IgPSBldC5nZXRBdHRyaWJ1dGUoY2ZnLmFuY2hvciwgbnMpOwogICAgICAgICAgICBpZih0aGlzLmFuY2hvcil7CiAgICAgICAgICAgICAgICB0aGlzLmFuY2hvclRhcmdldCA9IHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5kZWxheVNob3coKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25UYXJnZXRPdXQgOiBmdW5jdGlvbihlKXsKCiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuYWN0aXZlVGFyZ2V0ICYmIGUud2l0aGluKHRoaXMuYWN0aXZlVGFyZ2V0LmVsKSAmJiAhdGhpcy5nZXRUaXBDZmcoZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jbGVhclRpbWVyKCdzaG93Jyk7CiAgICAgICAgaWYodGhpcy5hdXRvSGlkZSAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLmRlbGF5SGlkZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzaG93QXQgOiBmdW5jdGlvbih4eSl7CiAgICAgICAgdmFyIHQgPSB0aGlzLmFjdGl2ZVRhcmdldDsKICAgICAgICBpZih0KXsKICAgICAgICAgICAgaWYoIXRoaXMucmVuZGVyZWQpewogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoRXh0LmdldEJvZHkoKSk7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVRhcmdldCA9IHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodC53aWR0aCl7CiAgICAgICAgICAgICAgICB0aGlzLnNldFdpZHRoKHQud2lkdGgpOwogICAgICAgICAgICAgICAgdGhpcy5ib2R5LnNldFdpZHRoKHRoaXMuYWRqdXN0Qm9keVdpZHRoKHQud2lkdGggLSB0aGlzLmdldEZyYW1lV2lkdGgoKSkpOwogICAgICAgICAgICAgICAgdGhpcy5tZWFzdXJlV2lkdGggPSBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlewogICAgICAgICAgICAgICAgdGhpcy5tZWFzdXJlV2lkdGggPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0VGl0bGUodC50aXRsZSB8fCAnJyk7CiAgICAgICAgICAgIHRoaXMuYm9keS51cGRhdGUodC50ZXh0KTsKICAgICAgICAgICAgdGhpcy5hdXRvSGlkZSA9IHQuYXV0b0hpZGU7CiAgICAgICAgICAgIHRoaXMuZGlzbWlzc0RlbGF5ID0gdC5kaXNtaXNzRGVsYXkgfHwgdGhpcy5kaXNtaXNzRGVsYXk7CiAgICAgICAgICAgIGlmKHRoaXMubGFzdENscyl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUNsYXNzKHRoaXMubGFzdENscyk7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5sYXN0Q2xzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHQuY2xzKXsKICAgICAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3ModC5jbHMpOwogICAgICAgICAgICAgICAgdGhpcy5sYXN0Q2xzID0gdC5jbHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5hbmNob3IpewogICAgICAgICAgICAgICAgdGhpcy5jb25zdHJhaW5Qb3NpdGlvbiA9IGZhbHNlOwogICAgICAgICAgICB9ZWxzZSBpZih0LmFsaWduKXsgCiAgICAgICAgICAgICAgICB4eSA9IHRoaXMuZWwuZ2V0QWxpZ25Ub1hZKHQuZWwsIHQuYWxpZ24pOwogICAgICAgICAgICAgICAgdGhpcy5jb25zdHJhaW5Qb3NpdGlvbiA9IGZhbHNlOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMuY29uc3RyYWluUG9zaXRpb24gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIEV4dC5RdWlja1RpcC5zdXBlcmNsYXNzLnNob3dBdC5jYWxsKHRoaXMsIHh5KTsKICAgIH0sCgogICAgCiAgICBoaWRlOiBmdW5jdGlvbigpewogICAgICAgIGRlbGV0ZSB0aGlzLmFjdGl2ZVRhcmdldDsKICAgICAgICBFeHQuUXVpY2tUaXAuc3VwZXJjbGFzcy5oaWRlLmNhbGwodGhpcyk7CiAgICB9Cn0pOwpFeHQucmVnKCdxdWlja3RpcCcsIEV4dC5RdWlja1RpcCk7CkV4dC5RdWlja1RpcHMgPSBmdW5jdGlvbigpewogICAgdmFyIHRpcCwKICAgICAgICBkaXNhYmxlZCA9IGZhbHNlOwogICAgICAgIAogICAgcmV0dXJuIHsKICAgICAgICAKICAgICAgICBpbml0IDogZnVuY3Rpb24oYXV0b1JlbmRlcil7CiAgICAgICAgICAgIGlmKCF0aXApewogICAgICAgICAgICAgICAgaWYoIUV4dC5pc1JlYWR5KXsKICAgICAgICAgICAgICAgICAgICBFeHQub25SZWFkeShmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICBFeHQuUXVpY2tUaXBzLmluaXQoYXV0b1JlbmRlcik7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGlwID0gbmV3IEV4dC5RdWlja1RpcCh7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudHM6J2hlYWRlcixib2R5JywgCiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ6IGRpc2FibGVkCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmKGF1dG9SZW5kZXIgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgICAgICB0aXAucmVuZGVyKEV4dC5nZXRCb2R5KCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAKICAgICAgICBkZERpc2FibGUgOiBmdW5jdGlvbigpewogICAgICAgICAgICAKICAgICAgICAgICAgaWYodGlwICYmICFkaXNhYmxlZCl7CiAgICAgICAgICAgICAgICB0aXAuZGlzYWJsZSgpOwogICAgICAgICAgICB9ICAgIAogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgZGRFbmFibGUgOiBmdW5jdGlvbigpewogICAgICAgICAgICAKICAgICAgICAgICAgaWYodGlwICYmICFkaXNhYmxlZCl7CiAgICAgICAgICAgICAgICB0aXAuZW5hYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBlbmFibGUgOiBmdW5jdGlvbigpewogICAgICAgICAgICBpZih0aXApewogICAgICAgICAgICAgICAgdGlwLmVuYWJsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkID0gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgZGlzYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmKHRpcCl7CiAgICAgICAgICAgICAgICB0aXAuZGlzYWJsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBpc0VuYWJsZWQgOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gdGlwICE9PSB1bmRlZmluZWQgJiYgIXRpcC5kaXNhYmxlZDsKICAgICAgICB9LAoKICAgICAgICAKICAgICAgICBnZXRRdWlja1RpcCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aXA7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgcmVnaXN0ZXIgOiBmdW5jdGlvbigpewogICAgICAgICAgICB0aXAucmVnaXN0ZXIuYXBwbHkodGlwLCBhcmd1bWVudHMpOwogICAgICAgIH0sCgogICAgICAgIAogICAgICAgIHVucmVnaXN0ZXIgOiBmdW5jdGlvbigpewogICAgICAgICAgICB0aXAudW5yZWdpc3Rlci5hcHBseSh0aXAsIGFyZ3VtZW50cyk7CiAgICAgICAgfSwKCiAgICAgICAgCiAgICAgICAgdGlwcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHRpcC5yZWdpc3Rlci5hcHBseSh0aXAsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgfTsKfSgpOwpFeHQuc2xpZGVyLlRpcCA9IEV4dC5leHRlbmQoRXh0LlRpcCwgewogICAgbWluV2lkdGg6IDEwLAogICAgb2Zmc2V0cyA6IFswLCAtMTBdLAogICAgCiAgICBpbml0OiBmdW5jdGlvbihzbGlkZXIpIHsKICAgICAgICBzbGlkZXIub24oewogICAgICAgICAgICBzY29wZSAgICA6IHRoaXMsCiAgICAgICAgICAgIGRyYWdzdGFydDogdGhpcy5vblNsaWRlLAogICAgICAgICAgICBkcmFnICAgICA6IHRoaXMub25TbGlkZSwKICAgICAgICAgICAgZHJhZ2VuZCAgOiB0aGlzLmhpZGUsCiAgICAgICAgICAgIGRlc3Ryb3kgIDogdGhpcy5kZXN0cm95CiAgICAgICAgfSk7CiAgICB9LAogICAgCiAgICAKICAgIG9uU2xpZGUgOiBmdW5jdGlvbihzbGlkZXIsIGUsIHRodW1iKSB7CiAgICAgICAgdGhpcy5zaG93KCk7CiAgICAgICAgdGhpcy5ib2R5LnVwZGF0ZSh0aGlzLmdldFRleHQodGh1bWIpKTsKICAgICAgICB0aGlzLmRvQXV0b1dpZHRoKCk7CiAgICAgICAgdGhpcy5lbC5hbGlnblRvKHRodW1iLmVsLCAnYi10PycsIHRoaXMub2Zmc2V0cyk7CiAgICB9LAoKICAgIAogICAgZ2V0VGV4dCA6IGZ1bmN0aW9uKHRodW1iKSB7CiAgICAgICAgcmV0dXJuIFN0cmluZyh0aHVtYi52YWx1ZSk7CiAgICB9Cn0pOwoKCkV4dC51eC5TbGlkZXJUaXAgPSBFeHQuc2xpZGVyLlRpcDsKRXh0LnRyZWUuVHJlZVBhbmVsID0gRXh0LmV4dGVuZChFeHQuUGFuZWwsIHsKICAgIHJvb3RWaXNpYmxlIDogdHJ1ZSwKICAgIGFuaW1hdGUgOiBFeHQuZW5hYmxlRngsCiAgICBsaW5lcyA6IHRydWUsCiAgICBlbmFibGVERCA6IGZhbHNlLAogICAgaGxEcm9wIDogRXh0LmVuYWJsZUZ4LAogICAgcGF0aFNlcGFyYXRvciA6ICcvJywKCiAgICAKICAgIGJ1YmJsZUV2ZW50cyA6IFtdLAoKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC50cmVlLlRyZWVQYW5lbC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKCiAgICAgICAgaWYoIXRoaXMuZXZlbnRNb2RlbCl7CiAgICAgICAgICAgIHRoaXMuZXZlbnRNb2RlbCA9IG5ldyBFeHQudHJlZS5UcmVlRXZlbnRNb2RlbCh0aGlzKTsKICAgICAgICB9CgogICAgICAgIAogICAgICAgIHZhciBsID0gdGhpcy5sb2FkZXI7CiAgICAgICAgaWYoIWwpewogICAgICAgICAgICBsID0gbmV3IEV4dC50cmVlLlRyZWVMb2FkZXIoewogICAgICAgICAgICAgICAgZGF0YVVybDogdGhpcy5kYXRhVXJsLAogICAgICAgICAgICAgICAgcmVxdWVzdE1ldGhvZDogdGhpcy5yZXF1ZXN0TWV0aG9kCiAgICAgICAgICAgIH0pOwogICAgICAgIH1lbHNlIGlmKEV4dC5pc09iamVjdChsKSAmJiAhbC5sb2FkKXsKICAgICAgICAgICAgbCA9IG5ldyBFeHQudHJlZS5UcmVlTG9hZGVyKGwpOwogICAgICAgIH0KICAgICAgICB0aGlzLmxvYWRlciA9IGw7CgogICAgICAgIHRoaXMubm9kZUhhc2ggPSB7fTsKCiAgICAgICAgCiAgICAgICAgaWYodGhpcy5yb290KXsKICAgICAgICAgICAgdmFyIHIgPSB0aGlzLnJvb3Q7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnJvb3Q7CiAgICAgICAgICAgIHRoaXMuc2V0Um9vdE5vZGUocik7CiAgICAgICAgfQoKCiAgICAgICAgdGhpcy5hZGRFdmVudHMoCgogICAgICAgICAgICAKICAgICAgICAgICAnYXBwZW5kJywKICAgICAgICAgICAKICAgICAgICAgICAncmVtb3ZlJywKICAgICAgICAgICAKICAgICAgICAgICAnbW92ZW5vZGUnLAogICAgICAgICAgIAogICAgICAgICAgICdpbnNlcnQnLAogICAgICAgICAgIAogICAgICAgICAgICdiZWZvcmVhcHBlbmQnLAogICAgICAgICAgIAogICAgICAgICAgICdiZWZvcmVyZW1vdmUnLAogICAgICAgICAgIAogICAgICAgICAgICdiZWZvcmVtb3Zlbm9kZScsCiAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVpbnNlcnQnLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVsb2FkJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdsb2FkJywKICAgICAgICAgICAgCiAgICAgICAgICAgICd0ZXh0Y2hhbmdlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVleHBhbmRub2RlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVjb2xsYXBzZW5vZGUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2V4cGFuZG5vZGUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2Rpc2FibGVkY2hhbmdlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjb2xsYXBzZW5vZGUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZWNsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjbGljaycsCiAgICAgICAgICAgIAogICAgICAgICAgICAnY29udGFpbmVyY2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NoZWNrY2hhbmdlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVkYmxjbGljaycsCiAgICAgICAgICAgIAogICAgICAgICAgICAnZGJsY2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NvbnRhaW5lcmRibGNsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjb250ZXh0bWVudScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnY29udGFpbmVyY29udGV4dG1lbnUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZWNoaWxkcmVucmVuZGVyZWQnLAogICAgICAgICAgIAogICAgICAgICAgICAnc3RhcnRkcmFnJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdlbmRkcmFnJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdkcmFnZHJvcCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYmVmb3Jlbm9kZWRyb3AnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ25vZGVkcm9wJywKICAgICAgICAgICAgIAogICAgICAgICAgICAnbm9kZWRyYWdvdmVyJwogICAgICAgICk7CiAgICAgICAgaWYodGhpcy5zaW5nbGVFeHBhbmQpewogICAgICAgICAgICB0aGlzLm9uKCdiZWZvcmVleHBhbmRub2RlJywgdGhpcy5yZXN0cmljdEV4cGFuZCwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHByb3h5Tm9kZUV2ZW50IDogZnVuY3Rpb24oZW5hbWUsIGExLCBhMiwgYTMsIGE0LCBhNSwgYTYpewogICAgICAgIGlmKGVuYW1lID09ICdjb2xsYXBzZScgfHwgZW5hbWUgPT0gJ2V4cGFuZCcgfHwgZW5hbWUgPT0gJ2JlZm9yZWNvbGxhcHNlJyB8fCBlbmFtZSA9PSAnYmVmb3JlZXhwYW5kJyB8fCBlbmFtZSA9PSAnbW92ZScgfHwgZW5hbWUgPT0gJ2JlZm9yZW1vdmUnKXsKICAgICAgICAgICAgZW5hbWUgPSBlbmFtZSsnbm9kZSc7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB0aGlzLmZpcmVFdmVudChlbmFtZSwgYTEsIGEyLCBhMywgYTQsIGE1LCBhNik7CiAgICB9LAoKCiAgICAKICAgIGdldFJvb3ROb2RlIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5yb290OwogICAgfSwKCiAgICAKICAgIHNldFJvb3ROb2RlIDogZnVuY3Rpb24obm9kZSl7CiAgICAgICAgdGhpcy5kZXN0cm95Um9vdCgpOwogICAgICAgIGlmKCFub2RlLnJlbmRlcil7IAogICAgICAgICAgICBub2RlID0gdGhpcy5sb2FkZXIuY3JlYXRlTm9kZShub2RlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5yb290ID0gbm9kZTsKICAgICAgICBub2RlLm93bmVyVHJlZSA9IHRoaXM7CiAgICAgICAgbm9kZS5pc1Jvb3QgPSB0cnVlOwogICAgICAgIHRoaXMucmVnaXN0ZXJOb2RlKG5vZGUpOwogICAgICAgIGlmKCF0aGlzLnJvb3RWaXNpYmxlKXsKICAgICAgICAgICAgdmFyIHVpUCA9IG5vZGUuYXR0cmlidXRlcy51aVByb3ZpZGVyOwogICAgICAgICAgICBub2RlLnVpID0gdWlQID8gbmV3IHVpUChub2RlKSA6IG5ldyBFeHQudHJlZS5Sb290VHJlZU5vZGVVSShub2RlKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5pbm5lckN0KXsKICAgICAgICAgICAgdGhpcy5jbGVhcklubmVyQ3QoKTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJSb290KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBub2RlOwogICAgfSwKICAgIAogICAgY2xlYXJJbm5lckN0IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmlubmVyQ3QudXBkYXRlKCcnKTsgICAgCiAgICB9LAogICAgCiAgICAKICAgIHJlbmRlclJvb3QgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMucm9vdC5yZW5kZXIoKTsKICAgICAgICBpZighdGhpcy5yb290VmlzaWJsZSl7CiAgICAgICAgICAgIHRoaXMucm9vdC5yZW5kZXJDaGlsZHJlbigpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXROb2RlQnlJZCA6IGZ1bmN0aW9uKGlkKXsKICAgICAgICByZXR1cm4gdGhpcy5ub2RlSGFzaFtpZF07CiAgICB9LAoKICAgIAogICAgcmVnaXN0ZXJOb2RlIDogZnVuY3Rpb24obm9kZSl7CiAgICAgICAgdGhpcy5ub2RlSGFzaFtub2RlLmlkXSA9IG5vZGU7CiAgICB9LAoKICAgIAogICAgdW5yZWdpc3Rlck5vZGUgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICBkZWxldGUgdGhpcy5ub2RlSGFzaFtub2RlLmlkXTsKICAgIH0sCgogICAgCiAgICB0b1N0cmluZyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuICdbVHJlZScrKHRoaXMuaWQ/JyAnK3RoaXMuaWQ6JycpKyddJzsKICAgIH0sCgogICAgCiAgICByZXN0cmljdEV4cGFuZCA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHZhciBwID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgIGlmKHApewogICAgICAgICAgICBpZihwLmV4cGFuZGVkQ2hpbGQgJiYgcC5leHBhbmRlZENoaWxkLnBhcmVudE5vZGUgPT0gcCl7CiAgICAgICAgICAgICAgICBwLmV4cGFuZGVkQ2hpbGQuY29sbGFwc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwLmV4cGFuZGVkQ2hpbGQgPSBub2RlOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRDaGVja2VkIDogZnVuY3Rpb24oYSwgc3RhcnROb2RlKXsKICAgICAgICBzdGFydE5vZGUgPSBzdGFydE5vZGUgfHwgdGhpcy5yb290OwogICAgICAgIHZhciByID0gW107CiAgICAgICAgdmFyIGYgPSBmdW5jdGlvbigpewogICAgICAgICAgICBpZih0aGlzLmF0dHJpYnV0ZXMuY2hlY2tlZCl7CiAgICAgICAgICAgICAgICByLnB1c2goIWEgPyB0aGlzIDogKGEgPT0gJ2lkJyA/IHRoaXMuaWQgOiB0aGlzLmF0dHJpYnV0ZXNbYV0pKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgc3RhcnROb2RlLmNhc2NhZGUoZik7CiAgICAgICAgcmV0dXJuIHI7CiAgICB9LAoKICAgIAogICAgZ2V0TG9hZGVyIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5sb2FkZXI7CiAgICB9LAoKICAgIAogICAgZXhwYW5kQWxsIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnJvb3QuZXhwYW5kKHRydWUpOwogICAgfSwKCiAgICAKICAgIGNvbGxhcHNlQWxsIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnJvb3QuY29sbGFwc2UodHJ1ZSk7CiAgICB9LAoKICAgIAogICAgZ2V0U2VsZWN0aW9uTW9kZWwgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLnNlbE1vZGVsKXsKICAgICAgICAgICAgdGhpcy5zZWxNb2RlbCA9IG5ldyBFeHQudHJlZS5EZWZhdWx0U2VsZWN0aW9uTW9kZWwoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuc2VsTW9kZWw7CiAgICB9LAoKICAgIAogICAgZXhwYW5kUGF0aCA6IGZ1bmN0aW9uKHBhdGgsIGF0dHIsIGNhbGxiYWNrKXsKICAgICAgICBpZihFeHQuaXNFbXB0eShwYXRoKSl7CiAgICAgICAgICAgIGlmKGNhbGxiYWNrKXsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlLCB1bmRlZmluZWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgYXR0ciA9IGF0dHIgfHwgJ2lkJzsKICAgICAgICB2YXIga2V5cyA9IHBhdGguc3BsaXQodGhpcy5wYXRoU2VwYXJhdG9yKTsKICAgICAgICB2YXIgY3VyTm9kZSA9IHRoaXMucm9vdDsKICAgICAgICBpZihjdXJOb2RlLmF0dHJpYnV0ZXNbYXR0cl0gIT0ga2V5c1sxXSl7IAogICAgICAgICAgICBpZihjYWxsYmFjayl7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSAxOwogICAgICAgIHZhciBmID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgaWYoKytpbmRleCA9PSBrZXlzLmxlbmd0aCl7CiAgICAgICAgICAgICAgICBpZihjYWxsYmFjayl7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSwgY3VyTm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGMgPSBjdXJOb2RlLmZpbmRDaGlsZChhdHRyLCBrZXlzW2luZGV4XSk7CiAgICAgICAgICAgIGlmKCFjKXsKICAgICAgICAgICAgICAgIGlmKGNhbGxiYWNrKXsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSwgY3VyTm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VyTm9kZSA9IGM7CiAgICAgICAgICAgIGMuZXhwYW5kKGZhbHNlLCBmYWxzZSwgZik7CiAgICAgICAgfTsKICAgICAgICBjdXJOb2RlLmV4cGFuZChmYWxzZSwgZmFsc2UsIGYpOwogICAgfSwKCiAgICAKICAgIHNlbGVjdFBhdGggOiBmdW5jdGlvbihwYXRoLCBhdHRyLCBjYWxsYmFjayl7CiAgICAgICAgaWYoRXh0LmlzRW1wdHkocGF0aCkpewogICAgICAgICAgICBpZihjYWxsYmFjayl7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSwgdW5kZWZpbmVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGF0dHIgPSBhdHRyIHx8ICdpZCc7CiAgICAgICAgdmFyIGtleXMgPSBwYXRoLnNwbGl0KHRoaXMucGF0aFNlcGFyYXRvciksCiAgICAgICAgICAgIHYgPSBrZXlzLnBvcCgpOwogICAgICAgIGlmKGtleXMubGVuZ3RoID4gMSl7CiAgICAgICAgICAgIHZhciBmID0gZnVuY3Rpb24oc3VjY2Vzcywgbm9kZSl7CiAgICAgICAgICAgICAgICBpZihzdWNjZXNzICYmIG5vZGUpewogICAgICAgICAgICAgICAgICAgIHZhciBuID0gbm9kZS5maW5kQ2hpbGQoYXR0ciwgdik7CiAgICAgICAgICAgICAgICAgICAgaWYobil7CiAgICAgICAgICAgICAgICAgICAgICAgIG4uc2VsZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGNhbGxiYWNrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIG4pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYoY2FsbGJhY2spewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSwgbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgaWYoY2FsbGJhY2spewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhmYWxzZSwgbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmV4cGFuZFBhdGgoa2V5cy5qb2luKHRoaXMucGF0aFNlcGFyYXRvciksIGF0dHIsIGYpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLnJvb3Quc2VsZWN0KCk7CiAgICAgICAgICAgIGlmKGNhbGxiYWNrKXsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKHRydWUsIHRoaXMucm9vdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0VHJlZUVsIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5ib2R5OwogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKXsKICAgICAgICBFeHQudHJlZS5UcmVlUGFuZWwuc3VwZXJjbGFzcy5vblJlbmRlci5jYWxsKHRoaXMsIGN0LCBwb3NpdGlvbik7CiAgICAgICAgdGhpcy5lbC5hZGRDbGFzcygneC10cmVlJyk7CiAgICAgICAgdGhpcy5pbm5lckN0ID0gdGhpcy5ib2R5LmNyZWF0ZUNoaWxkKHt0YWc6J3VsJywKICAgICAgICAgICAgICAgY2xzOid4LXRyZWUtcm9vdC1jdCAnICsKICAgICAgICAgICAgICAgKHRoaXMudXNlQXJyb3dzID8gJ3gtdHJlZS1hcnJvd3MnIDogdGhpcy5saW5lcyA/ICd4LXRyZWUtbGluZXMnIDogJ3gtdHJlZS1uby1saW5lcycpfSk7CiAgICB9LAoKICAgIAogICAgaW5pdEV2ZW50cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LnRyZWUuVHJlZVBhbmVsLnN1cGVyY2xhc3MuaW5pdEV2ZW50cy5jYWxsKHRoaXMpOwoKICAgICAgICBpZih0aGlzLmNvbnRhaW5lclNjcm9sbCl7CiAgICAgICAgICAgIEV4dC5kZC5TY3JvbGxNYW5hZ2VyLnJlZ2lzdGVyKHRoaXMuYm9keSk7CiAgICAgICAgfQogICAgICAgIGlmKCh0aGlzLmVuYWJsZUREIHx8IHRoaXMuZW5hYmxlRHJvcCkgJiYgIXRoaXMuZHJvcFpvbmUpewogICAgICAgICAgIAogICAgICAgICAgICAgdGhpcy5kcm9wWm9uZSA9IG5ldyBFeHQudHJlZS5UcmVlRHJvcFpvbmUodGhpcywgdGhpcy5kcm9wQ29uZmlnIHx8IHsKICAgICAgICAgICAgICAgZGRHcm91cDogdGhpcy5kZEdyb3VwIHx8ICdUcmVlREQnLCBhcHBlbmRPbmx5OiB0aGlzLmRkQXBwZW5kT25seSA9PT0gdHJ1ZQogICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZigodGhpcy5lbmFibGVERCB8fCB0aGlzLmVuYWJsZURyYWcpICYmICF0aGlzLmRyYWdab25lKXsKICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kcmFnWm9uZSA9IG5ldyBFeHQudHJlZS5UcmVlRHJhZ1pvbmUodGhpcywgdGhpcy5kcmFnQ29uZmlnIHx8IHsKICAgICAgICAgICAgICAgZGRHcm91cDogdGhpcy5kZEdyb3VwIHx8ICdUcmVlREQnLAogICAgICAgICAgICAgICBzY3JvbGw6IHRoaXMuZGRTY3JvbGwKICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5nZXRTZWxlY3Rpb25Nb2RlbCgpLmluaXQodGhpcyk7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJSZW5kZXIgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC50cmVlLlRyZWVQYW5lbC5zdXBlcmNsYXNzLmFmdGVyUmVuZGVyLmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290KCk7CiAgICB9LAoKICAgIGJlZm9yZURlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICBFeHQuZGQuU2Nyb2xsTWFuYWdlci51bnJlZ2lzdGVyKHRoaXMuYm9keSk7CiAgICAgICAgICAgIEV4dC5kZXN0cm95KHRoaXMuZHJvcFpvbmUsIHRoaXMuZHJhZ1pvbmUpOwogICAgICAgIH0KICAgICAgICB0aGlzLmRlc3Ryb3lSb290KCk7CiAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy5sb2FkZXIpOwogICAgICAgIHRoaXMubm9kZUhhc2ggPSB0aGlzLnJvb3QgPSB0aGlzLmxvYWRlciA9IG51bGw7CiAgICAgICAgRXh0LnRyZWUuVHJlZVBhbmVsLnN1cGVyY2xhc3MuYmVmb3JlRGVzdHJveS5jYWxsKHRoaXMpOwogICAgfSwKICAgIAogICAgCiAgICBkZXN0cm95Um9vdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5yb290ICYmIHRoaXMucm9vdC5kZXN0cm95KXsKICAgICAgICAgICAgdGhpcy5yb290LmRlc3Ryb3kodHJ1ZSk7CiAgICAgICAgfQogICAgfQoKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAoKCgogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCn0pOwoKRXh0LnRyZWUuVHJlZVBhbmVsLm5vZGVUeXBlcyA9IHt9OwoKRXh0LnJlZygndHJlZXBhbmVsJywgRXh0LnRyZWUuVHJlZVBhbmVsKTtFeHQudHJlZS5UcmVlRXZlbnRNb2RlbCA9IGZ1bmN0aW9uKHRyZWUpewogICAgdGhpcy50cmVlID0gdHJlZTsKICAgIHRoaXMudHJlZS5vbigncmVuZGVyJywgdGhpcy5pbml0RXZlbnRzLCB0aGlzKTsKfTsKCkV4dC50cmVlLlRyZWVFdmVudE1vZGVsLnByb3RvdHlwZSA9IHsKICAgIGluaXRFdmVudHMgOiBmdW5jdGlvbigpewogICAgICAgIHZhciB0ID0gdGhpcy50cmVlOwoKICAgICAgICBpZih0LnRyYWNrTW91c2VPdmVyICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHQubW9uKHQuaW5uZXJDdCwgewogICAgICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgICAgICBtb3VzZW92ZXI6IHRoaXMuZGVsZWdhdGVPdmVyLAogICAgICAgICAgICAgICAgbW91c2VvdXQ6IHRoaXMuZGVsZWdhdGVPdXQKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHQubW9uKHQuZ2V0VHJlZUVsKCksIHsKICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgIGNsaWNrOiB0aGlzLmRlbGVnYXRlQ2xpY2ssCiAgICAgICAgICAgIGRibGNsaWNrOiB0aGlzLmRlbGVnYXRlRGJsQ2xpY2ssCiAgICAgICAgICAgIGNvbnRleHRtZW51OiB0aGlzLmRlbGVnYXRlQ29udGV4dE1lbnUKICAgICAgICB9KTsKICAgIH0sCgogICAgZ2V0Tm9kZSA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciB0OwogICAgICAgIGlmKHQgPSBlLmdldFRhcmdldCgnLngtdHJlZS1ub2RlLWVsJywgMTApKXsKICAgICAgICAgICAgdmFyIGlkID0gRXh0LmZseSh0LCAnX3RyZWVFdmVudHMnKS5nZXRBdHRyaWJ1dGUoJ3RyZWUtbm9kZS1pZCcsICdleHQnKTsKICAgICAgICAgICAgaWYoaWQpewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJlZS5nZXROb2RlQnlJZChpZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIGdldE5vZGVUYXJnZXQgOiBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgdCA9IGUuZ2V0VGFyZ2V0KCcueC10cmVlLW5vZGUtaWNvbicsIDEpOwogICAgICAgIGlmKCF0KXsKICAgICAgICAgICAgdCA9IGUuZ2V0VGFyZ2V0KCcueC10cmVlLW5vZGUtZWwnLCA2KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHQ7CiAgICB9LAoKICAgIGRlbGVnYXRlT3V0IDogZnVuY3Rpb24oZSwgdCl7CiAgICAgICAgaWYoIXRoaXMuYmVmb3JlRXZlbnQoZSkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGUuZ2V0VGFyZ2V0KCcueC10cmVlLWVjLWljb24nLCAxKSl7CiAgICAgICAgICAgIHZhciBuID0gdGhpcy5nZXROb2RlKGUpOwogICAgICAgICAgICB0aGlzLm9uSWNvbk91dChlLCBuKTsKICAgICAgICAgICAgaWYobiA9PSB0aGlzLmxhc3RFY092ZXIpewogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMubGFzdEVjT3ZlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZigodCA9IHRoaXMuZ2V0Tm9kZVRhcmdldChlKSkgJiYgIWUud2l0aGluKHQsIHRydWUpKXsKICAgICAgICAgICAgdGhpcy5vbk5vZGVPdXQoZSwgdGhpcy5nZXROb2RlKGUpKTsKICAgICAgICB9CiAgICB9LAoKICAgIGRlbGVnYXRlT3ZlciA6IGZ1bmN0aW9uKGUsIHQpewogICAgICAgIGlmKCF0aGlzLmJlZm9yZUV2ZW50KGUpKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihFeHQuaXNHZWNrbyAmJiAhdGhpcy50cmFja2luZ0RvYyl7IAogICAgICAgICAgICBFeHQuZ2V0Qm9keSgpLm9uKCdtb3VzZW92ZXInLCB0aGlzLnRyYWNrRXhpdCwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMudHJhY2tpbmdEb2MgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmxhc3RFY092ZXIpeyAKICAgICAgICAgICAgdGhpcy5vbkljb25PdXQoZSwgdGhpcy5sYXN0RWNPdmVyKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMubGFzdEVjT3ZlcjsKICAgICAgICB9CiAgICAgICAgaWYoZS5nZXRUYXJnZXQoJy54LXRyZWUtZWMtaWNvbicsIDEpKXsKICAgICAgICAgICAgdGhpcy5sYXN0RWNPdmVyID0gdGhpcy5nZXROb2RlKGUpOwogICAgICAgICAgICB0aGlzLm9uSWNvbk92ZXIoZSwgdGhpcy5sYXN0RWNPdmVyKTsKICAgICAgICB9CiAgICAgICAgaWYodCA9IHRoaXMuZ2V0Tm9kZVRhcmdldChlKSl7CiAgICAgICAgICAgIHRoaXMub25Ob2RlT3ZlcihlLCB0aGlzLmdldE5vZGUoZSkpOwogICAgICAgIH0KICAgIH0sCgogICAgdHJhY2tFeGl0IDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYodGhpcy5sYXN0T3Zlck5vZGUpewogICAgICAgICAgICBpZih0aGlzLmxhc3RPdmVyTm9kZS51aSAmJiAhZS53aXRoaW4odGhpcy5sYXN0T3Zlck5vZGUudWkuZ2V0RWwoKSkpewogICAgICAgICAgICAgICAgdGhpcy5vbk5vZGVPdXQoZSwgdGhpcy5sYXN0T3Zlck5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxhc3RPdmVyTm9kZTsKICAgICAgICAgICAgRXh0LmdldEJvZHkoKS51bignbW91c2VvdmVyJywgdGhpcy50cmFja0V4aXQsIHRoaXMpOwogICAgICAgICAgICB0aGlzLnRyYWNraW5nRG9jID0gZmFsc2U7CiAgICAgICAgfQoKICAgIH0sCgogICAgZGVsZWdhdGVDbGljayA6IGZ1bmN0aW9uKGUsIHQpewogICAgICAgIGlmKHRoaXMuYmVmb3JlRXZlbnQoZSkpewogICAgICAgICAgICBpZihlLmdldFRhcmdldCgnaW5wdXRbdHlwZT1jaGVja2JveF0nLCAxKSl7CiAgICAgICAgICAgICAgICB0aGlzLm9uQ2hlY2tib3hDbGljayhlLCB0aGlzLmdldE5vZGUoZSkpOwogICAgICAgICAgICB9ZWxzZSBpZihlLmdldFRhcmdldCgnLngtdHJlZS1lYy1pY29uJywgMSkpewogICAgICAgICAgICAgICAgdGhpcy5vbkljb25DbGljayhlLCB0aGlzLmdldE5vZGUoZSkpOwogICAgICAgICAgICB9ZWxzZSBpZih0aGlzLmdldE5vZGVUYXJnZXQoZSkpewogICAgICAgICAgICAgICAgdGhpcy5vbk5vZGVDbGljayhlLCB0aGlzLmdldE5vZGUoZSkpOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuY2hlY2tDb250YWluZXJFdmVudChlLCAnY2xpY2snKTsKICAgICAgICB9CiAgICB9LAoKICAgIGRlbGVnYXRlRGJsQ2xpY2sgOiBmdW5jdGlvbihlLCB0KXsKICAgICAgICBpZih0aGlzLmJlZm9yZUV2ZW50KGUpKXsKICAgICAgICAgICAgaWYodGhpcy5nZXROb2RlVGFyZ2V0KGUpKXsKICAgICAgICAgICAgICAgIHRoaXMub25Ob2RlRGJsQ2xpY2soZSwgdGhpcy5nZXROb2RlKGUpKTsKICAgICAgICAgICAgfQogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmNoZWNrQ29udGFpbmVyRXZlbnQoZSwgJ2RibGNsaWNrJyk7CiAgICAgICAgfQogICAgfSwKCiAgICBkZWxlZ2F0ZUNvbnRleHRNZW51IDogZnVuY3Rpb24oZSwgdCl7CiAgICAgICAgaWYodGhpcy5iZWZvcmVFdmVudChlKSl7CiAgICAgICAgICAgIGlmKHRoaXMuZ2V0Tm9kZVRhcmdldChlKSl7CiAgICAgICAgICAgICAgICB0aGlzLm9uTm9kZUNvbnRleHRNZW51KGUsIHRoaXMuZ2V0Tm9kZShlKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5jaGVja0NvbnRhaW5lckV2ZW50KGUsICdjb250ZXh0bWVudScpOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIGNoZWNrQ29udGFpbmVyRXZlbnQ6IGZ1bmN0aW9uKGUsIHR5cGUpewogICAgICAgIGlmKHRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHRoaXMub25Db250YWluZXJFdmVudChlLCB0eXBlKTsgICAgCiAgICB9LAoKICAgIG9uQ29udGFpbmVyRXZlbnQ6IGZ1bmN0aW9uKGUsIHR5cGUpewogICAgICAgIHRoaXMudHJlZS5maXJlRXZlbnQoJ2NvbnRhaW5lcicgKyB0eXBlLCB0aGlzLnRyZWUsIGUpOwogICAgfSwKCiAgICBvbk5vZGVDbGljayA6IGZ1bmN0aW9uKGUsIG5vZGUpewogICAgICAgIG5vZGUudWkub25DbGljayhlKTsKICAgIH0sCgogICAgb25Ob2RlT3ZlciA6IGZ1bmN0aW9uKGUsIG5vZGUpewogICAgICAgIHRoaXMubGFzdE92ZXJOb2RlID0gbm9kZTsKICAgICAgICBub2RlLnVpLm9uT3ZlcihlKTsKICAgIH0sCgogICAgb25Ob2RlT3V0IDogZnVuY3Rpb24oZSwgbm9kZSl7CiAgICAgICAgbm9kZS51aS5vbk91dChlKTsKICAgIH0sCgogICAgb25JY29uT3ZlciA6IGZ1bmN0aW9uKGUsIG5vZGUpewogICAgICAgIG5vZGUudWkuYWRkQ2xhc3MoJ3gtdHJlZS1lYy1vdmVyJyk7CiAgICB9LAoKICAgIG9uSWNvbk91dCA6IGZ1bmN0aW9uKGUsIG5vZGUpewogICAgICAgIG5vZGUudWkucmVtb3ZlQ2xhc3MoJ3gtdHJlZS1lYy1vdmVyJyk7CiAgICB9LAoKICAgIG9uSWNvbkNsaWNrIDogZnVuY3Rpb24oZSwgbm9kZSl7CiAgICAgICAgbm9kZS51aS5lY0NsaWNrKGUpOwogICAgfSwKCiAgICBvbkNoZWNrYm94Q2xpY2sgOiBmdW5jdGlvbihlLCBub2RlKXsKICAgICAgICBub2RlLnVpLm9uQ2hlY2tDaGFuZ2UoZSk7CiAgICB9LAoKICAgIG9uTm9kZURibENsaWNrIDogZnVuY3Rpb24oZSwgbm9kZSl7CiAgICAgICAgbm9kZS51aS5vbkRibENsaWNrKGUpOwogICAgfSwKCiAgICBvbk5vZGVDb250ZXh0TWVudSA6IGZ1bmN0aW9uKGUsIG5vZGUpewogICAgICAgIG5vZGUudWkub25Db250ZXh0TWVudShlKTsKICAgIH0sCgogICAgYmVmb3JlRXZlbnQgOiBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgbm9kZSA9IHRoaXMuZ2V0Tm9kZShlKTsKICAgICAgICBpZih0aGlzLmRpc2FibGVkIHx8ICFub2RlIHx8ICFub2RlLnVpKXsKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgZGlzYWJsZTogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmRpc2FibGVkID0gdHJ1ZTsKICAgIH0sCgogICAgZW5hYmxlOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKICAgIH0KfTsKRXh0LnRyZWUuRGVmYXVsdFNlbGVjdGlvbk1vZGVsID0gRXh0LmV4dGVuZChFeHQudXRpbC5PYnNlcnZhYmxlLCB7CiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICB0aGlzLnNlbE5vZGUgPSBudWxsOwogICAKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICdzZWxlY3Rpb25jaGFuZ2UnLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVzZWxlY3QnCiAgICAgICAgKTsKCiAgICAgICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CiAgICAgICAgRXh0LnRyZWUuRGVmYXVsdFNlbGVjdGlvbk1vZGVsLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsgICAgCiAgICB9LAogICAgCiAgICBpbml0IDogZnVuY3Rpb24odHJlZSl7CiAgICAgICAgdGhpcy50cmVlID0gdHJlZTsKICAgICAgICB0cmVlLm1vbih0cmVlLmdldFRyZWVFbCgpLCAna2V5ZG93bicsIHRoaXMub25LZXlEb3duLCB0aGlzKTsKICAgICAgICB0cmVlLm9uKCdjbGljaycsIHRoaXMub25Ob2RlQ2xpY2ssIHRoaXMpOwogICAgfSwKICAgIAogICAgb25Ob2RlQ2xpY2sgOiBmdW5jdGlvbihub2RlLCBlKXsKICAgICAgICB0aGlzLnNlbGVjdChub2RlKTsKICAgIH0sCiAgICAKICAgIAogICAgc2VsZWN0IDogZnVuY3Rpb24obm9kZSwgIHNlbGVjdE5leHROb2RlKXsKICAgICAgICAKICAgICAgICBpZiAoIUV4dC5mbHkobm9kZS51aS53cmFwKS5pc1Zpc2libGUoKSAmJiBzZWxlY3ROZXh0Tm9kZSkgewogICAgICAgICAgICByZXR1cm4gc2VsZWN0TmV4dE5vZGUuY2FsbCh0aGlzLCBub2RlKTsKICAgICAgICB9CiAgICAgICAgdmFyIGxhc3QgPSB0aGlzLnNlbE5vZGU7CiAgICAgICAgaWYobm9kZSA9PSBsYXN0KXsKICAgICAgICAgICAgbm9kZS51aS5vblNlbGVjdGVkQ2hhbmdlKHRydWUpOwogICAgICAgIH1lbHNlIGlmKHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVzZWxlY3QnLCB0aGlzLCBub2RlLCBsYXN0KSAhPT0gZmFsc2UpewogICAgICAgICAgICBpZihsYXN0ICYmIGxhc3QudWkpewogICAgICAgICAgICAgICAgbGFzdC51aS5vblNlbGVjdGVkQ2hhbmdlKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNlbE5vZGUgPSBub2RlOwogICAgICAgICAgICBub2RlLnVpLm9uU2VsZWN0ZWRDaGFuZ2UodHJ1ZSk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzZWxlY3Rpb25jaGFuZ2UnLCB0aGlzLCBub2RlLCBsYXN0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5vZGU7CiAgICB9LAogICAgCiAgICAKICAgIHVuc2VsZWN0IDogZnVuY3Rpb24obm9kZSwgc2lsZW50KXsKICAgICAgICBpZih0aGlzLnNlbE5vZGUgPT0gbm9kZSl7CiAgICAgICAgICAgIHRoaXMuY2xlYXJTZWxlY3Rpb25zKHNpbGVudCk7CiAgICAgICAgfSAgICAKICAgIH0sCiAgICAKICAgIAogICAgY2xlYXJTZWxlY3Rpb25zIDogZnVuY3Rpb24oc2lsZW50KXsKICAgICAgICB2YXIgbiA9IHRoaXMuc2VsTm9kZTsKICAgICAgICBpZihuKXsKICAgICAgICAgICAgbi51aS5vblNlbGVjdGVkQ2hhbmdlKGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5zZWxOb2RlID0gbnVsbDsKICAgICAgICAgICAgaWYoc2lsZW50ICE9PSB0cnVlKXsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzZWxlY3Rpb25jaGFuZ2UnLCB0aGlzLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbjsKICAgIH0sCiAgICAKICAgIAogICAgZ2V0U2VsZWN0ZWROb2RlIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5zZWxOb2RlOyAgICAKICAgIH0sCiAgICAKICAgIAogICAgaXNTZWxlY3RlZCA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHJldHVybiB0aGlzLnNlbE5vZGUgPT0gbm9kZTsgIAogICAgfSwKCiAgICAKICAgIHNlbGVjdFByZXZpb3VzIDogZnVuY3Rpb24oIHMpewogICAgICAgIGlmKCEocyA9IHMgfHwgdGhpcy5zZWxOb2RlIHx8IHRoaXMubGFzdFNlbE5vZGUpKXsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciBwcyA9IHMucHJldmlvdXNTaWJsaW5nOwogICAgICAgIGlmKHBzKXsKICAgICAgICAgICAgaWYoIXBzLmlzRXhwYW5kZWQoKSB8fCBwcy5jaGlsZE5vZGVzLmxlbmd0aCA8IDEpewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0KHBzLCB0aGlzLnNlbGVjdFByZXZpb3VzKTsKICAgICAgICAgICAgfSBlbHNlewogICAgICAgICAgICAgICAgdmFyIGxjID0gcHMubGFzdENoaWxkOwogICAgICAgICAgICAgICAgd2hpbGUobGMgJiYgbGMuaXNFeHBhbmRlZCgpICYmIEV4dC5mbHkobGMudWkud3JhcCkuaXNWaXNpYmxlKCkgJiYgbGMuY2hpbGROb2Rlcy5sZW5ndGggPiAwKXsKICAgICAgICAgICAgICAgICAgICBsYyA9IGxjLmxhc3RDaGlsZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNlbGVjdChsYywgdGhpcy5zZWxlY3RQcmV2aW91cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYocy5wYXJlbnROb2RlICYmICh0aGlzLnRyZWUucm9vdFZpc2libGUgfHwgIXMucGFyZW50Tm9kZS5pc1Jvb3QpKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0KHMucGFyZW50Tm9kZSwgdGhpcy5zZWxlY3RQcmV2aW91cyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAKICAgIHNlbGVjdE5leHQgOiBmdW5jdGlvbiggcyl7CiAgICAgICAgaWYoIShzID0gcyB8fCB0aGlzLnNlbE5vZGUgfHwgdGhpcy5sYXN0U2VsTm9kZSkpewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYocy5maXJzdENoaWxkICYmIHMuaXNFeHBhbmRlZCgpICYmIEV4dC5mbHkocy51aS53cmFwKS5pc1Zpc2libGUoKSl7CiAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3Qocy5maXJzdENoaWxkLCB0aGlzLnNlbGVjdE5leHQpOwogICAgICAgICB9ZWxzZSBpZihzLm5leHRTaWJsaW5nKXsKICAgICAgICAgICAgIHJldHVybiB0aGlzLnNlbGVjdChzLm5leHRTaWJsaW5nLCB0aGlzLnNlbGVjdE5leHQpOwogICAgICAgICB9ZWxzZSBpZihzLnBhcmVudE5vZGUpewogICAgICAgICAgICB2YXIgbmV3UyA9IG51bGw7CiAgICAgICAgICAgIHMucGFyZW50Tm9kZS5idWJibGUoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIGlmKHRoaXMubmV4dFNpYmxpbmcpewogICAgICAgICAgICAgICAgICAgIG5ld1MgPSB0aGlzLmdldE93bmVyVHJlZSgpLnNlbE1vZGVsLnNlbGVjdCh0aGlzLm5leHRTaWJsaW5nLCB0aGlzLnNlbGVjdE5leHQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBuZXdTOwogICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIG9uS2V5RG93biA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciBzID0gdGhpcy5zZWxOb2RlIHx8IHRoaXMubGFzdFNlbE5vZGU7CiAgICAgICAgCiAgICAgICAgdmFyIHNtID0gdGhpczsKICAgICAgICBpZighcyl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGsgPSBlLmdldEtleSgpOwogICAgICAgIHN3aXRjaChrKXsKICAgICAgICAgICAgIGNhc2UgZS5ET1dOOgogICAgICAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3ROZXh0KCk7CiAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgIGNhc2UgZS5VUDoKICAgICAgICAgICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0UHJldmlvdXMoKTsKICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgY2FzZSBlLlJJR0hUOgogICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICBpZihzLmhhc0NoaWxkTm9kZXMoKSl7CiAgICAgICAgICAgICAgICAgICAgIGlmKCFzLmlzRXhwYW5kZWQoKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICBzLmV4cGFuZCgpOwogICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZihzLmZpcnN0Q2hpbGQpewogICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3Qocy5maXJzdENoaWxkLCBlKTsKICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgY2FzZSBlLkxFRlQ6CiAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgIGlmKHMuaGFzQ2hpbGROb2RlcygpICYmIHMuaXNFeHBhbmRlZCgpKXsKICAgICAgICAgICAgICAgICAgICAgcy5jb2xsYXBzZSgpOwogICAgICAgICAgICAgICAgIH1lbHNlIGlmKHMucGFyZW50Tm9kZSAmJiAodGhpcy50cmVlLnJvb3RWaXNpYmxlIHx8IHMucGFyZW50Tm9kZSAhPSB0aGlzLnRyZWUuZ2V0Um9vdE5vZGUoKSkpewogICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdChzLnBhcmVudE5vZGUsIGUpOwogICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH07CiAgICB9Cn0pOwoKCkV4dC50cmVlLk11bHRpU2VsZWN0aW9uTW9kZWwgPSBFeHQuZXh0ZW5kKEV4dC51dGlsLk9ic2VydmFibGUsIHsKICAgIAogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIHRoaXMuc2VsTm9kZXMgPSBbXTsKICAgICAgICB0aGlzLnNlbE1hcCA9IHt9OwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ3NlbGVjdGlvbmNoYW5nZScKICAgICAgICApOwogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwogICAgICAgIEV4dC50cmVlLk11bHRpU2VsZWN0aW9uTW9kZWwuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMpOyAgICAKICAgIH0sCiAgICAKICAgIGluaXQgOiBmdW5jdGlvbih0cmVlKXsKICAgICAgICB0aGlzLnRyZWUgPSB0cmVlOwogICAgICAgIHRyZWUubW9uKHRyZWUuZ2V0VHJlZUVsKCksICdrZXlkb3duJywgdGhpcy5vbktleURvd24sIHRoaXMpOwogICAgICAgIHRyZWUub24oJ2NsaWNrJywgdGhpcy5vbk5vZGVDbGljaywgdGhpcyk7CiAgICB9LAogICAgCiAgICBvbk5vZGVDbGljayA6IGZ1bmN0aW9uKG5vZGUsIGUpewogICAgICAgIGlmKGUuY3RybEtleSAmJiB0aGlzLmlzU2VsZWN0ZWQobm9kZSkpewogICAgICAgICAgICB0aGlzLnVuc2VsZWN0KG5vZGUpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLnNlbGVjdChub2RlLCBlLCBlLmN0cmxLZXkpOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgc2VsZWN0IDogZnVuY3Rpb24obm9kZSwgZSwga2VlcEV4aXN0aW5nKXsKICAgICAgICBpZihrZWVwRXhpc3RpbmcgIT09IHRydWUpewogICAgICAgICAgICB0aGlzLmNsZWFyU2VsZWN0aW9ucyh0cnVlKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5pc1NlbGVjdGVkKG5vZGUpKXsKICAgICAgICAgICAgdGhpcy5sYXN0U2VsTm9kZSA9IG5vZGU7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICB0aGlzLnNlbE5vZGVzLnB1c2gobm9kZSk7CiAgICAgICAgdGhpcy5zZWxNYXBbbm9kZS5pZF0gPSBub2RlOwogICAgICAgIHRoaXMubGFzdFNlbE5vZGUgPSBub2RlOwogICAgICAgIG5vZGUudWkub25TZWxlY3RlZENoYW5nZSh0cnVlKTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnc2VsZWN0aW9uY2hhbmdlJywgdGhpcywgdGhpcy5zZWxOb2Rlcyk7CiAgICAgICAgcmV0dXJuIG5vZGU7CiAgICB9LAogICAgCiAgICAKICAgIHVuc2VsZWN0IDogZnVuY3Rpb24obm9kZSl7CiAgICAgICAgaWYodGhpcy5zZWxNYXBbbm9kZS5pZF0pewogICAgICAgICAgICBub2RlLnVpLm9uU2VsZWN0ZWRDaGFuZ2UoZmFsc2UpOwogICAgICAgICAgICB2YXIgc24gPSB0aGlzLnNlbE5vZGVzOwogICAgICAgICAgICB2YXIgaW5kZXggPSBzbi5pbmRleE9mKG5vZGUpOwogICAgICAgICAgICBpZihpbmRleCAhPSAtMSl7CiAgICAgICAgICAgICAgICB0aGlzLnNlbE5vZGVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIHRoaXMuc2VsTWFwW25vZGUuaWRdOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnc2VsZWN0aW9uY2hhbmdlJywgdGhpcywgdGhpcy5zZWxOb2Rlcyk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBjbGVhclNlbGVjdGlvbnMgOiBmdW5jdGlvbihzdXBwcmVzc0V2ZW50KXsKICAgICAgICB2YXIgc24gPSB0aGlzLnNlbE5vZGVzOwogICAgICAgIGlmKHNuLmxlbmd0aCA+IDApewogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBzbi5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICBzbltpXS51aS5vblNlbGVjdGVkQ2hhbmdlKGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNlbE5vZGVzID0gW107CiAgICAgICAgICAgIHRoaXMuc2VsTWFwID0ge307CiAgICAgICAgICAgIGlmKHN1cHByZXNzRXZlbnQgIT09IHRydWUpewogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3NlbGVjdGlvbmNoYW5nZScsIHRoaXMsIHRoaXMuc2VsTm9kZXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBpc1NlbGVjdGVkIDogZnVuY3Rpb24obm9kZSl7CiAgICAgICAgcmV0dXJuIHRoaXMuc2VsTWFwW25vZGUuaWRdID8gdHJ1ZSA6IGZhbHNlOyAgCiAgICB9LAogICAgCiAgICAKICAgIGdldFNlbGVjdGVkTm9kZXMgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnNlbE5vZGVzLmNvbmNhdChbXSk7CiAgICB9LAoKICAgIG9uS2V5RG93biA6IEV4dC50cmVlLkRlZmF1bHRTZWxlY3Rpb25Nb2RlbC5wcm90b3R5cGUub25LZXlEb3duLAoKICAgIHNlbGVjdE5leHQgOiBFeHQudHJlZS5EZWZhdWx0U2VsZWN0aW9uTW9kZWwucHJvdG90eXBlLnNlbGVjdE5leHQsCgogICAgc2VsZWN0UHJldmlvdXMgOiBFeHQudHJlZS5EZWZhdWx0U2VsZWN0aW9uTW9kZWwucHJvdG90eXBlLnNlbGVjdFByZXZpb3VzCn0pOwpFeHQuZGF0YS5UcmVlID0gRXh0LmV4dGVuZChFeHQudXRpbC5PYnNlcnZhYmxlLCB7CiAgICAKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihyb290KXsKICAgICAgICB0aGlzLm5vZGVIYXNoID0ge307CiAgICAgICAgCiAgICAgICAgdGhpcy5yb290ID0gbnVsbDsKICAgICAgICBpZihyb290KXsKICAgICAgICAgICAgdGhpcy5zZXRSb290Tm9kZShyb290KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAiYXBwZW5kIiwKICAgICAgICAgICAgCiAgICAgICAgICAgICJyZW1vdmUiLAogICAgICAgICAgICAKICAgICAgICAgICAgIm1vdmUiLAogICAgICAgICAgICAKICAgICAgICAgICAgImluc2VydCIsCiAgICAgICAgICAgIAogICAgICAgICAgICAiYmVmb3JlYXBwZW5kIiwKICAgICAgICAgICAgCiAgICAgICAgICAgICJiZWZvcmVyZW1vdmUiLAogICAgICAgICAgICAKICAgICAgICAgICAgImJlZm9yZW1vdmUiLAogICAgICAgICAgICAKICAgICAgICAgICAgImJlZm9yZWluc2VydCIKICAgICAgICApOwogICAgICAgIEV4dC5kYXRhLlRyZWUuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMpOyAgICAgICAgCiAgICB9LAogICAgCiAgICAKICAgIHBhdGhTZXBhcmF0b3I6ICIvIiwKCiAgICAKICAgIHByb3h5Tm9kZUV2ZW50IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5maXJlRXZlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgCiAgICBnZXRSb290Tm9kZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMucm9vdDsKICAgIH0sCgogICAgCiAgICBzZXRSb290Tm9kZSA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHRoaXMucm9vdCA9IG5vZGU7CiAgICAgICAgbm9kZS5vd25lclRyZWUgPSB0aGlzOwogICAgICAgIG5vZGUuaXNSb290ID0gdHJ1ZTsKICAgICAgICB0aGlzLnJlZ2lzdGVyTm9kZShub2RlKTsKICAgICAgICByZXR1cm4gbm9kZTsKICAgIH0sCgogICAgCiAgICBnZXROb2RlQnlJZCA6IGZ1bmN0aW9uKGlkKXsKICAgICAgICByZXR1cm4gdGhpcy5ub2RlSGFzaFtpZF07CiAgICB9LAoKICAgIAogICAgcmVnaXN0ZXJOb2RlIDogZnVuY3Rpb24obm9kZSl7CiAgICAgICAgdGhpcy5ub2RlSGFzaFtub2RlLmlkXSA9IG5vZGU7CiAgICB9LAoKICAgIAogICAgdW5yZWdpc3Rlck5vZGUgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICBkZWxldGUgdGhpcy5ub2RlSGFzaFtub2RlLmlkXTsKICAgIH0sCgogICAgdG9TdHJpbmcgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiAiW1RyZWUiKyh0aGlzLmlkPyIgIit0aGlzLmlkOiIiKSsiXSI7CiAgICB9Cn0pOwoKCkV4dC5kYXRhLk5vZGUgPSBFeHQuZXh0ZW5kKEV4dC51dGlsLk9ic2VydmFibGUsIHsKICAgIAogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMpewogICAgICAgIAogICAgICAgIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICAgICAgdGhpcy5sZWFmID0gdGhpcy5hdHRyaWJ1dGVzLmxlYWY7CiAgICAgICAgCiAgICAgICAgdGhpcy5pZCA9IHRoaXMuYXR0cmlidXRlcy5pZDsKICAgICAgICBpZighdGhpcy5pZCl7CiAgICAgICAgICAgIHRoaXMuaWQgPSBFeHQuaWQobnVsbCwgInhub2RlLSIpOwogICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZXMuaWQgPSB0aGlzLmlkOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLmNoaWxkTm9kZXMgPSBbXTsKICAgICAgICAKICAgICAgICB0aGlzLnBhcmVudE5vZGUgPSBudWxsOwogICAgICAgIAogICAgICAgIHRoaXMuZmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgCiAgICAgICAgdGhpcy5sYXN0Q2hpbGQgPSBudWxsOwogICAgICAgIAogICAgICAgIHRoaXMucHJldmlvdXNTaWJsaW5nID0gbnVsbDsKICAgICAgICAKICAgICAgICB0aGlzLm5leHRTaWJsaW5nID0gbnVsbDsKCiAgICAgICAgdGhpcy5hZGRFdmVudHMoewogICAgICAgICAgICAKICAgICAgICAgICAgImFwcGVuZCIgOiB0cnVlLAogICAgICAgICAgICAKICAgICAgICAgICAgInJlbW92ZSIgOiB0cnVlLAogICAgICAgICAgICAKICAgICAgICAgICAgIm1vdmUiIDogdHJ1ZSwKICAgICAgICAgICAgCiAgICAgICAgICAgICJpbnNlcnQiIDogdHJ1ZSwKICAgICAgICAgICAgCiAgICAgICAgICAgICJiZWZvcmVhcHBlbmQiIDogdHJ1ZSwKICAgICAgICAgICAgCiAgICAgICAgICAgICJiZWZvcmVyZW1vdmUiIDogdHJ1ZSwKICAgICAgICAgICAgCiAgICAgICAgICAgICJiZWZvcmVtb3ZlIiA6IHRydWUsCiAgICAgICAgICAgICAKICAgICAgICAgICAgImJlZm9yZWluc2VydCIgOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5saXN0ZW5lcnMgPSB0aGlzLmF0dHJpYnV0ZXMubGlzdGVuZXJzOwogICAgICAgIEV4dC5kYXRhLk5vZGUuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMpOyAgICAKICAgIH0sCiAgICAKICAgIAogICAgZmlyZUV2ZW50IDogZnVuY3Rpb24oZXZ0TmFtZSl7CiAgICAgICAgCiAgICAgICAgaWYoRXh0LmRhdGEuTm9kZS5zdXBlcmNsYXNzLmZpcmVFdmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpID09PSBmYWxzZSl7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIG90ID0gdGhpcy5nZXRPd25lclRyZWUoKTsKICAgICAgICBpZihvdCl7CiAgICAgICAgICAgIGlmKG90LnByb3h5Tm9kZUV2ZW50LmFwcGx5KG90LCBhcmd1bWVudHMpID09PSBmYWxzZSl7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIAogICAgaXNMZWFmIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5sZWFmID09PSB0cnVlOwogICAgfSwKCiAgICAKICAgIHNldEZpcnN0Q2hpbGQgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICB0aGlzLmZpcnN0Q2hpbGQgPSBub2RlOwogICAgfSwKCiAgICAKICAgIHNldExhc3RDaGlsZCA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHRoaXMubGFzdENoaWxkID0gbm9kZTsKICAgIH0sCgoKICAgIAogICAgaXNMYXN0IDogZnVuY3Rpb24oKXsKICAgICAgIHJldHVybiAoIXRoaXMucGFyZW50Tm9kZSA/IHRydWUgOiB0aGlzLnBhcmVudE5vZGUubGFzdENoaWxkID09IHRoaXMpOwogICAgfSwKCiAgICAKICAgIGlzRmlyc3QgOiBmdW5jdGlvbigpewogICAgICAgcmV0dXJuICghdGhpcy5wYXJlbnROb2RlID8gdHJ1ZSA6IHRoaXMucGFyZW50Tm9kZS5maXJzdENoaWxkID09IHRoaXMpOwogICAgfSwKCiAgICAKICAgIGhhc0NoaWxkTm9kZXMgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiAhdGhpcy5pc0xlYWYoKSAmJiB0aGlzLmNoaWxkTm9kZXMubGVuZ3RoID4gMDsKICAgIH0sCgogICAgCiAgICBpc0V4cGFuZGFibGUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXMuZXhwYW5kYWJsZSB8fCB0aGlzLmhhc0NoaWxkTm9kZXMoKTsKICAgIH0sCgogICAgCiAgICBhcHBlbmRDaGlsZCA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHZhciBtdWx0aSA9IGZhbHNlOwogICAgICAgIGlmKEV4dC5pc0FycmF5KG5vZGUpKXsKICAgICAgICAgICAgbXVsdGkgPSBub2RlOwogICAgICAgIH1lbHNlIGlmKGFyZ3VtZW50cy5sZW5ndGggPiAxKXsKICAgICAgICAgICAgbXVsdGkgPSBhcmd1bWVudHM7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmKG11bHRpKXsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gbXVsdGkubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQobXVsdGlbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCJiZWZvcmVhcHBlbmQiLCB0aGlzLm93bmVyVHJlZSwgdGhpcywgbm9kZSkgPT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmNoaWxkTm9kZXMubGVuZ3RoOwogICAgICAgICAgICB2YXIgb2xkUGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYob2xkUGFyZW50KXsKICAgICAgICAgICAgICAgIGlmKG5vZGUuZmlyZUV2ZW50KCJiZWZvcmVtb3ZlIiwgbm9kZS5nZXRPd25lclRyZWUoKSwgbm9kZSwgb2xkUGFyZW50LCB0aGlzLCBpbmRleCkgPT09IGZhbHNlKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvbGRQYXJlbnQucmVtb3ZlQ2hpbGQobm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5kZXggPSB0aGlzLmNoaWxkTm9kZXMubGVuZ3RoOwogICAgICAgICAgICBpZihpbmRleCA9PT0gMCl7CiAgICAgICAgICAgICAgICB0aGlzLnNldEZpcnN0Q2hpbGQobm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jaGlsZE5vZGVzLnB1c2gobm9kZSk7CiAgICAgICAgICAgIG5vZGUucGFyZW50Tm9kZSA9IHRoaXM7CiAgICAgICAgICAgIHZhciBwcyA9IHRoaXMuY2hpbGROb2Rlc1tpbmRleC0xXTsKICAgICAgICAgICAgaWYocHMpewogICAgICAgICAgICAgICAgbm9kZS5wcmV2aW91c1NpYmxpbmcgPSBwczsKICAgICAgICAgICAgICAgIHBzLm5leHRTaWJsaW5nID0gbm9kZTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBub2RlLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5uZXh0U2libGluZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuc2V0TGFzdENoaWxkKG5vZGUpOwogICAgICAgICAgICBub2RlLnNldE93bmVyVHJlZSh0aGlzLmdldE93bmVyVHJlZSgpKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImFwcGVuZCIsIHRoaXMub3duZXJUcmVlLCB0aGlzLCBub2RlLCBpbmRleCk7CiAgICAgICAgICAgIGlmKG9sZFBhcmVudCl7CiAgICAgICAgICAgICAgICBub2RlLmZpcmVFdmVudCgibW92ZSIsIHRoaXMub3duZXJUcmVlLCBub2RlLCBvbGRQYXJlbnQsIHRoaXMsIGluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVtb3ZlQ2hpbGQgOiBmdW5jdGlvbihub2RlLCBkZXN0cm95KXsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmNoaWxkTm9kZXMuaW5kZXhPZihub2RlKTsKICAgICAgICBpZihpbmRleCA9PSAtMSl7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoImJlZm9yZXJlbW92ZSIsIHRoaXMub3duZXJUcmVlLCB0aGlzLCBub2RlKSA9PT0gZmFsc2UpewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICB0aGlzLmNoaWxkTm9kZXMuc3BsaWNlKGluZGV4LCAxKTsKCiAgICAgICAgCiAgICAgICAgaWYobm9kZS5wcmV2aW91c1NpYmxpbmcpewogICAgICAgICAgICBub2RlLnByZXZpb3VzU2libGluZy5uZXh0U2libGluZyA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgfQogICAgICAgIGlmKG5vZGUubmV4dFNpYmxpbmcpewogICAgICAgICAgICBub2RlLm5leHRTaWJsaW5nLnByZXZpb3VzU2libGluZyA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYodGhpcy5maXJzdENoaWxkID09IG5vZGUpewogICAgICAgICAgICB0aGlzLnNldEZpcnN0Q2hpbGQobm9kZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMubGFzdENoaWxkID09IG5vZGUpewogICAgICAgICAgICB0aGlzLnNldExhc3RDaGlsZChub2RlLnByZXZpb3VzU2libGluZyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmZpcmVFdmVudCgicmVtb3ZlIiwgdGhpcy5vd25lclRyZWUsIHRoaXMsIG5vZGUpOwogICAgICAgIGlmKGRlc3Ryb3kpewogICAgICAgICAgICBub2RlLmRlc3Ryb3kodHJ1ZSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIG5vZGUuY2xlYXIoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5vZGU7CiAgICB9LAoKICAgIAogICAgY2xlYXIgOiBmdW5jdGlvbihkZXN0cm95KXsKICAgICAgICAKICAgICAgICB0aGlzLnNldE93bmVyVHJlZShudWxsLCBkZXN0cm95KTsKICAgICAgICB0aGlzLnBhcmVudE5vZGUgPSB0aGlzLnByZXZpb3VzU2libGluZyA9IHRoaXMubmV4dFNpYmxpbmcgPSBudWxsOwogICAgICAgIGlmKGRlc3Ryb3kpewogICAgICAgICAgICB0aGlzLmZpcnN0Q2hpbGQgPSB0aGlzLmxhc3RDaGlsZCA9IG51bGw7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRlc3Ryb3kgOiBmdW5jdGlvbiggc2lsZW50KXsKICAgICAgICAKICAgICAgICBpZihzaWxlbnQgPT09IHRydWUpewogICAgICAgICAgICB0aGlzLnB1cmdlTGlzdGVuZXJzKCk7CiAgICAgICAgICAgIHRoaXMuY2xlYXIodHJ1ZSk7CiAgICAgICAgICAgIEV4dC5lYWNoKHRoaXMuY2hpbGROb2RlcywgZnVuY3Rpb24obil7CiAgICAgICAgICAgICAgICBuLmRlc3Ryb3kodHJ1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLmNoaWxkTm9kZXMgPSBudWxsOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLnJlbW92ZSh0cnVlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaW5zZXJ0QmVmb3JlIDogZnVuY3Rpb24obm9kZSwgcmVmTm9kZSl7CiAgICAgICAgaWYoIXJlZk5vZGUpeyAKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kQ2hpbGQobm9kZSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmKG5vZGUgPT0gcmVmTm9kZSl7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCJiZWZvcmVpbnNlcnQiLCB0aGlzLm93bmVyVHJlZSwgdGhpcywgbm9kZSwgcmVmTm9kZSkgPT09IGZhbHNlKXsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmNoaWxkTm9kZXMuaW5kZXhPZihyZWZOb2RlKTsKICAgICAgICB2YXIgb2xkUGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgIHZhciByZWZJbmRleCA9IGluZGV4OwoKICAgICAgICAKICAgICAgICBpZihvbGRQYXJlbnQgPT0gdGhpcyAmJiB0aGlzLmNoaWxkTm9kZXMuaW5kZXhPZihub2RlKSA8IGluZGV4KXsKICAgICAgICAgICAgcmVmSW5kZXgtLTsKICAgICAgICB9CgogICAgICAgIAogICAgICAgIGlmKG9sZFBhcmVudCl7CiAgICAgICAgICAgIGlmKG5vZGUuZmlyZUV2ZW50KCJiZWZvcmVtb3ZlIiwgbm9kZS5nZXRPd25lclRyZWUoKSwgbm9kZSwgb2xkUGFyZW50LCB0aGlzLCBpbmRleCwgcmVmTm9kZSkgPT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvbGRQYXJlbnQucmVtb3ZlQ2hpbGQobm9kZSk7CiAgICAgICAgfQogICAgICAgIGlmKHJlZkluZGV4ID09PSAwKXsKICAgICAgICAgICAgdGhpcy5zZXRGaXJzdENoaWxkKG5vZGUpOwogICAgICAgIH0KICAgICAgICB0aGlzLmNoaWxkTm9kZXMuc3BsaWNlKHJlZkluZGV4LCAwLCBub2RlKTsKICAgICAgICBub2RlLnBhcmVudE5vZGUgPSB0aGlzOwogICAgICAgIHZhciBwcyA9IHRoaXMuY2hpbGROb2Rlc1tyZWZJbmRleC0xXTsKICAgICAgICBpZihwcyl7CiAgICAgICAgICAgIG5vZGUucHJldmlvdXNTaWJsaW5nID0gcHM7CiAgICAgICAgICAgIHBzLm5leHRTaWJsaW5nID0gbm9kZTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgbm9kZS5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgICAgIH0KICAgICAgICBub2RlLm5leHRTaWJsaW5nID0gcmVmTm9kZTsKICAgICAgICByZWZOb2RlLnByZXZpb3VzU2libGluZyA9IG5vZGU7CiAgICAgICAgbm9kZS5zZXRPd25lclRyZWUodGhpcy5nZXRPd25lclRyZWUoKSk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoImluc2VydCIsIHRoaXMub3duZXJUcmVlLCB0aGlzLCBub2RlLCByZWZOb2RlKTsKICAgICAgICBpZihvbGRQYXJlbnQpewogICAgICAgICAgICBub2RlLmZpcmVFdmVudCgibW92ZSIsIHRoaXMub3duZXJUcmVlLCBub2RlLCBvbGRQYXJlbnQsIHRoaXMsIHJlZkluZGV4LCByZWZOb2RlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5vZGU7CiAgICB9LAoKICAgIAogICAgcmVtb3ZlIDogZnVuY3Rpb24oZGVzdHJveSl7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSkgewogICAgICAgICAgICB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcywgZGVzdHJveSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHJlbW92ZUFsbCA6IGZ1bmN0aW9uKGRlc3Ryb3kpewogICAgICAgIHZhciBjbiA9IHRoaXMuY2hpbGROb2RlcywKICAgICAgICAgICAgbjsKICAgICAgICB3aGlsZSgobiA9IGNuWzBdKSl7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2hpbGQobiwgZGVzdHJveSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGl0ZW0gOiBmdW5jdGlvbihpbmRleCl7CiAgICAgICAgcmV0dXJuIHRoaXMuY2hpbGROb2Rlc1tpbmRleF07CiAgICB9LAoKICAgIAogICAgcmVwbGFjZUNoaWxkIDogZnVuY3Rpb24obmV3Q2hpbGQsIG9sZENoaWxkKXsKICAgICAgICB2YXIgcyA9IG9sZENoaWxkID8gb2xkQ2hpbGQubmV4dFNpYmxpbmcgOiBudWxsOwogICAgICAgIHRoaXMucmVtb3ZlQ2hpbGQob2xkQ2hpbGQpOwogICAgICAgIHRoaXMuaW5zZXJ0QmVmb3JlKG5ld0NoaWxkLCBzKTsKICAgICAgICByZXR1cm4gb2xkQ2hpbGQ7CiAgICB9LAoKICAgIAogICAgaW5kZXhPZiA6IGZ1bmN0aW9uKGNoaWxkKXsKICAgICAgICByZXR1cm4gdGhpcy5jaGlsZE5vZGVzLmluZGV4T2YoY2hpbGQpOwogICAgfSwKCiAgICAKICAgIGdldE93bmVyVHJlZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgCiAgICAgICAgaWYoIXRoaXMub3duZXJUcmVlKXsKICAgICAgICAgICAgdmFyIHAgPSB0aGlzOwogICAgICAgICAgICB3aGlsZShwKXsKICAgICAgICAgICAgICAgIGlmKHAub3duZXJUcmVlKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLm93bmVyVHJlZSA9IHAub3duZXJUcmVlOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcCA9IHAucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5vd25lclRyZWU7CiAgICB9LAoKICAgIAogICAgZ2V0RGVwdGggOiBmdW5jdGlvbigpewogICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgdmFyIHAgPSB0aGlzOwogICAgICAgIHdoaWxlKHAucGFyZW50Tm9kZSl7CiAgICAgICAgICAgICsrZGVwdGg7CiAgICAgICAgICAgIHAgPSBwLnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZXB0aDsKICAgIH0sCgogICAgCiAgICBzZXRPd25lclRyZWUgOiBmdW5jdGlvbih0cmVlLCBkZXN0cm95KXsKICAgICAgICAKICAgICAgICBpZih0cmVlICE9IHRoaXMub3duZXJUcmVlKXsKICAgICAgICAgICAgaWYodGhpcy5vd25lclRyZWUpewogICAgICAgICAgICAgICAgdGhpcy5vd25lclRyZWUudW5yZWdpc3Rlck5vZGUodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vd25lclRyZWUgPSB0cmVlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYoZGVzdHJveSAhPT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICBFeHQuZWFjaCh0aGlzLmNoaWxkTm9kZXMsIGZ1bmN0aW9uKG4pewogICAgICAgICAgICAgICAgICAgIG4uc2V0T3duZXJUcmVlKHRyZWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodHJlZSl7CiAgICAgICAgICAgICAgICB0cmVlLnJlZ2lzdGVyTm9kZSh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRJZDogZnVuY3Rpb24oaWQpewogICAgICAgIGlmKGlkICE9PSB0aGlzLmlkKXsKICAgICAgICAgICAgdmFyIHQgPSB0aGlzLm93bmVyVHJlZTsKICAgICAgICAgICAgaWYodCl7CiAgICAgICAgICAgICAgICB0LnVucmVnaXN0ZXJOb2RlKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaWQgPSB0aGlzLmF0dHJpYnV0ZXMuaWQgPSBpZDsKICAgICAgICAgICAgaWYodCl7CiAgICAgICAgICAgICAgICB0LnJlZ2lzdGVyTm9kZSh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm9uSWRDaGFuZ2UoaWQpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbklkQ2hhbmdlOiBFeHQuZW1wdHlGbiwKCiAgICAKICAgIGdldFBhdGggOiBmdW5jdGlvbihhdHRyKXsKICAgICAgICBhdHRyID0gYXR0ciB8fCAiaWQiOwogICAgICAgIHZhciBwID0gdGhpcy5wYXJlbnROb2RlOwogICAgICAgIHZhciBiID0gW3RoaXMuYXR0cmlidXRlc1thdHRyXV07CiAgICAgICAgd2hpbGUocCl7CiAgICAgICAgICAgIGIudW5zaGlmdChwLmF0dHJpYnV0ZXNbYXR0cl0pOwogICAgICAgICAgICBwID0gcC5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgc2VwID0gdGhpcy5nZXRPd25lclRyZWUoKS5wYXRoU2VwYXJhdG9yOwogICAgICAgIHJldHVybiBzZXAgKyBiLmpvaW4oc2VwKTsKICAgIH0sCgogICAgCiAgICBidWJibGUgOiBmdW5jdGlvbihmbiwgc2NvcGUsIGFyZ3MpewogICAgICAgIHZhciBwID0gdGhpczsKICAgICAgICB3aGlsZShwKXsKICAgICAgICAgICAgaWYoZm4uYXBwbHkoc2NvcGUgfHwgcCwgYXJncyB8fCBbcF0pID09PSBmYWxzZSl7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBwID0gcC5wYXJlbnROb2RlOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBjYXNjYWRlIDogZnVuY3Rpb24oZm4sIHNjb3BlLCBhcmdzKXsKICAgICAgICBpZihmbi5hcHBseShzY29wZSB8fCB0aGlzLCBhcmdzIHx8IFt0aGlzXSkgIT09IGZhbHNlKXsKICAgICAgICAgICAgdmFyIGNzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBjcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgY3NbaV0uY2FzY2FkZShmbiwgc2NvcGUsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGVhY2hDaGlsZCA6IGZ1bmN0aW9uKGZuLCBzY29wZSwgYXJncyl7CiAgICAgICAgdmFyIGNzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGNzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmKGZuLmFwcGx5KHNjb3BlIHx8IGNzW2ldLCBhcmdzIHx8IFtjc1tpXV0pID09PSBmYWxzZSl7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBmaW5kQ2hpbGQgOiBmdW5jdGlvbihhdHRyaWJ1dGUsIHZhbHVlLCBkZWVwKXsKICAgICAgICByZXR1cm4gdGhpcy5maW5kQ2hpbGRCeShmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJpYnV0ZV0gPT0gdmFsdWU7CiAgICAgICAgfSwgbnVsbCwgZGVlcCk7CiAgICB9LAoKICAgIAogICAgZmluZENoaWxkQnkgOiBmdW5jdGlvbihmbiwgc2NvcGUsIGRlZXApewogICAgICAgIHZhciBjcyA9IHRoaXMuY2hpbGROb2RlcywKICAgICAgICAgICAgbGVuID0gY3MubGVuZ3RoLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbiwKICAgICAgICAgICAgcmVzOwogICAgICAgIGZvcig7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIG4gPSBjc1tpXTsKICAgICAgICAgICAgaWYoZm4uY2FsbChzY29wZSB8fCBuLCBuKSA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICByZXR1cm4gbjsKICAgICAgICAgICAgfWVsc2UgaWYgKGRlZXApewogICAgICAgICAgICAgICAgcmVzID0gbi5maW5kQ2hpbGRCeShmbiwgc2NvcGUsIGRlZXApOwogICAgICAgICAgICAgICAgaWYocmVzICE9IG51bGwpewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAKICAgIHNvcnQgOiBmdW5jdGlvbihmbiwgc2NvcGUpewogICAgICAgIHZhciBjcyA9IHRoaXMuY2hpbGROb2RlczsKICAgICAgICB2YXIgbGVuID0gY3MubGVuZ3RoOwogICAgICAgIGlmKGxlbiA+IDApewogICAgICAgICAgICB2YXIgc29ydEZuID0gc2NvcGUgPyBmdW5jdGlvbigpe2ZuLmFwcGx5KHNjb3BlLCBhcmd1bWVudHMpO30gOiBmbjsKICAgICAgICAgICAgY3Muc29ydChzb3J0Rm4pOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgdmFyIG4gPSBjc1tpXTsKICAgICAgICAgICAgICAgIG4ucHJldmlvdXNTaWJsaW5nID0gY3NbaS0xXTsKICAgICAgICAgICAgICAgIG4ubmV4dFNpYmxpbmcgPSBjc1tpKzFdOwogICAgICAgICAgICAgICAgaWYoaSA9PT0gMCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRGaXJzdENoaWxkKG4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoaSA9PSBsZW4tMSl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRMYXN0Q2hpbGQobik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgY29udGFpbnMgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICByZXR1cm4gbm9kZS5pc0FuY2VzdG9yKHRoaXMpOwogICAgfSwKCiAgICAKICAgIGlzQW5jZXN0b3IgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICB2YXIgcCA9IHRoaXMucGFyZW50Tm9kZTsKICAgICAgICB3aGlsZShwKXsKICAgICAgICAgICAgaWYocCA9PSBub2RlKXsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHAgPSBwLnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgdG9TdHJpbmcgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiAiW05vZGUiKyh0aGlzLmlkPyIgIit0aGlzLmlkOiIiKSsiXSI7CiAgICB9Cn0pOwpFeHQudHJlZS5UcmVlTm9kZSA9IEV4dC5leHRlbmQoRXh0LmRhdGEuTm9kZSwgewogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMpewogICAgICAgIGF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgICAgIGlmKEV4dC5pc1N0cmluZyhhdHRyaWJ1dGVzKSl7CiAgICAgICAgICAgIGF0dHJpYnV0ZXMgPSB7dGV4dDogYXR0cmlidXRlc307CiAgICAgICAgfQogICAgICAgIHRoaXMuY2hpbGRyZW5SZW5kZXJlZCA9IGZhbHNlOwogICAgICAgIHRoaXMucmVuZGVyZWQgPSBmYWxzZTsKICAgICAgICBFeHQudHJlZS5UcmVlTm9kZS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5leHBhbmRlZCA9IGF0dHJpYnV0ZXMuZXhwYW5kZWQgPT09IHRydWU7CiAgICAgICAgdGhpcy5pc1RhcmdldCA9IGF0dHJpYnV0ZXMuaXNUYXJnZXQgIT09IGZhbHNlOwogICAgICAgIHRoaXMuZHJhZ2dhYmxlID0gYXR0cmlidXRlcy5kcmFnZ2FibGUgIT09IGZhbHNlICYmIGF0dHJpYnV0ZXMuYWxsb3dEcmFnICE9PSBmYWxzZTsKICAgICAgICB0aGlzLmFsbG93Q2hpbGRyZW4gPSBhdHRyaWJ1dGVzLmFsbG93Q2hpbGRyZW4gIT09IGZhbHNlICYmIGF0dHJpYnV0ZXMuYWxsb3dEcm9wICE9PSBmYWxzZTsKCiAgICAgICAgCiAgICAgICAgdGhpcy50ZXh0ID0gYXR0cmlidXRlcy50ZXh0OwogICAgICAgIAogICAgICAgIHRoaXMuZGlzYWJsZWQgPSBhdHRyaWJ1dGVzLmRpc2FibGVkID09PSB0cnVlOwogICAgICAgIAogICAgICAgIHRoaXMuaGlkZGVuID0gYXR0cmlidXRlcy5oaWRkZW4gPT09IHRydWU7CiAgICAKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICd0ZXh0Y2hhbmdlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVleHBhbmQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZWNvbGxhcHNlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdleHBhbmQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2Rpc2FibGVkY2hhbmdlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjb2xsYXBzZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYmVmb3JlY2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjaGVja2NoYW5nZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYmVmb3JlZGJsY2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2RibGNsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjb250ZXh0bWVudScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYmVmb3JlY2hpbGRyZW5yZW5kZXJlZCcKICAgICAgICApOwogICAgCiAgICAgICAgdmFyIHVpQ2xhc3MgPSB0aGlzLmF0dHJpYnV0ZXMudWlQcm92aWRlciB8fCB0aGlzLmRlZmF1bHRVSSB8fCBFeHQudHJlZS5UcmVlTm9kZVVJOwogICAgCiAgICAgICAgCiAgICAgICAgdGhpcy51aSA9IG5ldyB1aUNsYXNzKHRoaXMpOyAgICAKICAgIH0sCiAgICAKICAgIHByZXZlbnRIU2Nyb2xsIDogdHJ1ZSwKICAgIAogICAgaXNFeHBhbmRlZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZXhwYW5kZWQ7CiAgICB9LAoKCiAgICBnZXRVSSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMudWk7CiAgICB9LAoKICAgIGdldExvYWRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIG93bmVyOwogICAgICAgIHJldHVybiB0aGlzLmxvYWRlciB8fCAoKG93bmVyID0gdGhpcy5nZXRPd25lclRyZWUoKSkgJiYgb3duZXIubG9hZGVyID8gb3duZXIubG9hZGVyIDogKHRoaXMubG9hZGVyID0gbmV3IEV4dC50cmVlLlRyZWVMb2FkZXIoKSkpOwogICAgfSwKCiAgICAKICAgIHNldEZpcnN0Q2hpbGQgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICB2YXIgb2YgPSB0aGlzLmZpcnN0Q2hpbGQ7CiAgICAgICAgRXh0LnRyZWUuVHJlZU5vZGUuc3VwZXJjbGFzcy5zZXRGaXJzdENoaWxkLmNhbGwodGhpcywgbm9kZSk7CiAgICAgICAgaWYodGhpcy5jaGlsZHJlblJlbmRlcmVkICYmIG9mICYmIG5vZGUgIT0gb2YpewogICAgICAgICAgICBvZi5yZW5kZXJJbmRlbnQodHJ1ZSwgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLnJlbmRlckluZGVudCh0cnVlLCB0cnVlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0TGFzdENoaWxkIDogZnVuY3Rpb24obm9kZSl7CiAgICAgICAgdmFyIG9sID0gdGhpcy5sYXN0Q2hpbGQ7CiAgICAgICAgRXh0LnRyZWUuVHJlZU5vZGUuc3VwZXJjbGFzcy5zZXRMYXN0Q2hpbGQuY2FsbCh0aGlzLCBub2RlKTsKICAgICAgICBpZih0aGlzLmNoaWxkcmVuUmVuZGVyZWQgJiYgb2wgJiYgbm9kZSAhPSBvbCl7CiAgICAgICAgICAgIG9sLnJlbmRlckluZGVudCh0cnVlLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMucmVuZGVySW5kZW50KHRydWUsIHRydWUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICAKICAgIGFwcGVuZENoaWxkIDogZnVuY3Rpb24obil7CiAgICAgICAgaWYoIW4ucmVuZGVyICYmICFFeHQuaXNBcnJheShuKSl7CiAgICAgICAgICAgIG4gPSB0aGlzLmdldExvYWRlcigpLmNyZWF0ZU5vZGUobik7CiAgICAgICAgfQogICAgICAgIHZhciBub2RlID0gRXh0LnRyZWUuVHJlZU5vZGUuc3VwZXJjbGFzcy5hcHBlbmRDaGlsZC5jYWxsKHRoaXMsIG4pOwogICAgICAgIGlmKG5vZGUgJiYgdGhpcy5jaGlsZHJlblJlbmRlcmVkKXsKICAgICAgICAgICAgbm9kZS5yZW5kZXIoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy51aS51cGRhdGVFeHBhbmRJY29uKCk7CiAgICAgICAgcmV0dXJuIG5vZGU7CiAgICB9LAoKICAgIAogICAgcmVtb3ZlQ2hpbGQgOiBmdW5jdGlvbihub2RlLCBkZXN0cm95KXsKICAgICAgICB0aGlzLm93bmVyVHJlZS5nZXRTZWxlY3Rpb25Nb2RlbCgpLnVuc2VsZWN0KG5vZGUpOwogICAgICAgIEV4dC50cmVlLlRyZWVOb2RlLnN1cGVyY2xhc3MucmVtb3ZlQ2hpbGQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAKICAgICAgICBpZighZGVzdHJveSl7CiAgICAgICAgICAgIHZhciByZW5kZXJlZCA9IG5vZGUudWkucmVuZGVyZWQ7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZihyZW5kZXJlZCl7CiAgICAgICAgICAgICAgICBub2RlLnVpLnJlbW92ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHJlbmRlcmVkICYmIHRoaXMuY2hpbGROb2Rlcy5sZW5ndGggPCAxKXsKICAgICAgICAgICAgICAgIHRoaXMuY29sbGFwc2UoZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICB0aGlzLnVpLnVwZGF0ZUV4cGFuZEljb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighdGhpcy5maXJzdENoaWxkICYmICF0aGlzLmlzSGlkZGVuUm9vdCgpKXsKICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW5SZW5kZXJlZCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBub2RlOwogICAgfSwKCiAgICAKICAgIGluc2VydEJlZm9yZSA6IGZ1bmN0aW9uKG5vZGUsIHJlZk5vZGUpewogICAgICAgIGlmKCFub2RlLnJlbmRlcil7CiAgICAgICAgICAgIG5vZGUgPSB0aGlzLmdldExvYWRlcigpLmNyZWF0ZU5vZGUobm9kZSk7CiAgICAgICAgfQogICAgICAgIHZhciBuZXdOb2RlID0gRXh0LnRyZWUuVHJlZU5vZGUuc3VwZXJjbGFzcy5pbnNlcnRCZWZvcmUuY2FsbCh0aGlzLCBub2RlLCByZWZOb2RlKTsKICAgICAgICBpZihuZXdOb2RlICYmIHJlZk5vZGUgJiYgdGhpcy5jaGlsZHJlblJlbmRlcmVkKXsKICAgICAgICAgICAgbm9kZS5yZW5kZXIoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy51aS51cGRhdGVFeHBhbmRJY29uKCk7CiAgICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICB9LAoKICAgIAogICAgc2V0VGV4dCA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgIHZhciBvbGRUZXh0ID0gdGhpcy50ZXh0OwogICAgICAgIHRoaXMudGV4dCA9IHRoaXMuYXR0cmlidXRlcy50ZXh0ID0gdGV4dDsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsgCiAgICAgICAgICAgIHRoaXMudWkub25UZXh0Q2hhbmdlKHRoaXMsIHRleHQsIG9sZFRleHQpOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgndGV4dGNoYW5nZScsIHRoaXMsIHRleHQsIG9sZFRleHQpOwogICAgfSwKICAgIAogICAgCiAgICBzZXRJY29uQ2xzIDogZnVuY3Rpb24oY2xzKXsKICAgICAgICB2YXIgb2xkID0gdGhpcy5hdHRyaWJ1dGVzLmljb25DbHM7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzLmljb25DbHMgPSBjbHM7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMudWkub25JY29uQ2xzQ2hhbmdlKHRoaXMsIGNscywgb2xkKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIHNldFRvb2x0aXAgOiBmdW5jdGlvbih0aXAsIHRpdGxlKXsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMucXRpcCA9IHRpcDsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMucXRpcFRpdGxlID0gdGl0bGU7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMudWkub25UaXBDaGFuZ2UodGhpcywgdGlwLCB0aXRsZSk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBzZXRJY29uIDogZnVuY3Rpb24oaWNvbil7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzLmljb24gPSBpY29uOwogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLnVpLm9uSWNvbkNoYW5nZSh0aGlzLCBpY29uKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIHNldEhyZWYgOiBmdW5jdGlvbihocmVmLCB0YXJnZXQpewogICAgICAgIHRoaXMuYXR0cmlidXRlcy5ocmVmID0gaHJlZjsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMuaHJlZlRhcmdldCA9IHRhcmdldDsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy51aS5vbkhyZWZDaGFuZ2UodGhpcywgaHJlZiwgdGFyZ2V0KTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIHNldENscyA6IGZ1bmN0aW9uKGNscyl7CiAgICAgICAgdmFyIG9sZCA9IHRoaXMuYXR0cmlidXRlcy5jbHM7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzLmNscyA9IGNsczsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy51aS5vbkNsc0NoYW5nZSh0aGlzLCBjbHMsIG9sZCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNlbGVjdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHQgPSB0aGlzLmdldE93bmVyVHJlZSgpOwogICAgICAgIGlmKHQpewogICAgICAgICAgICB0LmdldFNlbGVjdGlvbk1vZGVsKCkuc2VsZWN0KHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICB1bnNlbGVjdCA6IGZ1bmN0aW9uKHNpbGVudCl7CiAgICAgICAgdmFyIHQgPSB0aGlzLmdldE93bmVyVHJlZSgpOwogICAgICAgIGlmKHQpewogICAgICAgICAgICB0LmdldFNlbGVjdGlvbk1vZGVsKCkudW5zZWxlY3QodGhpcywgc2lsZW50KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaXNTZWxlY3RlZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHQgPSB0aGlzLmdldE93bmVyVHJlZSgpOwogICAgICAgIHJldHVybiB0ID8gdC5nZXRTZWxlY3Rpb25Nb2RlbCgpLmlzU2VsZWN0ZWQodGhpcykgOiBmYWxzZTsKICAgIH0sCgogICAgCiAgICBleHBhbmQgOiBmdW5jdGlvbihkZWVwLCBhbmltLCBjYWxsYmFjaywgc2NvcGUpewogICAgICAgIGlmKCF0aGlzLmV4cGFuZGVkKXsKICAgICAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoJ2JlZm9yZWV4cGFuZCcsIHRoaXMsIGRlZXAsIGFuaW0pID09PSBmYWxzZSl7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMuY2hpbGRyZW5SZW5kZXJlZCl7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckNoaWxkcmVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5leHBhbmRlZCA9IHRydWU7CiAgICAgICAgICAgIGlmKCF0aGlzLmlzSGlkZGVuUm9vdCgpICYmICh0aGlzLmdldE93bmVyVHJlZSgpLmFuaW1hdGUgJiYgYW5pbSAhPT0gZmFsc2UpIHx8IGFuaW0pewogICAgICAgICAgICAgICAgdGhpcy51aS5hbmltRXhwYW5kKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2V4cGFuZCcsIHRoaXMpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucnVuQ2FsbGJhY2soY2FsbGJhY2ssIHNjb3BlIHx8IHRoaXMsIFt0aGlzXSk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGVlcCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhwYW5kQ2hpbGROb2Rlcyh0cnVlLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LmNyZWF0ZURlbGVnYXRlKHRoaXMpKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmV4cGFuZCgpOwogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2V4cGFuZCcsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5ydW5DYWxsYmFjayhjYWxsYmFjaywgc2NvcGUgfHwgdGhpcywgW3RoaXNdKTsKICAgICAgICAgICAgfQogICAgICAgIH1lbHNlewogICAgICAgICAgIHRoaXMucnVuQ2FsbGJhY2soY2FsbGJhY2ssIHNjb3BlIHx8IHRoaXMsIFt0aGlzXSk7CiAgICAgICAgfQogICAgICAgIGlmKGRlZXAgPT09IHRydWUpewogICAgICAgICAgICB0aGlzLmV4cGFuZENoaWxkTm9kZXModHJ1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICBydW5DYWxsYmFjayA6IGZ1bmN0aW9uKGNiLCBzY29wZSwgYXJncyl7CiAgICAgICAgaWYoRXh0LmlzRnVuY3Rpb24oY2IpKXsKICAgICAgICAgICAgY2IuYXBwbHkoc2NvcGUsIGFyZ3MpOwogICAgICAgIH0KICAgIH0sCgogICAgaXNIaWRkZW5Sb290IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pc1Jvb3QgJiYgIXRoaXMuZ2V0T3duZXJUcmVlKCkucm9vdFZpc2libGU7CiAgICB9LAoKICAgIAogICAgY29sbGFwc2UgOiBmdW5jdGlvbihkZWVwLCBhbmltLCBjYWxsYmFjaywgc2NvcGUpewogICAgICAgIGlmKHRoaXMuZXhwYW5kZWQgJiYgIXRoaXMuaXNIaWRkZW5Sb290KCkpewogICAgICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3JlY29sbGFwc2UnLCB0aGlzLCBkZWVwLCBhbmltKSA9PT0gZmFsc2UpewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXhwYW5kZWQgPSBmYWxzZTsKICAgICAgICAgICAgaWYoKHRoaXMuZ2V0T3duZXJUcmVlKCkuYW5pbWF0ZSAmJiBhbmltICE9PSBmYWxzZSkgfHwgYW5pbSl7CiAgICAgICAgICAgICAgICB0aGlzLnVpLmFuaW1Db2xsYXBzZShmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjb2xsYXBzZScsIHRoaXMpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucnVuQ2FsbGJhY2soY2FsbGJhY2ssIHNjb3BlIHx8IHRoaXMsIFt0aGlzXSk7CiAgICAgICAgICAgICAgICAgICAgaWYoZGVlcCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGFwc2VDaGlsZE5vZGVzKHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0uY3JlYXRlRGVsZWdhdGUodGhpcykpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMudWkuY29sbGFwc2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjb2xsYXBzZScsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5ydW5DYWxsYmFjayhjYWxsYmFjaywgc2NvcGUgfHwgdGhpcywgW3RoaXNdKTsKICAgICAgICAgICAgfQogICAgICAgIH1lbHNlIGlmKCF0aGlzLmV4cGFuZGVkKXsKICAgICAgICAgICAgdGhpcy5ydW5DYWxsYmFjayhjYWxsYmFjaywgc2NvcGUgfHwgdGhpcywgW3RoaXNdKTsKICAgICAgICB9CiAgICAgICAgaWYoZGVlcCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHZhciBjcyA9IHRoaXMuY2hpbGROb2RlczsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gY3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgCWNzW2ldLmNvbGxhcHNlKHRydWUsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBkZWxheWVkRXhwYW5kIDogZnVuY3Rpb24oZGVsYXkpewogICAgICAgIGlmKCF0aGlzLmV4cGFuZFByb2NJZCl7CiAgICAgICAgICAgIHRoaXMuZXhwYW5kUHJvY0lkID0gdGhpcy5leHBhbmQuZGVmZXIoZGVsYXksIHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBjYW5jZWxFeHBhbmQgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuZXhwYW5kUHJvY0lkKXsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZXhwYW5kUHJvY0lkKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5leHBhbmRQcm9jSWQgPSBmYWxzZTsKICAgIH0sCgogICAgCiAgICB0b2dnbGUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuZXhwYW5kZWQpewogICAgICAgICAgICB0aGlzLmNvbGxhcHNlKCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuZXhwYW5kKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGVuc3VyZVZpc2libGUgOiBmdW5jdGlvbihjYWxsYmFjaywgc2NvcGUpewogICAgICAgIHZhciB0cmVlID0gdGhpcy5nZXRPd25lclRyZWUoKTsKICAgICAgICB0cmVlLmV4cGFuZFBhdGgodGhpcy5wYXJlbnROb2RlID8gdGhpcy5wYXJlbnROb2RlLmdldFBhdGgoKSA6IHRoaXMuZ2V0UGF0aCgpLCBmYWxzZSwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIG5vZGUgPSB0cmVlLmdldE5vZGVCeUlkKHRoaXMuaWQpOyAgCiAgICAgICAgICAgIHRyZWUuZ2V0VHJlZUVsKCkuc2Nyb2xsQ2hpbGRJbnRvVmlldyhub2RlLnVpLmFuY2hvcik7CiAgICAgICAgICAgIHRoaXMucnVuQ2FsbGJhY2soY2FsbGJhY2ssIHNjb3BlIHx8IHRoaXMsIFt0aGlzXSk7CiAgICAgICAgfS5jcmVhdGVEZWxlZ2F0ZSh0aGlzKSk7CiAgICB9LAoKICAgIAogICAgZXhwYW5kQ2hpbGROb2RlcyA6IGZ1bmN0aW9uKGRlZXAsIGFuaW0pIHsKICAgICAgICB2YXIgY3MgPSB0aGlzLmNoaWxkTm9kZXMsCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIGxlbiA9IGNzLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAJY3NbaV0uZXhwYW5kKGRlZXAsIGFuaW0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBjb2xsYXBzZUNoaWxkTm9kZXMgOiBmdW5jdGlvbihkZWVwKXsKICAgICAgICB2YXIgY3MgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gY3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAJY3NbaV0uY29sbGFwc2UoZGVlcCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRpc2FibGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgIHRoaXMudW5zZWxlY3QoKTsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkICYmIHRoaXMudWkub25EaXNhYmxlQ2hhbmdlKXsgCiAgICAgICAgICAgIHRoaXMudWkub25EaXNhYmxlQ2hhbmdlKHRoaXMsIHRydWUpOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgnZGlzYWJsZWRjaGFuZ2UnLCB0aGlzLCB0cnVlKTsKICAgIH0sCgogICAgCiAgICBlbmFibGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkICYmIHRoaXMudWkub25EaXNhYmxlQ2hhbmdlKXsgCiAgICAgICAgICAgIHRoaXMudWkub25EaXNhYmxlQ2hhbmdlKHRoaXMsIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2Rpc2FibGVkY2hhbmdlJywgdGhpcywgZmFsc2UpOwogICAgfSwKCiAgICAKICAgIHJlbmRlckNoaWxkcmVuIDogZnVuY3Rpb24oc3VwcHJlc3NFdmVudCl7CiAgICAgICAgaWYoc3VwcHJlc3NFdmVudCAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnYmVmb3JlY2hpbGRyZW5yZW5kZXJlZCcsIHRoaXMpOwogICAgICAgIH0KICAgICAgICB2YXIgY3MgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gY3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICBjc1tpXS5yZW5kZXIodHJ1ZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuY2hpbGRyZW5SZW5kZXJlZCA9IHRydWU7CiAgICB9LAoKICAgIAogICAgc29ydCA6IGZ1bmN0aW9uKGZuLCBzY29wZSl7CiAgICAgICAgRXh0LnRyZWUuVHJlZU5vZGUuc3VwZXJjbGFzcy5zb3J0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgaWYodGhpcy5jaGlsZHJlblJlbmRlcmVkKXsKICAgICAgICAgICAgdmFyIGNzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBjcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICBjc1tpXS5yZW5kZXIodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVuZGVyIDogZnVuY3Rpb24oYnVsa1JlbmRlcil7CiAgICAgICAgdGhpcy51aS5yZW5kZXIoYnVsa1JlbmRlcik7CiAgICAgICAgaWYoIXRoaXMucmVuZGVyZWQpewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5nZXRPd25lclRyZWUoKS5yZWdpc3Rlck5vZGUodGhpcyk7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZWQgPSB0cnVlOwogICAgICAgICAgICBpZih0aGlzLmV4cGFuZGVkKXsKICAgICAgICAgICAgICAgIHRoaXMuZXhwYW5kZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuZXhwYW5kKGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVuZGVySW5kZW50IDogZnVuY3Rpb24oZGVlcCwgcmVmcmVzaCl7CiAgICAgICAgaWYocmVmcmVzaCl7CiAgICAgICAgICAgIHRoaXMudWkuY2hpbGRJbmRlbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgICB0aGlzLnVpLnJlbmRlckluZGVudCgpOwogICAgICAgIGlmKGRlZXAgPT09IHRydWUgJiYgdGhpcy5jaGlsZHJlblJlbmRlcmVkKXsKICAgICAgICAgICAgdmFyIGNzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBjcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICBjc1tpXS5yZW5kZXJJbmRlbnQodHJ1ZSwgcmVmcmVzaCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIGJlZ2luVXBkYXRlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmNoaWxkcmVuUmVuZGVyZWQgPSBmYWxzZTsKICAgIH0sCgogICAgZW5kVXBkYXRlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmV4cGFuZGVkICYmIHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLnJlbmRlckNoaWxkcmVuKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRlc3Ryb3kgOiBmdW5jdGlvbihzaWxlbnQpewogICAgICAgIGlmKHNpbGVudCA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHRoaXMudW5zZWxlY3QodHJ1ZSk7CiAgICAgICAgfQogICAgICAgIEV4dC50cmVlLlRyZWVOb2RlLnN1cGVyY2xhc3MuZGVzdHJveS5jYWxsKHRoaXMsIHNpbGVudCk7CiAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy51aSwgdGhpcy5sb2FkZXIpOwogICAgICAgIHRoaXMudWkgPSB0aGlzLmxvYWRlciA9IG51bGw7CiAgICB9LAoKICAgIAogICAgb25JZENoYW5nZSA6IGZ1bmN0aW9uKGlkKXsKICAgICAgICB0aGlzLnVpLm9uSWRDaGFuZ2UoaWQpOwogICAgfQp9KTsKCkV4dC50cmVlLlRyZWVQYW5lbC5ub2RlVHlwZXMubm9kZSA9IEV4dC50cmVlLlRyZWVOb2RlOwogRXh0LnRyZWUuQXN5bmNUcmVlTm9kZSA9IGZ1bmN0aW9uKGNvbmZpZyl7CiAgICB0aGlzLmxvYWRlZCA9IGNvbmZpZyAmJiBjb25maWcubG9hZGVkID09PSB0cnVlOwogICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7CiAgICBFeHQudHJlZS5Bc3luY1RyZWVOb2RlLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIAogICAgdGhpcy5hZGRFdmVudHMoJ2JlZm9yZWxvYWQnLCAnbG9hZCcpOwogICAgCiAgICAKfTsKRXh0LmV4dGVuZChFeHQudHJlZS5Bc3luY1RyZWVOb2RlLCBFeHQudHJlZS5UcmVlTm9kZSwgewogICAgZXhwYW5kIDogZnVuY3Rpb24oZGVlcCwgYW5pbSwgY2FsbGJhY2ssIHNjb3BlKXsKICAgICAgICBpZih0aGlzLmxvYWRpbmcpeyAKICAgICAgICAgICAgdmFyIHRpbWVyOwogICAgICAgICAgICB2YXIgZiA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBpZighdGhpcy5sb2FkaW5nKXsgCiAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5leHBhbmQoZGVlcCwgYW5pbSwgY2FsbGJhY2ssIHNjb3BlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfS5jcmVhdGVEZWxlZ2F0ZSh0aGlzKTsKICAgICAgICAgICAgdGltZXIgPSBzZXRJbnRlcnZhbChmLCAyMDApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKCF0aGlzLmxvYWRlZCl7CiAgICAgICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCJiZWZvcmVsb2FkIiwgdGhpcykgPT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmxvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnVpLmJlZm9yZUxvYWQodGhpcyk7CiAgICAgICAgICAgIHZhciBsb2FkZXIgPSB0aGlzLmxvYWRlciB8fCB0aGlzLmF0dHJpYnV0ZXMubG9hZGVyIHx8IHRoaXMuZ2V0T3duZXJUcmVlKCkuZ2V0TG9hZGVyKCk7CiAgICAgICAgICAgIGlmKGxvYWRlcil7CiAgICAgICAgICAgICAgICBsb2FkZXIubG9hZCh0aGlzLCB0aGlzLmxvYWRDb21wbGV0ZS5jcmVhdGVEZWxlZ2F0ZSh0aGlzLCBbZGVlcCwgYW5pbSwgY2FsbGJhY2ssIHNjb3BlXSksIHRoaXMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIEV4dC50cmVlLkFzeW5jVHJlZU5vZGUuc3VwZXJjbGFzcy5leHBhbmQuY2FsbCh0aGlzLCBkZWVwLCBhbmltLCBjYWxsYmFjaywgc2NvcGUpOwogICAgfSwKICAgIAogICAgCiAgICBpc0xvYWRpbmcgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmxvYWRpbmc7ICAKICAgIH0sCiAgICAKICAgIGxvYWRDb21wbGV0ZSA6IGZ1bmN0aW9uKGRlZXAsIGFuaW0sIGNhbGxiYWNrLCBzY29wZSl7CiAgICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5sb2FkZWQgPSB0cnVlOwogICAgICAgIHRoaXMudWkuYWZ0ZXJMb2FkKHRoaXMpOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCJsb2FkIiwgdGhpcyk7CiAgICAgICAgdGhpcy5leHBhbmQoZGVlcCwgYW5pbSwgY2FsbGJhY2ssIHNjb3BlKTsKICAgIH0sCiAgICAKICAgIAogICAgaXNMb2FkZWQgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmxvYWRlZDsKICAgIH0sCiAgICAKICAgIGhhc0NoaWxkTm9kZXMgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLmlzTGVhZigpICYmICF0aGlzLmxvYWRlZCl7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH1lbHNlewogICAgICAgICAgICByZXR1cm4gRXh0LnRyZWUuQXN5bmNUcmVlTm9kZS5zdXBlcmNsYXNzLmhhc0NoaWxkTm9kZXMuY2FsbCh0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVsb2FkIDogZnVuY3Rpb24oY2FsbGJhY2ssIHNjb3BlKXsKICAgICAgICB0aGlzLmNvbGxhcHNlKGZhbHNlLCBmYWxzZSk7CiAgICAgICAgd2hpbGUodGhpcy5maXJzdENoaWxkKXsKICAgICAgICAgICAgdGhpcy5yZW1vdmVDaGlsZCh0aGlzLmZpcnN0Q2hpbGQpLmRlc3Ryb3koKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jaGlsZHJlblJlbmRlcmVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5sb2FkZWQgPSBmYWxzZTsKICAgICAgICBpZih0aGlzLmlzSGlkZGVuUm9vdCgpKXsKICAgICAgICAgICAgdGhpcy5leHBhbmRlZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICB0aGlzLmV4cGFuZChmYWxzZSwgZmFsc2UsIGNhbGxiYWNrLCBzY29wZSk7CiAgICB9Cn0pOwoKRXh0LnRyZWUuVHJlZVBhbmVsLm5vZGVUeXBlcy5hc3luYyA9IEV4dC50cmVlLkFzeW5jVHJlZU5vZGU7CkV4dC50cmVlLlRyZWVOb2RlVUkgPSBFeHQuZXh0ZW5kKE9iamVjdCwgewogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIEV4dC5hcHBseSh0aGlzLCB7CiAgICAgICAgICAgIG5vZGU6IG5vZGUsCiAgICAgICAgICAgIHJlbmRlcmVkOiBmYWxzZSwKICAgICAgICAgICAgYW5pbWF0aW5nOiBmYWxzZSwKICAgICAgICAgICAgd2FzTGVhZjogdHJ1ZSwKICAgICAgICAgICAgZWNjOiAneC10cmVlLWVjLWljb24geC10cmVlLWVsYm93JywKICAgICAgICAgICAgZW1wdHlJY29uOiBFeHQuQkxBTktfSU1BR0VfVVJMICAgIAogICAgICAgIH0pOwogICAgfSwKICAgIAogICAgCiAgICByZW1vdmVDaGlsZCA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLmN0Tm9kZS5yZW1vdmVDaGlsZChub2RlLnVpLmdldEVsKCkpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBiZWZvcmVMb2FkIDogZnVuY3Rpb24oKXsKICAgICAgICAgdGhpcy5hZGRDbGFzcygieC10cmVlLW5vZGUtbG9hZGluZyIpOwogICAgfSwKCiAgICAKICAgIGFmdGVyTG9hZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgIHRoaXMucmVtb3ZlQ2xhc3MoIngtdHJlZS1ub2RlLWxvYWRpbmciKTsKICAgIH0sCgogICAgCiAgICBvblRleHRDaGFuZ2UgOiBmdW5jdGlvbihub2RlLCB0ZXh0LCBvbGRUZXh0KXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy50ZXh0Tm9kZS5pbm5lckhUTUwgPSB0ZXh0OwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgb25JY29uQ2xzQ2hhbmdlIDogZnVuY3Rpb24obm9kZSwgY2xzLCBvbGRDbHMpewogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICBFeHQuZmx5KHRoaXMuaWNvbk5vZGUpLnJlcGxhY2VDbGFzcyhvbGRDbHMsIGNscyk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBvbkljb25DaGFuZ2UgOiBmdW5jdGlvbihub2RlLCBpY29uKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBlbXB0eSA9IEV4dC5pc0VtcHR5KGljb24pOwogICAgICAgICAgICB0aGlzLmljb25Ob2RlLnNyYyA9IGVtcHR5ID8gdGhpcy5lbXB0eUljb24gOiBpY29uOwogICAgICAgICAgICBFeHQuZmx5KHRoaXMuaWNvbk5vZGUpW2VtcHR5ID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddKCd4LXRyZWUtbm9kZS1pbmxpbmUtaWNvbicpOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgb25UaXBDaGFuZ2UgOiBmdW5jdGlvbihub2RlLCB0aXAsIHRpdGxlKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdmFyIGhhc1RpdGxlID0gRXh0LmlzRGVmaW5lZCh0aXRsZSk7CiAgICAgICAgICAgIGlmKHRoaXMudGV4dE5vZGUuc2V0QXR0cmlidXRlTlMpewogICAgICAgICAgICAgICAgdGhpcy50ZXh0Tm9kZS5zZXRBdHRyaWJ1dGVOUygiZXh0IiwgInF0aXAiLCB0aXApOwogICAgICAgICAgICAgICAgaWYoaGFzVGl0bGUpewogICAgICAgICAgICAgICAgICAgIHRoaXMudGV4dE5vZGUuc2V0QXR0cmlidXRlTlMoImV4dCIsICJxdGl0bGUiLCB0aXRsZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy50ZXh0Tm9kZS5zZXRBdHRyaWJ1dGUoImV4dDpxdGlwIiwgdGlwKTsKICAgICAgICAgICAgICAgIGlmKGhhc1RpdGxlKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRleHROb2RlLnNldEF0dHJpYnV0ZSgiZXh0OnF0aXRsZSIsIHRpdGxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgb25IcmVmQ2hhbmdlIDogZnVuY3Rpb24obm9kZSwgaHJlZiwgdGFyZ2V0KXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy5hbmNob3IuaHJlZiA9IHRoaXMuZ2V0SHJlZihocmVmKTsKICAgICAgICAgICAgaWYoRXh0LmlzRGVmaW5lZCh0YXJnZXQpKXsKICAgICAgICAgICAgICAgIHRoaXMuYW5jaG9yLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgb25DbHNDaGFuZ2UgOiBmdW5jdGlvbihub2RlLCBjbHMsIG9sZENscyl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIEV4dC5mbHkodGhpcy5lbE5vZGUpLnJlcGxhY2VDbGFzcyhvbGRDbHMsIGNscyk7CiAgICAgICAgfSAgICAKICAgIH0sCgogICAgCiAgICBvbkRpc2FibGVDaGFuZ2UgOiBmdW5jdGlvbihub2RlLCBzdGF0ZSl7CiAgICAgICAgdGhpcy5kaXNhYmxlZCA9IHN0YXRlOwogICAgICAgIGlmICh0aGlzLmNoZWNrYm94KSB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tib3guZGlzYWJsZWQgPSBzdGF0ZTsKICAgICAgICB9CiAgICAgICAgdGhpc1tzdGF0ZSA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnXSgneC10cmVlLW5vZGUtZGlzYWJsZWQnKTsKICAgIH0sCgogICAgCiAgICBvblNlbGVjdGVkQ2hhbmdlIDogZnVuY3Rpb24oc3RhdGUpewogICAgICAgIGlmKHN0YXRlKXsKICAgICAgICAgICAgdGhpcy5mb2N1cygpOwogICAgICAgICAgICB0aGlzLmFkZENsYXNzKCJ4LXRyZWUtc2VsZWN0ZWQiKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2xhc3MoIngtdHJlZS1zZWxlY3RlZCIpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbk1vdmUgOiBmdW5jdGlvbih0cmVlLCBub2RlLCBvbGRQYXJlbnQsIG5ld1BhcmVudCwgaW5kZXgsIHJlZk5vZGUpewogICAgICAgIHRoaXMuY2hpbGRJbmRlbnQgPSBudWxsOwogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IG5ld1BhcmVudC51aS5nZXRDb250YWluZXIoKTsKICAgICAgICAgICAgaWYoIXRhcmdldE5vZGUpewogICAgICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICAgIHRoaXMuaG9sZGVyLmFwcGVuZENoaWxkKHRoaXMud3JhcCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc2VydEJlZm9yZSA9IHJlZk5vZGUgPyByZWZOb2RlLnVpLmdldEVsKCkgOiBudWxsOwogICAgICAgICAgICBpZihpbnNlcnRCZWZvcmUpewogICAgICAgICAgICAgICAgdGFyZ2V0Tm9kZS5pbnNlcnRCZWZvcmUodGhpcy53cmFwLCBpbnNlcnRCZWZvcmUpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRhcmdldE5vZGUuYXBwZW5kQ2hpbGQodGhpcy53cmFwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm5vZGUucmVuZGVySW5kZW50KHRydWUsIG9sZFBhcmVudCAhPSBuZXdQYXJlbnQpOwogICAgICAgIH0KICAgIH0sCgoKICAgIGFkZENsYXNzIDogZnVuY3Rpb24oY2xzKXsKICAgICAgICBpZih0aGlzLmVsTm9kZSl7CiAgICAgICAgICAgIEV4dC5mbHkodGhpcy5lbE5vZGUpLmFkZENsYXNzKGNscyk7CiAgICAgICAgfQogICAgfSwKCgogICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihjbHMpewogICAgICAgIGlmKHRoaXMuZWxOb2RlKXsKICAgICAgICAgICAgRXh0LmZseSh0aGlzLmVsTm9kZSkucmVtb3ZlQ2xhc3MoY2xzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVtb3ZlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy5ob2xkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgdGhpcy5ob2xkZXIuYXBwZW5kQ2hpbGQodGhpcy53cmFwKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZmlyZUV2ZW50IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5ub2RlLmZpcmVFdmVudC5hcHBseSh0aGlzLm5vZGUsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIAogICAgaW5pdEV2ZW50cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5ub2RlLm9uKCJtb3ZlIiwgdGhpcy5vbk1vdmUsIHRoaXMpOwoKICAgICAgICBpZih0aGlzLm5vZGUuZGlzYWJsZWQpewogICAgICAgICAgICB0aGlzLm9uRGlzYWJsZUNoYW5nZSh0aGlzLm5vZGUsIHRydWUpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLm5vZGUuaGlkZGVuKXsKICAgICAgICAgICAgdGhpcy5oaWRlKCk7CiAgICAgICAgfQogICAgICAgIHZhciBvdCA9IHRoaXMubm9kZS5nZXRPd25lclRyZWUoKTsKICAgICAgICB2YXIgZGQgPSBvdC5lbmFibGVERCB8fCBvdC5lbmFibGVEcmFnIHx8IG90LmVuYWJsZURyb3A7CiAgICAgICAgaWYoZGQgJiYgKCF0aGlzLm5vZGUuaXNSb290IHx8IG90LnJvb3RWaXNpYmxlKSl7CiAgICAgICAgICAgIEV4dC5kZC5SZWdpc3RyeS5yZWdpc3Rlcih0aGlzLmVsTm9kZSwgewogICAgICAgICAgICAgICAgbm9kZTogdGhpcy5ub2RlLAogICAgICAgICAgICAgICAgaGFuZGxlczogdGhpcy5nZXREREhhbmRsZXMoKSwKICAgICAgICAgICAgICAgIGlzSGFuZGxlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0RERIYW5kbGVzIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gW3RoaXMuaWNvbk5vZGUsIHRoaXMudGV4dE5vZGUsIHRoaXMuZWxOb2RlXTsKICAgIH0sCgoKICAgIGhpZGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMubm9kZS5oaWRkZW4gPSB0cnVlOwogICAgICAgIGlmKHRoaXMud3JhcCl7CiAgICAgICAgICAgIHRoaXMud3JhcC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgIH0KICAgIH0sCgoKICAgIHNob3cgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMubm9kZS5oaWRkZW4gPSBmYWxzZTsKICAgICAgICBpZih0aGlzLndyYXApewogICAgICAgICAgICB0aGlzLndyYXAuc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkNvbnRleHRNZW51IDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYgKHRoaXMubm9kZS5oYXNMaXN0ZW5lcigiY29udGV4dG1lbnUiKSB8fCB0aGlzLm5vZGUuZ2V0T3duZXJUcmVlKCkuaGFzTGlzdGVuZXIoImNvbnRleHRtZW51IikpIHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB0aGlzLmZvY3VzKCk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJjb250ZXh0bWVudSIsIHRoaXMubm9kZSwgZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uQ2xpY2sgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZih0aGlzLmRyb3BwaW5nKXsKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgiYmVmb3JlY2xpY2siLCB0aGlzLm5vZGUsIGUpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHZhciBhID0gZS5nZXRUYXJnZXQoJ2EnKTsKICAgICAgICAgICAgaWYoIXRoaXMuZGlzYWJsZWQgJiYgdGhpcy5ub2RlLmF0dHJpYnV0ZXMuaHJlZiAmJiBhKXsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJjbGljayIsIHRoaXMubm9kZSwgZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH1lbHNlIGlmKGEgJiYgZS5jdHJsS2V5KXsKICAgICAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBpZih0aGlzLmRpc2FibGVkKXsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYodGhpcy5ub2RlLmF0dHJpYnV0ZXMuc2luZ2xlQ2xpY2tFeHBhbmQgJiYgIXRoaXMuYW5pbWF0aW5nICYmIHRoaXMubm9kZS5pc0V4cGFuZGFibGUoKSl7CiAgICAgICAgICAgICAgICB0aGlzLm5vZGUudG9nZ2xlKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJjbGljayIsIHRoaXMubm9kZSwgZSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uRGJsQ2xpY2sgOiBmdW5jdGlvbihlKXsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgaWYodGhpcy5kaXNhYmxlZCl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoImJlZm9yZWRibGNsaWNrIiwgdGhpcy5ub2RlLCBlKSAhPT0gZmFsc2UpewogICAgICAgICAgICBpZih0aGlzLmNoZWNrYm94KXsKICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlQ2hlY2soKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighdGhpcy5hbmltYXRpbmcgJiYgdGhpcy5ub2RlLmlzRXhwYW5kYWJsZSgpKXsKICAgICAgICAgICAgICAgIHRoaXMubm9kZS50b2dnbGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgiZGJsY2xpY2siLCB0aGlzLm5vZGUsIGUpOwogICAgICAgIH0KICAgIH0sCgogICAgb25PdmVyIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy5hZGRDbGFzcygneC10cmVlLW5vZGUtb3ZlcicpOwogICAgfSwKCiAgICBvbk91dCA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMucmVtb3ZlQ2xhc3MoJ3gtdHJlZS1ub2RlLW92ZXInKTsKICAgIH0sCgogICAgCiAgICBvbkNoZWNrQ2hhbmdlIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY2hlY2tlZCA9IHRoaXMuY2hlY2tib3guY2hlY2tlZDsKICAgICAgICAKICAgICAgICB0aGlzLmNoZWNrYm94LmRlZmF1bHRDaGVja2VkID0gY2hlY2tlZDsKICAgICAgICB0aGlzLm5vZGUuYXR0cmlidXRlcy5jaGVja2VkID0gY2hlY2tlZDsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnY2hlY2tjaGFuZ2UnLCB0aGlzLm5vZGUsIGNoZWNrZWQpOwogICAgfSwKCiAgICAKICAgIGVjQ2xpY2sgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZighdGhpcy5hbmltYXRpbmcgJiYgdGhpcy5ub2RlLmlzRXhwYW5kYWJsZSgpKXsKICAgICAgICAgICAgdGhpcy5ub2RlLnRvZ2dsZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzdGFydERyb3AgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZHJvcHBpbmcgPSB0cnVlOwogICAgfSwKCiAgICAKICAgIGVuZERyb3AgOiBmdW5jdGlvbigpewogICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgIHRoaXMuZHJvcHBpbmcgPSBmYWxzZTsKICAgICAgIH0uY3JlYXRlRGVsZWdhdGUodGhpcyksIDUwKTsKICAgIH0sCgogICAgCiAgICBleHBhbmQgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMudXBkYXRlRXhwYW5kSWNvbigpOwogICAgICAgIHRoaXMuY3ROb2RlLnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgIH0sCgogICAgCiAgICBmb2N1cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMubm9kZS5wcmV2ZW50SFNjcm9sbCl7CiAgICAgICAgICAgIHRyeXt0aGlzLmFuY2hvci5mb2N1cygpOwogICAgICAgICAgICB9Y2F0Y2goZSl7fQogICAgICAgIH1lbHNlewogICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICB2YXIgbm9zY3JvbGwgPSB0aGlzLm5vZGUuZ2V0T3duZXJUcmVlKCkuZ2V0VHJlZUVsKCkuZG9tOwogICAgICAgICAgICAgICAgdmFyIGwgPSBub3Njcm9sbC5zY3JvbGxMZWZ0OwogICAgICAgICAgICAgICAgdGhpcy5hbmNob3IuZm9jdXMoKTsKICAgICAgICAgICAgICAgIG5vc2Nyb2xsLnNjcm9sbExlZnQgPSBsOwogICAgICAgICAgICB9Y2F0Y2goZSl7fQogICAgICAgIH0KICAgIH0sCgoKICAgIHRvZ2dsZUNoZWNrIDogZnVuY3Rpb24odmFsdWUpewogICAgICAgIHZhciBjYiA9IHRoaXMuY2hlY2tib3g7CiAgICAgICAgaWYoY2IpewogICAgICAgICAgICBjYi5jaGVja2VkID0gKHZhbHVlID09PSB1bmRlZmluZWQgPyAhY2IuY2hlY2tlZCA6IHZhbHVlKTsKICAgICAgICAgICAgdGhpcy5vbkNoZWNrQ2hhbmdlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGJsdXIgOiBmdW5jdGlvbigpewogICAgICAgIHRyeXsKICAgICAgICAgICAgdGhpcy5hbmNob3IuYmx1cigpOwogICAgICAgIH1jYXRjaChlKXt9CiAgICB9LAoKICAgIAogICAgYW5pbUV4cGFuZCA6IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgICB2YXIgY3QgPSBFeHQuZ2V0KHRoaXMuY3ROb2RlKTsKICAgICAgICBjdC5zdG9wRngoKTsKICAgICAgICBpZighdGhpcy5ub2RlLmlzRXhwYW5kYWJsZSgpKXsKICAgICAgICAgICAgdGhpcy51cGRhdGVFeHBhbmRJY29uKCk7CiAgICAgICAgICAgIHRoaXMuY3ROb2RlLnN0eWxlLmRpc3BsYXkgPSAiIjsKICAgICAgICAgICAgRXh0LmNhbGxiYWNrKGNhbGxiYWNrKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmFuaW1hdGluZyA9IHRydWU7CiAgICAgICAgdGhpcy51cGRhdGVFeHBhbmRJY29uKCk7CgogICAgICAgIGN0LnNsaWRlSW4oJ3QnLCB7CiAgICAgICAgICAgY2FsbGJhY2sgOiBmdW5jdGlvbigpewogICAgICAgICAgICAgICB0aGlzLmFuaW1hdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICBFeHQuY2FsbGJhY2soY2FsbGJhY2spOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgZHVyYXRpb246IHRoaXMubm9kZS5vd25lclRyZWUuZHVyYXRpb24gfHwgLjI1CiAgICAgICAgfSk7CiAgICB9LAoKICAgIAogICAgaGlnaGxpZ2h0IDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdHJlZSA9IHRoaXMubm9kZS5nZXRPd25lclRyZWUoKTsKICAgICAgICBFeHQuZmx5KHRoaXMud3JhcCkuaGlnaGxpZ2h0KAogICAgICAgICAgICB0cmVlLmhsQ29sb3IgfHwgIkMzREFGOSIsCiAgICAgICAgICAgIHtlbmRDb2xvcjogdHJlZS5obEJhc2VDb2xvcn0KICAgICAgICApOwogICAgfSwKCiAgICAKICAgIGNvbGxhcHNlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnVwZGF0ZUV4cGFuZEljb24oKTsKICAgICAgICB0aGlzLmN0Tm9kZS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgfSwKCiAgICAKICAgIGFuaW1Db2xsYXBzZSA6IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgICB2YXIgY3QgPSBFeHQuZ2V0KHRoaXMuY3ROb2RlKTsKICAgICAgICBjdC5lbmFibGVEaXNwbGF5TW9kZSgnYmxvY2snKTsKICAgICAgICBjdC5zdG9wRngoKTsKCiAgICAgICAgdGhpcy5hbmltYXRpbmcgPSB0cnVlOwogICAgICAgIHRoaXMudXBkYXRlRXhwYW5kSWNvbigpOwoKICAgICAgICBjdC5zbGlkZU91dCgndCcsIHsKICAgICAgICAgICAgY2FsbGJhY2sgOiBmdW5jdGlvbigpewogICAgICAgICAgICAgICB0aGlzLmFuaW1hdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICBFeHQuY2FsbGJhY2soY2FsbGJhY2spOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgZHVyYXRpb246IHRoaXMubm9kZS5vd25lclRyZWUuZHVyYXRpb24gfHwgLjI1CiAgICAgICAgfSk7CiAgICB9LAoKICAgIAogICAgZ2V0Q29udGFpbmVyIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5jdE5vZGU7CiAgICB9LAoKCiAgICBnZXRFbCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMud3JhcDsKICAgIH0sCgogICAgCiAgICBhcHBlbmREREdob3N0IDogZnVuY3Rpb24oZ2hvc3ROb2RlKXsKICAgICAgICBnaG9zdE5vZGUuYXBwZW5kQ2hpbGQodGhpcy5lbE5vZGUuY2xvbmVOb2RlKHRydWUpKTsKICAgIH0sCgogICAgCiAgICBnZXRERFJlcGFpclhZIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gRXh0LmxpYi5Eb20uZ2V0WFkodGhpcy5pY29uTm9kZSk7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMucmVuZGVyKCk7CiAgICB9LAoKICAgIAogICAgcmVuZGVyIDogZnVuY3Rpb24oYnVsa1JlbmRlcil7CiAgICAgICAgdmFyIG4gPSB0aGlzLm5vZGUsIGEgPSBuLmF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHRhcmdldE5vZGUgPSBuLnBhcmVudE5vZGUgPwogICAgICAgICAgICAgIG4ucGFyZW50Tm9kZS51aS5nZXRDb250YWluZXIoKSA6IG4ub3duZXJUcmVlLmlubmVyQ3QuZG9tOwoKICAgICAgICBpZighdGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZWQgPSB0cnVlOwoKICAgICAgICAgICAgdGhpcy5yZW5kZXJFbGVtZW50cyhuLCBhLCB0YXJnZXROb2RlLCBidWxrUmVuZGVyKTsKCiAgICAgICAgICAgIGlmKGEucXRpcCl7CiAgICAgICAgICAgICAgICB0aGlzLm9uVGlwQ2hhbmdlKG4sIGEucXRpcCwgYS5xdGlwVGl0bGUpOwogICAgICAgICAgICB9ZWxzZSBpZihhLnF0aXBDZmcpewogICAgICAgICAgICAgICAgYS5xdGlwQ2ZnLnRhcmdldCA9IEV4dC5pZCh0aGlzLnRleHROb2RlKTsKICAgICAgICAgICAgICAgIEV4dC5RdWlja1RpcHMucmVnaXN0ZXIoYS5xdGlwQ2ZnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmluaXRFdmVudHMoKTsKICAgICAgICAgICAgaWYoIXRoaXMubm9kZS5leHBhbmRlZCl7CiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUV4cGFuZEljb24odHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgaWYoYnVsa1JlbmRlciA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgdGFyZ2V0Tm9kZS5hcHBlbmRDaGlsZCh0aGlzLndyYXApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHJlbmRlckVsZW1lbnRzIDogZnVuY3Rpb24obiwgYSwgdGFyZ2V0Tm9kZSwgYnVsa1JlbmRlcil7CiAgICAgICAgCiAgICAgICAgdGhpcy5pbmRlbnRNYXJrdXAgPSBuLnBhcmVudE5vZGUgPyBuLnBhcmVudE5vZGUudWkuZ2V0Q2hpbGRJbmRlbnQoKSA6ICcnOwoKICAgICAgICB2YXIgY2IgPSBFeHQuaXNCb29sZWFuKGEuY2hlY2tlZCksCiAgICAgICAgICAgIG5lbCwKICAgICAgICAgICAgaHJlZiA9IHRoaXMuZ2V0SHJlZihhLmhyZWYpLAogICAgICAgICAgICBidWYgPSBbJzxsaSBjbGFzcz0ieC10cmVlLW5vZGUiPjxkaXYgZXh0OnRyZWUtbm9kZS1pZD0iJyxuLmlkLCciIGNsYXNzPSJ4LXRyZWUtbm9kZS1lbCB4LXRyZWUtbm9kZS1sZWFmIHgtdW5zZWxlY3RhYmxlICcsIGEuY2xzLCciIHVuc2VsZWN0YWJsZT0ib24iPicsCiAgICAgICAgICAgICc8c3BhbiBjbGFzcz0ieC10cmVlLW5vZGUtaW5kZW50Ij4nLHRoaXMuaW5kZW50TWFya3VwLCI8L3NwYW4+IiwKICAgICAgICAgICAgJzxpbWcgYWx0PSIiIHNyYz0iJywgdGhpcy5lbXB0eUljb24sICciIGNsYXNzPSJ4LXRyZWUtZWMtaWNvbiB4LXRyZWUtZWxib3ciIC8+JywKICAgICAgICAgICAgJzxpbWcgYWx0PSIiIHNyYz0iJywgYS5pY29uIHx8IHRoaXMuZW1wdHlJY29uLCAnIiBjbGFzcz0ieC10cmVlLW5vZGUtaWNvbicsKGEuaWNvbiA/ICIgeC10cmVlLW5vZGUtaW5saW5lLWljb24iIDogIiIpLChhLmljb25DbHMgPyAiICIrYS5pY29uQ2xzIDogIiIpLCciIHVuc2VsZWN0YWJsZT0ib24iIC8+JywKICAgICAgICAgICAgY2IgPyAoJzxpbnB1dCBjbGFzcz0ieC10cmVlLW5vZGUtY2IiIHR5cGU9ImNoZWNrYm94IiAnICsgKGEuY2hlY2tlZCA/ICdjaGVja2VkPSJjaGVja2VkIiAvPicgOiAnLz4nKSkgOiAnJywKICAgICAgICAgICAgJzxhIGhpZGVmb2N1cz0ib24iIGNsYXNzPSJ4LXRyZWUtbm9kZS1hbmNob3IiIGhyZWY9IicsaHJlZiwnIiB0YWJJbmRleD0iMSIgJywKICAgICAgICAgICAgIGEuaHJlZlRhcmdldCA/ICcgdGFyZ2V0PSInK2EuaHJlZlRhcmdldCsnIicgOiAiIiwgJz48c3BhbiB1bnNlbGVjdGFibGU9Im9uIj4nLG4udGV4dCwiPC9zcGFuPjwvYT48L2Rpdj4iLAogICAgICAgICAgICAnPHVsIGNsYXNzPSJ4LXRyZWUtbm9kZS1jdCIgc3R5bGU9ImRpc3BsYXk6bm9uZTsiPjwvdWw+JywKICAgICAgICAgICAgIjwvbGk+Il0uam9pbignJyk7CgogICAgICAgIGlmKGJ1bGtSZW5kZXIgIT09IHRydWUgJiYgbi5uZXh0U2libGluZyAmJiAobmVsID0gbi5uZXh0U2libGluZy51aS5nZXRFbCgpKSl7CiAgICAgICAgICAgIHRoaXMud3JhcCA9IEV4dC5Eb21IZWxwZXIuaW5zZXJ0SHRtbCgiYmVmb3JlQmVnaW4iLCBuZWwsIGJ1Zik7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMud3JhcCA9IEV4dC5Eb21IZWxwZXIuaW5zZXJ0SHRtbCgiYmVmb3JlRW5kIiwgdGFyZ2V0Tm9kZSwgYnVmKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZWxOb2RlID0gdGhpcy53cmFwLmNoaWxkTm9kZXNbMF07CiAgICAgICAgdGhpcy5jdE5vZGUgPSB0aGlzLndyYXAuY2hpbGROb2Rlc1sxXTsKICAgICAgICB2YXIgY3MgPSB0aGlzLmVsTm9kZS5jaGlsZE5vZGVzOwogICAgICAgIHRoaXMuaW5kZW50Tm9kZSA9IGNzWzBdOwogICAgICAgIHRoaXMuZWNOb2RlID0gY3NbMV07CiAgICAgICAgdGhpcy5pY29uTm9kZSA9IGNzWzJdOwogICAgICAgIHZhciBpbmRleCA9IDM7CiAgICAgICAgaWYoY2IpewogICAgICAgICAgICB0aGlzLmNoZWNrYm94ID0gY3NbM107CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNoZWNrYm94LmRlZmF1bHRDaGVja2VkID0gdGhpcy5jaGVja2JveC5jaGVja2VkOwogICAgICAgICAgICBpbmRleCsrOwogICAgICAgIH0KICAgICAgICB0aGlzLmFuY2hvciA9IGNzW2luZGV4XTsKICAgICAgICB0aGlzLnRleHROb2RlID0gY3NbaW5kZXhdLmZpcnN0Q2hpbGQ7CiAgICB9LAogICAgCiAgICAKICAgIGdldEhyZWYgOiBmdW5jdGlvbihocmVmKXsKICAgICAgICByZXR1cm4gRXh0LmlzRW1wdHkoaHJlZikgPyAoRXh0LmlzR2Vja28gPyAnJyA6ICcjJykgOiBocmVmOwogICAgfSwKCgogICAgZ2V0QW5jaG9yIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5hbmNob3I7CiAgICB9LAoKCiAgICBnZXRUZXh0RWwgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnRleHROb2RlOwogICAgfSwKCgogICAgZ2V0SWNvbkVsIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pY29uTm9kZTsKICAgIH0sCgoKICAgIGlzQ2hlY2tlZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tib3ggPyB0aGlzLmNoZWNrYm94LmNoZWNrZWQgOiBmYWxzZTsKICAgIH0sCgogICAgCiAgICB1cGRhdGVFeHBhbmRJY29uIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdmFyIG4gPSB0aGlzLm5vZGUsCiAgICAgICAgICAgICAgICBjMSwKICAgICAgICAgICAgICAgIGMyLAogICAgICAgICAgICAgICAgY2xzID0gbi5pc0xhc3QoKSA/ICJ4LXRyZWUtZWxib3ctZW5kIiA6ICJ4LXRyZWUtZWxib3ciLAogICAgICAgICAgICAgICAgaGFzQ2hpbGQgPSBuLmhhc0NoaWxkTm9kZXMoKTsKICAgICAgICAgICAgaWYoaGFzQ2hpbGQgfHwgbi5hdHRyaWJ1dGVzLmV4cGFuZGFibGUpewogICAgICAgICAgICAgICAgaWYobi5leHBhbmRlZCl7CiAgICAgICAgICAgICAgICAgICAgY2xzICs9ICItbWludXMiOwogICAgICAgICAgICAgICAgICAgIGMxID0gIngtdHJlZS1ub2RlLWNvbGxhcHNlZCI7CiAgICAgICAgICAgICAgICAgICAgYzIgPSAieC10cmVlLW5vZGUtZXhwYW5kZWQiOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgY2xzICs9ICItcGx1cyI7CiAgICAgICAgICAgICAgICAgICAgYzEgPSAieC10cmVlLW5vZGUtZXhwYW5kZWQiOwogICAgICAgICAgICAgICAgICAgIGMyID0gIngtdHJlZS1ub2RlLWNvbGxhcHNlZCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZih0aGlzLndhc0xlYWYpewogICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2xhc3MoIngtdHJlZS1ub2RlLWxlYWYiKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLndhc0xlYWYgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKHRoaXMuYzEgIT0gYzEgfHwgdGhpcy5jMiAhPSBjMil7CiAgICAgICAgICAgICAgICAgICAgRXh0LmZseSh0aGlzLmVsTm9kZSkucmVwbGFjZUNsYXNzKGMxLCBjMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jMSA9IGMxOyB0aGlzLmMyID0gYzI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgaWYoIXRoaXMud2FzTGVhZil7CiAgICAgICAgICAgICAgICAgICAgRXh0LmZseSh0aGlzLmVsTm9kZSkucmVwbGFjZUNsYXNzKCJ4LXRyZWUtbm9kZS1leHBhbmRlZCIsICJ4LXRyZWUtbm9kZS1jb2xsYXBzZWQiKTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jMTsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jMjsKICAgICAgICAgICAgICAgICAgICB0aGlzLndhc0xlYWYgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlY2MgPSAieC10cmVlLWVjLWljb24gIitjbHM7CiAgICAgICAgICAgIGlmKHRoaXMuZWNjICE9IGVjYyl7CiAgICAgICAgICAgICAgICB0aGlzLmVjTm9kZS5jbGFzc05hbWUgPSBlY2M7CiAgICAgICAgICAgICAgICB0aGlzLmVjYyA9IGVjYzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbklkQ2hhbmdlOiBmdW5jdGlvbihpZCl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuZWxOb2RlLnNldEF0dHJpYnV0ZSgnZXh0OnRyZWUtbm9kZS1pZCcsIGlkKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0Q2hpbGRJbmRlbnQgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLmNoaWxkSW5kZW50KXsKICAgICAgICAgICAgdmFyIGJ1ZiA9IFtdLAogICAgICAgICAgICAgICAgcCA9IHRoaXMubm9kZTsKICAgICAgICAgICAgd2hpbGUocCl7CiAgICAgICAgICAgICAgICBpZighcC5pc1Jvb3QgfHwgKHAuaXNSb290ICYmIHAub3duZXJUcmVlLnJvb3RWaXNpYmxlKSl7CiAgICAgICAgICAgICAgICAgICAgaWYoIXAuaXNMYXN0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmLnVuc2hpZnQoJzxpbWcgYWx0PSIiIHNyYz0iJyt0aGlzLmVtcHR5SWNvbisnIiBjbGFzcz0ieC10cmVlLWVsYm93LWxpbmUiIC8+Jyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmLnVuc2hpZnQoJzxpbWcgYWx0PSIiIHNyYz0iJyt0aGlzLmVtcHR5SWNvbisnIiBjbGFzcz0ieC10cmVlLWljb24iIC8+Jyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcCA9IHAucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNoaWxkSW5kZW50ID0gYnVmLmpvaW4oIiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5jaGlsZEluZGVudDsKICAgIH0sCgogICAgCiAgICByZW5kZXJJbmRlbnQgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB2YXIgaW5kZW50ID0gIiIsCiAgICAgICAgICAgICAgICBwID0gdGhpcy5ub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIGlmKHApewogICAgICAgICAgICAgICAgaW5kZW50ID0gcC51aS5nZXRDaGlsZEluZGVudCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMuaW5kZW50TWFya3VwICE9IGluZGVudCl7IAogICAgICAgICAgICAgICAgdGhpcy5pbmRlbnROb2RlLmlubmVySFRNTCA9IGluZGVudDsKICAgICAgICAgICAgICAgIHRoaXMuaW5kZW50TWFya3VwID0gaW5kZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudXBkYXRlRXhwYW5kSWNvbigpOwogICAgICAgIH0KICAgIH0sCgogICAgZGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5lbE5vZGUpewogICAgICAgICAgICBFeHQuZGQuUmVnaXN0cnkudW5yZWdpc3Rlcih0aGlzLmVsTm9kZS5pZCk7CiAgICAgICAgfQoKICAgICAgICBFeHQuZWFjaChbJ3RleHRub2RlJywgJ2FuY2hvcicsICdjaGVja2JveCcsICdpbmRlbnROb2RlJywgJ2VjTm9kZScsICdpY29uTm9kZScsICdlbE5vZGUnLCAnY3ROb2RlJywgJ3dyYXAnLCAnaG9sZGVyJ10sIGZ1bmN0aW9uKGVsKXsKICAgICAgICAgICAgaWYodGhpc1tlbF0pewogICAgICAgICAgICAgICAgRXh0LmZseSh0aGlzW2VsXSkucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1tlbF07CiAgICAgICAgICAgIH0KICAgICAgICB9LCB0aGlzKTsKICAgICAgICBkZWxldGUgdGhpcy5ub2RlOwogICAgfQp9KTsKCgpFeHQudHJlZS5Sb290VHJlZU5vZGVVSSA9IEV4dC5leHRlbmQoRXh0LnRyZWUuVHJlZU5vZGVVSSwgewogICAgCiAgICByZW5kZXIgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSB0aGlzLm5vZGUub3duZXJUcmVlLmlubmVyQ3QuZG9tOwogICAgICAgICAgICB0aGlzLm5vZGUuZXhwYW5kZWQgPSB0cnVlOwogICAgICAgICAgICB0YXJnZXROb2RlLmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSJ4LXRyZWUtcm9vdC1ub2RlIj48L2Rpdj4nOwogICAgICAgICAgICB0aGlzLndyYXAgPSB0aGlzLmN0Tm9kZSA9IHRhcmdldE5vZGUuZmlyc3RDaGlsZDsKICAgICAgICB9CiAgICB9LAogICAgY29sbGFwc2UgOiBFeHQuZW1wdHlGbiwKICAgIGV4cGFuZCA6IEV4dC5lbXB0eUZuCn0pOwpFeHQudHJlZS5UcmVlTG9hZGVyID0gZnVuY3Rpb24oY29uZmlnKXsKICAgIHRoaXMuYmFzZVBhcmFtcyA9IHt9OwogICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CgogICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgCiAgICAgICAgImJlZm9yZWxvYWQiLAogICAgICAgIAogICAgICAgICJsb2FkIiwKICAgICAgICAKICAgICAgICAibG9hZGV4Y2VwdGlvbiIKICAgICk7CiAgICBFeHQudHJlZS5UcmVlTG9hZGVyLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsKICAgIGlmKEV4dC5pc1N0cmluZyh0aGlzLnBhcmFtT3JkZXIpKXsKICAgICAgICB0aGlzLnBhcmFtT3JkZXIgPSB0aGlzLnBhcmFtT3JkZXIuc3BsaXQoL1tccyx8XS8pOwogICAgfQp9OwoKRXh0LmV4dGVuZChFeHQudHJlZS5UcmVlTG9hZGVyLCBFeHQudXRpbC5PYnNlcnZhYmxlLCB7CiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIHVpUHJvdmlkZXJzIDoge30sCgogICAgCiAgICBjbGVhck9uTG9hZCA6IHRydWUsCgogICAgCiAgICBwYXJhbU9yZGVyOiB1bmRlZmluZWQsCgogICAgCiAgICBwYXJhbXNBc0hhc2g6IGZhbHNlLAoKICAgIAogICAgbm9kZVBhcmFtZXRlcjogJ25vZGUnLAoKICAgIAogICAgZGlyZWN0Rm4gOiB1bmRlZmluZWQsCgogICAgCiAgICBsb2FkIDogZnVuY3Rpb24obm9kZSwgY2FsbGJhY2ssIHNjb3BlKXsKICAgICAgICBpZih0aGlzLmNsZWFyT25Mb2FkKXsKICAgICAgICAgICAgd2hpbGUobm9kZS5maXJzdENoaWxkKXsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQ2hpbGQobm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZih0aGlzLmRvUHJlbG9hZChub2RlKSl7IAogICAgICAgICAgICB0aGlzLnJ1bkNhbGxiYWNrKGNhbGxiYWNrLCBzY29wZSB8fCBub2RlLCBbbm9kZV0pOwogICAgICAgIH1lbHNlIGlmKHRoaXMuZGlyZWN0Rm4gfHwgdGhpcy5kYXRhVXJsIHx8IHRoaXMudXJsKXsKICAgICAgICAgICAgdGhpcy5yZXF1ZXN0RGF0YShub2RlLCBjYWxsYmFjaywgc2NvcGUgfHwgbm9kZSk7CiAgICAgICAgfQogICAgfSwKCiAgICBkb1ByZWxvYWQgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICBpZihub2RlLmF0dHJpYnV0ZXMuY2hpbGRyZW4pewogICAgICAgICAgICBpZihub2RlLmNoaWxkTm9kZXMubGVuZ3RoIDwgMSl7IAogICAgICAgICAgICAgICAgdmFyIGNzID0gbm9kZS5hdHRyaWJ1dGVzLmNoaWxkcmVuOwogICAgICAgICAgICAgICAgbm9kZS5iZWdpblVwZGF0ZSgpOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gY3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgICAgIHZhciBjbiA9IG5vZGUuYXBwZW5kQ2hpbGQodGhpcy5jcmVhdGVOb2RlKGNzW2ldKSk7CiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5wcmVsb2FkQ2hpbGRyZW4pewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRvUHJlbG9hZChjbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZS5lbmRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICBnZXRQYXJhbXM6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHZhciBicCA9IEV4dC5hcHBseSh7fSwgdGhpcy5iYXNlUGFyYW1zKSwKICAgICAgICAgICAgbnAgPSB0aGlzLm5vZGVQYXJhbWV0ZXIsCiAgICAgICAgICAgIHBvID0gdGhpcy5wYXJhbU9yZGVyOwoKICAgICAgICBucCAmJiAoYnBbIG5wIF0gPSBub2RlLmlkKTsKCiAgICAgICAgaWYodGhpcy5kaXJlY3RGbil7CiAgICAgICAgICAgIHZhciBidWYgPSBbbm9kZS5pZF07CiAgICAgICAgICAgIGlmKHBvKXsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYobnAgJiYgcG8uaW5kZXhPZihucCkgPiAtMSl7CiAgICAgICAgICAgICAgICAgICAgYnVmID0gW107CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gcG8ubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgICAgIGJ1Zi5wdXNoKGJwWyBwb1tpXSBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2UgaWYodGhpcy5wYXJhbXNBc0hhc2gpewogICAgICAgICAgICAgICAgYnVmID0gW2JwXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYnVmOwogICAgICAgIH1lbHNlewogICAgICAgICAgICByZXR1cm4gYnA7CiAgICAgICAgfQogICAgfSwKCiAgICByZXF1ZXN0RGF0YSA6IGZ1bmN0aW9uKG5vZGUsIGNhbGxiYWNrLCBzY29wZSl7CiAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoImJlZm9yZWxvYWQiLCB0aGlzLCBub2RlLCBjYWxsYmFjaykgIT09IGZhbHNlKXsKICAgICAgICAgICAgaWYodGhpcy5kaXJlY3RGbil7CiAgICAgICAgICAgICAgICB2YXIgYXJncyA9IHRoaXMuZ2V0UGFyYW1zKG5vZGUpOwogICAgICAgICAgICAgICAgYXJncy5wdXNoKHRoaXMucHJvY2Vzc0RpcmVjdFJlc3BvbnNlLmNyZWF0ZURlbGVnYXRlKHRoaXMsIFt7Y2FsbGJhY2s6IGNhbGxiYWNrLCBub2RlOiBub2RlLCBzY29wZTogc2NvcGV9XSwgdHJ1ZSkpOwogICAgICAgICAgICAgICAgdGhpcy5kaXJlY3RGbi5hcHBseSh3aW5kb3csIGFyZ3MpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMudHJhbnNJZCA9IEV4dC5BamF4LnJlcXVlc3QoewogICAgICAgICAgICAgICAgICAgIG1ldGhvZDp0aGlzLnJlcXVlc3RNZXRob2QsCiAgICAgICAgICAgICAgICAgICAgdXJsOiB0aGlzLmRhdGFVcmx8fHRoaXMudXJsLAogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRoaXMuaGFuZGxlUmVzcG9uc2UsCiAgICAgICAgICAgICAgICAgICAgZmFpbHVyZTogdGhpcy5oYW5kbGVGYWlsdXJlLAogICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50OiB7Y2FsbGJhY2s6IGNhbGxiYWNrLCBub2RlOiBub2RlLCBzY29wZTogc2NvcGV9LAogICAgICAgICAgICAgICAgICAgIHBhcmFtczogdGhpcy5nZXRQYXJhbXMobm9kZSkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5ydW5DYWxsYmFjayhjYWxsYmFjaywgc2NvcGUgfHwgbm9kZSwgW10pOwogICAgICAgIH0KICAgIH0sCgogICAgcHJvY2Vzc0RpcmVjdFJlc3BvbnNlOiBmdW5jdGlvbihyZXN1bHQsIHJlc3BvbnNlLCBhcmdzKXsKICAgICAgICBpZihyZXNwb25zZS5zdGF0dXMpewogICAgICAgICAgICB0aGlzLmhhbmRsZVJlc3BvbnNlKHsKICAgICAgICAgICAgICAgIHJlc3BvbnNlRGF0YTogRXh0LmlzQXJyYXkocmVzdWx0KSA/IHJlc3VsdCA6IG51bGwsCiAgICAgICAgICAgICAgICByZXNwb25zZVRleHQ6IHJlc3VsdCwKICAgICAgICAgICAgICAgIGFyZ3VtZW50OiBhcmdzCiAgICAgICAgICAgIH0pOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmhhbmRsZUZhaWx1cmUoewogICAgICAgICAgICAgICAgYXJndW1lbnQ6IGFyZ3MKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHJ1bkNhbGxiYWNrOiBmdW5jdGlvbihjYiwgc2NvcGUsIGFyZ3MpewogICAgICAgIGlmKEV4dC5pc0Z1bmN0aW9uKGNiKSl7CiAgICAgICAgICAgIGNiLmFwcGx5KHNjb3BlLCBhcmdzKTsKICAgICAgICB9CiAgICB9LAoKICAgIGlzTG9hZGluZyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuICEhdGhpcy50cmFuc0lkOwogICAgfSwKCiAgICBhYm9ydCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5pc0xvYWRpbmcoKSl7CiAgICAgICAgICAgIEV4dC5BamF4LmFib3J0KHRoaXMudHJhbnNJZCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNyZWF0ZU5vZGUgOiBmdW5jdGlvbihhdHRyKXsKICAgICAgICAKICAgICAgICBpZih0aGlzLmJhc2VBdHRycyl7CiAgICAgICAgICAgIEV4dC5hcHBseUlmKGF0dHIsIHRoaXMuYmFzZUF0dHJzKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5hcHBseUxvYWRlciAhPT0gZmFsc2UgJiYgIWF0dHIubG9hZGVyKXsKICAgICAgICAgICAgYXR0ci5sb2FkZXIgPSB0aGlzOwogICAgICAgIH0KICAgICAgICBpZihFeHQuaXNTdHJpbmcoYXR0ci51aVByb3ZpZGVyKSl7CiAgICAgICAgICAgYXR0ci51aVByb3ZpZGVyID0gdGhpcy51aVByb3ZpZGVyc1thdHRyLnVpUHJvdmlkZXJdIHx8IGV2YWwoYXR0ci51aVByb3ZpZGVyKTsKICAgICAgICB9CiAgICAgICAgaWYoYXR0ci5ub2RlVHlwZSl7CiAgICAgICAgICAgIHJldHVybiBuZXcgRXh0LnRyZWUuVHJlZVBhbmVsLm5vZGVUeXBlc1thdHRyLm5vZGVUeXBlXShhdHRyKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgcmV0dXJuIGF0dHIubGVhZiA/CiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBFeHQudHJlZS5UcmVlTm9kZShhdHRyKSA6CiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBFeHQudHJlZS5Bc3luY1RyZWVOb2RlKGF0dHIpOwogICAgICAgIH0KICAgIH0sCgogICAgcHJvY2Vzc1Jlc3BvbnNlIDogZnVuY3Rpb24ocmVzcG9uc2UsIG5vZGUsIGNhbGxiYWNrLCBzY29wZSl7CiAgICAgICAgdmFyIGpzb24gPSByZXNwb25zZS5yZXNwb25zZVRleHQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG8gPSByZXNwb25zZS5yZXNwb25zZURhdGEgfHwgRXh0LmRlY29kZShqc29uKTsKICAgICAgICAgICAgbm9kZS5iZWdpblVwZGF0ZSgpOwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBvLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIHZhciBuID0gdGhpcy5jcmVhdGVOb2RlKG9baV0pOwogICAgICAgICAgICAgICAgaWYobil7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLmVuZFVwZGF0ZSgpOwogICAgICAgICAgICB0aGlzLnJ1bkNhbGxiYWNrKGNhbGxiYWNrLCBzY29wZSB8fCBub2RlLCBbbm9kZV0pOwogICAgICAgIH1jYXRjaChlKXsKICAgICAgICAgICAgdGhpcy5oYW5kbGVGYWlsdXJlKHJlc3BvbnNlKTsKICAgICAgICB9CiAgICB9LAoKICAgIGhhbmRsZVJlc3BvbnNlIDogZnVuY3Rpb24ocmVzcG9uc2UpewogICAgICAgIHRoaXMudHJhbnNJZCA9IGZhbHNlOwogICAgICAgIHZhciBhID0gcmVzcG9uc2UuYXJndW1lbnQ7CiAgICAgICAgdGhpcy5wcm9jZXNzUmVzcG9uc2UocmVzcG9uc2UsIGEubm9kZSwgYS5jYWxsYmFjaywgYS5zY29wZSk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoImxvYWQiLCB0aGlzLCBhLm5vZGUsIHJlc3BvbnNlKTsKICAgIH0sCgogICAgaGFuZGxlRmFpbHVyZSA6IGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgICB0aGlzLnRyYW5zSWQgPSBmYWxzZTsKICAgICAgICB2YXIgYSA9IHJlc3BvbnNlLmFyZ3VtZW50OwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCJsb2FkZXhjZXB0aW9uIiwgdGhpcywgYS5ub2RlLCByZXNwb25zZSk7CiAgICAgICAgdGhpcy5ydW5DYWxsYmFjayhhLmNhbGxiYWNrLCBhLnNjb3BlIHx8IGEubm9kZSwgW2Eubm9kZV0pOwogICAgfSwKCiAgICBkZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgICAgdGhpcy5wdXJnZUxpc3RlbmVycygpOwogICAgfQp9KTsKRXh0LnRyZWUuVHJlZUZpbHRlciA9IGZ1bmN0aW9uKHRyZWUsIGNvbmZpZyl7CiAgICB0aGlzLnRyZWUgPSB0cmVlOwogICAgdGhpcy5maWx0ZXJlZCA9IHt9OwogICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7Cn07CgpFeHQudHJlZS5UcmVlRmlsdGVyLnByb3RvdHlwZSA9IHsKICAgIGNsZWFyQmxhbms6ZmFsc2UsCiAgICByZXZlcnNlOmZhbHNlLAogICAgYXV0b0NsZWFyOmZhbHNlLAogICAgcmVtb3ZlOmZhbHNlLAoKICAgICAKICAgIGZpbHRlciA6IGZ1bmN0aW9uKHZhbHVlLCBhdHRyLCBzdGFydE5vZGUpewogICAgICAgIGF0dHIgPSBhdHRyIHx8ICJ0ZXh0IjsKICAgICAgICB2YXIgZjsKICAgICAgICBpZih0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIpewogICAgICAgICAgICB2YXIgdmxlbiA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHZsZW4gPT0gMCAmJiB0aGlzLmNsZWFyQmxhbmspewogICAgICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgZiA9IGZ1bmN0aW9uKG4pewogICAgICAgICAgICAgICAgcmV0dXJuIG4uYXR0cmlidXRlc1thdHRyXS5zdWJzdHIoMCwgdmxlbikudG9Mb3dlckNhc2UoKSA9PSB2YWx1ZTsKICAgICAgICAgICAgfTsKICAgICAgICB9ZWxzZSBpZih2YWx1ZS5leGVjKXsgCiAgICAgICAgICAgIGYgPSBmdW5jdGlvbihuKXsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS50ZXN0KG4uYXR0cmlidXRlc1thdHRyXSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRocm93ICdJbGxlZ2FsIGZpbHRlciB0eXBlLCBtdXN0IGJlIHN0cmluZyBvciByZWdleCc7CiAgICAgICAgfQogICAgICAgIHRoaXMuZmlsdGVyQnkoZiwgbnVsbCwgc3RhcnROb2RlKTsKCX0sCgogICAgCiAgICBmaWx0ZXJCeSA6IGZ1bmN0aW9uKGZuLCBzY29wZSwgc3RhcnROb2RlKXsKICAgICAgICBzdGFydE5vZGUgPSBzdGFydE5vZGUgfHwgdGhpcy50cmVlLnJvb3Q7CiAgICAgICAgaWYodGhpcy5hdXRvQ2xlYXIpewogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfQogICAgICAgIHZhciBhZiA9IHRoaXMuZmlsdGVyZWQsIHJ2ID0gdGhpcy5yZXZlcnNlOwogICAgICAgIHZhciBmID0gZnVuY3Rpb24obil7CiAgICAgICAgICAgIGlmKG4gPT0gc3RhcnROb2RlKXsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGFmW24uaWRdKXsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbSA9IGZuLmNhbGwoc2NvcGUgfHwgbiwgbik7CiAgICAgICAgICAgIGlmKCFtIHx8IHJ2KXsKICAgICAgICAgICAgICAgIGFmW24uaWRdID0gbjsKICAgICAgICAgICAgICAgIG4udWkuaGlkZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH07CiAgICAgICAgc3RhcnROb2RlLmNhc2NhZGUoZik7CiAgICAgICAgaWYodGhpcy5yZW1vdmUpewogICAgICAgICAgIGZvcih2YXIgaWQgaW4gYWYpewogICAgICAgICAgICAgICBpZih0eXBlb2YgaWQgIT0gImZ1bmN0aW9uIil7CiAgICAgICAgICAgICAgICAgICB2YXIgbiA9IGFmW2lkXTsKICAgICAgICAgICAgICAgICAgIGlmKG4gJiYgbi5wYXJlbnROb2RlKXsKICAgICAgICAgICAgICAgICAgICAgICBuLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobik7CiAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNsZWFyIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdCA9IHRoaXMudHJlZTsKICAgICAgICB2YXIgYWYgPSB0aGlzLmZpbHRlcmVkOwogICAgICAgIGZvcih2YXIgaWQgaW4gYWYpewogICAgICAgICAgICBpZih0eXBlb2YgaWQgIT0gImZ1bmN0aW9uIil7CiAgICAgICAgICAgICAgICB2YXIgbiA9IGFmW2lkXTsKICAgICAgICAgICAgICAgIGlmKG4pewogICAgICAgICAgICAgICAgICAgIG4udWkuc2hvdygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuZmlsdGVyZWQgPSB7fTsKICAgIH0KfTsKCkV4dC50cmVlLlRyZWVTb3J0ZXIgPSBFeHQuZXh0ZW5kKE9iamVjdCwgewogICAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24odHJlZSwgY29uZmlnKXsKICAgICAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCgogICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CiAgICB0cmVlLm9uKHsKICAgICAgICBzY29wZTogdGhpcywKICAgICAgICBiZWZvcmVjaGlsZHJlbnJlbmRlcmVkOiB0aGlzLmRvU29ydCwKICAgICAgICBhcHBlbmQ6IHRoaXMudXBkYXRlU29ydCwKICAgICAgICBpbnNlcnQ6IHRoaXMudXBkYXRlU29ydCwKICAgICAgICB0ZXh0Y2hhbmdlOiB0aGlzLnVwZGF0ZVNvcnRQYXJlbnQKICAgIH0pOwoKICAgIHZhciBkZXNjID0gdGhpcy5kaXIgJiYgdGhpcy5kaXIudG9Mb3dlckNhc2UoKSA9PSAnZGVzYycsCiAgICAgICAgcHJvcCA9IHRoaXMucHJvcGVydHkgfHwgJ3RleHQnLAogICAgICAgIHNvcnRUeXBlID0gdGhpcy5zb3J0VHlwZSwKICAgICAgICBmb2xkZXJTb3J0ID0gdGhpcy5mb2xkZXJTb3J0LAogICAgICAgIGNhc2VTZW5zaXRpdmUgPSB0aGlzLmNhc2VTZW5zaXRpdmUgPT09IHRydWUsCiAgICAgICAgbGVhZkF0dHIgPSB0aGlzLmxlYWZBdHRyIHx8ICdsZWFmJzsKCiAgICBpZihFeHQuaXNTdHJpbmcoc29ydFR5cGUpKXsKICAgICAgICBzb3J0VHlwZSA9IEV4dC5kYXRhLlNvcnRUeXBlc1tzb3J0VHlwZV07CiAgICB9CiAgICB0aGlzLnNvcnRGbiA9IGZ1bmN0aW9uKG4xLCBuMil7CiAgICAgICAgdmFyIGF0dHIxID0gbjEuYXR0cmlidXRlcywKICAgICAgICAgICAgYXR0cjIgPSBuMi5hdHRyaWJ1dGVzOwogICAgICAgICAgICAKICAgICAgICBpZihmb2xkZXJTb3J0KXsKICAgICAgICAgICAgaWYoYXR0cjFbbGVhZkF0dHJdICYmICFhdHRyMltsZWFmQXR0cl0pewogICAgICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIWF0dHIxW2xlYWZBdHRyXSAmJiBhdHRyMltsZWFmQXR0cl0pewogICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wMSA9IGF0dHIxW3Byb3BdLAogICAgICAgICAgICBwcm9wMiA9IGF0dHIyW3Byb3BdLAogICAgICAgICAgICB2MSA9IHNvcnRUeXBlID8gc29ydFR5cGUocHJvcDEpIDogKGNhc2VTZW5zaXRpdmUgPyBwcm9wMSA6IHByb3AxLnRvVXBwZXJDYXNlKCkpLAogICAgICAgICAgICB2MiA9IHNvcnRUeXBlID8gc29ydFR5cGUocHJvcDIpIDogKGNhc2VTZW5zaXRpdmUgPyBwcm9wMiA6IHByb3AyLnRvVXBwZXJDYXNlKCkpOwogICAgICAgICAgICAKICAgICAgICBpZih2MSA8IHYyKXsKICAgICAgICAgICAgcmV0dXJuIGRlc2MgPyAxIDogLTE7CiAgICAgICAgfWVsc2UgaWYodjEgPiB2Mil7CiAgICAgICAgICAgIHJldHVybiBkZXNjID8gLTEgOiAxOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH07CiAgICB9LAogICAgCiAgICBkb1NvcnQgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICBub2RlLnNvcnQodGhpcy5zb3J0Rm4pOwogICAgfSwKCiAgICB1cGRhdGVTb3J0IDogZnVuY3Rpb24odHJlZSwgbm9kZSl7CiAgICAgICAgaWYobm9kZS5jaGlsZHJlblJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy5kb1NvcnQuZGVmZXIoMSwgdGhpcywgW25vZGVdKTsKICAgICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZVNvcnRQYXJlbnQgOiBmdW5jdGlvbihub2RlKXsKICAgICAgICB2YXIgcCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICBpZihwICYmIHAuY2hpbGRyZW5SZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuZG9Tb3J0LmRlZmVyKDEsIHRoaXMsIFtwXSk7CiAgICAgICAgfQogICAgfSAgICAKfSk7CgppZihFeHQuZGQuRHJvcFpvbmUpewogICAgCkV4dC50cmVlLlRyZWVEcm9wWm9uZSA9IGZ1bmN0aW9uKHRyZWUsIGNvbmZpZyl7CiAgICAKICAgIHRoaXMuYWxsb3dQYXJlbnRJbnNlcnQgPSBjb25maWcuYWxsb3dQYXJlbnRJbnNlcnQgfHwgZmFsc2U7CiAgICAKICAgIHRoaXMuYWxsb3dDb250YWluZXJEcm9wID0gY29uZmlnLmFsbG93Q29udGFpbmVyRHJvcCB8fCBmYWxzZTsKICAgIAogICAgdGhpcy5hcHBlbmRPbmx5ID0gY29uZmlnLmFwcGVuZE9ubHkgfHwgZmFsc2U7CgogICAgRXh0LnRyZWUuVHJlZURyb3Bab25lLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCB0cmVlLmdldFRyZWVFbCgpLCBjb25maWcpOwogICAgCiAgICB0aGlzLnRyZWUgPSB0cmVlOwogICAgCiAgICB0aGlzLmRyYWdPdmVyRGF0YSA9IHt9OwogICAgCiAgICB0aGlzLmxhc3RJbnNlcnRDbGFzcyA9ICJ4LXRyZWUtbm8tc3RhdHVzIjsKfTsKCkV4dC5leHRlbmQoRXh0LnRyZWUuVHJlZURyb3Bab25lLCBFeHQuZGQuRHJvcFpvbmUsIHsKICAgIAogICAgZGRHcm91cCA6ICJUcmVlREQiLAoKICAgIAogICAgZXhwYW5kRGVsYXkgOiAxMDAwLAoKICAgIAogICAgZXhwYW5kTm9kZSA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIGlmKG5vZGUuaGFzQ2hpbGROb2RlcygpICYmICFub2RlLmlzRXhwYW5kZWQoKSl7CiAgICAgICAgICAgIG5vZGUuZXhwYW5kKGZhbHNlLCBudWxsLCB0aGlzLnRyaWdnZXJDYWNoZVJlZnJlc2guY3JlYXRlRGVsZWdhdGUodGhpcykpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBxdWV1ZUV4cGFuZCA6IGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHRoaXMuZXhwYW5kUHJvY0lkID0gdGhpcy5leHBhbmROb2RlLmRlZmVyKHRoaXMuZXhwYW5kRGVsYXksIHRoaXMsIFtub2RlXSk7CiAgICB9LAoKICAgIAogICAgY2FuY2VsRXhwYW5kIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmV4cGFuZFByb2NJZCl7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmV4cGFuZFByb2NJZCk7CiAgICAgICAgICAgIHRoaXMuZXhwYW5kUHJvY0lkID0gZmFsc2U7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGlzVmFsaWREcm9wUG9pbnQgOiBmdW5jdGlvbihuLCBwdCwgZGQsIGUsIGRhdGEpewogICAgICAgIGlmKCFuIHx8ICFkYXRhKXsgcmV0dXJuIGZhbHNlOyB9CiAgICAgICAgdmFyIHRhcmdldE5vZGUgPSBuLm5vZGU7CiAgICAgICAgdmFyIGRyb3BOb2RlID0gZGF0YS5ub2RlOwogICAgICAgIAogICAgICAgIGlmKCEodGFyZ2V0Tm9kZSAmJiB0YXJnZXROb2RlLmlzVGFyZ2V0ICYmIHB0KSl7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYocHQgPT0gImFwcGVuZCIgJiYgdGFyZ2V0Tm9kZS5hbGxvd0NoaWxkcmVuID09PSBmYWxzZSl7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgaWYoKHB0ID09ICJhYm92ZSIgfHwgcHQgPT0gImJlbG93IikgJiYgKHRhcmdldE5vZGUucGFyZW50Tm9kZSAmJiB0YXJnZXROb2RlLnBhcmVudE5vZGUuYWxsb3dDaGlsZHJlbiA9PT0gZmFsc2UpKXsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZihkcm9wTm9kZSAmJiAodGFyZ2V0Tm9kZSA9PSBkcm9wTm9kZSB8fCBkcm9wTm9kZS5jb250YWlucyh0YXJnZXROb2RlKSkpewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciBvdmVyRXZlbnQgPSB0aGlzLmRyYWdPdmVyRGF0YTsKICAgICAgICBvdmVyRXZlbnQudHJlZSA9IHRoaXMudHJlZTsKICAgICAgICBvdmVyRXZlbnQudGFyZ2V0ID0gdGFyZ2V0Tm9kZTsKICAgICAgICBvdmVyRXZlbnQuZGF0YSA9IGRhdGE7CiAgICAgICAgb3ZlckV2ZW50LnBvaW50ID0gcHQ7CiAgICAgICAgb3ZlckV2ZW50LnNvdXJjZSA9IGRkOwogICAgICAgIG92ZXJFdmVudC5yYXdFdmVudCA9IGU7CiAgICAgICAgb3ZlckV2ZW50LmRyb3BOb2RlID0gZHJvcE5vZGU7CiAgICAgICAgb3ZlckV2ZW50LmNhbmNlbCA9IGZhbHNlOyAgCiAgICAgICAgdmFyIHJlc3VsdCA9IHRoaXMudHJlZS5maXJlRXZlbnQoIm5vZGVkcmFnb3ZlciIsIG92ZXJFdmVudCk7CiAgICAgICAgcmV0dXJuIG92ZXJFdmVudC5jYW5jZWwgPT09IGZhbHNlICYmIHJlc3VsdCAhPT0gZmFsc2U7CiAgICB9LAoKICAgIAogICAgZ2V0RHJvcFBvaW50IDogZnVuY3Rpb24oZSwgbiwgZGQpewogICAgICAgIHZhciB0biA9IG4ubm9kZTsKICAgICAgICBpZih0bi5pc1Jvb3QpewogICAgICAgICAgICByZXR1cm4gdG4uYWxsb3dDaGlsZHJlbiAhPT0gZmFsc2UgPyAiYXBwZW5kIiA6IGZhbHNlOyAKICAgICAgICB9CiAgICAgICAgdmFyIGRyYWdFbCA9IG4uZGRlbDsKICAgICAgICB2YXIgdCA9IEV4dC5saWIuRG9tLmdldFkoZHJhZ0VsKSwgYiA9IHQgKyBkcmFnRWwub2Zmc2V0SGVpZ2h0OwogICAgICAgIHZhciB5ID0gRXh0LmxpYi5FdmVudC5nZXRQYWdlWShlKTsKICAgICAgICB2YXIgbm9BcHBlbmQgPSB0bi5hbGxvd0NoaWxkcmVuID09PSBmYWxzZSB8fCB0bi5pc0xlYWYoKTsKICAgICAgICBpZih0aGlzLmFwcGVuZE9ubHkgfHwgdG4ucGFyZW50Tm9kZS5hbGxvd0NoaWxkcmVuID09PSBmYWxzZSl7CiAgICAgICAgICAgIHJldHVybiBub0FwcGVuZCA/IGZhbHNlIDogImFwcGVuZCI7CiAgICAgICAgfQogICAgICAgIHZhciBub0JlbG93ID0gZmFsc2U7CiAgICAgICAgaWYoIXRoaXMuYWxsb3dQYXJlbnRJbnNlcnQpewogICAgICAgICAgICBub0JlbG93ID0gdG4uaGFzQ2hpbGROb2RlcygpICYmIHRuLmlzRXhwYW5kZWQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHEgPSAoYiAtIHQpIC8gKG5vQXBwZW5kID8gMiA6IDMpOwogICAgICAgIGlmKHkgPj0gdCAmJiB5IDwgKHQgKyBxKSl7CiAgICAgICAgICAgIHJldHVybiAiYWJvdmUiOwogICAgICAgIH1lbHNlIGlmKCFub0JlbG93ICYmIChub0FwcGVuZCB8fCB5ID49IGItcSAmJiB5IDw9IGIpKXsKICAgICAgICAgICAgcmV0dXJuICJiZWxvdyI7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHJldHVybiAiYXBwZW5kIjsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25Ob2RlRW50ZXIgOiBmdW5jdGlvbihuLCBkZCwgZSwgZGF0YSl7CiAgICAgICAgdGhpcy5jYW5jZWxFeHBhbmQoKTsKICAgIH0sCiAgICAKICAgIG9uQ29udGFpbmVyT3ZlciA6IGZ1bmN0aW9uKGRkLCBlLCBkYXRhKSB7CiAgICAgICAgaWYgKHRoaXMuYWxsb3dDb250YWluZXJEcm9wICYmIHRoaXMuaXNWYWxpZERyb3BQb2ludCh7IGRkZWw6IHRoaXMudHJlZS5nZXRSb290Tm9kZSgpLnVpLmVsTm9kZSwgbm9kZTogdGhpcy50cmVlLmdldFJvb3ROb2RlKCkgfSwgImFwcGVuZCIsIGRkLCBlLCBkYXRhKSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kcm9wQWxsb3dlZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuZHJvcE5vdEFsbG93ZWQ7CiAgICB9LAoKICAgIAogICAgb25Ob2RlT3ZlciA6IGZ1bmN0aW9uKG4sIGRkLCBlLCBkYXRhKXsKICAgICAgICB2YXIgcHQgPSB0aGlzLmdldERyb3BQb2ludChlLCBuLCBkZCk7CiAgICAgICAgdmFyIG5vZGUgPSBuLm5vZGU7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgaWYoIXRoaXMuZXhwYW5kUHJvY0lkICYmIHB0ID09ICJhcHBlbmQiICYmIG5vZGUuaGFzQ2hpbGROb2RlcygpICYmICFuLm5vZGUuaXNFeHBhbmRlZCgpKXsKICAgICAgICAgICAgdGhpcy5xdWV1ZUV4cGFuZChub2RlKTsKICAgICAgICB9ZWxzZSBpZihwdCAhPSAiYXBwZW5kIil7CiAgICAgICAgICAgIHRoaXMuY2FuY2VsRXhwYW5kKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIAogICAgICAgIHZhciByZXR1cm5DbHMgPSB0aGlzLmRyb3BOb3RBbGxvd2VkOwogICAgICAgIGlmKHRoaXMuaXNWYWxpZERyb3BQb2ludChuLCBwdCwgZGQsIGUsIGRhdGEpKXsKICAgICAgICAgICBpZihwdCl7CiAgICAgICAgICAgICAgIHZhciBlbCA9IG4uZGRlbDsKICAgICAgICAgICAgICAgdmFyIGNsczsKICAgICAgICAgICAgICAgaWYocHQgPT0gImFib3ZlIil7CiAgICAgICAgICAgICAgICAgICByZXR1cm5DbHMgPSBuLm5vZGUuaXNGaXJzdCgpID8gIngtdHJlZS1kcm9wLW9rLWFib3ZlIiA6ICJ4LXRyZWUtZHJvcC1vay1iZXR3ZWVuIjsKICAgICAgICAgICAgICAgICAgIGNscyA9ICJ4LXRyZWUtZHJhZy1pbnNlcnQtYWJvdmUiOwogICAgICAgICAgICAgICB9ZWxzZSBpZihwdCA9PSAiYmVsb3ciKXsKICAgICAgICAgICAgICAgICAgIHJldHVybkNscyA9IG4ubm9kZS5pc0xhc3QoKSA/ICJ4LXRyZWUtZHJvcC1vay1iZWxvdyIgOiAieC10cmVlLWRyb3Atb2stYmV0d2VlbiI7CiAgICAgICAgICAgICAgICAgICBjbHMgPSAieC10cmVlLWRyYWctaW5zZXJ0LWJlbG93IjsKICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICByZXR1cm5DbHMgPSAieC10cmVlLWRyb3Atb2stYXBwZW5kIjsKICAgICAgICAgICAgICAgICAgIGNscyA9ICJ4LXRyZWUtZHJhZy1hcHBlbmQiOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIGlmKHRoaXMubGFzdEluc2VydENsYXNzICE9IGNscyl7CiAgICAgICAgICAgICAgICAgICBFeHQuZmx5KGVsKS5yZXBsYWNlQ2xhc3ModGhpcy5sYXN0SW5zZXJ0Q2xhc3MsIGNscyk7CiAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RJbnNlcnRDbGFzcyA9IGNsczsKICAgICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgIH0KICAgICAgIHJldHVybiByZXR1cm5DbHM7CiAgICB9LAoKICAgIAogICAgb25Ob2RlT3V0IDogZnVuY3Rpb24obiwgZGQsIGUsIGRhdGEpewogICAgICAgIHRoaXMuY2FuY2VsRXhwYW5kKCk7CiAgICAgICAgdGhpcy5yZW1vdmVEcm9wSW5kaWNhdG9ycyhuKTsKICAgIH0sCgogICAgCiAgICBvbk5vZGVEcm9wIDogZnVuY3Rpb24obiwgZGQsIGUsIGRhdGEpewogICAgICAgIHZhciBwb2ludCA9IHRoaXMuZ2V0RHJvcFBvaW50KGUsIG4sIGRkKTsKICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IG4ubm9kZTsKICAgICAgICB0YXJnZXROb2RlLnVpLnN0YXJ0RHJvcCgpOwogICAgICAgIGlmKCF0aGlzLmlzVmFsaWREcm9wUG9pbnQobiwgcG9pbnQsIGRkLCBlLCBkYXRhKSl7CiAgICAgICAgICAgIHRhcmdldE5vZGUudWkuZW5kRHJvcCgpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciBkcm9wTm9kZSA9IGRhdGEubm9kZSB8fCAoZGQuZ2V0VHJlZU5vZGUgPyBkZC5nZXRUcmVlTm9kZShkYXRhLCB0YXJnZXROb2RlLCBwb2ludCwgZSkgOiBudWxsKTsKICAgICAgICByZXR1cm4gdGhpcy5wcm9jZXNzRHJvcCh0YXJnZXROb2RlLCBkYXRhLCBwb2ludCwgZGQsIGUsIGRyb3BOb2RlKTsKICAgIH0sCiAgICAKICAgIG9uQ29udGFpbmVyRHJvcCA6IGZ1bmN0aW9uKGRkLCBlLCBkYXRhKXsKICAgICAgICBpZiAodGhpcy5hbGxvd0NvbnRhaW5lckRyb3AgJiYgdGhpcy5pc1ZhbGlkRHJvcFBvaW50KHsgZGRlbDogdGhpcy50cmVlLmdldFJvb3ROb2RlKCkudWkuZWxOb2RlLCBub2RlOiB0aGlzLnRyZWUuZ2V0Um9vdE5vZGUoKSB9LCAiYXBwZW5kIiwgZGQsIGUsIGRhdGEpKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGhpcy50cmVlLmdldFJvb3ROb2RlKCk7ICAgICAgIAogICAgICAgICAgICB0YXJnZXROb2RlLnVpLnN0YXJ0RHJvcCgpOwogICAgICAgICAgICB2YXIgZHJvcE5vZGUgPSBkYXRhLm5vZGUgfHwgKGRkLmdldFRyZWVOb2RlID8gZGQuZ2V0VHJlZU5vZGUoZGF0YSwgdGFyZ2V0Tm9kZSwgJ2FwcGVuZCcsIGUpIDogbnVsbCk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnByb2Nlc3NEcm9wKHRhcmdldE5vZGUsIGRhdGEsICdhcHBlbmQnLCBkZCwgZSwgZHJvcE5vZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgCiAgICAKICAgIHByb2Nlc3NEcm9wOiBmdW5jdGlvbih0YXJnZXQsIGRhdGEsIHBvaW50LCBkZCwgZSwgZHJvcE5vZGUpewogICAgICAgIHZhciBkcm9wRXZlbnQgPSB7CiAgICAgICAgICAgIHRyZWUgOiB0aGlzLnRyZWUsCiAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0LAogICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICBwb2ludDogcG9pbnQsCiAgICAgICAgICAgIHNvdXJjZTogZGQsCiAgICAgICAgICAgIHJhd0V2ZW50OiBlLAogICAgICAgICAgICBkcm9wTm9kZTogZHJvcE5vZGUsCiAgICAgICAgICAgIGNhbmNlbDogIWRyb3BOb2RlLAogICAgICAgICAgICBkcm9wU3RhdHVzOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgdmFyIHJldHZhbCA9IHRoaXMudHJlZS5maXJlRXZlbnQoImJlZm9yZW5vZGVkcm9wIiwgZHJvcEV2ZW50KTsKICAgICAgICBpZihyZXR2YWwgPT09IGZhbHNlIHx8IGRyb3BFdmVudC5jYW5jZWwgPT09IHRydWUgfHwgIWRyb3BFdmVudC5kcm9wTm9kZSl7CiAgICAgICAgICAgIHRhcmdldC51aS5lbmREcm9wKCk7CiAgICAgICAgICAgIHJldHVybiBkcm9wRXZlbnQuZHJvcFN0YXR1czsKICAgICAgICB9CiAgICAKICAgICAgICB0YXJnZXQgPSBkcm9wRXZlbnQudGFyZ2V0OwogICAgICAgIGlmKHBvaW50ID09ICdhcHBlbmQnICYmICF0YXJnZXQuaXNFeHBhbmRlZCgpKXsKICAgICAgICAgICAgdGFyZ2V0LmV4cGFuZChmYWxzZSwgbnVsbCwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIHRoaXMuY29tcGxldGVEcm9wKGRyb3BFdmVudCk7CiAgICAgICAgICAgIH0uY3JlYXRlRGVsZWdhdGUodGhpcykpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmNvbXBsZXRlRHJvcChkcm9wRXZlbnQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgCiAgICBjb21wbGV0ZURyb3AgOiBmdW5jdGlvbihkZSl7CiAgICAgICAgdmFyIG5zID0gZGUuZHJvcE5vZGUsIHAgPSBkZS5wb2ludCwgdCA9IGRlLnRhcmdldDsKICAgICAgICBpZighRXh0LmlzQXJyYXkobnMpKXsKICAgICAgICAgICAgbnMgPSBbbnNdOwogICAgICAgIH0KICAgICAgICB2YXIgbjsKICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBucy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIG4gPSBuc1tpXTsKICAgICAgICAgICAgaWYocCA9PSAiYWJvdmUiKXsKICAgICAgICAgICAgICAgIHQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobiwgdCk7CiAgICAgICAgICAgIH1lbHNlIGlmKHAgPT0gImJlbG93Iil7CiAgICAgICAgICAgICAgICB0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG4sIHQubmV4dFNpYmxpbmcpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHQuYXBwZW5kQ2hpbGQobik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbi51aS5mb2N1cygpOwogICAgICAgIGlmKEV4dC5lbmFibGVGeCAmJiB0aGlzLnRyZWUuaGxEcm9wKXsKICAgICAgICAgICAgbi51aS5oaWdobGlnaHQoKTsKICAgICAgICB9CiAgICAgICAgdC51aS5lbmREcm9wKCk7CiAgICAgICAgdGhpcy50cmVlLmZpcmVFdmVudCgibm9kZWRyb3AiLCBkZSk7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJOb2RlTW92ZWQgOiBmdW5jdGlvbihkZCwgZGF0YSwgZSwgdGFyZ2V0Tm9kZSwgZHJvcE5vZGUpewogICAgICAgIGlmKEV4dC5lbmFibGVGeCAmJiB0aGlzLnRyZWUuaGxEcm9wKXsKICAgICAgICAgICAgZHJvcE5vZGUudWkuZm9jdXMoKTsKICAgICAgICAgICAgZHJvcE5vZGUudWkuaGlnaGxpZ2h0KCk7CiAgICAgICAgfQogICAgICAgIHRoaXMudHJlZS5maXJlRXZlbnQoIm5vZGVkcm9wIiwgdGhpcy50cmVlLCB0YXJnZXROb2RlLCBkYXRhLCBkZCwgZSk7CiAgICB9LAoKICAgIAogICAgZ2V0VHJlZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMudHJlZTsKICAgIH0sCgogICAgCiAgICByZW1vdmVEcm9wSW5kaWNhdG9ycyA6IGZ1bmN0aW9uKG4pewogICAgICAgIGlmKG4gJiYgbi5kZGVsKXsKICAgICAgICAgICAgdmFyIGVsID0gbi5kZGVsOwogICAgICAgICAgICBFeHQuZmx5KGVsKS5yZW1vdmVDbGFzcyhbCiAgICAgICAgICAgICAgICAgICAgIngtdHJlZS1kcmFnLWluc2VydC1hYm92ZSIsCiAgICAgICAgICAgICAgICAgICAgIngtdHJlZS1kcmFnLWluc2VydC1iZWxvdyIsCiAgICAgICAgICAgICAgICAgICAgIngtdHJlZS1kcmFnLWFwcGVuZCJdKTsKICAgICAgICAgICAgdGhpcy5sYXN0SW5zZXJ0Q2xhc3MgPSAiX25vY2xhc3MiOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBiZWZvcmVEcmFnRHJvcCA6IGZ1bmN0aW9uKHRhcmdldCwgZSwgaWQpewogICAgICAgIHRoaXMuY2FuY2VsRXhwYW5kKCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIAogICAgYWZ0ZXJSZXBhaXIgOiBmdW5jdGlvbihkYXRhKXsKICAgICAgICBpZihkYXRhICYmIEV4dC5lbmFibGVGeCl7CiAgICAgICAgICAgIGRhdGEubm9kZS51aS5oaWdobGlnaHQoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5oaWRlUHJveHkoKTsKICAgIH0gICAgCn0pOwoKfQppZihFeHQuZGQuRHJhZ1pvbmUpewpFeHQudHJlZS5UcmVlRHJhZ1pvbmUgPSBmdW5jdGlvbih0cmVlLCBjb25maWcpewogICAgRXh0LnRyZWUuVHJlZURyYWdab25lLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCB0cmVlLmlubmVyQ3QsIGNvbmZpZyk7CiAgICAKICAgIHRoaXMudHJlZSA9IHRyZWU7Cn07CgpFeHQuZXh0ZW5kKEV4dC50cmVlLlRyZWVEcmFnWm9uZSwgRXh0LmRkLkRyYWdab25lLCB7CiAgICAKICAgIGRkR3JvdXAgOiAiVHJlZUREIiwKCiAgICAKICAgIG9uQmVmb3JlRHJhZyA6IGZ1bmN0aW9uKGRhdGEsIGUpewogICAgICAgIHZhciBuID0gZGF0YS5ub2RlOwogICAgICAgIHJldHVybiBuICYmIG4uZHJhZ2dhYmxlICYmICFuLmRpc2FibGVkOwogICAgfSwKCiAgICAKICAgIG9uSW5pdERyYWcgOiBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZHJhZ0RhdGE7CiAgICAgICAgdGhpcy50cmVlLmdldFNlbGVjdGlvbk1vZGVsKCkuc2VsZWN0KGRhdGEubm9kZSk7CiAgICAgICAgdGhpcy50cmVlLmV2ZW50TW9kZWwuZGlzYWJsZSgpOwogICAgICAgIHRoaXMucHJveHkudXBkYXRlKCIiKTsKICAgICAgICBkYXRhLm5vZGUudWkuYXBwZW5kRERHaG9zdCh0aGlzLnByb3h5Lmdob3N0LmRvbSk7CiAgICAgICAgdGhpcy50cmVlLmZpcmVFdmVudCgic3RhcnRkcmFnIiwgdGhpcy50cmVlLCBkYXRhLm5vZGUsIGUpOwogICAgfSwKCiAgICAKICAgIGdldFJlcGFpclhZIDogZnVuY3Rpb24oZSwgZGF0YSl7CiAgICAgICAgcmV0dXJuIGRhdGEubm9kZS51aS5nZXRERFJlcGFpclhZKCk7CiAgICB9LAoKICAgIAogICAgb25FbmREcmFnIDogZnVuY3Rpb24oZGF0YSwgZSl7CiAgICAgICAgdGhpcy50cmVlLmV2ZW50TW9kZWwuZW5hYmxlLmRlZmVyKDEwMCwgdGhpcy50cmVlLmV2ZW50TW9kZWwpOwogICAgICAgIHRoaXMudHJlZS5maXJlRXZlbnQoImVuZGRyYWciLCB0aGlzLnRyZWUsIGRhdGEubm9kZSwgZSk7CiAgICB9LAoKICAgIAogICAgb25WYWxpZERyb3AgOiBmdW5jdGlvbihkZCwgZSwgaWQpewogICAgICAgIHRoaXMudHJlZS5maXJlRXZlbnQoImRyYWdkcm9wIiwgdGhpcy50cmVlLCB0aGlzLmRyYWdEYXRhLm5vZGUsIGRkLCBlKTsKICAgICAgICB0aGlzLmhpZGVQcm94eSgpOwogICAgfSwKCiAgICAKICAgIGJlZm9yZUludmFsaWREcm9wIDogZnVuY3Rpb24oZSwgaWQpewogICAgICAgIAogICAgICAgIHZhciBzbSA9IHRoaXMudHJlZS5nZXRTZWxlY3Rpb25Nb2RlbCgpOwogICAgICAgIHNtLmNsZWFyU2VsZWN0aW9ucygpOwogICAgICAgIHNtLnNlbGVjdCh0aGlzLmRyYWdEYXRhLm5vZGUpOwogICAgfSwKICAgIAogICAgCiAgICBhZnRlclJlcGFpciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKEV4dC5lbmFibGVGeCAmJiB0aGlzLnRyZWUuaGxEcm9wKSB7CiAgICAgICAgICAgIEV4dC5FbGVtZW50LmZseSh0aGlzLmRyYWdEYXRhLmRkZWwpLmhpZ2hsaWdodCh0aGlzLmhsQ29sb3IgfHwgImMzZGFmOSIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmRyYWdnaW5nID0gZmFsc2U7CiAgICB9Cn0pOwp9CkV4dC50cmVlLlRyZWVFZGl0b3IgPSBmdW5jdGlvbih0cmVlLCBmYywgY29uZmlnKXsKICAgIGZjID0gZmMgfHwge307CiAgICB2YXIgZmllbGQgPSBmYy5ldmVudHMgPyBmYyA6IG5ldyBFeHQuZm9ybS5UZXh0RmllbGQoZmMpOwogICAgCiAgICBFeHQudHJlZS5UcmVlRWRpdG9yLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBmaWVsZCwgY29uZmlnKTsKCiAgICB0aGlzLnRyZWUgPSB0cmVlOwoKICAgIGlmKCF0cmVlLnJlbmRlcmVkKXsKICAgICAgICB0cmVlLm9uKCdyZW5kZXInLCB0aGlzLmluaXRFZGl0b3IsIHRoaXMpOwogICAgfWVsc2V7CiAgICAgICAgdGhpcy5pbml0RWRpdG9yKHRyZWUpOwogICAgfQp9OwoKRXh0LmV4dGVuZChFeHQudHJlZS5UcmVlRWRpdG9yLCBFeHQuRWRpdG9yLCB7CiAgICAKICAgIGFsaWdubWVudDogImwtbCIsCiAgICAKICAgIGF1dG9TaXplOiBmYWxzZSwKICAgIAogICAgaGlkZUVsIDogZmFsc2UsCiAgICAKICAgIGNsczogIngtc21hbGwtZWRpdG9yIHgtdHJlZS1lZGl0b3IiLAogICAgCiAgICBzaGltOmZhbHNlLAogICAgCiAgICBzaGFkb3c6ImZyYW1lIiwKICAgIAogICAgbWF4V2lkdGg6IDI1MCwKICAgIAogICAgZWRpdERlbGF5IDogMzUwLAoKICAgIGluaXRFZGl0b3IgOiBmdW5jdGlvbih0cmVlKXsKICAgICAgICB0cmVlLm9uKHsKICAgICAgICAgICAgc2NvcGUgICAgICA6IHRoaXMsCiAgICAgICAgICAgIGJlZm9yZWNsaWNrOiB0aGlzLmJlZm9yZU5vZGVDbGljaywKICAgICAgICAgICAgZGJsY2xpY2sgICA6IHRoaXMub25Ob2RlRGJsQ2xpY2sKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICB0aGlzLm9uKHsKICAgICAgICAgICAgc2NvcGUgICAgICAgICAgOiB0aGlzLAogICAgICAgICAgICBjb21wbGV0ZSAgICAgICA6IHRoaXMudXBkYXRlTm9kZSwKICAgICAgICAgICAgYmVmb3Jlc3RhcnRlZGl0OiB0aGlzLmZpdFRvVHJlZSwKICAgICAgICAgICAgc3BlY2lhbGtleSAgICAgOiB0aGlzLm9uU3BlY2lhbEtleQogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIHRoaXMub24oJ3N0YXJ0ZWRpdCcsIHRoaXMuYmluZFNjcm9sbCwgdGhpcywge2RlbGF5OjEwfSk7CiAgICB9LAoKICAgIAogICAgZml0VG9UcmVlIDogZnVuY3Rpb24oZWQsIGVsKXsKICAgICAgICB2YXIgdGQgPSB0aGlzLnRyZWUuZ2V0VHJlZUVsKCkuZG9tLCBuZCA9IGVsLmRvbTsKICAgICAgICBpZih0ZC5zY3JvbGxMZWZ0ID4gIG5kLm9mZnNldExlZnQpeyAKICAgICAgICAgICAgdGQuc2Nyb2xsTGVmdCA9IG5kLm9mZnNldExlZnQ7CiAgICAgICAgfQogICAgICAgIHZhciB3ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICB0aGlzLm1heFdpZHRoLAogICAgICAgICAgICAgICAgKHRkLmNsaWVudFdpZHRoID4gMjAgPyB0ZC5jbGllbnRXaWR0aCA6IHRkLm9mZnNldFdpZHRoKSAtIE1hdGgubWF4KDAsIG5kLm9mZnNldExlZnQtdGQuc2Nyb2xsTGVmdCkgLSA1KTsKICAgICAgICB0aGlzLnNldFNpemUodywgJycpOwogICAgfSwKCiAgICAKICAgIHRyaWdnZXJFZGl0IDogZnVuY3Rpb24obm9kZSwgZGVmZXIpewogICAgICAgIHRoaXMuY29tcGxldGVFZGl0KCk7CgkJaWYobm9kZS5hdHRyaWJ1dGVzLmVkaXRhYmxlICE9PSBmYWxzZSl7CiAgICAgICAgICAgCgkJCXRoaXMuZWRpdE5vZGUgPSBub2RlOwogICAgICAgICAgICBpZih0aGlzLnRyZWUuYXV0b1Njcm9sbCl7CiAgICAgICAgICAgICAgICBFeHQuZmx5KG5vZGUudWkuZ2V0RWwoKSkuc2Nyb2xsSW50b1ZpZXcodGhpcy50cmVlLmJvZHkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUudGV4dCB8fCAnJzsKICAgICAgICAgICAgaWYgKCFFeHQuaXNHZWNrbyAmJiBFeHQuaXNFbXB0eShub2RlLnRleHQpKXsKICAgICAgICAgICAgICAgIG5vZGUuc2V0VGV4dCgnJiMxNjA7Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hdXRvRWRpdFRpbWVyID0gdGhpcy5zdGFydEVkaXQuZGVmZXIodGhpcy5lZGl0RGVsYXksIHRoaXMsIFtub2RlLnVpLnRleHROb2RlLCB2YWx1ZV0pOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGJpbmRTY3JvbGwgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMudHJlZS5nZXRUcmVlRWwoKS5vbignc2Nyb2xsJywgdGhpcy5jYW5jZWxFZGl0LCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBiZWZvcmVOb2RlQ2xpY2sgOiBmdW5jdGlvbihub2RlLCBlKXsKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5hdXRvRWRpdFRpbWVyKTsKICAgICAgICBpZih0aGlzLnRyZWUuZ2V0U2VsZWN0aW9uTW9kZWwoKS5pc1NlbGVjdGVkKG5vZGUpKXsKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlckVkaXQobm9kZSk7CiAgICAgICAgfQogICAgfSwKCiAgICBvbk5vZGVEYmxDbGljayA6IGZ1bmN0aW9uKG5vZGUsIGUpewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmF1dG9FZGl0VGltZXIpOwogICAgfSwKCiAgICAKICAgIHVwZGF0ZU5vZGUgOiBmdW5jdGlvbihlZCwgdmFsdWUpewogICAgICAgIHRoaXMudHJlZS5nZXRUcmVlRWwoKS51bignc2Nyb2xsJywgdGhpcy5jYW5jZWxFZGl0LCB0aGlzKTsKICAgICAgICB0aGlzLmVkaXROb2RlLnNldFRleHQodmFsdWUpOwogICAgfSwKCiAgICAKICAgIG9uSGlkZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LnRyZWUuVHJlZUVkaXRvci5zdXBlcmNsYXNzLm9uSGlkZS5jYWxsKHRoaXMpOwogICAgICAgIGlmKHRoaXMuZWRpdE5vZGUpewogICAgICAgICAgICB0aGlzLmVkaXROb2RlLnVpLmZvY3VzLmRlZmVyKDUwLCB0aGlzLmVkaXROb2RlLnVpKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25TcGVjaWFsS2V5IDogZnVuY3Rpb24oZmllbGQsIGUpewogICAgICAgIHZhciBrID0gZS5nZXRLZXkoKTsKICAgICAgICBpZihrID09IGUuRVNDKXsKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgdGhpcy5jYW5jZWxFZGl0KCk7CiAgICAgICAgfWVsc2UgaWYoayA9PSBlLkVOVEVSICYmICFlLmhhc01vZGlmaWVyKCkpewogICAgICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgICAgICB0aGlzLmNvbXBsZXRlRWRpdCgpOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIG9uRGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuYXV0b0VkaXRUaW1lcik7CiAgICAgICAgRXh0LnRyZWUuVHJlZUVkaXRvci5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHZhciB0cmVlID0gdGhpcy50cmVlOwogICAgICAgIHRyZWUudW4oJ2JlZm9yZWNsaWNrJywgdGhpcy5iZWZvcmVOb2RlQ2xpY2ssIHRoaXMpOwogICAgICAgIHRyZWUudW4oJ2RibGNsaWNrJywgdGhpcy5vbk5vZGVEYmxDbGljaywgdGhpcyk7CiAgICB9Cn0pOwoKdmFyIHN3Zm9iamVjdCA9IGZ1bmN0aW9uKCkgewogICAgCiAgICB2YXIgVU5ERUYgPSAidW5kZWZpbmVkIiwKICAgICAgICBPQkpFQ1QgPSAib2JqZWN0IiwKICAgICAgICBTSE9DS1dBVkVfRkxBU0ggPSAiU2hvY2t3YXZlIEZsYXNoIiwKICAgICAgICBTSE9DS1dBVkVfRkxBU0hfQVggPSAiU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2giLAogICAgICAgIEZMQVNIX01JTUVfVFlQRSA9ICJhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCIsCiAgICAgICAgRVhQUkVTU19JTlNUQUxMX0lEID0gIlNXRk9iamVjdEV4cHJJbnN0IiwKICAgICAgICBPTl9SRUFEWV9TVEFURV9DSEFOR0UgPSAib25yZWFkeXN0YXRlY2hhbmdlIiwKICAgICAgICAKICAgICAgICB3aW4gPSB3aW5kb3csCiAgICAgICAgZG9jID0gZG9jdW1lbnQsCiAgICAgICAgbmF2ID0gbmF2aWdhdG9yLAogICAgICAgIAogICAgICAgIHBsdWdpbiA9IGZhbHNlLAogICAgICAgIGRvbUxvYWRGbkFyciA9IFttYWluXSwKICAgICAgICByZWdPYmpBcnIgPSBbXSwKICAgICAgICBvYmpJZEFyciA9IFtdLAogICAgICAgIGxpc3RlbmVyc0FyciA9IFtdLAogICAgICAgIHN0b3JlZEFsdENvbnRlbnQsCiAgICAgICAgc3RvcmVkQWx0Q29udGVudElkLAogICAgICAgIHN0b3JlZENhbGxiYWNrRm4sCiAgICAgICAgc3RvcmVkQ2FsbGJhY2tPYmosCiAgICAgICAgaXNEb21Mb2FkZWQgPSBmYWxzZSwKICAgICAgICBpc0V4cHJlc3NJbnN0YWxsQWN0aXZlID0gZmFsc2UsCiAgICAgICAgZHluYW1pY1N0eWxlc2hlZXQsCiAgICAgICAgZHluYW1pY1N0eWxlc2hlZXRNZWRpYSwKICAgICAgICBhdXRvSGlkZVNob3cgPSB0cnVlLAogICAgCiAgICAgIAogICAgdWEgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdzNjZG9tID0gdHlwZW9mIGRvYy5nZXRFbGVtZW50QnlJZCAhPSBVTkRFRiAmJiB0eXBlb2YgZG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lICE9IFVOREVGICYmIHR5cGVvZiBkb2MuY3JlYXRlRWxlbWVudCAhPSBVTkRFRiwKICAgICAgICAgICAgdSA9IG5hdi51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgcCA9IG5hdi5wbGF0Zm9ybS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICB3aW5kb3dzID0gcCA/ICgvd2luLykudGVzdChwKSA6IC93aW4vLnRlc3QodSksCiAgICAgICAgICAgIG1hYyA9IHAgPyAoL21hYy8pLnRlc3QocCkgOiAvbWFjLy50ZXN0KHUpLAogICAgICAgICAgICB3ZWJraXQgPSAvd2Via2l0Ly50ZXN0KHUpID8gcGFyc2VGbG9hdCh1LnJlcGxhY2UoL14uKndlYmtpdFwvKFxkKyhcLlxkKyk/KS4qJC8sICIkMSIpKSA6IGZhbHNlLCAKICAgICAgICAgICAgaWUgPSAhKyJcdjEiLCAKICAgICAgICAgICAgcGxheWVyVmVyc2lvbiA9IFswLDAsMF0sCiAgICAgICAgICAgIGQgPSBudWxsOwogICAgICAgIGlmICh0eXBlb2YgbmF2LnBsdWdpbnMgIT0gVU5ERUYgJiYgdHlwZW9mIG5hdi5wbHVnaW5zW1NIT0NLV0FWRV9GTEFTSF0gPT0gT0JKRUNUKSB7CiAgICAgICAgICAgIGQgPSBuYXYucGx1Z2luc1tTSE9DS1dBVkVfRkxBU0hdLmRlc2NyaXB0aW9uOwogICAgICAgICAgICBpZiAoZCAmJiAhKHR5cGVvZiBuYXYubWltZVR5cGVzICE9IFVOREVGICYmIG5hdi5taW1lVHlwZXNbRkxBU0hfTUlNRV9UWVBFXSAmJiAhbmF2Lm1pbWVUeXBlc1tGTEFTSF9NSU1FX1RZUEVdLmVuYWJsZWRQbHVnaW4pKSB7IAogICAgICAgICAgICAgICAgcGx1Z2luID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGllID0gZmFsc2U7IAogICAgICAgICAgICAgICAgZCA9IGQucmVwbGFjZSgvXi4qXHMrKFxTK1xzK1xTKyQpLywgIiQxIik7CiAgICAgICAgICAgICAgICBwbGF5ZXJWZXJzaW9uWzBdID0gcGFyc2VJbnQoZC5yZXBsYWNlKC9eKC4qKVwuLiokLywgIiQxIiksIDEwKTsKICAgICAgICAgICAgICAgIHBsYXllclZlcnNpb25bMV0gPSBwYXJzZUludChkLnJlcGxhY2UoL14uKlwuKC4qKVxzLiokLywgIiQxIiksIDEwKTsKICAgICAgICAgICAgICAgIHBsYXllclZlcnNpb25bMl0gPSAvW2EtekEtWl0vLnRlc3QoZCkgPyBwYXJzZUludChkLnJlcGxhY2UoL14uKlthLXpBLVpdKyguKikkLywgIiQxIiksIDEwKSA6IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHdpbi5BY3RpdmVYT2JqZWN0ICE9IFVOREVGKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB2YXIgYSA9IG5ldyBBY3RpdmVYT2JqZWN0KFNIT0NLV0FWRV9GTEFTSF9BWCk7CiAgICAgICAgICAgICAgICBpZiAoYSkgeyAKICAgICAgICAgICAgICAgICAgICBkID0gYS5HZXRWYXJpYWJsZSgiJHZlcnNpb24iKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZSA9IHRydWU7IAogICAgICAgICAgICAgICAgICAgICAgICBkID0gZC5zcGxpdCgiICIpWzFdLnNwbGl0KCIsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllclZlcnNpb24gPSBbcGFyc2VJbnQoZFswXSwgMTApLCBwYXJzZUludChkWzFdLCAxMCksIHBhcnNlSW50KGRbMl0sIDEwKV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoKGUpIHt9CiAgICAgICAgfQogICAgICAgIHJldHVybiB7IHczOnczY2RvbSwgcHY6cGxheWVyVmVyc2lvbiwgd2s6d2Via2l0LCBpZTppZSwgd2luOndpbmRvd3MsIG1hYzptYWMgfTsKICAgIH0oKSwKICAgIAogICAgIAogICAgb25Eb21Mb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF1YS53MykgeyByZXR1cm47IH0KICAgICAgICBpZiAoKHR5cGVvZiBkb2MucmVhZHlTdGF0ZSAhPSBVTkRFRiAmJiBkb2MucmVhZHlTdGF0ZSA9PSAiY29tcGxldGUiKSB8fCAodHlwZW9mIGRvYy5yZWFkeVN0YXRlID09IFVOREVGICYmIChkb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXSB8fCBkb2MuYm9keSkpKSB7IAogICAgICAgICAgICBjYWxsRG9tTG9hZEZ1bmN0aW9ucygpOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzRG9tTG9hZGVkKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jLmFkZEV2ZW50TGlzdGVuZXIgIT0gVU5ERUYpIHsKICAgICAgICAgICAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgY2FsbERvbUxvYWRGdW5jdGlvbnMsIGZhbHNlKTsKICAgICAgICAgICAgfSAgICAgICAKICAgICAgICAgICAgaWYgKHVhLmllICYmIHVhLndpbikgewogICAgICAgICAgICAgICAgZG9jLmF0dGFjaEV2ZW50KE9OX1JFQURZX1NUQVRFX0NIQU5HRSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvYy5yZWFkeVN0YXRlID09ICJjb21wbGV0ZSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jLmRldGFjaEV2ZW50KE9OX1JFQURZX1NUQVRFX0NIQU5HRSwgYXJndW1lbnRzLmNhbGxlZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxEb21Mb2FkRnVuY3Rpb25zKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAod2luID09IHRvcCkgeyAKICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRG9tTG9hZGVkKSB7IHJldHVybjsgfQogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jLmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCgibGVmdCIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYXJndW1lbnRzLmNhbGxlZSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2FsbERvbUxvYWRGdW5jdGlvbnMoKTsKICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh1YS53aykgewogICAgICAgICAgICAgICAgKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRG9tTG9hZGVkKSB7IHJldHVybjsgfQogICAgICAgICAgICAgICAgICAgIGlmICghKC9sb2FkZWR8Y29tcGxldGUvKS50ZXN0KGRvYy5yZWFkeVN0YXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFyZ3VtZW50cy5jYWxsZWUsIDApOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhbGxEb21Mb2FkRnVuY3Rpb25zKCk7CiAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFkZExvYWRFdmVudChjYWxsRG9tTG9hZEZ1bmN0aW9ucyk7CiAgICAgICAgfQogICAgfSgpOwogICAgCiAgICBmdW5jdGlvbiBjYWxsRG9tTG9hZEZ1bmN0aW9ucygpIHsKICAgICAgICBpZiAoaXNEb21Mb2FkZWQpIHsgcmV0dXJuOyB9CiAgICAgICAgdHJ5IHsgCiAgICAgICAgICAgIHZhciB0ID0gZG9jLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uYXBwZW5kQ2hpbGQoY3JlYXRlRWxlbWVudCgic3BhbiIpKTsKICAgICAgICAgICAgdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHQpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoZSkgeyByZXR1cm47IH0KICAgICAgICBpc0RvbUxvYWRlZCA9IHRydWU7CiAgICAgICAgdmFyIGRsID0gZG9tTG9hZEZuQXJyLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRsOyBpKyspIHsKICAgICAgICAgICAgZG9tTG9hZEZuQXJyW2ldKCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICBmdW5jdGlvbiBhZGREb21Mb2FkRXZlbnQoZm4pIHsKICAgICAgICBpZiAoaXNEb21Mb2FkZWQpIHsKICAgICAgICAgICAgZm4oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7IAogICAgICAgICAgICBkb21Mb2FkRm5BcnJbZG9tTG9hZEZuQXJyLmxlbmd0aF0gPSBmbjsgCiAgICAgICAgfQogICAgfQogICAgCiAgICAKICAgIGZ1bmN0aW9uIGFkZExvYWRFdmVudChmbikgewogICAgICAgIGlmICh0eXBlb2Ygd2luLmFkZEV2ZW50TGlzdGVuZXIgIT0gVU5ERUYpIHsKICAgICAgICAgICAgd2luLmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmbiwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlb2YgZG9jLmFkZEV2ZW50TGlzdGVuZXIgIT0gVU5ERUYpIHsKICAgICAgICAgICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmbiwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlb2Ygd2luLmF0dGFjaEV2ZW50ICE9IFVOREVGKSB7CiAgICAgICAgICAgIGFkZExpc3RlbmVyKHdpbiwgIm9ubG9hZCIsIGZuKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHdpbi5vbmxvYWQgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgZm5PbGQgPSB3aW4ub25sb2FkOwogICAgICAgICAgICB3aW4ub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmbk9sZCgpOwogICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHdpbi5vbmxvYWQgPSBmbjsKICAgICAgICB9CiAgICB9CiAgICAKICAgIAogICAgZnVuY3Rpb24gbWFpbigpIHsgCiAgICAgICAgaWYgKHBsdWdpbikgewogICAgICAgICAgICB0ZXN0UGxheWVyVmVyc2lvbigpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgbWF0Y2hWZXJzaW9ucygpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgCiAgICBmdW5jdGlvbiB0ZXN0UGxheWVyVmVyc2lvbigpIHsKICAgICAgICB2YXIgYiA9IGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdOwogICAgICAgIHZhciBvID0gY3JlYXRlRWxlbWVudChPQkpFQ1QpOwogICAgICAgIG8uc2V0QXR0cmlidXRlKCJ0eXBlIiwgRkxBU0hfTUlNRV9UWVBFKTsKICAgICAgICB2YXIgdCA9IGIuYXBwZW5kQ2hpbGQobyk7CiAgICAgICAgaWYgKHQpIHsKICAgICAgICAgICAgdmFyIGNvdW50ZXIgPSAwOwogICAgICAgICAgICAoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdC5HZXRWYXJpYWJsZSAhPSBVTkRFRikgewogICAgICAgICAgICAgICAgICAgIHZhciBkID0gdC5HZXRWYXJpYWJsZSgiJHZlcnNpb24iKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZCkgewogICAgICAgICAgICAgICAgICAgICAgICBkID0gZC5zcGxpdCgiICIpWzFdLnNwbGl0KCIsIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHVhLnB2ID0gW3BhcnNlSW50KGRbMF0sIDEwKSwgcGFyc2VJbnQoZFsxXSwgMTApLCBwYXJzZUludChkWzJdLCAxMCldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNvdW50ZXIgPCAxMCkgewogICAgICAgICAgICAgICAgICAgIGNvdW50ZXIrKzsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFyZ3VtZW50cy5jYWxsZWUsIDEwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBiLnJlbW92ZUNoaWxkKG8pOwogICAgICAgICAgICAgICAgdCA9IG51bGw7CiAgICAgICAgICAgICAgICBtYXRjaFZlcnNpb25zKCk7CiAgICAgICAgICAgIH0pKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBtYXRjaFZlcnNpb25zKCk7CiAgICAgICAgfQogICAgfQogICAgCiAgICAKICAgIGZ1bmN0aW9uIG1hdGNoVmVyc2lvbnMoKSB7CiAgICAgICAgdmFyIHJsID0gcmVnT2JqQXJyLmxlbmd0aDsKICAgICAgICBpZiAocmwgPiAwKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmw7IGkrKykgeyAKICAgICAgICAgICAgICAgIHZhciBpZCA9IHJlZ09iakFycltpXS5pZDsKICAgICAgICAgICAgICAgIHZhciBjYiA9IHJlZ09iakFycltpXS5jYWxsYmFja0ZuOwogICAgICAgICAgICAgICAgdmFyIGNiT2JqID0ge3N1Y2Nlc3M6ZmFsc2UsIGlkOmlkfTsKICAgICAgICAgICAgICAgIGlmICh1YS5wdlswXSA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0gZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChvYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhc1BsYXllclZlcnNpb24ocmVnT2JqQXJyW2ldLnN3ZlZlcnNpb24pICYmICEodWEud2sgJiYgdWEud2sgPCAzMTIpKSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VmlzaWJpbGl0eShpZCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYk9iai5zdWNjZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYk9iai5yZWYgPSBnZXRPYmplY3RCeUlkKGlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYihjYk9iaik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmVnT2JqQXJyW2ldLmV4cHJlc3NJbnN0YWxsICYmIGNhbkV4cHJlc3NJbnN0YWxsKCkpIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHQuZGF0YSA9IHJlZ09iakFycltpXS5leHByZXNzSW5zdGFsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dC53aWR0aCA9IG9iai5nZXRBdHRyaWJ1dGUoIndpZHRoIikgfHwgIjAiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0LmhlaWdodCA9IG9iai5nZXRBdHRyaWJ1dGUoImhlaWdodCIpIHx8ICIwIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvYmouZ2V0QXR0cmlidXRlKCJjbGFzcyIpKSB7IGF0dC5zdHlsZWNsYXNzID0gb2JqLmdldEF0dHJpYnV0ZSgiY2xhc3MiKTsgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5nZXRBdHRyaWJ1dGUoImFsaWduIikpIHsgYXR0LmFsaWduID0gb2JqLmdldEF0dHJpYnV0ZSgiYWxpZ24iKTsgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcCA9IG9iai5nZXRFbGVtZW50c0J5VGFnTmFtZSgicGFyYW0iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwbCA9IHAubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwbDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBbal0uZ2V0QXR0cmlidXRlKCJuYW1lIikudG9Mb3dlckNhc2UoKSAhPSAibW92aWUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcltwW2pdLmdldEF0dHJpYnV0ZSgibmFtZSIpXSA9IHBbal0uZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dFeHByZXNzSW5zdGFsbChhdHQsIHBhciwgaWQsIGNiKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5QWx0Q29udGVudChvYmopOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNiKSB7IGNiKGNiT2JqKTsgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7ICAKICAgICAgICAgICAgICAgICAgICBzZXRWaXNpYmlsaXR5KGlkLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG8gPSBnZXRPYmplY3RCeUlkKGlkKTsgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvICYmIHR5cGVvZiBvLlNldFZhcmlhYmxlICE9IFVOREVGKSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2JPYmouc3VjY2VzcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYk9iai5yZWYgPSBvOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNiKGNiT2JqKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGdldE9iamVjdEJ5SWQob2JqZWN0SWRTdHIpIHsKICAgICAgICB2YXIgciA9IG51bGw7CiAgICAgICAgdmFyIG8gPSBnZXRFbGVtZW50QnlJZChvYmplY3RJZFN0cik7CiAgICAgICAgaWYgKG8gJiYgby5ub2RlTmFtZSA9PSAiT0JKRUNUIikgewogICAgICAgICAgICBpZiAodHlwZW9mIG8uU2V0VmFyaWFibGUgIT0gVU5ERUYpIHsKICAgICAgICAgICAgICAgIHIgPSBvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdmFyIG4gPSBvLmdldEVsZW1lbnRzQnlUYWdOYW1lKE9CSkVDVClbMF07CiAgICAgICAgICAgICAgICBpZiAobikgewogICAgICAgICAgICAgICAgICAgIHIgPSBuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByOwogICAgfQogICAgCiAgICAKICAgIGZ1bmN0aW9uIGNhbkV4cHJlc3NJbnN0YWxsKCkgewogICAgICAgIHJldHVybiAhaXNFeHByZXNzSW5zdGFsbEFjdGl2ZSAmJiBoYXNQbGF5ZXJWZXJzaW9uKCI2LjAuNjUiKSAmJiAodWEud2luIHx8IHVhLm1hYykgJiYgISh1YS53ayAmJiB1YS53ayA8IDMxMik7CiAgICB9CiAgICAKICAgIAogICAgZnVuY3Rpb24gc2hvd0V4cHJlc3NJbnN0YWxsKGF0dCwgcGFyLCByZXBsYWNlRWxlbUlkU3RyLCBjYWxsYmFja0ZuKSB7CiAgICAgICAgaXNFeHByZXNzSW5zdGFsbEFjdGl2ZSA9IHRydWU7CiAgICAgICAgc3RvcmVkQ2FsbGJhY2tGbiA9IGNhbGxiYWNrRm4gfHwgbnVsbDsKICAgICAgICBzdG9yZWRDYWxsYmFja09iaiA9IHtzdWNjZXNzOmZhbHNlLCBpZDpyZXBsYWNlRWxlbUlkU3RyfTsKICAgICAgICB2YXIgb2JqID0gZ2V0RWxlbWVudEJ5SWQocmVwbGFjZUVsZW1JZFN0cik7CiAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgICBpZiAob2JqLm5vZGVOYW1lID09ICJPQkpFQ1QiKSB7IAogICAgICAgICAgICAgICAgc3RvcmVkQWx0Q29udGVudCA9IGFic3RyYWN0QWx0Q29udGVudChvYmopOwogICAgICAgICAgICAgICAgc3RvcmVkQWx0Q29udGVudElkID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsgCiAgICAgICAgICAgICAgICBzdG9yZWRBbHRDb250ZW50ID0gb2JqOwogICAgICAgICAgICAgICAgc3RvcmVkQWx0Q29udGVudElkID0gcmVwbGFjZUVsZW1JZFN0cjsKICAgICAgICAgICAgfQogICAgICAgICAgICBhdHQuaWQgPSBFWFBSRVNTX0lOU1RBTExfSUQ7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXR0LndpZHRoID09IFVOREVGIHx8ICghKC8lJC8pLnRlc3QoYXR0LndpZHRoKSAmJiBwYXJzZUludChhdHQud2lkdGgsIDEwKSA8IDMxMCkpIHsKICAgICAgICAgICAgICAgIGF0dC53aWR0aCA9ICIzMTAiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIGF0dC5oZWlnaHQgPT0gVU5ERUYgfHwgKCEoLyUkLykudGVzdChhdHQuaGVpZ2h0KSAmJiBwYXJzZUludChhdHQuaGVpZ2h0LCAxMCkgPCAxMzcpKSB7CiAgICAgICAgICAgICAgICBhdHQuaGVpZ2h0ID0gIjEzNyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9jLnRpdGxlID0gZG9jLnRpdGxlLnNsaWNlKDAsIDQ3KSArICIgLSBGbGFzaCBQbGF5ZXIgSW5zdGFsbGF0aW9uIjsKICAgICAgICAgICAgdmFyIHB0ID0gdWEuaWUgJiYgdWEud2luID8gIkFjdGl2ZVgiIDogIlBsdWdJbiIsCiAgICAgICAgICAgICAgICBmdiA9ICJNTXJlZGlyZWN0VVJMPSIgKyB3aW4ubG9jYXRpb24udG9TdHJpbmcoKS5yZXBsYWNlKC8mL2csIiUyNiIpICsgIiZNTXBsYXllclR5cGU9IiArIHB0ICsgIiZNTWRvY3RpdGxlPSIgKyBkb2MudGl0bGU7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyLmZsYXNodmFycyAhPSBVTkRFRikgewogICAgICAgICAgICAgICAgcGFyLmZsYXNodmFycyArPSAiJiIgKyBmdjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHBhci5mbGFzaHZhcnMgPSBmdjsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh1YS5pZSAmJiB1YS53aW4gJiYgb2JqLnJlYWR5U3RhdGUgIT0gNCkgewogICAgICAgICAgICAgICAgdmFyIG5ld09iaiA9IGNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgICAgcmVwbGFjZUVsZW1JZFN0ciArPSAiU1dGT2JqZWN0TmV3IjsKICAgICAgICAgICAgICAgIG5ld09iai5zZXRBdHRyaWJ1dGUoImlkIiwgcmVwbGFjZUVsZW1JZFN0cik7CiAgICAgICAgICAgICAgICBvYmoucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobmV3T2JqLCBvYmopOyAKICAgICAgICAgICAgICAgIG9iai5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICAgICAgKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5yZWFkeVN0YXRlID09IDQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb2JqLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQob2JqKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYXJndW1lbnRzLmNhbGxlZSwgMTApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3JlYXRlU1dGKGF0dCwgcGFyLCByZXBsYWNlRWxlbUlkU3RyKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIAogICAgZnVuY3Rpb24gZGlzcGxheUFsdENvbnRlbnQob2JqKSB7CiAgICAgICAgaWYgKHVhLmllICYmIHVhLndpbiAmJiBvYmoucmVhZHlTdGF0ZSAhPSA0KSB7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGVsID0gY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIG9iai5wYXJlbnROb2RlLmluc2VydEJlZm9yZShlbCwgb2JqKTsgCiAgICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKGFic3RyYWN0QWx0Q29udGVudChvYmopLCBlbCk7CiAgICAgICAgICAgIG9iai5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICAoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIGlmIChvYmoucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgb2JqLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQob2JqKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYXJndW1lbnRzLmNhbGxlZSwgMTApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSgpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgb2JqLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKGFic3RyYWN0QWx0Q29udGVudChvYmopLCBvYmopOwogICAgICAgIH0KICAgIH0gCgogICAgZnVuY3Rpb24gYWJzdHJhY3RBbHRDb250ZW50KG9iaikgewogICAgICAgIHZhciBhYyA9IGNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGlmICh1YS53aW4gJiYgdWEuaWUpIHsKICAgICAgICAgICAgYWMuaW5uZXJIVE1MID0gb2JqLmlubmVySFRNTDsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXN0ZWRPYmogPSBvYmouZ2V0RWxlbWVudHNCeVRhZ05hbWUoT0JKRUNUKVswXTsKICAgICAgICAgICAgaWYgKG5lc3RlZE9iaikgewogICAgICAgICAgICAgICAgdmFyIGMgPSBuZXN0ZWRPYmouY2hpbGROb2RlczsKICAgICAgICAgICAgICAgIGlmIChjKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNsID0gYy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKGNbaV0ubm9kZVR5cGUgPT0gMSAmJiBjW2ldLm5vZGVOYW1lID09ICJQQVJBTSIpICYmICEoY1tpXS5ub2RlVHlwZSA9PSA4KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWMuYXBwZW5kQ2hpbGQoY1tpXS5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBhYzsKICAgIH0KICAgIAogICAgCiAgICBmdW5jdGlvbiBjcmVhdGVTV0YoYXR0T2JqLCBwYXJPYmosIGlkKSB7CiAgICAgICAgdmFyIHIsIGVsID0gZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgIGlmICh1YS53ayAmJiB1YS53ayA8IDMxMikgeyByZXR1cm4gcjsgfQogICAgICAgIGlmIChlbCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGF0dE9iai5pZCA9PSBVTkRFRikgeyAKICAgICAgICAgICAgICAgIGF0dE9iai5pZCA9IGlkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh1YS5pZSAmJiB1YS53aW4pIHsgCiAgICAgICAgICAgICAgICB2YXIgYXR0ID0gIiI7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGF0dE9iaikgewogICAgICAgICAgICAgICAgICAgIGlmIChhdHRPYmpbaV0gIT0gT2JqZWN0LnByb3RvdHlwZVtpXSkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkudG9Mb3dlckNhc2UoKSA9PSAiZGF0YSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhck9iai5tb3ZpZSA9IGF0dE9ialtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpLnRvTG93ZXJDYXNlKCkgPT0gInN0eWxlY2xhc3MiKSB7IAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ICs9ICcgY2xhc3M9IicgKyBhdHRPYmpbaV0gKyAnIic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaS50b0xvd2VyQ2FzZSgpICE9ICJjbGFzc2lkIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ICs9ICcgJyArIGkgKyAnPSInICsgYXR0T2JqW2ldICsgJyInOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHBhciA9ICIiOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaiBpbiBwYXJPYmopIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyT2JqW2pdICE9IE9iamVjdC5wcm90b3R5cGVbal0pIHsgCiAgICAgICAgICAgICAgICAgICAgICAgIHBhciArPSAnPHBhcmFtIG5hbWU9IicgKyBqICsgJyIgdmFsdWU9IicgKyBwYXJPYmpbal0gKyAnIiAvPic7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWwub3V0ZXJIVE1MID0gJzxvYmplY3QgY2xhc3NpZD0iY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwIicgKyBhdHQgKyAnPicgKyBwYXIgKyAnPC9vYmplY3Q+JzsKICAgICAgICAgICAgICAgIG9iaklkQXJyW29iaklkQXJyLmxlbmd0aF0gPSBhdHRPYmouaWQ7IAogICAgICAgICAgICAgICAgciA9IGdldEVsZW1lbnRCeUlkKGF0dE9iai5pZCk7ICAKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsgCiAgICAgICAgICAgICAgICB2YXIgbyA9IGNyZWF0ZUVsZW1lbnQoT0JKRUNUKTsKICAgICAgICAgICAgICAgIG8uc2V0QXR0cmlidXRlKCJ0eXBlIiwgRkxBU0hfTUlNRV9UWVBFKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIG0gaW4gYXR0T2JqKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGF0dE9ialttXSAhPSBPYmplY3QucHJvdG90eXBlW21dKSB7IAogICAgICAgICAgICAgICAgICAgICAgICBpZiAobS50b0xvd2VyQ2FzZSgpID09ICJzdHlsZWNsYXNzIikgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8uc2V0QXR0cmlidXRlKCJjbGFzcyIsIGF0dE9ialttXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobS50b0xvd2VyQ2FzZSgpICE9ICJjbGFzc2lkIikgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8uc2V0QXR0cmlidXRlKG0sIGF0dE9ialttXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHZhciBuIGluIHBhck9iaikgewogICAgICAgICAgICAgICAgICAgIGlmIChwYXJPYmpbbl0gIT0gT2JqZWN0LnByb3RvdHlwZVtuXSAmJiBuLnRvTG93ZXJDYXNlKCkgIT0gIm1vdmllIikgeyAKICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlT2JqUGFyYW0obywgbiwgcGFyT2JqW25dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChvLCBlbCk7CiAgICAgICAgICAgICAgICByID0gbzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcjsKICAgIH0KICAgIAogICAgZnVuY3Rpb24gY3JlYXRlT2JqUGFyYW0oZWwsIHBOYW1lLCBwVmFsdWUpIHsKICAgICAgICB2YXIgcCA9IGNyZWF0ZUVsZW1lbnQoInBhcmFtIik7CiAgICAgICAgcC5zZXRBdHRyaWJ1dGUoIm5hbWUiLCBwTmFtZSk7ICAKICAgICAgICBwLnNldEF0dHJpYnV0ZSgidmFsdWUiLCBwVmFsdWUpOwogICAgICAgIGVsLmFwcGVuZENoaWxkKHApOwogICAgfQogICAgCiAgICAKICAgIGZ1bmN0aW9uIHJlbW92ZVNXRihpZCkgewogICAgICAgIHZhciBvYmogPSBnZXRFbGVtZW50QnlJZChpZCk7CiAgICAgICAgaWYgKG9iaiAmJiBvYmoubm9kZU5hbWUgPT0gIk9CSkVDVCIpIHsKICAgICAgICAgICAgaWYgKHVhLmllICYmIHVhLndpbikgewogICAgICAgICAgICAgICAgb2JqLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgICAgICAoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBpZiAob2JqLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVPYmplY3RJbklFKGlkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoYXJndW1lbnRzLmNhbGxlZSwgMTApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBvYmoucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChvYmopOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICBmdW5jdGlvbiByZW1vdmVPYmplY3RJbklFKGlkKSB7CiAgICAgICAgdmFyIG9iaiA9IGdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9ialtpXSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgb2JqW2ldID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBvYmoucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChvYmopOwogICAgICAgIH0KICAgIH0KICAgIAogICAgCiAgICBmdW5jdGlvbiBnZXRFbGVtZW50QnlJZChpZCkgewogICAgICAgIHZhciBlbCA9IG51bGw7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZWwgPSBkb2MuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoZSkge30KICAgICAgICByZXR1cm4gZWw7CiAgICB9CiAgICAKICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQoZWwpIHsKICAgICAgICByZXR1cm4gZG9jLmNyZWF0ZUVsZW1lbnQoZWwpOwogICAgfQogICAgCiAgICAgIAogICAgZnVuY3Rpb24gYWRkTGlzdGVuZXIodGFyZ2V0LCBldmVudFR5cGUsIGZuKSB7CiAgICAgICAgdGFyZ2V0LmF0dGFjaEV2ZW50KGV2ZW50VHlwZSwgZm4pOwogICAgICAgIGxpc3RlbmVyc0FycltsaXN0ZW5lcnNBcnIubGVuZ3RoXSA9IFt0YXJnZXQsIGV2ZW50VHlwZSwgZm5dOwogICAgfQogICAgCiAgICAKICAgIGZ1bmN0aW9uIGhhc1BsYXllclZlcnNpb24ocnYpIHsKICAgICAgICB2YXIgcHYgPSB1YS5wdiwgdiA9IHJ2LnNwbGl0KCIuIik7CiAgICAgICAgdlswXSA9IHBhcnNlSW50KHZbMF0sIDEwKTsKICAgICAgICB2WzFdID0gcGFyc2VJbnQodlsxXSwgMTApIHx8IDA7IAogICAgICAgIHZbMl0gPSBwYXJzZUludCh2WzJdLCAxMCkgfHwgMDsKICAgICAgICByZXR1cm4gKHB2WzBdID4gdlswXSB8fCAocHZbMF0gPT0gdlswXSAmJiBwdlsxXSA+IHZbMV0pIHx8IChwdlswXSA9PSB2WzBdICYmIHB2WzFdID09IHZbMV0gJiYgcHZbMl0gPj0gdlsyXSkpID8gdHJ1ZSA6IGZhbHNlOwogICAgfQogICAgCiAgICAgIAogICAgZnVuY3Rpb24gY3JlYXRlQ1NTKHNlbCwgZGVjbCwgbWVkaWEsIG5ld1N0eWxlKSB7CiAgICAgICAgaWYgKHVhLmllICYmIHVhLm1hYykgeyByZXR1cm47IH0KICAgICAgICB2YXIgaCA9IGRvYy5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdOwogICAgICAgIGlmICghaCkgeyByZXR1cm47IH0gCiAgICAgICAgdmFyIG0gPSAobWVkaWEgJiYgdHlwZW9mIG1lZGlhID09ICJzdHJpbmciKSA/IG1lZGlhIDogInNjcmVlbiI7CiAgICAgICAgaWYgKG5ld1N0eWxlKSB7CiAgICAgICAgICAgIGR5bmFtaWNTdHlsZXNoZWV0ID0gbnVsbDsKICAgICAgICAgICAgZHluYW1pY1N0eWxlc2hlZXRNZWRpYSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICghZHluYW1pY1N0eWxlc2hlZXQgfHwgZHluYW1pY1N0eWxlc2hlZXRNZWRpYSAhPSBtKSB7IAogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHMgPSBjcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICBzLnNldEF0dHJpYnV0ZSgidHlwZSIsICJ0ZXh0L2NzcyIpOwogICAgICAgICAgICBzLnNldEF0dHJpYnV0ZSgibWVkaWEiLCBtKTsKICAgICAgICAgICAgZHluYW1pY1N0eWxlc2hlZXQgPSBoLmFwcGVuZENoaWxkKHMpOwogICAgICAgICAgICBpZiAodWEuaWUgJiYgdWEud2luICYmIHR5cGVvZiBkb2Muc3R5bGVTaGVldHMgIT0gVU5ERUYgJiYgZG9jLnN0eWxlU2hlZXRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGR5bmFtaWNTdHlsZXNoZWV0ID0gZG9jLnN0eWxlU2hlZXRzW2RvYy5zdHlsZVNoZWV0cy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkeW5hbWljU3R5bGVzaGVldE1lZGlhID0gbTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHVhLmllICYmIHVhLndpbikgewogICAgICAgICAgICBpZiAoZHluYW1pY1N0eWxlc2hlZXQgJiYgdHlwZW9mIGR5bmFtaWNTdHlsZXNoZWV0LmFkZFJ1bGUgPT0gT0JKRUNUKSB7CiAgICAgICAgICAgICAgICBkeW5hbWljU3R5bGVzaGVldC5hZGRSdWxlKHNlbCwgZGVjbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGlmIChkeW5hbWljU3R5bGVzaGVldCAmJiB0eXBlb2YgZG9jLmNyZWF0ZVRleHROb2RlICE9IFVOREVGKSB7CiAgICAgICAgICAgICAgICBkeW5hbWljU3R5bGVzaGVldC5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoc2VsICsgIiB7IiArIGRlY2wgKyAifSIpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgZnVuY3Rpb24gc2V0VmlzaWJpbGl0eShpZCwgaXNWaXNpYmxlKSB7CiAgICAgICAgaWYgKCFhdXRvSGlkZVNob3cpIHsgcmV0dXJuOyB9CiAgICAgICAgdmFyIHYgPSBpc1Zpc2libGUgPyAidmlzaWJsZSIgOiAiaGlkZGVuIjsKICAgICAgICBpZiAoaXNEb21Mb2FkZWQgJiYgZ2V0RWxlbWVudEJ5SWQoaWQpKSB7CiAgICAgICAgICAgIGdldEVsZW1lbnRCeUlkKGlkKS5zdHlsZS52aXNpYmlsaXR5ID0gdjsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGNyZWF0ZUNTUygiIyIgKyBpZCwgInZpc2liaWxpdHk6IiArIHYpOwogICAgICAgIH0KICAgIH0KCiAgICAKICAgIGZ1bmN0aW9uIHVybEVuY29kZUlmTmVjZXNzYXJ5KHMpIHsKICAgICAgICB2YXIgcmVnZXggPSAvW1xcXCI8PlwuO10vOwogICAgICAgIHZhciBoYXNCYWRDaGFycyA9IHJlZ2V4LmV4ZWMocykgIT0gbnVsbDsKICAgICAgICByZXR1cm4gaGFzQmFkQ2hhcnMgJiYgdHlwZW9mIGVuY29kZVVSSUNvbXBvbmVudCAhPSBVTkRFRiA/IGVuY29kZVVSSUNvbXBvbmVudChzKSA6IHM7CiAgICB9CiAgICAKICAgIAogICAgdmFyIGNsZWFudXAgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodWEuaWUgJiYgdWEud2luKSB7CiAgICAgICAgICAgIHdpbmRvdy5hdHRhY2hFdmVudCgib251bmxvYWQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdmFyIGxsID0gbGlzdGVuZXJzQXJyLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyc0FycltpXVswXS5kZXRhY2hFdmVudChsaXN0ZW5lcnNBcnJbaV1bMV0sIGxpc3RlbmVyc0FycltpXVsyXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciBpbCA9IG9iaklkQXJyLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgaWw7IGorKykgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZVNXRihvYmpJZEFycltqXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAodmFyIGsgaW4gdWEpIHsKICAgICAgICAgICAgICAgICAgICB1YVtrXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1YSA9IG51bGw7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBsIGluIHN3Zm9iamVjdCkgewogICAgICAgICAgICAgICAgICAgIHN3Zm9iamVjdFtsXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzd2ZvYmplY3QgPSBudWxsOwogICAgICAgICAgICAgICAgd2luZG93LmRldGFjaEV2ZW50KCdvbnVubG9hZCcsIGFyZ3VtZW50cy5jYWxsZWUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KCk7CiAgICAKICAgIHJldHVybiB7CiAgICAgICAgIAogICAgICAgIHJlZ2lzdGVyT2JqZWN0OiBmdW5jdGlvbihvYmplY3RJZFN0ciwgc3dmVmVyc2lvblN0ciwgeGlTd2ZVcmxTdHIsIGNhbGxiYWNrRm4pIHsKICAgICAgICAgICAgaWYgKHVhLnczICYmIG9iamVjdElkU3RyICYmIHN3ZlZlcnNpb25TdHIpIHsKICAgICAgICAgICAgICAgIHZhciByZWdPYmogPSB7fTsKICAgICAgICAgICAgICAgIHJlZ09iai5pZCA9IG9iamVjdElkU3RyOwogICAgICAgICAgICAgICAgcmVnT2JqLnN3ZlZlcnNpb24gPSBzd2ZWZXJzaW9uU3RyOwogICAgICAgICAgICAgICAgcmVnT2JqLmV4cHJlc3NJbnN0YWxsID0geGlTd2ZVcmxTdHI7CiAgICAgICAgICAgICAgICByZWdPYmouY2FsbGJhY2tGbiA9IGNhbGxiYWNrRm47CiAgICAgICAgICAgICAgICByZWdPYmpBcnJbcmVnT2JqQXJyLmxlbmd0aF0gPSByZWdPYmo7CiAgICAgICAgICAgICAgICBzZXRWaXNpYmlsaXR5KG9iamVjdElkU3RyLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoY2FsbGJhY2tGbikgewogICAgICAgICAgICAgICAgY2FsbGJhY2tGbih7c3VjY2VzczpmYWxzZSwgaWQ6b2JqZWN0SWRTdHJ9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgZ2V0T2JqZWN0QnlJZDogZnVuY3Rpb24ob2JqZWN0SWRTdHIpIHsKICAgICAgICAgICAgaWYgKHVhLnczKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0T2JqZWN0QnlJZChvYmplY3RJZFN0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIGVtYmVkU1dGOiBmdW5jdGlvbihzd2ZVcmxTdHIsIHJlcGxhY2VFbGVtSWRTdHIsIHdpZHRoU3RyLCBoZWlnaHRTdHIsIHN3ZlZlcnNpb25TdHIsIHhpU3dmVXJsU3RyLCBmbGFzaHZhcnNPYmosIHBhck9iaiwgYXR0T2JqLCBjYWxsYmFja0ZuKSB7CiAgICAgICAgICAgIHZhciBjYWxsYmFja09iaiA9IHtzdWNjZXNzOmZhbHNlLCBpZDpyZXBsYWNlRWxlbUlkU3RyfTsKICAgICAgICAgICAgaWYgKHVhLnczICYmICEodWEud2sgJiYgdWEud2sgPCAzMTIpICYmIHN3ZlVybFN0ciAmJiByZXBsYWNlRWxlbUlkU3RyICYmIHdpZHRoU3RyICYmIGhlaWdodFN0ciAmJiBzd2ZWZXJzaW9uU3RyKSB7CiAgICAgICAgICAgICAgICBzZXRWaXNpYmlsaXR5KHJlcGxhY2VFbGVtSWRTdHIsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGFkZERvbUxvYWRFdmVudChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB3aWR0aFN0ciArPSAiIjsgCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0U3RyICs9ICIiOwogICAgICAgICAgICAgICAgICAgIHZhciBhdHQgPSB7fTsKICAgICAgICAgICAgICAgICAgICBpZiAoYXR0T2JqICYmIHR5cGVvZiBhdHRPYmogPT09IE9CSkVDVCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGF0dE9iaikgeyAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dFtpXSA9IGF0dE9ialtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBhdHQuZGF0YSA9IHN3ZlVybFN0cjsKICAgICAgICAgICAgICAgICAgICBhdHQud2lkdGggPSB3aWR0aFN0cjsKICAgICAgICAgICAgICAgICAgICBhdHQuaGVpZ2h0ID0gaGVpZ2h0U3RyOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXIgPSB7fTsgCiAgICAgICAgICAgICAgICAgICAgaWYgKHBhck9iaiAmJiB0eXBlb2YgcGFyT2JqID09PSBPQkpFQ1QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiBpbiBwYXJPYmopIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJbal0gPSBwYXJPYmpbal07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGZsYXNodmFyc09iaiAmJiB0eXBlb2YgZmxhc2h2YXJzT2JqID09PSBPQkpFQ1QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayBpbiBmbGFzaHZhcnNPYmopIHsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhci5mbGFzaHZhcnMgIT0gVU5ERUYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXIuZmxhc2h2YXJzICs9ICImIiArIGsgKyAiPSIgKyBmbGFzaHZhcnNPYmpba107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXIuZmxhc2h2YXJzID0gayArICI9IiArIGZsYXNodmFyc09ialtrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaGFzUGxheWVyVmVyc2lvbihzd2ZWZXJzaW9uU3RyKSkgeyAKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9iaiA9IGNyZWF0ZVNXRihhdHQsIHBhciwgcmVwbGFjZUVsZW1JZFN0cik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHQuaWQgPT0gcmVwbGFjZUVsZW1JZFN0cikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VmlzaWJpbGl0eShyZXBsYWNlRWxlbUlkU3RyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja09iai5zdWNjZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tPYmoucmVmID0gb2JqOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh4aVN3ZlVybFN0ciAmJiBjYW5FeHByZXNzSW5zdGFsbCgpKSB7IAogICAgICAgICAgICAgICAgICAgICAgICBhdHQuZGF0YSA9IHhpU3dmVXJsU3RyOwogICAgICAgICAgICAgICAgICAgICAgICBzaG93RXhwcmVzc0luc3RhbGwoYXR0LCBwYXIsIHJlcGxhY2VFbGVtSWRTdHIsIGNhbGxiYWNrRm4pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgeyAKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VmlzaWJpbGl0eShyZXBsYWNlRWxlbUlkU3RyLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrRm4pIHsgY2FsbGJhY2tGbihjYWxsYmFja09iaik7IH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGNhbGxiYWNrRm4pIHsgY2FsbGJhY2tGbihjYWxsYmFja09iaik7IH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIHN3aXRjaE9mZkF1dG9IaWRlU2hvdzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGF1dG9IaWRlU2hvdyA9IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgdWE6IHVhLAogICAgICAgIAogICAgICAgIGdldEZsYXNoUGxheWVyVmVyc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB7IG1ham9yOnVhLnB2WzBdLCBtaW5vcjp1YS5wdlsxXSwgcmVsZWFzZTp1YS5wdlsyXSB9OwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgaGFzRmxhc2hQbGF5ZXJWZXJzaW9uOiBoYXNQbGF5ZXJWZXJzaW9uLAogICAgICAgIAogICAgICAgIGNyZWF0ZVNXRjogZnVuY3Rpb24oYXR0T2JqLCBwYXJPYmosIHJlcGxhY2VFbGVtSWRTdHIpIHsKICAgICAgICAgICAgaWYgKHVhLnczKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlU1dGKGF0dE9iaiwgcGFyT2JqLCByZXBsYWNlRWxlbUlkU3RyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIHNob3dFeHByZXNzSW5zdGFsbDogZnVuY3Rpb24oYXR0LCBwYXIsIHJlcGxhY2VFbGVtSWRTdHIsIGNhbGxiYWNrRm4pIHsKICAgICAgICAgICAgaWYgKHVhLnczICYmIGNhbkV4cHJlc3NJbnN0YWxsKCkpIHsKICAgICAgICAgICAgICAgIHNob3dFeHByZXNzSW5zdGFsbChhdHQsIHBhciwgcmVwbGFjZUVsZW1JZFN0ciwgY2FsbGJhY2tGbik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIHJlbW92ZVNXRjogZnVuY3Rpb24ob2JqRWxlbUlkU3RyKSB7CiAgICAgICAgICAgIGlmICh1YS53MykgewogICAgICAgICAgICAgICAgcmVtb3ZlU1dGKG9iakVsZW1JZFN0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIGNyZWF0ZUNTUzogZnVuY3Rpb24oc2VsU3RyLCBkZWNsU3RyLCBtZWRpYVN0ciwgbmV3U3R5bGVCb29sZWFuKSB7CiAgICAgICAgICAgIGlmICh1YS53MykgewogICAgICAgICAgICAgICAgY3JlYXRlQ1NTKHNlbFN0ciwgZGVjbFN0ciwgbWVkaWFTdHIsIG5ld1N0eWxlQm9vbGVhbik7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIAogICAgICAgIGFkZERvbUxvYWRFdmVudDogYWRkRG9tTG9hZEV2ZW50LAogICAgICAgIAogICAgICAgIGFkZExvYWRFdmVudDogYWRkTG9hZEV2ZW50LAogICAgICAgIAogICAgICAgIGdldFF1ZXJ5UGFyYW1WYWx1ZTogZnVuY3Rpb24ocGFyYW0pIHsKICAgICAgICAgICAgdmFyIHEgPSBkb2MubG9jYXRpb24uc2VhcmNoIHx8IGRvYy5sb2NhdGlvbi5oYXNoOwogICAgICAgICAgICBpZiAocSkgewogICAgICAgICAgICAgICAgaWYgKC9cPy8udGVzdChxKSkgeyBxID0gcS5zcGxpdCgiPyIpWzFdOyB9IAogICAgICAgICAgICAgICAgaWYgKHBhcmFtID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXJsRW5jb2RlSWZOZWNlc3NhcnkocSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgcGFpcnMgPSBxLnNwbGl0KCImIik7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhaXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhaXJzW2ldLnN1YnN0cmluZygwLCBwYWlyc1tpXS5pbmRleE9mKCI9IikpID09IHBhcmFtKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmxFbmNvZGVJZk5lY2Vzc2FyeShwYWlyc1tpXS5zdWJzdHJpbmcoKHBhaXJzW2ldLmluZGV4T2YoIj0iKSArIDEpKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIAogICAgICAgIGV4cHJlc3NJbnN0YWxsQ2FsbGJhY2s6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoaXNFeHByZXNzSW5zdGFsbEFjdGl2ZSkgewogICAgICAgICAgICAgICAgdmFyIG9iaiA9IGdldEVsZW1lbnRCeUlkKEVYUFJFU1NfSU5TVEFMTF9JRCk7CiAgICAgICAgICAgICAgICBpZiAob2JqICYmIHN0b3JlZEFsdENvbnRlbnQpIHsKICAgICAgICAgICAgICAgICAgICBvYmoucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoc3RvcmVkQWx0Q29udGVudCwgb2JqKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcmVkQWx0Q29udGVudElkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFZpc2liaWxpdHkoc3RvcmVkQWx0Q29udGVudElkLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVhLmllICYmIHVhLndpbikgeyBzdG9yZWRBbHRDb250ZW50LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOyB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdG9yZWRDYWxsYmFja0ZuKSB7IHN0b3JlZENhbGxiYWNrRm4oc3RvcmVkQ2FsbGJhY2tPYmopOyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpc0V4cHJlc3NJbnN0YWxsQWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgIH0gCiAgICAgICAgfQogICAgfTsKfSgpOwoKRXh0LkZsYXNoQ29tcG9uZW50ID0gRXh0LmV4dGVuZChFeHQuQm94Q29tcG9uZW50LCB7CiAgICAKICAgIGZsYXNoVmVyc2lvbiA6ICc5LjAuMTE1JywKCiAgICAKICAgIGJhY2tncm91bmRDb2xvcjogJyNmZmZmZmYnLAoKICAgIAogICAgd21vZGU6ICdvcGFxdWUnLAoKICAgIAogICAgZmxhc2hWYXJzOiB1bmRlZmluZWQsCgogICAgCiAgICBmbGFzaFBhcmFtczogdW5kZWZpbmVkLAoKICAgIAogICAgdXJsOiB1bmRlZmluZWQsCiAgICBzd2ZJZCA6IHVuZGVmaW5lZCwKICAgIHN3ZldpZHRoOiAnMTAwJScsCiAgICBzd2ZIZWlnaHQ6ICcxMDAlJywKCiAgICAKICAgIGV4cHJlc3NJbnN0YWxsOiBmYWxzZSwKCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuRmxhc2hDb21wb25lbnQuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CgogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2luaXRpYWxpemUnCiAgICAgICAgKTsKICAgIH0sCgogICAgb25SZW5kZXIgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5GbGFzaENvbXBvbmVudC5zdXBlcmNsYXNzLm9uUmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIHZhciBwYXJhbXMgPSBFeHQuYXBwbHkoewogICAgICAgICAgICBhbGxvd1NjcmlwdEFjY2VzczogJ2Fsd2F5cycsCiAgICAgICAgICAgIGJnY29sb3I6IHRoaXMuYmFja2dyb3VuZENvbG9yLAogICAgICAgICAgICB3bW9kZTogdGhpcy53bW9kZQogICAgICAgIH0sIHRoaXMuZmxhc2hQYXJhbXMpLCB2YXJzID0gRXh0LmFwcGx5KHsKICAgICAgICAgICAgYWxsb3dlZERvbWFpbjogZG9jdW1lbnQubG9jYXRpb24uaG9zdG5hbWUsCiAgICAgICAgICAgIFlVSVN3ZklkOiB0aGlzLmdldElkKCksCiAgICAgICAgICAgIFlVSUJyaWRnZUNhbGxiYWNrOiAnRXh0LkZsYXNoRXZlbnRQcm94eS5vbkV2ZW50JwogICAgICAgIH0sIHRoaXMuZmxhc2hWYXJzKTsKCiAgICAgICAgbmV3IHN3Zm9iamVjdC5lbWJlZFNXRih0aGlzLnVybCwgdGhpcy5pZCwgdGhpcy5zd2ZXaWR0aCwgdGhpcy5zd2ZIZWlnaHQsIHRoaXMuZmxhc2hWZXJzaW9uLAogICAgICAgICAgICB0aGlzLmV4cHJlc3NJbnN0YWxsID8gRXh0LkZsYXNoQ29tcG9uZW50LkVYUFJFU1NfSU5TVEFMTF9VUkwgOiB1bmRlZmluZWQsIHZhcnMsIHBhcmFtcyk7CgogICAgICAgIHRoaXMuc3dmID0gRXh0LmdldERvbSh0aGlzLmlkKTsKICAgICAgICB0aGlzLmVsID0gRXh0LmdldCh0aGlzLnN3Zik7CiAgICB9LAoKICAgIGdldFN3ZklkIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5zd2ZJZCB8fCAodGhpcy5zd2ZJZCA9ICJleHRzd2YiICsgKCsrRXh0LkNvbXBvbmVudC5BVVRPX0lEKSk7CiAgICB9LAoKICAgIGdldElkIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5pZCB8fCAodGhpcy5pZCA9ICJleHRmbGFzaGNtcCIgKyAoKytFeHQuQ29tcG9uZW50LkFVVE9fSUQpKTsKICAgIH0sCgogICAgb25GbGFzaEV2ZW50IDogZnVuY3Rpb24oZSl7CiAgICAgICAgc3dpdGNoKGUudHlwZSl7CiAgICAgICAgICAgIGNhc2UgInN3ZlJlYWR5IjoKICAgICAgICAgICAgICAgIHRoaXMuaW5pdFN3ZigpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJsb2ciOgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBlLmNvbXBvbmVudCA9IHRoaXM7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoZS50eXBlLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvZXZlbnQkLywgJycpLCBlKTsKICAgIH0sCgogICAgaW5pdFN3ZiA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5vblN3ZlJlYWR5KCEhdGhpcy5pc0luaXRpYWxpemVkKTsKICAgICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdpbml0aWFsaXplJywgdGhpcyk7CiAgICB9LAoKICAgIGJlZm9yZURlc3Ryb3k6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHN3Zm9iamVjdC5yZW1vdmVTV0YodGhpcy5zd2YuaWQpOwogICAgICAgIH0KICAgICAgICBFeHQuRmxhc2hDb21wb25lbnQuc3VwZXJjbGFzcy5iZWZvcmVEZXN0cm95LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIG9uU3dmUmVhZHkgOiBFeHQuZW1wdHlGbgp9KTsKCgpFeHQuRmxhc2hDb21wb25lbnQuRVhQUkVTU19JTlNUQUxMX1VSTCA9ICdodHRwOi8nICsgJy9zd2ZvYmplY3QuZ29vZ2xlY29kZS5jb20vc3ZuL3RydW5rL3N3Zm9iamVjdC9leHByZXNzSW5zdGFsbC5zd2YnOwoKRXh0LnJlZygnZmxhc2gnLCBFeHQuRmxhc2hDb21wb25lbnQpOwpFeHQuRmxhc2hFdmVudFByb3h5ID0gewogICAgb25FdmVudCA6IGZ1bmN0aW9uKGlkLCBlKXsKICAgICAgICB2YXIgZnAgPSBFeHQuZ2V0Q21wKGlkKTsKICAgICAgICBpZihmcCl7CiAgICAgICAgICAgIGZwLm9uRmxhc2hFdmVudChlKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgYXJndW1lbnRzLmNhbGxlZS5kZWZlcigxMCwgdGhpcywgW2lkLCBlXSk7CiAgICAgICAgfQogICAgfQp9OwoKIEV4dC5jaGFydC5DaGFydCA9IEV4dC5leHRlbmQoRXh0LkZsYXNoQ29tcG9uZW50LCB7CiAgICByZWZyZXNoQnVmZmVyOiAxMDAsCgogICAgCgogICAgCiAgICBjaGFydFN0eWxlOiB7CiAgICAgICAgcGFkZGluZzogMTAsCiAgICAgICAgYW5pbWF0aW9uRW5hYmxlZDogdHJ1ZSwKICAgICAgICBmb250OiB7CiAgICAgICAgICAgIG5hbWU6ICdUYWhvbWEnLAogICAgICAgICAgICBjb2xvcjogMHg0NDQ0NDQsCiAgICAgICAgICAgIHNpemU6IDExCiAgICAgICAgfSwKICAgICAgICBkYXRhVGlwOiB7CiAgICAgICAgICAgIHBhZGRpbmc6IDUsCiAgICAgICAgICAgIGJvcmRlcjogewogICAgICAgICAgICAgICAgY29sb3I6IDB4OTliYmU4LAogICAgICAgICAgICAgICAgc2l6ZToxCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHsKICAgICAgICAgICAgICAgIGNvbG9yOiAweERBRTdGNiwKICAgICAgICAgICAgICAgIGFscGhhOiAuOQogICAgICAgICAgICB9LAogICAgICAgICAgICBmb250OiB7CiAgICAgICAgICAgICAgICBuYW1lOiAnVGFob21hJywKICAgICAgICAgICAgICAgIGNvbG9yOiAweDE1NDI4QiwKICAgICAgICAgICAgICAgIHNpemU6IDEwLAogICAgICAgICAgICAgICAgYm9sZDogdHJ1ZQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKCiAgICAKICAgIGV4dHJhU3R5bGU6IG51bGwsCgogICAgCiAgICBzZXJpZXNTdHlsZXM6IG51bGwsCgogICAgCiAgICBkaXNhYmxlQ2FjaGluZzogRXh0LmlzSUUgfHwgRXh0LmlzT3BlcmEsCiAgICBkaXNhYmxlQ2FjaGVQYXJhbTogJ19kYycsCgogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmNoYXJ0LkNoYXJ0LnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIGlmKCF0aGlzLnVybCl7CiAgICAgICAgICAgIHRoaXMudXJsID0gRXh0LmNoYXJ0LkNoYXJ0LkNIQVJUX1VSTDsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5kaXNhYmxlQ2FjaGluZyl7CiAgICAgICAgICAgIHRoaXMudXJsID0gRXh0LnVybEFwcGVuZCh0aGlzLnVybCwgU3RyaW5nLmZvcm1hdCgnezB9PXsxfScsIHRoaXMuZGlzYWJsZUNhY2hlUGFyYW0sIG5ldyBEYXRlKCkuZ2V0VGltZSgpKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAnaXRlbW1vdXNlb3ZlcicsCiAgICAgICAgICAgICdpdGVtbW91c2VvdXQnLAogICAgICAgICAgICAnaXRlbWNsaWNrJywKICAgICAgICAgICAgJ2l0ZW1kb3VibGVjbGljaycsCiAgICAgICAgICAgICdpdGVtZHJhZ3N0YXJ0JywKICAgICAgICAgICAgJ2l0ZW1kcmFnJywKICAgICAgICAgICAgJ2l0ZW1kcmFnZW5kJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVyZWZyZXNoJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdyZWZyZXNoJwogICAgICAgICk7CiAgICAgICAgdGhpcy5zdG9yZSA9IEV4dC5TdG9yZU1nci5sb29rdXAodGhpcy5zdG9yZSk7CiAgICB9LAoKICAgIAogICAgIHNldFN0eWxlOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgICAgIHRoaXMuc3dmLnNldFN0eWxlKG5hbWUsIEV4dC5lbmNvZGUodmFsdWUpKTsKICAgICB9LAoKICAgIAogICAgc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewogICAgICAgIHRoaXMuc3dmLnNldFN0eWxlcyhFeHQuZW5jb2RlKHN0eWxlcykpOwogICAgfSwKCiAgICAKICAgIHNldFNlcmllc1N0eWxlczogZnVuY3Rpb24oc3R5bGVzKXsKICAgICAgICB0aGlzLnNlcmllc1N0eWxlcyA9IHN0eWxlczsKICAgICAgICB2YXIgcyA9IFtdOwogICAgICAgIEV4dC5lYWNoKHN0eWxlcywgZnVuY3Rpb24oc3R5bGUpewogICAgICAgICAgICBzLnB1c2goRXh0LmVuY29kZShzdHlsZSkpOwogICAgICAgIH0pOwogICAgICAgIHRoaXMuc3dmLnNldFNlcmllc1N0eWxlcyhzKTsKICAgIH0sCgogICAgc2V0Q2F0ZWdvcnlOYW1lcyA6IGZ1bmN0aW9uKG5hbWVzKXsKICAgICAgICB0aGlzLnN3Zi5zZXRDYXRlZ29yeU5hbWVzKG5hbWVzKTsKICAgIH0sCgogICAgc2V0TGVnZW5kUmVuZGVyZXIgOiBmdW5jdGlvbihmbiwgc2NvcGUpewogICAgICAgIHZhciBjaGFydCA9IHRoaXM7CiAgICAgICAgc2NvcGUgPSBzY29wZSB8fCBjaGFydDsKICAgICAgICBjaGFydC5yZW1vdmVGblByb3h5KGNoYXJ0LmxlZ2VuZEZuTmFtZSk7CiAgICAgICAgY2hhcnQubGVnZW5kRm5OYW1lID0gY2hhcnQuY3JlYXRlRm5Qcm94eShmdW5jdGlvbihuYW1lKXsKICAgICAgICAgICAgcmV0dXJuIGZuLmNhbGwoc2NvcGUsIG5hbWUpOwogICAgICAgIH0pOwogICAgICAgIGNoYXJ0LnN3Zi5zZXRMZWdlbmRMYWJlbEZ1bmN0aW9uKGNoYXJ0LmxlZ2VuZEZuTmFtZSk7CiAgICB9LAoKICAgIHNldFRpcFJlbmRlcmVyIDogZnVuY3Rpb24oZm4sIHNjb3BlKXsKICAgICAgICB2YXIgY2hhcnQgPSB0aGlzOwogICAgICAgIHNjb3BlID0gc2NvcGUgfHwgY2hhcnQ7CiAgICAgICAgY2hhcnQucmVtb3ZlRm5Qcm94eShjaGFydC50aXBGbk5hbWUpOwogICAgICAgIGNoYXJ0LnRpcEZuTmFtZSA9IGNoYXJ0LmNyZWF0ZUZuUHJveHkoZnVuY3Rpb24oaXRlbSwgaW5kZXgsIHNlcmllcyl7CiAgICAgICAgICAgIHZhciByZWNvcmQgPSBjaGFydC5zdG9yZS5nZXRBdChpbmRleCk7CiAgICAgICAgICAgIHJldHVybiBmbi5jYWxsKHNjb3BlLCBjaGFydCwgcmVjb3JkLCBpbmRleCwgc2VyaWVzKTsKICAgICAgICB9KTsKICAgICAgICBjaGFydC5zd2Yuc2V0RGF0YVRpcEZ1bmN0aW9uKGNoYXJ0LnRpcEZuTmFtZSk7CiAgICB9LAoKICAgIHNldFNlcmllcyA6IGZ1bmN0aW9uKHNlcmllcyl7CiAgICAgICAgdGhpcy5zZXJpZXMgPSBzZXJpZXM7CiAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICB9LAoKICAgIAogICAgYmluZFN0b3JlIDogZnVuY3Rpb24oc3RvcmUsIGluaXRpYWwpewogICAgICAgIGlmKCFpbml0aWFsICYmIHRoaXMuc3RvcmUpewogICAgICAgICAgICBpZihzdG9yZSAhPT0gdGhpcy5zdG9yZSAmJiB0aGlzLnN0b3JlLmF1dG9EZXN0cm95KXsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUuZGVzdHJveSgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oImRhdGFjaGFuZ2VkIiwgdGhpcy5yZWZyZXNoLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oImFkZCIsIHRoaXMuZGVsYXlSZWZyZXNoLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oInJlbW92ZSIsIHRoaXMuZGVsYXlSZWZyZXNoLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oInVwZGF0ZSIsIHRoaXMuZGVsYXlSZWZyZXNoLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oImNsZWFyIiwgdGhpcy5yZWZyZXNoLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZihzdG9yZSl7CiAgICAgICAgICAgIHN0b3JlID0gRXh0LlN0b3JlTWdyLmxvb2t1cChzdG9yZSk7CiAgICAgICAgICAgIHN0b3JlLm9uKHsKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgZGF0YWNoYW5nZWQ6IHRoaXMucmVmcmVzaCwKICAgICAgICAgICAgICAgIGFkZDogdGhpcy5kZWxheVJlZnJlc2gsCiAgICAgICAgICAgICAgICByZW1vdmU6IHRoaXMuZGVsYXlSZWZyZXNoLAogICAgICAgICAgICAgICAgdXBkYXRlOiB0aGlzLmRlbGF5UmVmcmVzaCwKICAgICAgICAgICAgICAgIGNsZWFyOiB0aGlzLnJlZnJlc2gKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZTsKICAgICAgICBpZihzdG9yZSAmJiAhaW5pdGlhbCl7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgICAgIH0KICAgIH0sCgogICAgb25Td2ZSZWFkeSA6IGZ1bmN0aW9uKGlzUmVzZXQpewogICAgICAgIEV4dC5jaGFydC5DaGFydC5zdXBlcmNsYXNzLm9uU3dmUmVhZHkuY2FsbCh0aGlzLCBpc1Jlc2V0KTsKICAgICAgICB2YXIgcmVmOwogICAgICAgIHRoaXMuc3dmLnNldFR5cGUodGhpcy50eXBlKTsKCiAgICAgICAgaWYodGhpcy5jaGFydFN0eWxlKXsKICAgICAgICAgICAgdGhpcy5zZXRTdHlsZXMoRXh0LmFwcGx5KHt9LCB0aGlzLmV4dHJhU3R5bGUsIHRoaXMuY2hhcnRTdHlsZSkpOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5jYXRlZ29yeU5hbWVzKXsKICAgICAgICAgICAgdGhpcy5zZXRDYXRlZ29yeU5hbWVzKHRoaXMuY2F0ZWdvcnlOYW1lcyk7CiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLnRpcFJlbmRlcmVyKXsKICAgICAgICAgICAgcmVmID0gdGhpcy5nZXRGdW5jdGlvblJlZih0aGlzLnRpcFJlbmRlcmVyKTsKICAgICAgICAgICAgdGhpcy5zZXRUaXBSZW5kZXJlcihyZWYuZm4sIHJlZi5zY29wZSk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMubGVnZW5kUmVuZGVyZXIpewogICAgICAgICAgICByZWYgPSB0aGlzLmdldEZ1bmN0aW9uUmVmKHRoaXMubGVnZW5kUmVuZGVyZXIpOwogICAgICAgICAgICB0aGlzLnNldExlZ2VuZFJlbmRlcmVyKHJlZi5mbiwgcmVmLnNjb3BlKTsKICAgICAgICB9CiAgICAgICAgaWYoIWlzUmVzZXQpewogICAgICAgICAgICB0aGlzLmJpbmRTdG9yZSh0aGlzLnN0b3JlLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5yZWZyZXNoLmRlZmVyKDEwLCB0aGlzKTsKICAgIH0sCgogICAgZGVsYXlSZWZyZXNoIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5yZWZyZXNoVGFzayl7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaFRhc2sgPSBuZXcgRXh0LnV0aWwuRGVsYXllZFRhc2sodGhpcy5yZWZyZXNoLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5yZWZyZXNoVGFzay5kZWxheSh0aGlzLnJlZnJlc2hCdWZmZXIpOwogICAgfSwKCiAgICByZWZyZXNoIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3JlcmVmcmVzaCcsIHRoaXMpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHZhciBzdHlsZUNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBkYXRhID0gW10sIHJzID0gdGhpcy5zdG9yZS5kYXRhLml0ZW1zOwogICAgICAgICAgICBmb3IodmFyIGogPSAwLCBsZW4gPSBycy5sZW5ndGg7IGogPCBsZW47IGorKyl7CiAgICAgICAgICAgICAgICBkYXRhW2pdID0gcnNbal0uZGF0YTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBkYXRhUHJvdmlkZXIgPSBbXTsKICAgICAgICAgICAgdmFyIHNlcmllc0NvdW50ID0gMDsKICAgICAgICAgICAgdmFyIGN1cnJlbnRTZXJpZXMgPSBudWxsOwogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIGlmKHRoaXMuc2VyaWVzKXsKICAgICAgICAgICAgICAgIHNlcmllc0NvdW50ID0gdGhpcy5zZXJpZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgc2VyaWVzQ291bnQ7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFNlcmllcyA9IHRoaXMuc2VyaWVzW2ldOwogICAgICAgICAgICAgICAgICAgIHZhciBjbG9uZWRTZXJpZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIHByb3AgaW4gY3VycmVudFNlcmllcyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHByb3AgPT0gInN0eWxlIiAmJiBjdXJyZW50U2VyaWVzLnN0eWxlICE9PSBudWxsKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb25lZFNlcmllcy5zdHlsZSA9IEV4dC5lbmNvZGUoY3VycmVudFNlcmllcy5zdHlsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZUNoYW5nZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb25lZFNlcmllc1twcm9wXSA9IGN1cnJlbnRTZXJpZXNbcHJvcF07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZGF0YVByb3ZpZGVyLnB1c2goY2xvbmVkU2VyaWVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoc2VyaWVzQ291bnQgPiAwKXsKICAgICAgICAgICAgICAgIGZvcihpID0gMDsgaSA8IHNlcmllc0NvdW50OyBpKyspewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTZXJpZXMgPSBkYXRhUHJvdmlkZXJbaV07CiAgICAgICAgICAgICAgICAgICAgaWYoIWN1cnJlbnRTZXJpZXMudHlwZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRTZXJpZXMudHlwZSA9IHRoaXMudHlwZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFNlcmllcy5kYXRhUHJvdmlkZXIgPSBkYXRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2V7CiAgICAgICAgICAgICAgICBkYXRhUHJvdmlkZXIucHVzaCh7dHlwZTogdGhpcy50eXBlLCBkYXRhUHJvdmlkZXI6IGRhdGF9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnN3Zi5zZXREYXRhUHJvdmlkZXIoZGF0YVByb3ZpZGVyKTsKICAgICAgICAgICAgaWYodGhpcy5zZXJpZXNTdHlsZXMpewogICAgICAgICAgICAgICAgdGhpcy5zZXRTZXJpZXNTdHlsZXModGhpcy5zZXJpZXNTdHlsZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdyZWZyZXNoJywgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNyZWF0ZUZuUHJveHkgOiBmdW5jdGlvbihmbil7CiAgICAgICAgdmFyIGZuTmFtZSA9ICdleHRGblByb3h5JyArICgrK0V4dC5jaGFydC5DaGFydC5QUk9YWV9GTl9JRCk7CiAgICAgICAgRXh0LmNoYXJ0LkNoYXJ0LnByb3h5RnVuY3Rpb25bZm5OYW1lXSA9IGZuOwogICAgICAgIHJldHVybiAnRXh0LmNoYXJ0LkNoYXJ0LnByb3h5RnVuY3Rpb24uJyArIGZuTmFtZTsKICAgIH0sCgogICAgCiAgICByZW1vdmVGblByb3h5IDogZnVuY3Rpb24oZm4pewogICAgICAgIGlmKCFFeHQuaXNFbXB0eShmbikpewogICAgICAgICAgICBmbiA9IGZuLnJlcGxhY2UoJ0V4dC5jaGFydC5DaGFydC5wcm94eUZ1bmN0aW9uLicsICcnKTsKICAgICAgICAgICAgZGVsZXRlIEV4dC5jaGFydC5DaGFydC5wcm94eUZ1bmN0aW9uW2ZuXTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0RnVuY3Rpb25SZWYgOiBmdW5jdGlvbih2YWwpewogICAgICAgIGlmKEV4dC5pc0Z1bmN0aW9uKHZhbCkpewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZm46IHZhbCwKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzCiAgICAgICAgICAgIH07CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBmbjogdmFsLmZuLAogICAgICAgICAgICAgICAgc2NvcGU6IHZhbC5zY29wZSB8fCB0aGlzCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uRGVzdHJveTogZnVuY3Rpb24oKXsKICAgICAgICBpZiAodGhpcy5yZWZyZXNoVGFzayAmJiB0aGlzLnJlZnJlc2hUYXNrLmNhbmNlbCl7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaFRhc2suY2FuY2VsKCk7CiAgICAgICAgfQogICAgICAgIEV4dC5jaGFydC5DaGFydC5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYmluZFN0b3JlKG51bGwpOwogICAgICAgIHRoaXMucmVtb3ZlRm5Qcm94eSh0aGlzLnRpcEZuTmFtZSk7CiAgICAgICAgdGhpcy5yZW1vdmVGblByb3h5KHRoaXMubGVnZW5kRm5OYW1lKTsKICAgIH0KfSk7CkV4dC5yZWcoJ2NoYXJ0JywgRXh0LmNoYXJ0LkNoYXJ0KTsKRXh0LmNoYXJ0LkNoYXJ0LlBST1hZX0ZOX0lEID0gMDsKRXh0LmNoYXJ0LkNoYXJ0LnByb3h5RnVuY3Rpb24gPSB7fTsKCgpFeHQuY2hhcnQuQ2hhcnQuQ0hBUlRfVVJMID0gJ2h0dHA6LycgKyAnL3l1aS55YWhvb2FwaXMuY29tLzIuOC4yL2J1aWxkL2NoYXJ0cy9hc3NldHMvY2hhcnRzLnN3Zic7CgoKRXh0LmNoYXJ0LlBpZUNoYXJ0ID0gRXh0LmV4dGVuZChFeHQuY2hhcnQuQ2hhcnQsIHsKICAgIHR5cGU6ICdwaWUnLAoKICAgIG9uU3dmUmVhZHkgOiBmdW5jdGlvbihpc1Jlc2V0KXsKICAgICAgICBFeHQuY2hhcnQuUGllQ2hhcnQuc3VwZXJjbGFzcy5vblN3ZlJlYWR5LmNhbGwodGhpcywgaXNSZXNldCk7CgogICAgICAgIHRoaXMuc2V0RGF0YUZpZWxkKHRoaXMuZGF0YUZpZWxkKTsKICAgICAgICB0aGlzLnNldENhdGVnb3J5RmllbGQodGhpcy5jYXRlZ29yeUZpZWxkKTsKICAgIH0sCgogICAgc2V0RGF0YUZpZWxkIDogZnVuY3Rpb24oZmllbGQpewogICAgICAgIHRoaXMuZGF0YUZpZWxkID0gZmllbGQ7CiAgICAgICAgdGhpcy5zd2Yuc2V0RGF0YUZpZWxkKGZpZWxkKTsKICAgIH0sCgogICAgc2V0Q2F0ZWdvcnlGaWVsZCA6IGZ1bmN0aW9uKGZpZWxkKXsKICAgICAgICB0aGlzLmNhdGVnb3J5RmllbGQgPSBmaWVsZDsKICAgICAgICB0aGlzLnN3Zi5zZXRDYXRlZ29yeUZpZWxkKGZpZWxkKTsKICAgIH0KfSk7CkV4dC5yZWcoJ3BpZWNoYXJ0JywgRXh0LmNoYXJ0LlBpZUNoYXJ0KTsKCgpFeHQuY2hhcnQuQ2FydGVzaWFuQ2hhcnQgPSBFeHQuZXh0ZW5kKEV4dC5jaGFydC5DaGFydCwgewogICAgb25Td2ZSZWFkeSA6IGZ1bmN0aW9uKGlzUmVzZXQpewogICAgICAgIEV4dC5jaGFydC5DYXJ0ZXNpYW5DaGFydC5zdXBlcmNsYXNzLm9uU3dmUmVhZHkuY2FsbCh0aGlzLCBpc1Jlc2V0KTsKICAgICAgICB0aGlzLmxhYmVsRm4gPSBbXTsKICAgICAgICBpZih0aGlzLnhGaWVsZCl7CiAgICAgICAgICAgIHRoaXMuc2V0WEZpZWxkKHRoaXMueEZpZWxkKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy55RmllbGQpewogICAgICAgICAgICB0aGlzLnNldFlGaWVsZCh0aGlzLnlGaWVsZCk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMueEF4aXMpewogICAgICAgICAgICB0aGlzLnNldFhBeGlzKHRoaXMueEF4aXMpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnhBeGVzKXsKICAgICAgICAgICAgdGhpcy5zZXRYQXhlcyh0aGlzLnhBeGVzKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy55QXhpcyl7CiAgICAgICAgICAgIHRoaXMuc2V0WUF4aXModGhpcy55QXhpcyk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMueUF4ZXMpewogICAgICAgICAgICB0aGlzLnNldFlBeGVzKHRoaXMueUF4ZXMpOwogICAgICAgIH0KICAgICAgICBpZihFeHQuaXNEZWZpbmVkKHRoaXMuY29uc3RyYWluVmlld3BvcnQpKXsKICAgICAgICAgICAgdGhpcy5zd2Yuc2V0Q29uc3RyYWluVmlld3BvcnQodGhpcy5jb25zdHJhaW5WaWV3cG9ydCk7CiAgICAgICAgfQogICAgfSwKCiAgICBzZXRYRmllbGQgOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgdGhpcy54RmllbGQgPSB2YWx1ZTsKICAgICAgICB0aGlzLnN3Zi5zZXRIb3Jpem9udGFsRmllbGQodmFsdWUpOwogICAgfSwKCiAgICBzZXRZRmllbGQgOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgdGhpcy55RmllbGQgPSB2YWx1ZTsKICAgICAgICB0aGlzLnN3Zi5zZXRWZXJ0aWNhbEZpZWxkKHZhbHVlKTsKICAgIH0sCgogICAgc2V0WEF4aXMgOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgdGhpcy54QXhpcyA9IHRoaXMuY3JlYXRlQXhpcygneEF4aXMnLCB2YWx1ZSk7CiAgICAgICAgdGhpcy5zd2Yuc2V0SG9yaXpvbnRhbEF4aXModGhpcy54QXhpcyk7CiAgICB9LAoKICAgIHNldFhBeGVzIDogZnVuY3Rpb24odmFsdWUpewogICAgICAgIHZhciBheGlzOwogICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBheGlzID0gdGhpcy5jcmVhdGVBeGlzKCd4QXhpcycgKyBpLCB2YWx1ZVtpXSk7CiAgICAgICAgICAgIHRoaXMuc3dmLnNldEhvcml6b250YWxBeGlzKGF4aXMpOwogICAgICAgIH0KICAgIH0sCgogICAgc2V0WUF4aXMgOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgdGhpcy55QXhpcyA9IHRoaXMuY3JlYXRlQXhpcygneUF4aXMnLCB2YWx1ZSk7CiAgICAgICAgdGhpcy5zd2Yuc2V0VmVydGljYWxBeGlzKHRoaXMueUF4aXMpOwogICAgfSwKCiAgICBzZXRZQXhlcyA6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICB2YXIgYXhpczsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYXhpcyA9IHRoaXMuY3JlYXRlQXhpcygneUF4aXMnICsgaSwgdmFsdWVbaV0pOwogICAgICAgICAgICB0aGlzLnN3Zi5zZXRWZXJ0aWNhbEF4aXMoYXhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBjcmVhdGVBeGlzIDogZnVuY3Rpb24oYXhpcywgdmFsdWUpewogICAgICAgIHZhciBvID0gRXh0LmFwcGx5KHt9LCB2YWx1ZSksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgb2xkOwoKICAgICAgICBpZih0aGlzW2F4aXNdKXsKICAgICAgICAgICAgb2xkID0gdGhpc1theGlzXS5sYWJlbEZ1bmN0aW9uOwogICAgICAgICAgICB0aGlzLnJlbW92ZUZuUHJveHkob2xkKTsKICAgICAgICAgICAgdGhpcy5sYWJlbEZuLnJlbW92ZShvbGQpOwogICAgICAgIH0KICAgICAgICBpZihvLmxhYmVsUmVuZGVyZXIpewogICAgICAgICAgICByZWYgPSB0aGlzLmdldEZ1bmN0aW9uUmVmKG8ubGFiZWxSZW5kZXJlcik7CiAgICAgICAgICAgIG8ubGFiZWxGdW5jdGlvbiA9IHRoaXMuY3JlYXRlRm5Qcm94eShmdW5jdGlvbih2KXsKICAgICAgICAgICAgICAgIHJldHVybiByZWYuZm4uY2FsbChyZWYuc2NvcGUsIHYpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZGVsZXRlIG8ubGFiZWxSZW5kZXJlcjsKICAgICAgICAgICAgdGhpcy5sYWJlbEZuLnB1c2goby5sYWJlbEZ1bmN0aW9uKTsKICAgICAgICB9CiAgICAgICAgaWYoYXhpcy5pbmRleE9mKCd4QXhpcycpID4gLTEgJiYgby5wb3NpdGlvbiA9PSAnbGVmdCcpewogICAgICAgICAgICBvLnBvc2l0aW9uID0gJ2JvdHRvbSc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvOwogICAgfSwKCiAgICBvbkRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5jaGFydC5DYXJ0ZXNpYW5DaGFydC5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIEV4dC5lYWNoKHRoaXMubGFiZWxGbiwgZnVuY3Rpb24oZm4pewogICAgICAgICAgICB0aGlzLnJlbW92ZUZuUHJveHkoZm4pOwogICAgICAgIH0sIHRoaXMpOwogICAgfQp9KTsKRXh0LnJlZygnY2FydGVzaWFuY2hhcnQnLCBFeHQuY2hhcnQuQ2FydGVzaWFuQ2hhcnQpOwoKCkV4dC5jaGFydC5MaW5lQ2hhcnQgPSBFeHQuZXh0ZW5kKEV4dC5jaGFydC5DYXJ0ZXNpYW5DaGFydCwgewogICAgdHlwZTogJ2xpbmUnCn0pOwpFeHQucmVnKCdsaW5lY2hhcnQnLCBFeHQuY2hhcnQuTGluZUNoYXJ0KTsKCgpFeHQuY2hhcnQuQ29sdW1uQ2hhcnQgPSBFeHQuZXh0ZW5kKEV4dC5jaGFydC5DYXJ0ZXNpYW5DaGFydCwgewogICAgdHlwZTogJ2NvbHVtbicKfSk7CkV4dC5yZWcoJ2NvbHVtbmNoYXJ0JywgRXh0LmNoYXJ0LkNvbHVtbkNoYXJ0KTsKCgpFeHQuY2hhcnQuU3RhY2tlZENvbHVtbkNoYXJ0ID0gRXh0LmV4dGVuZChFeHQuY2hhcnQuQ2FydGVzaWFuQ2hhcnQsIHsKICAgIHR5cGU6ICdzdGFja2NvbHVtbicKfSk7CkV4dC5yZWcoJ3N0YWNrZWRjb2x1bW5jaGFydCcsIEV4dC5jaGFydC5TdGFja2VkQ29sdW1uQ2hhcnQpOwoKCkV4dC5jaGFydC5CYXJDaGFydCA9IEV4dC5leHRlbmQoRXh0LmNoYXJ0LkNhcnRlc2lhbkNoYXJ0LCB7CiAgICB0eXBlOiAnYmFyJwp9KTsKRXh0LnJlZygnYmFyY2hhcnQnLCBFeHQuY2hhcnQuQmFyQ2hhcnQpOwoKCkV4dC5jaGFydC5TdGFja2VkQmFyQ2hhcnQgPSBFeHQuZXh0ZW5kKEV4dC5jaGFydC5DYXJ0ZXNpYW5DaGFydCwgewogICAgdHlwZTogJ3N0YWNrYmFyJwp9KTsKRXh0LnJlZygnc3RhY2tlZGJhcmNoYXJ0JywgRXh0LmNoYXJ0LlN0YWNrZWRCYXJDaGFydCk7CgoKCgpFeHQuY2hhcnQuQXhpcyA9IGZ1bmN0aW9uKGNvbmZpZyl7CiAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKfTsKCkV4dC5jaGFydC5BeGlzLnByb3RvdHlwZSA9CnsKICAgIAogICAgdHlwZTogbnVsbCwKCiAgICAKICAgIG9yaWVudGF0aW9uOiAiaG9yaXpvbnRhbCIsCgogICAgCiAgICByZXZlcnNlOiBmYWxzZSwKCiAgICAKICAgIGxhYmVsRnVuY3Rpb246IG51bGwsCgogICAgCiAgICBoaWRlT3ZlcmxhcHBpbmdMYWJlbHM6IHRydWUsCgogICAgCiAgICBsYWJlbFNwYWNpbmc6IDIKfTsKCgpFeHQuY2hhcnQuTnVtZXJpY0F4aXMgPSBFeHQuZXh0ZW5kKEV4dC5jaGFydC5BeGlzLCB7CiAgICB0eXBlOiAibnVtZXJpYyIsCgogICAgCiAgICBtaW5pbXVtOiBOYU4sCgogICAgCiAgICBtYXhpbXVtOiBOYU4sCgogICAgCiAgICBtYWpvclVuaXQ6IE5hTiwKCiAgICAKICAgIG1pbm9yVW5pdDogTmFOLAoKICAgIAogICAgc25hcFRvVW5pdHM6IHRydWUsCgogICAgCiAgICBhbHdheXNTaG93WmVybzogdHJ1ZSwKCiAgICAKICAgIHNjYWxlOiAibGluZWFyIiwKCiAgICAKICAgIHJvdW5kTWFqb3JVbml0OiB0cnVlLAoKICAgIAogICAgY2FsY3VsYXRlQnlMYWJlbFNpemU6IHRydWUsCgogICAgCiAgICBwb3NpdGlvbjogJ2xlZnQnLAoKICAgIAogICAgYWRqdXN0TWF4aW11bUJ5TWFqb3JVbml0OiB0cnVlLAoKICAgIAogICAgYWRqdXN0TWluaW11bUJ5TWFqb3JVbml0OiB0cnVlCgp9KTsKCgpFeHQuY2hhcnQuVGltZUF4aXMgPSBFeHQuZXh0ZW5kKEV4dC5jaGFydC5BeGlzLCB7CiAgICB0eXBlOiAidGltZSIsCgogICAgCiAgICBtaW5pbXVtOiBudWxsLAoKICAgIAogICAgbWF4aW11bTogbnVsbCwKCiAgICAKICAgIG1ham9yVW5pdDogTmFOLAoKICAgIAogICAgbWFqb3JUaW1lVW5pdDogbnVsbCwKCiAgICAKICAgIG1pbm9yVW5pdDogTmFOLAoKICAgIAogICAgbWlub3JUaW1lVW5pdDogbnVsbCwKCiAgICAKICAgIHNuYXBUb1VuaXRzOiB0cnVlLAoKICAgIAogICAgc3RhY2tpbmdFbmFibGVkOiBmYWxzZSwKCiAgICAKICAgIGNhbGN1bGF0ZUJ5TGFiZWxTaXplOiB0cnVlCgp9KTsKCgpFeHQuY2hhcnQuQ2F0ZWdvcnlBeGlzID0gRXh0LmV4dGVuZChFeHQuY2hhcnQuQXhpcywgewogICAgdHlwZTogImNhdGVnb3J5IiwKCiAgICAKICAgIGNhdGVnb3J5TmFtZXM6IG51bGwsCgogICAgCiAgICBjYWxjdWxhdGVDYXRlZ29yeUNvdW50OiBmYWxzZQoKfSk7CgoKRXh0LmNoYXJ0LlNlcmllcyA9IGZ1bmN0aW9uKGNvbmZpZykgeyBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsgfTsKCkV4dC5jaGFydC5TZXJpZXMucHJvdG90eXBlID0KewogICAgCiAgICB0eXBlOiBudWxsLAoKICAgIAogICAgZGlzcGxheU5hbWU6IG51bGwKfTsKCgpFeHQuY2hhcnQuQ2FydGVzaWFuU2VyaWVzID0gRXh0LmV4dGVuZChFeHQuY2hhcnQuU2VyaWVzLCB7CiAgICAKICAgIHhGaWVsZDogbnVsbCwKCiAgICAKICAgIHlGaWVsZDogbnVsbCwKCiAgICAKICAgIHNob3dJbkxlZ2VuZDogdHJ1ZSwKCiAgICAKICAgIGF4aXM6ICdwcmltYXJ5Jwp9KTsKCgpFeHQuY2hhcnQuQ29sdW1uU2VyaWVzID0gRXh0LmV4dGVuZChFeHQuY2hhcnQuQ2FydGVzaWFuU2VyaWVzLCB7CiAgICB0eXBlOiAiY29sdW1uIgp9KTsKCgpFeHQuY2hhcnQuTGluZVNlcmllcyA9IEV4dC5leHRlbmQoRXh0LmNoYXJ0LkNhcnRlc2lhblNlcmllcywgewogICAgdHlwZTogImxpbmUiCn0pOwoKCkV4dC5jaGFydC5CYXJTZXJpZXMgPSBFeHQuZXh0ZW5kKEV4dC5jaGFydC5DYXJ0ZXNpYW5TZXJpZXMsIHsKICAgIHR5cGU6ICJiYXIiCn0pOwoKCgpFeHQuY2hhcnQuUGllU2VyaWVzID0gRXh0LmV4dGVuZChFeHQuY2hhcnQuU2VyaWVzLCB7CiAgICB0eXBlOiAicGllIiwKICAgIGRhdGFGaWVsZDogbnVsbCwKICAgIGNhdGVnb3J5RmllbGQ6IG51bGwKfSk7CkV4dC5tZW51Lk1lbnUgPSBFeHQuZXh0ZW5kKEV4dC5Db250YWluZXIsIHsKICAgIAogICAgCiAgICAKICAgIG1pbldpZHRoIDogMTIwLAogICAgCiAgICBzaGFkb3cgOiAnc2lkZXMnLAogICAgCiAgICBzdWJNZW51QWxpZ24gOiAndGwtdHI/JywKICAgIAogICAgZGVmYXVsdEFsaWduIDogJ3RsLWJsPycsCiAgICAKICAgIGFsbG93T3RoZXJNZW51cyA6IGZhbHNlLAogICAgCiAgICBpZ25vcmVQYXJlbnRDbGlja3MgOiBmYWxzZSwKICAgIAogICAgZW5hYmxlU2Nyb2xsaW5nIDogdHJ1ZSwKICAgIAogICAgbWF4SGVpZ2h0IDogbnVsbCwKICAgIAogICAgc2Nyb2xsSW5jcmVtZW50IDogMjQsCiAgICAKICAgIHNob3dTZXBhcmF0b3IgOiB0cnVlLAogICAgCiAgICBkZWZhdWx0T2Zmc2V0cyA6IFswLCAwXSwKCiAgICAKICAgIHBsYWluIDogZmFsc2UsCgogICAgCiAgICBmbG9hdGluZyA6IHRydWUsCgoKICAgIAogICAgekluZGV4OiAxNTAwMCwKCiAgICAKICAgIGhpZGRlbiA6IHRydWUsCgogICAgCiAgICBsYXlvdXQgOiAnbWVudScsCiAgICBoaWRlTW9kZSA6ICdvZmZzZXRzJywgICAgCiAgICBzY3JvbGxlckhlaWdodCA6IDgsCiAgICBhdXRvTGF5b3V0IDogdHJ1ZSwgICAgICAgCiAgICBkZWZhdWx0VHlwZSA6ICdtZW51aXRlbScsCiAgICBidWZmZXJSZXNpemUgOiBmYWxzZSwKCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICBpZihFeHQuaXNBcnJheSh0aGlzLmluaXRpYWxDb25maWcpKXsKICAgICAgICAgICAgRXh0LmFwcGx5KHRoaXMsIHtpdGVtczp0aGlzLmluaXRpYWxDb25maWd9KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAnY2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ21vdXNlb3ZlcicsCiAgICAgICAgICAgIAogICAgICAgICAgICAnbW91c2VvdXQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2l0ZW1jbGljaycKICAgICAgICApOwogICAgICAgIEV4dC5tZW51Lk1lbnVNZ3IucmVnaXN0ZXIodGhpcyk7CiAgICAgICAgaWYodGhpcy5mbG9hdGluZyl7CiAgICAgICAgICAgIEV4dC5FdmVudE1hbmFnZXIub25XaW5kb3dSZXNpemUodGhpcy5oaWRlLCB0aGlzKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgaWYodGhpcy5pbml0aWFsQ29uZmlnLmhpZGRlbiAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgdGhpcy5oaWRkZW4gPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmludGVybmFsRGVmYXVsdHMgPSB7aGlkZU9uQ2xpY2s6IGZhbHNlfTsKICAgICAgICB9CiAgICAgICAgRXh0Lm1lbnUuTWVudS5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLmF1dG9MYXlvdXQpewogICAgICAgICAgICB2YXIgZm4gPSB0aGlzLmRvTGF5b3V0LmNyZWF0ZURlbGVnYXRlKHRoaXMsIFtdKTsKICAgICAgICAgICAgdGhpcy5vbih7CiAgICAgICAgICAgICAgICBhZGQ6IGZuLAogICAgICAgICAgICAgICAgcmVtb3ZlOiBmbgogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0TGF5b3V0VGFyZ2V0IDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudWw7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIGlmKCFjdCl7CiAgICAgICAgICAgIGN0ID0gRXh0LmdldEJvZHkoKTsKICAgICAgICB9CgogICAgICAgIHZhciBkaCA9IHsKICAgICAgICAgICAgaWQ6IHRoaXMuZ2V0SWQoKSwKICAgICAgICAgICAgY2xzOiAneC1tZW51ICcgKyAoKHRoaXMuZmxvYXRpbmcpID8gJ3gtbWVudS1mbG9hdGluZyB4LWxheWVyICcgOiAnJykgKyAodGhpcy5jbHMgfHwgJycpICsgKHRoaXMucGxhaW4gPyAnIHgtbWVudS1wbGFpbicgOiAnJykgKyAodGhpcy5zaG93U2VwYXJhdG9yID8gJycgOiAnIHgtbWVudS1ub3NlcCcpLAogICAgICAgICAgICBzdHlsZTogdGhpcy5zdHlsZSwKICAgICAgICAgICAgY246IFsKICAgICAgICAgICAgICAgIHt0YWc6ICdhJywgY2xzOiAneC1tZW51LWZvY3VzJywgaHJlZjogJyMnLCBvbmNsaWNrOiAncmV0dXJuIGZhbHNlOycsIHRhYkluZGV4OiAnLTEnfSwKICAgICAgICAgICAgICAgIHt0YWc6ICd1bCcsIGNsczogJ3gtbWVudS1saXN0J30KICAgICAgICAgICAgXQogICAgICAgIH07CiAgICAgICAgaWYodGhpcy5mbG9hdGluZyl7CiAgICAgICAgICAgIHRoaXMuZWwgPSBuZXcgRXh0LkxheWVyKHsKICAgICAgICAgICAgICAgIHNoYWRvdzogdGhpcy5zaGFkb3csCiAgICAgICAgICAgICAgICBkaDogZGgsCiAgICAgICAgICAgICAgICBjb25zdHJhaW46IGZhbHNlLAogICAgICAgICAgICAgICAgcGFyZW50RWw6IGN0LAogICAgICAgICAgICAgICAgemluZGV4OiB0aGlzLnpJbmRleAogICAgICAgICAgICB9KTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5lbCA9IGN0LmNyZWF0ZUNoaWxkKGRoKTsKICAgICAgICB9CiAgICAgICAgRXh0Lm1lbnUuTWVudS5zdXBlcmNsYXNzLm9uUmVuZGVyLmNhbGwodGhpcywgY3QsIHBvc2l0aW9uKTsKCiAgICAgICAgaWYoIXRoaXMua2V5TmF2KXsKICAgICAgICAgICAgdGhpcy5rZXlOYXYgPSBuZXcgRXh0Lm1lbnUuTWVudU5hdih0aGlzKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5mb2N1c0VsID0gdGhpcy5lbC5jaGlsZCgnYS54LW1lbnUtZm9jdXMnKTsKICAgICAgICB0aGlzLnVsID0gdGhpcy5lbC5jaGlsZCgndWwueC1tZW51LWxpc3QnKTsKICAgICAgICB0aGlzLm1vbih0aGlzLnVsLCB7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBjbGljazogdGhpcy5vbkNsaWNrLAogICAgICAgICAgICBtb3VzZW92ZXI6IHRoaXMub25Nb3VzZU92ZXIsCiAgICAgICAgICAgIG1vdXNlb3V0OiB0aGlzLm9uTW91c2VPdXQKICAgICAgICB9KTsKICAgICAgICBpZih0aGlzLmVuYWJsZVNjcm9sbGluZyl7CiAgICAgICAgICAgIHRoaXMubW9uKHRoaXMuZWwsIHsKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgZGVsZWdhdGU6ICcueC1tZW51LXNjcm9sbGVyJywKICAgICAgICAgICAgICAgIGNsaWNrOiB0aGlzLm9uU2Nyb2xsLAogICAgICAgICAgICAgICAgbW91c2VvdmVyOiB0aGlzLmRlYWN0aXZhdGVBY3RpdmUKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGZpbmRUYXJnZXRJdGVtIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIHQgPSBlLmdldFRhcmdldCgnLngtbWVudS1saXN0LWl0ZW0nLCB0aGlzLnVsLCB0cnVlKTsKICAgICAgICBpZih0ICYmIHQubWVudUl0ZW1JZCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLml0ZW1zLmdldCh0Lm1lbnVJdGVtSWQpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkNsaWNrIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIHQgPSB0aGlzLmZpbmRUYXJnZXRJdGVtKGUpOwogICAgICAgIGlmKHQpewogICAgICAgICAgICBpZih0LmlzRm9ybUZpZWxkKXsKICAgICAgICAgICAgICAgIHRoaXMuc2V0QWN0aXZlSXRlbSh0KTsKICAgICAgICAgICAgfWVsc2UgaWYodCBpbnN0YW5jZW9mIEV4dC5tZW51LkJhc2VJdGVtKXsKICAgICAgICAgICAgICAgIGlmKHQubWVudSAmJiB0aGlzLmlnbm9yZVBhcmVudENsaWNrcyl7CiAgICAgICAgICAgICAgICAgICAgdC5leHBhbmRNZW51KCk7CiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfWVsc2UgaWYodC5vbkNsaWNrKXsKICAgICAgICAgICAgICAgICAgICB0Lm9uQ2xpY2soZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2NsaWNrJywgdGhpcywgdCwgZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0QWN0aXZlSXRlbSA6IGZ1bmN0aW9uKGl0ZW0sIGF1dG9FeHBhbmQpewogICAgICAgIGlmKGl0ZW0gIT0gdGhpcy5hY3RpdmVJdGVtKXsKICAgICAgICAgICAgdGhpcy5kZWFjdGl2YXRlQWN0aXZlKCk7CiAgICAgICAgICAgIGlmKCh0aGlzLmFjdGl2ZUl0ZW0gPSBpdGVtKS5pc0Zvcm1GaWVsZCl7CiAgICAgICAgICAgICAgICBpdGVtLmZvY3VzKCk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgaXRlbS5hY3RpdmF0ZShhdXRvRXhwYW5kKTsKICAgICAgICAgICAgfQogICAgICAgIH1lbHNlIGlmKGF1dG9FeHBhbmQpewogICAgICAgICAgICBpdGVtLmV4cGFuZE1lbnUoKTsKICAgICAgICB9CiAgICB9LAoKICAgIGRlYWN0aXZhdGVBY3RpdmUgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBhID0gdGhpcy5hY3RpdmVJdGVtOwogICAgICAgIGlmKGEpewogICAgICAgICAgICBpZihhLmlzRm9ybUZpZWxkKXsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYoYS5jb2xsYXBzZSl7CiAgICAgICAgICAgICAgICAgICAgYS5jb2xsYXBzZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGEuZGVhY3RpdmF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmFjdGl2ZUl0ZW07CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHRyeUFjdGl2YXRlIDogZnVuY3Rpb24oc3RhcnQsIHN0ZXApewogICAgICAgIHZhciBpdGVtcyA9IHRoaXMuaXRlbXM7CiAgICAgICAgZm9yKHZhciBpID0gc3RhcnQsIGxlbiA9IGl0ZW1zLmxlbmd0aDsgaSA+PSAwICYmIGkgPCBsZW47IGkrPSBzdGVwKXsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBpdGVtcy5nZXQoaSk7CiAgICAgICAgICAgIGlmKGl0ZW0uaXNWaXNpYmxlKCkgJiYgIWl0ZW0uZGlzYWJsZWQgJiYgKGl0ZW0uY2FuQWN0aXZhdGUgfHwgaXRlbS5pc0Zvcm1GaWVsZCkpewogICAgICAgICAgICAgICAgdGhpcy5zZXRBY3RpdmVJdGVtKGl0ZW0sIGZhbHNlKTsKICAgICAgICAgICAgICAgIHJldHVybiBpdGVtOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgCiAgICBvbk1vdXNlT3ZlciA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciB0ID0gdGhpcy5maW5kVGFyZ2V0SXRlbShlKTsKICAgICAgICBpZih0KXsKICAgICAgICAgICAgaWYodC5jYW5BY3RpdmF0ZSAmJiAhdC5kaXNhYmxlZCl7CiAgICAgICAgICAgICAgICB0aGlzLnNldEFjdGl2ZUl0ZW0odCwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5vdmVyID0gdHJ1ZTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnbW91c2VvdmVyJywgdGhpcywgZSwgdCk7CiAgICB9LAoKICAgIAogICAgb25Nb3VzZU91dCA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciB0ID0gdGhpcy5maW5kVGFyZ2V0SXRlbShlKTsKICAgICAgICBpZih0KXsKICAgICAgICAgICAgaWYodCA9PSB0aGlzLmFjdGl2ZUl0ZW0gJiYgdC5zaG91bGREZWFjdGl2YXRlICYmIHQuc2hvdWxkRGVhY3RpdmF0ZShlKSl7CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUl0ZW0uZGVhY3RpdmF0ZSgpOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuYWN0aXZlSXRlbTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLm92ZXIgPSBmYWxzZTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnbW91c2VvdXQnLCB0aGlzLCBlLCB0KTsKICAgIH0sCgogICAgCiAgICBvblNjcm9sbCA6IGZ1bmN0aW9uKGUsIHQpewogICAgICAgIGlmKGUpewogICAgICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgIH0KICAgICAgICB2YXIgdWwgPSB0aGlzLnVsLmRvbSwgdG9wID0gRXh0LmZseSh0KS5pcygnLngtbWVudS1zY3JvbGxlci10b3AnKTsKICAgICAgICB1bC5zY3JvbGxUb3AgKz0gdGhpcy5zY3JvbGxJbmNyZW1lbnQgKiAodG9wID8gLTEgOiAxKTsKICAgICAgICBpZih0b3AgPyB1bC5zY3JvbGxUb3AgPD0gMCA6IHVsLnNjcm9sbFRvcCArIHRoaXMuYWN0aXZlTWF4ID49IHVsLnNjcm9sbEhlaWdodCl7CiAgICAgICAgICAgdGhpcy5vblNjcm9sbGVyT3V0KG51bGwsIHQpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblNjcm9sbGVySW4gOiBmdW5jdGlvbihlLCB0KXsKICAgICAgICB2YXIgdWwgPSB0aGlzLnVsLmRvbSwgdG9wID0gRXh0LmZseSh0KS5pcygnLngtbWVudS1zY3JvbGxlci10b3AnKTsKICAgICAgICBpZih0b3AgPyB1bC5zY3JvbGxUb3AgPiAwIDogdWwuc2Nyb2xsVG9wICsgdGhpcy5hY3RpdmVNYXggPCB1bC5zY3JvbGxIZWlnaHQpewogICAgICAgICAgICBFeHQuZmx5KHQpLmFkZENsYXNzKFsneC1tZW51LWl0ZW0tYWN0aXZlJywgJ3gtbWVudS1zY3JvbGxlci1hY3RpdmUnXSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uU2Nyb2xsZXJPdXQgOiBmdW5jdGlvbihlLCB0KXsKICAgICAgICBFeHQuZmx5KHQpLnJlbW92ZUNsYXNzKFsneC1tZW51LWl0ZW0tYWN0aXZlJywgJ3gtbWVudS1zY3JvbGxlci1hY3RpdmUnXSk7CiAgICB9LAoKICAgIAogICAgc2hvdyA6IGZ1bmN0aW9uKGVsLCBwb3MsIHBhcmVudE1lbnUpewogICAgICAgIGlmKHRoaXMuZmxvYXRpbmcpewogICAgICAgICAgICB0aGlzLnBhcmVudE1lbnUgPSBwYXJlbnRNZW51OwogICAgICAgICAgICBpZighdGhpcy5lbCl7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpOwogICAgICAgICAgICAgICAgdGhpcy5kb0xheW91dChmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zaG93QXQodGhpcy5lbC5nZXRBbGlnblRvWFkoZWwsIHBvcyB8fCB0aGlzLmRlZmF1bHRBbGlnbiwgdGhpcy5kZWZhdWx0T2Zmc2V0cyksIHBhcmVudE1lbnUpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBFeHQubWVudS5NZW51LnN1cGVyY2xhc3Muc2hvdy5jYWxsKHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzaG93QXQgOiBmdW5jdGlvbih4eSwgcGFyZW50TWVudSl7CiAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoJ2JlZm9yZXNob3cnLCB0aGlzKSAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLnBhcmVudE1lbnUgPSBwYXJlbnRNZW51OwogICAgICAgICAgICBpZighdGhpcy5lbCl7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMuZW5hYmxlU2Nyb2xsaW5nKXsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5lbC5zZXRYWSh4eSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHh5WzFdID0gdGhpcy5jb25zdHJhaW5TY3JvbGwoeHlbMV0pOwogICAgICAgICAgICAgICAgeHkgPSBbdGhpcy5lbC5hZGp1c3RGb3JDb25zdHJhaW50cyh4eSlbMF0sIHh5WzFdXTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHh5ID0gdGhpcy5lbC5hZGp1c3RGb3JDb25zdHJhaW50cyh4eSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5lbC5zZXRYWSh4eSk7CiAgICAgICAgICAgIHRoaXMuZWwuc2hvdygpOwogICAgICAgICAgICBFeHQubWVudS5NZW51LnN1cGVyY2xhc3Mub25TaG93LmNhbGwodGhpcyk7CiAgICAgICAgICAgIGlmKEV4dC5pc0lFKXsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2F1dG9zaXplJywgdGhpcyk7CiAgICAgICAgICAgICAgICBpZighRXh0LmlzSUU4KXsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLnJlcGFpbnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhpZGRlbiA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmZvY3VzKCk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzaG93JywgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBjb25zdHJhaW5TY3JvbGwgOiBmdW5jdGlvbih5KXsKICAgICAgICB2YXIgbWF4LCBmdWxsID0gdGhpcy51bC5zZXRIZWlnaHQoJ2F1dG8nKS5nZXRIZWlnaHQoKSwKICAgICAgICAgICAgcmV0dXJuWSA9IHksIG5vcm1hbFksIHBhcmVudEVsLCBzY3JvbGxUb3AsIHZpZXdIZWlnaHQ7CiAgICAgICAgaWYodGhpcy5mbG9hdGluZyl7CiAgICAgICAgICAgIHBhcmVudEVsID0gRXh0LmZseSh0aGlzLmVsLmRvbS5wYXJlbnROb2RlKTsKICAgICAgICAgICAgc2Nyb2xsVG9wID0gcGFyZW50RWwuZ2V0U2Nyb2xsKCkudG9wOwogICAgICAgICAgICB2aWV3SGVpZ2h0ID0gcGFyZW50RWwuZ2V0Vmlld1NpemUoKS5oZWlnaHQ7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgbm9ybWFsWSA9IHkgLSBzY3JvbGxUb3A7CiAgICAgICAgICAgIG1heCA9IHRoaXMubWF4SGVpZ2h0ID8gdGhpcy5tYXhIZWlnaHQgOiB2aWV3SGVpZ2h0IC0gbm9ybWFsWTsKICAgICAgICAgICAgaWYoZnVsbCA+IHZpZXdIZWlnaHQpIHsKICAgICAgICAgICAgICAgIG1heCA9IHZpZXdIZWlnaHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVyblkgPSB5IC0gbm9ybWFsWTsKICAgICAgICAgICAgfSBlbHNlIGlmKG1heCA8IGZ1bGwpIHsKICAgICAgICAgICAgICAgIHJldHVyblkgPSB5IC0gKGZ1bGwgLSBtYXgpOwogICAgICAgICAgICAgICAgbWF4ID0gZnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH1lbHNlewogICAgICAgICAgICBtYXggPSB0aGlzLmdldEhlaWdodCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAodGhpcy5tYXhIZWlnaHQpewogICAgICAgICAgICBtYXggPSBNYXRoLm1pbih0aGlzLm1heEhlaWdodCwgbWF4KTsKICAgICAgICB9CiAgICAgICAgaWYoZnVsbCA+IG1heCAmJiBtYXggPiAwKXsKICAgICAgICAgICAgdGhpcy5hY3RpdmVNYXggPSBtYXggLSB0aGlzLnNjcm9sbGVySGVpZ2h0ICogMiAtIHRoaXMuZWwuZ2V0RnJhbWVXaWR0aCgndGInKSAtIEV4dC5udW0odGhpcy5lbC5zaGFkb3dPZmZzZXQsIDApOwogICAgICAgICAgICB0aGlzLnVsLnNldEhlaWdodCh0aGlzLmFjdGl2ZU1heCk7CiAgICAgICAgICAgIHRoaXMuY3JlYXRlU2Nyb2xsZXJzKCk7CiAgICAgICAgICAgIHRoaXMuZWwuc2VsZWN0KCcueC1tZW51LXNjcm9sbGVyJykuc2V0RGlzcGxheWVkKCcnKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy51bC5zZXRIZWlnaHQoZnVsbCk7CiAgICAgICAgICAgIHRoaXMuZWwuc2VsZWN0KCcueC1tZW51LXNjcm9sbGVyJykuc2V0RGlzcGxheWVkKCdub25lJyk7CiAgICAgICAgfQogICAgICAgIHRoaXMudWwuZG9tLnNjcm9sbFRvcCA9IDA7CiAgICAgICAgcmV0dXJuIHJldHVyblk7CiAgICB9LAoKICAgIGNyZWF0ZVNjcm9sbGVycyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMuc2Nyb2xsZXIpewogICAgICAgICAgICB0aGlzLnNjcm9sbGVyID0gewogICAgICAgICAgICAgICAgcG9zOiAwLAogICAgICAgICAgICAgICAgdG9wOiB0aGlzLmVsLmluc2VydEZpcnN0KHsKICAgICAgICAgICAgICAgICAgICB0YWc6ICdkaXYnLAogICAgICAgICAgICAgICAgICAgIGNsczogJ3gtbWVudS1zY3JvbGxlciB4LW1lbnUtc2Nyb2xsZXItdG9wJywKICAgICAgICAgICAgICAgICAgICBodG1sOiAnJiMxNjA7JwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBib3R0b206IHRoaXMuZWwuY3JlYXRlQ2hpbGQoewogICAgICAgICAgICAgICAgICAgIHRhZzogJ2RpdicsCiAgICAgICAgICAgICAgICAgICAgY2xzOiAneC1tZW51LXNjcm9sbGVyIHgtbWVudS1zY3JvbGxlci1ib3R0b20nLAogICAgICAgICAgICAgICAgICAgIGh0bWw6ICcmIzE2MDsnCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNjcm9sbGVyLnRvcC5ob3Zlcih0aGlzLm9uU2Nyb2xsZXJJbiwgdGhpcy5vblNjcm9sbGVyT3V0LCB0aGlzKTsKICAgICAgICAgICAgdGhpcy5zY3JvbGxlci50b3BSZXBlYXRlciA9IG5ldyBFeHQudXRpbC5DbGlja1JlcGVhdGVyKHRoaXMuc2Nyb2xsZXIudG9wLCB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IHsKICAgICAgICAgICAgICAgICAgICBjbGljazogdGhpcy5vblNjcm9sbC5jcmVhdGVEZWxlZ2F0ZSh0aGlzLCBbbnVsbCwgdGhpcy5zY3JvbGxlci50b3BdLCBmYWxzZSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsZXIuYm90dG9tLmhvdmVyKHRoaXMub25TY3JvbGxlckluLCB0aGlzLm9uU2Nyb2xsZXJPdXQsIHRoaXMpOwogICAgICAgICAgICB0aGlzLnNjcm9sbGVyLmJvdHRvbVJlcGVhdGVyID0gbmV3IEV4dC51dGlsLkNsaWNrUmVwZWF0ZXIodGhpcy5zY3JvbGxlci5ib3R0b20sIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVyczogewogICAgICAgICAgICAgICAgICAgIGNsaWNrOiB0aGlzLm9uU2Nyb2xsLmNyZWF0ZURlbGVnYXRlKHRoaXMsIFtudWxsLCB0aGlzLnNjcm9sbGVyLmJvdHRvbV0sIGZhbHNlKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9LAoKICAgIG9uTGF5b3V0IDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmlzVmlzaWJsZSgpKXsKICAgICAgICAgICAgaWYodGhpcy5lbmFibGVTY3JvbGxpbmcpewogICAgICAgICAgICAgICAgdGhpcy5jb25zdHJhaW5TY3JvbGwodGhpcy5lbC5nZXRUb3AoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5mbG9hdGluZyl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnN5bmMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgZm9jdXMgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLmhpZGRlbil7CiAgICAgICAgICAgIHRoaXMuZG9Gb2N1cy5kZWZlcig1MCwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBkb0ZvY3VzIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5oaWRkZW4pewogICAgICAgICAgICB0aGlzLmZvY3VzRWwuZm9jdXMoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaGlkZSA6IGZ1bmN0aW9uKGRlZXApewogICAgICAgIGlmICghdGhpcy5pc0Rlc3Ryb3llZCkgewogICAgICAgICAgICB0aGlzLmRlZXBIaWRlID0gZGVlcDsKICAgICAgICAgICAgRXh0Lm1lbnUuTWVudS5zdXBlcmNsYXNzLmhpZGUuY2FsbCh0aGlzKTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuZGVlcEhpZGU7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uSGlkZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0Lm1lbnUuTWVudS5zdXBlcmNsYXNzLm9uSGlkZS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuZGVhY3RpdmF0ZUFjdGl2ZSgpOwogICAgICAgIGlmKHRoaXMuZWwgJiYgdGhpcy5mbG9hdGluZyl7CiAgICAgICAgICAgIHRoaXMuZWwuaGlkZSgpOwogICAgICAgIH0KICAgICAgICB2YXIgcG0gPSB0aGlzLnBhcmVudE1lbnU7CiAgICAgICAgaWYodGhpcy5kZWVwSGlkZSA9PT0gdHJ1ZSAmJiBwbSl7CiAgICAgICAgICAgIGlmKHBtLmZsb2F0aW5nKXsKICAgICAgICAgICAgICAgIHBtLmhpZGUodHJ1ZSk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgcG0uZGVhY3RpdmF0ZUFjdGl2ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGxvb2t1cENvbXBvbmVudCA6IGZ1bmN0aW9uKGMpewogICAgICAgICBpZihFeHQuaXNTdHJpbmcoYykpewogICAgICAgICAgICBjID0gKGMgPT0gJ3NlcGFyYXRvcicgfHwgYyA9PSAnLScpID8gbmV3IEV4dC5tZW51LlNlcGFyYXRvcigpIDogbmV3IEV4dC5tZW51LlRleHRJdGVtKGMpOwogICAgICAgICAgICAgdGhpcy5hcHBseURlZmF1bHRzKGMpOwogICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgaWYoRXh0LmlzT2JqZWN0KGMpKXsKICAgICAgICAgICAgICAgIGMgPSB0aGlzLmdldE1lbnVJdGVtKGMpOwogICAgICAgICAgICB9ZWxzZSBpZihjLnRhZ05hbWUgfHwgYy5lbCl7IAogICAgICAgICAgICAgICAgYyA9IG5ldyBFeHQuQm94Q29tcG9uZW50KHsKICAgICAgICAgICAgICAgICAgICBlbDogYwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgfQogICAgICAgICByZXR1cm4gYzsKICAgIH0sCgogICAgYXBwbHlEZWZhdWx0cyA6IGZ1bmN0aW9uKGMpIHsKICAgICAgICBpZiAoIUV4dC5pc1N0cmluZyhjKSkgewogICAgICAgICAgICBjID0gRXh0Lm1lbnUuTWVudS5zdXBlcmNsYXNzLmFwcGx5RGVmYXVsdHMuY2FsbCh0aGlzLCBjKTsKICAgICAgICAgICAgdmFyIGQgPSB0aGlzLmludGVybmFsRGVmYXVsdHM7CiAgICAgICAgICAgIGlmKGQpewogICAgICAgICAgICAgICAgaWYoYy5ldmVudHMpewogICAgICAgICAgICAgICAgICAgIEV4dC5hcHBseUlmKGMuaW5pdGlhbENvbmZpZywgZCk7CiAgICAgICAgICAgICAgICAgICAgRXh0LmFwcGx5KGMsIGQpOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgRXh0LmFwcGx5SWYoYywgZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGM7CiAgICB9LAoKICAgIAogICAgZ2V0TWVudUl0ZW0gOiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICBjb25maWcub3duZXJDdCA9IHRoaXM7CiAgICAgICAgCiAgICAgICAgaWYgKCFjb25maWcuaXNYVHlwZSkgewogICAgICAgICAgICBpZiAoIWNvbmZpZy54dHlwZSAmJiBFeHQuaXNCb29sZWFuKGNvbmZpZy5jaGVja2VkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBFeHQubWVudS5DaGVja0l0ZW0oY29uZmlnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gRXh0LmNyZWF0ZShjb25maWcsIHRoaXMuZGVmYXVsdFR5cGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29uZmlnOwogICAgfSwKCiAgICAKICAgIGFkZFNlcGFyYXRvciA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmFkZChuZXcgRXh0Lm1lbnUuU2VwYXJhdG9yKCkpOwogICAgfSwKCiAgICAKICAgIGFkZEVsZW1lbnQgOiBmdW5jdGlvbihlbCkgewogICAgICAgIHJldHVybiB0aGlzLmFkZChuZXcgRXh0Lm1lbnUuQmFzZUl0ZW0oewogICAgICAgICAgICBlbDogZWwKICAgICAgICB9KSk7CiAgICB9LAoKICAgIAogICAgYWRkSXRlbSA6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGQoaXRlbSk7CiAgICB9LAoKICAgIAogICAgYWRkTWVudUl0ZW0gOiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICByZXR1cm4gdGhpcy5hZGQodGhpcy5nZXRNZW51SXRlbShjb25maWcpKTsKICAgIH0sCgogICAgCiAgICBhZGRUZXh0IDogZnVuY3Rpb24odGV4dCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkKG5ldyBFeHQubWVudS5UZXh0SXRlbSh0ZXh0KSk7CiAgICB9LAoKICAgIAogICAgb25EZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLnJlbW92ZVJlc2l6ZUxpc3RlbmVyKHRoaXMuaGlkZSwgdGhpcyk7CiAgICAgICAgdmFyIHBtID0gdGhpcy5wYXJlbnRNZW51OwogICAgICAgIGlmKHBtICYmIHBtLmFjdGl2ZUNoaWxkID09IHRoaXMpewogICAgICAgICAgICBkZWxldGUgcG0uYWN0aXZlQ2hpbGQ7CiAgICAgICAgfQogICAgICAgIGRlbGV0ZSB0aGlzLnBhcmVudE1lbnU7CiAgICAgICAgRXh0Lm1lbnUuTWVudS5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIEV4dC5tZW51Lk1lbnVNZ3IudW5yZWdpc3Rlcih0aGlzKTsKICAgICAgICBpZih0aGlzLmtleU5hdikgewogICAgICAgICAgICB0aGlzLmtleU5hdi5kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICAgIHZhciBzID0gdGhpcy5zY3JvbGxlcjsKICAgICAgICBpZihzKXsKICAgICAgICAgICAgRXh0LmRlc3Ryb3kocy50b3BSZXBlYXRlciwgcy5ib3R0b21SZXBlYXRlciwgcy50b3AsIHMuYm90dG9tKTsKICAgICAgICB9CiAgICAgICAgRXh0LmRlc3Ryb3koCiAgICAgICAgICAgIHRoaXMuZWwsCiAgICAgICAgICAgIHRoaXMuZm9jdXNFbCwKICAgICAgICAgICAgdGhpcy51bAogICAgICAgICk7CiAgICB9Cn0pOwoKRXh0LnJlZygnbWVudScsIEV4dC5tZW51Lk1lbnUpOwoKCkV4dC5tZW51Lk1lbnVOYXYgPSBFeHQuZXh0ZW5kKEV4dC5LZXlOYXYsIGZ1bmN0aW9uKCl7CiAgICBmdW5jdGlvbiB1cChlLCBtKXsKICAgICAgICBpZighbS50cnlBY3RpdmF0ZShtLml0ZW1zLmluZGV4T2YobS5hY3RpdmVJdGVtKS0xLCAtMSkpewogICAgICAgICAgICBtLnRyeUFjdGl2YXRlKG0uaXRlbXMubGVuZ3RoLTEsIC0xKTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBkb3duKGUsIG0pewogICAgICAgIGlmKCFtLnRyeUFjdGl2YXRlKG0uaXRlbXMuaW5kZXhPZihtLmFjdGl2ZUl0ZW0pKzEsIDEpKXsKICAgICAgICAgICAgbS50cnlBY3RpdmF0ZSgwLCAxKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24obWVudSl7CiAgICAgICAgICAgIEV4dC5tZW51Lk1lbnVOYXYuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIG1lbnUuZWwpOwogICAgICAgICAgICB0aGlzLnNjb3BlID0gdGhpcy5tZW51ID0gbWVudTsKICAgICAgICB9LAoKICAgICAgICBkb1JlbGF5IDogZnVuY3Rpb24oZSwgaCl7CiAgICAgICAgICAgIHZhciBrID0gZS5nZXRLZXkoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLm1lbnUuYWN0aXZlSXRlbSAmJiB0aGlzLm1lbnUuYWN0aXZlSXRlbS5pc0Zvcm1GaWVsZCAmJiBrICE9IGUuVEFCKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIXRoaXMubWVudS5hY3RpdmVJdGVtICYmIGUuaXNOYXZLZXlQcmVzcygpICYmIGsgIT0gZS5TUEFDRSAmJiBrICE9IGUuUkVUVVJOKXsKICAgICAgICAgICAgICAgIHRoaXMubWVudS50cnlBY3RpdmF0ZSgwLCAxKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaC5jYWxsKHRoaXMuc2NvcGUgfHwgdGhpcywgZSwgdGhpcy5tZW51KTsKICAgICAgICB9LAoKICAgICAgICB0YWI6IGZ1bmN0aW9uKGUsIG0pIHsKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgaWYgKGUuc2hpZnRLZXkpIHsKICAgICAgICAgICAgICAgIHVwKGUsIG0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZG93bihlLCBtKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHVwIDogdXAsCgogICAgICAgIGRvd24gOiBkb3duLAoKICAgICAgICByaWdodCA6IGZ1bmN0aW9uKGUsIG0pewogICAgICAgICAgICBpZihtLmFjdGl2ZUl0ZW0pewogICAgICAgICAgICAgICAgbS5hY3RpdmVJdGVtLmV4cGFuZE1lbnUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICBsZWZ0IDogZnVuY3Rpb24oZSwgbSl7CiAgICAgICAgICAgIG0uaGlkZSgpOwogICAgICAgICAgICBpZihtLnBhcmVudE1lbnUgJiYgbS5wYXJlbnRNZW51LmFjdGl2ZUl0ZW0pewogICAgICAgICAgICAgICAgbS5wYXJlbnRNZW51LmFjdGl2ZUl0ZW0uYWN0aXZhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGVudGVyIDogZnVuY3Rpb24oZSwgbSl7CiAgICAgICAgICAgIGlmKG0uYWN0aXZlSXRlbSl7CiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgbS5hY3RpdmVJdGVtLm9uQ2xpY2soZSk7CiAgICAgICAgICAgICAgICBtLmZpcmVFdmVudCgnY2xpY2snLCB0aGlzLCBtLmFjdGl2ZUl0ZW0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Owp9KCkpOwoKRXh0Lm1lbnUuTWVudU1nciA9IGZ1bmN0aW9uKCl7CiAgIHZhciBtZW51cywgCiAgICAgICBhY3RpdmUsIAogICAgICAgbWFwLAogICAgICAgZ3JvdXBzID0ge30sIAogICAgICAgYXR0YWNoZWQgPSBmYWxzZSwgCiAgICAgICBsYXN0U2hvdyA9IG5ldyBEYXRlKCk7CiAgIAoKICAgCiAgIGZ1bmN0aW9uIGluaXQoKXsKICAgICAgIG1lbnVzID0ge307CiAgICAgICBhY3RpdmUgPSBuZXcgRXh0LnV0aWwuTWl4ZWRDb2xsZWN0aW9uKCk7CiAgICAgICBtYXAgPSBFeHQuZ2V0RG9jKCkuYWRkS2V5TGlzdGVuZXIoMjcsIGhpZGVBbGwpOwogICAgICAgbWFwLmRpc2FibGUoKTsKICAgfQoKICAgCiAgIGZ1bmN0aW9uIGhpZGVBbGwoKXsKICAgICAgIGlmKGFjdGl2ZSAmJiBhY3RpdmUubGVuZ3RoID4gMCl7CiAgICAgICAgICAgdmFyIGMgPSBhY3RpdmUuY2xvbmUoKTsKICAgICAgICAgICBjLmVhY2goZnVuY3Rpb24obSl7CiAgICAgICAgICAgICAgIG0uaGlkZSgpOwogICAgICAgICAgIH0pOwogICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgfQogICAgICAgcmV0dXJuIGZhbHNlOwogICB9CgogICAKICAgZnVuY3Rpb24gb25IaWRlKG0pewogICAgICAgYWN0aXZlLnJlbW92ZShtKTsKICAgICAgIGlmKGFjdGl2ZS5sZW5ndGggPCAxKXsKICAgICAgICAgICBtYXAuZGlzYWJsZSgpOwogICAgICAgICAgIEV4dC5nZXREb2MoKS51bigibW91c2Vkb3duIiwgb25Nb3VzZURvd24pOwogICAgICAgICAgIGF0dGFjaGVkID0gZmFsc2U7CiAgICAgICB9CiAgIH0KCiAgIAogICBmdW5jdGlvbiBvblNob3cobSl7CiAgICAgICB2YXIgbGFzdCA9IGFjdGl2ZS5sYXN0KCk7CiAgICAgICBsYXN0U2hvdyA9IG5ldyBEYXRlKCk7CiAgICAgICBhY3RpdmUuYWRkKG0pOwogICAgICAgaWYoIWF0dGFjaGVkKXsKICAgICAgICAgICBtYXAuZW5hYmxlKCk7CiAgICAgICAgICAgRXh0LmdldERvYygpLm9uKCJtb3VzZWRvd24iLCBvbk1vdXNlRG93bik7CiAgICAgICAgICAgYXR0YWNoZWQgPSB0cnVlOwogICAgICAgfQogICAgICAgaWYobS5wYXJlbnRNZW51KXsKICAgICAgICAgIG0uZ2V0RWwoKS5zZXRaSW5kZXgocGFyc2VJbnQobS5wYXJlbnRNZW51LmdldEVsKCkuZ2V0U3R5bGUoInotaW5kZXgiKSwgMTApICsgMyk7CiAgICAgICAgICBtLnBhcmVudE1lbnUuYWN0aXZlQ2hpbGQgPSBtOwogICAgICAgfWVsc2UgaWYobGFzdCAmJiAhbGFzdC5pc0Rlc3Ryb3llZCAmJiBsYXN0LmlzVmlzaWJsZSgpKXsKICAgICAgICAgIG0uZ2V0RWwoKS5zZXRaSW5kZXgocGFyc2VJbnQobGFzdC5nZXRFbCgpLmdldFN0eWxlKCJ6LWluZGV4IiksIDEwKSArIDMpOwogICAgICAgfQogICB9CgogICAKICAgZnVuY3Rpb24gb25CZWZvcmVIaWRlKG0pewogICAgICAgaWYobS5hY3RpdmVDaGlsZCl7CiAgICAgICAgICAgbS5hY3RpdmVDaGlsZC5oaWRlKCk7CiAgICAgICB9CiAgICAgICBpZihtLmF1dG9IaWRlVGltZXIpewogICAgICAgICAgIGNsZWFyVGltZW91dChtLmF1dG9IaWRlVGltZXIpOwogICAgICAgICAgIGRlbGV0ZSBtLmF1dG9IaWRlVGltZXI7CiAgICAgICB9CiAgIH0KCiAgIAogICBmdW5jdGlvbiBvbkJlZm9yZVNob3cobSl7CiAgICAgICB2YXIgcG0gPSBtLnBhcmVudE1lbnU7CiAgICAgICBpZighcG0gJiYgIW0uYWxsb3dPdGhlck1lbnVzKXsKICAgICAgICAgICBoaWRlQWxsKCk7CiAgICAgICB9ZWxzZSBpZihwbSAmJiBwbS5hY3RpdmVDaGlsZCl7CiAgICAgICAgICAgcG0uYWN0aXZlQ2hpbGQuaGlkZSgpOwogICAgICAgfQogICB9CgogICAKICAgZnVuY3Rpb24gb25Nb3VzZURvd24oZSl7CiAgICAgICBpZihsYXN0U2hvdy5nZXRFbGFwc2VkKCkgPiA1MCAmJiBhY3RpdmUubGVuZ3RoID4gMCAmJiAhZS5nZXRUYXJnZXQoIi54LW1lbnUiKSl7CiAgICAgICAgICAgaGlkZUFsbCgpOwogICAgICAgfQogICB9CgogICByZXR1cm4gewoKICAgICAgIAogICAgICAgaGlkZUFsbCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBoaWRlQWxsKCk7CiAgICAgICB9LAoKICAgICAgIAogICAgICAgcmVnaXN0ZXIgOiBmdW5jdGlvbihtZW51KXsKICAgICAgICAgICBpZighbWVudXMpewogICAgICAgICAgICAgICBpbml0KCk7CiAgICAgICAgICAgfQogICAgICAgICAgIG1lbnVzW21lbnUuaWRdID0gbWVudTsKICAgICAgICAgICBtZW51Lm9uKHsKICAgICAgICAgICAgICAgYmVmb3JlaGlkZTogb25CZWZvcmVIaWRlLAogICAgICAgICAgICAgICBoaWRlOiBvbkhpZGUsCiAgICAgICAgICAgICAgIGJlZm9yZXNob3c6IG9uQmVmb3JlU2hvdywKICAgICAgICAgICAgICAgc2hvdzogb25TaG93CiAgICAgICAgICAgfSk7CiAgICAgICB9LAoKICAgICAgICAKICAgICAgIGdldCA6IGZ1bmN0aW9uKG1lbnUpewogICAgICAgICAgIGlmKHR5cGVvZiBtZW51ID09ICJzdHJpbmciKXsgCiAgICAgICAgICAgICAgIGlmKCFtZW51cyl7ICAKICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIHJldHVybiBtZW51c1ttZW51XTsKICAgICAgICAgICB9ZWxzZSBpZihtZW51LmV2ZW50cyl7ICAKICAgICAgICAgICAgICAgcmV0dXJuIG1lbnU7CiAgICAgICAgICAgfWVsc2UgaWYodHlwZW9mIG1lbnUubGVuZ3RoID09ICdudW1iZXInKXsgCiAgICAgICAgICAgICAgIHJldHVybiBuZXcgRXh0Lm1lbnUuTWVudSh7aXRlbXM6bWVudX0pOwogICAgICAgICAgIH1lbHNleyAKICAgICAgICAgICAgICAgcmV0dXJuIEV4dC5jcmVhdGUobWVudSwgJ21lbnUnKTsKICAgICAgICAgICB9CiAgICAgICB9LAoKICAgICAgIAogICAgICAgdW5yZWdpc3RlciA6IGZ1bmN0aW9uKG1lbnUpewogICAgICAgICAgIGRlbGV0ZSBtZW51c1ttZW51LmlkXTsKICAgICAgICAgICBtZW51LnVuKCJiZWZvcmVoaWRlIiwgb25CZWZvcmVIaWRlKTsKICAgICAgICAgICBtZW51LnVuKCJoaWRlIiwgb25IaWRlKTsKICAgICAgICAgICBtZW51LnVuKCJiZWZvcmVzaG93Iiwgb25CZWZvcmVTaG93KTsKICAgICAgICAgICBtZW51LnVuKCJzaG93Iiwgb25TaG93KTsKICAgICAgIH0sCgogICAgICAgCiAgICAgICByZWdpc3RlckNoZWNrYWJsZSA6IGZ1bmN0aW9uKG1lbnVJdGVtKXsKICAgICAgICAgICB2YXIgZyA9IG1lbnVJdGVtLmdyb3VwOwogICAgICAgICAgIGlmKGcpewogICAgICAgICAgICAgICBpZighZ3JvdXBzW2ddKXsKICAgICAgICAgICAgICAgICAgIGdyb3Vwc1tnXSA9IFtdOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIGdyb3Vwc1tnXS5wdXNoKG1lbnVJdGVtKTsKICAgICAgICAgICB9CiAgICAgICB9LAoKICAgICAgIAogICAgICAgdW5yZWdpc3RlckNoZWNrYWJsZSA6IGZ1bmN0aW9uKG1lbnVJdGVtKXsKICAgICAgICAgICB2YXIgZyA9IG1lbnVJdGVtLmdyb3VwOwogICAgICAgICAgIGlmKGcpewogICAgICAgICAgICAgICBncm91cHNbZ10ucmVtb3ZlKG1lbnVJdGVtKTsKICAgICAgICAgICB9CiAgICAgICB9LAogICAgICAgCiAgICAgICAKICAgICAgIG9uQ2hlY2tDaGFuZ2U6IGZ1bmN0aW9uKGl0ZW0sIHN0YXRlKXsKICAgICAgICAgICBpZihpdGVtLmdyb3VwICYmIHN0YXRlKXsKICAgICAgICAgICAgICAgdmFyIGdyb3VwID0gZ3JvdXBzW2l0ZW0uZ3JvdXBdLAogICAgICAgICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgICAgICAgICBsZW4gPSBncm91cC5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICBjdXJyZW50OwogICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgIGZvcig7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gZ3JvdXBbaV07CiAgICAgICAgICAgICAgICAgICBpZihjdXJyZW50ICE9IGl0ZW0pewogICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQuc2V0Q2hlY2tlZChmYWxzZSk7CiAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIH0KICAgICAgICAgICB9CiAgICAgICB9LAoKICAgICAgIGdldENoZWNrZWRJdGVtIDogZnVuY3Rpb24oZ3JvdXBJZCl7CiAgICAgICAgICAgdmFyIGcgPSBncm91cHNbZ3JvdXBJZF07CiAgICAgICAgICAgaWYoZyl7CiAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGwgPSBnLmxlbmd0aDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgICAgICAgICBpZihnW2ldLmNoZWNrZWQpewogICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnW2ldOwogICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICB9CiAgICAgICAgICAgfQogICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgfSwKCiAgICAgICBzZXRDaGVja2VkSXRlbSA6IGZ1bmN0aW9uKGdyb3VwSWQsIGl0ZW1JZCl7CiAgICAgICAgICAgdmFyIGcgPSBncm91cHNbZ3JvdXBJZF07CiAgICAgICAgICAgaWYoZyl7CiAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGwgPSBnLmxlbmd0aDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgICAgICAgICBpZihnW2ldLmlkID09IGl0ZW1JZCl7CiAgICAgICAgICAgICAgICAgICAgICAgZ1tpXS5zZXRDaGVja2VkKHRydWUpOwogICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICB9CiAgICAgICAgICAgfQogICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgfQogICB9Owp9KCk7CgpFeHQubWVudS5CYXNlSXRlbSA9IEV4dC5leHRlbmQoRXh0LkNvbXBvbmVudCwgewogICAgCiAgICAKICAgIAogICAgCiAgICBjYW5BY3RpdmF0ZSA6IGZhbHNlLAogICAgCiAgICBhY3RpdmVDbGFzcyA6ICJ4LW1lbnUtaXRlbS1hY3RpdmUiLAogICAgCiAgICBoaWRlT25DbGljayA6IHRydWUsCiAgICAKICAgIGNsaWNrSGlkZURlbGF5IDogMSwKCiAgICAKICAgIGN0eXBlIDogIkV4dC5tZW51LkJhc2VJdGVtIiwKCiAgICAKICAgIGFjdGlvbk1vZGUgOiAiY29udGFpbmVyIiwKCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQubWVudS5CYXNlSXRlbS5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICdjbGljaycsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYWN0aXZhdGUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2RlYWN0aXZhdGUnCiAgICAgICAgKTsKICAgICAgICBpZih0aGlzLmhhbmRsZXIpewogICAgICAgICAgICB0aGlzLm9uKCJjbGljayIsIHRoaXMuaGFuZGxlciwgdGhpcy5zY29wZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY29udGFpbmVyLCBwb3NpdGlvbil7CiAgICAgICAgRXh0Lm1lbnUuQmFzZUl0ZW0uc3VwZXJjbGFzcy5vblJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGlmKHRoaXMub3duZXJDdCAmJiB0aGlzLm93bmVyQ3QgaW5zdGFuY2VvZiBFeHQubWVudS5NZW51KXsKICAgICAgICAgICAgdGhpcy5wYXJlbnRNZW51ID0gdGhpcy5vd25lckN0OwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hZGRDbGFzcygneC1tZW51LWxpc3QtaXRlbScpOwogICAgICAgICAgICB0aGlzLm1vbih0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgICAgIGNsaWNrOiB0aGlzLm9uQ2xpY2ssCiAgICAgICAgICAgICAgICBtb3VzZWVudGVyOiB0aGlzLmFjdGl2YXRlLAogICAgICAgICAgICAgICAgbW91c2VsZWF2ZTogdGhpcy5kZWFjdGl2YXRlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRIYW5kbGVyIDogZnVuY3Rpb24oaGFuZGxlciwgc2NvcGUpewogICAgICAgIGlmKHRoaXMuaGFuZGxlcil7CiAgICAgICAgICAgIHRoaXMudW4oImNsaWNrIiwgdGhpcy5oYW5kbGVyLCB0aGlzLnNjb3BlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5vbigiY2xpY2siLCB0aGlzLmhhbmRsZXIgPSBoYW5kbGVyLCB0aGlzLnNjb3BlID0gc2NvcGUpOwogICAgfSwKCiAgICAKICAgIG9uQ2xpY2sgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZighdGhpcy5kaXNhYmxlZCAmJiB0aGlzLmZpcmVFdmVudCgiY2xpY2siLCB0aGlzLCBlKSAhPT0gZmFsc2UKICAgICAgICAgICAgICAgICYmICh0aGlzLnBhcmVudE1lbnUgJiYgdGhpcy5wYXJlbnRNZW51LmZpcmVFdmVudCgiaXRlbWNsaWNrIiwgdGhpcywgZSkgIT09IGZhbHNlKSl7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2xpY2soZSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFjdGl2YXRlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmRpc2FibGVkKXsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICB2YXIgbGkgPSB0aGlzLmNvbnRhaW5lcjsKICAgICAgICBsaS5hZGRDbGFzcyh0aGlzLmFjdGl2ZUNsYXNzKTsKICAgICAgICB0aGlzLnJlZ2lvbiA9IGxpLmdldFJlZ2lvbigpLmFkanVzdCgyLCAyLCAtMiwgLTIpOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCJhY3RpdmF0ZSIsIHRoaXMpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAKICAgIGRlYWN0aXZhdGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNsYXNzKHRoaXMuYWN0aXZlQ2xhc3MpOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCJkZWFjdGl2YXRlIiwgdGhpcyk7CiAgICB9LAoKICAgIAogICAgc2hvdWxkRGVhY3RpdmF0ZSA6IGZ1bmN0aW9uKGUpewogICAgICAgIHJldHVybiAhdGhpcy5yZWdpb24gfHwgIXRoaXMucmVnaW9uLmNvbnRhaW5zKGUuZ2V0UG9pbnQoKSk7CiAgICB9LAoKICAgIAogICAgaGFuZGxlQ2xpY2sgOiBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgcG0gPSB0aGlzLnBhcmVudE1lbnU7CiAgICAgICAgaWYodGhpcy5oaWRlT25DbGljayl7CiAgICAgICAgICAgIGlmKHBtLmZsb2F0aW5nKXsKICAgICAgICAgICAgICAgIHRoaXMuY2xpY2tIaWRlRGVsYXlUaW1lciA9IHBtLmhpZGUuZGVmZXIodGhpcy5jbGlja0hpZGVEZWxheSwgcG0sIFt0cnVlXSk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgcG0uZGVhY3RpdmF0ZUFjdGl2ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKICAgIAogICAgYmVmb3JlRGVzdHJveTogZnVuY3Rpb24oKXsKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5jbGlja0hpZGVEZWxheVRpbWVyKTsKICAgICAgICBFeHQubWVudS5CYXNlSXRlbS5zdXBlcmNsYXNzLmJlZm9yZURlc3Ryb3kuY2FsbCh0aGlzKTsgICAgCiAgICB9LAoKICAgIAogICAgZXhwYW5kTWVudSA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgaGlkZU1lbnUgOiBFeHQuZW1wdHlGbgp9KTsKRXh0LnJlZygnbWVudWJhc2VpdGVtJywgRXh0Lm1lbnUuQmFzZUl0ZW0pOwpFeHQubWVudS5UZXh0SXRlbSA9IEV4dC5leHRlbmQoRXh0Lm1lbnUuQmFzZUl0ZW0sIHsKICAgIAogICAgCiAgICBoaWRlT25DbGljayA6IGZhbHNlLAogICAgCiAgICBpdGVtQ2xzIDogIngtbWVudS10ZXh0IiwKICAgIAogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyA9PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25maWcgPSB7CiAgICAgICAgICAgICAgICB0ZXh0OiBjb25maWcKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgRXh0Lm1lbnUuVGV4dEl0ZW0uc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGNvbmZpZyk7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgICBzLmNsYXNzTmFtZSA9IHRoaXMuaXRlbUNsczsKICAgICAgICBzLmlubmVySFRNTCA9IHRoaXMudGV4dDsKICAgICAgICB0aGlzLmVsID0gczsKICAgICAgICBFeHQubWVudS5UZXh0SXRlbS5zdXBlcmNsYXNzLm9uUmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9Cn0pOwpFeHQucmVnKCdtZW51dGV4dGl0ZW0nLCBFeHQubWVudS5UZXh0SXRlbSk7CkV4dC5tZW51LlNlcGFyYXRvciA9IEV4dC5leHRlbmQoRXh0Lm1lbnUuQmFzZUl0ZW0sIHsKICAgIAogICAgaXRlbUNscyA6ICJ4LW1lbnUtc2VwIiwKICAgIAogICAgaGlkZU9uQ2xpY2sgOiBmYWxzZSwKICAgIAogICAgCiAgICBhY3RpdmVDbGFzczogJycsCgogICAgCiAgICBvblJlbmRlciA6IGZ1bmN0aW9uKGxpKXsKICAgICAgICB2YXIgcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgICBzLmNsYXNzTmFtZSA9IHRoaXMuaXRlbUNsczsKICAgICAgICBzLmlubmVySFRNTCA9ICImIzE2MDsiOwogICAgICAgIHRoaXMuZWwgPSBzOwogICAgICAgIGxpLmFkZENsYXNzKCJ4LW1lbnUtc2VwLWxpIik7CiAgICAgICAgRXh0Lm1lbnUuU2VwYXJhdG9yLnN1cGVyY2xhc3Mub25SZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KfSk7CkV4dC5yZWcoJ21lbnVzZXBhcmF0b3InLCBFeHQubWVudS5TZXBhcmF0b3IpOwpFeHQubWVudS5JdGVtID0gRXh0LmV4dGVuZChFeHQubWVudS5CYXNlSXRlbSwgewogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIGl0ZW1DbHMgOiAneC1tZW51LWl0ZW0nLAogICAgCiAgICBjYW5BY3RpdmF0ZSA6IHRydWUsCiAgICAKICAgIHNob3dEZWxheTogMjAwLAogICAgCiAgICAKICAgIGFsdFRleHQ6ICcnLAogICAgCiAgICAKICAgIGhpZGVEZWxheTogMjAwLAoKICAgIAogICAgY3R5cGU6ICdFeHQubWVudS5JdGVtJywKCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQubWVudS5JdGVtLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIGlmKHRoaXMubWVudSl7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEV4dC5pc0FycmF5KHRoaXMubWVudSkpewogICAgICAgICAgICAgICAgdGhpcy5tZW51ID0geyBpdGVtczogdGhpcy5tZW51IH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKEV4dC5pc09iamVjdCh0aGlzLm1lbnUpKXsKICAgICAgICAgICAgICAgIHRoaXMubWVudS5vd25lckN0ID0gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5tZW51ID0gRXh0Lm1lbnUuTWVudU1nci5nZXQodGhpcy5tZW51KTsKICAgICAgICAgICAgdGhpcy5tZW51Lm93bmVyQ3QgPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY29udGFpbmVyLCBwb3NpdGlvbil7CiAgICAgICAgaWYgKCF0aGlzLml0ZW1UcGwpIHsKICAgICAgICAgICAgdGhpcy5pdGVtVHBsID0gRXh0Lm1lbnUuSXRlbS5wcm90b3R5cGUuaXRlbVRwbCA9IG5ldyBFeHQuWFRlbXBsYXRlKAogICAgICAgICAgICAgICAgJzxhIGlkPSJ7aWR9IiBjbGFzcz0ie2Nsc30iIGhpZGVmb2N1cz0idHJ1ZSIgdW5zZWxlY3RhYmxlPSJvbiIgaHJlZj0ie2hyZWZ9IicsCiAgICAgICAgICAgICAgICAgICAgJzx0cGwgaWY9ImhyZWZUYXJnZXQiPicsCiAgICAgICAgICAgICAgICAgICAgICAgICcgdGFyZ2V0PSJ7aHJlZlRhcmdldH0iJywKICAgICAgICAgICAgICAgICAgICAnPC90cGw+JywKICAgICAgICAgICAgICAgICAnPicsCiAgICAgICAgICAgICAgICAgICAgICc8aW1nIGFsdD0ie2FsdFRleHR9IiBzcmM9IntpY29ufSIgY2xhc3M9IngtbWVudS1pdGVtLWljb24ge2ljb25DbHN9Ii8+JywKICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPSJ4LW1lbnUtaXRlbS10ZXh0Ij57dGV4dH08L3NwYW4+JywKICAgICAgICAgICAgICAgICAnPC9hPicKICAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHZhciBhID0gdGhpcy5nZXRUZW1wbGF0ZUFyZ3MoKTsKICAgICAgICB0aGlzLmVsID0gcG9zaXRpb24gPyB0aGlzLml0ZW1UcGwuaW5zZXJ0QmVmb3JlKHBvc2l0aW9uLCBhLCB0cnVlKSA6IHRoaXMuaXRlbVRwbC5hcHBlbmQoY29udGFpbmVyLCBhLCB0cnVlKTsKICAgICAgICB0aGlzLmljb25FbCA9IHRoaXMuZWwuY2hpbGQoJ2ltZy54LW1lbnUtaXRlbS1pY29uJyk7CiAgICAgICAgdGhpcy50ZXh0RWwgPSB0aGlzLmVsLmNoaWxkKCcueC1tZW51LWl0ZW0tdGV4dCcpOwogICAgICAgIGlmKCF0aGlzLmhyZWYpIHsgCiAgICAgICAgICAgIHRoaXMubW9uKHRoaXMuZWwsICdjbGljaycsIEV4dC5lbXB0eUZuLCBudWxsLCB7IHByZXZlbnREZWZhdWx0OiB0cnVlIH0pOwogICAgICAgIH0KICAgICAgICBFeHQubWVudS5JdGVtLnN1cGVyY2xhc3Mub25SZW5kZXIuY2FsbCh0aGlzLCBjb250YWluZXIsIHBvc2l0aW9uKTsKICAgIH0sCgogICAgZ2V0VGVtcGxhdGVBcmdzOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBpZDogdGhpcy5pZCwKICAgICAgICAgICAgY2xzOiB0aGlzLml0ZW1DbHMgKyAodGhpcy5tZW51ID8gICcgeC1tZW51LWl0ZW0tYXJyb3cnIDogJycpICsgKHRoaXMuY2xzID8gICcgJyArIHRoaXMuY2xzIDogJycpLAogICAgICAgICAgICBocmVmOiB0aGlzLmhyZWYgfHwgJyMnLAogICAgICAgICAgICBocmVmVGFyZ2V0OiB0aGlzLmhyZWZUYXJnZXQsCiAgICAgICAgICAgIGljb246IHRoaXMuaWNvbiB8fCBFeHQuQkxBTktfSU1BR0VfVVJMLAogICAgICAgICAgICBpY29uQ2xzOiB0aGlzLmljb25DbHMgfHwgJycsCiAgICAgICAgICAgIHRleHQ6IHRoaXMuaXRlbVRleHR8fHRoaXMudGV4dHx8JyYjMTYwOycsCiAgICAgICAgICAgIGFsdFRleHQ6IHRoaXMuYWx0VGV4dCB8fCAnJwogICAgICAgIH07CiAgICB9LAoKICAgIAogICAgc2V0VGV4dCA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgIHRoaXMudGV4dCA9IHRleHR8fCcmIzE2MDsnOwogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLnRleHRFbC51cGRhdGUodGhpcy50ZXh0KTsKICAgICAgICAgICAgdGhpcy5wYXJlbnRNZW51LmxheW91dC5kb0F1dG9TaXplKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNldEljb25DbGFzcyA6IGZ1bmN0aW9uKGNscyl7CiAgICAgICAgdmFyIG9sZENscyA9IHRoaXMuaWNvbkNsczsKICAgICAgICB0aGlzLmljb25DbHMgPSBjbHM7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuaWNvbkVsLnJlcGxhY2VDbGFzcyhvbGRDbHMsIHRoaXMuaWNvbkNscyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGJlZm9yZURlc3Ryb3k6IGZ1bmN0aW9uKCl7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuc2hvd1RpbWVyKTsKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5oaWRlVGltZXIpOwogICAgICAgIGlmICh0aGlzLm1lbnUpewogICAgICAgICAgICBkZWxldGUgdGhpcy5tZW51Lm93bmVyQ3Q7CiAgICAgICAgICAgIHRoaXMubWVudS5kZXN0cm95KCk7CiAgICAgICAgfQogICAgICAgIEV4dC5tZW51Lkl0ZW0uc3VwZXJjbGFzcy5iZWZvcmVEZXN0cm95LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgaGFuZGxlQ2xpY2sgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZighdGhpcy5ocmVmKXsgCiAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgfQogICAgICAgIEV4dC5tZW51Lkl0ZW0uc3VwZXJjbGFzcy5oYW5kbGVDbGljay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAKICAgIGFjdGl2YXRlIDogZnVuY3Rpb24oYXV0b0V4cGFuZCl7CiAgICAgICAgaWYoRXh0Lm1lbnUuSXRlbS5zdXBlcmNsYXNzLmFjdGl2YXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpewogICAgICAgICAgICB0aGlzLmZvY3VzKCk7CiAgICAgICAgICAgIGlmKGF1dG9FeHBhbmQpewogICAgICAgICAgICAgICAgdGhpcy5leHBhbmRNZW51KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIAogICAgc2hvdWxkRGVhY3RpdmF0ZSA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKEV4dC5tZW51Lkl0ZW0uc3VwZXJjbGFzcy5zaG91bGREZWFjdGl2YXRlLmNhbGwodGhpcywgZSkpewogICAgICAgICAgICBpZih0aGlzLm1lbnUgJiYgdGhpcy5tZW51LmlzVmlzaWJsZSgpKXsKICAgICAgICAgICAgICAgIHJldHVybiAhdGhpcy5tZW51LmdldEVsKCkuZ2V0UmVnaW9uKCkuY29udGFpbnMoZS5nZXRQb2ludCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAKICAgIGRlYWN0aXZhdGUgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5tZW51Lkl0ZW0uc3VwZXJjbGFzcy5kZWFjdGl2YXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy5oaWRlTWVudSgpOwogICAgfSwKCiAgICAKICAgIGV4cGFuZE1lbnUgOiBmdW5jdGlvbihhdXRvQWN0aXZhdGUpewogICAgICAgIGlmKCF0aGlzLmRpc2FibGVkICYmIHRoaXMubWVudSl7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmhpZGVUaW1lcik7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmhpZGVUaW1lcjsKICAgICAgICAgICAgaWYoIXRoaXMubWVudS5pc1Zpc2libGUoKSAmJiAhdGhpcy5zaG93VGltZXIpewogICAgICAgICAgICAgICAgdGhpcy5zaG93VGltZXIgPSB0aGlzLmRlZmVyRXhwYW5kLmRlZmVyKHRoaXMuc2hvd0RlbGF5LCB0aGlzLCBbYXV0b0FjdGl2YXRlXSk7CiAgICAgICAgICAgIH1lbHNlIGlmICh0aGlzLm1lbnUuaXNWaXNpYmxlKCkgJiYgYXV0b0FjdGl2YXRlKXsKICAgICAgICAgICAgICAgIHRoaXMubWVudS50cnlBY3RpdmF0ZSgwLCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBkZWZlckV4cGFuZCA6IGZ1bmN0aW9uKGF1dG9BY3RpdmF0ZSl7CiAgICAgICAgZGVsZXRlIHRoaXMuc2hvd1RpbWVyOwogICAgICAgIHRoaXMubWVudS5zaG93KHRoaXMuY29udGFpbmVyLCB0aGlzLnBhcmVudE1lbnUuc3ViTWVudUFsaWduIHx8ICd0bC10cj8nLCB0aGlzLnBhcmVudE1lbnUpOwogICAgICAgIGlmKGF1dG9BY3RpdmF0ZSl7CiAgICAgICAgICAgIHRoaXMubWVudS50cnlBY3RpdmF0ZSgwLCAxKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaGlkZU1lbnUgOiBmdW5jdGlvbigpewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnNob3dUaW1lcik7CiAgICAgICAgZGVsZXRlIHRoaXMuc2hvd1RpbWVyOwogICAgICAgIGlmKCF0aGlzLmhpZGVUaW1lciAmJiB0aGlzLm1lbnUgJiYgdGhpcy5tZW51LmlzVmlzaWJsZSgpKXsKICAgICAgICAgICAgdGhpcy5oaWRlVGltZXIgPSB0aGlzLmRlZmVySGlkZS5kZWZlcih0aGlzLmhpZGVEZWxheSwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRlZmVySGlkZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgZGVsZXRlIHRoaXMuaGlkZVRpbWVyOwogICAgICAgIGlmKHRoaXMubWVudS5vdmVyKXsKICAgICAgICAgICAgdGhpcy5wYXJlbnRNZW51LnNldEFjdGl2ZUl0ZW0odGhpcywgZmFsc2UpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLm1lbnUuaGlkZSgpOwogICAgICAgIH0KICAgIH0KfSk7CkV4dC5yZWcoJ21lbnVpdGVtJywgRXh0Lm1lbnUuSXRlbSk7CkV4dC5tZW51LkNoZWNrSXRlbSA9IEV4dC5leHRlbmQoRXh0Lm1lbnUuSXRlbSwgewogICAgCiAgICAKICAgIGl0ZW1DbHMgOiAieC1tZW51LWl0ZW0geC1tZW51LWNoZWNrLWl0ZW0iLAogICAgCiAgICBncm91cENsYXNzIDogIngtbWVudS1ncm91cC1pdGVtIiwKCiAgICAKICAgIGNoZWNrZWQ6IGZhbHNlLAoKICAgIAogICAgY3R5cGU6ICJFeHQubWVudS5DaGVja0l0ZW0iLAogICAgCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQubWVudS5DaGVja0l0ZW0uc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CgkgICAgdGhpcy5hZGRFdmVudHMoCgkgICAgICAgIAoJICAgICAgICAiYmVmb3JlY2hlY2tjaGFuZ2UiICwKCSAgICAgICAgCgkgICAgICAgICJjaGVja2NoYW5nZSIKCSAgICApOwoJICAgIAoJICAgIGlmKHRoaXMuY2hlY2tIYW5kbGVyKXsKCSAgICAgICAgdGhpcy5vbignY2hlY2tjaGFuZ2UnLCB0aGlzLmNoZWNrSGFuZGxlciwgdGhpcy5zY29wZSk7CgkgICAgfQoJICAgIEV4dC5tZW51Lk1lbnVNZ3IucmVnaXN0ZXJDaGVja2FibGUodGhpcyk7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjKXsKICAgICAgICBFeHQubWVudS5DaGVja0l0ZW0uc3VwZXJjbGFzcy5vblJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGlmKHRoaXMuZ3JvdXApewogICAgICAgICAgICB0aGlzLmVsLmFkZENsYXNzKHRoaXMuZ3JvdXBDbGFzcyk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuY2hlY2tlZCl7CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNldENoZWNrZWQodHJ1ZSwgdHJ1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5tZW51Lk1lbnVNZ3IudW5yZWdpc3RlckNoZWNrYWJsZSh0aGlzKTsKICAgICAgICBFeHQubWVudS5DaGVja0l0ZW0uc3VwZXJjbGFzcy5kZXN0cm95LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIAogICAgc2V0Q2hlY2tlZCA6IGZ1bmN0aW9uKHN0YXRlLCBzdXBwcmVzc0V2ZW50KXsKICAgICAgICB2YXIgc3VwcHJlc3MgPSBzdXBwcmVzc0V2ZW50ID09PSB0cnVlOwogICAgICAgIGlmKHRoaXMuY2hlY2tlZCAhPSBzdGF0ZSAmJiAoc3VwcHJlc3MgfHwgdGhpcy5maXJlRXZlbnQoImJlZm9yZWNoZWNrY2hhbmdlIiwgdGhpcywgc3RhdGUpICE9PSBmYWxzZSkpewogICAgICAgICAgICBFeHQubWVudS5NZW51TWdyLm9uQ2hlY2tDaGFuZ2UodGhpcywgc3RhdGUpOwogICAgICAgICAgICBpZih0aGlzLmNvbnRhaW5lcil7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lcltzdGF0ZSA/ICJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiXSgieC1tZW51LWl0ZW0tY2hlY2tlZCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IHN0YXRlOwogICAgICAgICAgICBpZighc3VwcHJlc3MpewogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImNoZWNrY2hhbmdlIiwgdGhpcywgc3RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGhhbmRsZUNsaWNrIDogZnVuY3Rpb24oZSl7CiAgICAgICBpZighdGhpcy5kaXNhYmxlZCAmJiAhKHRoaXMuY2hlY2tlZCAmJiB0aGlzLmdyb3VwKSl7CiAgICAgICAgICAgdGhpcy5zZXRDaGVja2VkKCF0aGlzLmNoZWNrZWQpOwogICAgICAgfQogICAgICAgRXh0Lm1lbnUuQ2hlY2tJdGVtLnN1cGVyY2xhc3MuaGFuZGxlQ2xpY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KfSk7CkV4dC5yZWcoJ21lbnVjaGVja2l0ZW0nLCBFeHQubWVudS5DaGVja0l0ZW0pOwogRXh0Lm1lbnUuRGF0ZU1lbnUgPSBFeHQuZXh0ZW5kKEV4dC5tZW51Lk1lbnUsIHsKICAgIAogICAgZW5hYmxlU2Nyb2xsaW5nIDogZmFsc2UsCiAgICAKICAgICAgICAKICAgIAogICAgaGlkZU9uQ2xpY2sgOiB0cnVlLAogICAgCiAgICAKICAgIHBpY2tlcklkIDogbnVsbCwKICAgIAogICAgCiAgICAKICAgIAogICAgY2xzIDogJ3gtZGF0ZS1tZW51JywKICAgIAogICAgCiAgICAKICAgIAoKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMub24oJ2JlZm9yZXNob3cnLCB0aGlzLm9uQmVmb3JlU2hvdywgdGhpcyk7CiAgICAgICAgaWYodGhpcy5zdHJpY3QgPSAoRXh0LmlzSUU3ICYmIEV4dC5pc1N0cmljdCkpewogICAgICAgICAgICB0aGlzLm9uKCdzaG93JywgdGhpcy5vblNob3csIHRoaXMsIHtzaW5nbGU6IHRydWUsIGRlbGF5OiAyMH0pOwogICAgICAgIH0KICAgICAgICBFeHQuYXBwbHkodGhpcywgewogICAgICAgICAgICBwbGFpbjogdHJ1ZSwKICAgICAgICAgICAgc2hvd1NlcGFyYXRvcjogZmFsc2UsCiAgICAgICAgICAgIGl0ZW1zOiB0aGlzLnBpY2tlciA9IG5ldyBFeHQuRGF0ZVBpY2tlcihFeHQuYXBwbHlJZih7CiAgICAgICAgICAgICAgICBpbnRlcm5hbFJlbmRlcjogdGhpcy5zdHJpY3QgfHwgIUV4dC5pc0lFLAogICAgICAgICAgICAgICAgY3RDbHM6ICd4LW1lbnUtZGF0ZS1pdGVtJywKICAgICAgICAgICAgICAgIGlkOiB0aGlzLnBpY2tlcklkCiAgICAgICAgICAgIH0sIHRoaXMuaW5pdGlhbENvbmZpZykpCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5waWNrZXIucHVyZ2VMaXN0ZW5lcnMoKTsKICAgICAgICBFeHQubWVudS5EYXRlTWVudS5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKICAgICAgICAKICAgICAgICB0aGlzLnJlbGF5RXZlbnRzKHRoaXMucGlja2VyLCBbJ3NlbGVjdCddKTsKICAgICAgICB0aGlzLm9uKCdzaG93JywgdGhpcy5waWNrZXIuZm9jdXMsIHRoaXMucGlja2VyKTsKICAgICAgICB0aGlzLm9uKCdzZWxlY3QnLCB0aGlzLm1lbnVIaWRlLCB0aGlzKTsKICAgICAgICBpZih0aGlzLmhhbmRsZXIpewogICAgICAgICAgICB0aGlzLm9uKCdzZWxlY3QnLCB0aGlzLmhhbmRsZXIsIHRoaXMuc2NvcGUgfHwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBtZW51SGlkZSA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmKHRoaXMuaGlkZU9uQ2xpY2spewogICAgICAgICAgICB0aGlzLmhpZGUodHJ1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICBvbkJlZm9yZVNob3cgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMucGlja2VyKXsKICAgICAgICAgICAgdGhpcy5waWNrZXIuaGlkZU1vbnRoUGlja2VyKHRydWUpOwogICAgICAgIH0KICAgIH0sCgogICAgb25TaG93IDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgZWwgPSB0aGlzLnBpY2tlci5nZXRFbCgpOwogICAgICAgIGVsLnNldFdpZHRoKGVsLmdldFdpZHRoKCkpOyAKICAgIH0KIH0pOwogRXh0LnJlZygnZGF0ZW1lbnUnLCBFeHQubWVudS5EYXRlTWVudSk7CiAKIEV4dC5tZW51LkNvbG9yTWVudSA9IEV4dC5leHRlbmQoRXh0Lm1lbnUuTWVudSwgewogICAgCiAgICBlbmFibGVTY3JvbGxpbmcgOiBmYWxzZSwKICAgIAogICAgICAgIAogICAgCiAgICAKICAgIGhpZGVPbkNsaWNrIDogdHJ1ZSwKICAgIAogICAgY2xzIDogJ3gtY29sb3ItbWVudScsCiAgICAKICAgIAogICAgcGFsZXR0ZUlkIDogbnVsbCwKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmFwcGx5KHRoaXMsIHsKICAgICAgICAgICAgcGxhaW46IHRydWUsCiAgICAgICAgICAgIHNob3dTZXBhcmF0b3I6IGZhbHNlLAogICAgICAgICAgICBpdGVtczogdGhpcy5wYWxldHRlID0gbmV3IEV4dC5Db2xvclBhbGV0dGUoRXh0LmFwcGx5SWYoewogICAgICAgICAgICAgICAgaWQ6IHRoaXMucGFsZXR0ZUlkCiAgICAgICAgICAgIH0sIHRoaXMuaW5pdGlhbENvbmZpZykpCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5wYWxldHRlLnB1cmdlTGlzdGVuZXJzKCk7CiAgICAgICAgRXh0Lm1lbnUuQ29sb3JNZW51LnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIAogICAgICAgIHRoaXMucmVsYXlFdmVudHModGhpcy5wYWxldHRlLCBbJ3NlbGVjdCddKTsKICAgICAgICB0aGlzLm9uKCdzZWxlY3QnLCB0aGlzLm1lbnVIaWRlLCB0aGlzKTsKICAgICAgICBpZih0aGlzLmhhbmRsZXIpewogICAgICAgICAgICB0aGlzLm9uKCdzZWxlY3QnLCB0aGlzLmhhbmRsZXIsIHRoaXMuc2NvcGUgfHwgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBtZW51SGlkZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5oaWRlT25DbGljayl7CiAgICAgICAgICAgIHRoaXMuaGlkZSh0cnVlKTsKICAgICAgICB9CiAgICB9Cn0pOwpFeHQucmVnKCdjb2xvcm1lbnUnLCBFeHQubWVudS5Db2xvck1lbnUpOwoKRXh0LmZvcm0uRmllbGQgPSBFeHQuZXh0ZW5kKEV4dC5Cb3hDb21wb25lbnQsICB7CiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCgogICAgCiAgICBpbnZhbGlkQ2xhc3MgOiAneC1mb3JtLWludmFsaWQnLAogICAgCiAgICBpbnZhbGlkVGV4dCA6ICdUaGUgdmFsdWUgaW4gdGhpcyBmaWVsZCBpcyBpbnZhbGlkJywKICAgIAogICAgZm9jdXNDbGFzcyA6ICd4LWZvcm0tZm9jdXMnLAogICAgCiAgICAKICAgIHZhbGlkYXRpb25FdmVudCA6ICdrZXl1cCcsCiAgICAKICAgIHZhbGlkYXRlT25CbHVyIDogdHJ1ZSwKICAgIAogICAgdmFsaWRhdGlvbkRlbGF5IDogMjUwLAogICAgCiAgICBkZWZhdWx0QXV0b0NyZWF0ZSA6IHt0YWc6ICdpbnB1dCcsIHR5cGU6ICd0ZXh0Jywgc2l6ZTogJzIwJywgYXV0b2NvbXBsZXRlOiAnb2ZmJ30sCiAgICAKICAgIGZpZWxkQ2xhc3MgOiAneC1mb3JtLWZpZWxkJywKICAgIAogICAgbXNnVGFyZ2V0IDogJ3F0aXAnLAogICAgCiAgICBtc2dGeCA6ICdub3JtYWwnLAogICAgCiAgICByZWFkT25seSA6IGZhbHNlLAogICAgCiAgICBkaXNhYmxlZCA6IGZhbHNlLAogICAgCiAgICBzdWJtaXRWYWx1ZTogdHJ1ZSwKCiAgICAKICAgIGlzRm9ybUZpZWxkIDogdHJ1ZSwKCiAgICAKICAgIG1zZ0Rpc3BsYXk6ICcnLAoKICAgIAogICAgaGFzRm9jdXMgOiBmYWxzZSwKCiAgICAKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5mb3JtLkZpZWxkLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2ZvY3VzJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdibHVyJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdzcGVjaWFsa2V5JywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjaGFuZ2UnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2ludmFsaWQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ3ZhbGlkJwogICAgICAgICk7CiAgICB9LAoKICAgIAogICAgZ2V0TmFtZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyZWQgJiYgdGhpcy5lbC5kb20ubmFtZSA/IHRoaXMuZWwuZG9tLm5hbWUgOiB0aGlzLm5hbWUgfHwgdGhpcy5pZCB8fCAnJzsKICAgIH0sCgogICAgCiAgICBvblJlbmRlciA6IGZ1bmN0aW9uKGN0LCBwb3NpdGlvbil7CiAgICAgICAgaWYoIXRoaXMuZWwpewogICAgICAgICAgICB2YXIgY2ZnID0gdGhpcy5nZXRBdXRvQ3JlYXRlKCk7CgogICAgICAgICAgICBpZighY2ZnLm5hbWUpewogICAgICAgICAgICAgICAgY2ZnLm5hbWUgPSB0aGlzLm5hbWUgfHwgdGhpcy5pZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLmlucHV0VHlwZSl7CiAgICAgICAgICAgICAgICBjZmcudHlwZSA9IHRoaXMuaW5wdXRUeXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYXV0b0VsID0gY2ZnOwogICAgICAgIH0KICAgICAgICBFeHQuZm9ybS5GaWVsZC5zdXBlcmNsYXNzLm9uUmVuZGVyLmNhbGwodGhpcywgY3QsIHBvc2l0aW9uKTsKICAgICAgICBpZih0aGlzLnN1Ym1pdFZhbHVlID09PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuZWwuZG9tLnJlbW92ZUF0dHJpYnV0ZSgnbmFtZScpOwogICAgICAgIH0KICAgICAgICB2YXIgdHlwZSA9IHRoaXMuZWwuZG9tLnR5cGU7CiAgICAgICAgaWYodHlwZSl7CiAgICAgICAgICAgIGlmKHR5cGUgPT0gJ3Bhc3N3b3JkJyl7CiAgICAgICAgICAgICAgICB0eXBlID0gJ3RleHQnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3MoJ3gtZm9ybS0nK3R5cGUpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnJlYWRPbmx5KXsKICAgICAgICAgICAgdGhpcy5zZXRSZWFkT25seSh0cnVlKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy50YWJJbmRleCAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgdGhpcy5lbC5kb20uc2V0QXR0cmlidXRlKCd0YWJJbmRleCcsIHRoaXMudGFiSW5kZXgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5lbC5hZGRDbGFzcyhbdGhpcy5maWVsZENsYXNzLCB0aGlzLmNsc10pOwogICAgfSwKCiAgICAKICAgIGdldEl0ZW1DdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuaXRlbUN0OwogICAgfSwKCiAgICAKICAgIGluaXRWYWx1ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy52YWx1ZSAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZSh0aGlzLnZhbHVlKTsKICAgICAgICB9ZWxzZSBpZighRXh0LmlzRW1wdHkodGhpcy5lbC5kb20udmFsdWUpICYmIHRoaXMuZWwuZG9tLnZhbHVlICE9IHRoaXMuZW1wdHlUZXh0KXsKICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZSh0aGlzLmVsLmRvbS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMub3JpZ2luYWxWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgIH0sCgogICAgCiAgICBpc0RpcnR5IDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYodGhpcy5kaXNhYmxlZCB8fCAhdGhpcy5yZW5kZXJlZCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBTdHJpbmcodGhpcy5nZXRWYWx1ZSgpKSAhPT0gU3RyaW5nKHRoaXMub3JpZ2luYWxWYWx1ZSk7CiAgICB9LAoKICAgIAogICAgc2V0UmVhZE9ubHkgOiBmdW5jdGlvbihyZWFkT25seSl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuZWwuZG9tLnJlYWRPbmx5ID0gcmVhZE9ubHk7CiAgICAgICAgfQogICAgICAgIHRoaXMucmVhZE9ubHkgPSByZWFkT25seTsKICAgIH0sCgogICAgCiAgICBhZnRlclJlbmRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmZvcm0uRmllbGQuc3VwZXJjbGFzcy5hZnRlclJlbmRlci5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuaW5pdEV2ZW50cygpOwogICAgICAgIHRoaXMuaW5pdFZhbHVlKCk7CiAgICB9LAoKICAgIAogICAgZmlyZUtleSA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKGUuaXNTcGVjaWFsS2V5KCkpewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnc3BlY2lhbGtleScsIHRoaXMsIGUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZXNldCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zZXRWYWx1ZSh0aGlzLm9yaWdpbmFsVmFsdWUpOwogICAgICAgIHRoaXMuY2xlYXJJbnZhbGlkKCk7CiAgICB9LAoKICAgIAogICAgaW5pdEV2ZW50cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5tb24odGhpcy5lbCwgRXh0LkV2ZW50TWFuYWdlci5nZXRLZXlFdmVudCgpLCB0aGlzLmZpcmVLZXksICB0aGlzKTsKICAgICAgICB0aGlzLm1vbih0aGlzLmVsLCAnZm9jdXMnLCB0aGlzLm9uRm9jdXMsIHRoaXMpOwoKICAgICAgICAKICAgICAgICAKICAgICAgICB0aGlzLm1vbih0aGlzLmVsLCAnYmx1cicsIHRoaXMub25CbHVyLCB0aGlzLCB0aGlzLmluRWRpdG9yID8ge2J1ZmZlcjoxMH0gOiBudWxsKTsKICAgIH0sCgogICAgCiAgICBwcmVGb2N1czogRXh0LmVtcHR5Rm4sCgogICAgCiAgICBvbkZvY3VzIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnByZUZvY3VzKCk7CiAgICAgICAgaWYodGhpcy5mb2N1c0NsYXNzKXsKICAgICAgICAgICAgdGhpcy5lbC5hZGRDbGFzcyh0aGlzLmZvY3VzQ2xhc3MpOwogICAgICAgIH0KICAgICAgICBpZighdGhpcy5oYXNGb2N1cyl7CiAgICAgICAgICAgIHRoaXMuaGFzRm9jdXMgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdGFydFZhbHVlID0gdGhpcy5nZXRWYWx1ZSgpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnZm9jdXMnLCB0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYmVmb3JlQmx1ciA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgb25CbHVyIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmJlZm9yZUJsdXIoKTsKICAgICAgICBpZih0aGlzLmZvY3VzQ2xhc3MpewogICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUNsYXNzKHRoaXMuZm9jdXNDbGFzcyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaGFzRm9jdXMgPSBmYWxzZTsKICAgICAgICBpZih0aGlzLnZhbGlkYXRpb25FdmVudCAhPT0gZmFsc2UgJiYgKHRoaXMudmFsaWRhdGVPbkJsdXIgfHwgdGhpcy52YWxpZGF0aW9uRXZlbnQgPT0gJ2JsdXInKSl7CiAgICAgICAgICAgIHRoaXMudmFsaWRhdGUoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHYgPSB0aGlzLmdldFZhbHVlKCk7CiAgICAgICAgaWYoU3RyaW5nKHYpICE9PSBTdHJpbmcodGhpcy5zdGFydFZhbHVlKSl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjaGFuZ2UnLCB0aGlzLCB2LCB0aGlzLnN0YXJ0VmFsdWUpOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgnYmx1cicsIHRoaXMpOwogICAgICAgIHRoaXMucG9zdEJsdXIoKTsKICAgIH0sCgogICAgCiAgICBwb3N0Qmx1ciA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgaXNWYWxpZCA6IGZ1bmN0aW9uKHByZXZlbnRNYXJrKXsKICAgICAgICBpZih0aGlzLmRpc2FibGVkKXsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHZhciByZXN0b3JlID0gdGhpcy5wcmV2ZW50TWFyazsKICAgICAgICB0aGlzLnByZXZlbnRNYXJrID0gcHJldmVudE1hcmsgPT09IHRydWU7CiAgICAgICAgdmFyIHYgPSB0aGlzLnZhbGlkYXRlVmFsdWUodGhpcy5wcm9jZXNzVmFsdWUodGhpcy5nZXRSYXdWYWx1ZSgpKSwgcHJldmVudE1hcmspOwogICAgICAgIHRoaXMucHJldmVudE1hcmsgPSByZXN0b3JlOwogICAgICAgIHJldHVybiB2OwogICAgfSwKCiAgICAKICAgIHZhbGlkYXRlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmRpc2FibGVkIHx8IHRoaXMudmFsaWRhdGVWYWx1ZSh0aGlzLnByb2Nlc3NWYWx1ZSh0aGlzLmdldFJhd1ZhbHVlKCkpKSl7CiAgICAgICAgICAgIHRoaXMuY2xlYXJJbnZhbGlkKCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIAogICAgcHJvY2Vzc1ZhbHVlIDogZnVuY3Rpb24odmFsdWUpewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCgogICAgCiAgICAgdmFsaWRhdGVWYWx1ZSA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgIAogICAgICAgICB2YXIgZXJyb3IgPSB0aGlzLmdldEVycm9ycyh2YWx1ZSlbMF07CgogICAgICAgICBpZiAoZXJyb3IgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgIHRoaXMubWFya0ludmFsaWQoZXJyb3IpOwogICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICB9CiAgICAgfSwKICAgIAogICAgCiAgICBnZXRFcnJvcnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBbXTsKICAgIH0sCgogICAgCiAgICBnZXRBY3RpdmVFcnJvciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuYWN0aXZlRXJyb3IgfHwgJyc7CiAgICB9LAoKICAgIAogICAgbWFya0ludmFsaWQgOiBmdW5jdGlvbihtc2cpewogICAgICAgIAogICAgICAgIGlmICh0aGlzLnJlbmRlcmVkICYmICF0aGlzLnByZXZlbnRNYXJrKSB7CiAgICAgICAgICAgIG1zZyA9IG1zZyB8fCB0aGlzLmludmFsaWRUZXh0OwoKICAgICAgICAgICAgdmFyIG10ID0gdGhpcy5nZXRNZXNzYWdlSGFuZGxlcigpOwogICAgICAgICAgICBpZihtdCl7CiAgICAgICAgICAgICAgICBtdC5tYXJrKHRoaXMsIG1zZyk7CiAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMubXNnVGFyZ2V0KXsKICAgICAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3ModGhpcy5pbnZhbGlkQ2xhc3MpOwogICAgICAgICAgICAgICAgdmFyIHQgPSBFeHQuZ2V0RG9tKHRoaXMubXNnVGFyZ2V0KTsKICAgICAgICAgICAgICAgIGlmKHQpewogICAgICAgICAgICAgICAgICAgIHQuaW5uZXJIVE1MID0gbXNnOwogICAgICAgICAgICAgICAgICAgIHQuc3R5bGUuZGlzcGxheSA9IHRoaXMubXNnRGlzcGxheTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLnNldEFjdGl2ZUVycm9yKG1zZyk7CiAgICB9LAogICAgCiAgICAKICAgIGNsZWFySW52YWxpZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMucmVuZGVyZWQgJiYgIXRoaXMucHJldmVudE1hcmspIHsKICAgICAgICAgICAgdGhpcy5lbC5yZW1vdmVDbGFzcyh0aGlzLmludmFsaWRDbGFzcyk7CiAgICAgICAgICAgIHZhciBtdCA9IHRoaXMuZ2V0TWVzc2FnZUhhbmRsZXIoKTsKICAgICAgICAgICAgaWYobXQpewogICAgICAgICAgICAgICAgbXQuY2xlYXIodGhpcyk7CiAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMubXNnVGFyZ2V0KXsKICAgICAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3ModGhpcy5pbnZhbGlkQ2xhc3MpOwogICAgICAgICAgICAgICAgdmFyIHQgPSBFeHQuZ2V0RG9tKHRoaXMubXNnVGFyZ2V0KTsKICAgICAgICAgICAgICAgIGlmKHQpewogICAgICAgICAgICAgICAgICAgIHQuaW5uZXJIVE1MID0gJyc7CiAgICAgICAgICAgICAgICAgICAgdC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMudW5zZXRBY3RpdmVFcnJvcigpOwogICAgfSwKCiAgICAKICAgIHNldEFjdGl2ZUVycm9yOiBmdW5jdGlvbihtc2csIHN1cHByZXNzRXZlbnQpIHsKICAgICAgICB0aGlzLmFjdGl2ZUVycm9yID0gbXNnOwogICAgICAgIGlmIChzdXBwcmVzc0V2ZW50ICE9PSB0cnVlKSB0aGlzLmZpcmVFdmVudCgnaW52YWxpZCcsIHRoaXMsIG1zZyk7CiAgICB9LAogICAgCiAgICAKICAgIHVuc2V0QWN0aXZlRXJyb3I6IGZ1bmN0aW9uKHN1cHByZXNzRXZlbnQpIHsKICAgICAgICBkZWxldGUgdGhpcy5hY3RpdmVFcnJvcjsKICAgICAgICBpZiAoc3VwcHJlc3NFdmVudCAhPT0gdHJ1ZSkgdGhpcy5maXJlRXZlbnQoJ3ZhbGlkJywgdGhpcyk7CiAgICB9LAoKICAgIAogICAgZ2V0TWVzc2FnZUhhbmRsZXIgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiBFeHQuZm9ybS5NZXNzYWdlVGFyZ2V0c1t0aGlzLm1zZ1RhcmdldF07CiAgICB9LAoKICAgIAogICAgZ2V0RXJyb3JDdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZWwuZmluZFBhcmVudCgnLngtZm9ybS1lbGVtZW50JywgNSwgdHJ1ZSkgfHwgCiAgICAgICAgICAgIHRoaXMuZWwuZmluZFBhcmVudCgnLngtZm9ybS1maWVsZC13cmFwJywgNSwgdHJ1ZSk7ICAgCiAgICB9LAoKICAgIAogICAgYWxpZ25FcnJvckVsIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmVycm9yRWwuc2V0V2lkdGgodGhpcy5nZXRFcnJvckN0KCkuZ2V0V2lkdGgodHJ1ZSkgLSAyMCk7CiAgICB9LAoKICAgIAogICAgYWxpZ25FcnJvckljb24gOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZXJyb3JJY29uLmFsaWduVG8odGhpcy5lbCwgJ3RsLXRyJywgWzIsIDBdKTsKICAgIH0sCgogICAgCiAgICBnZXRSYXdWYWx1ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHYgPSB0aGlzLnJlbmRlcmVkID8gdGhpcy5lbC5nZXRWYWx1ZSgpIDogRXh0LnZhbHVlKHRoaXMudmFsdWUsICcnKTsKICAgICAgICBpZih2ID09PSB0aGlzLmVtcHR5VGV4dCl7CiAgICAgICAgICAgIHYgPSAnJzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHY7CiAgICB9LAoKICAgIAogICAgZ2V0VmFsdWUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLnJlbmRlcmVkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgdiA9IHRoaXMuZWwuZ2V0VmFsdWUoKTsKICAgICAgICBpZih2ID09PSB0aGlzLmVtcHR5VGV4dCB8fCB2ID09PSB1bmRlZmluZWQpewogICAgICAgICAgICB2ID0gJyc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2OwogICAgfSwKCiAgICAKICAgIHNldFJhd1ZhbHVlIDogZnVuY3Rpb24odil7CiAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyZWQgPyAodGhpcy5lbC5kb20udmFsdWUgPSAoRXh0LmlzRW1wdHkodikgPyAnJyA6IHYpKSA6ICcnOwogICAgfSwKCiAgICAKICAgIHNldFZhbHVlIDogZnVuY3Rpb24odil7CiAgICAgICAgdGhpcy52YWx1ZSA9IHY7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuZWwuZG9tLnZhbHVlID0gKEV4dC5pc0VtcHR5KHYpID8gJycgOiB2KTsKICAgICAgICAgICAgdGhpcy52YWxpZGF0ZSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBhcHBlbmQgOiBmdW5jdGlvbih2KXsKICAgICAgICAgdGhpcy5zZXRWYWx1ZShbdGhpcy5nZXRWYWx1ZSgpLCB2XS5qb2luKCcnKSk7CiAgICB9CgogICAgCiAgICAKCiAgICAKfSk7CgoKRXh0LmZvcm0uTWVzc2FnZVRhcmdldHMgPSB7CiAgICAncXRpcCcgOiB7CiAgICAgICAgbWFyazogZnVuY3Rpb24oZmllbGQsIG1zZyl7CiAgICAgICAgICAgIGZpZWxkLmVsLmFkZENsYXNzKGZpZWxkLmludmFsaWRDbGFzcyk7CiAgICAgICAgICAgIGZpZWxkLmVsLmRvbS5xdGlwID0gbXNnOwogICAgICAgICAgICBmaWVsZC5lbC5kb20ucWNsYXNzID0gJ3gtZm9ybS1pbnZhbGlkLXRpcCc7CiAgICAgICAgICAgIGlmKEV4dC5RdWlja1RpcHMpeyAKICAgICAgICAgICAgICAgIEV4dC5RdWlja1RpcHMuZW5hYmxlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGNsZWFyOiBmdW5jdGlvbihmaWVsZCl7CiAgICAgICAgICAgIGZpZWxkLmVsLnJlbW92ZUNsYXNzKGZpZWxkLmludmFsaWRDbGFzcyk7CiAgICAgICAgICAgIGZpZWxkLmVsLmRvbS5xdGlwID0gJyc7CiAgICAgICAgfQogICAgfSwKICAgICd0aXRsZScgOiB7CiAgICAgICAgbWFyazogZnVuY3Rpb24oZmllbGQsIG1zZyl7CiAgICAgICAgICAgIGZpZWxkLmVsLmFkZENsYXNzKGZpZWxkLmludmFsaWRDbGFzcyk7CiAgICAgICAgICAgIGZpZWxkLmVsLmRvbS50aXRsZSA9IG1zZzsKICAgICAgICB9LAogICAgICAgIGNsZWFyOiBmdW5jdGlvbihmaWVsZCl7CiAgICAgICAgICAgIGZpZWxkLmVsLmRvbS50aXRsZSA9ICcnOwogICAgICAgIH0KICAgIH0sCiAgICAndW5kZXInIDogewogICAgICAgIG1hcms6IGZ1bmN0aW9uKGZpZWxkLCBtc2cpewogICAgICAgICAgICBmaWVsZC5lbC5hZGRDbGFzcyhmaWVsZC5pbnZhbGlkQ2xhc3MpOwogICAgICAgICAgICBpZighZmllbGQuZXJyb3JFbCl7CiAgICAgICAgICAgICAgICB2YXIgZWxwID0gZmllbGQuZ2V0RXJyb3JDdCgpOwogICAgICAgICAgICAgICAgaWYoIWVscCl7IAogICAgICAgICAgICAgICAgICAgIGZpZWxkLmVsLmRvbS50aXRsZSA9IG1zZzsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmaWVsZC5lcnJvckVsID0gZWxwLmNyZWF0ZUNoaWxkKHtjbHM6J3gtZm9ybS1pbnZhbGlkLW1zZyd9KTsKICAgICAgICAgICAgICAgIGZpZWxkLm9uKCdyZXNpemUnLCBmaWVsZC5hbGlnbkVycm9yRWwsIGZpZWxkKTsKICAgICAgICAgICAgICAgIGZpZWxkLm9uKCdkZXN0cm95JywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBFeHQuZGVzdHJveSh0aGlzLmVycm9yRWwpOwogICAgICAgICAgICAgICAgfSwgZmllbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpZWxkLmFsaWduRXJyb3JFbCgpOwogICAgICAgICAgICBmaWVsZC5lcnJvckVsLnVwZGF0ZShtc2cpOwogICAgICAgICAgICBFeHQuZm9ybS5GaWVsZC5tc2dGeFtmaWVsZC5tc2dGeF0uc2hvdyhmaWVsZC5lcnJvckVsLCBmaWVsZCk7CiAgICAgICAgfSwKICAgICAgICBjbGVhcjogZnVuY3Rpb24oZmllbGQpewogICAgICAgICAgICBmaWVsZC5lbC5yZW1vdmVDbGFzcyhmaWVsZC5pbnZhbGlkQ2xhc3MpOwogICAgICAgICAgICBpZihmaWVsZC5lcnJvckVsKXsKICAgICAgICAgICAgICAgIEV4dC5mb3JtLkZpZWxkLm1zZ0Z4W2ZpZWxkLm1zZ0Z4XS5oaWRlKGZpZWxkLmVycm9yRWwsIGZpZWxkKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBmaWVsZC5lbC5kb20udGl0bGUgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICAnc2lkZScgOiB7CiAgICAgICAgbWFyazogZnVuY3Rpb24oZmllbGQsIG1zZyl7CiAgICAgICAgICAgIGZpZWxkLmVsLmFkZENsYXNzKGZpZWxkLmludmFsaWRDbGFzcyk7CiAgICAgICAgICAgIGlmKCFmaWVsZC5lcnJvckljb24pewogICAgICAgICAgICAgICAgdmFyIGVscCA9IGZpZWxkLmdldEVycm9yQ3QoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYoIWVscCl7CiAgICAgICAgICAgICAgICAgICAgZmllbGQuZWwuZG9tLnRpdGxlID0gbXNnOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZpZWxkLmVycm9ySWNvbiA9IGVscC5jcmVhdGVDaGlsZCh7Y2xzOid4LWZvcm0taW52YWxpZC1pY29uJ30pOwogICAgICAgICAgICAgICAgaWYgKGZpZWxkLm93bmVyQ3QpIHsKICAgICAgICAgICAgICAgICAgICBmaWVsZC5vd25lckN0Lm9uKCdhZnRlcmxheW91dCcsIGZpZWxkLmFsaWduRXJyb3JJY29uLCBmaWVsZCk7CiAgICAgICAgICAgICAgICAgICAgZmllbGQub3duZXJDdC5vbignZXhwYW5kJywgZmllbGQuYWxpZ25FcnJvckljb24sIGZpZWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZpZWxkLm9uKCdyZXNpemUnLCBmaWVsZC5hbGlnbkVycm9ySWNvbiwgZmllbGQpOwogICAgICAgICAgICAgICAgZmllbGQub24oJ2Rlc3Ryb3knLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIEV4dC5kZXN0cm95KHRoaXMuZXJyb3JJY29uKTsKICAgICAgICAgICAgICAgIH0sIGZpZWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaWVsZC5hbGlnbkVycm9ySWNvbigpOwogICAgICAgICAgICBmaWVsZC5lcnJvckljb24uZG9tLnF0aXAgPSBtc2c7CiAgICAgICAgICAgIGZpZWxkLmVycm9ySWNvbi5kb20ucWNsYXNzID0gJ3gtZm9ybS1pbnZhbGlkLXRpcCc7CiAgICAgICAgICAgIGZpZWxkLmVycm9ySWNvbi5zaG93KCk7CiAgICAgICAgfSwKICAgICAgICBjbGVhcjogZnVuY3Rpb24oZmllbGQpewogICAgICAgICAgICBmaWVsZC5lbC5yZW1vdmVDbGFzcyhmaWVsZC5pbnZhbGlkQ2xhc3MpOwogICAgICAgICAgICBpZihmaWVsZC5lcnJvckljb24pewogICAgICAgICAgICAgICAgZmllbGQuZXJyb3JJY29uLmRvbS5xdGlwID0gJyc7CiAgICAgICAgICAgICAgICBmaWVsZC5lcnJvckljb24uaGlkZSgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGZpZWxkLmVsLmRvbS50aXRsZSA9ICcnOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKCkV4dC5mb3JtLkZpZWxkLm1zZ0Z4ID0gewogICAgbm9ybWFsIDogewogICAgICAgIHNob3c6IGZ1bmN0aW9uKG1zZ0VsLCBmKXsKICAgICAgICAgICAgbXNnRWwuc2V0RGlzcGxheWVkKCdibG9jaycpOwogICAgICAgIH0sCgogICAgICAgIGhpZGUgOiBmdW5jdGlvbihtc2dFbCwgZil7CiAgICAgICAgICAgIG1zZ0VsLnNldERpc3BsYXllZChmYWxzZSkudXBkYXRlKCcnKTsKICAgICAgICB9CiAgICB9LAoKICAgIHNsaWRlIDogewogICAgICAgIHNob3c6IGZ1bmN0aW9uKG1zZ0VsLCBmKXsKICAgICAgICAgICAgbXNnRWwuc2xpZGVJbigndCcsIHtzdG9wRng6dHJ1ZX0pOwogICAgICAgIH0sCgogICAgICAgIGhpZGUgOiBmdW5jdGlvbihtc2dFbCwgZil7CiAgICAgICAgICAgIG1zZ0VsLnNsaWRlT3V0KCd0Jywge3N0b3BGeDp0cnVlLHVzZURpc3BsYXk6dHJ1ZX0pOwogICAgICAgIH0KICAgIH0sCgogICAgc2xpZGVSaWdodCA6IHsKICAgICAgICBzaG93OiBmdW5jdGlvbihtc2dFbCwgZil7CiAgICAgICAgICAgIG1zZ0VsLmZpeERpc3BsYXkoKTsKICAgICAgICAgICAgbXNnRWwuYWxpZ25UbyhmLmVsLCAndGwtdHInKTsKICAgICAgICAgICAgbXNnRWwuc2xpZGVJbignbCcsIHtzdG9wRng6dHJ1ZX0pOwogICAgICAgIH0sCgogICAgICAgIGhpZGUgOiBmdW5jdGlvbihtc2dFbCwgZil7CiAgICAgICAgICAgIG1zZ0VsLnNsaWRlT3V0KCdsJywge3N0b3BGeDp0cnVlLHVzZURpc3BsYXk6dHJ1ZX0pOwogICAgICAgIH0KICAgIH0KfTsKRXh0LnJlZygnZmllbGQnLCBFeHQuZm9ybS5GaWVsZCk7CgpFeHQuZm9ybS5UZXh0RmllbGQgPSBFeHQuZXh0ZW5kKEV4dC5mb3JtLkZpZWxkLCAgewogICAgCiAgICAKICAgIAogICAgZ3JvdyA6IGZhbHNlLAogICAgCiAgICBncm93TWluIDogMzAsCiAgICAKICAgIGdyb3dNYXggOiA4MDAsCiAgICAKICAgIHZ0eXBlIDogbnVsbCwKICAgIAogICAgbWFza1JlIDogbnVsbCwKICAgIAogICAgZGlzYWJsZUtleUZpbHRlciA6IGZhbHNlLAogICAgCiAgICBhbGxvd0JsYW5rIDogdHJ1ZSwKICAgIAogICAgbWluTGVuZ3RoIDogMCwKICAgIAogICAgbWF4TGVuZ3RoIDogTnVtYmVyLk1BWF9WQUxVRSwKICAgIAogICAgbWluTGVuZ3RoVGV4dCA6ICdUaGUgbWluaW11bSBsZW5ndGggZm9yIHRoaXMgZmllbGQgaXMgezB9JywKICAgIAogICAgbWF4TGVuZ3RoVGV4dCA6ICdUaGUgbWF4aW11bSBsZW5ndGggZm9yIHRoaXMgZmllbGQgaXMgezB9JywKICAgIAogICAgc2VsZWN0T25Gb2N1cyA6IGZhbHNlLAogICAgCiAgICBibGFua1RleHQgOiAnVGhpcyBmaWVsZCBpcyByZXF1aXJlZCcsCiAgICAKICAgIHZhbGlkYXRvciA6IG51bGwsCiAgICAKICAgIHJlZ2V4IDogbnVsbCwKICAgIAogICAgcmVnZXhUZXh0IDogJycsCiAgICAKICAgIGVtcHR5VGV4dCA6IG51bGwsCiAgICAKICAgIGVtcHR5Q2xhc3MgOiAneC1mb3JtLWVtcHR5LWZpZWxkJywKCiAgICAKCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5UZXh0RmllbGQuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAnYXV0b3NpemUnLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICdrZXlkb3duJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdrZXl1cCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAna2V5cHJlc3MnCiAgICAgICAgKTsKICAgIH0sCgogICAgCiAgICBpbml0RXZlbnRzIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5UZXh0RmllbGQuc3VwZXJjbGFzcy5pbml0RXZlbnRzLmNhbGwodGhpcyk7CiAgICAgICAgaWYodGhpcy52YWxpZGF0aW9uRXZlbnQgPT0gJ2tleXVwJyl7CiAgICAgICAgICAgIHRoaXMudmFsaWRhdGlvblRhc2sgPSBuZXcgRXh0LnV0aWwuRGVsYXllZFRhc2sodGhpcy52YWxpZGF0ZSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMubW9uKHRoaXMuZWwsICdrZXl1cCcsIHRoaXMuZmlsdGVyVmFsaWRhdGlvbiwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYodGhpcy52YWxpZGF0aW9uRXZlbnQgIT09IGZhbHNlICYmIHRoaXMudmFsaWRhdGlvbkV2ZW50ICE9ICdibHVyJyl7CiAgICAgICAgCXRoaXMubW9uKHRoaXMuZWwsIHRoaXMudmFsaWRhdGlvbkV2ZW50LCB0aGlzLnZhbGlkYXRlLCB0aGlzLCB7YnVmZmVyOiB0aGlzLnZhbGlkYXRpb25EZWxheX0pOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLnNlbGVjdE9uRm9jdXMgfHwgdGhpcy5lbXB0eVRleHQpeyAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1vbih0aGlzLmVsLCAnbW91c2Vkb3duJywgdGhpcy5vbk1vdXNlRG93biwgdGhpcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZih0aGlzLmVtcHR5VGV4dCl7CiAgICAgICAgICAgICAgICB0aGlzLmFwcGx5RW1wdHlUZXh0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYodGhpcy5tYXNrUmUgfHwgKHRoaXMudnR5cGUgJiYgdGhpcy5kaXNhYmxlS2V5RmlsdGVyICE9PSB0cnVlICYmICh0aGlzLm1hc2tSZSA9IEV4dC5mb3JtLlZUeXBlc1t0aGlzLnZ0eXBlKydNYXNrJ10pKSl7CiAgICAgICAgCXRoaXMubW9uKHRoaXMuZWwsICdrZXlwcmVzcycsIHRoaXMuZmlsdGVyS2V5cywgdGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuZ3Jvdyl7CiAgICAgICAgCXRoaXMubW9uKHRoaXMuZWwsICdrZXl1cCcsIHRoaXMub25LZXlVcEJ1ZmZlcmVkLCB0aGlzLCB7YnVmZmVyOiA1MH0pOwoJCQl0aGlzLm1vbih0aGlzLmVsLCAnY2xpY2snLCB0aGlzLmF1dG9TaXplLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5lbmFibGVLZXlFdmVudHMpewogICAgICAgICAgICB0aGlzLm1vbih0aGlzLmVsLCB7CiAgICAgICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgICAgIGtleXVwOiB0aGlzLm9uS2V5VXAsCiAgICAgICAgICAgICAgICBrZXlkb3duOiB0aGlzLm9uS2V5RG93biwKICAgICAgICAgICAgICAgIGtleXByZXNzOiB0aGlzLm9uS2V5UHJlc3MKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgb25Nb3VzZURvd246IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKCF0aGlzLmhhc0ZvY3VzKXsKICAgICAgICAgICAgdGhpcy5tb24odGhpcy5lbCwgJ21vdXNldXAnLCBFeHQuZW1wdHlGbiwgdGhpcywgeyBzaW5nbGU6IHRydWUsIHByZXZlbnREZWZhdWx0OiB0cnVlIH0pOwogICAgICAgIH0KICAgIH0sCgogICAgcHJvY2Vzc1ZhbHVlIDogZnVuY3Rpb24odmFsdWUpewogICAgICAgIGlmKHRoaXMuc3RyaXBDaGFyc1JlKXsKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gdmFsdWUucmVwbGFjZSh0aGlzLnN0cmlwQ2hhcnNSZSwgJycpOwogICAgICAgICAgICBpZihuZXdWYWx1ZSAhPT0gdmFsdWUpewogICAgICAgICAgICAgICAgdGhpcy5zZXRSYXdWYWx1ZShuZXdWYWx1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwKCiAgICBmaWx0ZXJWYWxpZGF0aW9uIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYoIWUuaXNOYXZLZXlQcmVzcygpKXsKICAgICAgICAgICAgdGhpcy52YWxpZGF0aW9uVGFzay5kZWxheSh0aGlzLnZhbGlkYXRpb25EZWxheSk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBvbkRpc2FibGU6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmZvcm0uVGV4dEZpZWxkLnN1cGVyY2xhc3Mub25EaXNhYmxlLmNhbGwodGhpcyk7CiAgICAgICAgaWYoRXh0LmlzSUUpewogICAgICAgICAgICB0aGlzLmVsLmRvbS51bnNlbGVjdGFibGUgPSAnb24nOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgb25FbmFibGU6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmZvcm0uVGV4dEZpZWxkLnN1cGVyY2xhc3Mub25FbmFibGUuY2FsbCh0aGlzKTsKICAgICAgICBpZihFeHQuaXNJRSl7CiAgICAgICAgICAgIHRoaXMuZWwuZG9tLnVuc2VsZWN0YWJsZSA9ICcnOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbktleVVwQnVmZmVyZWQgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZih0aGlzLmRvQXV0b1NpemUoZSkpewogICAgICAgICAgICB0aGlzLmF1dG9TaXplKCk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBkb0F1dG9TaXplIDogZnVuY3Rpb24oZSl7CiAgICAgICAgcmV0dXJuICFlLmlzTmF2S2V5UHJlc3MoKTsKICAgIH0sCgogICAgCiAgICBvbktleVVwIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2tleXVwJywgdGhpcywgZSk7CiAgICB9LAoKICAgIAogICAgb25LZXlEb3duIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2tleWRvd24nLCB0aGlzLCBlKTsKICAgIH0sCgogICAgCiAgICBvbktleVByZXNzIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2tleXByZXNzJywgdGhpcywgZSk7CiAgICB9LAoKICAgIAogICAgcmVzZXQgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5mb3JtLlRleHRGaWVsZC5zdXBlcmNsYXNzLnJlc2V0LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5hcHBseUVtcHR5VGV4dCgpOwogICAgfSwKCiAgICBhcHBseUVtcHR5VGV4dCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCAmJiB0aGlzLmVtcHR5VGV4dCAmJiB0aGlzLmdldFJhd1ZhbHVlKCkubGVuZ3RoIDwgMSAmJiAhdGhpcy5oYXNGb2N1cyl7CiAgICAgICAgICAgIHRoaXMuc2V0UmF3VmFsdWUodGhpcy5lbXB0eVRleHQpOwogICAgICAgICAgICB0aGlzLmVsLmFkZENsYXNzKHRoaXMuZW1wdHlDbGFzcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHByZUZvY3VzIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgZWwgPSB0aGlzLmVsLAogICAgICAgICAgICBpc0VtcHR5OwogICAgICAgIGlmKHRoaXMuZW1wdHlUZXh0KXsKICAgICAgICAgICAgaWYoZWwuZG9tLnZhbHVlID09IHRoaXMuZW1wdHlUZXh0KXsKICAgICAgICAgICAgICAgIHRoaXMuc2V0UmF3VmFsdWUoJycpOwogICAgICAgICAgICAgICAgaXNFbXB0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWwucmVtb3ZlQ2xhc3ModGhpcy5lbXB0eUNsYXNzKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5zZWxlY3RPbkZvY3VzIHx8IGlzRW1wdHkpewogICAgICAgICAgICBlbC5kb20uc2VsZWN0KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHBvc3RCbHVyIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmFwcGx5RW1wdHlUZXh0KCk7CiAgICB9LAoKICAgIAogICAgZmlsdGVyS2V5cyA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKGUuY3RybEtleSl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIGsgPSBlLmdldEtleSgpOwogICAgICAgIGlmKEV4dC5pc0dlY2tvICYmIChlLmlzTmF2S2V5UHJlc3MoKSB8fCBrID09IGUuQkFDS1NQQUNFIHx8IChrID09IGUuREVMRVRFICYmIGUuYnV0dG9uID09IC0xKSkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBjYyA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZS5nZXRDaGFyQ29kZSgpKTsKICAgICAgICBpZighRXh0LmlzR2Vja28gJiYgZS5pc1NwZWNpYWxLZXkoKSAmJiAhY2MpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKCF0aGlzLm1hc2tSZS50ZXN0KGNjKSl7CiAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgfQogICAgfSwKCiAgICBzZXRWYWx1ZSA6IGZ1bmN0aW9uKHYpewogICAgICAgIGlmKHRoaXMuZW1wdHlUZXh0ICYmIHRoaXMuZWwgJiYgIUV4dC5pc0VtcHR5KHYpKXsKICAgICAgICAgICAgdGhpcy5lbC5yZW1vdmVDbGFzcyh0aGlzLmVtcHR5Q2xhc3MpOwogICAgICAgIH0KICAgICAgICBFeHQuZm9ybS5UZXh0RmllbGQuc3VwZXJjbGFzcy5zZXRWYWx1ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIHRoaXMuYXBwbHlFbXB0eVRleHQoKTsKICAgICAgICB0aGlzLmF1dG9TaXplKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZ2V0RXJyb3JzOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBlcnJvcnMgPSBFeHQuZm9ybS5UZXh0RmllbGQuc3VwZXJjbGFzcy5nZXRFcnJvcnMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAKICAgICAgICB2YWx1ZSA9IEV4dC5pc0RlZmluZWQodmFsdWUpID8gdmFsdWUgOiB0aGlzLnByb2Nlc3NWYWx1ZSh0aGlzLmdldFJhd1ZhbHVlKCkpOyAgICAgICAgCiAgICAgICAgCiAgICAgICAgaWYgKEV4dC5pc0Z1bmN0aW9uKHRoaXMudmFsaWRhdG9yKSkgewogICAgICAgICAgICB2YXIgbXNnID0gdGhpcy52YWxpZGF0b3IodmFsdWUpOwogICAgICAgICAgICBpZiAobXNnICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaChtc2cpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPCAxIHx8IHZhbHVlID09PSB0aGlzLmVtcHR5VGV4dCkgewogICAgICAgICAgICBpZiAodGhpcy5hbGxvd0JsYW5rKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBlcnJvcnM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaCh0aGlzLmJsYW5rVGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKCF0aGlzLmFsbG93QmxhbmsgJiYgKHZhbHVlLmxlbmd0aCA8IDEgfHwgdmFsdWUgPT09IHRoaXMuZW1wdHlUZXh0KSkgeyAKICAgICAgICAgICAgZXJyb3JzLnB1c2godGhpcy5ibGFua1RleHQpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAodmFsdWUubGVuZ3RoIDwgdGhpcy5taW5MZW5ndGgpIHsKICAgICAgICAgICAgZXJyb3JzLnB1c2goU3RyaW5nLmZvcm1hdCh0aGlzLm1pbkxlbmd0aFRleHQsIHRoaXMubWluTGVuZ3RoKSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiB0aGlzLm1heExlbmd0aCkgewogICAgICAgICAgICBlcnJvcnMucHVzaChTdHJpbmcuZm9ybWF0KHRoaXMubWF4TGVuZ3RoVGV4dCwgdGhpcy5tYXhMZW5ndGgpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMudnR5cGUpIHsKICAgICAgICAgICAgdmFyIHZ0ID0gRXh0LmZvcm0uVlR5cGVzOwogICAgICAgICAgICBpZighdnRbdGhpcy52dHlwZV0odmFsdWUsIHRoaXMpKXsKICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHRoaXMudnR5cGVUZXh0IHx8IHZ0W3RoaXMudnR5cGUgKydUZXh0J10pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLnJlZ2V4ICYmICF0aGlzLnJlZ2V4LnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgIGVycm9ycy5wdXNoKHRoaXMucmVnZXhUZXh0KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIGVycm9yczsKICAgIH0sCgogICAgCiAgICBzZWxlY3RUZXh0IDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CiAgICAgICAgdmFyIHYgPSB0aGlzLmdldFJhd1ZhbHVlKCk7CiAgICAgICAgdmFyIGRvRm9jdXMgPSBmYWxzZTsKICAgICAgICBpZih2Lmxlbmd0aCA+IDApewogICAgICAgICAgICBzdGFydCA9IHN0YXJ0ID09PSB1bmRlZmluZWQgPyAwIDogc3RhcnQ7CiAgICAgICAgICAgIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gdi5sZW5ndGggOiBlbmQ7CiAgICAgICAgICAgIHZhciBkID0gdGhpcy5lbC5kb207CiAgICAgICAgICAgIGlmKGQuc2V0U2VsZWN0aW9uUmFuZ2UpewogICAgICAgICAgICAgICAgZC5zZXRTZWxlY3Rpb25SYW5nZShzdGFydCwgZW5kKTsKICAgICAgICAgICAgfWVsc2UgaWYoZC5jcmVhdGVUZXh0UmFuZ2UpewogICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gZC5jcmVhdGVUZXh0UmFuZ2UoKTsKICAgICAgICAgICAgICAgIHJhbmdlLm1vdmVTdGFydCgnY2hhcmFjdGVyJywgc3RhcnQpOwogICAgICAgICAgICAgICAgcmFuZ2UubW92ZUVuZCgnY2hhcmFjdGVyJywgZW5kLXYubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvRm9jdXMgPSBFeHQuaXNHZWNrbyB8fCBFeHQuaXNPcGVyYTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgZG9Gb2N1cyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmKGRvRm9jdXMpewogICAgICAgICAgICB0aGlzLmZvY3VzKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGF1dG9TaXplIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5ncm93IHx8ICF0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZighdGhpcy5tZXRyaWNzKXsKICAgICAgICAgICAgdGhpcy5tZXRyaWNzID0gRXh0LnV0aWwuVGV4dE1ldHJpY3MuY3JlYXRlSW5zdGFuY2UodGhpcy5lbCk7CiAgICAgICAgfQogICAgICAgIHZhciBlbCA9IHRoaXMuZWw7CiAgICAgICAgdmFyIHYgPSBlbC5kb20udmFsdWU7CiAgICAgICAgdmFyIGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBkLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHYpKTsKICAgICAgICB2ID0gZC5pbm5lckhUTUw7CiAgICAgICAgRXh0LnJlbW92ZU5vZGUoZCk7CiAgICAgICAgZCA9IG51bGw7CiAgICAgICAgdiArPSAnJiMxNjA7JzsKICAgICAgICB2YXIgdyA9IE1hdGgubWluKHRoaXMuZ3Jvd01heCwgTWF0aC5tYXgodGhpcy5tZXRyaWNzLmdldFdpZHRoKHYpICsgIDEwLCB0aGlzLmdyb3dNaW4pKTsKICAgICAgICB0aGlzLmVsLnNldFdpZHRoKHcpOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdhdXRvc2l6ZScsIHRoaXMsIHcpOwogICAgfSwKCQoJb25EZXN0cm95OiBmdW5jdGlvbigpewoJCWlmKHRoaXMudmFsaWRhdGlvblRhc2spewoJCQl0aGlzLnZhbGlkYXRpb25UYXNrLmNhbmNlbCgpOwoJCQl0aGlzLnZhbGlkYXRpb25UYXNrID0gbnVsbDsKCQl9CgkJRXh0LmZvcm0uVGV4dEZpZWxkLnN1cGVyY2xhc3Mub25EZXN0cm95LmNhbGwodGhpcyk7Cgl9Cn0pOwpFeHQucmVnKCd0ZXh0ZmllbGQnLCBFeHQuZm9ybS5UZXh0RmllbGQpOwoKRXh0LmZvcm0uVHJpZ2dlckZpZWxkID0gRXh0LmV4dGVuZChFeHQuZm9ybS5UZXh0RmllbGQsICB7CiAgICAKICAgIAogICAgCiAgICBkZWZhdWx0QXV0b0NyZWF0ZSA6IHt0YWc6ICJpbnB1dCIsIHR5cGU6ICJ0ZXh0Iiwgc2l6ZTogIjE2IiwgYXV0b2NvbXBsZXRlOiAib2ZmIn0sCiAgICAKICAgIGhpZGVUcmlnZ2VyOmZhbHNlLAogICAgCiAgICBlZGl0YWJsZTogdHJ1ZSwKICAgIAogICAgcmVhZE9ubHk6IGZhbHNlLAogICAgCiAgICB3cmFwRm9jdXNDbGFzczogJ3gtdHJpZ2dlci13cmFwLWZvY3VzJywKICAgIAogICAgYXV0b1NpemU6IEV4dC5lbXB0eUZuLAogICAgCiAgICBtb25pdG9yVGFiIDogdHJ1ZSwKICAgIAogICAgZGVmZXJIZWlnaHQgOiB0cnVlLAogICAgCiAgICBtaW1pY2luZyA6IGZhbHNlLAoKICAgIGFjdGlvbk1vZGU6ICd3cmFwJywKCiAgICBkZWZhdWx0VHJpZ2dlcldpZHRoOiAxNywKCiAgICAKICAgIG9uUmVzaXplIDogZnVuY3Rpb24odywgaCl7CiAgICAgICAgRXh0LmZvcm0uVHJpZ2dlckZpZWxkLnN1cGVyY2xhc3Mub25SZXNpemUuY2FsbCh0aGlzLCB3LCBoKTsKICAgICAgICB2YXIgdHcgPSB0aGlzLmdldFRyaWdnZXJXaWR0aCgpOwogICAgICAgIGlmKEV4dC5pc051bWJlcih3KSl7CiAgICAgICAgICAgIHRoaXMuZWwuc2V0V2lkdGgodyAtIHR3KTsKICAgICAgICB9CiAgICAgICAgdGhpcy53cmFwLnNldFdpZHRoKHRoaXMuZWwuZ2V0V2lkdGgoKSArIHR3KTsKICAgIH0sCgogICAgZ2V0VHJpZ2dlcldpZHRoOiBmdW5jdGlvbigpewogICAgICAgIHZhciB0dyA9IHRoaXMudHJpZ2dlci5nZXRXaWR0aCgpOwogICAgICAgIGlmKCF0aGlzLmhpZGVUcmlnZ2VyICYmICF0aGlzLnJlYWRPbmx5ICYmIHR3ID09PSAwKXsKICAgICAgICAgICAgdHcgPSB0aGlzLmRlZmF1bHRUcmlnZ2VyV2lkdGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0dzsKICAgIH0sCgogICAgCiAgICBhbGlnbkVycm9ySWNvbiA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy53cmFwKXsKICAgICAgICAgICAgdGhpcy5lcnJvckljb24uYWxpZ25Ubyh0aGlzLndyYXAsICd0bC10cicsIFsyLCAwXSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKXsKICAgICAgICB0aGlzLmRvYyA9IEV4dC5pc0lFID8gRXh0LmdldEJvZHkoKSA6IEV4dC5nZXREb2MoKTsKICAgICAgICBFeHQuZm9ybS5UcmlnZ2VyRmllbGQuc3VwZXJjbGFzcy5vblJlbmRlci5jYWxsKHRoaXMsIGN0LCBwb3NpdGlvbik7CgogICAgICAgIHRoaXMud3JhcCA9IHRoaXMuZWwud3JhcCh7Y2xzOiAneC1mb3JtLWZpZWxkLXdyYXAgeC1mb3JtLWZpZWxkLXRyaWdnZXItd3JhcCd9KTsKICAgICAgICB0aGlzLnRyaWdnZXIgPSB0aGlzLndyYXAuY3JlYXRlQ2hpbGQodGhpcy50cmlnZ2VyQ29uZmlnIHx8CiAgICAgICAgICAgICAgICB7dGFnOiAiaW1nIiwgc3JjOiBFeHQuQkxBTktfSU1BR0VfVVJMLCBhbHQ6ICIiLCBjbHM6ICJ4LWZvcm0tdHJpZ2dlciAiICsgdGhpcy50cmlnZ2VyQ2xhc3N9KTsKICAgICAgICB0aGlzLmluaXRUcmlnZ2VyKCk7CiAgICAgICAgaWYoIXRoaXMud2lkdGgpewogICAgICAgICAgICB0aGlzLndyYXAuc2V0V2lkdGgodGhpcy5lbC5nZXRXaWR0aCgpK3RoaXMudHJpZ2dlci5nZXRXaWR0aCgpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5yZXNpemVFbCA9IHRoaXMucG9zaXRpb25FbCA9IHRoaXMud3JhcDsKICAgIH0sCgogICAgZ2V0V2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybih0aGlzLmVsLmdldFdpZHRoKCkgKyB0aGlzLnRyaWdnZXIuZ2V0V2lkdGgoKSk7CiAgICB9LAoKICAgIHVwZGF0ZUVkaXRTdGF0ZTogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgaWYgKHRoaXMucmVhZE9ubHkpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWwuZG9tLnJlYWRPbmx5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZWwuYWRkQ2xhc3MoJ3gtdHJpZ2dlci1ub2VkaXQnKTsKICAgICAgICAgICAgICAgIHRoaXMubXVuKHRoaXMuZWwsICdjbGljaycsIHRoaXMub25UcmlnZ2VyQ2xpY2ssIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyLnNldERpc3BsYXllZChmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuZWRpdGFibGUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLmRvbS5yZWFkT25seSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbC5hZGRDbGFzcygneC10cmlnZ2VyLW5vZWRpdCcpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubW9uKHRoaXMuZWwsICdjbGljaycsIHRoaXMub25UcmlnZ2VyQ2xpY2ssIHRoaXMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLmRvbS5yZWFkT25seSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3MoJ3gtdHJpZ2dlci1ub2VkaXQnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLm11bih0aGlzLmVsLCAnY2xpY2snLCB0aGlzLm9uVHJpZ2dlckNsaWNrLCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlci5zZXREaXNwbGF5ZWQoIXRoaXMuaGlkZVRyaWdnZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMub25SZXNpemUodGhpcy53aWR0aCB8fCB0aGlzLndyYXAuZ2V0V2lkdGgoKSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNldEhpZGVUcmlnZ2VyOiBmdW5jdGlvbihoaWRlVHJpZ2dlcil7CiAgICAgICAgaWYoaGlkZVRyaWdnZXIgIT0gdGhpcy5oaWRlVHJpZ2dlcil7CiAgICAgICAgICAgIHRoaXMuaGlkZVRyaWdnZXIgPSBoaWRlVHJpZ2dlcjsKICAgICAgICAgICAgdGhpcy51cGRhdGVFZGl0U3RhdGUoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0RWRpdGFibGU6IGZ1bmN0aW9uKGVkaXRhYmxlKXsKICAgICAgICBpZihlZGl0YWJsZSAhPSB0aGlzLmVkaXRhYmxlKXsKICAgICAgICAgICAgdGhpcy5lZGl0YWJsZSA9IGVkaXRhYmxlOwogICAgICAgICAgICB0aGlzLnVwZGF0ZUVkaXRTdGF0ZSgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRSZWFkT25seTogZnVuY3Rpb24ocmVhZE9ubHkpewogICAgICAgIGlmKHJlYWRPbmx5ICE9IHRoaXMucmVhZE9ubHkpewogICAgICAgICAgICB0aGlzLnJlYWRPbmx5ID0gcmVhZE9ubHk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlRWRpdFN0YXRlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICBhZnRlclJlbmRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmZvcm0uVHJpZ2dlckZpZWxkLnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLnVwZGF0ZUVkaXRTdGF0ZSgpOwogICAgfSwKCiAgICAKICAgIGluaXRUcmlnZ2VyIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLm1vbih0aGlzLnRyaWdnZXIsICdjbGljaycsIHRoaXMub25UcmlnZ2VyQ2xpY2ssIHRoaXMsIHtwcmV2ZW50RGVmYXVsdDp0cnVlfSk7CiAgICAgICAgdGhpcy50cmlnZ2VyLmFkZENsYXNzT25PdmVyKCd4LWZvcm0tdHJpZ2dlci1vdmVyJyk7CiAgICAgICAgdGhpcy50cmlnZ2VyLmFkZENsYXNzT25DbGljaygneC1mb3JtLXRyaWdnZXItY2xpY2snKTsKICAgIH0sCgogICAgCiAgICBvbkRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5kZXN0cm95KHRoaXMudHJpZ2dlciwgdGhpcy53cmFwKTsKICAgICAgICBpZiAodGhpcy5taW1pY2luZyl7CiAgICAgICAgICAgIHRoaXMuZG9jLnVuKCdtb3VzZWRvd24nLCB0aGlzLm1pbWljQmx1ciwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIGRlbGV0ZSB0aGlzLmRvYzsKICAgICAgICBFeHQuZm9ybS5UcmlnZ2VyRmllbGQuc3VwZXJjbGFzcy5vbkRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBvbkZvY3VzIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5UcmlnZ2VyRmllbGQuc3VwZXJjbGFzcy5vbkZvY3VzLmNhbGwodGhpcyk7CiAgICAgICAgaWYoIXRoaXMubWltaWNpbmcpewogICAgICAgICAgICB0aGlzLndyYXAuYWRkQ2xhc3ModGhpcy53cmFwRm9jdXNDbGFzcyk7CiAgICAgICAgICAgIHRoaXMubWltaWNpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmRvYy5vbignbW91c2Vkb3duJywgdGhpcy5taW1pY0JsdXIsIHRoaXMsIHtkZWxheTogMTB9KTsKICAgICAgICAgICAgaWYodGhpcy5tb25pdG9yVGFiKXsKICAgICAgICAgICAgICAgIHRoaXMub24oJ3NwZWNpYWxrZXknLCB0aGlzLmNoZWNrVGFiLCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBjaGVja1RhYiA6IGZ1bmN0aW9uKG1lLCBlKXsKICAgICAgICBpZihlLmdldEtleSgpID09IGUuVEFCKXsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyQmx1cigpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkJsdXIgOiBFeHQuZW1wdHlGbiwKCiAgICAKICAgIG1pbWljQmx1ciA6IGZ1bmN0aW9uKGUpewogICAgICAgIGlmKCF0aGlzLmlzRGVzdHJveWVkICYmICF0aGlzLndyYXAuY29udGFpbnMoZS50YXJnZXQpICYmIHRoaXMudmFsaWRhdGVCbHVyKGUpKXsKICAgICAgICAgICAgdGhpcy50cmlnZ2VyQmx1cigpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICB0cmlnZ2VyQmx1ciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5taW1pY2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMuZG9jLnVuKCdtb3VzZWRvd24nLCB0aGlzLm1pbWljQmx1ciwgdGhpcyk7CiAgICAgICAgaWYodGhpcy5tb25pdG9yVGFiICYmIHRoaXMuZWwpewogICAgICAgICAgICB0aGlzLnVuKCdzcGVjaWFsa2V5JywgdGhpcy5jaGVja1RhYiwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIEV4dC5mb3JtLlRyaWdnZXJGaWVsZC5zdXBlcmNsYXNzLm9uQmx1ci5jYWxsKHRoaXMpOwogICAgICAgIGlmKHRoaXMud3JhcCl7CiAgICAgICAgICAgIHRoaXMud3JhcC5yZW1vdmVDbGFzcyh0aGlzLndyYXBGb2N1c0NsYXNzKTsKICAgICAgICB9CiAgICB9LAoKICAgIGJlZm9yZUJsdXIgOiBFeHQuZW1wdHlGbiwKCiAgICAKICAgIAogICAgdmFsaWRhdGVCbHVyIDogZnVuY3Rpb24oZSl7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIAogICAgb25UcmlnZ2VyQ2xpY2sgOiBFeHQuZW1wdHlGbgoKICAgIAogICAgCiAgICAKfSk7CgoKRXh0LmZvcm0uVHdpblRyaWdnZXJGaWVsZCA9IEV4dC5leHRlbmQoRXh0LmZvcm0uVHJpZ2dlckZpZWxkLCB7CiAgICAKICAgIAogICAgCgogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmZvcm0uVHdpblRyaWdnZXJGaWVsZC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKCiAgICAgICAgdGhpcy50cmlnZ2VyQ29uZmlnID0gewogICAgICAgICAgICB0YWc6J3NwYW4nLCBjbHM6J3gtZm9ybS10d2luLXRyaWdnZXJzJywgY246WwogICAgICAgICAgICB7dGFnOiAiaW1nIiwgc3JjOiBFeHQuQkxBTktfSU1BR0VfVVJMLCBhbHQ6ICIiLCBjbHM6ICJ4LWZvcm0tdHJpZ2dlciAiICsgdGhpcy50cmlnZ2VyMUNsYXNzfSwKICAgICAgICAgICAge3RhZzogImltZyIsIHNyYzogRXh0LkJMQU5LX0lNQUdFX1VSTCwgYWx0OiAiIiwgY2xzOiAieC1mb3JtLXRyaWdnZXIgIiArIHRoaXMudHJpZ2dlcjJDbGFzc30KICAgICAgICBdfTsKICAgIH0sCgogICAgZ2V0VHJpZ2dlciA6IGZ1bmN0aW9uKGluZGV4KXsKICAgICAgICByZXR1cm4gdGhpcy50cmlnZ2Vyc1tpbmRleF07CiAgICB9LAogICAgCiAgICBhZnRlclJlbmRlcjogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5Ud2luVHJpZ2dlckZpZWxkLnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLnRyaWdnZXJzLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gdHJpZ2dlcnMubGVuZ3RoOwogICAgICAgICAgICAKICAgICAgICBmb3IoOyBpIDwgbGVuOyArK2kpewogICAgICAgICAgICBpZih0aGlzWydoaWRlVHJpZ2dlcicgKyAoaSArIDEpXSl7CiAgICAgICAgICAgICAgICAgICAgdHJpZ2dlcnNbaV0uaGlkZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICB9ICAgIAogICAgfSwKCiAgICBpbml0VHJpZ2dlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHRzID0gdGhpcy50cmlnZ2VyLnNlbGVjdCgnLngtZm9ybS10cmlnZ2VyJywgdHJ1ZSksCiAgICAgICAgICAgIHRyaWdnZXJGaWVsZCA9IHRoaXM7CiAgICAgICAgICAgIAogICAgICAgIHRzLmVhY2goZnVuY3Rpb24odCwgYWxsLCBpbmRleCl7CiAgICAgICAgICAgIHZhciB0cmlnZ2VySW5kZXggPSAnVHJpZ2dlcicrKGluZGV4KzEpOwogICAgICAgICAgICB0LmhpZGUgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgdmFyIHcgPSB0cmlnZ2VyRmllbGQud3JhcC5nZXRXaWR0aCgpOwogICAgICAgICAgICAgICAgdGhpcy5kb20uc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIHRyaWdnZXJGaWVsZC5lbC5zZXRXaWR0aCh3LXRyaWdnZXJGaWVsZC50cmlnZ2VyLmdldFdpZHRoKCkpOwogICAgICAgICAgICAgICAgdHJpZ2dlckZpZWxkWydoaWRkZW4nICsgdHJpZ2dlckluZGV4XSA9IHRydWU7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHQuc2hvdyA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICB2YXIgdyA9IHRyaWdnZXJGaWVsZC53cmFwLmdldFdpZHRoKCk7CiAgICAgICAgICAgICAgICB0aGlzLmRvbS5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgICAgICAgICB0cmlnZ2VyRmllbGQuZWwuc2V0V2lkdGgody10cmlnZ2VyRmllbGQudHJpZ2dlci5nZXRXaWR0aCgpKTsKICAgICAgICAgICAgICAgIHRyaWdnZXJGaWVsZFsnaGlkZGVuJyArIHRyaWdnZXJJbmRleF0gPSBmYWxzZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5tb24odCwgJ2NsaWNrJywgdGhpc1snb24nK3RyaWdnZXJJbmRleCsnQ2xpY2snXSwgdGhpcywge3ByZXZlbnREZWZhdWx0OnRydWV9KTsKICAgICAgICAgICAgdC5hZGRDbGFzc09uT3ZlcigneC1mb3JtLXRyaWdnZXItb3ZlcicpOwogICAgICAgICAgICB0LmFkZENsYXNzT25DbGljaygneC1mb3JtLXRyaWdnZXItY2xpY2snKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgICB0aGlzLnRyaWdnZXJzID0gdHMuZWxlbWVudHM7CiAgICB9LAoKICAgIGdldFRyaWdnZXJXaWR0aDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdHcgPSAwOwogICAgICAgIEV4dC5lYWNoKHRoaXMudHJpZ2dlcnMsIGZ1bmN0aW9uKHQsIGluZGV4KXsKICAgICAgICAgICAgdmFyIHRyaWdnZXJJbmRleCA9ICdUcmlnZ2VyJyArIChpbmRleCArIDEpLAogICAgICAgICAgICAgICAgdyA9IHQuZ2V0V2lkdGgoKTsKICAgICAgICAgICAgaWYodyA9PT0gMCAmJiAhdGhpc1snaGlkZGVuJyArIHRyaWdnZXJJbmRleF0pewogICAgICAgICAgICAgICAgdHcgKz0gdGhpcy5kZWZhdWx0VHJpZ2dlcldpZHRoOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHR3ICs9IHc7CiAgICAgICAgICAgIH0KICAgICAgICB9LCB0aGlzKTsKICAgICAgICByZXR1cm4gdHc7CiAgICB9LAoKICAgIAogICAgb25EZXN0cm95IDogZnVuY3Rpb24oKSB7CiAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy50cmlnZ2Vycyk7CiAgICAgICAgRXh0LmZvcm0uVHdpblRyaWdnZXJGaWVsZC5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICAKICAgIG9uVHJpZ2dlcjFDbGljayA6IEV4dC5lbXB0eUZuLAogICAgCiAgICBvblRyaWdnZXIyQ2xpY2sgOiBFeHQuZW1wdHlGbgp9KTsKRXh0LnJlZygndHJpZ2dlcicsIEV4dC5mb3JtLlRyaWdnZXJGaWVsZCk7CgpFeHQuZm9ybS5UZXh0QXJlYSA9IEV4dC5leHRlbmQoRXh0LmZvcm0uVGV4dEZpZWxkLCAgewogICAgCiAgICBncm93TWluIDogNjAsCiAgICAKICAgIGdyb3dNYXg6IDEwMDAsCiAgICBncm93QXBwZW5kIDogJyYjMTYwO1xuJiMxNjA7JywKCiAgICBlbnRlcklzU3BlY2lhbCA6IGZhbHNlLAoKICAgIAogICAgcHJldmVudFNjcm9sbGJhcnM6IGZhbHNlLAogICAgCgogICAgCiAgICBvblJlbmRlciA6IGZ1bmN0aW9uKGN0LCBwb3NpdGlvbil7CiAgICAgICAgaWYoIXRoaXMuZWwpewogICAgICAgICAgICB0aGlzLmRlZmF1bHRBdXRvQ3JlYXRlID0gewogICAgICAgICAgICAgICAgdGFnOiAidGV4dGFyZWEiLAogICAgICAgICAgICAgICAgc3R5bGU6IndpZHRoOjEwMHB4O2hlaWdodDo2MHB4OyIsCiAgICAgICAgICAgICAgICBhdXRvY29tcGxldGU6ICJvZmYiCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIEV4dC5mb3JtLlRleHRBcmVhLnN1cGVyY2xhc3Mub25SZW5kZXIuY2FsbCh0aGlzLCBjdCwgcG9zaXRpb24pOwogICAgICAgIGlmKHRoaXMuZ3Jvdyl7CiAgICAgICAgICAgIHRoaXMudGV4dFNpemVFbCA9IEV4dC5Eb21IZWxwZXIuYXBwZW5kKGRvY3VtZW50LmJvZHksIHsKICAgICAgICAgICAgICAgIHRhZzogInByZSIsIGNsczogIngtZm9ybS1ncm93LXNpemVyIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhpcy5wcmV2ZW50U2Nyb2xsYmFycyl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnNldFN0eWxlKCJvdmVyZmxvdyIsICJoaWRkZW4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVsLnNldEhlaWdodCh0aGlzLmdyb3dNaW4pOwogICAgICAgIH0KICAgIH0sCgogICAgb25EZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQucmVtb3ZlTm9kZSh0aGlzLnRleHRTaXplRWwpOwogICAgICAgIEV4dC5mb3JtLlRleHRBcmVhLnN1cGVyY2xhc3Mub25EZXN0cm95LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIGZpcmVLZXkgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZihlLmlzU3BlY2lhbEtleSgpICYmICh0aGlzLmVudGVySXNTcGVjaWFsIHx8IChlLmdldEtleSgpICE9IGUuRU5URVIgfHwgZS5oYXNNb2RpZmllcigpKSkpewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgic3BlY2lhbGtleSIsIHRoaXMsIGUpOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgZG9BdXRvU2l6ZSA6IGZ1bmN0aW9uKGUpewogICAgICAgIHJldHVybiAhZS5pc05hdktleVByZXNzKCkgfHwgZS5nZXRLZXkoKSA9PSBlLkVOVEVSOwogICAgfSwKICAgIAogICAgCiAgICBmaWx0ZXJWYWxpZGF0aW9uOiBmdW5jdGlvbihlKSB7ICAgICAgICAgICAgCiAgICAgICAgaWYoIWUuaXNOYXZLZXlQcmVzcygpIHx8ICghdGhpcy5lbnRlcklzU3BlY2lhbCAmJiBlLmtleUNvZGUgPT0gZS5FTlRFUikpewogICAgICAgICAgICB0aGlzLnZhbGlkYXRpb25UYXNrLmRlbGF5KHRoaXMudmFsaWRhdGlvbkRlbGF5KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYXV0b1NpemU6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMuZ3JvdyB8fCAhdGhpcy50ZXh0U2l6ZUVsKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgZWwgPSB0aGlzLmVsLAogICAgICAgICAgICB2ID0gRXh0LnV0aWwuRm9ybWF0Lmh0bWxFbmNvZGUoZWwuZG9tLnZhbHVlKSwKICAgICAgICAgICAgdHMgPSB0aGlzLnRleHRTaXplRWwsCiAgICAgICAgICAgIGg7CiAgICAgICAgICAgIAogICAgICAgIEV4dC5mbHkodHMpLnNldFdpZHRoKHRoaXMuZWwuZ2V0V2lkdGgoKSk7CiAgICAgICAgaWYodi5sZW5ndGggPCAxKXsKICAgICAgICAgICAgdiA9ICImIzE2MDsmIzE2MDsiOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB2ICs9IHRoaXMuZ3Jvd0FwcGVuZDsKICAgICAgICAgICAgaWYoRXh0LmlzSUUpewogICAgICAgICAgICAgICAgdiA9IHYucmVwbGFjZSgvXG4vZywgJyYjMTYwOzxiciAvPicpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRzLmlubmVySFRNTCA9IHY7CiAgICAgICAgaCA9IE1hdGgubWluKHRoaXMuZ3Jvd01heCwgTWF0aC5tYXgodHMub2Zmc2V0SGVpZ2h0LCB0aGlzLmdyb3dNaW4pKTsKICAgICAgICBpZihoICE9IHRoaXMubGFzdEhlaWdodCl7CiAgICAgICAgICAgIHRoaXMubGFzdEhlaWdodCA9IGg7CiAgICAgICAgICAgIHRoaXMuZWwuc2V0SGVpZ2h0KGgpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgiYXV0b3NpemUiLCB0aGlzLCBoKTsKICAgICAgICB9CiAgICB9Cn0pOwpFeHQucmVnKCd0ZXh0YXJlYScsIEV4dC5mb3JtLlRleHRBcmVhKTsKRXh0LmZvcm0uTnVtYmVyRmllbGQgPSBFeHQuZXh0ZW5kKEV4dC5mb3JtLlRleHRGaWVsZCwgIHsKICAgIAogICAgCiAgICAKICAgIGZpZWxkQ2xhc3M6ICJ4LWZvcm0tZmllbGQgeC1mb3JtLW51bS1maWVsZCIsCiAgICAKICAgIAogICAgYWxsb3dEZWNpbWFscyA6IHRydWUsCiAgICAKICAgIAogICAgZGVjaW1hbFNlcGFyYXRvciA6ICIuIiwKICAgIAogICAgCiAgICBkZWNpbWFsUHJlY2lzaW9uIDogMiwKICAgIAogICAgCiAgICBhbGxvd05lZ2F0aXZlIDogdHJ1ZSwKICAgIAogICAgCiAgICBtaW5WYWx1ZSA6IE51bWJlci5ORUdBVElWRV9JTkZJTklUWSwKICAgIAogICAgCiAgICBtYXhWYWx1ZSA6IE51bWJlci5NQVhfVkFMVUUsCiAgICAKICAgIAogICAgbWluVGV4dCA6ICJUaGUgbWluaW11bSB2YWx1ZSBmb3IgdGhpcyBmaWVsZCBpcyB7MH0iLAogICAgCiAgICAKICAgIG1heFRleHQgOiAiVGhlIG1heGltdW0gdmFsdWUgZm9yIHRoaXMgZmllbGQgaXMgezB9IiwKICAgIAogICAgCiAgICBuYW5UZXh0IDogInswfSBpcyBub3QgYSB2YWxpZCBudW1iZXIiLAogICAgCiAgICAKICAgIGJhc2VDaGFycyA6ICIwMTIzNDU2Nzg5IiwKICAgIAogICAgCiAgICBhdXRvU3RyaXBDaGFyczogZmFsc2UsCgogICAgCiAgICBpbml0RXZlbnRzIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFsbG93ZWQgPSB0aGlzLmJhc2VDaGFycyArICcnOwogICAgICAgIGlmICh0aGlzLmFsbG93RGVjaW1hbHMpIHsKICAgICAgICAgICAgYWxsb3dlZCArPSB0aGlzLmRlY2ltYWxTZXBhcmF0b3I7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmFsbG93TmVnYXRpdmUpIHsKICAgICAgICAgICAgYWxsb3dlZCArPSAnLSc7CiAgICAgICAgfQogICAgICAgIGFsbG93ZWQgPSBFeHQuZXNjYXBlUmUoYWxsb3dlZCk7CiAgICAgICAgdGhpcy5tYXNrUmUgPSBuZXcgUmVnRXhwKCdbJyArIGFsbG93ZWQgKyAnXScpOwogICAgICAgIGlmICh0aGlzLmF1dG9TdHJpcENoYXJzKSB7CiAgICAgICAgICAgIHRoaXMuc3RyaXBDaGFyc1JlID0gbmV3IFJlZ0V4cCgnW14nICsgYWxsb3dlZCArICddJywgJ2dpJyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIEV4dC5mb3JtLk51bWJlckZpZWxkLnN1cGVyY2xhc3MuaW5pdEV2ZW50cy5jYWxsKHRoaXMpOwogICAgfSwKICAgIAogICAgCiAgICBnZXRFcnJvcnM6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIGVycm9ycyA9IEV4dC5mb3JtLk51bWJlckZpZWxkLnN1cGVyY2xhc3MuZ2V0RXJyb3JzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgCiAgICAgICAgdmFsdWUgPSBFeHQuaXNEZWZpbmVkKHZhbHVlKSA/IHZhbHVlIDogdGhpcy5wcm9jZXNzVmFsdWUodGhpcy5nZXRSYXdWYWx1ZSgpKTsKICAgICAgICAKICAgICAgICBpZiAodmFsdWUubGVuZ3RoIDwgMSkgeyAKICAgICAgICAgICAgIHJldHVybiBlcnJvcnM7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhbHVlID0gU3RyaW5nKHZhbHVlKS5yZXBsYWNlKHRoaXMuZGVjaW1hbFNlcGFyYXRvciwgIi4iKTsKICAgICAgICAKICAgICAgICBpZihpc05hTih2YWx1ZSkpewogICAgICAgICAgICBlcnJvcnMucHVzaChTdHJpbmcuZm9ybWF0KHRoaXMubmFuVGV4dCwgdmFsdWUpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIG51bSA9IHRoaXMucGFyc2VWYWx1ZSh2YWx1ZSk7CiAgICAgICAgCiAgICAgICAgaWYgKG51bSA8IHRoaXMubWluVmFsdWUpIHsKICAgICAgICAgICAgZXJyb3JzLnB1c2goU3RyaW5nLmZvcm1hdCh0aGlzLm1pblRleHQsIHRoaXMubWluVmFsdWUpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKG51bSA+IHRoaXMubWF4VmFsdWUpIHsKICAgICAgICAgICAgZXJyb3JzLnB1c2goU3RyaW5nLmZvcm1hdCh0aGlzLm1heFRleHQsIHRoaXMubWF4VmFsdWUpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIGVycm9yczsKICAgIH0sCgogICAgZ2V0VmFsdWUgOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5maXhQcmVjaXNpb24odGhpcy5wYXJzZVZhbHVlKEV4dC5mb3JtLk51bWJlckZpZWxkLnN1cGVyY2xhc3MuZ2V0VmFsdWUuY2FsbCh0aGlzKSkpOwogICAgfSwKCiAgICBzZXRWYWx1ZSA6IGZ1bmN0aW9uKHYpIHsKICAgIAl2ID0gRXh0LmlzTnVtYmVyKHYpID8gdiA6IHBhcnNlRmxvYXQoU3RyaW5nKHYpLnJlcGxhY2UodGhpcy5kZWNpbWFsU2VwYXJhdG9yLCAiLiIpKTsKICAgICAgICB2ID0gdGhpcy5maXhQcmVjaXNpb24odik7CiAgICAgICAgdiA9IGlzTmFOKHYpID8gJycgOiBTdHJpbmcodikucmVwbGFjZSgiLiIsIHRoaXMuZGVjaW1hbFNlcGFyYXRvcik7CiAgICAgICAgcmV0dXJuIEV4dC5mb3JtLk51bWJlckZpZWxkLnN1cGVyY2xhc3Muc2V0VmFsdWUuY2FsbCh0aGlzLCB2KTsKICAgIH0sCiAgICAKICAgIAogICAgc2V0TWluVmFsdWUgOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMubWluVmFsdWUgPSBFeHQubnVtKHZhbHVlLCBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkpOwogICAgfSwKICAgIAogICAgCiAgICBzZXRNYXhWYWx1ZSA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5tYXhWYWx1ZSA9IEV4dC5udW0odmFsdWUsIE51bWJlci5NQVhfVkFMVUUpOyAgICAKICAgIH0sCgogICAgCiAgICBwYXJzZVZhbHVlIDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YWx1ZSA9IHBhcnNlRmxvYXQoU3RyaW5nKHZhbHVlKS5yZXBsYWNlKHRoaXMuZGVjaW1hbFNlcGFyYXRvciwgIi4iKSk7CiAgICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKSA/ICcnIDogdmFsdWU7CiAgICB9LAoKICAgIAogICAgZml4UHJlY2lzaW9uIDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgbmFuID0gaXNOYU4odmFsdWUpOwogICAgICAgIAogICAgICAgIGlmICghdGhpcy5hbGxvd0RlY2ltYWxzIHx8IHRoaXMuZGVjaW1hbFByZWNpc2lvbiA9PSAtMSB8fCBuYW4gfHwgIXZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBuYW4gPyAnJyA6IHZhbHVlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gcGFyc2VGbG9hdChwYXJzZUZsb2F0KHZhbHVlKS50b0ZpeGVkKHRoaXMuZGVjaW1hbFByZWNpc2lvbikpOwogICAgfSwKCiAgICBiZWZvcmVCbHVyIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHYgPSB0aGlzLnBhcnNlVmFsdWUodGhpcy5nZXRSYXdWYWx1ZSgpKTsKICAgICAgICAKICAgICAgICBpZiAoIUV4dC5pc0VtcHR5KHYpKSB7CiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodik7CiAgICAgICAgfQogICAgfQp9KTsKCkV4dC5yZWcoJ251bWJlcmZpZWxkJywgRXh0LmZvcm0uTnVtYmVyRmllbGQpOwoKRXh0LmZvcm0uRGF0ZUZpZWxkID0gRXh0LmV4dGVuZChFeHQuZm9ybS5UcmlnZ2VyRmllbGQsICB7CiAgICAKICAgIGZvcm1hdCA6ICJtL2QvWSIsCiAgICAKICAgIGFsdEZvcm1hdHMgOiAibS9kL1l8bi9qL1l8bi9qL3l8bS9qL3l8bi9kL3l8bS9qL1l8bi9kL1l8bS1kLXl8bS1kLVl8bS9kfG0tZHxtZHxtZHl8bWRZfGR8WS1tLWR8bi1qfG4vaiIsCiAgICAKICAgIGRpc2FibGVkRGF5c1RleHQgOiAiRGlzYWJsZWQiLAogICAgCiAgICBkaXNhYmxlZERhdGVzVGV4dCA6ICJEaXNhYmxlZCIsCiAgICAKICAgIG1pblRleHQgOiAiVGhlIGRhdGUgaW4gdGhpcyBmaWVsZCBtdXN0IGJlIGVxdWFsIHRvIG9yIGFmdGVyIHswfSIsCiAgICAKICAgIG1heFRleHQgOiAiVGhlIGRhdGUgaW4gdGhpcyBmaWVsZCBtdXN0IGJlIGVxdWFsIHRvIG9yIGJlZm9yZSB7MH0iLAogICAgCiAgICBpbnZhbGlkVGV4dCA6ICJ7MH0gaXMgbm90IGEgdmFsaWQgZGF0ZSAtIGl0IG11c3QgYmUgaW4gdGhlIGZvcm1hdCB7MX0iLAogICAgCiAgICB0cmlnZ2VyQ2xhc3MgOiAneC1mb3JtLWRhdGUtdHJpZ2dlcicsCiAgICAKICAgIHNob3dUb2RheSA6IHRydWUsCiAgICAKICAgIAogICAgc3RhcnREYXkgOiAwLAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAoKICAgIAogICAgZGVmYXVsdEF1dG9DcmVhdGUgOiB7dGFnOiAiaW5wdXQiLCB0eXBlOiAidGV4dCIsIHNpemU6ICIxMCIsIGF1dG9jb21wbGV0ZTogIm9mZiJ9LAoKICAgIAogICAgCiAgICBpbml0VGltZTogJzEyJywgCgogICAgaW5pdFRpbWVGb3JtYXQ6ICdIJywKCiAgICAKICAgIHNhZmVQYXJzZSA6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXQpIHsKICAgICAgICBpZiAoRGF0ZS5mb3JtYXRDb250YWluc0hvdXJJbmZvKGZvcm1hdCkpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBEYXRlLnBhcnNlRGF0ZSh2YWx1ZSwgZm9ybWF0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHBhcnNlZERhdGUgPSBEYXRlLnBhcnNlRGF0ZSh2YWx1ZSArICcgJyArIHRoaXMuaW5pdFRpbWUsIGZvcm1hdCArICcgJyArIHRoaXMuaW5pdFRpbWVGb3JtYXQpOwogCiAgICAgICAgICAgIGlmIChwYXJzZWREYXRlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VkRGF0ZS5jbGVhclRpbWUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmZvcm0uRGF0ZUZpZWxkLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwoKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICdzZWxlY3QnCiAgICAgICAgKTsKCiAgICAgICAgaWYoRXh0LmlzU3RyaW5nKHRoaXMubWluVmFsdWUpKXsKICAgICAgICAgICAgdGhpcy5taW5WYWx1ZSA9IHRoaXMucGFyc2VEYXRlKHRoaXMubWluVmFsdWUpOwogICAgICAgIH0KICAgICAgICBpZihFeHQuaXNTdHJpbmcodGhpcy5tYXhWYWx1ZSkpewogICAgICAgICAgICB0aGlzLm1heFZhbHVlID0gdGhpcy5wYXJzZURhdGUodGhpcy5tYXhWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZGlzYWJsZWREYXRlc1JFID0gbnVsbDsKICAgICAgICB0aGlzLmluaXREaXNhYmxlZERheXMoKTsKICAgIH0sCgogICAgaW5pdEV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgICAgRXh0LmZvcm0uRGF0ZUZpZWxkLnN1cGVyY2xhc3MuaW5pdEV2ZW50cy5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMua2V5TmF2ID0gbmV3IEV4dC5LZXlOYXYodGhpcy5lbCwgewogICAgICAgICAgICAiZG93biI6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHRoaXMub25UcmlnZ2VyQ2xpY2soKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgIGZvcmNlS2V5RG93bjogdHJ1ZQogICAgICAgIH0pOwogICAgfSwKCgogICAgCiAgICBpbml0RGlzYWJsZWREYXlzIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmRpc2FibGVkRGF0ZXMpewogICAgICAgICAgICB2YXIgZGQgPSB0aGlzLmRpc2FibGVkRGF0ZXMsCiAgICAgICAgICAgICAgICBsZW4gPSBkZC5sZW5ndGggLSAxLAogICAgICAgICAgICAgICAgcmUgPSAiKD86IjsKCiAgICAgICAgICAgIEV4dC5lYWNoKGRkLCBmdW5jdGlvbihkLCBpKXsKICAgICAgICAgICAgICAgIHJlICs9IEV4dC5pc0RhdGUoZCkgPyAnXicgKyBFeHQuZXNjYXBlUmUoZC5kYXRlRm9ybWF0KHRoaXMuZm9ybWF0KSkgKyAnJCcgOiBkZFtpXTsKICAgICAgICAgICAgICAgIGlmKGkgIT0gbGVuKXsKICAgICAgICAgICAgICAgICAgICByZSArPSAnfCc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICB0aGlzLmRpc2FibGVkRGF0ZXNSRSA9IG5ldyBSZWdFeHAocmUgKyAnKScpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXREaXNhYmxlZERhdGVzIDogZnVuY3Rpb24oZGQpewogICAgICAgIHRoaXMuZGlzYWJsZWREYXRlcyA9IGRkOwogICAgICAgIHRoaXMuaW5pdERpc2FibGVkRGF5cygpOwogICAgICAgIGlmKHRoaXMubWVudSl7CiAgICAgICAgICAgIHRoaXMubWVudS5waWNrZXIuc2V0RGlzYWJsZWREYXRlcyh0aGlzLmRpc2FibGVkRGF0ZXNSRSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNldERpc2FibGVkRGF5cyA6IGZ1bmN0aW9uKGRkKXsKICAgICAgICB0aGlzLmRpc2FibGVkRGF5cyA9IGRkOwogICAgICAgIGlmKHRoaXMubWVudSl7CiAgICAgICAgICAgIHRoaXMubWVudS5waWNrZXIuc2V0RGlzYWJsZWREYXlzKGRkKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0TWluVmFsdWUgOiBmdW5jdGlvbihkdCl7CiAgICAgICAgdGhpcy5taW5WYWx1ZSA9IChFeHQuaXNTdHJpbmcoZHQpID8gdGhpcy5wYXJzZURhdGUoZHQpIDogZHQpOwogICAgICAgIGlmKHRoaXMubWVudSl7CiAgICAgICAgICAgIHRoaXMubWVudS5waWNrZXIuc2V0TWluRGF0ZSh0aGlzLm1pblZhbHVlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0TWF4VmFsdWUgOiBmdW5jdGlvbihkdCl7CiAgICAgICAgdGhpcy5tYXhWYWx1ZSA9IChFeHQuaXNTdHJpbmcoZHQpID8gdGhpcy5wYXJzZURhdGUoZHQpIDogZHQpOwogICAgICAgIGlmKHRoaXMubWVudSl7CiAgICAgICAgICAgIHRoaXMubWVudS5waWNrZXIuc2V0TWF4RGF0ZSh0aGlzLm1heFZhbHVlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0RXJyb3JzOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBlcnJvcnMgPSBFeHQuZm9ybS5EYXRlRmllbGQuc3VwZXJjbGFzcy5nZXRFcnJvcnMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgdmFsdWUgPSB0aGlzLmZvcm1hdERhdGUodmFsdWUgfHwgdGhpcy5wcm9jZXNzVmFsdWUodGhpcy5nZXRSYXdWYWx1ZSgpKSk7CgogICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPCAxKSB7IAogICAgICAgICAgICAgcmV0dXJuIGVycm9yczsKICAgICAgICB9CgogICAgICAgIHZhciBzdmFsdWUgPSB2YWx1ZTsKICAgICAgICB2YWx1ZSA9IHRoaXMucGFyc2VEYXRlKHZhbHVlKTsKICAgICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgICAgIGVycm9ycy5wdXNoKFN0cmluZy5mb3JtYXQodGhpcy5pbnZhbGlkVGV4dCwgc3ZhbHVlLCB0aGlzLmZvcm1hdCkpOwogICAgICAgICAgICByZXR1cm4gZXJyb3JzOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRpbWUgPSB2YWx1ZS5nZXRUaW1lKCk7CiAgICAgICAgaWYgKHRoaXMubWluVmFsdWUgJiYgdGltZSA8IHRoaXMubWluVmFsdWUuY2xlYXJUaW1lKCkuZ2V0VGltZSgpKSB7CiAgICAgICAgICAgIGVycm9ycy5wdXNoKFN0cmluZy5mb3JtYXQodGhpcy5taW5UZXh0LCB0aGlzLmZvcm1hdERhdGUodGhpcy5taW5WYWx1ZSkpKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm1heFZhbHVlICYmIHRpbWUgPiB0aGlzLm1heFZhbHVlLmNsZWFyVGltZSgpLmdldFRpbWUoKSkgewogICAgICAgICAgICBlcnJvcnMucHVzaChTdHJpbmcuZm9ybWF0KHRoaXMubWF4VGV4dCwgdGhpcy5mb3JtYXREYXRlKHRoaXMubWF4VmFsdWUpKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5kaXNhYmxlZERheXMpIHsKICAgICAgICAgICAgdmFyIGRheSA9IHZhbHVlLmdldERheSgpOwoKICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IHRoaXMuZGlzYWJsZWREYXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF5ID09PSB0aGlzLmRpc2FibGVkRGF5c1tpXSkgewogICAgICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHRoaXMuZGlzYWJsZWREYXlzVGV4dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBmdmFsdWUgPSB0aGlzLmZvcm1hdERhdGUodmFsdWUpOwogICAgICAgIGlmICh0aGlzLmRpc2FibGVkRGF0ZXNSRSAmJiB0aGlzLmRpc2FibGVkRGF0ZXNSRS50ZXN0KGZ2YWx1ZSkpIHsKICAgICAgICAgICAgZXJyb3JzLnB1c2goU3RyaW5nLmZvcm1hdCh0aGlzLmRpc2FibGVkRGF0ZXNUZXh0LCBmdmFsdWUpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBlcnJvcnM7CiAgICB9LAoKICAgIAogICAgCiAgICB2YWxpZGF0ZUJsdXIgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiAhdGhpcy5tZW51IHx8ICF0aGlzLm1lbnUuaXNWaXNpYmxlKCk7CiAgICB9LAoKICAgIAogICAgZ2V0VmFsdWUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnBhcnNlRGF0ZShFeHQuZm9ybS5EYXRlRmllbGQuc3VwZXJjbGFzcy5nZXRWYWx1ZS5jYWxsKHRoaXMpKSB8fCAiIjsKICAgIH0sCgogICAgCiAgICBzZXRWYWx1ZSA6IGZ1bmN0aW9uKGRhdGUpewogICAgICAgIHJldHVybiBFeHQuZm9ybS5EYXRlRmllbGQuc3VwZXJjbGFzcy5zZXRWYWx1ZS5jYWxsKHRoaXMsIHRoaXMuZm9ybWF0RGF0ZSh0aGlzLnBhcnNlRGF0ZShkYXRlKSkpOwogICAgfSwKCiAgICAKICAgIHBhcnNlRGF0ZSA6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYoIXZhbHVlIHx8IEV4dC5pc0RhdGUodmFsdWUpKXsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KCiAgICAgICAgdmFyIHYgPSB0aGlzLnNhZmVQYXJzZSh2YWx1ZSwgdGhpcy5mb3JtYXQpLAogICAgICAgICAgICBhZiA9IHRoaXMuYWx0Rm9ybWF0cywKICAgICAgICAgICAgYWZhID0gdGhpcy5hbHRGb3JtYXRzQXJyYXk7CgogICAgICAgIGlmICghdiAmJiBhZikgewogICAgICAgICAgICBhZmEgPSBhZmEgfHwgYWYuc3BsaXQoInwiKTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBhZmEubGVuZ3RoOyBpIDwgbGVuICYmICF2OyBpKyspIHsKICAgICAgICAgICAgICAgIHYgPSB0aGlzLnNhZmVQYXJzZSh2YWx1ZSwgYWZhW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdjsKICAgIH0sCgogICAgCiAgICBvbkRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5kZXN0cm95KHRoaXMubWVudSwgdGhpcy5rZXlOYXYpOwogICAgICAgIEV4dC5mb3JtLkRhdGVGaWVsZC5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICAKICAgIGZvcm1hdERhdGUgOiBmdW5jdGlvbihkYXRlKXsKICAgICAgICByZXR1cm4gRXh0LmlzRGF0ZShkYXRlKSA/IGRhdGUuZGF0ZUZvcm1hdCh0aGlzLmZvcm1hdCkgOiBkYXRlOwogICAgfSwKCiAgICAKICAgIAogICAgCiAgICBvblRyaWdnZXJDbGljayA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5kaXNhYmxlZCl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5tZW51ID09IG51bGwpewogICAgICAgICAgICB0aGlzLm1lbnUgPSBuZXcgRXh0Lm1lbnUuRGF0ZU1lbnUoewogICAgICAgICAgICAgICAgaGlkZU9uQ2xpY2s6IGZhbHNlLAogICAgICAgICAgICAgICAgZm9jdXNPblNlbGVjdDogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHRoaXMub25Gb2N1cygpOwogICAgICAgIEV4dC5hcHBseSh0aGlzLm1lbnUucGlja2VyLCAgewogICAgICAgICAgICBtaW5EYXRlIDogdGhpcy5taW5WYWx1ZSwKICAgICAgICAgICAgbWF4RGF0ZSA6IHRoaXMubWF4VmFsdWUsCiAgICAgICAgICAgIGRpc2FibGVkRGF0ZXNSRSA6IHRoaXMuZGlzYWJsZWREYXRlc1JFLAogICAgICAgICAgICBkaXNhYmxlZERhdGVzVGV4dCA6IHRoaXMuZGlzYWJsZWREYXRlc1RleHQsCiAgICAgICAgICAgIGRpc2FibGVkRGF5cyA6IHRoaXMuZGlzYWJsZWREYXlzLAogICAgICAgICAgICBkaXNhYmxlZERheXNUZXh0IDogdGhpcy5kaXNhYmxlZERheXNUZXh0LAogICAgICAgICAgICBmb3JtYXQgOiB0aGlzLmZvcm1hdCwKICAgICAgICAgICAgc2hvd1RvZGF5IDogdGhpcy5zaG93VG9kYXksCiAgICAgICAgICAgIHN0YXJ0RGF5OiB0aGlzLnN0YXJ0RGF5LAogICAgICAgICAgICBtaW5UZXh0IDogU3RyaW5nLmZvcm1hdCh0aGlzLm1pblRleHQsIHRoaXMuZm9ybWF0RGF0ZSh0aGlzLm1pblZhbHVlKSksCiAgICAgICAgICAgIG1heFRleHQgOiBTdHJpbmcuZm9ybWF0KHRoaXMubWF4VGV4dCwgdGhpcy5mb3JtYXREYXRlKHRoaXMubWF4VmFsdWUpKQogICAgICAgIH0pOwogICAgICAgIHRoaXMubWVudS5waWNrZXIuc2V0VmFsdWUodGhpcy5nZXRWYWx1ZSgpIHx8IG5ldyBEYXRlKCkpOwogICAgICAgIHRoaXMubWVudS5zaG93KHRoaXMuZWwsICJ0bC1ibD8iKTsKICAgICAgICB0aGlzLm1lbnVFdmVudHMoJ29uJyk7CiAgICB9LAoKICAgIAogICAgbWVudUV2ZW50czogZnVuY3Rpb24obWV0aG9kKXsKICAgICAgICB0aGlzLm1lbnVbbWV0aG9kXSgnc2VsZWN0JywgdGhpcy5vblNlbGVjdCwgdGhpcyk7CiAgICAgICAgdGhpcy5tZW51W21ldGhvZF0oJ2hpZGUnLCB0aGlzLm9uTWVudUhpZGUsIHRoaXMpOwogICAgICAgIHRoaXMubWVudVttZXRob2RdKCdzaG93JywgdGhpcy5vbkZvY3VzLCB0aGlzKTsKICAgIH0sCgogICAgb25TZWxlY3Q6IGZ1bmN0aW9uKG0sIGQpewogICAgICAgIHRoaXMuc2V0VmFsdWUoZCk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3NlbGVjdCcsIHRoaXMsIGQpOwogICAgICAgIHRoaXMubWVudS5oaWRlKCk7CiAgICB9LAoKICAgIG9uTWVudUhpZGU6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5mb2N1cyhmYWxzZSwgNjApOwogICAgICAgIHRoaXMubWVudUV2ZW50cygndW4nKTsKICAgIH0sCgogICAgCiAgICBiZWZvcmVCbHVyIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdiA9IHRoaXMucGFyc2VEYXRlKHRoaXMuZ2V0UmF3VmFsdWUoKSk7CiAgICAgICAgaWYodil7CiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodik7CiAgICAgICAgfQogICAgfQoKICAgIAogICAgCiAgICAKICAgIAp9KTsKRXh0LnJlZygnZGF0ZWZpZWxkJywgRXh0LmZvcm0uRGF0ZUZpZWxkKTsKCkV4dC5mb3JtLkRpc3BsYXlGaWVsZCA9IEV4dC5leHRlbmQoRXh0LmZvcm0uRmllbGQsICB7CiAgICB2YWxpZGF0aW9uRXZlbnQgOiBmYWxzZSwKICAgIHZhbGlkYXRlT25CbHVyIDogZmFsc2UsCiAgICBkZWZhdWx0QXV0b0NyZWF0ZSA6IHt0YWc6ICJkaXYifSwKICAgIAogICAgZmllbGRDbGFzcyA6ICJ4LWZvcm0tZGlzcGxheS1maWVsZCIsCiAgICAKICAgIGh0bWxFbmNvZGU6IGZhbHNlLAoKICAgIAogICAgaW5pdEV2ZW50cyA6IEV4dC5lbXB0eUZuLAoKICAgIGlzVmFsaWQgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICB2YWxpZGF0ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIGdldFJhd1ZhbHVlIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdiA9IHRoaXMucmVuZGVyZWQgPyB0aGlzLmVsLmRvbS5pbm5lckhUTUwgOiBFeHQudmFsdWUodGhpcy52YWx1ZSwgJycpOwogICAgICAgIGlmKHYgPT09IHRoaXMuZW1wdHlUZXh0KXsKICAgICAgICAgICAgdiA9ICcnOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmh0bWxFbmNvZGUpewogICAgICAgICAgICB2ID0gRXh0LnV0aWwuRm9ybWF0Lmh0bWxEZWNvZGUodik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2OwogICAgfSwKCiAgICBnZXRWYWx1ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UmF3VmFsdWUoKTsKICAgIH0sCiAgICAKICAgIGdldE5hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLm5hbWU7CiAgICB9LAoKICAgIHNldFJhd1ZhbHVlIDogZnVuY3Rpb24odil7CiAgICAgICAgaWYodGhpcy5odG1sRW5jb2RlKXsKICAgICAgICAgICAgdiA9IEV4dC51dGlsLkZvcm1hdC5odG1sRW5jb2RlKHYpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJlZCA/ICh0aGlzLmVsLmRvbS5pbm5lckhUTUwgPSAoRXh0LmlzRW1wdHkodikgPyAnJyA6IHYpKSA6ICh0aGlzLnZhbHVlID0gdik7CiAgICB9LAoKICAgIHNldFZhbHVlIDogZnVuY3Rpb24odil7CiAgICAgICAgdGhpcy5zZXRSYXdWYWx1ZSh2KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKfSk7CgpFeHQucmVnKCdkaXNwbGF5ZmllbGQnLCBFeHQuZm9ybS5EaXNwbGF5RmllbGQpOwoKRXh0LmZvcm0uQ29tYm9Cb3ggPSBFeHQuZXh0ZW5kKEV4dC5mb3JtLlRyaWdnZXJGaWVsZCwgewogICAgCiAgICAKICAgIAogICAgCiAgICAKCiAgICAKICAgIGRlZmF1bHRBdXRvQ3JlYXRlIDoge3RhZzogImlucHV0IiwgdHlwZTogInRleHQiLCBzaXplOiAiMjQiLCBhdXRvY29tcGxldGU6ICJvZmYifSwKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgbGlzdENsYXNzIDogJycsCiAgICAKICAgIHNlbGVjdGVkQ2xhc3MgOiAneC1jb21iby1zZWxlY3RlZCcsCiAgICAKICAgIGxpc3RFbXB0eVRleHQ6ICcnLAogICAgCiAgICB0cmlnZ2VyQ2xhc3MgOiAneC1mb3JtLWFycm93LXRyaWdnZXInLAogICAgCiAgICBzaGFkb3cgOiAnc2lkZXMnLAogICAgCiAgICBsaXN0QWxpZ24gOiAndGwtYmw/JywKICAgIAogICAgbWF4SGVpZ2h0IDogMzAwLAogICAgCiAgICBtaW5IZWlnaHQgOiA5MCwKICAgIAogICAgdHJpZ2dlckFjdGlvbiA6ICdxdWVyeScsCiAgICAKICAgIG1pbkNoYXJzIDogNCwKICAgIAogICAgYXV0b1NlbGVjdCA6IHRydWUsCiAgICAKICAgIHR5cGVBaGVhZCA6IGZhbHNlLAogICAgCiAgICBxdWVyeURlbGF5IDogNTAwLAogICAgCiAgICBwYWdlU2l6ZSA6IDAsCiAgICAKICAgIHNlbGVjdE9uRm9jdXMgOiBmYWxzZSwKICAgIAogICAgcXVlcnlQYXJhbSA6ICdxdWVyeScsCiAgICAKICAgIGxvYWRpbmdUZXh0IDogJ0xvYWRpbmcuLi4nLAogICAgCiAgICByZXNpemFibGUgOiBmYWxzZSwKICAgIAogICAgaGFuZGxlSGVpZ2h0IDogOCwKICAgIAogICAgYWxsUXVlcnk6ICcnLAogICAgCiAgICBtb2RlOiAncmVtb3RlJywKICAgIAogICAgbWluTGlzdFdpZHRoIDogNzAsCiAgICAKICAgIGZvcmNlU2VsZWN0aW9uIDogZmFsc2UsCiAgICAKICAgIHR5cGVBaGVhZERlbGF5IDogMjUwLAogICAgCgogICAgCiAgICBsYXp5SW5pdCA6IHRydWUsCgogICAgCiAgICBjbGVhckZpbHRlck9uUmVzZXQgOiB0cnVlLAoKICAgIAogICAgc3VibWl0VmFsdWU6IHVuZGVmaW5lZCwKCiAgICAKCiAgICAKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5mb3JtLkNvbWJvQm94LnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2V4cGFuZCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAnY29sbGFwc2UnLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVzZWxlY3QnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ3NlbGVjdCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYmVmb3JlcXVlcnknCiAgICAgICAgKTsKICAgICAgICBpZih0aGlzLnRyYW5zZm9ybSl7CiAgICAgICAgICAgIHZhciBzID0gRXh0LmdldERvbSh0aGlzLnRyYW5zZm9ybSk7CiAgICAgICAgICAgIGlmKCF0aGlzLmhpZGRlbk5hbWUpewogICAgICAgICAgICAgICAgdGhpcy5oaWRkZW5OYW1lID0gcy5uYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCF0aGlzLnN0b3JlKXsKICAgICAgICAgICAgICAgIHRoaXMubW9kZSA9ICdsb2NhbCc7CiAgICAgICAgICAgICAgICB2YXIgZCA9IFtdLCBvcHRzID0gcy5vcHRpb25zOwogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gb3B0cy5sZW5ndGg7aSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB2YXIgbyA9IG9wdHNbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gKG8uaGFzQXR0cmlidXRlID8gby5oYXNBdHRyaWJ1dGUoJ3ZhbHVlJykgOiBvLmdldEF0dHJpYnV0ZU5vZGUoJ3ZhbHVlJykuc3BlY2lmaWVkKSA/IG8udmFsdWUgOiBvLnRleHQ7CiAgICAgICAgICAgICAgICAgICAgaWYoby5zZWxlY3RlZCAmJiBFeHQuaXNFbXB0eSh0aGlzLnZhbHVlLCB0cnVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGQucHVzaChbdmFsdWUsIG8udGV4dF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5zdG9yZSA9IG5ldyBFeHQuZGF0YS5BcnJheVN0b3JlKHsKICAgICAgICAgICAgICAgICAgICBpZEluZGV4OiAwLAogICAgICAgICAgICAgICAgICAgIGZpZWxkczogWyd2YWx1ZScsICd0ZXh0J10sCiAgICAgICAgICAgICAgICAgICAgZGF0YSA6IGQsCiAgICAgICAgICAgICAgICAgICAgYXV0b0Rlc3Ryb3k6IHRydWUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdGhpcy52YWx1ZUZpZWxkID0gJ3ZhbHVlJzsKICAgICAgICAgICAgICAgIHRoaXMuZGlzcGxheUZpZWxkID0gJ3RleHQnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHMubmFtZSA9IEV4dC5pZCgpOyAKICAgICAgICAgICAgaWYoIXRoaXMubGF6eVJlbmRlcil7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldCA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmVsID0gRXh0LkRvbUhlbHBlci5pbnNlcnRCZWZvcmUocywgdGhpcy5hdXRvQ3JlYXRlIHx8IHRoaXMuZGVmYXVsdEF1dG9DcmVhdGUpOwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIodGhpcy5lbC5wYXJlbnROb2RlLCBzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFeHQucmVtb3ZlTm9kZShzKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZWxzZSBpZih0aGlzLnN0b3JlKXsKICAgICAgICAgICAgdGhpcy5zdG9yZSA9IEV4dC5TdG9yZU1nci5sb29rdXAodGhpcy5zdG9yZSk7CiAgICAgICAgICAgIGlmKHRoaXMuc3RvcmUuYXV0b0NyZWF0ZWQpewogICAgICAgICAgICAgICAgdGhpcy5kaXNwbGF5RmllbGQgPSB0aGlzLnZhbHVlRmllbGQgPSAnZmllbGQxJzsKICAgICAgICAgICAgICAgIGlmKCF0aGlzLnN0b3JlLmV4cGFuZERhdGEpewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzcGxheUZpZWxkID0gJ2ZpZWxkMic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLm1vZGUgPSAnbG9jYWwnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNlbGVjdGVkSW5kZXggPSAtMTsKICAgICAgICBpZih0aGlzLm1vZGUgPT0gJ2xvY2FsJyl7CiAgICAgICAgICAgIGlmKCFFeHQuaXNEZWZpbmVkKHRoaXMuaW5pdGlhbENvbmZpZy5xdWVyeURlbGF5KSl7CiAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5RGVsYXkgPSAxMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighRXh0LmlzRGVmaW5lZCh0aGlzLmluaXRpYWxDb25maWcubWluQ2hhcnMpKXsKICAgICAgICAgICAgICAgIHRoaXMubWluQ2hhcnMgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKXsKICAgICAgICBpZih0aGlzLmhpZGRlbk5hbWUgJiYgIUV4dC5pc0RlZmluZWQodGhpcy5zdWJtaXRWYWx1ZSkpewogICAgICAgICAgICB0aGlzLnN1Ym1pdFZhbHVlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIEV4dC5mb3JtLkNvbWJvQm94LnN1cGVyY2xhc3Mub25SZW5kZXIuY2FsbCh0aGlzLCBjdCwgcG9zaXRpb24pOwogICAgICAgIGlmKHRoaXMuaGlkZGVuTmFtZSl7CiAgICAgICAgICAgIHRoaXMuaGlkZGVuRmllbGQgPSB0aGlzLmVsLmluc2VydFNpYmxpbmcoe3RhZzonaW5wdXQnLCB0eXBlOidoaWRkZW4nLCBuYW1lOiB0aGlzLmhpZGRlbk5hbWUsCiAgICAgICAgICAgICAgICAgICAgaWQ6ICh0aGlzLmhpZGRlbklkIHx8IEV4dC5pZCgpKX0sICdiZWZvcmUnLCB0cnVlKTsKCiAgICAgICAgfQogICAgICAgIGlmKEV4dC5pc0dlY2tvKXsKICAgICAgICAgICAgdGhpcy5lbC5kb20uc2V0QXR0cmlidXRlKCdhdXRvY29tcGxldGUnLCAnb2ZmJyk7CiAgICAgICAgfQoKICAgICAgICBpZighdGhpcy5sYXp5SW5pdCl7CiAgICAgICAgICAgIHRoaXMuaW5pdExpc3QoKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5vbignZm9jdXMnLCB0aGlzLmluaXRMaXN0LCB0aGlzLCB7c2luZ2xlOiB0cnVlfSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGluaXRWYWx1ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmZvcm0uQ29tYm9Cb3guc3VwZXJjbGFzcy5pbml0VmFsdWUuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLmhpZGRlbkZpZWxkKXsKICAgICAgICAgICAgdGhpcy5oaWRkZW5GaWVsZC52YWx1ZSA9CiAgICAgICAgICAgICAgICBFeHQudmFsdWUoRXh0LmlzRGVmaW5lZCh0aGlzLmhpZGRlblZhbHVlKSA/IHRoaXMuaGlkZGVuVmFsdWUgOiB0aGlzLnZhbHVlLCAnJyk7CiAgICAgICAgfQogICAgfSwKCiAgICBnZXRQYXJlbnRaSW5kZXggOiBmdW5jdGlvbigpewogICAgICAgIHZhciB6aW5kZXg7CiAgICAgICAgaWYgKHRoaXMub3duZXJDdCl7CiAgICAgICAgICAgIHRoaXMuZmluZFBhcmVudEJ5KGZ1bmN0aW9uKGN0KXsKICAgICAgICAgICAgICAgIHppbmRleCA9IHBhcnNlSW50KGN0LmdldFBvc2l0aW9uRWwoKS5nZXRTdHlsZSgnei1pbmRleCcpLCAxMCk7CiAgICAgICAgICAgICAgICByZXR1cm4gISF6aW5kZXg7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gemluZGV4OwogICAgfSwKICAgIAogICAgZ2V0WkluZGV4IDogZnVuY3Rpb24obGlzdFBhcmVudCl7CiAgICAgICAgbGlzdFBhcmVudCA9IGxpc3RQYXJlbnQgfHwgRXh0LmdldERvbSh0aGlzLmdldExpc3RQYXJlbnQoKSB8fCBFeHQuZ2V0Qm9keSgpKTsKICAgICAgICB2YXIgemluZGV4ID0gcGFyc2VJbnQoRXh0LmZseShsaXN0UGFyZW50KS5nZXRTdHlsZSgnei1pbmRleCcpLCAxMCk7CiAgICAgICAgaWYoIXppbmRleCl7CiAgICAgICAgICAgIHppbmRleCA9IHRoaXMuZ2V0UGFyZW50WkluZGV4KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAoemluZGV4IHx8IDEyMDAwKSArIDU7CiAgICB9LAoKICAgIAogICAgaW5pdExpc3QgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLmxpc3QpewogICAgICAgICAgICB2YXIgY2xzID0gJ3gtY29tYm8tbGlzdCcsCiAgICAgICAgICAgICAgICBsaXN0UGFyZW50ID0gRXh0LmdldERvbSh0aGlzLmdldExpc3RQYXJlbnQoKSB8fCBFeHQuZ2V0Qm9keSgpKTsKCiAgICAgICAgICAgIHRoaXMubGlzdCA9IG5ldyBFeHQuTGF5ZXIoewogICAgICAgICAgICAgICAgcGFyZW50RWw6IGxpc3RQYXJlbnQsCiAgICAgICAgICAgICAgICBzaGFkb3c6IHRoaXMuc2hhZG93LAogICAgICAgICAgICAgICAgY2xzOiBbY2xzLCB0aGlzLmxpc3RDbGFzc10uam9pbignICcpLAogICAgICAgICAgICAgICAgY29uc3RyYWluOmZhbHNlLAogICAgICAgICAgICAgICAgemluZGV4OiB0aGlzLmdldFpJbmRleChsaXN0UGFyZW50KQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciBsdyA9IHRoaXMubGlzdFdpZHRoIHx8IE1hdGgubWF4KHRoaXMud3JhcC5nZXRXaWR0aCgpLCB0aGlzLm1pbkxpc3RXaWR0aCk7CiAgICAgICAgICAgIHRoaXMubGlzdC5zZXRTaXplKGx3LCAwKTsKICAgICAgICAgICAgdGhpcy5saXN0LnN3YWxsb3dFdmVudCgnbW91c2V3aGVlbCcpOwogICAgICAgICAgICB0aGlzLmFzc2V0SGVpZ2h0ID0gMDsKICAgICAgICAgICAgaWYodGhpcy5zeW5jRm9udCAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgdGhpcy5saXN0LnNldFN0eWxlKCdmb250LXNpemUnLCB0aGlzLmVsLmdldFN0eWxlKCdmb250LXNpemUnKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy50aXRsZSl7CiAgICAgICAgICAgICAgICB0aGlzLmhlYWRlciA9IHRoaXMubGlzdC5jcmVhdGVDaGlsZCh7Y2xzOmNscysnLWhkJywgaHRtbDogdGhpcy50aXRsZX0pOwogICAgICAgICAgICAgICAgdGhpcy5hc3NldEhlaWdodCArPSB0aGlzLmhlYWRlci5nZXRIZWlnaHQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5pbm5lckxpc3QgPSB0aGlzLmxpc3QuY3JlYXRlQ2hpbGQoe2NsczpjbHMrJy1pbm5lcid9KTsKICAgICAgICAgICAgdGhpcy5tb24odGhpcy5pbm5lckxpc3QsICdtb3VzZW92ZXInLCB0aGlzLm9uVmlld092ZXIsIHRoaXMpOwogICAgICAgICAgICB0aGlzLm1vbih0aGlzLmlubmVyTGlzdCwgJ21vdXNlbW92ZScsIHRoaXMub25WaWV3TW92ZSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuaW5uZXJMaXN0LnNldFdpZHRoKGx3IC0gdGhpcy5saXN0LmdldEZyYW1lV2lkdGgoJ2xyJykpOwoKICAgICAgICAgICAgaWYodGhpcy5wYWdlU2l6ZSl7CiAgICAgICAgICAgICAgICB0aGlzLmZvb3RlciA9IHRoaXMubGlzdC5jcmVhdGVDaGlsZCh7Y2xzOmNscysnLWZ0J30pOwogICAgICAgICAgICAgICAgdGhpcy5wYWdlVGIgPSBuZXcgRXh0LlBhZ2luZ1Rvb2xiYXIoewogICAgICAgICAgICAgICAgICAgIHN0b3JlOiB0aGlzLnN0b3JlLAogICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiB0aGlzLnBhZ2VTaXplLAogICAgICAgICAgICAgICAgICAgIHJlbmRlclRvOnRoaXMuZm9vdGVyCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuYXNzZXRIZWlnaHQgKz0gdGhpcy5mb290ZXIuZ2V0SGVpZ2h0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKCF0aGlzLnRwbCl7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMudHBsID0gJzx0cGwgZm9yPSIuIj48ZGl2IGNsYXNzPSInK2NscysnLWl0ZW0iPnsnICsgdGhpcy5kaXNwbGF5RmllbGQgKyAnfTwvZGl2PjwvdHBsPic7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfQoKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMudmlldyA9IG5ldyBFeHQuRGF0YVZpZXcoewogICAgICAgICAgICAgICAgYXBwbHlUbzogdGhpcy5pbm5lckxpc3QsCiAgICAgICAgICAgICAgICB0cGw6IHRoaXMudHBsLAogICAgICAgICAgICAgICAgc2luZ2xlU2VsZWN0OiB0cnVlLAogICAgICAgICAgICAgICAgc2VsZWN0ZWRDbGFzczogdGhpcy5zZWxlY3RlZENsYXNzLAogICAgICAgICAgICAgICAgaXRlbVNlbGVjdG9yOiB0aGlzLml0ZW1TZWxlY3RvciB8fCAnLicgKyBjbHMgKyAnLWl0ZW0nLAogICAgICAgICAgICAgICAgZW1wdHlUZXh0OiB0aGlzLmxpc3RFbXB0eVRleHQsCiAgICAgICAgICAgICAgICBkZWZlckVtcHR5VGV4dDogZmFsc2UKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLm1vbih0aGlzLnZpZXcsIHsKICAgICAgICAgICAgICAgIGNvbnRhaW5lcmNsaWNrIDogdGhpcy5vblZpZXdDbGljaywKICAgICAgICAgICAgICAgIGNsaWNrIDogdGhpcy5vblZpZXdDbGljaywKICAgICAgICAgICAgICAgIHNjb3BlIDp0aGlzCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy5iaW5kU3RvcmUodGhpcy5zdG9yZSwgdHJ1ZSk7CgogICAgICAgICAgICBpZih0aGlzLnJlc2l6YWJsZSl7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2l6ZXIgPSBuZXcgRXh0LlJlc2l6YWJsZSh0aGlzLmxpc3QsICB7CiAgICAgICAgICAgICAgICAgICBwaW5uZWQ6dHJ1ZSwgaGFuZGxlczonc2UnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMubW9uKHRoaXMucmVzaXplciwgJ3Jlc2l6ZScsIGZ1bmN0aW9uKHIsIHcsIGgpewogICAgICAgICAgICAgICAgICAgIHRoaXMubWF4SGVpZ2h0ID0gaC10aGlzLmhhbmRsZUhlaWdodC10aGlzLmxpc3QuZ2V0RnJhbWVXaWR0aCgndGInKS10aGlzLmFzc2V0SGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdFdpZHRoID0gdzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlubmVyTGlzdC5zZXRXaWR0aCh3IC0gdGhpcy5saXN0LmdldEZyYW1lV2lkdGgoJ2xyJykpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVzdHJpY3RIZWlnaHQoKTsKICAgICAgICAgICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAgICAgICAgIHRoaXNbdGhpcy5wYWdlU2l6ZT8nZm9vdGVyJzonaW5uZXJMaXN0J10uc2V0U3R5bGUoJ21hcmdpbi1ib3R0b20nLCB0aGlzLmhhbmRsZUhlaWdodCsncHgnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRMaXN0UGFyZW50IDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmJvZHk7CiAgICB9LAoKICAgIAogICAgZ2V0U3RvcmUgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnN0b3JlOwogICAgfSwKCiAgICAKICAgIGJpbmRTdG9yZSA6IGZ1bmN0aW9uKHN0b3JlLCBpbml0aWFsKXsKICAgICAgICBpZih0aGlzLnN0b3JlICYmICFpbml0aWFsKXsKICAgICAgICAgICAgaWYodGhpcy5zdG9yZSAhPT0gc3RvcmUgJiYgdGhpcy5zdG9yZS5hdXRvRGVzdHJveSl7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JlLmRlc3Ryb3koKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JlLnVuKCdiZWZvcmVsb2FkJywgdGhpcy5vbkJlZm9yZUxvYWQsIHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy5zdG9yZS51bignbG9hZCcsIHRoaXMub25Mb2FkLCB0aGlzKTsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUudW4oJ2V4Y2VwdGlvbicsIHRoaXMuY29sbGFwc2UsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCFzdG9yZSl7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3JlID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmKHRoaXMudmlldyl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52aWV3LmJpbmRTdG9yZShudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKHRoaXMucGFnZVRiKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhZ2VUYi5iaW5kU3RvcmUobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoc3RvcmUpewogICAgICAgICAgICBpZighaW5pdGlhbCkgewogICAgICAgICAgICAgICAgdGhpcy5sYXN0UXVlcnkgPSBudWxsOwogICAgICAgICAgICAgICAgaWYodGhpcy5wYWdlVGIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhZ2VUYi5iaW5kU3RvcmUoc3RvcmUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnN0b3JlID0gRXh0LlN0b3JlTWdyLmxvb2t1cChzdG9yZSk7CiAgICAgICAgICAgIHRoaXMuc3RvcmUub24oewogICAgICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgICAgICBiZWZvcmVsb2FkOiB0aGlzLm9uQmVmb3JlTG9hZCwKICAgICAgICAgICAgICAgIGxvYWQ6IHRoaXMub25Mb2FkLAogICAgICAgICAgICAgICAgZXhjZXB0aW9uOiB0aGlzLmNvbGxhcHNlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYodGhpcy52aWV3KXsKICAgICAgICAgICAgICAgIHRoaXMudmlldy5iaW5kU3RvcmUoc3RvcmUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICByZXNldCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5jbGVhckZpbHRlck9uUmVzZXQgJiYgdGhpcy5tb2RlID09ICdsb2NhbCcpewogICAgICAgICAgICB0aGlzLnN0b3JlLmNsZWFyRmlsdGVyKCk7CiAgICAgICAgfQogICAgICAgIEV4dC5mb3JtLkNvbWJvQm94LnN1cGVyY2xhc3MucmVzZXQuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBpbml0RXZlbnRzIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5Db21ib0JveC5zdXBlcmNsYXNzLmluaXRFdmVudHMuY2FsbCh0aGlzKTsKCiAgICAgICAgCiAgICAgICAgdGhpcy5rZXlOYXYgPSBuZXcgRXh0LktleU5hdih0aGlzLmVsLCB7CiAgICAgICAgICAgICJ1cCIgOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgIHRoaXMuaW5LZXlNb2RlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0UHJldigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImRvd24iIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBpZighdGhpcy5pc0V4cGFuZGVkKCkpewogICAgICAgICAgICAgICAgICAgIHRoaXMub25UcmlnZ2VyQ2xpY2soKTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIHRoaXMuaW5LZXlNb2RlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdE5leHQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJlbnRlciIgOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgIHRoaXMub25WaWV3Q2xpY2soKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJlc2MiIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICB0aGlzLmNvbGxhcHNlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAidGFiIiA6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZm9yY2VTZWxlY3Rpb24gPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxhcHNlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMub25WaWV3Q2xpY2soZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzY29wZSA6IHRoaXMsCgogICAgICAgICAgICBkb1JlbGF5IDogZnVuY3Rpb24oZSwgaCwgaG5hbWUpewogICAgICAgICAgICAgICAgaWYoaG5hbWUgPT0gJ2Rvd24nIHx8IHRoaXMuc2NvcGUuaXNFeHBhbmRlZCgpKXsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2YXIgcmVsYXkgPSBFeHQuS2V5TmF2LnByb3RvdHlwZS5kb1JlbGF5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgICAgaWYoIUV4dC5pc0lFICYmIEV4dC5FdmVudE1hbmFnZXIudXNlS2V5ZG93bil7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNjb3BlLmZpcmVLZXkoZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWxheTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZm9yY2VLZXlEb3duIDogdHJ1ZSwKICAgICAgICAgICAgZGVmYXVsdEV2ZW50QWN0aW9uOiAnc3RvcEV2ZW50JwogICAgICAgIH0pOwogICAgICAgIHRoaXMucXVlcnlEZWxheSA9IE1hdGgubWF4KHRoaXMucXVlcnlEZWxheSB8fCAxMCwKICAgICAgICAgICAgICAgIHRoaXMubW9kZSA9PSAnbG9jYWwnID8gMTAgOiAyNTApOwogICAgICAgIHRoaXMuZHFUYXNrID0gbmV3IEV4dC51dGlsLkRlbGF5ZWRUYXNrKHRoaXMuaW5pdFF1ZXJ5LCB0aGlzKTsKICAgICAgICBpZih0aGlzLnR5cGVBaGVhZCl7CiAgICAgICAgICAgIHRoaXMudGFUYXNrID0gbmV3IEV4dC51dGlsLkRlbGF5ZWRUYXNrKHRoaXMub25UeXBlQWhlYWQsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZighdGhpcy5lbmFibGVLZXlFdmVudHMpewogICAgICAgICAgICB0aGlzLm1vbih0aGlzLmVsLCAna2V5dXAnLCB0aGlzLm9uS2V5VXAsIHRoaXMpOwogICAgICAgIH0KICAgIH0sCgoKICAgIAogICAgb25EZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBpZiAodGhpcy5kcVRhc2spewogICAgICAgICAgICB0aGlzLmRxVGFzay5jYW5jZWwoKTsKICAgICAgICAgICAgdGhpcy5kcVRhc2sgPSBudWxsOwogICAgICAgIH0KICAgICAgICB0aGlzLmJpbmRTdG9yZShudWxsKTsKICAgICAgICBFeHQuZGVzdHJveSgKICAgICAgICAgICAgdGhpcy5yZXNpemVyLAogICAgICAgICAgICB0aGlzLnZpZXcsCiAgICAgICAgICAgIHRoaXMucGFnZVRiLAogICAgICAgICAgICB0aGlzLmxpc3QKICAgICAgICApOwogICAgICAgIEV4dC5kZXN0cm95TWVtYmVycyh0aGlzLCAnaGlkZGVuRmllbGQnKTsKICAgICAgICBFeHQuZm9ybS5Db21ib0JveC5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICAKICAgIGZpcmVLZXkgOiBmdW5jdGlvbihlKXsKICAgICAgICBpZiAoIXRoaXMuaXNFeHBhbmRlZCgpKSB7CiAgICAgICAgICAgIEV4dC5mb3JtLkNvbWJvQm94LnN1cGVyY2xhc3MuZmlyZUtleS5jYWxsKHRoaXMsIGUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblJlc2l6ZSA6IGZ1bmN0aW9uKHcsIGgpewogICAgICAgIEV4dC5mb3JtLkNvbWJvQm94LnN1cGVyY2xhc3Mub25SZXNpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICBpZighaXNOYU4odykgJiYgdGhpcy5pc1Zpc2libGUoKSAmJiB0aGlzLmxpc3QpewogICAgICAgICAgICB0aGlzLmRvUmVzaXplKHcpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmJ1ZmZlclNpemUgPSB3OwogICAgICAgIH0KICAgIH0sCgogICAgZG9SZXNpemU6IGZ1bmN0aW9uKHcpewogICAgICAgIGlmKCFFeHQuaXNEZWZpbmVkKHRoaXMubGlzdFdpZHRoKSl7CiAgICAgICAgICAgIHZhciBsdyA9IE1hdGgubWF4KHcsIHRoaXMubWluTGlzdFdpZHRoKTsKICAgICAgICAgICAgdGhpcy5saXN0LnNldFdpZHRoKGx3KTsKICAgICAgICAgICAgdGhpcy5pbm5lckxpc3Quc2V0V2lkdGgobHcgLSB0aGlzLmxpc3QuZ2V0RnJhbWVXaWR0aCgnbHInKSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uRW5hYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5Db21ib0JveC5zdXBlcmNsYXNzLm9uRW5hYmxlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgaWYodGhpcy5oaWRkZW5GaWVsZCl7CiAgICAgICAgICAgIHRoaXMuaGlkZGVuRmllbGQuZGlzYWJsZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25EaXNhYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5Db21ib0JveC5zdXBlcmNsYXNzLm9uRGlzYWJsZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGlmKHRoaXMuaGlkZGVuRmllbGQpewogICAgICAgICAgICB0aGlzLmhpZGRlbkZpZWxkLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25CZWZvcmVMb2FkIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5oYXNGb2N1cyl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5pbm5lckxpc3QudXBkYXRlKHRoaXMubG9hZGluZ1RleHQgPwogICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ibG9hZGluZy1pbmRpY2F0b3IiPicrdGhpcy5sb2FkaW5nVGV4dCsnPC9kaXY+JyA6ICcnKTsKICAgICAgICB0aGlzLnJlc3RyaWN0SGVpZ2h0KCk7CiAgICAgICAgdGhpcy5zZWxlY3RlZEluZGV4ID0gLTE7CiAgICB9LAoKICAgIAogICAgb25Mb2FkIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5oYXNGb2N1cyl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5zdG9yZS5nZXRDb3VudCgpID4gMCB8fCB0aGlzLmxpc3RFbXB0eVRleHQpewogICAgICAgICAgICB0aGlzLmV4cGFuZCgpOwogICAgICAgICAgICB0aGlzLnJlc3RyaWN0SGVpZ2h0KCk7CiAgICAgICAgICAgIGlmKHRoaXMubGFzdFF1ZXJ5ID09IHRoaXMuYWxsUXVlcnkpewogICAgICAgICAgICAgICAgaWYodGhpcy5lZGl0YWJsZSl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbC5kb20uc2VsZWN0KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYodGhpcy5hdXRvU2VsZWN0ICE9PSBmYWxzZSAmJiAhdGhpcy5zZWxlY3RCeVZhbHVlKHRoaXMudmFsdWUsIHRydWUpKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdCgwLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBpZih0aGlzLmF1dG9TZWxlY3QgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdE5leHQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmKHRoaXMudHlwZUFoZWFkICYmIHRoaXMubGFzdEtleSAhPSBFeHQuRXZlbnRPYmplY3QuQkFDS1NQQUNFICYmIHRoaXMubGFzdEtleSAhPSBFeHQuRXZlbnRPYmplY3QuREVMRVRFKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhVGFzay5kZWxheSh0aGlzLnR5cGVBaGVhZERlbGF5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmNvbGxhcHNlKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgCiAgICBvblR5cGVBaGVhZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5zdG9yZS5nZXRDb3VudCgpID4gMCl7CiAgICAgICAgICAgIHZhciByID0gdGhpcy5zdG9yZS5nZXRBdCgwKTsKICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gci5kYXRhW3RoaXMuZGlzcGxheUZpZWxkXTsKICAgICAgICAgICAgdmFyIGxlbiA9IG5ld1ZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgdmFyIHNlbFN0YXJ0ID0gdGhpcy5nZXRSYXdWYWx1ZSgpLmxlbmd0aDsKICAgICAgICAgICAgaWYoc2VsU3RhcnQgIT0gbGVuKXsKICAgICAgICAgICAgICAgIHRoaXMuc2V0UmF3VmFsdWUobmV3VmFsdWUpOwogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RUZXh0KHNlbFN0YXJ0LCBuZXdWYWx1ZS5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFzc2VydFZhbHVlIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdmFsID0gdGhpcy5nZXRSYXdWYWx1ZSgpLAogICAgICAgICAgICByZWM7CgogICAgICAgIGlmKHRoaXMudmFsdWVGaWVsZCAmJiBFeHQuaXNEZWZpbmVkKHRoaXMudmFsdWUpKXsKICAgICAgICAgICAgcmVjID0gdGhpcy5maW5kUmVjb3JkKHRoaXMudmFsdWVGaWVsZCwgdGhpcy52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGlmKCFyZWMgfHwgcmVjLmdldCh0aGlzLmRpc3BsYXlGaWVsZCkgIT0gdmFsKXsKICAgICAgICAgICAgcmVjID0gdGhpcy5maW5kUmVjb3JkKHRoaXMuZGlzcGxheUZpZWxkLCB2YWwpOwogICAgICAgIH0KICAgICAgICBpZighcmVjICYmIHRoaXMuZm9yY2VTZWxlY3Rpb24pewogICAgICAgICAgICBpZih2YWwubGVuZ3RoID4gMCAmJiB2YWwgIT0gdGhpcy5lbXB0eVRleHQpewogICAgICAgICAgICAgICAgdGhpcy5lbC5kb20udmFsdWUgPSBFeHQudmFsdWUodGhpcy5sYXN0U2VsZWN0aW9uVGV4dCwgJycpOwogICAgICAgICAgICAgICAgdGhpcy5hcHBseUVtcHR5VGV4dCgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJWYWx1ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGlmKHJlYyAmJiB0aGlzLnZhbHVlRmllbGQpewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMudmFsdWUgPT0gdmFsKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWwgPSByZWMuZ2V0KHRoaXMudmFsdWVGaWVsZCB8fCB0aGlzLmRpc3BsYXlGaWVsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZSh2YWwpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblNlbGVjdCA6IGZ1bmN0aW9uKHJlY29yZCwgaW5kZXgpewogICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVzZWxlY3QnLCB0aGlzLCByZWNvcmQsIGluZGV4KSAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLnNldFZhbHVlKHJlY29yZC5kYXRhW3RoaXMudmFsdWVGaWVsZCB8fCB0aGlzLmRpc3BsYXlGaWVsZF0pOwogICAgICAgICAgICB0aGlzLmNvbGxhcHNlKCk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzZWxlY3QnLCB0aGlzLCByZWNvcmQsIGluZGV4KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0TmFtZTogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgaGYgPSB0aGlzLmhpZGRlbkZpZWxkOwogICAgICAgIHJldHVybiBoZiAmJiBoZi5uYW1lID8gaGYubmFtZSA6IHRoaXMuaGlkZGVuTmFtZSB8fCBFeHQuZm9ybS5Db21ib0JveC5zdXBlcmNsYXNzLmdldE5hbWUuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBnZXRWYWx1ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy52YWx1ZUZpZWxkKXsKICAgICAgICAgICAgcmV0dXJuIEV4dC5pc0RlZmluZWQodGhpcy52YWx1ZSkgPyB0aGlzLnZhbHVlIDogJyc7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHJldHVybiBFeHQuZm9ybS5Db21ib0JveC5zdXBlcmNsYXNzLmdldFZhbHVlLmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNsZWFyVmFsdWUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuaGlkZGVuRmllbGQpewogICAgICAgICAgICB0aGlzLmhpZGRlbkZpZWxkLnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2V0UmF3VmFsdWUoJycpOwogICAgICAgIHRoaXMubGFzdFNlbGVjdGlvblRleHQgPSAnJzsKICAgICAgICB0aGlzLmFwcGx5RW1wdHlUZXh0KCk7CiAgICAgICAgdGhpcy52YWx1ZSA9ICcnOwogICAgfSwKCiAgICAKICAgIHNldFZhbHVlIDogZnVuY3Rpb24odil7CiAgICAgICAgdmFyIHRleHQgPSB2OwogICAgICAgIGlmKHRoaXMudmFsdWVGaWVsZCl7CiAgICAgICAgICAgIHZhciByID0gdGhpcy5maW5kUmVjb3JkKHRoaXMudmFsdWVGaWVsZCwgdik7CiAgICAgICAgICAgIGlmKHIpewogICAgICAgICAgICAgICAgdGV4dCA9IHIuZGF0YVt0aGlzLmRpc3BsYXlGaWVsZF07CiAgICAgICAgICAgIH1lbHNlIGlmKEV4dC5pc0RlZmluZWQodGhpcy52YWx1ZU5vdEZvdW5kVGV4dCkpewogICAgICAgICAgICAgICAgdGV4dCA9IHRoaXMudmFsdWVOb3RGb3VuZFRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5sYXN0U2VsZWN0aW9uVGV4dCA9IHRleHQ7CiAgICAgICAgaWYodGhpcy5oaWRkZW5GaWVsZCl7CiAgICAgICAgICAgIHRoaXMuaGlkZGVuRmllbGQudmFsdWUgPSBFeHQudmFsdWUodiwgJycpOwogICAgICAgIH0KICAgICAgICBFeHQuZm9ybS5Db21ib0JveC5zdXBlcmNsYXNzLnNldFZhbHVlLmNhbGwodGhpcywgdGV4dCk7CiAgICAgICAgdGhpcy52YWx1ZSA9IHY7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZmluZFJlY29yZCA6IGZ1bmN0aW9uKHByb3AsIHZhbHVlKXsKICAgICAgICB2YXIgcmVjb3JkOwogICAgICAgIGlmKHRoaXMuc3RvcmUuZ2V0Q291bnQoKSA+IDApewogICAgICAgICAgICB0aGlzLnN0b3JlLmVhY2goZnVuY3Rpb24ocil7CiAgICAgICAgICAgICAgICBpZihyLmRhdGFbcHJvcF0gPT0gdmFsdWUpewogICAgICAgICAgICAgICAgICAgIHJlY29yZCA9IHI7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgIH0sCgogICAgCiAgICBvblZpZXdNb3ZlIDogZnVuY3Rpb24oZSwgdCl7CiAgICAgICAgdGhpcy5pbktleU1vZGUgPSBmYWxzZTsKICAgIH0sCgogICAgCiAgICBvblZpZXdPdmVyIDogZnVuY3Rpb24oZSwgdCl7CiAgICAgICAgaWYodGhpcy5pbktleU1vZGUpeyAKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgaXRlbSA9IHRoaXMudmlldy5maW5kSXRlbUZyb21DaGlsZCh0KTsKICAgICAgICBpZihpdGVtKXsKICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy52aWV3LmluZGV4T2YoaXRlbSk7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0KGluZGV4LCBmYWxzZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uVmlld0NsaWNrIDogZnVuY3Rpb24oZG9Gb2N1cyl7CiAgICAgICAgdmFyIGluZGV4ID0gdGhpcy52aWV3LmdldFNlbGVjdGVkSW5kZXhlcygpWzBdLAogICAgICAgICAgICBzID0gdGhpcy5zdG9yZSwKICAgICAgICAgICAgciA9IHMuZ2V0QXQoaW5kZXgpOwogICAgICAgIGlmKHIpewogICAgICAgICAgICB0aGlzLm9uU2VsZWN0KHIsIGluZGV4KTsKICAgICAgICB9ZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY29sbGFwc2UoKTsKICAgICAgICB9CiAgICAgICAgaWYoZG9Gb2N1cyAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLmVsLmZvY3VzKCk7CiAgICAgICAgfQogICAgfSwKCgogICAgCiAgICByZXN0cmljdEhlaWdodCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5pbm5lckxpc3QuZG9tLnN0eWxlLmhlaWdodCA9ICcnOwogICAgICAgIHZhciBpbm5lciA9IHRoaXMuaW5uZXJMaXN0LmRvbSwKICAgICAgICAgICAgcGFkID0gdGhpcy5saXN0LmdldEZyYW1lV2lkdGgoJ3RiJykgKyAodGhpcy5yZXNpemFibGUgPyB0aGlzLmhhbmRsZUhlaWdodCA6IDApICsgdGhpcy5hc3NldEhlaWdodCwKICAgICAgICAgICAgaCA9IE1hdGgubWF4KGlubmVyLmNsaWVudEhlaWdodCwgaW5uZXIub2Zmc2V0SGVpZ2h0LCBpbm5lci5zY3JvbGxIZWlnaHQpLAogICAgICAgICAgICBoYSA9IHRoaXMuZ2V0UG9zaXRpb24oKVsxXS1FeHQuZ2V0Qm9keSgpLmdldFNjcm9sbCgpLnRvcCwKICAgICAgICAgICAgaGIgPSBFeHQubGliLkRvbS5nZXRWaWV3SGVpZ2h0KCktaGEtdGhpcy5nZXRTaXplKCkuaGVpZ2h0LAogICAgICAgICAgICBzcGFjZSA9IE1hdGgubWF4KGhhLCBoYiwgdGhpcy5taW5IZWlnaHQgfHwgMCktdGhpcy5saXN0LnNoYWRvd09mZnNldC1wYWQtNTsKCiAgICAgICAgaCA9IE1hdGgubWluKGgsIHNwYWNlLCB0aGlzLm1heEhlaWdodCk7CgogICAgICAgIHRoaXMuaW5uZXJMaXN0LnNldEhlaWdodChoKTsKICAgICAgICB0aGlzLmxpc3QuYmVnaW5VcGRhdGUoKTsKICAgICAgICB0aGlzLmxpc3Quc2V0SGVpZ2h0KGgrcGFkKTsKICAgICAgICB0aGlzLmxpc3QuYWxpZ25Uby5hcHBseSh0aGlzLmxpc3QsIFt0aGlzLmVsXS5jb25jYXQodGhpcy5saXN0QWxpZ24pKTsKICAgICAgICB0aGlzLmxpc3QuZW5kVXBkYXRlKCk7CiAgICB9LAoKICAgIAogICAgaXNFeHBhbmRlZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMubGlzdCAmJiB0aGlzLmxpc3QuaXNWaXNpYmxlKCk7CiAgICB9LAoKICAgIAogICAgc2VsZWN0QnlWYWx1ZSA6IGZ1bmN0aW9uKHYsIHNjcm9sbEludG9WaWV3KXsKICAgICAgICBpZighRXh0LmlzRW1wdHkodiwgdHJ1ZSkpewogICAgICAgICAgICB2YXIgciA9IHRoaXMuZmluZFJlY29yZCh0aGlzLnZhbHVlRmllbGQgfHwgdGhpcy5kaXNwbGF5RmllbGQsIHYpOwogICAgICAgICAgICBpZihyKXsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0KHRoaXMuc3RvcmUuaW5kZXhPZihyKSwgc2Nyb2xsSW50b1ZpZXcpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAKICAgIHNlbGVjdCA6IGZ1bmN0aW9uKGluZGV4LCBzY3JvbGxJbnRvVmlldyl7CiAgICAgICAgdGhpcy5zZWxlY3RlZEluZGV4ID0gaW5kZXg7CiAgICAgICAgdGhpcy52aWV3LnNlbGVjdChpbmRleCk7CiAgICAgICAgaWYoc2Nyb2xsSW50b1ZpZXcgIT09IGZhbHNlKXsKICAgICAgICAgICAgdmFyIGVsID0gdGhpcy52aWV3LmdldE5vZGUoaW5kZXgpOwogICAgICAgICAgICBpZihlbCl7CiAgICAgICAgICAgICAgICB0aGlzLmlubmVyTGlzdC5zY3JvbGxDaGlsZEludG9WaWV3KGVsLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAKICAgIHNlbGVjdE5leHQgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBjdCA9IHRoaXMuc3RvcmUuZ2V0Q291bnQoKTsKICAgICAgICBpZihjdCA+IDApewogICAgICAgICAgICBpZih0aGlzLnNlbGVjdGVkSW5kZXggPT0gLTEpewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3QoMCk7CiAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuc2VsZWN0ZWRJbmRleCA8IGN0LTEpewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3QodGhpcy5zZWxlY3RlZEluZGV4KzEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNlbGVjdFByZXYgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBjdCA9IHRoaXMuc3RvcmUuZ2V0Q291bnQoKTsKICAgICAgICBpZihjdCA+IDApewogICAgICAgICAgICBpZih0aGlzLnNlbGVjdGVkSW5kZXggPT0gLTEpewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3QoMCk7CiAgICAgICAgICAgIH1lbHNlIGlmKHRoaXMuc2VsZWN0ZWRJbmRleCAhPT0gMCl7CiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdCh0aGlzLnNlbGVjdGVkSW5kZXgtMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25LZXlVcCA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciBrID0gZS5nZXRLZXkoKTsKICAgICAgICBpZih0aGlzLmVkaXRhYmxlICE9PSBmYWxzZSAmJiB0aGlzLnJlYWRPbmx5ICE9PSB0cnVlICYmIChrID09IGUuQkFDS1NQQUNFIHx8ICFlLmlzU3BlY2lhbEtleSgpKSl7CgogICAgICAgICAgICB0aGlzLmxhc3RLZXkgPSBrOwogICAgICAgICAgICB0aGlzLmRxVGFzay5kZWxheSh0aGlzLnF1ZXJ5RGVsYXkpOwogICAgICAgIH0KICAgICAgICBFeHQuZm9ybS5Db21ib0JveC5zdXBlcmNsYXNzLm9uS2V5VXAuY2FsbCh0aGlzLCBlKTsKICAgIH0sCgogICAgCiAgICB2YWxpZGF0ZUJsdXIgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiAhdGhpcy5saXN0IHx8ICF0aGlzLmxpc3QuaXNWaXNpYmxlKCk7CiAgICB9LAoKICAgIAogICAgaW5pdFF1ZXJ5IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmRvUXVlcnkodGhpcy5nZXRSYXdWYWx1ZSgpKTsKICAgIH0sCgogICAgCiAgICBiZWZvcmVCbHVyIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmFzc2VydFZhbHVlKCk7CiAgICB9LAoKICAgIAogICAgcG9zdEJsdXIgIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5Db21ib0JveC5zdXBlcmNsYXNzLnBvc3RCbHVyLmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5jb2xsYXBzZSgpOwogICAgICAgIHRoaXMuaW5LZXlNb2RlID0gZmFsc2U7CiAgICB9LAoKICAgIAogICAgZG9RdWVyeSA6IGZ1bmN0aW9uKHEsIGZvcmNlQWxsKXsKICAgICAgICBxID0gRXh0LmlzRW1wdHkocSkgPyAnJyA6IHE7CiAgICAgICAgdmFyIHFlID0gewogICAgICAgICAgICBxdWVyeTogcSwKICAgICAgICAgICAgZm9yY2VBbGw6IGZvcmNlQWxsLAogICAgICAgICAgICBjb21ibzogdGhpcywKICAgICAgICAgICAgY2FuY2VsOmZhbHNlCiAgICAgICAgfTsKICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3JlcXVlcnknLCBxZSk9PT1mYWxzZSB8fCBxZS5jYW5jZWwpewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHEgPSBxZS5xdWVyeTsKICAgICAgICBmb3JjZUFsbCA9IHFlLmZvcmNlQWxsOwogICAgICAgIGlmKGZvcmNlQWxsID09PSB0cnVlIHx8IChxLmxlbmd0aCA+PSB0aGlzLm1pbkNoYXJzKSl7CiAgICAgICAgICAgIGlmKHRoaXMubGFzdFF1ZXJ5ICE9PSBxKXsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFF1ZXJ5ID0gcTsKICAgICAgICAgICAgICAgIGlmKHRoaXMubW9kZSA9PSAnbG9jYWwnKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkSW5kZXggPSAtMTsKICAgICAgICAgICAgICAgICAgICBpZihmb3JjZUFsbCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUuY2xlYXJGaWx0ZXIoKTsKICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yZS5maWx0ZXIodGhpcy5kaXNwbGF5RmllbGQsIHEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTG9hZCgpOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yZS5iYXNlUGFyYW1zW3RoaXMucXVlcnlQYXJhbV0gPSBxOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUubG9hZCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtczogdGhpcy5nZXRQYXJhbXMocSkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4cGFuZCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRJbmRleCA9IC0xOwogICAgICAgICAgICAgICAgdGhpcy5vbkxvYWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRQYXJhbXMgOiBmdW5jdGlvbihxKXsKICAgICAgICB2YXIgcGFyYW1zID0ge30sCiAgICAgICAgICAgIHBhcmFtTmFtZXMgPSB0aGlzLnN0b3JlLnBhcmFtTmFtZXM7CiAgICAgICAgaWYodGhpcy5wYWdlU2l6ZSl7CiAgICAgICAgICAgIHBhcmFtc1twYXJhbU5hbWVzLnN0YXJ0XSA9IDA7CiAgICAgICAgICAgIHBhcmFtc1twYXJhbU5hbWVzLmxpbWl0XSA9IHRoaXMucGFnZVNpemU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwYXJhbXM7CiAgICB9LAoKICAgIAogICAgY29sbGFwc2UgOiBmdW5jdGlvbigpewogICAgICAgIGlmKCF0aGlzLmlzRXhwYW5kZWQoKSl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5saXN0LmhpZGUoKTsKICAgICAgICBFeHQuZ2V0RG9jKCkudW4oJ21vdXNld2hlZWwnLCB0aGlzLmNvbGxhcHNlSWYsIHRoaXMpOwogICAgICAgIEV4dC5nZXREb2MoKS51bignbW91c2Vkb3duJywgdGhpcy5jb2xsYXBzZUlmLCB0aGlzKTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnY29sbGFwc2UnLCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBjb2xsYXBzZUlmIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYoIXRoaXMuaXNEZXN0cm95ZWQgJiYgIWUud2l0aGluKHRoaXMud3JhcCkgJiYgIWUud2l0aGluKHRoaXMubGlzdCkpewogICAgICAgICAgICB0aGlzLmNvbGxhcHNlKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGV4cGFuZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5pc0V4cGFuZGVkKCkgfHwgIXRoaXMuaGFzRm9jdXMpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLnRpdGxlIHx8IHRoaXMucGFnZVNpemUpewogICAgICAgICAgICB0aGlzLmFzc2V0SGVpZ2h0ID0gMDsKICAgICAgICAgICAgaWYodGhpcy50aXRsZSl7CiAgICAgICAgICAgICAgICB0aGlzLmFzc2V0SGVpZ2h0ICs9IHRoaXMuaGVhZGVyLmdldEhlaWdodCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKHRoaXMucGFnZVNpemUpewogICAgICAgICAgICAgICAgdGhpcy5hc3NldEhlaWdodCArPSB0aGlzLmZvb3Rlci5nZXRIZWlnaHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5idWZmZXJTaXplKXsKICAgICAgICAgICAgdGhpcy5kb1Jlc2l6ZSh0aGlzLmJ1ZmZlclNpemUpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5idWZmZXJTaXplOwogICAgICAgIH0KICAgICAgICB0aGlzLmxpc3QuYWxpZ25Uby5hcHBseSh0aGlzLmxpc3QsIFt0aGlzLmVsXS5jb25jYXQodGhpcy5saXN0QWxpZ24pKTsKCiAgICAgICAgCiAgICAgICAgdGhpcy5saXN0LnNldFpJbmRleCh0aGlzLmdldFpJbmRleCgpKTsKICAgICAgICB0aGlzLmxpc3Quc2hvdygpOwogICAgICAgIGlmKEV4dC5pc0dlY2tvMil7CiAgICAgICAgICAgIHRoaXMuaW5uZXJMaXN0LnNldE92ZXJmbG93KCdhdXRvJyk7IAogICAgICAgIH0KICAgICAgICB0aGlzLm1vbihFeHQuZ2V0RG9jKCksIHsKICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgIG1vdXNld2hlZWw6IHRoaXMuY29sbGFwc2VJZiwKICAgICAgICAgICAgbW91c2Vkb3duOiB0aGlzLmNvbGxhcHNlSWYKICAgICAgICB9KTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnZXhwYW5kJywgdGhpcyk7CiAgICB9LAoKICAgIAogICAgCiAgICAKICAgIG9uVHJpZ2dlckNsaWNrIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnJlYWRPbmx5IHx8IHRoaXMuZGlzYWJsZWQpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuaXNFeHBhbmRlZCgpKXsKICAgICAgICAgICAgdGhpcy5jb2xsYXBzZSgpOwogICAgICAgICAgICB0aGlzLmVsLmZvY3VzKCk7CiAgICAgICAgfWVsc2UgewogICAgICAgICAgICB0aGlzLm9uRm9jdXMoe30pOwogICAgICAgICAgICBpZih0aGlzLnRyaWdnZXJBY3Rpb24gPT0gJ2FsbCcpIHsKICAgICAgICAgICAgICAgIHRoaXMuZG9RdWVyeSh0aGlzLmFsbFF1ZXJ5LCB0cnVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZG9RdWVyeSh0aGlzLmdldFJhd1ZhbHVlKCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZWwuZm9jdXMoKTsKICAgICAgICB9CiAgICB9CgogICAgCiAgICAKICAgIAogICAgCgp9KTsKRXh0LnJlZygnY29tYm8nLCBFeHQuZm9ybS5Db21ib0JveCk7CgpFeHQuZm9ybS5DaGVja2JveCA9IEV4dC5leHRlbmQoRXh0LmZvcm0uRmllbGQsICB7CiAgICAKICAgIGZvY3VzQ2xhc3MgOiB1bmRlZmluZWQsCiAgICAKICAgIGZpZWxkQ2xhc3MgOiAneC1mb3JtLWZpZWxkJywKICAgIAogICAgY2hlY2tlZCA6IGZhbHNlLAogICAgCiAgICBib3hMYWJlbDogJyYjMTYwOycsCiAgICAKICAgIGRlZmF1bHRBdXRvQ3JlYXRlIDogeyB0YWc6ICdpbnB1dCcsIHR5cGU6ICdjaGVja2JveCcsIGF1dG9jb21wbGV0ZTogJ29mZid9LAogICAgCiAgICAKICAgIAoKICAgIAogICAgYWN0aW9uTW9kZSA6ICd3cmFwJywKCgkKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5mb3JtLkNoZWNrYm94LnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NoZWNrJwogICAgICAgICk7CiAgICB9LAoKICAgIAogICAgb25SZXNpemUgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5mb3JtLkNoZWNrYm94LnN1cGVyY2xhc3Mub25SZXNpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICBpZighdGhpcy5ib3hMYWJlbCAmJiAhdGhpcy5maWVsZExhYmVsKXsKICAgICAgICAgICAgdGhpcy5lbC5hbGlnblRvKHRoaXMud3JhcCwgJ2MtYycpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBpbml0RXZlbnRzIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5DaGVja2JveC5zdXBlcmNsYXNzLmluaXRFdmVudHMuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm1vbih0aGlzLmVsLCB7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBjbGljazogdGhpcy5vbkNsaWNrLAogICAgICAgICAgICBjaGFuZ2U6IHRoaXMub25DbGljawogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIG1hcmtJbnZhbGlkIDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGNsZWFySW52YWxpZCA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIEV4dC5mb3JtLkNoZWNrYm94LnN1cGVyY2xhc3Mub25SZW5kZXIuY2FsbCh0aGlzLCBjdCwgcG9zaXRpb24pOwogICAgICAgIGlmKHRoaXMuaW5wdXRWYWx1ZSAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgdGhpcy5lbC5kb20udmFsdWUgPSB0aGlzLmlucHV0VmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMud3JhcCA9IHRoaXMuZWwud3JhcCh7Y2xzOiAneC1mb3JtLWNoZWNrLXdyYXAnfSk7CiAgICAgICAgaWYodGhpcy5ib3hMYWJlbCl7CiAgICAgICAgICAgIHRoaXMud3JhcC5jcmVhdGVDaGlsZCh7dGFnOiAnbGFiZWwnLCBodG1sRm9yOiB0aGlzLmVsLmlkLCBjbHM6ICd4LWZvcm0tY2ItbGFiZWwnLCBodG1sOiB0aGlzLmJveExhYmVsfSk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuY2hlY2tlZCl7CiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUodHJ1ZSk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IHRoaXMuZWwuZG9tLmNoZWNrZWQ7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChFeHQuaXNJRSAmJiAhRXh0LmlzU3RyaWN0KSB7CiAgICAgICAgICAgIHRoaXMud3JhcC5yZXBhaW50KCk7CiAgICAgICAgfQogICAgICAgIHRoaXMucmVzaXplRWwgPSB0aGlzLnBvc2l0aW9uRWwgPSB0aGlzLndyYXA7CiAgICB9LAoKICAgIAogICAgb25EZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZGVzdHJveSh0aGlzLndyYXApOwogICAgICAgIEV4dC5mb3JtLkNoZWNrYm94LnN1cGVyY2xhc3Mub25EZXN0cm95LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgaW5pdFZhbHVlIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5vcmlnaW5hbFZhbHVlID0gdGhpcy5nZXRWYWx1ZSgpOwogICAgfSwKCiAgICAKICAgIGdldFZhbHVlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWwuZG9tLmNoZWNrZWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmNoZWNrZWQ7CiAgICB9LAoKCQogICAgb25DbGljayA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5lbC5kb20uY2hlY2tlZCAhPSB0aGlzLmNoZWNrZWQpewogICAgICAgICAgICB0aGlzLnNldFZhbHVlKHRoaXMuZWwuZG9tLmNoZWNrZWQpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRWYWx1ZSA6IGZ1bmN0aW9uKHYpewogICAgICAgIHZhciBjaGVja2VkID0gdGhpcy5jaGVja2VkLAogICAgICAgICAgICBpbnB1dFZhbCA9IHRoaXMuaW5wdXRWYWx1ZTsKICAgICAgICAgICAgCiAgICAgICAgaWYgKHYgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9IGZhbHNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tlZCA9ICh2ID09PSB0cnVlIHx8IHYgPT09ICd0cnVlJyB8fCB2ID09ICcxJyB8fCAoaW5wdXRWYWwgPyB2ID09IGlucHV0VmFsIDogU3RyaW5nKHYpLnRvTG93ZXJDYXNlKCkgPT0gJ29uJykpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy5lbC5kb20uY2hlY2tlZCA9IHRoaXMuY2hlY2tlZDsKICAgICAgICAgICAgdGhpcy5lbC5kb20uZGVmYXVsdENoZWNrZWQgPSB0aGlzLmNoZWNrZWQ7CiAgICAgICAgfQogICAgICAgIGlmKGNoZWNrZWQgIT0gdGhpcy5jaGVja2VkKXsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2NoZWNrJywgdGhpcywgdGhpcy5jaGVja2VkKTsKICAgICAgICAgICAgaWYodGhpcy5oYW5kbGVyKXsKICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlci5jYWxsKHRoaXMuc2NvcGUgfHwgdGhpcywgdGhpcywgdGhpcy5jaGVja2VkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KfSk7CkV4dC5yZWcoJ2NoZWNrYm94JywgRXh0LmZvcm0uQ2hlY2tib3gpOwoKRXh0LmZvcm0uQ2hlY2tib3hHcm91cCA9IEV4dC5leHRlbmQoRXh0LmZvcm0uRmllbGQsIHsKICAgIAogICAgCiAgICBjb2x1bW5zIDogJ2F1dG8nLAogICAgCiAgICB2ZXJ0aWNhbCA6IGZhbHNlLAogICAgCiAgICBhbGxvd0JsYW5rIDogdHJ1ZSwKICAgIAogICAgYmxhbmtUZXh0IDogIllvdSBtdXN0IHNlbGVjdCBhdCBsZWFzdCBvbmUgaXRlbSBpbiB0aGlzIGdyb3VwIiwKCiAgICAKICAgIGRlZmF1bHRUeXBlIDogJ2NoZWNrYm94JywKCiAgICAKICAgIGdyb3VwQ2xzIDogJ3gtZm9ybS1jaGVjay1ncm91cCcsCgogICAgCiAgICBpbml0Q29tcG9uZW50OiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NoYW5nZScKICAgICAgICApOwogICAgICAgIHRoaXMub24oJ2NoYW5nZScsIHRoaXMudmFsaWRhdGUsIHRoaXMpOwogICAgICAgIEV4dC5mb3JtLkNoZWNrYm94R3JvdXAuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIGlmKCF0aGlzLmVsKXsKICAgICAgICAgICAgdmFyIHBhbmVsQ2ZnID0gewogICAgICAgICAgICAgICAgYXV0b0VsOiB7CiAgICAgICAgICAgICAgICAgICAgaWQ6IHRoaXMuaWQKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjbHM6IHRoaXMuZ3JvdXBDbHMsCiAgICAgICAgICAgICAgICBsYXlvdXQ6ICdjb2x1bW4nLAogICAgICAgICAgICAgICAgcmVuZGVyVG86IGN0LAogICAgICAgICAgICAgICAgYnVmZmVyUmVzaXplOiBmYWxzZSAKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIGNvbENmZyA9IHsKICAgICAgICAgICAgICAgIHh0eXBlOiAnY29udGFpbmVyJywKICAgICAgICAgICAgICAgIGRlZmF1bHRUeXBlOiB0aGlzLmRlZmF1bHRUeXBlLAogICAgICAgICAgICAgICAgbGF5b3V0OiAnZm9ybScsCiAgICAgICAgICAgICAgICBkZWZhdWx0czogewogICAgICAgICAgICAgICAgICAgIGhpZGVMYWJlbDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBhbmNob3I6ICcxMDAlJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYodGhpcy5pdGVtc1swXS5pdGVtcyl7CgogICAgICAgICAgICAgICAgCgogICAgICAgICAgICAgICAgRXh0LmFwcGx5KHBhbmVsQ2ZnLCB7CiAgICAgICAgICAgICAgICAgICAgbGF5b3V0Q29uZmlnOiB7Y29sdW1uczogdGhpcy5pdGVtcy5sZW5ndGh9LAogICAgICAgICAgICAgICAgICAgIGRlZmF1bHRzOiB0aGlzLmRlZmF1bHRzLAogICAgICAgICAgICAgICAgICAgIGl0ZW1zOiB0aGlzLml0ZW1zCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGZvcih2YXIgaT0wLCBsZW49dGhpcy5pdGVtcy5sZW5ndGg7IGk8bGVuOyBpKyspewogICAgICAgICAgICAgICAgICAgIEV4dC5hcHBseUlmKHRoaXMuaXRlbXNbaV0sIGNvbENmZyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9ZWxzZXsKCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgIHZhciBudW1Db2xzLCBjb2xzID0gW107CgogICAgICAgICAgICAgICAgaWYodHlwZW9mIHRoaXMuY29sdW1ucyA9PSAnc3RyaW5nJyl7IAogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sdW1ucyA9IHRoaXMuaXRlbXMubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoIUV4dC5pc0FycmF5KHRoaXMuY29sdW1ucykpewogICAgICAgICAgICAgICAgICAgIHZhciBjcyA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPHRoaXMuY29sdW1uczsgaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgY3MucHVzaCgoMTAwL3RoaXMuY29sdW1ucykqLjAxKTsgCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sdW1ucyA9IGNzOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG51bUNvbHMgPSB0aGlzLmNvbHVtbnMubGVuZ3RoOwoKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yKHZhciBpPTA7IGk8bnVtQ29sczsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB2YXIgY2MgPSBFeHQuYXBwbHkoe2l0ZW1zOltdfSwgY29sQ2ZnKTsKICAgICAgICAgICAgICAgICAgICBjY1t0aGlzLmNvbHVtbnNbaV0gPD0gMSA/ICdjb2x1bW5XaWR0aCcgOiAnd2lkdGgnXSA9IHRoaXMuY29sdW1uc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLmRlZmF1bHRzKXsKICAgICAgICAgICAgICAgICAgICAgICAgY2MuZGVmYXVsdHMgPSBFeHQuYXBwbHkoY2MuZGVmYXVsdHMgfHwge30sIHRoaXMuZGVmYXVsdHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb2xzLnB1c2goY2MpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmKHRoaXMudmVydGljYWwpewogICAgICAgICAgICAgICAgICAgIHZhciByb3dzID0gTWF0aC5jZWlsKHRoaXMuaXRlbXMubGVuZ3RoIC8gbnVtQ29scyksIHJpID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGk9MCwgbGVuPXRoaXMuaXRlbXMubGVuZ3RoOyBpPGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaT4wICYmIGklcm93cz09MCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByaSsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoaXMuaXRlbXNbaV0uZmllbGRMYWJlbCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1zW2ldLmhpZGVMYWJlbCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHNbcmldLml0ZW1zLnB1c2godGhpcy5pdGVtc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaT0wLCBsZW49dGhpcy5pdGVtcy5sZW5ndGg7IGk8bGVuOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2kgPSBpICUgbnVtQ29sczsKICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5pdGVtc1tpXS5maWVsZExhYmVsKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbXNbaV0uaGlkZUxhYmVsID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29sc1tjaV0uaXRlbXMucHVzaCh0aGlzLml0ZW1zW2ldKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIEV4dC5hcHBseShwYW5lbENmZywgewogICAgICAgICAgICAgICAgICAgIGxheW91dENvbmZpZzoge2NvbHVtbnM6IG51bUNvbHN9LAogICAgICAgICAgICAgICAgICAgIGl0ZW1zOiBjb2xzCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5wYW5lbCA9IG5ldyBFeHQuQ29udGFpbmVyKHBhbmVsQ2ZnKTsKICAgICAgICAgICAgdGhpcy5wYW5lbC5vd25lckN0ID0gdGhpczsKICAgICAgICAgICAgdGhpcy5lbCA9IHRoaXMucGFuZWwuZ2V0RWwoKTsKCiAgICAgICAgICAgIGlmKHRoaXMuZm9ySWQgJiYgdGhpcy5pdGVtQ2xzKXsKICAgICAgICAgICAgICAgIHZhciBsID0gdGhpcy5lbC51cCh0aGlzLml0ZW1DbHMpLmNoaWxkKCdsYWJlbCcsIHRydWUpOwogICAgICAgICAgICAgICAgaWYobCl7CiAgICAgICAgICAgICAgICAgICAgbC5zZXRBdHRyaWJ1dGUoJ2h0bWxGb3InLCB0aGlzLmZvcklkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGZpZWxkcyA9IHRoaXMucGFuZWwuZmluZEJ5KGZ1bmN0aW9uKGMpewogICAgICAgICAgICAgICAgcmV0dXJuIGMuaXNGb3JtRmllbGQ7CiAgICAgICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAgICAgdGhpcy5pdGVtcyA9IG5ldyBFeHQudXRpbC5NaXhlZENvbGxlY3Rpb24oKTsKICAgICAgICAgICAgdGhpcy5pdGVtcy5hZGRBbGwoZmllbGRzKTsKICAgICAgICB9CiAgICAgICAgRXh0LmZvcm0uQ2hlY2tib3hHcm91cC5zdXBlcmNsYXNzLm9uUmVuZGVyLmNhbGwodGhpcywgY3QsIHBvc2l0aW9uKTsKICAgIH0sCgogICAgaW5pdFZhbHVlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLnZhbHVlKXsKICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZS5hcHBseSh0aGlzLCB0aGlzLmJ1ZmZlcmVkID8gdGhpcy52YWx1ZSA6IFt0aGlzLnZhbHVlXSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmJ1ZmZlcmVkOwogICAgICAgICAgICBkZWxldGUgdGhpcy52YWx1ZTsKICAgICAgICB9CiAgICB9LAoKICAgIGFmdGVyUmVuZGVyIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5DaGVja2JveEdyb3VwLnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmVhY2hJdGVtKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICBpdGVtLm9uKCdjaGVjaycsIHRoaXMuZmlyZUNoZWNrZWQsIHRoaXMpOwogICAgICAgICAgICBpdGVtLmluR3JvdXAgPSB0cnVlOwogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIGRvTGF5b3V0OiBmdW5jdGlvbigpewogICAgICAgIAogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLnBhbmVsLmZvcmNlTGF5b3V0ID0gdGhpcy5vd25lckN0LmZvcmNlTGF5b3V0OwogICAgICAgICAgICB0aGlzLnBhbmVsLmRvTGF5b3V0KCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGZpcmVDaGVja2VkOiBmdW5jdGlvbigpewogICAgICAgIHZhciBhcnIgPSBbXTsKICAgICAgICB0aGlzLmVhY2hJdGVtKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICBpZihpdGVtLmNoZWNrZWQpewogICAgICAgICAgICAgICAgYXJyLnB1c2goaXRlbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgnY2hhbmdlJywgdGhpcywgYXJyKTsKICAgIH0sCiAgICAKICAgIAogICAgZ2V0RXJyb3JzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZXJyb3JzID0gRXh0LmZvcm0uQ2hlY2tib3hHcm91cC5zdXBlcmNsYXNzLmdldEVycm9ycy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIAogICAgICAgIGlmICghdGhpcy5hbGxvd0JsYW5rKSB7CiAgICAgICAgICAgIHZhciBibGFuayA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmVhY2hJdGVtKGZ1bmN0aW9uKGYpewogICAgICAgICAgICAgICAgaWYgKGYuY2hlY2tlZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAoYmxhbmsgPSBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJsYW5rKSBlcnJvcnMucHVzaCh0aGlzLmJsYW5rVGV4dCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBlcnJvcnM7CiAgICB9LAoKICAgIAogICAgaXNEaXJ0eTogZnVuY3Rpb24oKXsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5kaXNhYmxlZCB8fCAhdGhpcy5yZW5kZXJlZCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB2YXIgZGlydHkgPSBmYWxzZTsKICAgICAgICAKICAgICAgICB0aGlzLmVhY2hJdGVtKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICBpZihpdGVtLmlzRGlydHkoKSl7CiAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAKICAgICAgICByZXR1cm4gZGlydHk7CiAgICB9LAoKICAgIAogICAgc2V0UmVhZE9ubHkgOiBmdW5jdGlvbihyZWFkT25seSl7CiAgICAgICAgaWYodGhpcy5yZW5kZXJlZCl7CiAgICAgICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgICAgICBpdGVtLnNldFJlYWRPbmx5KHJlYWRPbmx5KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHRoaXMucmVhZE9ubHkgPSByZWFkT25seTsKICAgIH0sCgogICAgCiAgICBvbkRpc2FibGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgIGl0ZW0uZGlzYWJsZSgpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIG9uRW5hYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmVhY2hJdGVtKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICBpdGVtLmVuYWJsZSgpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIG9uUmVzaXplIDogZnVuY3Rpb24odywgaCl7CiAgICAgICAgdGhpcy5wYW5lbC5zZXRTaXplKHcsIGgpOwogICAgICAgIHRoaXMucGFuZWwuZG9MYXlvdXQoKTsKICAgIH0sCgogICAgCiAgICByZXNldCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMub3JpZ2luYWxWYWx1ZSkgewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5lYWNoSXRlbShmdW5jdGlvbihjKXsKICAgICAgICAgICAgICAgIGlmKGMuc2V0VmFsdWUpewogICAgICAgICAgICAgICAgICAgIGMuc2V0VmFsdWUoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIGMub3JpZ2luYWxWYWx1ZSA9IGMuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5yZXNldE9yaWdpbmFsID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZSh0aGlzLm9yaWdpbmFsVmFsdWUpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5yZXNldE9yaWdpbmFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oYyl7CiAgICAgICAgICAgICAgICBpZihjLnJlc2V0KXsKICAgICAgICAgICAgICAgICAgICBjLnJlc2V0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAKICAgICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuY2xlYXJJbnZhbGlkKCk7CiAgICAgICAgfSkuZGVmZXIoNTAsIHRoaXMpOwogICAgfSwKCiAgICAKICAgIHNldFZhbHVlOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLm9uU2V0VmFsdWUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5idWZmZXJlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBhcmd1bWVudHM7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIG9uU2V0VmFsdWU6IGZ1bmN0aW9uKGlkLCB2YWx1ZSl7CiAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKICAgICAgICAgICAgaWYoRXh0LmlzQXJyYXkoaWQpKXsKICAgICAgICAgICAgICAgIEV4dC5lYWNoKGlkLCBmdW5jdGlvbih2YWwsIGlkeCl7CiAgICAgICAgICAgICAgICAgICAgaWYgKEV4dC5pc09iamVjdCh2YWwpICYmIHZhbC5zZXRWYWx1ZSl7IAogICAgICAgICAgICAgICAgICAgICAgICB2YWwuc2V0VmFsdWUodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlc2V0T3JpZ2luYWwgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbC5vcmlnaW5hbFZhbHVlID0gdmFsLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLml0ZW1zLml0ZW1BdChpZHgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZihpdGVtKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uc2V0VmFsdWUodmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICB9ZWxzZSBpZihFeHQuaXNPYmplY3QoaWQpKXsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yKHZhciBpIGluIGlkKXsKICAgICAgICAgICAgICAgICAgICB2YXIgZiA9IHRoaXMuZ2V0Qm94KGkpOwogICAgICAgICAgICAgICAgICAgIGlmKGYpewogICAgICAgICAgICAgICAgICAgICAgICBmLnNldFZhbHVlKGlkW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZUZvckl0ZW0oaWQpOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHZhciBmID0gdGhpcy5nZXRCb3goaWQpOwogICAgICAgICAgICBpZihmKXsKICAgICAgICAgICAgICAgIGYuc2V0VmFsdWUodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGJlZm9yZURlc3Ryb3k6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy5wYW5lbCk7CiAgICAgICAgaWYgKCF0aGlzLnJlbmRlcmVkKSB7CiAgICAgICAgICAgIEV4dC5kZXN0cm95KHRoaXMuaXRlbXMpOwogICAgICAgIH0KICAgICAgICBFeHQuZm9ybS5DaGVja2JveEdyb3VwLnN1cGVyY2xhc3MuYmVmb3JlRGVzdHJveS5jYWxsKHRoaXMpOwoKICAgIH0sCgogICAgc2V0VmFsdWVGb3JJdGVtIDogZnVuY3Rpb24odmFsKXsKICAgICAgICB2YWwgPSBTdHJpbmcodmFsKS5zcGxpdCgnLCcpOwogICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgIGlmKHZhbC5pbmRleE9mKGl0ZW0uaW5wdXRWYWx1ZSk+IC0xKXsKICAgICAgICAgICAgICAgIGl0ZW0uc2V0VmFsdWUodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICBnZXRCb3ggOiBmdW5jdGlvbihpZCl7CiAgICAgICAgdmFyIGJveCA9IG51bGw7CiAgICAgICAgdGhpcy5lYWNoSXRlbShmdW5jdGlvbihmKXsKICAgICAgICAgICAgaWYoaWQgPT0gZiB8fCBmLmRhdGFJbmRleCA9PSBpZCB8fCBmLmlkID09IGlkIHx8IGYuZ2V0TmFtZSgpID09IGlkKXsKICAgICAgICAgICAgICAgIGJveCA9IGY7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYm94OwogICAgfSwKCiAgICAKICAgIGdldFZhbHVlIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgb3V0ID0gW107CiAgICAgICAgdGhpcy5lYWNoSXRlbShmdW5jdGlvbihpdGVtKXsKICAgICAgICAgICAgaWYoaXRlbS5jaGVja2VkKXsKICAgICAgICAgICAgICAgIG91dC5wdXNoKGl0ZW0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG91dDsKICAgIH0sCgogICAgCiAgICBlYWNoSXRlbTogZnVuY3Rpb24oZm4sIHNjb3BlKSB7CiAgICAgICAgaWYodGhpcy5pdGVtcyAmJiB0aGlzLml0ZW1zLmVhY2gpewogICAgICAgICAgICB0aGlzLml0ZW1zLmVhY2goZm4sIHNjb3BlIHx8IHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCgogICAgCiAgICBnZXRSYXdWYWx1ZSA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgc2V0UmF3VmFsdWUgOiBFeHQuZW1wdHlGbgoKfSk7CgpFeHQucmVnKCdjaGVja2JveGdyb3VwJywgRXh0LmZvcm0uQ2hlY2tib3hHcm91cCk7CgpFeHQuZm9ybS5Db21wb3NpdGVGaWVsZCA9IEV4dC5leHRlbmQoRXh0LmZvcm0uRmllbGQsIHsKCiAgICAKICAgIGRlZmF1bHRNYXJnaW5zOiAnMCA1IDAgMCcsCgogICAgCiAgICBza2lwTGFzdEl0ZW1NYXJnaW46IHRydWUsCgogICAgCiAgICBpc0NvbXBvc2l0ZTogdHJ1ZSwKCiAgICAKICAgIGNvbWJpbmVFcnJvcnM6IHRydWUsCiAgICAKICAgIAogICAgbGFiZWxDb25uZWN0b3I6ICcsICcsCiAgICAKICAgIAoKICAgIAogICAgCiAgICBpbml0Q29tcG9uZW50OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbGFiZWxzID0gW10sCiAgICAgICAgICAgIGl0ZW1zICA9IHRoaXMuaXRlbXMsCiAgICAgICAgICAgIGl0ZW07CgogICAgICAgIGZvciAodmFyIGk9MCwgaiA9IGl0ZW1zLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICBpdGVtID0gaXRlbXNbaV07CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIUV4dC5pc0VtcHR5KGl0ZW0ucmVmKSl7CiAgICAgICAgICAgICAgICBpdGVtLnJlZiA9ICcuLi8nICsgaXRlbS5yZWY7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxhYmVscy5wdXNoKGl0ZW0uZmllbGRMYWJlbCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgRXh0LmFwcGx5SWYoaXRlbSwgdGhpcy5kZWZhdWx0cyk7CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCEoaSA9PSBqIC0gMSAmJiB0aGlzLnNraXBMYXN0SXRlbU1hcmdpbikpIHsKICAgICAgICAgICAgICAgIEV4dC5hcHBseUlmKGl0ZW0sIHttYXJnaW5zOiB0aGlzLmRlZmF1bHRNYXJnaW5zfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuZmllbGRMYWJlbCA9IHRoaXMuZmllbGRMYWJlbCB8fCB0aGlzLmJ1aWxkTGFiZWwobGFiZWxzKTsKCiAgICAgICAgCiAgICAgICAgdGhpcy5maWVsZEVycm9ycyA9IG5ldyBFeHQudXRpbC5NaXhlZENvbGxlY3Rpb24odHJ1ZSwgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICByZXR1cm4gaXRlbS5maWVsZDsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5maWVsZEVycm9ycy5vbih7CiAgICAgICAgICAgIHNjb3BlICA6IHRoaXMsCiAgICAgICAgICAgIGFkZCAgICA6IHRoaXMudXBkYXRlSW52YWxpZE1hcmssCiAgICAgICAgICAgIHJlbW92ZSA6IHRoaXMudXBkYXRlSW52YWxpZE1hcmssCiAgICAgICAgICAgIHJlcGxhY2U6IHRoaXMudXBkYXRlSW52YWxpZE1hcmsKICAgICAgICB9KTsKCiAgICAgICAgRXh0LmZvcm0uQ29tcG9zaXRlRmllbGQuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgCiAgICAgICAgdGhpcy5pbm5lckN0ID0gbmV3IEV4dC5Db250YWluZXIoewogICAgICAgICAgICBsYXlvdXQgIDogJ2hib3gnLAogICAgICAgICAgICBpdGVtcyAgIDogdGhpcy5pdGVtcywKICAgICAgICAgICAgY2xzICAgICA6ICd4LWZvcm0tY29tcG9zaXRlJywKICAgICAgICAgICAgZGVmYXVsdE1hcmdpbnM6ICcwIDMgMCAwJywKICAgICAgICAgICAgb3duZXJDdDogdGhpcwogICAgICAgIH0pOwogICAgICAgIHRoaXMuaW5uZXJDdC5vd25lckN0ID0gdW5kZWZpbmVkOwogICAgICAgIAogICAgICAgIHZhciBmaWVsZHMgPSB0aGlzLmlubmVyQ3QuZmluZEJ5KGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgcmV0dXJuIGMuaXNGb3JtRmllbGQ7CiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIAogICAgICAgIHRoaXMuaXRlbXMgPSBuZXcgRXh0LnV0aWwuTWl4ZWRDb2xsZWN0aW9uKCk7CiAgICAgICAgdGhpcy5pdGVtcy5hZGRBbGwoZmllbGRzKTsKICAgICAgICAKICAgIH0sCgogICAgCiAgICBvblJlbmRlcjogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKSB7CiAgICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgaW5uZXJDdCA9IHRoaXMuaW5uZXJDdDsKICAgICAgICAgICAgaW5uZXJDdC5yZW5kZXIoY3QpOwoKICAgICAgICAgICAgdGhpcy5lbCA9IGlubmVyQ3QuZ2V0RWwoKTsKCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuY29tYmluZUVycm9ycykgewogICAgICAgICAgICAgICAgdGhpcy5lYWNoSXRlbShmdW5jdGlvbihmaWVsZCkgewogICAgICAgICAgICAgICAgICAgIEV4dC5hcHBseShmaWVsZCwgewogICAgICAgICAgICAgICAgICAgICAgICBtYXJrSW52YWxpZCA6IHRoaXMub25GaWVsZE1hcmtJbnZhbGlkLmNyZWF0ZURlbGVnYXRlKHRoaXMsIFtmaWVsZF0sIDApLAogICAgICAgICAgICAgICAgICAgICAgICBjbGVhckludmFsaWQ6IHRoaXMub25GaWVsZENsZWFySW52YWxpZC5jcmVhdGVEZWxlZ2F0ZSh0aGlzLCBbZmllbGRdLCAwKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgbCA9IHRoaXMuZWwucGFyZW50KCkucGFyZW50KCkuY2hpbGQoJ2xhYmVsJywgdHJ1ZSk7CiAgICAgICAgICAgIGlmIChsKSB7CiAgICAgICAgICAgICAgICBsLnNldEF0dHJpYnV0ZSgnZm9yJywgdGhpcy5pdGVtcy5pdGVtc1swXS5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIEV4dC5mb3JtLkNvbXBvc2l0ZUZpZWxkLnN1cGVyY2xhc3Mub25SZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgCiAgICBvbkZpZWxkTWFya0ludmFsaWQ6IGZ1bmN0aW9uKGZpZWxkLCBtZXNzYWdlKSB7CiAgICAgICAgdmFyIG5hbWUgID0gZmllbGQuZ2V0TmFtZSgpLAogICAgICAgICAgICBlcnJvciA9IHsKICAgICAgICAgICAgICAgIGZpZWxkOiBuYW1lLCAKICAgICAgICAgICAgICAgIGVycm9yTmFtZTogZmllbGQuZmllbGRMYWJlbCB8fCBuYW1lLAogICAgICAgICAgICAgICAgZXJyb3I6IG1lc3NhZ2UKICAgICAgICAgICAgfTsKCiAgICAgICAgdGhpcy5maWVsZEVycm9ycy5yZXBsYWNlKG5hbWUsIGVycm9yKTsKCiAgICAgICAgaWYgKCFmaWVsZC5wcmV2ZW50TWFyaykgewogICAgICAgICAgICBmaWVsZC5lbC5hZGRDbGFzcyhmaWVsZC5pbnZhbGlkQ2xhc3MpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkZpZWxkQ2xlYXJJbnZhbGlkOiBmdW5jdGlvbihmaWVsZCkgewogICAgICAgIHRoaXMuZmllbGRFcnJvcnMucmVtb3ZlS2V5KGZpZWxkLmdldE5hbWUoKSk7CgogICAgICAgIGZpZWxkLmVsLnJlbW92ZUNsYXNzKGZpZWxkLmludmFsaWRDbGFzcyk7CiAgICB9LAoKICAgIAogICAgdXBkYXRlSW52YWxpZE1hcms6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpZVN0cmljdCA9IEV4dC5pc0lFNiAmJiBFeHQuaXNTdHJpY3Q7CgogICAgICAgIGlmICh0aGlzLmZpZWxkRXJyb3JzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHRoaXMuY2xlYXJJbnZhbGlkKCk7CgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGllU3RyaWN0KSB7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFySW52YWxpZC5kZWZlcig1MCwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHRoaXMuYnVpbGRDb21iaW5lZEVycm9yTWVzc2FnZSh0aGlzLmZpZWxkRXJyb3JzLml0ZW1zKTsKCiAgICAgICAgICAgIHRoaXMuc29ydEVycm9ycygpOwogICAgICAgICAgICB0aGlzLm1hcmtJbnZhbGlkKG1lc3NhZ2UpOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpZVN0cmljdCkgewogICAgICAgICAgICAgICAgdGhpcy5tYXJrSW52YWxpZChtZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICB2YWxpZGF0ZVZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgcHJldmVudE1hcmspIHsKICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwoKICAgICAgICB0aGlzLmVhY2hJdGVtKGZ1bmN0aW9uKGZpZWxkKSB7CiAgICAgICAgICAgIGlmICghZmllbGQuaXNWYWxpZChwcmV2ZW50TWFyaykpIHsKICAgICAgICAgICAgICAgIHZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHZhbGlkOwogICAgfSwKCiAgICAKICAgIGJ1aWxkQ29tYmluZWRFcnJvck1lc3NhZ2U6IGZ1bmN0aW9uKGVycm9ycykgewogICAgICAgIHZhciBjb21iaW5lZCA9IFtdLAogICAgICAgICAgICBlcnJvcjsKCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGogPSBlcnJvcnMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgIGVycm9yID0gZXJyb3JzW2ldOwoKICAgICAgICAgICAgY29tYmluZWQucHVzaChTdHJpbmcuZm9ybWF0KCJ7MH06IHsxfSIsIGVycm9yLmVycm9yTmFtZSwgZXJyb3IuZXJyb3IpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjb21iaW5lZC5qb2luKCI8YnIgLz4iKTsKICAgIH0sCgogICAgCiAgICBzb3J0RXJyb3JzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZmllbGRzID0gdGhpcy5pdGVtczsKCiAgICAgICAgdGhpcy5maWVsZEVycm9ycy5zb3J0KCJBU0MiLCBmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICAgIHZhciBmaW5kQnlOYW1lID0gZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZmllbGQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmllbGQuZ2V0TmFtZSgpID09IGtleTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgYUluZGV4ID0gZmllbGRzLmZpbmRJbmRleEJ5KGZpbmRCeU5hbWUoYS5maWVsZCkpLAogICAgICAgICAgICAgICAgYkluZGV4ID0gZmllbGRzLmZpbmRJbmRleEJ5KGZpbmRCeU5hbWUoYi5maWVsZCkpOwoKICAgICAgICAgICAgcmV0dXJuIGFJbmRleCA8IGJJbmRleCA/IC0xIDogMTsKICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5lYWNoSXRlbShmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgIGl0ZW0ucmVzZXQoKTsKICAgICAgICB9KTsKCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNsZWFySW52YWxpZCgpOwogICAgICAgIH0pLmRlZmVyKDUwLCB0aGlzKTsKICAgIH0sCiAgICAKICAgIAogICAgY2xlYXJJbnZhbGlkQ2hpbGRyZW46IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICBpdGVtLmNsZWFySW52YWxpZCgpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIGJ1aWxkTGFiZWw6IGZ1bmN0aW9uKHNlZ21lbnRzKSB7CiAgICAgICAgcmV0dXJuIEV4dC5jbGVhbihzZWdtZW50cykuam9pbih0aGlzLmxhYmVsQ29ubmVjdG9yKTsKICAgIH0sCgogICAgCiAgICBpc0RpcnR5OiBmdW5jdGlvbigpewogICAgICAgIAogICAgICAgIGlmICh0aGlzLmRpc2FibGVkIHx8ICF0aGlzLnJlbmRlcmVkKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBkaXJ0eSA9IGZhbHNlOwogICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgIGlmKGl0ZW0uaXNEaXJ0eSgpKXsKICAgICAgICAgICAgICAgIGRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBkaXJ0eTsKICAgIH0sCgogICAgCiAgICBlYWNoSXRlbTogZnVuY3Rpb24oZm4sIHNjb3BlKSB7CiAgICAgICAgaWYodGhpcy5pdGVtcyAmJiB0aGlzLml0ZW1zLmVhY2gpewogICAgICAgICAgICB0aGlzLml0ZW1zLmVhY2goZm4sIHNjb3BlIHx8IHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblJlc2l6ZTogZnVuY3Rpb24oYWRqV2lkdGgsIGFkakhlaWdodCwgcmF3V2lkdGgsIHJhd0hlaWdodCkgewogICAgICAgIHZhciBpbm5lckN0ID0gdGhpcy5pbm5lckN0OwoKICAgICAgICBpZiAodGhpcy5yZW5kZXJlZCAmJiBpbm5lckN0LnJlbmRlcmVkKSB7CiAgICAgICAgICAgIGlubmVyQ3Quc2V0U2l6ZShhZGpXaWR0aCwgYWRqSGVpZ2h0KTsKICAgICAgICB9CgogICAgICAgIEV4dC5mb3JtLkNvbXBvc2l0ZUZpZWxkLnN1cGVyY2xhc3Mub25SZXNpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgCiAgICBkb0xheW91dDogZnVuY3Rpb24oc2hhbGxvdywgZm9yY2UpIHsKICAgICAgICBpZiAodGhpcy5yZW5kZXJlZCkgewogICAgICAgICAgICB2YXIgaW5uZXJDdCA9IHRoaXMuaW5uZXJDdDsKCiAgICAgICAgICAgIGlubmVyQ3QuZm9yY2VMYXlvdXQgPSB0aGlzLm93bmVyQ3QuZm9yY2VMYXlvdXQ7CiAgICAgICAgICAgIGlubmVyQ3QuZG9MYXlvdXQoc2hhbGxvdywgZm9yY2UpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBiZWZvcmVEZXN0cm95OiBmdW5jdGlvbigpewogICAgICAgIEV4dC5kZXN0cm95KHRoaXMuaW5uZXJDdCk7CgogICAgICAgIEV4dC5mb3JtLkNvbXBvc2l0ZUZpZWxkLnN1cGVyY2xhc3MuYmVmb3JlRGVzdHJveS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICAKICAgIHNldFJlYWRPbmx5IDogZnVuY3Rpb24ocmVhZE9ubHkpIHsKICAgICAgICBpZiAocmVhZE9ubHkgPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJlYWRPbmx5ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmVhZE9ubHkgPSAhIXJlYWRPbmx5OwoKICAgICAgICBpZih0aGlzLnJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy5lYWNoSXRlbShmdW5jdGlvbihpdGVtKXsKICAgICAgICAgICAgICAgIGl0ZW0uc2V0UmVhZE9ubHkocmVhZE9ubHkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5yZWFkT25seSA9IHJlYWRPbmx5OwogICAgfSwKCiAgICBvblNob3cgOiBmdW5jdGlvbigpIHsKICAgICAgICBFeHQuZm9ybS5Db21wb3NpdGVGaWVsZC5zdXBlcmNsYXNzLm9uU2hvdy5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuZG9MYXlvdXQoKTsKICAgIH0sCgogICAgCiAgICBvbkRpc2FibGUgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgIGl0ZW0uZGlzYWJsZSgpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIG9uRW5hYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmVhY2hJdGVtKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICBpdGVtLmVuYWJsZSgpOwogICAgICAgIH0pOwogICAgfQp9KTsKCkV4dC5yZWcoJ2NvbXBvc2l0ZWZpZWxkJywgRXh0LmZvcm0uQ29tcG9zaXRlRmllbGQpOwpFeHQuZm9ybS5SYWRpbyA9IEV4dC5leHRlbmQoRXh0LmZvcm0uQ2hlY2tib3gsIHsKICAgIGlucHV0VHlwZTogJ3JhZGlvJywKCiAgICAKICAgIG1hcmtJbnZhbGlkIDogRXh0LmVtcHR5Rm4sCiAgICAKICAgIGNsZWFySW52YWxpZCA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgZ2V0R3JvdXBWYWx1ZSA6IGZ1bmN0aW9uKCl7CiAgICAJdmFyIHAgPSB0aGlzLmVsLnVwKCdmb3JtJykgfHwgRXh0LmdldEJvZHkoKTsKICAgICAgICB2YXIgYyA9IHAuY2hpbGQoJ2lucHV0W25hbWU9IicrdGhpcy5lbC5kb20ubmFtZSsnIl06Y2hlY2tlZCcsIHRydWUpOwogICAgICAgIHJldHVybiBjID8gYy52YWx1ZSA6IG51bGw7CiAgICB9LAoKICAgIAogICAgc2V0VmFsdWUgOiBmdW5jdGlvbih2KXsKICAgIAl2YXIgY2hlY2tFbCwKICAgICAgICAgICAgZWxzLAogICAgICAgICAgICByYWRpbzsKICAgIAlpZiAodHlwZW9mIHYgPT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgIEV4dC5mb3JtLlJhZGlvLnN1cGVyY2xhc3Muc2V0VmFsdWUuY2FsbCh0aGlzLCB2KTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMucmVuZGVyZWQpIHsKICAgICAgICAgICAgY2hlY2tFbCA9IHRoaXMuZ2V0Q2hlY2tFbCgpOwogICAgICAgICAgICByYWRpbyA9IGNoZWNrRWwuY2hpbGQoJ2lucHV0W25hbWU9IicgKyB0aGlzLmVsLmRvbS5uYW1lICsgJyJdW3ZhbHVlPSInICsgdiArICciXScsIHRydWUpOwogICAgICAgICAgICBpZihyYWRpbyl7CiAgICAgICAgICAgICAgICBFeHQuZ2V0Q21wKHJhZGlvLmlkKS5zZXRWYWx1ZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZih0aGlzLnJlbmRlcmVkICYmIHRoaXMuY2hlY2tlZCl7CiAgICAgICAgICAgIGNoZWNrRWwgPSBjaGVja0VsIHx8IHRoaXMuZ2V0Q2hlY2tFbCgpOwogICAgICAgICAgICBlbHMgPSB0aGlzLmdldENoZWNrRWwoKS5zZWxlY3QoJ2lucHV0W25hbWU9IicgKyB0aGlzLmVsLmRvbS5uYW1lICsgJyJdJyk7CgkJCWVscy5lYWNoKGZ1bmN0aW9uKGVsKXsKCQkJCWlmKGVsLmRvbS5pZCAhPSB0aGlzLmlkKXsKCQkJCQlFeHQuZ2V0Q21wKGVsLmRvbS5pZCkuc2V0VmFsdWUoZmFsc2UpOwoJCQkJfQoJCQl9LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZ2V0Q2hlY2tFbDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmluR3JvdXApewogICAgICAgICAgICByZXR1cm4gdGhpcy5lbC51cCgnLngtZm9ybS1yYWRpby1ncm91cCcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5lbC51cCgnZm9ybScpIHx8IEV4dC5nZXRCb2R5KCk7CiAgICB9Cn0pOwpFeHQucmVnKCdyYWRpbycsIEV4dC5mb3JtLlJhZGlvKTsKCkV4dC5mb3JtLlJhZGlvR3JvdXAgPSBFeHQuZXh0ZW5kKEV4dC5mb3JtLkNoZWNrYm94R3JvdXAsIHsKICAgIAogICAgCiAgICBhbGxvd0JsYW5rIDogdHJ1ZSwKICAgIAogICAgYmxhbmtUZXh0IDogJ1lvdSBtdXN0IHNlbGVjdCBvbmUgaXRlbSBpbiB0aGlzIGdyb3VwJywKICAgIAogICAgCiAgICBkZWZhdWx0VHlwZSA6ICdyYWRpbycsCiAgICAKICAgIAogICAgZ3JvdXBDbHMgOiAneC1mb3JtLXJhZGlvLWdyb3VwJywKICAgIAogICAgCiAgICAKICAgIAogICAgZ2V0VmFsdWUgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBvdXQgPSBudWxsOwogICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgIGlmKGl0ZW0uY2hlY2tlZCl7CiAgICAgICAgICAgICAgICBvdXQgPSBpdGVtOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG91dDsKICAgIH0sCiAgICAKICAgIAogICAgb25TZXRWYWx1ZSA6IGZ1bmN0aW9uKGlkLCB2YWx1ZSl7CiAgICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+IDEpewogICAgICAgICAgICB2YXIgZiA9IHRoaXMuZ2V0Qm94KGlkKTsKICAgICAgICAgICAgaWYoZil7CiAgICAgICAgICAgICAgICBmLnNldFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgICAgIGlmKGYuY2hlY2tlZCl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lYWNoSXRlbShmdW5jdGlvbihpdGVtKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0gIT09IGYpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXRWYWx1ZShmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLnNldFZhbHVlRm9ySXRlbShpZCk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgc2V0VmFsdWVGb3JJdGVtIDogZnVuY3Rpb24odmFsKXsKICAgICAgICB2YWwgPSBTdHJpbmcodmFsKS5zcGxpdCgnLCcpWzBdOwogICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgIGl0ZW0uc2V0VmFsdWUodmFsID09IGl0ZW0uaW5wdXRWYWx1ZSk7CiAgICAgICAgfSk7CiAgICB9LAogICAgCiAgICAKICAgIGZpcmVDaGVja2VkIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5jaGVja1Rhc2spewogICAgICAgICAgICB0aGlzLmNoZWNrVGFzayA9IG5ldyBFeHQudXRpbC5EZWxheWVkVGFzayh0aGlzLmJ1ZmZlckNoZWNrZWQsIHRoaXMpOwogICAgICAgIH0KICAgICAgICB0aGlzLmNoZWNrVGFzay5kZWxheSgxMCk7CiAgICB9LAogICAgCiAgICAKICAgIGJ1ZmZlckNoZWNrZWQgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBvdXQgPSBudWxsOwogICAgICAgIHRoaXMuZWFjaEl0ZW0oZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICAgIGlmKGl0ZW0uY2hlY2tlZCl7CiAgICAgICAgICAgICAgICBvdXQgPSBpdGVtOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2NoYW5nZScsIHRoaXMsIG91dCk7CiAgICB9LAogICAgCiAgICBvbkRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuY2hlY2tUYXNrKXsKICAgICAgICAgICAgdGhpcy5jaGVja1Rhc2suY2FuY2VsKCk7CiAgICAgICAgICAgIHRoaXMuY2hlY2tUYXNrID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgRXh0LmZvcm0uUmFkaW9Hcm91cC5zdXBlcmNsYXNzLm9uRGVzdHJveS5jYWxsKHRoaXMpOwogICAgfQoKfSk7CgpFeHQucmVnKCdyYWRpb2dyb3VwJywgRXh0LmZvcm0uUmFkaW9Hcm91cCk7CgpFeHQuZm9ybS5IaWRkZW4gPSBFeHQuZXh0ZW5kKEV4dC5mb3JtLkZpZWxkLCB7CiAgICAKICAgIGlucHV0VHlwZSA6ICdoaWRkZW4nLAogICAgCiAgICBzaG91bGRMYXlvdXQ6IGZhbHNlLAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5mb3JtLkhpZGRlbi5zdXBlcmNsYXNzLm9uUmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIAogICAgaW5pdEV2ZW50cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5vcmlnaW5hbFZhbHVlID0gdGhpcy5nZXRWYWx1ZSgpOwogICAgfSwKCiAgICAKICAgIHNldFNpemUgOiBFeHQuZW1wdHlGbiwKICAgIHNldFdpZHRoIDogRXh0LmVtcHR5Rm4sCiAgICBzZXRIZWlnaHQgOiBFeHQuZW1wdHlGbiwKICAgIHNldFBvc2l0aW9uIDogRXh0LmVtcHR5Rm4sCiAgICBzZXRQYWdlUG9zaXRpb24gOiBFeHQuZW1wdHlGbiwKICAgIG1hcmtJbnZhbGlkIDogRXh0LmVtcHR5Rm4sCiAgICBjbGVhckludmFsaWQgOiBFeHQuZW1wdHlGbgp9KTsKRXh0LnJlZygnaGlkZGVuJywgRXh0LmZvcm0uSGlkZGVuKTsKRXh0LmZvcm0uQmFzaWNGb3JtID0gRXh0LmV4dGVuZChFeHQudXRpbC5PYnNlcnZhYmxlLCB7CgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGVsLCBjb25maWcpewogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwogICAgICAgIGlmKEV4dC5pc1N0cmluZyh0aGlzLnBhcmFtT3JkZXIpKXsKICAgICAgICAgICAgdGhpcy5wYXJhbU9yZGVyID0gdGhpcy5wYXJhbU9yZGVyLnNwbGl0KC9bXHMsfF0vKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5pdGVtcyA9IG5ldyBFeHQudXRpbC5NaXhlZENvbGxlY3Rpb24oZmFsc2UsIGZ1bmN0aW9uKG8pewogICAgICAgICAgICByZXR1cm4gby5nZXRJdGVtSWQoKTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVhY3Rpb24nLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2FjdGlvbmZhaWxlZCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAnYWN0aW9uY29tcGxldGUnCiAgICAgICAgKTsKCiAgICAgICAgaWYoZWwpewogICAgICAgICAgICB0aGlzLmluaXRFbChlbCk7CiAgICAgICAgfQogICAgICAgIEV4dC5mb3JtLkJhc2ljRm9ybS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgdGltZW91dDogMzAsCgogICAgCgogICAgCiAgICBwYXJhbU9yZGVyOiB1bmRlZmluZWQsCgogICAgCiAgICBwYXJhbXNBc0hhc2g6IGZhbHNlLAoKICAgIAogICAgd2FpdFRpdGxlOiAnUGxlYXNlIFdhaXQuLi4nLAoKICAgIAogICAgYWN0aXZlQWN0aW9uIDogbnVsbCwKCiAgICAKICAgIHRyYWNrUmVzZXRPbkxvYWQgOiBmYWxzZSwKCiAgICAKICAgIAoKICAgIAogICAgaW5pdEVsIDogZnVuY3Rpb24oZWwpewogICAgICAgIHRoaXMuZWwgPSBFeHQuZ2V0KGVsKTsKICAgICAgICB0aGlzLmlkID0gdGhpcy5lbC5pZCB8fCBFeHQuaWQoKTsKICAgICAgICBpZighdGhpcy5zdGFuZGFyZFN1Ym1pdCl7CiAgICAgICAgICAgIHRoaXMuZWwub24oJ3N1Ym1pdCcsIHRoaXMub25TdWJtaXQsIHRoaXMpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsLmFkZENsYXNzKCd4LWZvcm0nKTsKICAgIH0sCgogICAgCiAgICBnZXRFbDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5lbDsKICAgIH0sCgogICAgCiAgICBvblN1Ym1pdCA6IGZ1bmN0aW9uKGUpewogICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICB9LAoKICAgIAogICAgZGVzdHJveTogZnVuY3Rpb24oYm91bmQpewogICAgICAgIGlmKGJvdW5kICE9PSB0cnVlKXsKICAgICAgICAgICAgdGhpcy5pdGVtcy5lYWNoKGZ1bmN0aW9uKGYpewogICAgICAgICAgICAgICAgRXh0LmRlc3Ryb3koZik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBFeHQuZGVzdHJveSh0aGlzLmVsKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5pdGVtcy5jbGVhcigpOwogICAgICAgIHRoaXMucHVyZ2VMaXN0ZW5lcnMoKTsKICAgIH0sCgogICAgCiAgICBpc1ZhbGlkIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdmFsaWQgPSB0cnVlOwogICAgICAgIHRoaXMuaXRlbXMuZWFjaChmdW5jdGlvbihmKXsKICAgICAgICAgICBpZighZi52YWxpZGF0ZSgpKXsKICAgICAgICAgICAgICAgdmFsaWQgPSBmYWxzZTsKICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHZhbGlkOwogICAgfSwKCiAgICAKICAgIGlzRGlydHkgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBkaXJ0eSA9IGZhbHNlOwogICAgICAgIHRoaXMuaXRlbXMuZWFjaChmdW5jdGlvbihmKXsKICAgICAgICAgICBpZihmLmlzRGlydHkoKSl7CiAgICAgICAgICAgICAgIGRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZGlydHk7CiAgICB9LAoKICAgIAogICAgZG9BY3Rpb24gOiBmdW5jdGlvbihhY3Rpb24sIG9wdGlvbnMpewogICAgICAgIGlmKEV4dC5pc1N0cmluZyhhY3Rpb24pKXsKICAgICAgICAgICAgYWN0aW9uID0gbmV3IEV4dC5mb3JtLkFjdGlvbi5BQ1RJT05fVFlQRVNbYWN0aW9uXSh0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoJ2JlZm9yZWFjdGlvbicsIHRoaXMsIGFjdGlvbikgIT09IGZhbHNlKXsKICAgICAgICAgICAgdGhpcy5iZWZvcmVBY3Rpb24oYWN0aW9uKTsKICAgICAgICAgICAgYWN0aW9uLnJ1bi5kZWZlcigxMDAsIGFjdGlvbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHN1Ym1pdCA6IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgIGlmKHRoaXMuc3RhbmRhcmRTdWJtaXQpewogICAgICAgICAgICB2YXIgdiA9IG9wdGlvbnMuY2xpZW50VmFsaWRhdGlvbiA9PT0gZmFsc2UgfHwgdGhpcy5pc1ZhbGlkKCk7CiAgICAgICAgICAgIGlmKHYpewogICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpcy5lbC5kb207CiAgICAgICAgICAgICAgICBpZih0aGlzLnVybCAmJiBFeHQuaXNFbXB0eShlbC5hY3Rpb24pKXsKICAgICAgICAgICAgICAgICAgICBlbC5hY3Rpb24gPSB0aGlzLnVybDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsLnN1Ym1pdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH0KICAgICAgICB2YXIgc3VibWl0QWN0aW9uID0gU3RyaW5nLmZvcm1hdCgnezB9c3VibWl0JywgdGhpcy5hcGkgPyAnZGlyZWN0JyA6ICcnKTsKICAgICAgICB0aGlzLmRvQWN0aW9uKHN1Ym1pdEFjdGlvbiwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgbG9hZCA6IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgICAgIHZhciBsb2FkQWN0aW9uID0gU3RyaW5nLmZvcm1hdCgnezB9bG9hZCcsIHRoaXMuYXBpID8gJ2RpcmVjdCcgOiAnJyk7CiAgICAgICAgdGhpcy5kb0FjdGlvbihsb2FkQWN0aW9uLCBvcHRpb25zKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICB1cGRhdGVSZWNvcmQgOiBmdW5jdGlvbihyZWNvcmQpewogICAgICAgIHJlY29yZC5iZWdpbkVkaXQoKTsKICAgICAgICB2YXIgZnMgPSByZWNvcmQuZmllbGRzLAogICAgICAgICAgICBmaWVsZCwKICAgICAgICAgICAgdmFsdWU7CiAgICAgICAgZnMuZWFjaChmdW5jdGlvbihmKXsKICAgICAgICAgICAgZmllbGQgPSB0aGlzLmZpbmRGaWVsZChmLm5hbWUpOwogICAgICAgICAgICBpZihmaWVsZCl7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGZpZWxkLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICBpZiAoRXh0LnR5cGUodmFsdWUpICE9PSBmYWxzZSAmJiB2YWx1ZS5nZXRHcm91cFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5nZXRHcm91cFZhbHVlKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBmaWVsZC5lYWNoSXRlbSApIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZpZWxkLmVhY2hJdGVtKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKGl0ZW0uZ2V0VmFsdWUoKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZWNvcmQuc2V0KGYubmFtZSwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgcmVjb3JkLmVuZEVkaXQoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBsb2FkUmVjb3JkIDogZnVuY3Rpb24ocmVjb3JkKXsKICAgICAgICB0aGlzLnNldFZhbHVlcyhyZWNvcmQuZGF0YSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgYmVmb3JlQWN0aW9uIDogZnVuY3Rpb24oYWN0aW9uKXsKICAgICAgICAKICAgICAgICB0aGlzLml0ZW1zLmVhY2goZnVuY3Rpb24oZil7CiAgICAgICAgICAgIGlmKGYuaXNGb3JtRmllbGQgJiYgZi5zeW5jVmFsdWUpewogICAgICAgICAgICAgICAgZi5zeW5jVmFsdWUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBvID0gYWN0aW9uLm9wdGlvbnM7CiAgICAgICAgaWYoby53YWl0TXNnKXsKICAgICAgICAgICAgaWYodGhpcy53YWl0TXNnVGFyZ2V0ID09PSB0cnVlKXsKICAgICAgICAgICAgICAgIHRoaXMuZWwubWFzayhvLndhaXRNc2csICd4LW1hc2stbG9hZGluZycpOwogICAgICAgICAgICB9ZWxzZSBpZih0aGlzLndhaXRNc2dUYXJnZXQpewogICAgICAgICAgICAgICAgdGhpcy53YWl0TXNnVGFyZ2V0ID0gRXh0LmdldCh0aGlzLndhaXRNc2dUYXJnZXQpOwogICAgICAgICAgICAgICAgdGhpcy53YWl0TXNnVGFyZ2V0Lm1hc2soby53YWl0TXNnLCAneC1tYXNrLWxvYWRpbmcnKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBFeHQuTWVzc2FnZUJveC53YWl0KG8ud2FpdE1zZywgby53YWl0VGl0bGUgfHwgdGhpcy53YWl0VGl0bGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGFmdGVyQWN0aW9uIDogZnVuY3Rpb24oYWN0aW9uLCBzdWNjZXNzKXsKICAgICAgICB0aGlzLmFjdGl2ZUFjdGlvbiA9IG51bGw7CiAgICAgICAgdmFyIG8gPSBhY3Rpb24ub3B0aW9uczsKICAgICAgICBpZihvLndhaXRNc2cpewogICAgICAgICAgICBpZih0aGlzLndhaXRNc2dUYXJnZXQgPT09IHRydWUpewogICAgICAgICAgICAgICAgdGhpcy5lbC51bm1hc2soKTsKICAgICAgICAgICAgfWVsc2UgaWYodGhpcy53YWl0TXNnVGFyZ2V0KXsKICAgICAgICAgICAgICAgIHRoaXMud2FpdE1zZ1RhcmdldC51bm1hc2soKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBFeHQuTWVzc2FnZUJveC51cGRhdGVQcm9ncmVzcygxKTsKICAgICAgICAgICAgICAgIEV4dC5NZXNzYWdlQm94LmhpZGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZihzdWNjZXNzKXsKICAgICAgICAgICAgaWYoby5yZXNldCl7CiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXh0LmNhbGxiYWNrKG8uc3VjY2Vzcywgby5zY29wZSwgW3RoaXMsIGFjdGlvbl0pOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnYWN0aW9uY29tcGxldGUnLCB0aGlzLCBhY3Rpb24pOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBFeHQuY2FsbGJhY2soby5mYWlsdXJlLCBvLnNjb3BlLCBbdGhpcywgYWN0aW9uXSk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdhY3Rpb25mYWlsZWQnLCB0aGlzLCBhY3Rpb24pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBmaW5kRmllbGQgOiBmdW5jdGlvbihpZCkgewogICAgICAgIHZhciBmaWVsZCA9IHRoaXMuaXRlbXMuZ2V0KGlkKTsKCiAgICAgICAgaWYgKCFFeHQuaXNPYmplY3QoZmllbGQpKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgZmluZE1hdGNoaW5nRmllbGQgPSBmdW5jdGlvbihmKSB7CiAgICAgICAgICAgICAgICBpZiAoZi5pc0Zvcm1GaWVsZCkgewogICAgICAgICAgICAgICAgICAgIGlmIChmLmRhdGFJbmRleCA9PSBpZCB8fCBmLmlkID09IGlkIHx8IGYuZ2V0TmFtZSgpID09IGlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkID0gZjsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZi5pc0NvbXBvc2l0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZi5pdGVtcy5lYWNoKGZpbmRNYXRjaGluZ0ZpZWxkKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGYgaW5zdGFuY2VvZiBFeHQuZm9ybS5DaGVja2JveEdyb3VwICYmIGYucmVuZGVyZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGYuZWFjaEl0ZW0oZmluZE1hdGNoaW5nRmllbGQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuaXRlbXMuZWFjaChmaW5kTWF0Y2hpbmdGaWVsZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmaWVsZCB8fCBudWxsOwogICAgfSwKCgogICAgCiAgICBtYXJrSW52YWxpZCA6IGZ1bmN0aW9uKGVycm9ycyl7CiAgICAgICAgaWYgKEV4dC5pc0FycmF5KGVycm9ycykpIHsKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gZXJyb3JzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIHZhciBmaWVsZEVycm9yID0gZXJyb3JzW2ldOwogICAgICAgICAgICAgICAgdmFyIGYgPSB0aGlzLmZpbmRGaWVsZChmaWVsZEVycm9yLmlkKTsKICAgICAgICAgICAgICAgIGlmKGYpewogICAgICAgICAgICAgICAgICAgIGYubWFya0ludmFsaWQoZmllbGRFcnJvci5tc2cpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGZpZWxkLCBpZDsKICAgICAgICAgICAgZm9yKGlkIGluIGVycm9ycyl7CiAgICAgICAgICAgICAgICBpZighRXh0LmlzRnVuY3Rpb24oZXJyb3JzW2lkXSkgJiYgKGZpZWxkID0gdGhpcy5maW5kRmllbGQoaWQpKSl7CiAgICAgICAgICAgICAgICAgICAgZmllbGQubWFya0ludmFsaWQoZXJyb3JzW2lkXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHNldFZhbHVlcyA6IGZ1bmN0aW9uKHZhbHVlcyl7CiAgICAgICAgaWYoRXh0LmlzQXJyYXkodmFsdWVzKSl7IAogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSB2YWx1ZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgdmFyIHYgPSB2YWx1ZXNbaV07CiAgICAgICAgICAgICAgICB2YXIgZiA9IHRoaXMuZmluZEZpZWxkKHYuaWQpOwogICAgICAgICAgICAgICAgaWYoZil7CiAgICAgICAgICAgICAgICAgICAgZi5zZXRWYWx1ZSh2LnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRyYWNrUmVzZXRPbkxvYWQpewogICAgICAgICAgICAgICAgICAgICAgICBmLm9yaWdpbmFsVmFsdWUgPSBmLmdldFZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7IAogICAgICAgICAgICB2YXIgZmllbGQsIGlkOwogICAgICAgICAgICBmb3IoaWQgaW4gdmFsdWVzKXsKICAgICAgICAgICAgICAgIGlmKCFFeHQuaXNGdW5jdGlvbih2YWx1ZXNbaWRdKSAmJiAoZmllbGQgPSB0aGlzLmZpbmRGaWVsZChpZCkpKXsKICAgICAgICAgICAgICAgICAgICBmaWVsZC5zZXRWYWx1ZSh2YWx1ZXNbaWRdKTsKICAgICAgICAgICAgICAgICAgICBpZih0aGlzLnRyYWNrUmVzZXRPbkxvYWQpewogICAgICAgICAgICAgICAgICAgICAgICBmaWVsZC5vcmlnaW5hbFZhbHVlID0gZmllbGQuZ2V0VmFsdWUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZ2V0VmFsdWVzIDogZnVuY3Rpb24oYXNTdHJpbmcpewogICAgICAgIHZhciBmcyA9IEV4dC5saWIuQWpheC5zZXJpYWxpemVGb3JtKHRoaXMuZWwuZG9tKTsKICAgICAgICBpZihhc1N0cmluZyA9PT0gdHJ1ZSl7CiAgICAgICAgICAgIHJldHVybiBmczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEV4dC51cmxEZWNvZGUoZnMpOwogICAgfSwKCiAgICAKICAgIGdldEZpZWxkVmFsdWVzIDogZnVuY3Rpb24oZGlydHlPbmx5KXsKICAgICAgICB2YXIgbyA9IHt9LAogICAgICAgICAgICBuLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHZhbDsKICAgICAgICB0aGlzLml0ZW1zLmVhY2goZnVuY3Rpb24oZikgewogICAgICAgICAgICBpZiAoIWYuZGlzYWJsZWQgJiYgKGRpcnR5T25seSAhPT0gdHJ1ZSB8fCBmLmlzRGlydHkoKSkpIHsKICAgICAgICAgICAgICAgIG4gPSBmLmdldE5hbWUoKTsKICAgICAgICAgICAgICAgIGtleSA9IG9bbl07CiAgICAgICAgICAgICAgICB2YWwgPSBmLmdldFZhbHVlKCk7CgogICAgICAgICAgICAgICAgaWYoRXh0LmlzRGVmaW5lZChrZXkpKXsKICAgICAgICAgICAgICAgICAgICBpZihFeHQuaXNBcnJheShrZXkpKXsKICAgICAgICAgICAgICAgICAgICAgICAgb1tuXS5wdXNoKHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIG9bbl0gPSBba2V5LCB2YWxdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIG9bbl0gPSB2YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gbzsKICAgIH0sCgogICAgCiAgICBjbGVhckludmFsaWQgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuaXRlbXMuZWFjaChmdW5jdGlvbihmKXsKICAgICAgICAgICBmLmNsZWFySW52YWxpZCgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHJlc2V0IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLml0ZW1zLmVhY2goZnVuY3Rpb24oZil7CiAgICAgICAgICAgIGYucmVzZXQoKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBhZGQgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuaXRlbXMuYWRkQWxsKEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIHJlbW92ZSA6IGZ1bmN0aW9uKGZpZWxkKXsKICAgICAgICB0aGlzLml0ZW1zLnJlbW92ZShmaWVsZCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgY2xlYW5EZXN0cm95ZWQgOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLml0ZW1zLmZpbHRlckJ5KGZ1bmN0aW9uKG8pIHsgcmV0dXJuICEhby5pc0Rlc3Ryb3llZDsgfSkuZWFjaCh0aGlzLnJlbW92ZSwgdGhpcyk7CiAgICB9LAoKICAgIAogICAgcmVuZGVyIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLml0ZW1zLmVhY2goZnVuY3Rpb24oZil7CiAgICAgICAgICAgIGlmKGYuaXNGb3JtRmllbGQgJiYgIWYucmVuZGVyZWQgJiYgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZi5pZCkpeyAKICAgICAgICAgICAgICAgIGYuYXBwbHlUb01hcmt1cChmLmlkKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGFwcGx5VG9GaWVsZHMgOiBmdW5jdGlvbihvKXsKICAgICAgICB0aGlzLml0ZW1zLmVhY2goZnVuY3Rpb24oZil7CiAgICAgICAgICAgRXh0LmFwcGx5KGYsIG8pOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAKICAgIGFwcGx5SWZUb0ZpZWxkcyA6IGZ1bmN0aW9uKG8pewogICAgICAgIHRoaXMuaXRlbXMuZWFjaChmdW5jdGlvbihmKXsKICAgICAgICAgICBFeHQuYXBwbHlJZihmLCBvKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgY2FsbEZpZWxkTWV0aG9kIDogZnVuY3Rpb24oZm5OYW1lLCBhcmdzKXsKICAgICAgICBhcmdzID0gYXJncyB8fCBbXTsKICAgICAgICB0aGlzLml0ZW1zLmVhY2goZnVuY3Rpb24oZil7CiAgICAgICAgICAgIGlmKEV4dC5pc0Z1bmN0aW9uKGZbZm5OYW1lXSkpewogICAgICAgICAgICAgICAgZltmbk5hbWVdLmFwcGx5KGYsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Cn0pOwoKCkV4dC5CYXNpY0Zvcm0gPSBFeHQuZm9ybS5CYXNpY0Zvcm07CgpFeHQuRm9ybVBhbmVsID0gRXh0LmV4dGVuZChFeHQuUGFuZWwsIHsKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAoKCiAgICAKICAgIG1pbkJ1dHRvbldpZHRoIDogNzUsCgogICAgCiAgICBsYWJlbEFsaWduIDogJ2xlZnQnLAoKICAgIAogICAgbW9uaXRvclZhbGlkIDogZmFsc2UsCgogICAgCiAgICBtb25pdG9yUG9sbCA6IDIwMCwKCiAgICAKICAgIGxheW91dCA6ICdmb3JtJywKCiAgICAKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZm9ybSA9IHRoaXMuY3JlYXRlRm9ybSgpOwogICAgICAgIEV4dC5Gb3JtUGFuZWwuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CgogICAgICAgIHRoaXMuYm9keUNmZyA9IHsKICAgICAgICAgICAgdGFnOiAnZm9ybScsCiAgICAgICAgICAgIGNsczogdGhpcy5iYXNlQ2xzICsgJy1ib2R5JywKICAgICAgICAgICAgbWV0aG9kIDogdGhpcy5tZXRob2QgfHwgJ1BPU1QnLAogICAgICAgICAgICBpZCA6IHRoaXMuZm9ybUlkIHx8IEV4dC5pZCgpCiAgICAgICAgfTsKICAgICAgICBpZih0aGlzLmZpbGVVcGxvYWQpIHsKICAgICAgICAgICAgdGhpcy5ib2R5Q2ZnLmVuY3R5cGUgPSAnbXVsdGlwYXJ0L2Zvcm0tZGF0YSc7CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5pdEl0ZW1zKCk7CgogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NsaWVudHZhbGlkYXRpb24nCiAgICAgICAgKTsKCiAgICAgICAgdGhpcy5yZWxheUV2ZW50cyh0aGlzLmZvcm0sIFsnYmVmb3JlYWN0aW9uJywgJ2FjdGlvbmZhaWxlZCcsICdhY3Rpb25jb21wbGV0ZSddKTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVGb3JtIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY29uZmlnID0gRXh0LmFwcGx5SWYoe2xpc3RlbmVyczoge319LCB0aGlzLmluaXRpYWxDb25maWcpOwogICAgICAgIHJldHVybiBuZXcgRXh0LmZvcm0uQmFzaWNGb3JtKG51bGwsIGNvbmZpZyk7CiAgICB9LAoKICAgIAogICAgaW5pdEZpZWxkcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGYgPSB0aGlzLmZvcm07CiAgICAgICAgdmFyIGZvcm1QYW5lbCA9IHRoaXM7CiAgICAgICAgdmFyIGZuID0gZnVuY3Rpb24oYyl7CiAgICAgICAgICAgIGlmKGZvcm1QYW5lbC5pc0ZpZWxkKGMpKXsKICAgICAgICAgICAgICAgIGYuYWRkKGMpOwogICAgICAgICAgICB9ZWxzZSBpZihjLmZpbmRCeSAmJiBjICE9IGZvcm1QYW5lbCl7CiAgICAgICAgICAgICAgICBmb3JtUGFuZWwuYXBwbHlTZXR0aW5ncyhjKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYoYy5pdGVtcyAmJiBjLml0ZW1zLmVhY2gpewogICAgICAgICAgICAgICAgICAgIGMuaXRlbXMuZWFjaChmbiwgdGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHRoaXMuaXRlbXMuZWFjaChmbiwgdGhpcyk7CiAgICB9LAoKICAgIAogICAgYXBwbHlTZXR0aW5nczogZnVuY3Rpb24oYyl7CiAgICAgICAgdmFyIGN0ID0gYy5vd25lckN0OwogICAgICAgIEV4dC5hcHBseUlmKGMsIHsKICAgICAgICAgICAgbGFiZWxBbGlnbjogY3QubGFiZWxBbGlnbiwKICAgICAgICAgICAgbGFiZWxXaWR0aDogY3QubGFiZWxXaWR0aCwKICAgICAgICAgICAgaXRlbUNsczogY3QuaXRlbUNscwogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIGdldExheW91dFRhcmdldCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZm9ybS5lbDsKICAgIH0sCgogICAgCiAgICBnZXRGb3JtIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5mb3JtOwogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oY3QsIHBvc2l0aW9uKXsKICAgICAgICB0aGlzLmluaXRGaWVsZHMoKTsKICAgICAgICBFeHQuRm9ybVBhbmVsLnN1cGVyY2xhc3Mub25SZW5kZXIuY2FsbCh0aGlzLCBjdCwgcG9zaXRpb24pOwogICAgICAgIHRoaXMuZm9ybS5pbml0RWwodGhpcy5ib2R5KTsKICAgIH0sCgogICAgCiAgICBiZWZvcmVEZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnN0b3BNb25pdG9yaW5nKCk7CiAgICAgICAgdGhpcy5mb3JtLmRlc3Ryb3kodHJ1ZSk7CiAgICAgICAgRXh0LkZvcm1QYW5lbC5zdXBlcmNsYXNzLmJlZm9yZURlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBpc0ZpZWxkIDogZnVuY3Rpb24oYykgewogICAgICAgIHJldHVybiAhIWMuc2V0VmFsdWUgJiYgISFjLmdldFZhbHVlICYmICEhYy5tYXJrSW52YWxpZCAmJiAhIWMuY2xlYXJJbnZhbGlkOwogICAgfSwKCiAgICAKICAgIGluaXRFdmVudHMgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5Gb3JtUGFuZWwuc3VwZXJjbGFzcy5pbml0RXZlbnRzLmNhbGwodGhpcyk7CiAgICAgICAgCiAgICAgICAgdGhpcy5vbih7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBhZGQ6IHRoaXMub25BZGRFdmVudCwKICAgICAgICAgICAgcmVtb3ZlOiB0aGlzLm9uUmVtb3ZlRXZlbnQKICAgICAgICB9KTsKICAgICAgICBpZih0aGlzLm1vbml0b3JWYWxpZCl7IAogICAgICAgICAgICB0aGlzLnN0YXJ0TW9uaXRvcmluZygpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkFkZDogZnVuY3Rpb24oYyl7CiAgICAgICAgRXh0LkZvcm1QYW5lbC5zdXBlcmNsYXNzLm9uQWRkLmNhbGwodGhpcywgYyk7CiAgICAgICAgdGhpcy5wcm9jZXNzQWRkKGMpOwogICAgfSwKCiAgICAKICAgIG9uQWRkRXZlbnQ6IGZ1bmN0aW9uKGN0LCBjKXsKICAgICAgICBpZihjdCAhPT0gdGhpcyl7CiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0FkZChjKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcHJvY2Vzc0FkZCA6IGZ1bmN0aW9uKGMpewogICAgICAgIAogICAgICAgIGlmKHRoaXMuaXNGaWVsZChjKSl7CiAgICAgICAgICAgIHRoaXMuZm9ybS5hZGQoYyk7CiAgICAgICAgCiAgICAgICAgfWVsc2UgaWYoYy5maW5kQnkpewogICAgICAgICAgICB0aGlzLmFwcGx5U2V0dGluZ3MoYyk7CiAgICAgICAgICAgIHRoaXMuZm9ybS5hZGQuYXBwbHkodGhpcy5mb3JtLCBjLmZpbmRCeSh0aGlzLmlzRmllbGQpKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25SZW1vdmU6IGZ1bmN0aW9uKGMpewogICAgICAgIEV4dC5Gb3JtUGFuZWwuc3VwZXJjbGFzcy5vblJlbW92ZS5jYWxsKHRoaXMsIGMpOwogICAgICAgIHRoaXMucHJvY2Vzc1JlbW92ZShjKTsKICAgIH0sCgogICAgb25SZW1vdmVFdmVudDogZnVuY3Rpb24oY3QsIGMpewogICAgICAgIGlmKGN0ICE9PSB0aGlzKXsKICAgICAgICAgICAgdGhpcy5wcm9jZXNzUmVtb3ZlKGMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBwcm9jZXNzUmVtb3ZlOiBmdW5jdGlvbihjKXsKICAgICAgICBpZighdGhpcy5kZXN0cm95aW5nKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHRoaXMuaXNGaWVsZChjKSl7CiAgICAgICAgICAgICAgICB0aGlzLmZvcm0ucmVtb3ZlKGMpOwogICAgICAgICAgICAKICAgICAgICAgICAgfWVsc2UgaWYgKGMuZmluZEJ5KXsKICAgICAgICAgICAgICAgIEV4dC5lYWNoKGMuZmluZEJ5KHRoaXMuaXNGaWVsZCksIHRoaXMuZm9ybS5yZW1vdmUsIHRoaXMuZm9ybSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuZm9ybS5jbGVhbkRlc3Ryb3llZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHN0YXJ0TW9uaXRvcmluZyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMudmFsaWRUYXNrKXsKICAgICAgICAgICAgdGhpcy52YWxpZFRhc2sgPSBuZXcgRXh0LnV0aWwuVGFza1J1bm5lcigpOwogICAgICAgICAgICB0aGlzLnZhbGlkVGFzay5zdGFydCh7CiAgICAgICAgICAgICAgICBydW4gOiB0aGlzLmJpbmRIYW5kbGVyLAogICAgICAgICAgICAgICAgaW50ZXJ2YWwgOiB0aGlzLm1vbml0b3JQb2xsIHx8IDIwMCwKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzdG9wTW9uaXRvcmluZyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy52YWxpZFRhc2spewogICAgICAgICAgICB0aGlzLnZhbGlkVGFzay5zdG9wQWxsKCk7CiAgICAgICAgICAgIHRoaXMudmFsaWRUYXNrID0gbnVsbDsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgbG9hZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5mb3JtLmxvYWQuYXBwbHkodGhpcy5mb3JtLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAKICAgIG9uRGlzYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LkZvcm1QYW5lbC5zdXBlcmNsYXNzLm9uRGlzYWJsZS5jYWxsKHRoaXMpOwogICAgICAgIGlmKHRoaXMuZm9ybSl7CiAgICAgICAgICAgIHRoaXMuZm9ybS5pdGVtcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgdGhpcy5kaXNhYmxlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkVuYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LkZvcm1QYW5lbC5zdXBlcmNsYXNzLm9uRW5hYmxlLmNhbGwodGhpcyk7CiAgICAgICAgaWYodGhpcy5mb3JtKXsKICAgICAgICAgICAgdGhpcy5mb3JtLml0ZW1zLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYmluZEhhbmRsZXIgOiBmdW5jdGlvbigpewogICAgICAgIHZhciB2YWxpZCA9IHRydWU7CiAgICAgICAgdGhpcy5mb3JtLml0ZW1zLmVhY2goZnVuY3Rpb24oZil7CiAgICAgICAgICAgIGlmKCFmLmlzVmFsaWQodHJ1ZSkpewogICAgICAgICAgICAgICAgdmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmKHRoaXMuZmJhcil7CiAgICAgICAgICAgIHZhciBmaXRlbXMgPSB0aGlzLmZiYXIuaXRlbXMuaXRlbXM7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGZpdGVtcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICB2YXIgYnRuID0gZml0ZW1zW2ldOwogICAgICAgICAgICAgICAgaWYoYnRuLmZvcm1CaW5kID09PSB0cnVlICYmIGJ0bi5kaXNhYmxlZCA9PT0gdmFsaWQpewogICAgICAgICAgICAgICAgICAgIGJ0bi5zZXREaXNhYmxlZCghdmFsaWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdjbGllbnR2YWxpZGF0aW9uJywgdGhpcywgdmFsaWQpOwogICAgfQp9KTsKRXh0LnJlZygnZm9ybScsIEV4dC5Gb3JtUGFuZWwpOwoKRXh0LmZvcm0uRm9ybVBhbmVsID0gRXh0LkZvcm1QYW5lbDsKCkV4dC5mb3JtLkZpZWxkU2V0ID0gRXh0LmV4dGVuZChFeHQuUGFuZWwsIHsKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIGJhc2VDbHMgOiAneC1maWVsZHNldCcsCiAgICAKICAgIGxheW91dCA6ICdmb3JtJywKICAgIAogICAgYW5pbUNvbGxhcHNlIDogZmFsc2UsCgogICAgCiAgICBvblJlbmRlciA6IGZ1bmN0aW9uKGN0LCBwb3NpdGlvbil7CiAgICAgICAgaWYoIXRoaXMuZWwpewogICAgICAgICAgICB0aGlzLmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZmllbGRzZXQnKTsKICAgICAgICAgICAgdGhpcy5lbC5pZCA9IHRoaXMuaWQ7CiAgICAgICAgICAgIGlmICh0aGlzLnRpdGxlIHx8IHRoaXMuaGVhZGVyIHx8IHRoaXMuY2hlY2tib3hUb2dnbGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWwuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGVnZW5kJykpLmNsYXNzTmFtZSA9IHRoaXMuYmFzZUNscyArICctaGVhZGVyJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgRXh0LmZvcm0uRmllbGRTZXQuc3VwZXJjbGFzcy5vblJlbmRlci5jYWxsKHRoaXMsIGN0LCBwb3NpdGlvbik7CgogICAgICAgIGlmKHRoaXMuY2hlY2tib3hUb2dnbGUpewogICAgICAgICAgICB2YXIgbyA9IHR5cGVvZiB0aGlzLmNoZWNrYm94VG9nZ2xlID09ICdvYmplY3QnID8KICAgICAgICAgICAgICAgICAgICB0aGlzLmNoZWNrYm94VG9nZ2xlIDoKICAgICAgICAgICAgICAgICAgICB7dGFnOiAnaW5wdXQnLCB0eXBlOiAnY2hlY2tib3gnLCBuYW1lOiB0aGlzLmNoZWNrYm94TmFtZSB8fCB0aGlzLmlkKyctY2hlY2tib3gnfTsKICAgICAgICAgICAgdGhpcy5jaGVja2JveCA9IHRoaXMuaGVhZGVyLmluc2VydEZpcnN0KG8pOwogICAgICAgICAgICB0aGlzLmNoZWNrYm94LmRvbS5jaGVja2VkID0gIXRoaXMuY29sbGFwc2VkOwogICAgICAgICAgICB0aGlzLm1vbih0aGlzLmNoZWNrYm94LCAnY2xpY2snLCB0aGlzLm9uQ2hlY2tDbGljaywgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uQ29sbGFwc2UgOiBmdW5jdGlvbihkb0FuaW0sIGFuaW1BcmcpewogICAgICAgIGlmKHRoaXMuY2hlY2tib3gpewogICAgICAgICAgICB0aGlzLmNoZWNrYm94LmRvbS5jaGVja2VkID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIEV4dC5mb3JtLkZpZWxkU2V0LnN1cGVyY2xhc3Mub25Db2xsYXBzZS5jYWxsKHRoaXMsIGRvQW5pbSwgYW5pbUFyZyk7CgogICAgfSwKCiAgICAKICAgIG9uRXhwYW5kIDogZnVuY3Rpb24oZG9BbmltLCBhbmltQXJnKXsKICAgICAgICBpZih0aGlzLmNoZWNrYm94KXsKICAgICAgICAgICAgdGhpcy5jaGVja2JveC5kb20uY2hlY2tlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIEV4dC5mb3JtLkZpZWxkU2V0LnN1cGVyY2xhc3Mub25FeHBhbmQuY2FsbCh0aGlzLCBkb0FuaW0sIGFuaW1BcmcpOwogICAgfSwKCiAgICAKICAgIG9uQ2hlY2tDbGljayA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpc1t0aGlzLmNoZWNrYm94LmRvbS5jaGVja2VkID8gJ2V4cGFuZCcgOiAnY29sbGFwc2UnXSgpOwogICAgfQoKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAp9KTsKRXh0LnJlZygnZmllbGRzZXQnLCBFeHQuZm9ybS5GaWVsZFNldCk7CgpFeHQuZm9ybS5IdG1sRWRpdG9yID0gRXh0LmV4dGVuZChFeHQuZm9ybS5GaWVsZCwgewogICAgCiAgICBlbmFibGVGb3JtYXQgOiB0cnVlLAogICAgCiAgICBlbmFibGVGb250U2l6ZSA6IHRydWUsCiAgICAKICAgIGVuYWJsZUNvbG9ycyA6IHRydWUsCiAgICAKICAgIGVuYWJsZUFsaWdubWVudHMgOiB0cnVlLAogICAgCiAgICBlbmFibGVMaXN0cyA6IHRydWUsCiAgICAKICAgIGVuYWJsZVNvdXJjZUVkaXQgOiB0cnVlLAogICAgCiAgICBlbmFibGVMaW5rcyA6IHRydWUsCiAgICAKICAgIGVuYWJsZUZvbnQgOiB0cnVlLAogICAgCiAgICBjcmVhdGVMaW5rVGV4dCA6ICdQbGVhc2UgZW50ZXIgdGhlIFVSTCBmb3IgdGhlIGxpbms6JywKICAgIAogICAgZGVmYXVsdExpbmtWYWx1ZSA6ICdodHRwOi8nKycvJywKICAgIAogICAgZm9udEZhbWlsaWVzIDogWwogICAgICAgICdBcmlhbCcsCiAgICAgICAgJ0NvdXJpZXIgTmV3JywKICAgICAgICAnVGFob21hJywKICAgICAgICAnVGltZXMgTmV3IFJvbWFuJywKICAgICAgICAnVmVyZGFuYScKICAgIF0sCiAgICBkZWZhdWx0Rm9udDogJ3RhaG9tYScsCiAgICAKICAgIGRlZmF1bHRWYWx1ZTogKEV4dC5pc09wZXJhIHx8IEV4dC5pc0lFNikgPyAnJiMxNjA7JyA6ICcmIzgyMDM7JywKCiAgICAKICAgIGFjdGlvbk1vZGU6ICd3cmFwJywKICAgIHZhbGlkYXRpb25FdmVudCA6IGZhbHNlLAogICAgZGVmZXJIZWlnaHQ6IHRydWUsCiAgICBpbml0aWFsaXplZCA6IGZhbHNlLAogICAgYWN0aXZhdGVkIDogZmFsc2UsCiAgICBzb3VyY2VFZGl0TW9kZSA6IGZhbHNlLAogICAgb25Gb2N1cyA6IEV4dC5lbXB0eUZuLAogICAgaWZyYW1lUGFkOjMsCiAgICBoaWRlTW9kZTonb2Zmc2V0cycsCiAgICBkZWZhdWx0QXV0b0NyZWF0ZSA6IHsKICAgICAgICB0YWc6ICJ0ZXh0YXJlYSIsCiAgICAgICAgc3R5bGU6IndpZHRoOjUwMHB4O2hlaWdodDozMDBweDsiLAogICAgICAgIGF1dG9jb21wbGV0ZTogIm9mZiIKICAgIH0sCgogICAgCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICdpbml0aWFsaXplJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdhY3RpdmF0ZScsCiAgICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZXN5bmMnLAogICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVwdXNoJywKICAgICAgICAgICAgIAogICAgICAgICAgICAnc3luYycsCiAgICAgICAgICAgICAKICAgICAgICAgICAgJ3B1c2gnLAogICAgICAgICAgICAgCiAgICAgICAgICAgICdlZGl0bW9kZWNoYW5nZScKICAgICAgICApOwogICAgICAgIEV4dC5mb3JtLkh0bWxFZGl0b3Iuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgY3JlYXRlRm9udE9wdGlvbnMgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBidWYgPSBbXSwgZnMgPSB0aGlzLmZvbnRGYW1pbGllcywgZmYsIGxjOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGZzLmxlbmd0aDsgaTwgbGVuOyBpKyspewogICAgICAgICAgICBmZiA9IGZzW2ldOwogICAgICAgICAgICBsYyA9IGZmLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGJ1Zi5wdXNoKAogICAgICAgICAgICAgICAgJzxvcHRpb24gdmFsdWU9IicsbGMsJyIgc3R5bGU9ImZvbnQtZmFtaWx5OicsZmYsJzsiJywKICAgICAgICAgICAgICAgICAgICAodGhpcy5kZWZhdWx0Rm9udCA9PSBsYyA/ICcgc2VsZWN0ZWQ9InRydWUiPicgOiAnPicpLAogICAgICAgICAgICAgICAgICAgIGZmLAogICAgICAgICAgICAgICAgJzwvb3B0aW9uPicKICAgICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJ1Zi5qb2luKCcnKTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVUb29sYmFyIDogZnVuY3Rpb24oZWRpdG9yKXsKICAgICAgICB2YXIgaXRlbXMgPSBbXTsKICAgICAgICB2YXIgdGlwc0VuYWJsZWQgPSBFeHQuUXVpY2tUaXBzICYmIEV4dC5RdWlja1RpcHMuaXNFbmFibGVkKCk7CgoKICAgICAgICBmdW5jdGlvbiBidG4oaWQsIHRvZ2dsZSwgaGFuZGxlcil7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBpdGVtSWQgOiBpZCwKICAgICAgICAgICAgICAgIGNscyA6ICd4LWJ0bi1pY29uJywKICAgICAgICAgICAgICAgIGljb25DbHM6ICd4LWVkaXQtJytpZCwKICAgICAgICAgICAgICAgIGVuYWJsZVRvZ2dsZTp0b2dnbGUgIT09IGZhbHNlLAogICAgICAgICAgICAgICAgc2NvcGU6IGVkaXRvciwKICAgICAgICAgICAgICAgIGhhbmRsZXI6aGFuZGxlcnx8ZWRpdG9yLnJlbGF5QnRuQ21kLAogICAgICAgICAgICAgICAgY2xpY2tFdmVudDonbW91c2Vkb3duJywKICAgICAgICAgICAgICAgIHRvb2x0aXA6IHRpcHNFbmFibGVkID8gZWRpdG9yLmJ1dHRvblRpcHNbaWRdIHx8IHVuZGVmaW5lZCA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgIG92ZXJmbG93VGV4dDogZWRpdG9yLmJ1dHRvblRpcHNbaWRdLnRpdGxlIHx8IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgIHRhYkluZGV4Oi0xCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKCiAgICAgICAgaWYodGhpcy5lbmFibGVGb250ICYmICFFeHQuaXNTYWZhcmkyKXsKICAgICAgICAgICAgdmFyIGZvbnRTZWxlY3RJdGVtID0gbmV3IEV4dC5Ub29sYmFyLkl0ZW0oewogICAgICAgICAgICAgICBhdXRvRWw6IHsKICAgICAgICAgICAgICAgICAgICB0YWc6J3NlbGVjdCcsCiAgICAgICAgICAgICAgICAgICAgY2xzOid4LWZvbnQtc2VsZWN0JywKICAgICAgICAgICAgICAgICAgICBodG1sOiB0aGlzLmNyZWF0ZUZvbnRPcHRpb25zKCkKICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGl0ZW1zLnB1c2goCiAgICAgICAgICAgICAgICBmb250U2VsZWN0SXRlbSwKICAgICAgICAgICAgICAgICctJwogICAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5lbmFibGVGb3JtYXQpewogICAgICAgICAgICBpdGVtcy5wdXNoKAogICAgICAgICAgICAgICAgYnRuKCdib2xkJyksCiAgICAgICAgICAgICAgICBidG4oJ2l0YWxpYycpLAogICAgICAgICAgICAgICAgYnRuKCd1bmRlcmxpbmUnKQogICAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5lbmFibGVGb250U2l6ZSl7CiAgICAgICAgICAgIGl0ZW1zLnB1c2goCiAgICAgICAgICAgICAgICAnLScsCiAgICAgICAgICAgICAgICBidG4oJ2luY3JlYXNlZm9udHNpemUnLCBmYWxzZSwgdGhpcy5hZGp1c3RGb250KSwKICAgICAgICAgICAgICAgIGJ0bignZGVjcmVhc2Vmb250c2l6ZScsIGZhbHNlLCB0aGlzLmFkanVzdEZvbnQpCiAgICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLmVuYWJsZUNvbG9ycyl7CiAgICAgICAgICAgIGl0ZW1zLnB1c2goCiAgICAgICAgICAgICAgICAnLScsIHsKICAgICAgICAgICAgICAgICAgICBpdGVtSWQ6J2ZvcmVjb2xvcicsCiAgICAgICAgICAgICAgICAgICAgY2xzOid4LWJ0bi1pY29uJywKICAgICAgICAgICAgICAgICAgICBpY29uQ2xzOiAneC1lZGl0LWZvcmVjb2xvcicsCiAgICAgICAgICAgICAgICAgICAgY2xpY2tFdmVudDonbW91c2Vkb3duJywKICAgICAgICAgICAgICAgICAgICB0b29sdGlwOiB0aXBzRW5hYmxlZCA/IGVkaXRvci5idXR0b25UaXBzLmZvcmVjb2xvciB8fCB1bmRlZmluZWQgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgdGFiSW5kZXg6LTEsCiAgICAgICAgICAgICAgICAgICAgbWVudSA6IG5ldyBFeHQubWVudS5Db2xvck1lbnUoewogICAgICAgICAgICAgICAgICAgICAgICBhbGxvd1Jlc2VsZWN0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBmb2N1czogRXh0LmVtcHR5Rm4sCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOicwMDAwMDAnLAogICAgICAgICAgICAgICAgICAgICAgICBwbGFpbjp0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0OiBmdW5jdGlvbihjcCwgY29sb3IpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY0NtZCgnZm9yZWNvbG9yJywgRXh0LmlzV2ViS2l0IHx8IEV4dC5pc0lFID8gJyMnK2NvbG9yIDogY29sb3IpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmZXJGb2N1cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjbGlja0V2ZW50Oidtb3VzZWRvd24nCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICBpdGVtSWQ6J2JhY2tjb2xvcicsCiAgICAgICAgICAgICAgICAgICAgY2xzOid4LWJ0bi1pY29uJywKICAgICAgICAgICAgICAgICAgICBpY29uQ2xzOiAneC1lZGl0LWJhY2tjb2xvcicsCiAgICAgICAgICAgICAgICAgICAgY2xpY2tFdmVudDonbW91c2Vkb3duJywKICAgICAgICAgICAgICAgICAgICB0b29sdGlwOiB0aXBzRW5hYmxlZCA/IGVkaXRvci5idXR0b25UaXBzLmJhY2tjb2xvciB8fCB1bmRlZmluZWQgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgICAgICAgdGFiSW5kZXg6LTEsCiAgICAgICAgICAgICAgICAgICAgbWVudSA6IG5ldyBFeHQubWVudS5Db2xvck1lbnUoewogICAgICAgICAgICAgICAgICAgICAgICBmb2N1czogRXh0LmVtcHR5Rm4sCiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOidGRkZGRkYnLAogICAgICAgICAgICAgICAgICAgICAgICBwbGFpbjp0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBhbGxvd1Jlc2VsZWN0OiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0OiBmdW5jdGlvbihjcCwgY29sb3IpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKEV4dC5pc0dlY2tvKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjQ21kKCd1c2VDU1MnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY0NtZCgnaGlsaXRlY29sb3InLCBjb2xvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY0NtZCgndXNlQ1NTJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmZXJGb2N1cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNDbWQoRXh0LmlzT3BlcmEgPyAnaGlsaXRlY29sb3InIDogJ2JhY2tjb2xvcicsIEV4dC5pc1dlYktpdCB8fCBFeHQuaXNJRSA/ICcjJytjb2xvciA6IGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZlckZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBjbGlja0V2ZW50Oidtb3VzZWRvd24nCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuZW5hYmxlQWxpZ25tZW50cyl7CiAgICAgICAgICAgIGl0ZW1zLnB1c2goCiAgICAgICAgICAgICAgICAnLScsCiAgICAgICAgICAgICAgICBidG4oJ2p1c3RpZnlsZWZ0JyksCiAgICAgICAgICAgICAgICBidG4oJ2p1c3RpZnljZW50ZXInKSwKICAgICAgICAgICAgICAgIGJ0bignanVzdGlmeXJpZ2h0JykKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGlmKCFFeHQuaXNTYWZhcmkyKXsKICAgICAgICAgICAgaWYodGhpcy5lbmFibGVMaW5rcyl7CiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKAogICAgICAgICAgICAgICAgICAgICctJywKICAgICAgICAgICAgICAgICAgICBidG4oJ2NyZWF0ZWxpbmsnLCBmYWxzZSwgdGhpcy5jcmVhdGVMaW5rKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYodGhpcy5lbmFibGVMaXN0cyl7CiAgICAgICAgICAgICAgICBpdGVtcy5wdXNoKAogICAgICAgICAgICAgICAgICAgICctJywKICAgICAgICAgICAgICAgICAgICBidG4oJ2luc2VydG9yZGVyZWRsaXN0JyksCiAgICAgICAgICAgICAgICAgICAgYnRuKCdpbnNlcnR1bm9yZGVyZWRsaXN0JykKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5lbmFibGVTb3VyY2VFZGl0KXsKICAgICAgICAgICAgICAgIGl0ZW1zLnB1c2goCiAgICAgICAgICAgICAgICAgICAgJy0nLAogICAgICAgICAgICAgICAgICAgIGJ0bignc291cmNlZWRpdCcsIHRydWUsIGZ1bmN0aW9uKGJ0bil7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG9nZ2xlU291cmNlRWRpdCghdGhpcy5zb3VyY2VFZGl0TW9kZSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIAogICAgICAgIHZhciB0YiA9IG5ldyBFeHQuVG9vbGJhcih7CiAgICAgICAgICAgIHJlbmRlclRvOiB0aGlzLndyYXAuZG9tLmZpcnN0Q2hpbGQsCiAgICAgICAgICAgIGl0ZW1zOiBpdGVtcwogICAgICAgIH0pOwoKICAgICAgICBpZiAoZm9udFNlbGVjdEl0ZW0pIHsKICAgICAgICAgICAgdGhpcy5mb250U2VsZWN0ID0gZm9udFNlbGVjdEl0ZW0uZWw7CgogICAgICAgICAgICB0aGlzLm1vbih0aGlzLmZvbnRTZWxlY3QsICdjaGFuZ2UnLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgdmFyIGZvbnQgPSB0aGlzLmZvbnRTZWxlY3QuZG9tLnZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5yZWxheUNtZCgnZm9udG5hbWUnLCBmb250KTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmZXJGb2N1cygpOwogICAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIAogICAgICAgIHRoaXMubW9uKHRiLmVsLCAnY2xpY2snLCBmdW5jdGlvbihlKXsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0pOwoKICAgICAgICB0aGlzLnRiID0gdGI7CiAgICAgICAgdGhpcy50Yi5kb0xheW91dCgpOwogICAgfSwKCiAgICBvbkRpc2FibGU6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy53cmFwLm1hc2soKTsKICAgICAgICBFeHQuZm9ybS5IdG1sRWRpdG9yLnN1cGVyY2xhc3Mub25EaXNhYmxlLmNhbGwodGhpcyk7CiAgICB9LAoKICAgIG9uRW5hYmxlOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMud3JhcC51bm1hc2soKTsKICAgICAgICBFeHQuZm9ybS5IdG1sRWRpdG9yLnN1cGVyY2xhc3Mub25FbmFibGUuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgc2V0UmVhZE9ubHk6IGZ1bmN0aW9uKHJlYWRPbmx5KXsKCiAgICAgICAgRXh0LmZvcm0uSHRtbEVkaXRvci5zdXBlcmNsYXNzLnNldFJlYWRPbmx5LmNhbGwodGhpcywgcmVhZE9ubHkpOwogICAgICAgIGlmKHRoaXMuaW5pdGlhbGl6ZWQpewogICAgICAgICAgICBpZihFeHQuaXNJRSl7CiAgICAgICAgICAgICAgICB0aGlzLmdldEVkaXRvckJvZHkoKS5jb250ZW50RWRpdGFibGUgPSAhcmVhZE9ubHk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgdGhpcy5zZXREZXNpZ25Nb2RlKCFyZWFkT25seSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGJkID0gdGhpcy5nZXRFZGl0b3JCb2R5KCk7CiAgICAgICAgICAgIGlmKGJkKXsKICAgICAgICAgICAgICAgIGJkLnN0eWxlLmN1cnNvciA9IHRoaXMucmVhZE9ubHkgPyAnZGVmYXVsdCcgOiAndGV4dCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5kaXNhYmxlSXRlbXMocmVhZE9ubHkpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXREb2NNYXJrdXAgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBoID0gRXh0LmZseSh0aGlzLmlmcmFtZSkuZ2V0SGVpZ2h0KCkgLSB0aGlzLmlmcmFtZVBhZCAqIDI7CiAgICAgICAgcmV0dXJuIFN0cmluZy5mb3JtYXQoJzxodG1sPjxoZWFkPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+Ym9keXtib3JkZXI6IDA7IG1hcmdpbjogMDsgcGFkZGluZzogezB9cHg7IGhlaWdodDogezF9cHg7IGN1cnNvcjogdGV4dH08L3N0eWxlPjwvaGVhZD48Ym9keT48L2JvZHk+PC9odG1sPicsIHRoaXMuaWZyYW1lUGFkLCBoKTsKICAgIH0sCgogICAgCiAgICBnZXRFZGl0b3JCb2R5IDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgZG9jID0gdGhpcy5nZXREb2MoKTsKICAgICAgICByZXR1cm4gZG9jLmJvZHkgfHwgZG9jLmRvY3VtZW50RWxlbWVudDsKICAgIH0sCgogICAgCiAgICBnZXREb2MgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiBFeHQuaXNJRSA/IHRoaXMuZ2V0V2luKCkuZG9jdW1lbnQgOiAodGhpcy5pZnJhbWUuY29udGVudERvY3VtZW50IHx8IHRoaXMuZ2V0V2luKCkuZG9jdW1lbnQpOwogICAgfSwKCiAgICAKICAgIGdldFdpbiA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIEV4dC5pc0lFID8gdGhpcy5pZnJhbWUuY29udGVudFdpbmRvdyA6IHdpbmRvdy5mcmFtZXNbdGhpcy5pZnJhbWUubmFtZV07CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIEV4dC5mb3JtLkh0bWxFZGl0b3Iuc3VwZXJjbGFzcy5vblJlbmRlci5jYWxsKHRoaXMsIGN0LCBwb3NpdGlvbik7CiAgICAgICAgdGhpcy5lbC5kb20uc3R5bGUuYm9yZGVyID0gJzAgbm9uZSc7CiAgICAgICAgdGhpcy5lbC5kb20uc2V0QXR0cmlidXRlKCd0YWJJbmRleCcsIC0xKTsKICAgICAgICB0aGlzLmVsLmFkZENsYXNzKCd4LWhpZGRlbicpOwogICAgICAgIGlmKEV4dC5pc0lFKXsgCiAgICAgICAgICAgIHRoaXMuZWwuYXBwbHlTdHlsZXMoJ21hcmdpbi10b3A6LTFweDttYXJnaW4tYm90dG9tOi0xcHg7Jyk7CiAgICAgICAgfQogICAgICAgIHRoaXMud3JhcCA9IHRoaXMuZWwud3JhcCh7CiAgICAgICAgICAgIGNsczoneC1odG1sLWVkaXRvci13cmFwJywgY246e2NsczoneC1odG1sLWVkaXRvci10Yid9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuY3JlYXRlVG9vbGJhcih0aGlzKTsKCiAgICAgICAgdGhpcy5kaXNhYmxlSXRlbXModHJ1ZSk7CgogICAgICAgIHRoaXMudGIuZG9MYXlvdXQoKTsKCiAgICAgICAgdGhpcy5jcmVhdGVJRnJhbWUoKTsKCiAgICAgICAgaWYoIXRoaXMud2lkdGgpewogICAgICAgICAgICB2YXIgc3ogPSB0aGlzLmVsLmdldFNpemUoKTsKICAgICAgICAgICAgdGhpcy5zZXRTaXplKHN6LndpZHRoLCB0aGlzLmhlaWdodCB8fCBzei5oZWlnaHQpOwogICAgICAgIH0KICAgICAgICB0aGlzLnJlc2l6ZUVsID0gdGhpcy5wb3NpdGlvbkVsID0gdGhpcy53cmFwOwogICAgfSwKCiAgICBjcmVhdGVJRnJhbWU6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpOwogICAgICAgIGlmcmFtZS5uYW1lID0gRXh0LmlkKCk7CiAgICAgICAgaWZyYW1lLmZyYW1lQm9yZGVyID0gJzAnOwogICAgICAgIGlmcmFtZS5zdHlsZS5vdmVyZmxvdyA9ICdhdXRvJzsKICAgICAgICBpZnJhbWUuc3JjID0gRXh0LlNTTF9TRUNVUkVfVVJMOwoKICAgICAgICB0aGlzLndyYXAuZG9tLmFwcGVuZENoaWxkKGlmcmFtZSk7CiAgICAgICAgdGhpcy5pZnJhbWUgPSBpZnJhbWU7CgogICAgICAgIHRoaXMubW9uaXRvclRhc2sgPSBFeHQuVGFza01nci5zdGFydCh7CiAgICAgICAgICAgIHJ1bjogdGhpcy5jaGVja0Rlc2lnbk1vZGUsCiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICBpbnRlcnZhbDoxMDAKICAgICAgICB9KTsKICAgIH0sCgogICAgaW5pdEZyYW1lIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuVGFza01nci5zdG9wKHRoaXMubW9uaXRvclRhc2spOwogICAgICAgIHZhciBkb2MgPSB0aGlzLmdldERvYygpOwogICAgICAgIHRoaXMud2luID0gdGhpcy5nZXRXaW4oKTsKCiAgICAgICAgZG9jLm9wZW4oKTsKICAgICAgICBkb2Mud3JpdGUodGhpcy5nZXREb2NNYXJrdXAoKSk7CiAgICAgICAgZG9jLmNsb3NlKCk7CgogICAgICAgIHZhciB0YXNrID0geyAKICAgICAgICAgICAgcnVuIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIHZhciBkb2MgPSB0aGlzLmdldERvYygpOwogICAgICAgICAgICAgICAgaWYoZG9jLmJvZHkgfHwgZG9jLnJlYWR5U3RhdGUgPT0gJ2NvbXBsZXRlJyl7CiAgICAgICAgICAgICAgICAgICAgRXh0LlRhc2tNZ3Iuc3RvcCh0YXNrKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERlc2lnbk1vZGUodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbml0RWRpdG9yLmRlZmVyKDEwLCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW50ZXJ2YWwgOiAxMCwKICAgICAgICAgICAgZHVyYXRpb246MTAwMDAsCiAgICAgICAgICAgIHNjb3BlOiB0aGlzCiAgICAgICAgfTsKICAgICAgICBFeHQuVGFza01nci5zdGFydCh0YXNrKTsKICAgIH0sCgoKICAgIGNoZWNrRGVzaWduTW9kZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy53cmFwICYmIHRoaXMud3JhcC5kb20ub2Zmc2V0V2lkdGgpewogICAgICAgICAgICB2YXIgZG9jID0gdGhpcy5nZXREb2MoKTsKICAgICAgICAgICAgaWYoIWRvYyl7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoIWRvYy5lZGl0b3JJbml0aWFsaXplZCB8fCB0aGlzLmdldERlc2lnbk1vZGUoKSAhPSAnb24nKXsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdEZyYW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0RGVzaWduTW9kZSA6IGZ1bmN0aW9uKG1vZGUpewogICAgICAgIHZhciBkb2MgPSB0aGlzLmdldERvYygpOwogICAgICAgIGlmIChkb2MpIHsKICAgICAgICAgICAgaWYodGhpcy5yZWFkT25seSl7CiAgICAgICAgICAgICAgICBtb2RlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9jLmRlc2lnbk1vZGUgPSAoL29ufHRydWUvaSkudGVzdChTdHJpbmcobW9kZSkudG9Mb3dlckNhc2UoKSkgPydvbic6J29mZic7CiAgICAgICAgfQoKICAgIH0sCgogICAgCiAgICBnZXREZXNpZ25Nb2RlIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgZG9jID0gdGhpcy5nZXREb2MoKTsKICAgICAgICBpZighZG9jKXsgcmV0dXJuICcnOyB9CiAgICAgICAgcmV0dXJuIFN0cmluZyhkb2MuZGVzaWduTW9kZSkudG9Mb3dlckNhc2UoKTsKCiAgICB9LAoKICAgIGRpc2FibGVJdGVtczogZnVuY3Rpb24oZGlzYWJsZWQpewogICAgICAgIGlmKHRoaXMuZm9udFNlbGVjdCl7CiAgICAgICAgICAgIHRoaXMuZm9udFNlbGVjdC5kb20uZGlzYWJsZWQgPSBkaXNhYmxlZDsKICAgICAgICB9CiAgICAgICAgdGhpcy50Yi5pdGVtcy5lYWNoKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgICBpZihpdGVtLmdldEl0ZW1JZCgpICE9ICdzb3VyY2VlZGl0Jyl7CiAgICAgICAgICAgICAgICBpdGVtLnNldERpc2FibGVkKGRpc2FibGVkKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIG9uUmVzaXplIDogZnVuY3Rpb24odywgaCl7CiAgICAgICAgRXh0LmZvcm0uSHRtbEVkaXRvci5zdXBlcmNsYXNzLm9uUmVzaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgaWYodGhpcy5lbCAmJiB0aGlzLmlmcmFtZSl7CiAgICAgICAgICAgIGlmKEV4dC5pc051bWJlcih3KSl7CiAgICAgICAgICAgICAgICB2YXIgYXcgPSB3IC0gdGhpcy53cmFwLmdldEZyYW1lV2lkdGgoJ2xyJyk7CiAgICAgICAgICAgICAgICB0aGlzLmVsLnNldFdpZHRoKGF3KTsKICAgICAgICAgICAgICAgIHRoaXMudGIuc2V0V2lkdGgoYXcpOwogICAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc3R5bGUud2lkdGggPSBNYXRoLm1heChhdywgMCkgKyAncHgnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKEV4dC5pc051bWJlcihoKSl7CiAgICAgICAgICAgICAgICB2YXIgYWggPSBoIC0gdGhpcy53cmFwLmdldEZyYW1lV2lkdGgoJ3RiJykgLSB0aGlzLnRiLmVsLmdldEhlaWdodCgpOwogICAgICAgICAgICAgICAgdGhpcy5lbC5zZXRIZWlnaHQoYWgpOwogICAgICAgICAgICAgICAgdGhpcy5pZnJhbWUuc3R5bGUuaGVpZ2h0ID0gTWF0aC5tYXgoYWgsIDApICsgJ3B4JzsKICAgICAgICAgICAgICAgIHZhciBiZCA9IHRoaXMuZ2V0RWRpdG9yQm9keSgpOwogICAgICAgICAgICAgICAgaWYoYmQpewogICAgICAgICAgICAgICAgICAgIGJkLnN0eWxlLmhlaWdodCA9IE1hdGgubWF4KChhaCAtICh0aGlzLmlmcmFtZVBhZCoyKSksIDApICsgJ3B4JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICB0b2dnbGVTb3VyY2VFZGl0IDogZnVuY3Rpb24oc291cmNlRWRpdE1vZGUpewogICAgICAgIHZhciBpZnJhbWVIZWlnaHQsCiAgICAgICAgICAgIGVsSGVpZ2h0OwoKICAgICAgICBpZiAoc291cmNlRWRpdE1vZGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBzb3VyY2VFZGl0TW9kZSA9ICF0aGlzLnNvdXJjZUVkaXRNb2RlOwogICAgICAgIH0KICAgICAgICB0aGlzLnNvdXJjZUVkaXRNb2RlID0gc291cmNlRWRpdE1vZGUgPT09IHRydWU7CiAgICAgICAgdmFyIGJ0biA9IHRoaXMudGIuZ2V0Q29tcG9uZW50KCdzb3VyY2VlZGl0Jyk7CgogICAgICAgIGlmIChidG4ucHJlc3NlZCAhPT0gdGhpcy5zb3VyY2VFZGl0TW9kZSkgewogICAgICAgICAgICBidG4udG9nZ2xlKHRoaXMuc291cmNlRWRpdE1vZGUpOwogICAgICAgICAgICBpZiAoIWJ0bi54dGJIaWRkZW4pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5zb3VyY2VFZGl0TW9kZSkgewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5wcmV2aW91c1NpemUgPSB0aGlzLmdldFNpemUoKTsKCiAgICAgICAgICAgIGlmcmFtZUhlaWdodCA9IEV4dC5nZXQodGhpcy5pZnJhbWUpLmdldEhlaWdodCgpOwoKICAgICAgICAgICAgdGhpcy5kaXNhYmxlSXRlbXModHJ1ZSk7CiAgICAgICAgICAgIHRoaXMuc3luY1ZhbHVlKCk7CiAgICAgICAgICAgIHRoaXMuaWZyYW1lLmNsYXNzTmFtZSA9ICd4LWhpZGRlbic7CiAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlQ2xhc3MoJ3gtaGlkZGVuJyk7CiAgICAgICAgICAgIHRoaXMuZWwuZG9tLnJlbW92ZUF0dHJpYnV0ZSgndGFiSW5kZXgnKTsKICAgICAgICAgICAgdGhpcy5lbC5mb2N1cygpOwogICAgICAgICAgICB0aGlzLmVsLmRvbS5zdHlsZS5oZWlnaHQgPSBpZnJhbWVIZWlnaHQgKyAncHgnOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZWxIZWlnaHQgPSBwYXJzZUludCh0aGlzLmVsLmRvbS5zdHlsZS5oZWlnaHQsIDEwKTsKICAgICAgICAgICAgaWYgKHRoaXMuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGlzYWJsZUl0ZW1zKHRoaXMucmVhZE9ubHkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucHVzaFZhbHVlKCk7CiAgICAgICAgICAgIHRoaXMuaWZyYW1lLmNsYXNzTmFtZSA9ICcnOwogICAgICAgICAgICB0aGlzLmVsLmFkZENsYXNzKCd4LWhpZGRlbicpOwogICAgICAgICAgICB0aGlzLmVsLmRvbS5zZXRBdHRyaWJ1dGUoJ3RhYkluZGV4JywgLTEpOwogICAgICAgICAgICB0aGlzLmRlZmVyRm9jdXMoKTsKCiAgICAgICAgICAgIHRoaXMuc2V0U2l6ZSh0aGlzLnByZXZpb3VzU2l6ZSk7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnByZXZpb3VzU2l6ZTsKICAgICAgICAgICAgdGhpcy5pZnJhbWUuc3R5bGUuaGVpZ2h0ID0gZWxIZWlnaHQgKyAncHgnOwogICAgICAgIH0KICAgICAgICB0aGlzLmZpcmVFdmVudCgnZWRpdG1vZGVjaGFuZ2UnLCB0aGlzLCB0aGlzLnNvdXJjZUVkaXRNb2RlKTsKICAgIH0sCgogICAgCiAgICBjcmVhdGVMaW5rIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHVybCA9IHByb21wdCh0aGlzLmNyZWF0ZUxpbmtUZXh0LCB0aGlzLmRlZmF1bHRMaW5rVmFsdWUpOwogICAgICAgIGlmKHVybCAmJiB1cmwgIT0gJ2h0dHA6LycrJy8nKXsKICAgICAgICAgICAgdGhpcy5yZWxheUNtZCgnY3JlYXRlbGluaycsIHVybCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGluaXRFdmVudHMgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMub3JpZ2luYWxWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoKTsKICAgIH0sCgogICAgCiAgICBtYXJrSW52YWxpZCA6IEV4dC5lbXB0eUZuLAoKICAgIAogICAgY2xlYXJJbnZhbGlkIDogRXh0LmVtcHR5Rm4sCgogICAgCiAgICBzZXRWYWx1ZSA6IGZ1bmN0aW9uKHYpewogICAgICAgIEV4dC5mb3JtLkh0bWxFZGl0b3Iuc3VwZXJjbGFzcy5zZXRWYWx1ZS5jYWxsKHRoaXMsIHYpOwogICAgICAgIHRoaXMucHVzaFZhbHVlKCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgY2xlYW5IdG1sOiBmdW5jdGlvbihodG1sKSB7CiAgICAgICAgaHRtbCA9IFN0cmluZyhodG1sKTsKICAgICAgICBpZihFeHQuaXNXZWJLaXQpeyAKICAgICAgICAgICAgaHRtbCA9IGh0bWwucmVwbGFjZSgvXHNjbGFzcz0iKD86QXBwbGUtc3R5bGUtc3BhbnxraHRtbC1ibG9jay1wbGFjZWhvbGRlcikiL2dpLCAnJyk7CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBpZihodG1sLmNoYXJDb2RlQXQoMCkgPT0gdGhpcy5kZWZhdWx0VmFsdWUucmVwbGFjZSgvXEQvZywgJycpKXsKICAgICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKDEpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaHRtbDsKICAgIH0sCgogICAgCiAgICBzeW5jVmFsdWUgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMuaW5pdGlhbGl6ZWQpewogICAgICAgICAgICB2YXIgYmQgPSB0aGlzLmdldEVkaXRvckJvZHkoKTsKICAgICAgICAgICAgdmFyIGh0bWwgPSBiZC5pbm5lckhUTUw7CiAgICAgICAgICAgIGlmKEV4dC5pc1dlYktpdCl7CiAgICAgICAgICAgICAgICB2YXIgYnMgPSBiZC5nZXRBdHRyaWJ1dGUoJ3N0eWxlJyk7IAogICAgICAgICAgICAgICAgdmFyIG0gPSBicy5tYXRjaCgvdGV4dC1hbGlnbjooLio/KTsvaSk7CiAgICAgICAgICAgICAgICBpZihtICYmIG1bMV0pewogICAgICAgICAgICAgICAgICAgIGh0bWwgPSAnPGRpdiBzdHlsZT0iJyttWzBdKyciPicgKyBodG1sICsgJzwvZGl2Pic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaHRtbCA9IHRoaXMuY2xlYW5IdG1sKGh0bWwpOwogICAgICAgICAgICBpZih0aGlzLmZpcmVFdmVudCgnYmVmb3Jlc3luYycsIHRoaXMsIGh0bWwpICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICB0aGlzLmVsLmRvbS52YWx1ZSA9IGh0bWw7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnc3luYycsIHRoaXMsIGh0bWwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldFZhbHVlIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpc1t0aGlzLnNvdXJjZUVkaXRNb2RlID8gJ3B1c2hWYWx1ZScgOiAnc3luY1ZhbHVlJ10oKTsKICAgICAgICByZXR1cm4gRXh0LmZvcm0uSHRtbEVkaXRvci5zdXBlcmNsYXNzLmdldFZhbHVlLmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgcHVzaFZhbHVlIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmluaXRpYWxpemVkKXsKICAgICAgICAgICAgdmFyIHYgPSB0aGlzLmVsLmRvbS52YWx1ZTsKICAgICAgICAgICAgaWYoIXRoaXMuYWN0aXZhdGVkICYmIHYubGVuZ3RoIDwgMSl7CiAgICAgICAgICAgICAgICB2ID0gdGhpcy5kZWZhdWx0VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoJ2JlZm9yZXB1c2gnLCB0aGlzLCB2KSAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgdGhpcy5nZXRFZGl0b3JCb2R5KCkuaW5uZXJIVE1MID0gdjsKICAgICAgICAgICAgICAgIGlmKEV4dC5pc0dlY2tvKXsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldERlc2lnbk1vZGUoZmFsc2UpOyAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREZXNpZ25Nb2RlKHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3B1c2gnLCB0aGlzLCB2KTsKICAgICAgICAgICAgfQoKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZGVmZXJGb2N1cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5mb2N1cy5kZWZlcigxMCwgdGhpcyk7CiAgICB9LAoKICAgIAogICAgZm9jdXMgOiBmdW5jdGlvbigpewogICAgICAgIGlmKHRoaXMud2luICYmICF0aGlzLnNvdXJjZUVkaXRNb2RlKXsKICAgICAgICAgICAgdGhpcy53aW4uZm9jdXMoKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy5lbC5mb2N1cygpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBpbml0RWRpdG9yIDogZnVuY3Rpb24oKXsKICAgICAgICAKICAgICAgICB0cnl7CiAgICAgICAgICAgIHZhciBkYm9keSA9IHRoaXMuZ2V0RWRpdG9yQm9keSgpLAogICAgICAgICAgICAgICAgc3MgPSB0aGlzLmVsLmdldFN0eWxlcygnZm9udC1zaXplJywgJ2ZvbnQtZmFtaWx5JywgJ2JhY2tncm91bmQtaW1hZ2UnLCAnYmFja2dyb3VuZC1yZXBlYXQnLCAnYmFja2dyb3VuZC1jb2xvcicsICdjb2xvcicpLAogICAgICAgICAgICAgICAgZG9jLAogICAgICAgICAgICAgICAgZm47CgogICAgICAgICAgICBzc1snYmFja2dyb3VuZC1hdHRhY2htZW50J10gPSAnZml4ZWQnOyAKICAgICAgICAgICAgZGJvZHkuYmdQcm9wZXJ0aWVzID0gJ2ZpeGVkJzsgCgogICAgICAgICAgICBFeHQuRG9tSGVscGVyLmFwcGx5U3R5bGVzKGRib2R5LCBzcyk7CgogICAgICAgICAgICBkb2MgPSB0aGlzLmdldERvYygpOwoKICAgICAgICAgICAgaWYoZG9jKXsKICAgICAgICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLnJlbW92ZUFsbChkb2MpOwogICAgICAgICAgICAgICAgfWNhdGNoKGUpe30KICAgICAgICAgICAgfQoKICAgICAgICAgICAgCiAgICAgICAgICAgIGZuID0gdGhpcy5vbkVkaXRvckV2ZW50LmNyZWF0ZURlbGVnYXRlKHRoaXMpOwogICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLm9uKGRvYywgewogICAgICAgICAgICAgICAgbW91c2Vkb3duOiBmbiwKICAgICAgICAgICAgICAgIGRibGNsaWNrOiBmbiwKICAgICAgICAgICAgICAgIGNsaWNrOiBmbiwKICAgICAgICAgICAgICAgIGtleXVwOiBmbiwKICAgICAgICAgICAgICAgIGJ1ZmZlcjoxMDAKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZihFeHQuaXNHZWNrbyl7CiAgICAgICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLm9uKGRvYywgJ2tleXByZXNzJywgdGhpcy5hcHBseUNvbW1hbmQsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKEV4dC5pc0lFIHx8IEV4dC5pc1dlYktpdCB8fCBFeHQuaXNPcGVyYSl7CiAgICAgICAgICAgICAgICBFeHQuRXZlbnRNYW5hZ2VyLm9uKGRvYywgJ2tleWRvd24nLCB0aGlzLmZpeEtleXMsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvYy5lZGl0b3JJbml0aWFsaXplZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnB1c2hWYWx1ZSgpOwogICAgICAgICAgICB0aGlzLnNldFJlYWRPbmx5KHRoaXMucmVhZE9ubHkpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnaW5pdGlhbGl6ZScsIHRoaXMpOwogICAgICAgIH1jYXRjaChlKXt9CiAgICB9LAoKICAgIAogICAgYmVmb3JlRGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5tb25pdG9yVGFzayl7CiAgICAgICAgICAgIEV4dC5UYXNrTWdyLnN0b3AodGhpcy5tb25pdG9yVGFzayk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICBFeHQuZGVzdHJveSh0aGlzLnRiKTsKICAgICAgICAgICAgdmFyIGRvYyA9IHRoaXMuZ2V0RG9jKCk7CiAgICAgICAgICAgIGlmKGRvYyl7CiAgICAgICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICAgICAgRXh0LkV2ZW50TWFuYWdlci5yZW1vdmVBbGwoZG9jKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIGRvYyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkb2NbcHJvcF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfWNhdGNoKGUpe30KICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aGlzLndyYXApewogICAgICAgICAgICAgICAgdGhpcy53cmFwLmRvbS5pbm5lckhUTUwgPSAnJzsKICAgICAgICAgICAgICAgIHRoaXMud3JhcC5yZW1vdmUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBFeHQuZm9ybS5IdG1sRWRpdG9yLnN1cGVyY2xhc3MuYmVmb3JlRGVzdHJveS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICAKICAgIG9uRmlyc3RGb2N1cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5hY3RpdmF0ZWQgPSB0cnVlOwogICAgICAgIHRoaXMuZGlzYWJsZUl0ZW1zKHRoaXMucmVhZE9ubHkpOwogICAgICAgIGlmKEV4dC5pc0dlY2tvKXsgCiAgICAgICAgICAgIHRoaXMud2luLmZvY3VzKCk7CiAgICAgICAgICAgIHZhciBzID0gdGhpcy53aW4uZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICAgIGlmKCFzLmZvY3VzTm9kZSB8fCBzLmZvY3VzTm9kZS5ub2RlVHlwZSAhPSAzKXsKICAgICAgICAgICAgICAgIHZhciByID0gcy5nZXRSYW5nZUF0KDApOwogICAgICAgICAgICAgICAgci5zZWxlY3ROb2RlQ29udGVudHModGhpcy5nZXRFZGl0b3JCb2R5KCkpOwogICAgICAgICAgICAgICAgci5jb2xsYXBzZSh0cnVlKTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmZXJGb2N1cygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICAgIHRoaXMuZXhlY0NtZCgndXNlQ1NTJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLmV4ZWNDbWQoJ3N0eWxlV2l0aENTUycsIGZhbHNlKTsKICAgICAgICAgICAgfWNhdGNoKGUpe30KICAgICAgICB9CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2FjdGl2YXRlJywgdGhpcyk7CiAgICB9LAoKICAgIAogICAgYWRqdXN0Rm9udDogZnVuY3Rpb24oYnRuKXsKICAgICAgICB2YXIgYWRqdXN0ID0gYnRuLmdldEl0ZW1JZCgpID09ICdpbmNyZWFzZWZvbnRzaXplJyA/IDEgOiAtMSwKICAgICAgICAgICAgZG9jID0gdGhpcy5nZXREb2MoKSwKICAgICAgICAgICAgdiA9IHBhcnNlSW50KGRvYy5xdWVyeUNvbW1hbmRWYWx1ZSgnRm9udFNpemUnKSB8fCAyLCAxMCk7CiAgICAgICAgaWYoKEV4dC5pc1NhZmFyaSAmJiAhRXh0LmlzU2FmYXJpMikgfHwgRXh0LmlzQ2hyb21lIHx8IEV4dC5pc0Fpcil7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYodiA8PSAxMCl7CiAgICAgICAgICAgICAgICB2ID0gMSArIGFkanVzdDsKICAgICAgICAgICAgfWVsc2UgaWYodiA8PSAxMyl7CiAgICAgICAgICAgICAgICB2ID0gMiArIGFkanVzdDsKICAgICAgICAgICAgfWVsc2UgaWYodiA8PSAxNil7CiAgICAgICAgICAgICAgICB2ID0gMyArIGFkanVzdDsKICAgICAgICAgICAgfWVsc2UgaWYodiA8PSAxOCl7CiAgICAgICAgICAgICAgICB2ID0gNCArIGFkanVzdDsKICAgICAgICAgICAgfWVsc2UgaWYodiA8PSAyNCl7CiAgICAgICAgICAgICAgICB2ID0gNSArIGFkanVzdDsKICAgICAgICAgICAgfWVsc2UgewogICAgICAgICAgICAgICAgdiA9IDYgKyBhZGp1c3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdiA9IHYuY29uc3RyYWluKDEsIDYpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICBpZihFeHQuaXNTYWZhcmkpeyAKICAgICAgICAgICAgICAgIGFkanVzdCAqPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHYgPSBNYXRoLm1heCgxLCB2K2FkanVzdCkgKyAoRXh0LmlzU2FmYXJpID8gJ3B4JyA6IDApOwogICAgICAgIH0KICAgICAgICB0aGlzLmV4ZWNDbWQoJ0ZvbnRTaXplJywgdik7CiAgICB9LAoKICAgIAogICAgb25FZGl0b3JFdmVudCA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMudXBkYXRlVG9vbGJhcigpOwogICAgfSwKCgogICAgCiAgICB1cGRhdGVUb29sYmFyOiBmdW5jdGlvbigpewoKICAgICAgICBpZih0aGlzLnJlYWRPbmx5KXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYoIXRoaXMuYWN0aXZhdGVkKXsKICAgICAgICAgICAgdGhpcy5vbkZpcnN0Rm9jdXMoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGJ0bnMgPSB0aGlzLnRiLml0ZW1zLm1hcCwKICAgICAgICAgICAgZG9jID0gdGhpcy5nZXREb2MoKTsKCiAgICAgICAgaWYodGhpcy5lbmFibGVGb250ICYmICFFeHQuaXNTYWZhcmkyKXsKICAgICAgICAgICAgdmFyIG5hbWUgPSAoZG9jLnF1ZXJ5Q29tbWFuZFZhbHVlKCdGb250TmFtZScpfHx0aGlzLmRlZmF1bHRGb250KS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZihuYW1lICE9IHRoaXMuZm9udFNlbGVjdC5kb20udmFsdWUpewogICAgICAgICAgICAgICAgdGhpcy5mb250U2VsZWN0LmRvbS52YWx1ZSA9IG5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYodGhpcy5lbmFibGVGb3JtYXQpewogICAgICAgICAgICBidG5zLmJvbGQudG9nZ2xlKGRvYy5xdWVyeUNvbW1hbmRTdGF0ZSgnYm9sZCcpKTsKICAgICAgICAgICAgYnRucy5pdGFsaWMudG9nZ2xlKGRvYy5xdWVyeUNvbW1hbmRTdGF0ZSgnaXRhbGljJykpOwogICAgICAgICAgICBidG5zLnVuZGVybGluZS50b2dnbGUoZG9jLnF1ZXJ5Q29tbWFuZFN0YXRlKCd1bmRlcmxpbmUnKSk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMuZW5hYmxlQWxpZ25tZW50cyl7CiAgICAgICAgICAgIGJ0bnMuanVzdGlmeWxlZnQudG9nZ2xlKGRvYy5xdWVyeUNvbW1hbmRTdGF0ZSgnanVzdGlmeWxlZnQnKSk7CiAgICAgICAgICAgIGJ0bnMuanVzdGlmeWNlbnRlci50b2dnbGUoZG9jLnF1ZXJ5Q29tbWFuZFN0YXRlKCdqdXN0aWZ5Y2VudGVyJykpOwogICAgICAgICAgICBidG5zLmp1c3RpZnlyaWdodC50b2dnbGUoZG9jLnF1ZXJ5Q29tbWFuZFN0YXRlKCdqdXN0aWZ5cmlnaHQnKSk7CiAgICAgICAgfQogICAgICAgIGlmKCFFeHQuaXNTYWZhcmkyICYmIHRoaXMuZW5hYmxlTGlzdHMpewogICAgICAgICAgICBidG5zLmluc2VydG9yZGVyZWRsaXN0LnRvZ2dsZShkb2MucXVlcnlDb21tYW5kU3RhdGUoJ2luc2VydG9yZGVyZWRsaXN0JykpOwogICAgICAgICAgICBidG5zLmluc2VydHVub3JkZXJlZGxpc3QudG9nZ2xlKGRvYy5xdWVyeUNvbW1hbmRTdGF0ZSgnaW5zZXJ0dW5vcmRlcmVkbGlzdCcpKTsKICAgICAgICB9CgogICAgICAgIEV4dC5tZW51Lk1lbnVNZ3IuaGlkZUFsbCgpOwoKICAgICAgICB0aGlzLnN5bmNWYWx1ZSgpOwogICAgfSwKCiAgICAKICAgIHJlbGF5QnRuQ21kIDogZnVuY3Rpb24oYnRuKXsKICAgICAgICB0aGlzLnJlbGF5Q21kKGJ0bi5nZXRJdGVtSWQoKSk7CiAgICB9LAoKICAgIAogICAgcmVsYXlDbWQgOiBmdW5jdGlvbihjbWQsIHZhbHVlKXsKICAgICAgICAoZnVuY3Rpb24oKXsKICAgICAgICAgICAgdGhpcy5mb2N1cygpOwogICAgICAgICAgICB0aGlzLmV4ZWNDbWQoY21kLCB2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVG9vbGJhcigpOwogICAgICAgIH0pLmRlZmVyKDEwLCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBleGVjQ21kIDogZnVuY3Rpb24oY21kLCB2YWx1ZSl7CiAgICAgICAgdmFyIGRvYyA9IHRoaXMuZ2V0RG9jKCk7CiAgICAgICAgZG9jLmV4ZWNDb21tYW5kKGNtZCwgZmFsc2UsIHZhbHVlID09PSB1bmRlZmluZWQgPyBudWxsIDogdmFsdWUpOwogICAgICAgIHRoaXMuc3luY1ZhbHVlKCk7CiAgICB9LAoKICAgIAogICAgYXBwbHlDb21tYW5kIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYoZS5jdHJsS2V5KXsKICAgICAgICAgICAgdmFyIGMgPSBlLmdldENoYXJDb2RlKCksIGNtZDsKICAgICAgICAgICAgaWYoYyA+IDApewogICAgICAgICAgICAgICAgYyA9IFN0cmluZy5mcm9tQ2hhckNvZGUoYyk7CiAgICAgICAgICAgICAgICBzd2l0Y2goYyl7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnYic6CiAgICAgICAgICAgICAgICAgICAgICAgIGNtZCA9ICdib2xkJzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdpJzoKICAgICAgICAgICAgICAgICAgICAgICAgY21kID0gJ2l0YWxpYyc7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAndSc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNtZCA9ICd1bmRlcmxpbmUnOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoY21kKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLndpbi5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY0NtZChjbWQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVmZXJGb2N1cygpOwogICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBpbnNlcnRBdEN1cnNvciA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgIGlmKCF0aGlzLmFjdGl2YXRlZCl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYoRXh0LmlzSUUpewogICAgICAgICAgICB0aGlzLndpbi5mb2N1cygpOwogICAgICAgICAgICB2YXIgZG9jID0gdGhpcy5nZXREb2MoKSwKICAgICAgICAgICAgICAgIHIgPSBkb2Muc2VsZWN0aW9uLmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICAgIGlmKHIpewogICAgICAgICAgICAgICAgci5wYXN0ZUhUTUwodGV4dCk7CiAgICAgICAgICAgICAgICB0aGlzLnN5bmNWYWx1ZSgpOwogICAgICAgICAgICAgICAgdGhpcy5kZWZlckZvY3VzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdGhpcy53aW4uZm9jdXMoKTsKICAgICAgICAgICAgdGhpcy5leGVjQ21kKCdJbnNlcnRIVE1MJywgdGV4dCk7CiAgICAgICAgICAgIHRoaXMuZGVmZXJGb2N1cygpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBmaXhLZXlzIDogZnVuY3Rpb24oKXsgCiAgICAgICAgaWYoRXh0LmlzSUUpewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICB2YXIgayA9IGUuZ2V0S2V5KCksCiAgICAgICAgICAgICAgICAgICAgZG9jID0gdGhpcy5nZXREb2MoKSwKICAgICAgICAgICAgICAgICAgICAgICAgcjsKICAgICAgICAgICAgICAgIGlmKGsgPT0gZS5UQUIpewogICAgICAgICAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgciA9IGRvYy5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICBpZihyKXsKICAgICAgICAgICAgICAgICAgICAgICAgci5jb2xsYXBzZSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgci5wYXN0ZUhUTUwoJyZuYnNwOyZuYnNwOyZuYnNwOyZuYnNwOycpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmVyRm9jdXMoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9ZWxzZSBpZihrID09IGUuRU5URVIpewogICAgICAgICAgICAgICAgICAgIHIgPSBkb2Muc2VsZWN0aW9uLmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYocil7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSByLnBhcmVudEVsZW1lbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIXRhcmdldCB8fCB0YXJnZXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdsaScpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIucGFzdGVIVE1MKCc8YnIgLz4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIuY29sbGFwc2UoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgci5zZWxlY3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9ZWxzZSBpZihFeHQuaXNPcGVyYSl7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgIHZhciBrID0gZS5nZXRLZXkoKTsKICAgICAgICAgICAgICAgIGlmKGsgPT0gZS5UQUIpewogICAgICAgICAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy53aW4uZm9jdXMoKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWNDbWQoJ0luc2VydEhUTUwnLCcmbmJzcDsmbmJzcDsmbmJzcDsmbmJzcDsnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlZmVyRm9jdXMoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9ZWxzZSBpZihFeHQuaXNXZWJLaXQpewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICB2YXIgayA9IGUuZ2V0S2V5KCk7CiAgICAgICAgICAgICAgICBpZihrID09IGUuVEFCKXsKICAgICAgICAgICAgICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlY0NtZCgnSW5zZXJ0VGV4dCcsJ1x0Jyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZlckZvY3VzKCk7CiAgICAgICAgICAgICAgICB9ZWxzZSBpZihrID09IGUuRU5URVIpewogICAgICAgICAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjQ21kKCdJbnNlcnRIdG1sJywnPGJyIC8+PGJyIC8+Jyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWZlckZvY3VzKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0oKSwKCiAgICAKICAgIGdldFRvb2xiYXIgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLnRiOwogICAgfSwKCiAgICAKICAgIGJ1dHRvblRpcHMgOiB7CiAgICAgICAgYm9sZCA6IHsKICAgICAgICAgICAgdGl0bGU6ICdCb2xkIChDdHJsK0IpJywKICAgICAgICAgICAgdGV4dDogJ01ha2UgdGhlIHNlbGVjdGVkIHRleHQgYm9sZC4nLAogICAgICAgICAgICBjbHM6ICd4LWh0bWwtZWRpdG9yLXRpcCcKICAgICAgICB9LAogICAgICAgIGl0YWxpYyA6IHsKICAgICAgICAgICAgdGl0bGU6ICdJdGFsaWMgKEN0cmwrSSknLAogICAgICAgICAgICB0ZXh0OiAnTWFrZSB0aGUgc2VsZWN0ZWQgdGV4dCBpdGFsaWMuJywKICAgICAgICAgICAgY2xzOiAneC1odG1sLWVkaXRvci10aXAnCiAgICAgICAgfSwKICAgICAgICB1bmRlcmxpbmUgOiB7CiAgICAgICAgICAgIHRpdGxlOiAnVW5kZXJsaW5lIChDdHJsK1UpJywKICAgICAgICAgICAgdGV4dDogJ1VuZGVybGluZSB0aGUgc2VsZWN0ZWQgdGV4dC4nLAogICAgICAgICAgICBjbHM6ICd4LWh0bWwtZWRpdG9yLXRpcCcKICAgICAgICB9LAogICAgICAgIGluY3JlYXNlZm9udHNpemUgOiB7CiAgICAgICAgICAgIHRpdGxlOiAnR3JvdyBUZXh0JywKICAgICAgICAgICAgdGV4dDogJ0luY3JlYXNlIHRoZSBmb250IHNpemUuJywKICAgICAgICAgICAgY2xzOiAneC1odG1sLWVkaXRvci10aXAnCiAgICAgICAgfSwKICAgICAgICBkZWNyZWFzZWZvbnRzaXplIDogewogICAgICAgICAgICB0aXRsZTogJ1NocmluayBUZXh0JywKICAgICAgICAgICAgdGV4dDogJ0RlY3JlYXNlIHRoZSBmb250IHNpemUuJywKICAgICAgICAgICAgY2xzOiAneC1odG1sLWVkaXRvci10aXAnCiAgICAgICAgfSwKICAgICAgICBiYWNrY29sb3IgOiB7CiAgICAgICAgICAgIHRpdGxlOiAnVGV4dCBIaWdobGlnaHQgQ29sb3InLAogICAgICAgICAgICB0ZXh0OiAnQ2hhbmdlIHRoZSBiYWNrZ3JvdW5kIGNvbG9yIG9mIHRoZSBzZWxlY3RlZCB0ZXh0LicsCiAgICAgICAgICAgIGNsczogJ3gtaHRtbC1lZGl0b3ItdGlwJwogICAgICAgIH0sCiAgICAgICAgZm9yZWNvbG9yIDogewogICAgICAgICAgICB0aXRsZTogJ0ZvbnQgQ29sb3InLAogICAgICAgICAgICB0ZXh0OiAnQ2hhbmdlIHRoZSBjb2xvciBvZiB0aGUgc2VsZWN0ZWQgdGV4dC4nLAogICAgICAgICAgICBjbHM6ICd4LWh0bWwtZWRpdG9yLXRpcCcKICAgICAgICB9LAogICAgICAgIGp1c3RpZnlsZWZ0IDogewogICAgICAgICAgICB0aXRsZTogJ0FsaWduIFRleHQgTGVmdCcsCiAgICAgICAgICAgIHRleHQ6ICdBbGlnbiB0ZXh0IHRvIHRoZSBsZWZ0LicsCiAgICAgICAgICAgIGNsczogJ3gtaHRtbC1lZGl0b3ItdGlwJwogICAgICAgIH0sCiAgICAgICAganVzdGlmeWNlbnRlciA6IHsKICAgICAgICAgICAgdGl0bGU6ICdDZW50ZXIgVGV4dCcsCiAgICAgICAgICAgIHRleHQ6ICdDZW50ZXIgdGV4dCBpbiB0aGUgZWRpdG9yLicsCiAgICAgICAgICAgIGNsczogJ3gtaHRtbC1lZGl0b3ItdGlwJwogICAgICAgIH0sCiAgICAgICAganVzdGlmeXJpZ2h0IDogewogICAgICAgICAgICB0aXRsZTogJ0FsaWduIFRleHQgUmlnaHQnLAogICAgICAgICAgICB0ZXh0OiAnQWxpZ24gdGV4dCB0byB0aGUgcmlnaHQuJywKICAgICAgICAgICAgY2xzOiAneC1odG1sLWVkaXRvci10aXAnCiAgICAgICAgfSwKICAgICAgICBpbnNlcnR1bm9yZGVyZWRsaXN0IDogewogICAgICAgICAgICB0aXRsZTogJ0J1bGxldCBMaXN0JywKICAgICAgICAgICAgdGV4dDogJ1N0YXJ0IGEgYnVsbGV0ZWQgbGlzdC4nLAogICAgICAgICAgICBjbHM6ICd4LWh0bWwtZWRpdG9yLXRpcCcKICAgICAgICB9LAogICAgICAgIGluc2VydG9yZGVyZWRsaXN0IDogewogICAgICAgICAgICB0aXRsZTogJ051bWJlcmVkIExpc3QnLAogICAgICAgICAgICB0ZXh0OiAnU3RhcnQgYSBudW1iZXJlZCBsaXN0LicsCiAgICAgICAgICAgIGNsczogJ3gtaHRtbC1lZGl0b3ItdGlwJwogICAgICAgIH0sCiAgICAgICAgY3JlYXRlbGluayA6IHsKICAgICAgICAgICAgdGl0bGU6ICdIeXBlcmxpbmsnLAogICAgICAgICAgICB0ZXh0OiAnTWFrZSB0aGUgc2VsZWN0ZWQgdGV4dCBhIGh5cGVybGluay4nLAogICAgICAgICAgICBjbHM6ICd4LWh0bWwtZWRpdG9yLXRpcCcKICAgICAgICB9LAogICAgICAgIHNvdXJjZWVkaXQgOiB7CiAgICAgICAgICAgIHRpdGxlOiAnU291cmNlIEVkaXQnLAogICAgICAgICAgICB0ZXh0OiAnU3dpdGNoIHRvIHNvdXJjZSBlZGl0aW5nIG1vZGUuJywKICAgICAgICAgICAgY2xzOiAneC1odG1sLWVkaXRvci10aXAnCiAgICAgICAgfQogICAgfQoKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAp9KTsKRXh0LnJlZygnaHRtbGVkaXRvcicsIEV4dC5mb3JtLkh0bWxFZGl0b3IpOwoKRXh0LmZvcm0uVGltZUZpZWxkID0gRXh0LmV4dGVuZChFeHQuZm9ybS5Db21ib0JveCwgewogICAgCiAgICBtaW5WYWx1ZSA6IHVuZGVmaW5lZCwKICAgIAogICAgbWF4VmFsdWUgOiB1bmRlZmluZWQsCiAgICAKICAgIG1pblRleHQgOiAiVGhlIHRpbWUgaW4gdGhpcyBmaWVsZCBtdXN0IGJlIGVxdWFsIHRvIG9yIGFmdGVyIHswfSIsCiAgICAKICAgIG1heFRleHQgOiAiVGhlIHRpbWUgaW4gdGhpcyBmaWVsZCBtdXN0IGJlIGVxdWFsIHRvIG9yIGJlZm9yZSB7MH0iLAogICAgCiAgICBpbnZhbGlkVGV4dCA6ICJ7MH0gaXMgbm90IGEgdmFsaWQgdGltZSIsCiAgICAKICAgIGZvcm1hdCA6ICJnOmkgQSIsCiAgICAKICAgIGFsdEZvcm1hdHMgOiAiZzppYXxnOmlBfGc6aSBhfGc6aSBBfGg6aXxnOml8SDppfGdhfGhhfGdBfGggYXxnIGF8ZyBBfGdpfGhpfGdpYXxoaWF8Z3xIfGdpIGF8aGkgYXxnaUF8aGlBfGdpIEF8aGkgQSIsCiAgICAKICAgIGluY3JlbWVudDogMTUsCgogICAgCiAgICBtb2RlOiAnbG9jYWwnLAogICAgCiAgICB0cmlnZ2VyQWN0aW9uOiAnYWxsJywKICAgIAogICAgdHlwZUFoZWFkOiBmYWxzZSwKCiAgICAKICAgIAogICAgCiAgICBpbml0RGF0ZTogJzEvMS8yMDA4JywKCiAgICBpbml0RGF0ZUZvcm1hdDogJ2ovbi9ZJywKCiAgICAKICAgIGluaXRDb21wb25lbnQgOiBmdW5jdGlvbigpewogICAgICAgIGlmKEV4dC5pc0RlZmluZWQodGhpcy5taW5WYWx1ZSkpewogICAgICAgICAgICB0aGlzLnNldE1pblZhbHVlKHRoaXMubWluVmFsdWUsIHRydWUpOwogICAgICAgIH0KICAgICAgICBpZihFeHQuaXNEZWZpbmVkKHRoaXMubWF4VmFsdWUpKXsKICAgICAgICAgICAgdGhpcy5zZXRNYXhWYWx1ZSh0aGlzLm1heFZhbHVlLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgaWYoIXRoaXMuc3RvcmUpewogICAgICAgICAgICB0aGlzLmdlbmVyYXRlU3RvcmUodHJ1ZSk7CiAgICAgICAgfQogICAgICAgIEV4dC5mb3JtLlRpbWVGaWVsZC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBzZXRNaW5WYWx1ZTogZnVuY3Rpb24odmFsdWUsICBpbml0aWFsKXsKICAgICAgICB0aGlzLnNldExpbWl0KHZhbHVlLCB0cnVlLCBpbml0aWFsKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgCiAgICBzZXRNYXhWYWx1ZTogZnVuY3Rpb24odmFsdWUsICBpbml0aWFsKXsKICAgICAgICB0aGlzLnNldExpbWl0KHZhbHVlLCBmYWxzZSwgaW5pdGlhbCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIAogICAgZ2VuZXJhdGVTdG9yZTogZnVuY3Rpb24oaW5pdGlhbCl7CiAgICAgICAgdmFyIG1pbiA9IHRoaXMubWluVmFsdWUgfHwgbmV3IERhdGUodGhpcy5pbml0RGF0ZSkuY2xlYXJUaW1lKCksCiAgICAgICAgICAgIG1heCA9IHRoaXMubWF4VmFsdWUgfHwgbmV3IERhdGUodGhpcy5pbml0RGF0ZSkuY2xlYXJUaW1lKCkuYWRkKCdtaScsICgyNCAqIDYwKSAtIDEpLAogICAgICAgICAgICB0aW1lcyA9IFtdOwoKICAgICAgICB3aGlsZShtaW4gPD0gbWF4KXsKICAgICAgICAgICAgdGltZXMucHVzaChtaW4uZGF0ZUZvcm1hdCh0aGlzLmZvcm1hdCkpOwogICAgICAgICAgICBtaW4gPSBtaW4uYWRkKCdtaScsIHRoaXMuaW5jcmVtZW50KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5iaW5kU3RvcmUodGltZXMsIGluaXRpYWwpOwogICAgfSwKCiAgICAKICAgIHNldExpbWl0OiBmdW5jdGlvbih2YWx1ZSwgaXNNaW4sIGluaXRpYWwpewogICAgICAgIHZhciBkOwogICAgICAgIGlmKEV4dC5pc1N0cmluZyh2YWx1ZSkpewogICAgICAgICAgICBkID0gdGhpcy5wYXJzZURhdGUodmFsdWUpOwogICAgICAgIH1lbHNlIGlmKEV4dC5pc0RhdGUodmFsdWUpKXsKICAgICAgICAgICAgZCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBpZihkKXsKICAgICAgICAgICAgdmFyIHZhbCA9IG5ldyBEYXRlKHRoaXMuaW5pdERhdGUpLmNsZWFyVGltZSgpOwogICAgICAgICAgICB2YWwuc2V0SG91cnMoZC5nZXRIb3VycygpLCBkLmdldE1pbnV0ZXMoKSwgZC5nZXRTZWNvbmRzKCksIGQuZ2V0TWlsbGlzZWNvbmRzKCkpOwogICAgICAgICAgICB0aGlzW2lzTWluID8gJ21pblZhbHVlJyA6ICdtYXhWYWx1ZSddID0gdmFsOwogICAgICAgICAgICBpZighaW5pdGlhbCl7CiAgICAgICAgICAgICAgICB0aGlzLmdlbmVyYXRlU3RvcmUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRWYWx1ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHYgPSBFeHQuZm9ybS5UaW1lRmllbGQuc3VwZXJjbGFzcy5nZXRWYWx1ZS5jYWxsKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLmZvcm1hdERhdGUodGhpcy5wYXJzZURhdGUodikpIHx8ICcnOwogICAgfSwKCiAgICAKICAgIHNldFZhbHVlIDogZnVuY3Rpb24odmFsdWUpewogICAgICAgIHJldHVybiBFeHQuZm9ybS5UaW1lRmllbGQuc3VwZXJjbGFzcy5zZXRWYWx1ZS5jYWxsKHRoaXMsIHRoaXMuZm9ybWF0RGF0ZSh0aGlzLnBhcnNlRGF0ZSh2YWx1ZSkpKTsKICAgIH0sCgogICAgCiAgICB2YWxpZGF0ZVZhbHVlIDogRXh0LmZvcm0uRGF0ZUZpZWxkLnByb3RvdHlwZS52YWxpZGF0ZVZhbHVlLAoKICAgIGZvcm1hdERhdGUgOiBFeHQuZm9ybS5EYXRlRmllbGQucHJvdG90eXBlLmZvcm1hdERhdGUsCgogICAgcGFyc2VEYXRlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmICghdmFsdWUgfHwgRXh0LmlzRGF0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGlkID0gdGhpcy5pbml0RGF0ZSArICcgJywKICAgICAgICAgICAgaWRmID0gdGhpcy5pbml0RGF0ZUZvcm1hdCArICcgJywKICAgICAgICAgICAgdiA9IERhdGUucGFyc2VEYXRlKGlkICsgdmFsdWUsIGlkZiArIHRoaXMuZm9ybWF0KSwgCiAgICAgICAgICAgIGFmID0gdGhpcy5hbHRGb3JtYXRzOwoKICAgICAgICBpZiAoIXYgJiYgYWYpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmFsdEZvcm1hdHNBcnJheSkgewogICAgICAgICAgICAgICAgdGhpcy5hbHRGb3JtYXRzQXJyYXkgPSBhZi5zcGxpdCgifCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhZmEgPSB0aGlzLmFsdEZvcm1hdHNBcnJheSwgbGVuID0gYWZhLmxlbmd0aDsgaSA8IGxlbiAmJiAhdjsgaSsrKSB7CiAgICAgICAgICAgICAgICB2ID0gRGF0ZS5wYXJzZURhdGUoaWQgKyB2YWx1ZSwgaWRmICsgYWZhW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHY7CiAgICB9Cn0pOwpFeHQucmVnKCd0aW1lZmllbGQnLCBFeHQuZm9ybS5UaW1lRmllbGQpOwpFeHQuZm9ybS5TbGlkZXJGaWVsZCA9IEV4dC5leHRlbmQoRXh0LmZvcm0uRmllbGQsIHsKICAgIAogICAgCiAgICB1c2VUaXBzIDogdHJ1ZSwKICAgIAogICAgCiAgICB0aXBUZXh0IDogbnVsbCwKICAgIAogICAgCiAgICBhY3Rpb25Nb2RlOiAnd3JhcCcsCiAgICAKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjZmcgPSBFeHQuY29weVRvKHsKICAgICAgICAgICAgaWQ6IHRoaXMuaWQgKyAnLXNsaWRlcicKICAgICAgICB9LCB0aGlzLmluaXRpYWxDb25maWcsIFsndmVydGljYWwnLCAnbWluVmFsdWUnLCAnbWF4VmFsdWUnLCAnZGVjaW1hbFByZWNpc2lvbicsICdrZXlJbmNyZW1lbnQnLCAnaW5jcmVtZW50JywgJ2NsaWNrVG9DaGFuZ2UnLCAnYW5pbWF0ZSddKTsKICAgICAgICAKICAgICAgICAKICAgICAgICBpZiAodGhpcy51c2VUaXBzKSB7CiAgICAgICAgICAgIHZhciBwbHVnID0gdGhpcy50aXBUZXh0ID8ge2dldFRleHQ6IHRoaXMudGlwVGV4dH0gOiB7fTsKICAgICAgICAgICAgY2ZnLnBsdWdpbnMgPSBbbmV3IEV4dC5zbGlkZXIuVGlwKHBsdWcpXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zbGlkZXIgPSBuZXcgRXh0LlNsaWRlcihjZmcpOwogICAgICAgIEV4dC5mb3JtLlNsaWRlckZpZWxkLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpOwogICAgfSwgICAgCiAgICAKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIHRoaXMuYXV0b0NyZWF0ZSA9IHsKICAgICAgICAgICAgaWQ6IHRoaXMuaWQsCiAgICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgICAgICAgdHlwZTogJ2hpZGRlbicsCiAgICAgICAgICAgIHRhZzogJ2lucHV0JyAgICAKICAgICAgICB9OwogICAgICAgIEV4dC5mb3JtLlNsaWRlckZpZWxkLnN1cGVyY2xhc3Mub25SZW5kZXIuY2FsbCh0aGlzLCBjdCwgcG9zaXRpb24pOwogICAgICAgIHRoaXMud3JhcCA9IHRoaXMuZWwud3JhcCh7Y2xzOiAneC1mb3JtLWZpZWxkLXdyYXAnfSk7CiAgICAgICAgdGhpcy5yZXNpemVFbCA9IHRoaXMucG9zaXRpb25FbCA9IHRoaXMud3JhcDsKICAgICAgICB0aGlzLnNsaWRlci5yZW5kZXIodGhpcy53cmFwKTsKICAgIH0sCiAgICAKICAgIAogICAgb25SZXNpemUgOiBmdW5jdGlvbih3LCBoLCBhdywgYWgpewogICAgICAgIEV4dC5mb3JtLlNsaWRlckZpZWxkLnN1cGVyY2xhc3Mub25SZXNpemUuY2FsbCh0aGlzLCB3LCBoLCBhdywgYWgpOwogICAgICAgIHRoaXMuc2xpZGVyLnNldFNpemUodywgaCk7ICAgIAogICAgfSwKICAgIAogICAgCiAgICBpbml0RXZlbnRzIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5TbGlkZXJGaWVsZC5zdXBlcmNsYXNzLmluaXRFdmVudHMuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLnNsaWRlci5vbignY2hhbmdlJywgdGhpcy5vbkNoYW5nZSwgdGhpcyk7ICAgCiAgICB9LAogICAgCiAgICAKICAgIG9uQ2hhbmdlIDogZnVuY3Rpb24oc2xpZGVyLCB2KXsKICAgICAgICB0aGlzLnNldFZhbHVlKHYsIHVuZGVmaW5lZCwgdHJ1ZSk7CiAgICB9LAogICAgCiAgICAKICAgIG9uRW5hYmxlIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZm9ybS5TbGlkZXJGaWVsZC5zdXBlcmNsYXNzLm9uRW5hYmxlLmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5zbGlkZXIuZW5hYmxlKCk7CiAgICB9LAogICAgCiAgICAKICAgIG9uRGlzYWJsZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmZvcm0uU2xpZGVyRmllbGQuc3VwZXJjbGFzcy5vbkRpc2FibGUuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLnNsaWRlci5kaXNhYmxlKCk7ICAgIAogICAgfSwKICAgIAogICAgCiAgICBiZWZvcmVEZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZGVzdHJveSh0aGlzLnNsaWRlcik7CiAgICAgICAgRXh0LmZvcm0uU2xpZGVyRmllbGQuc3VwZXJjbGFzcy5iZWZvcmVEZXN0cm95LmNhbGwodGhpcyk7CiAgICB9LAogICAgCiAgICAKICAgIGFsaWduRXJyb3JJY29uIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLmVycm9ySWNvbi5hbGlnblRvKHRoaXMuc2xpZGVyLmVsLCAndGwtdHInLCBbMiwgMF0pOwogICAgfSwKICAgIAogICAgCiAgICBzZXRNaW5WYWx1ZSA6IGZ1bmN0aW9uKHYpewogICAgICAgIHRoaXMuc2xpZGVyLnNldE1pblZhbHVlKHYpOwogICAgICAgIHJldHVybiB0aGlzOyAgICAKICAgIH0sCiAgICAKICAgIAogICAgc2V0TWF4VmFsdWUgOiBmdW5jdGlvbih2KXsKICAgICAgICB0aGlzLnNsaWRlci5zZXRNYXhWYWx1ZSh2KTsKICAgICAgICByZXR1cm4gdGhpczsgICAgCiAgICB9LAogICAgCiAgICAKICAgIHNldFZhbHVlIDogZnVuY3Rpb24odiwgYW5pbWF0ZSwgIHNpbGVudCl7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgaWYoIXNpbGVudCl7CiAgICAgICAgICAgIHRoaXMuc2xpZGVyLnNldFZhbHVlKHYsIGFuaW1hdGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gRXh0LmZvcm0uU2xpZGVyRmllbGQuc3VwZXJjbGFzcy5zZXRWYWx1ZS5jYWxsKHRoaXMsIHRoaXMuc2xpZGVyLmdldFZhbHVlKCkpOwogICAgfSwKICAgIAogICAgCiAgICBnZXRWYWx1ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuc2xpZGVyLmdldFZhbHVlKCk7ICAgIAogICAgfQp9KTsKCkV4dC5yZWcoJ3NsaWRlcmZpZWxkJywgRXh0LmZvcm0uU2xpZGVyRmllbGQpOwpFeHQuZm9ybS5MYWJlbCA9IEV4dC5leHRlbmQoRXh0LkJveENvbXBvbmVudCwgewogICAgCiAgICAKICAgIAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIGlmKCF0aGlzLmVsKXsKICAgICAgICAgICAgdGhpcy5lbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xhYmVsJyk7CiAgICAgICAgICAgIHRoaXMuZWwuaWQgPSB0aGlzLmdldElkKCk7CiAgICAgICAgICAgIHRoaXMuZWwuaW5uZXJIVE1MID0gdGhpcy50ZXh0ID8gRXh0LnV0aWwuRm9ybWF0Lmh0bWxFbmNvZGUodGhpcy50ZXh0KSA6ICh0aGlzLmh0bWwgfHwgJycpOwogICAgICAgICAgICBpZih0aGlzLmZvcklkKXsKICAgICAgICAgICAgICAgIHRoaXMuZWwuc2V0QXR0cmlidXRlKCdmb3InLCB0aGlzLmZvcklkKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBFeHQuZm9ybS5MYWJlbC5zdXBlcmNsYXNzLm9uUmVuZGVyLmNhbGwodGhpcywgY3QsIHBvc2l0aW9uKTsKICAgIH0sCgogICAgCiAgICBzZXRUZXh0IDogZnVuY3Rpb24odCwgZW5jb2RlKXsKICAgICAgICB2YXIgZSA9IGVuY29kZSA9PT0gZmFsc2U7CiAgICAgICAgdGhpc1shZSA/ICd0ZXh0JyA6ICdodG1sJ10gPSB0OwogICAgICAgIGRlbGV0ZSB0aGlzW2UgPyAndGV4dCcgOiAnaHRtbCddOwogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICB0aGlzLmVsLmRvbS5pbm5lckhUTUwgPSBlbmNvZGUgIT09IGZhbHNlID8gRXh0LnV0aWwuRm9ybWF0Lmh0bWxFbmNvZGUodCkgOiB0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KfSk7CgpFeHQucmVnKCdsYWJlbCcsIEV4dC5mb3JtLkxhYmVsKTsKRXh0LmZvcm0uQWN0aW9uID0gZnVuY3Rpb24oZm9ybSwgb3B0aW9ucyl7CiAgICB0aGlzLmZvcm0gPSBmb3JtOwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKfTsKCgpFeHQuZm9ybS5BY3Rpb24uQ0xJRU5UX0lOVkFMSUQgPSAnY2xpZW50JzsKCkV4dC5mb3JtLkFjdGlvbi5TRVJWRVJfSU5WQUxJRCA9ICdzZXJ2ZXInOwoKRXh0LmZvcm0uQWN0aW9uLkNPTk5FQ1RfRkFJTFVSRSA9ICdjb25uZWN0JzsKCkV4dC5mb3JtLkFjdGlvbi5MT0FEX0ZBSUxVUkUgPSAnbG9hZCc7CgpFeHQuZm9ybS5BY3Rpb24ucHJvdG90eXBlID0gewoKCgoKCgoKCgoKCgoKCiAgICB0eXBlIDogJ2RlZmF1bHQnLAoKIAogCgogICAgCiAgICBydW4gOiBmdW5jdGlvbihvcHRpb25zKXsKCiAgICB9LAoKICAgIAogICAgc3VjY2VzcyA6IGZ1bmN0aW9uKHJlc3BvbnNlKXsKCiAgICB9LAoKICAgIAogICAgaGFuZGxlUmVzcG9uc2UgOiBmdW5jdGlvbihyZXNwb25zZSl7CgogICAgfSwKCiAgICAKICAgIGZhaWx1cmUgOiBmdW5jdGlvbihyZXNwb25zZSl7CiAgICAgICAgdGhpcy5yZXNwb25zZSA9IHJlc3BvbnNlOwogICAgICAgIHRoaXMuZmFpbHVyZVR5cGUgPSBFeHQuZm9ybS5BY3Rpb24uQ09OTkVDVF9GQUlMVVJFOwogICAgICAgIHRoaXMuZm9ybS5hZnRlckFjdGlvbih0aGlzLCBmYWxzZSk7CiAgICB9LAoKICAgIAogICAgCiAgICAKICAgIHByb2Nlc3NSZXNwb25zZSA6IGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgICB0aGlzLnJlc3BvbnNlID0gcmVzcG9uc2U7CiAgICAgICAgaWYoIXJlc3BvbnNlLnJlc3BvbnNlVGV4dCAmJiAhcmVzcG9uc2UucmVzcG9uc2VYTUwpewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgdGhpcy5yZXN1bHQgPSB0aGlzLmhhbmRsZVJlc3BvbnNlKHJlc3BvbnNlKTsKICAgICAgICByZXR1cm4gdGhpcy5yZXN1bHQ7CiAgICB9LAogICAgCiAgICBkZWNvZGVSZXNwb25zZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gRXh0LmRlY29kZShyZXNwb25zZS5yZXNwb25zZVRleHQpOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSAKICAgIH0sCgogICAgCiAgICBnZXRVcmwgOiBmdW5jdGlvbihhcHBlbmRQYXJhbXMpewogICAgICAgIHZhciB1cmwgPSB0aGlzLm9wdGlvbnMudXJsIHx8IHRoaXMuZm9ybS51cmwgfHwgdGhpcy5mb3JtLmVsLmRvbS5hY3Rpb247CiAgICAgICAgaWYoYXBwZW5kUGFyYW1zKXsKICAgICAgICAgICAgdmFyIHAgPSB0aGlzLmdldFBhcmFtcygpOwogICAgICAgICAgICBpZihwKXsKICAgICAgICAgICAgICAgIHVybCA9IEV4dC51cmxBcHBlbmQodXJsLCBwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdXJsOwogICAgfSwKCiAgICAKICAgIGdldE1ldGhvZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuICh0aGlzLm9wdGlvbnMubWV0aG9kIHx8IHRoaXMuZm9ybS5tZXRob2QgfHwgdGhpcy5mb3JtLmVsLmRvbS5tZXRob2QgfHwgJ1BPU1QnKS50b1VwcGVyQ2FzZSgpOwogICAgfSwKCiAgICAKICAgIGdldFBhcmFtcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGJwID0gdGhpcy5mb3JtLmJhc2VQYXJhbXM7CiAgICAgICAgdmFyIHAgPSB0aGlzLm9wdGlvbnMucGFyYW1zOwogICAgICAgIGlmKHApewogICAgICAgICAgICBpZih0eXBlb2YgcCA9PSAib2JqZWN0Iil7CiAgICAgICAgICAgICAgICBwID0gRXh0LnVybEVuY29kZShFeHQuYXBwbHlJZihwLCBicCkpOwogICAgICAgICAgICB9ZWxzZSBpZih0eXBlb2YgcCA9PSAnc3RyaW5nJyAmJiBicCl7CiAgICAgICAgICAgICAgICBwICs9ICcmJyArIEV4dC51cmxFbmNvZGUoYnApOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2UgaWYoYnApewogICAgICAgICAgICBwID0gRXh0LnVybEVuY29kZShicCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwOwogICAgfSwKCiAgICAKICAgIGNyZWF0ZUNhbGxiYWNrIDogZnVuY3Rpb24ob3B0cyl7CiAgICAgICAgdmFyIG9wdHMgPSBvcHRzIHx8IHt9OwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHN1Y2Nlc3M6IHRoaXMuc3VjY2VzcywKICAgICAgICAgICAgZmFpbHVyZTogdGhpcy5mYWlsdXJlLAogICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgdGltZW91dDogKG9wdHMudGltZW91dCoxMDAwKSB8fCAodGhpcy5mb3JtLnRpbWVvdXQqMTAwMCksCiAgICAgICAgICAgIHVwbG9hZDogdGhpcy5mb3JtLmZpbGVVcGxvYWQgPyB0aGlzLnN1Y2Nlc3MgOiB1bmRlZmluZWQKICAgICAgICB9OwogICAgfQp9OwoKCkV4dC5mb3JtLkFjdGlvbi5TdWJtaXQgPSBmdW5jdGlvbihmb3JtLCBvcHRpb25zKXsKICAgIEV4dC5mb3JtLkFjdGlvbi5TdWJtaXQuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGZvcm0sIG9wdGlvbnMpOwp9OwoKRXh0LmV4dGVuZChFeHQuZm9ybS5BY3Rpb24uU3VibWl0LCBFeHQuZm9ybS5BY3Rpb24sIHsKICAgIAogICAgCiAgICB0eXBlIDogJ3N1Ym1pdCcsCgogICAgCiAgICBydW4gOiBmdW5jdGlvbigpewogICAgICAgIHZhciBvID0gdGhpcy5vcHRpb25zLAogICAgICAgICAgICBtZXRob2QgPSB0aGlzLmdldE1ldGhvZCgpLAogICAgICAgICAgICBpc0dldCA9IG1ldGhvZCA9PSAnR0VUJzsKICAgICAgICBpZihvLmNsaWVudFZhbGlkYXRpb24gPT09IGZhbHNlIHx8IHRoaXMuZm9ybS5pc1ZhbGlkKCkpewogICAgICAgICAgICBpZiAoby5zdWJtaXRFbXB0eVRleHQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICB2YXIgZmllbGRzID0gdGhpcy5mb3JtLml0ZW1zLAogICAgICAgICAgICAgICAgICAgIGVtcHR5RmllbGRzID0gW10sCiAgICAgICAgICAgICAgICAgICAgc2V0dXBFbXB0eUZpZWxkcyA9IGZ1bmN0aW9uKGYpewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZi5lbC5nZXRWYWx1ZSgpID09IGYuZW1wdHlUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbXB0eUZpZWxkcy5wdXNoKGYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZi5lbC5kb20udmFsdWUgPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZihmLmlzQ29tcG9zaXRlICYmIGYucmVuZGVyZWQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZi5pdGVtcy5lYWNoKHNldHVwRW1wdHlGaWVsZHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZpZWxkcy5lYWNoKHNldHVwRW1wdHlGaWVsZHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEV4dC5BamF4LnJlcXVlc3QoRXh0LmFwcGx5KHRoaXMuY3JlYXRlQ2FsbGJhY2sobyksIHsKICAgICAgICAgICAgICAgIGZvcm06dGhpcy5mb3JtLmVsLmRvbSwKICAgICAgICAgICAgICAgIHVybDp0aGlzLmdldFVybChpc0dldCksCiAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZCwKICAgICAgICAgICAgICAgIGhlYWRlcnM6IG8uaGVhZGVycywKICAgICAgICAgICAgICAgIHBhcmFtczohaXNHZXQgPyB0aGlzLmdldFBhcmFtcygpIDogbnVsbCwKICAgICAgICAgICAgICAgIGlzVXBsb2FkOiB0aGlzLmZvcm0uZmlsZVVwbG9hZAogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGlmIChvLnN1Ym1pdEVtcHR5VGV4dCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIEV4dC5lYWNoKGVtcHR5RmllbGRzLCBmdW5jdGlvbihmKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGYuYXBwbHlFbXB0eVRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZi5hcHBseUVtcHR5VGV4dCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2UgaWYgKG8uY2xpZW50VmFsaWRhdGlvbiAhPT0gZmFsc2UpeyAKICAgICAgICAgICAgdGhpcy5mYWlsdXJlVHlwZSA9IEV4dC5mb3JtLkFjdGlvbi5DTElFTlRfSU5WQUxJRDsKICAgICAgICAgICAgdGhpcy5mb3JtLmFmdGVyQWN0aW9uKHRoaXMsIGZhbHNlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc3VjY2VzcyA6IGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5wcm9jZXNzUmVzcG9uc2UocmVzcG9uc2UpOwogICAgICAgIGlmKHJlc3VsdCA9PT0gdHJ1ZSB8fCByZXN1bHQuc3VjY2Vzcyl7CiAgICAgICAgICAgIHRoaXMuZm9ybS5hZnRlckFjdGlvbih0aGlzLCB0cnVlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZihyZXN1bHQuZXJyb3JzKXsKICAgICAgICAgICAgdGhpcy5mb3JtLm1hcmtJbnZhbGlkKHJlc3VsdC5lcnJvcnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLmZhaWx1cmVUeXBlID0gRXh0LmZvcm0uQWN0aW9uLlNFUlZFUl9JTlZBTElEOwogICAgICAgIHRoaXMuZm9ybS5hZnRlckFjdGlvbih0aGlzLCBmYWxzZSk7CiAgICB9LAoKICAgIAogICAgaGFuZGxlUmVzcG9uc2UgOiBmdW5jdGlvbihyZXNwb25zZSl7CiAgICAgICAgaWYodGhpcy5mb3JtLmVycm9yUmVhZGVyKXsKICAgICAgICAgICAgdmFyIHJzID0gdGhpcy5mb3JtLmVycm9yUmVhZGVyLnJlYWQocmVzcG9uc2UpOwogICAgICAgICAgICB2YXIgZXJyb3JzID0gW107CiAgICAgICAgICAgIGlmKHJzLnJlY29yZHMpewogICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gcnMucmVjb3Jkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciByID0gcnMucmVjb3Jkc1tpXTsKICAgICAgICAgICAgICAgICAgICBlcnJvcnNbaV0gPSByLmRhdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZXJyb3JzLmxlbmd0aCA8IDEpewogICAgICAgICAgICAgICAgZXJyb3JzID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgc3VjY2VzcyA6IHJzLnN1Y2Nlc3MsCiAgICAgICAgICAgICAgICBlcnJvcnMgOiBlcnJvcnMKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlUmVzcG9uc2UocmVzcG9uc2UpOwogICAgfQp9KTsKCgoKRXh0LmZvcm0uQWN0aW9uLkxvYWQgPSBmdW5jdGlvbihmb3JtLCBvcHRpb25zKXsKICAgIEV4dC5mb3JtLkFjdGlvbi5Mb2FkLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBmb3JtLCBvcHRpb25zKTsKICAgIHRoaXMucmVhZGVyID0gdGhpcy5mb3JtLnJlYWRlcjsKfTsKCkV4dC5leHRlbmQoRXh0LmZvcm0uQWN0aW9uLkxvYWQsIEV4dC5mb3JtLkFjdGlvbiwgewogICAgCiAgICB0eXBlIDogJ2xvYWQnLAoKICAgIAogICAgcnVuIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuQWpheC5yZXF1ZXN0KEV4dC5hcHBseSgKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlQ2FsbGJhY2sodGhpcy5vcHRpb25zKSwgewogICAgICAgICAgICAgICAgICAgIG1ldGhvZDp0aGlzLmdldE1ldGhvZCgpLAogICAgICAgICAgICAgICAgICAgIHVybDp0aGlzLmdldFVybChmYWxzZSksCiAgICAgICAgICAgICAgICAgICAgaGVhZGVyczogdGhpcy5vcHRpb25zLmhlYWRlcnMsCiAgICAgICAgICAgICAgICAgICAgcGFyYW1zOnRoaXMuZ2V0UGFyYW1zKCkKICAgICAgICB9KSk7CiAgICB9LAoKICAgIAogICAgc3VjY2VzcyA6IGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5wcm9jZXNzUmVzcG9uc2UocmVzcG9uc2UpOwogICAgICAgIGlmKHJlc3VsdCA9PT0gdHJ1ZSB8fCAhcmVzdWx0LnN1Y2Nlc3MgfHwgIXJlc3VsdC5kYXRhKXsKICAgICAgICAgICAgdGhpcy5mYWlsdXJlVHlwZSA9IEV4dC5mb3JtLkFjdGlvbi5MT0FEX0ZBSUxVUkU7CiAgICAgICAgICAgIHRoaXMuZm9ybS5hZnRlckFjdGlvbih0aGlzLCBmYWxzZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5mb3JtLmNsZWFySW52YWxpZCgpOwogICAgICAgIHRoaXMuZm9ybS5zZXRWYWx1ZXMocmVzdWx0LmRhdGEpOwogICAgICAgIHRoaXMuZm9ybS5hZnRlckFjdGlvbih0aGlzLCB0cnVlKTsKICAgIH0sCgogICAgCiAgICBoYW5kbGVSZXNwb25zZSA6IGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgICBpZih0aGlzLmZvcm0ucmVhZGVyKXsKICAgICAgICAgICAgdmFyIHJzID0gdGhpcy5mb3JtLnJlYWRlci5yZWFkKHJlc3BvbnNlKTsKICAgICAgICAgICAgdmFyIGRhdGEgPSBycy5yZWNvcmRzICYmIHJzLnJlY29yZHNbMF0gPyBycy5yZWNvcmRzWzBdLmRhdGEgOiBudWxsOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgc3VjY2VzcyA6IHJzLnN1Y2Nlc3MsCiAgICAgICAgICAgICAgICBkYXRhIDogZGF0YQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGVSZXNwb25zZShyZXNwb25zZSk7CiAgICB9Cn0pOwoKCgoKRXh0LmZvcm0uQWN0aW9uLkRpcmVjdExvYWQgPSBFeHQuZXh0ZW5kKEV4dC5mb3JtLkFjdGlvbi5Mb2FkLCB7CiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oZm9ybSwgb3B0cykgewogICAgICAgIEV4dC5mb3JtLkFjdGlvbi5EaXJlY3RMb2FkLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBmb3JtLCBvcHRzKTsKICAgIH0sCiAgICB0eXBlIDogJ2RpcmVjdGxvYWQnLAoKICAgIHJ1biA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGFyZ3MgPSB0aGlzLmdldFBhcmFtcygpOwogICAgICAgIGFyZ3MucHVzaCh0aGlzLnN1Y2Nlc3MsIHRoaXMpOwogICAgICAgIHRoaXMuZm9ybS5hcGkubG9hZC5hcHBseSh3aW5kb3csIGFyZ3MpOwogICAgfSwKCiAgICBnZXRQYXJhbXMgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYnVmID0gW10sIG8gPSB7fTsKICAgICAgICB2YXIgYnAgPSB0aGlzLmZvcm0uYmFzZVBhcmFtczsKICAgICAgICB2YXIgcCA9IHRoaXMub3B0aW9ucy5wYXJhbXM7CiAgICAgICAgRXh0LmFwcGx5KG8sIHAsIGJwKTsKICAgICAgICB2YXIgcGFyYW1PcmRlciA9IHRoaXMuZm9ybS5wYXJhbU9yZGVyOwogICAgICAgIGlmKHBhcmFtT3JkZXIpewogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBwYXJhbU9yZGVyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIGJ1Zi5wdXNoKG9bcGFyYW1PcmRlcltpXV0pOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2UgaWYodGhpcy5mb3JtLnBhcmFtc0FzSGFzaCl7CiAgICAgICAgICAgIGJ1Zi5wdXNoKG8pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYnVmOwogICAgfSwKICAgIAogICAgCiAgICAKICAgIHByb2Nlc3NSZXNwb25zZSA6IGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgIHRoaXMucmVzdWx0ID0gcmVzdWx0OwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9LAoKICAgIHN1Y2Nlc3MgOiBmdW5jdGlvbihyZXNwb25zZSwgdHJhbnMpewogICAgICAgIGlmKHRyYW5zLnR5cGUgPT0gRXh0LkRpcmVjdC5leGNlcHRpb25zLlNFUlZFUil7CiAgICAgICAgICAgIHJlc3BvbnNlID0ge307CiAgICAgICAgfQogICAgICAgIEV4dC5mb3JtLkFjdGlvbi5EaXJlY3RMb2FkLnN1cGVyY2xhc3Muc3VjY2Vzcy5jYWxsKHRoaXMsIHJlc3BvbnNlKTsKICAgIH0KfSk7CgoKRXh0LmZvcm0uQWN0aW9uLkRpcmVjdFN1Ym1pdCA9IEV4dC5leHRlbmQoRXh0LmZvcm0uQWN0aW9uLlN1Ym1pdCwgewogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihmb3JtLCBvcHRzKSB7CiAgICAgICAgRXh0LmZvcm0uQWN0aW9uLkRpcmVjdFN1Ym1pdC5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgZm9ybSwgb3B0cyk7CiAgICB9LAogICAgdHlwZSA6ICdkaXJlY3RzdWJtaXQnLAogICAgCiAgICBydW4gOiBmdW5jdGlvbigpewogICAgICAgIHZhciBvID0gdGhpcy5vcHRpb25zOwogICAgICAgIGlmKG8uY2xpZW50VmFsaWRhdGlvbiA9PT0gZmFsc2UgfHwgdGhpcy5mb3JtLmlzVmFsaWQoKSl7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zdWNjZXNzLnBhcmFtcyA9IHRoaXMuZ2V0UGFyYW1zKCk7CiAgICAgICAgICAgIHRoaXMuZm9ybS5hcGkuc3VibWl0KHRoaXMuZm9ybS5lbC5kb20sIHRoaXMuc3VjY2VzcywgdGhpcyk7CiAgICAgICAgfWVsc2UgaWYgKG8uY2xpZW50VmFsaWRhdGlvbiAhPT0gZmFsc2UpeyAKICAgICAgICAgICAgdGhpcy5mYWlsdXJlVHlwZSA9IEV4dC5mb3JtLkFjdGlvbi5DTElFTlRfSU5WQUxJRDsKICAgICAgICAgICAgdGhpcy5mb3JtLmFmdGVyQWN0aW9uKHRoaXMsIGZhbHNlKTsKICAgICAgICB9CiAgICB9LAoKICAgIGdldFBhcmFtcyA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBvID0ge307CiAgICAgICAgdmFyIGJwID0gdGhpcy5mb3JtLmJhc2VQYXJhbXM7CiAgICAgICAgdmFyIHAgPSB0aGlzLm9wdGlvbnMucGFyYW1zOwogICAgICAgIEV4dC5hcHBseShvLCBwLCBicCk7CiAgICAgICAgcmV0dXJuIG87CiAgICB9LAogICAgCiAgICAKICAgIAogICAgcHJvY2Vzc1Jlc3BvbnNlIDogZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgdGhpcy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCgogICAgc3VjY2VzcyA6IGZ1bmN0aW9uKHJlc3BvbnNlLCB0cmFucyl7CiAgICAgICAgaWYodHJhbnMudHlwZSA9PSBFeHQuRGlyZWN0LmV4Y2VwdGlvbnMuU0VSVkVSKXsKICAgICAgICAgICAgcmVzcG9uc2UgPSB7fTsKICAgICAgICB9CiAgICAgICAgRXh0LmZvcm0uQWN0aW9uLkRpcmVjdFN1Ym1pdC5zdXBlcmNsYXNzLnN1Y2Nlc3MuY2FsbCh0aGlzLCByZXNwb25zZSk7CiAgICB9Cn0pOwoKRXh0LmZvcm0uQWN0aW9uLkFDVElPTl9UWVBFUyA9IHsKICAgICdsb2FkJyA6IEV4dC5mb3JtLkFjdGlvbi5Mb2FkLAogICAgJ3N1Ym1pdCcgOiBFeHQuZm9ybS5BY3Rpb24uU3VibWl0LAogICAgJ2RpcmVjdGxvYWQnIDogRXh0LmZvcm0uQWN0aW9uLkRpcmVjdExvYWQsCiAgICAnZGlyZWN0c3VibWl0JyA6IEV4dC5mb3JtLkFjdGlvbi5EaXJlY3RTdWJtaXQKfTsKCkV4dC5mb3JtLlZUeXBlcyA9IGZ1bmN0aW9uKCl7CiAgICAKICAgIHZhciBhbHBoYSA9IC9eW2EtekEtWl9dKyQvLAogICAgICAgIGFscGhhbnVtID0gL15bYS16QS1aMC05X10rJC8sCiAgICAgICAgZW1haWwgPSAvXihcdyspKFtcLSsuXCddW1x3XSspKkAoXHdbXC1cd10qXC4pezEsNX0oW0EtWmEtel0pezIsNn0kLywKICAgICAgICB1cmwgPSAvKCgoXmh0dHBzPyl8KF5mdHApKTpcL1wvKFtcLVx3XStcLikrXHd7MiwzfShcL1slXC1cd10rKFwuXHd7Mix9KT8pKigoW1x3XC1cLlw/XFxcLytAJiM7YH49JSFdKikoXC5cd3syLH0pPykqXC8/KS9pOwoKICAgIAogICAgcmV0dXJuIHsKICAgICAgICAKICAgICAgICAnZW1haWwnIDogZnVuY3Rpb24odil7CiAgICAgICAgICAgIHJldHVybiBlbWFpbC50ZXN0KHYpOwogICAgICAgIH0sCiAgICAgICAgCiAgICAgICAgJ2VtYWlsVGV4dCcgOiAnVGhpcyBmaWVsZCBzaG91bGQgYmUgYW4gZS1tYWlsIGFkZHJlc3MgaW4gdGhlIGZvcm1hdCAidXNlckBleGFtcGxlLmNvbSInLAogICAgICAgIAogICAgICAgICdlbWFpbE1hc2snIDogL1thLXowLTlfXC5cLVwrXCdAXS9pLAoKICAgICAgICAvKioKICAgICAgICAgKiBUaGUgZnVuY3Rpb24gdXNlZCB0byB2YWxpZGF0ZSBVUkxzCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHZhbHVlIFRoZSBVUkwKICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIHRoZSBSZWdFeHAgdGVzdCBwYXNzZWQsIGFuZCBmYWxzZSBpZiBub3QuCiAgICAgICAgICovCiAgICAgICAgJ3VybCcgOiBmdW5jdGlvbih2KXsKICAgICAgICAgICAgcmV0dXJuIHVybC50ZXN0KHYpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGVycm9yIHRleHQgdG8gZGlzcGxheSB3aGVuIHRoZSB1cmwgdmFsaWRhdGlvbiBmdW5jdGlvbiByZXR1cm5zIGZhbHNlLiAgRGVmYXVsdHMgdG86CiAgICAgICAgICogPHR0PidUaGlzIGZpZWxkIHNob3VsZCBiZSBhIFVSTCBpbiB0aGUgZm9ybWF0ICJodHRwOi8nKycvd3d3LmV4YW1wbGUuY29tIic8L3R0PgogICAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgICAqLwogICAgICAgICd1cmxUZXh0JyA6ICdUaGlzIGZpZWxkIHNob3VsZCBiZSBhIFVSTCBpbiB0aGUgZm9ybWF0ICJodHRwOi8nKycvd3d3LmV4YW1wbGUuY29tIicsCgogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBmdW5jdGlvbiB1c2VkIHRvIHZhbGlkYXRlIGFscGhhIHZhbHVlcwogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUKICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIHRoZSBSZWdFeHAgdGVzdCBwYXNzZWQsIGFuZCBmYWxzZSBpZiBub3QuCiAgICAgICAgICovCiAgICAgICAgJ2FscGhhJyA6IGZ1bmN0aW9uKHYpewogICAgICAgICAgICByZXR1cm4gYWxwaGEudGVzdCh2KTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBlcnJvciB0ZXh0IHRvIGRpc3BsYXkgd2hlbiB0aGUgYWxwaGEgdmFsaWRhdGlvbiBmdW5jdGlvbiByZXR1cm5zIGZhbHNlLiAgRGVmYXVsdHMgdG86CiAgICAgICAgICogPHR0PidUaGlzIGZpZWxkIHNob3VsZCBvbmx5IGNvbnRhaW4gbGV0dGVycyBhbmQgXyc8L3R0PgogICAgICAgICAqIEB0eXBlIFN0cmluZwogICAgICAgICAqLwogICAgICAgICdhbHBoYVRleHQnIDogJ1RoaXMgZmllbGQgc2hvdWxkIG9ubHkgY29udGFpbiBsZXR0ZXJzIGFuZCBfJywKICAgICAgICAvKioKICAgICAgICAgKiBUaGUga2V5c3Ryb2tlIGZpbHRlciBtYXNrIHRvIGJlIGFwcGxpZWQgb24gYWxwaGEgaW5wdXQuICBEZWZhdWx0cyB0bzoKICAgICAgICAgKiA8dHQ+L1thLXpfXS9pPC90dD4KICAgICAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAgICAgKi8KICAgICAgICAnYWxwaGFNYXNrJyA6IC9bYS16X10vaSwKCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGZ1bmN0aW9uIHVzZWQgdG8gdmFsaWRhdGUgYWxwaGFudW1lcmljIHZhbHVlcwogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUKICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSB0cnVlIGlmIHRoZSBSZWdFeHAgdGVzdCBwYXNzZWQsIGFuZCBmYWxzZSBpZiBub3QuCiAgICAgICAgICovCiAgICAgICAgJ2FscGhhbnVtJyA6IGZ1bmN0aW9uKHYpewogICAgICAgICAgICByZXR1cm4gYWxwaGFudW0udGVzdCh2KTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBlcnJvciB0ZXh0IHRvIGRpc3BsYXkgd2hlbiB0aGUgYWxwaGFudW1lcmljIHZhbGlkYXRpb24gZnVuY3Rpb24gcmV0dXJucyBmYWxzZS4gIERlZmF1bHRzIHRvOgogICAgICAgICAqIDx0dD4nVGhpcyBmaWVsZCBzaG91bGQgb25seSBjb250YWluIGxldHRlcnMsIG51bWJlcnMgYW5kIF8nPC90dD4KICAgICAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAgICAgKi8KICAgICAgICAnYWxwaGFudW1UZXh0JyA6ICdUaGlzIGZpZWxkIHNob3VsZCBvbmx5IGNvbnRhaW4gbGV0dGVycywgbnVtYmVycyBhbmQgXycsCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIGtleXN0cm9rZSBmaWx0ZXIgbWFzayB0byBiZSBhcHBsaWVkIG9uIGFscGhhbnVtZXJpYyBpbnB1dC4gIERlZmF1bHRzIHRvOgogICAgICAgICAqIDx0dD4vW2EtejAtOV9dL2k8L3R0PgogICAgICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICAgICAqLwogICAgICAgICdhbHBoYW51bU1hc2snIDogL1thLXowLTlfXS9pCiAgICB9Owp9KCk7Ci8qKgogKiBAY2xhc3MgRXh0LmdyaWQuR3JpZFBhbmVsCiAqIEBleHRlbmRzIEV4dC5QYW5lbAogKiA8cD5UaGlzIGNsYXNzIHJlcHJlc2VudHMgdGhlIHByaW1hcnkgaW50ZXJmYWNlIG9mIGEgY29tcG9uZW50IGJhc2VkIGdyaWQgY29udHJvbCB0byByZXByZXNlbnQgZGF0YQogKiBpbiBhIHRhYnVsYXIgZm9ybWF0IG9mIHJvd3MgYW5kIGNvbHVtbnMuIFRoZSBHcmlkUGFuZWwgaXMgY29tcG9zZWQgb2YgdGhlIGZvbGxvd2luZzo8L3A+CiAqIDxkaXYgY2xhc3M9Im1kZXRhaWwtcGFyYW1zIj48dWw+CiAqIDxsaT48Yj57QGxpbmsgRXh0LmRhdGEuU3RvcmUgU3RvcmV9PC9iPiA6IFRoZSBNb2RlbCBob2xkaW5nIHRoZSBkYXRhIHJlY29yZHMgKHJvd3MpCiAqIDxkaXYgY2xhc3M9InN1Yi1kZXNjIj48L2Rpdj48L2xpPgogKiA8bGk+PGI+e0BsaW5rIEV4dC5ncmlkLkNvbHVtbk1vZGVsIENvbHVtbiBtb2RlbH08L2I+IDogQ29sdW1uIG1ha2V1cAogKiA8ZGl2IGNsYXNzPSJzdWItZGVzYyI+PC9kaXY+PC9saT4KICogPGxpPjxiPntAbGluayBFeHQuZ3JpZC5HcmlkVmlldyBWaWV3fTwvYj4gOiBFbmNhcHN1bGF0ZXMgdGhlIHVzZXIgaW50ZXJmYWNlCiAqIDxkaXYgY2xhc3M9InN1Yi1kZXNjIj48L2Rpdj48L2xpPgogKiA8bGk+PGI+e0BsaW5rIEV4dC5ncmlkLkFic3RyYWN0U2VsZWN0aW9uTW9kZWwgc2VsZWN0aW9uIG1vZGVsfTwvYj4gOiBTZWxlY3Rpb24gYmVoYXZpb3IKICogPGRpdiBjbGFzcz0ic3ViLWRlc2MiPjwvZGl2PjwvbGk+CiAqIDwvdWw+PC9kaXY+CiAqIDxwPkV4YW1wbGUgdXNhZ2U6PC9wPgogKiA8cHJlPjxjb2RlPgp2YXIgZ3JpZCA9IG5ldyBFeHQuZ3JpZC5HcmlkUGFuZWwoewogICAge0BsaW5rICNzdG9yZX06IG5ldyB7QGxpbmsgRXh0LmRhdGEuU3RvcmV9KHsKICAgICAgICB7QGxpbmsgRXh0LmRhdGEuU3RvcmUjYXV0b0Rlc3Ryb3kgYXV0b0Rlc3Ryb3l9OiB0cnVlLAogICAgICAgIHtAbGluayBFeHQuZGF0YS5TdG9yZSNyZWFkZXIgcmVhZGVyfTogcmVhZGVyLAogICAgICAgIHtAbGluayBFeHQuZGF0YS5TdG9yZSNkYXRhIGRhdGF9OiB4Zy5kdW1teURhdGEKICAgIH0pLAogICAge0BsaW5rICNjb2xNb2RlbH06IG5ldyB7QGxpbmsgRXh0LmdyaWQuQ29sdW1uTW9kZWx9KHsKICAgICAgICB7QGxpbmsgRXh0LmdyaWQuQ29sdW1uTW9kZWwjZGVmYXVsdHMgZGVmYXVsdHN9OiB7CiAgICAgICAgICAgIHdpZHRoOiAxMjAsCiAgICAgICAgICAgIHNvcnRhYmxlOiB0cnVlCiAgICAgICAgfSwKICAgICAgICB7QGxpbmsgRXh0LmdyaWQuQ29sdW1uTW9kZWwjY29sdW1ucyBjb2x1bW5zfTogWwogICAgICAgICAgICB7aWQ6ICdjb21wYW55JywgaGVhZGVyOiAnQ29tcGFueScsIHdpZHRoOiAyMDAsIHNvcnRhYmxlOiB0cnVlLCBkYXRhSW5kZXg6ICdjb21wYW55J30sCiAgICAgICAgICAgIHtoZWFkZXI6ICdQcmljZScsIHJlbmRlcmVyOiBFeHQudXRpbC5Gb3JtYXQudXNNb25leSwgZGF0YUluZGV4OiAncHJpY2UnfSwKICAgICAgICAgICAge2hlYWRlcjogJ0NoYW5nZScsIGRhdGFJbmRleDogJ2NoYW5nZSd9LAogICAgICAgICAgICB7aGVhZGVyOiAnJSBDaGFuZ2UnLCBkYXRhSW5kZXg6ICdwY3RDaGFuZ2UnfSwKICAgICAgICAgICAgLy8gaW5zdGVhZCBvZiBzcGVjaWZ5aW5nIHJlbmRlcmVyOiBFeHQudXRpbC5Gb3JtYXQuZGF0ZVJlbmRlcmVyKCdtL2QvWScpIHVzZSB4dHlwZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBoZWFkZXI6ICdMYXN0IFVwZGF0ZWQnLCB3aWR0aDogMTM1LCBkYXRhSW5kZXg6ICdsYXN0Q2hhbmdlJywKICAgICAgICAgICAgICAgIHh0eXBlOiAnZGF0ZWNvbHVtbicsIGZvcm1hdDogJ00gZCwgWScKICAgICAgICAgICAgfQogICAgICAgIF0KICAgIH0pLAogICAge0BsaW5rICN2aWV3Q29uZmlnfTogewogICAgICAgIHtAbGluayBFeHQuZ3JpZC5HcmlkVmlldyNmb3JjZUZpdCBmb3JjZUZpdH06IHRydWUsCgovLyAgICAgIFJldHVybiBDU1MgY2xhc3MgdG8gYXBwbHkgdG8gcm93cyBkZXBlbmRpbmcgdXBvbiBkYXRhIHZhbHVlcwogICAgICAgIHtAbGluayBFeHQuZ3JpZC5HcmlkVmlldyNnZXRSb3dDbGFzcyBnZXRSb3dDbGFzc306IGZ1bmN0aW9uKHJlY29yZCwgaW5kZXgpIHsKICAgICAgICAgICAgdmFyIGMgPSByZWNvcmQue0BsaW5rIEV4dC5kYXRhLlJlY29yZCNnZXQgZ2V0fSgnY2hhbmdlJyk7CiAgICAgICAgICAgIGlmIChjIDwgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuICdwcmljZS1mYWxsJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChjID4gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuICdwcmljZS1yaXNlJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICB7QGxpbmsgI3NtfTogbmV3IEV4dC5ncmlkLlJvd1NlbGVjdGlvbk1vZGVsKHtzaW5nbGVTZWxlY3Q6dHJ1ZX0pLAogICAgd2lkdGg6IDYwMCwKICAgIGhlaWdodDogMzAwLAogICAgZnJhbWU6IHRydWUsCiAgICB0aXRsZTogJ0ZyYW1lZCB3aXRoIFJvdyBTZWxlY3Rpb24gYW5kIEhvcml6b250YWwgU2Nyb2xsaW5nJywKICAgIGljb25DbHM6ICdpY29uLWdyaWQnCn0pOwogKiA8L2NvZGU+PC9wcmU+CiAqIDxwPjxiPjx1Pk5vdGVzOjwvdT48L2I+PC9wPgogKiA8ZGl2IGNsYXNzPSJtZGV0YWlsLXBhcmFtcyI+PHVsPgogKiA8bGk+QWx0aG91Z2ggdGhpcyBjbGFzcyBpbmhlcml0cyBtYW55IGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBmcm9tIGJhc2UgY2xhc3Nlcywgc29tZSBvZiB0aGVtCiAqIChzdWNoIGFzIGF1dG9TY3JvbGwsIGF1dG9XaWR0aCwgbGF5b3V0LCBpdGVtcywgZXRjKSBhcmUgbm90IHVzZWQgYnkgdGhpcyBjbGFzcywgYW5kIHdpbGwKICogaGF2ZSBubyBlZmZlY3QuPC9saT4KICogPGxpPkEgZ3JpZCA8Yj5yZXF1aXJlczwvYj4gYSB3aWR0aCBpbiB3aGljaCB0byBzY3JvbGwgaXRzIGNvbHVtbnMsIGFuZCBhIGhlaWdodCBpbiB3aGljaCB0bwogKiBzY3JvbGwgaXRzIHJvd3MuIFRoZXNlIGRpbWVuc2lvbnMgY2FuIGVpdGhlciBiZSBzZXQgZXhwbGljaXRseSB0aHJvdWdoIHRoZQogKiA8dHQ+e0BsaW5rIEV4dC5Cb3hDb21wb25lbnQjaGVpZ2h0IGhlaWdodH08L3R0PiBhbmQgPHR0PntAbGluayBFeHQuQm94Q29tcG9uZW50I3dpZHRoIHdpZHRofTwvdHQ+CiAqIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBvciBpbXBsaWNpdGx5IHNldCBieSB1c2luZyB0aGUgZ3JpZCBhcyBhIGNoaWxkIGl0ZW0gb2YgYQogKiB7QGxpbmsgRXh0LkNvbnRhaW5lciBDb250YWluZXJ9IHdoaWNoIHdpbGwgaGF2ZSBhIHtAbGluayBFeHQuQ29udGFpbmVyI2xheW91dCBsYXlvdXQgbWFuYWdlcn0KICogcHJvdmlkZSB0aGUgc2l6aW5nIG9mIGl0cyBjaGlsZCBpdGVtcyAoZm9yIGV4YW1wbGUgdGhlIENvbnRhaW5lciBvZiB0aGUgR3JpZCBtYXkgc3BlY2lmeQogKiA8dHQ+e0BsaW5rIEV4dC5Db250YWluZXIjbGF5b3V0IGxheW91dH06J2ZpdCc8L3R0PikuPC9saT4KICogPGxpPlRvIGFjY2VzcyB0aGUgZGF0YSBpbiBhIEdyaWQsIGl0IGlzIG5lY2Vzc2FyeSB0byB1c2UgdGhlIGRhdGEgbW9kZWwgZW5jYXBzdWxhdGVkCiAqIGJ5IHRoZSB7QGxpbmsgI3N0b3JlIFN0b3JlfS4gU2VlIHRoZSB7QGxpbmsgI2NlbGxjbGlja30gZXZlbnQgZm9yIG1vcmUgZGV0YWlscy48L2xpPgogKiA8L3VsPjwvZGl2PgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtPYmplY3R9IGNvbmZpZyBUaGUgY29uZmlnIG9iamVjdAogKiBAeHR5cGUgZ3JpZAogKi8KRXh0LmdyaWQuR3JpZFBhbmVsID0gRXh0LmV4dGVuZChFeHQuUGFuZWwsIHsKICAgIC8qKgogICAgICogQGNmZyB7U3RyaW5nfSBhdXRvRXhwYW5kQ29sdW1uCiAgICAgKiA8cD5UaGUgPHR0PntAbGluayBFeHQuZ3JpZC5Db2x1bW4jaWQgaWR9PC90dD4gb2YgYSB7QGxpbmsgRXh0LmdyaWQuQ29sdW1uIGNvbHVtbn0gaW4KICAgICAqIHRoaXMgZ3JpZCB0aGF0IHNob3VsZCBleHBhbmQgdG8gZmlsbCB1bnVzZWQgc3BhY2UuIFRoaXMgdmFsdWUgc3BlY2lmaWVkIGhlcmUgY2FuIG5vdAogICAgICogYmUgPHR0PjA8L3R0Pi48L3A+CiAgICAgKiA8YnI+PHA+PGI+Tm90ZTwvYj46IElmIHRoZSBHcmlkJ3Mge0BsaW5rIEV4dC5ncmlkLkdyaWRWaWV3IHZpZXd9IGlzIGNvbmZpZ3VyZWQgd2l0aAogICAgICogPHR0PntAbGluayBFeHQuZ3JpZC5HcmlkVmlldyNmb3JjZUZpdCBmb3JjZUZpdH09dHJ1ZTwvdHQ+IHRoZSA8dHQ+YXV0b0V4cGFuZENvbHVtbjwvdHQ+CiAgICAgKiBpcyBpZ25vcmVkLiBTZWUge0BsaW5rIEV4dC5ncmlkLkNvbHVtbn0uPHR0PntAbGluayBFeHQuZ3JpZC5Db2x1bW4jd2lkdGggd2lkdGh9PC90dD4KICAgICAqIGZvciBhZGRpdGlvbmFsIGRldGFpbHMuPC9wPgogICAgICogPHA+U2VlIDx0dD57QGxpbmsgI2F1dG9FeHBhbmRNYXh9PC90dD4gYW5kIDx0dD57QGxpbmsgI2F1dG9FeHBhbmRNaW59PC90dD4gYWxzby48L3A+CiAgICAgKi8KICAgIGF1dG9FeHBhbmRDb2x1bW4gOiBmYWxzZSwKICAgIAogICAgCiAgICBhdXRvRXhwYW5kTWF4IDogMTAwMCwKICAgIAogICAgCiAgICBhdXRvRXhwYW5kTWluIDogNTAsCiAgICAKICAgIAogICAgY29sdW1uTGluZXMgOiBmYWxzZSwKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIGRkVGV4dCA6ICd7MH0gc2VsZWN0ZWQgcm93ezF9JywKICAgIAogICAgCiAgICBkZWZlclJvd1JlbmRlciA6IHRydWUsCiAgICAKICAgIAogICAgCiAgICAKICAgIGVuYWJsZUNvbHVtbkhpZGUgOiB0cnVlLAogICAgCiAgICAKICAgIGVuYWJsZUNvbHVtbk1vdmUgOiB0cnVlLAogICAgCiAgICAKICAgIGVuYWJsZURyYWdEcm9wIDogZmFsc2UsCiAgICAKICAgIAogICAgZW5hYmxlSGRNZW51IDogdHJ1ZSwKICAgIAogICAgCiAgICAKICAgIGxvYWRNYXNrIDogZmFsc2UsCiAgICAKICAgIAogICAgCiAgICBtaW5Db2x1bW5XaWR0aCA6IDI1LAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIHN0cmlwZVJvd3MgOiBmYWxzZSwKICAgIAogICAgCiAgICB0cmFja01vdXNlT3ZlciA6IHRydWUsCiAgICAKICAgIAogICAgc3RhdGVFdmVudHMgOiBbJ2NvbHVtbm1vdmUnLCAnY29sdW1ucmVzaXplJywgJ3NvcnRjaGFuZ2UnLCAnZ3JvdXBjaGFuZ2UnXSwKICAgIAogICAgCiAgICB2aWV3IDogbnVsbCwKCiAgICAKICAgIGJ1YmJsZUV2ZW50czogW10sCgogICAgCgogICAgCiAgICByZW5kZXJlZCA6IGZhbHNlLAogICAgCiAgICAKICAgIHZpZXdSZWFkeSA6IGZhbHNlLAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCkgewogICAgICAgIEV4dC5ncmlkLkdyaWRQYW5lbC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKCiAgICAgICAgaWYgKHRoaXMuY29sdW1uTGluZXMpIHsKICAgICAgICAgICAgdGhpcy5jbHMgPSAodGhpcy5jbHMgfHwgJycpICsgJyB4LWdyaWQtd2l0aC1jb2wtbGluZXMnOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAKICAgICAgICB0aGlzLmF1dG9TY3JvbGwgPSBmYWxzZTsKICAgICAgICB0aGlzLmF1dG9XaWR0aCA9IGZhbHNlOwoKICAgICAgICBpZihFeHQuaXNBcnJheSh0aGlzLmNvbHVtbnMpKXsKICAgICAgICAgICAgdGhpcy5jb2xNb2RlbCA9IG5ldyBFeHQuZ3JpZC5Db2x1bW5Nb2RlbCh0aGlzLmNvbHVtbnMpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5jb2x1bW5zOwogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgaWYodGhpcy5kcyl7CiAgICAgICAgICAgIHRoaXMuc3RvcmUgPSB0aGlzLmRzOwogICAgICAgICAgICBkZWxldGUgdGhpcy5kczsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5jbSl7CiAgICAgICAgICAgIHRoaXMuY29sTW9kZWwgPSB0aGlzLmNtOwogICAgICAgICAgICBkZWxldGUgdGhpcy5jbTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5zbSl7CiAgICAgICAgICAgIHRoaXMuc2VsTW9kZWwgPSB0aGlzLnNtOwogICAgICAgICAgICBkZWxldGUgdGhpcy5zbTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdG9yZSA9IEV4dC5TdG9yZU1nci5sb29rdXAodGhpcy5zdG9yZSk7CgogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICdjbGljaycsCiAgICAgICAgICAgIAogICAgICAgICAgICAnZGJsY2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NvbnRleHRtZW51JywKICAgICAgICAgICAgCiAgICAgICAgICAgICdtb3VzZWRvd24nLAogICAgICAgICAgICAKICAgICAgICAgICAgJ21vdXNldXAnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ21vdXNlb3ZlcicsCiAgICAgICAgICAgIAogICAgICAgICAgICAnbW91c2VvdXQnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2tleXByZXNzJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdrZXlkb3duJywKCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NlbGxtb3VzZWRvd24nLAogICAgICAgICAgICAKICAgICAgICAgICAgJ3Jvd21vdXNlZG93bicsCiAgICAgICAgICAgIAogICAgICAgICAgICAnaGVhZGVybW91c2Vkb3duJywKCiAgICAgICAgICAgIAogICAgICAgICAgICAnZ3JvdXBtb3VzZWRvd24nLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICdyb3dib2R5bW91c2Vkb3duJywKCiAgICAgICAgICAgIAogICAgICAgICAgICAnY29udGFpbmVybW91c2Vkb3duJywKCiAgICAgICAgICAgIAogICAgICAgICAgICAnY2VsbGNsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjZWxsZGJsY2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ3Jvd2NsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdyb3dkYmxjbGljaycsCiAgICAgICAgICAgIAogICAgICAgICAgICAnaGVhZGVyY2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2hlYWRlcmRibGNsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdncm91cGNsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdncm91cGRibGNsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjb250YWluZXJjbGljaycsCiAgICAgICAgICAgIAogICAgICAgICAgICAnY29udGFpbmVyZGJsY2xpY2snLAoKICAgICAgICAgICAgCiAgICAgICAgICAgICdyb3dib2R5Y2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ3Jvd2JvZHlkYmxjbGljaycsCgogICAgICAgICAgICAKICAgICAgICAgICAgJ3Jvd2NvbnRleHRtZW51JywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjZWxsY29udGV4dG1lbnUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2hlYWRlcmNvbnRleHRtZW51JywKICAgICAgICAgICAgCiAgICAgICAgICAgICdncm91cGNvbnRleHRtZW51JywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjb250YWluZXJjb250ZXh0bWVudScsCiAgICAgICAgICAgIAogICAgICAgICAgICAncm93Ym9keWNvbnRleHRtZW51JywKICAgICAgICAgICAgCiAgICAgICAgICAgICdib2R5c2Nyb2xsJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjb2x1bW5yZXNpemUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NvbHVtbm1vdmUnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ3NvcnRjaGFuZ2UnLAogICAgICAgICAgICAKICAgICAgICAgICAgJ2dyb3VwY2hhbmdlJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdyZWNvbmZpZ3VyZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAndmlld3JlYWR5JwogICAgICAgICk7CiAgICB9LAoKICAgIAogICAgb25SZW5kZXIgOiBmdW5jdGlvbihjdCwgcG9zaXRpb24pewogICAgICAgIEV4dC5ncmlkLkdyaWRQYW5lbC5zdXBlcmNsYXNzLm9uUmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIHZhciBjID0gdGhpcy5nZXRHcmlkRWwoKTsKCiAgICAgICAgdGhpcy5lbC5hZGRDbGFzcygneC1ncmlkLXBhbmVsJyk7CgogICAgICAgIHRoaXMubW9uKGMsIHsKICAgICAgICAgICAgc2NvcGU6IHRoaXMsCiAgICAgICAgICAgIG1vdXNlZG93bjogdGhpcy5vbk1vdXNlRG93biwKICAgICAgICAgICAgY2xpY2s6IHRoaXMub25DbGljaywKICAgICAgICAgICAgZGJsY2xpY2s6IHRoaXMub25EYmxDbGljaywKICAgICAgICAgICAgY29udGV4dG1lbnU6IHRoaXMub25Db250ZXh0TWVudQogICAgICAgIH0pOwoKICAgICAgICB0aGlzLnJlbGF5RXZlbnRzKGMsIFsnbW91c2Vkb3duJywnbW91c2V1cCcsJ21vdXNlb3ZlcicsJ21vdXNlb3V0Jywna2V5cHJlc3MnLCAna2V5ZG93biddKTsKCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmdldFZpZXcoKTsKICAgICAgICB2aWV3LmluaXQodGhpcyk7CiAgICAgICAgdmlldy5yZW5kZXIoKTsKICAgICAgICB0aGlzLmdldFNlbGVjdGlvbk1vZGVsKCkuaW5pdCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBpbml0RXZlbnRzIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZ3JpZC5HcmlkUGFuZWwuc3VwZXJjbGFzcy5pbml0RXZlbnRzLmNhbGwodGhpcyk7CgogICAgICAgIGlmKHRoaXMubG9hZE1hc2spewogICAgICAgICAgICB0aGlzLmxvYWRNYXNrID0gbmV3IEV4dC5Mb2FkTWFzayh0aGlzLmJ3cmFwLAogICAgICAgICAgICAgICAgICAgIEV4dC5hcHBseSh7c3RvcmU6dGhpcy5zdG9yZX0sIHRoaXMubG9hZE1hc2spKTsKICAgICAgICB9CiAgICB9LAoKICAgIGluaXRTdGF0ZUV2ZW50cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmdyaWQuR3JpZFBhbmVsLnN1cGVyY2xhc3MuaW5pdFN0YXRlRXZlbnRzLmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5tb24odGhpcy5jb2xNb2RlbCwgJ2hpZGRlbmNoYW5nZScsIHRoaXMuc2F2ZVN0YXRlLCB0aGlzLCB7ZGVsYXk6IDEwMH0pOwogICAgfSwKCiAgICBhcHBseVN0YXRlIDogZnVuY3Rpb24oc3RhdGUpewogICAgICAgIHZhciBjbSA9IHRoaXMuY29sTW9kZWwsCiAgICAgICAgICAgIGNzID0gc3RhdGUuY29sdW1ucywKICAgICAgICAgICAgc3RvcmUgPSB0aGlzLnN0b3JlLAogICAgICAgICAgICBzLAogICAgICAgICAgICBjLAogICAgICAgICAgICBjb2xJbmRleDsKCiAgICAgICAgaWYoY3MpewogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBjcy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICBzID0gY3NbaV07CiAgICAgICAgICAgICAgICBjID0gY20uZ2V0Q29sdW1uQnlJZChzLmlkKTsKICAgICAgICAgICAgICAgIGlmKGMpewogICAgICAgICAgICAgICAgICAgIGNvbEluZGV4ID0gY20uZ2V0SW5kZXhCeUlkKHMuaWQpOwogICAgICAgICAgICAgICAgICAgIGNtLnNldFN0YXRlKGNvbEluZGV4LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhpZGRlbjogcy5oaWRkZW4sCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBzLndpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICBzb3J0YWJsZTogcy5zb3J0YWJsZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGlmKGNvbEluZGV4ICE9IGkpewogICAgICAgICAgICAgICAgICAgICAgICBjbS5tb3ZlQ29sdW1uKGNvbEluZGV4LCBpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoc3RvcmUpewogICAgICAgICAgICBzID0gc3RhdGUuc29ydDsKICAgICAgICAgICAgaWYocyl7CiAgICAgICAgICAgICAgICBzdG9yZVtzdG9yZS5yZW1vdGVTb3J0ID8gJ3NldERlZmF1bHRTb3J0JyA6ICdzb3J0J10ocy5maWVsZCwgcy5kaXJlY3Rpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHMgPSBzdGF0ZS5ncm91cDsKICAgICAgICAgICAgaWYoc3RvcmUuZ3JvdXBCeSl7CiAgICAgICAgICAgICAgICBpZihzKXsKICAgICAgICAgICAgICAgICAgICBzdG9yZS5ncm91cEJ5KHMpOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgc3RvcmUuY2xlYXJHcm91cGluZygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgIH0KICAgICAgICB2YXIgbyA9IEV4dC5hcHBseSh7fSwgc3RhdGUpOwogICAgICAgIGRlbGV0ZSBvLmNvbHVtbnM7CiAgICAgICAgZGVsZXRlIG8uc29ydDsKICAgICAgICBFeHQuZ3JpZC5HcmlkUGFuZWwuc3VwZXJjbGFzcy5hcHBseVN0YXRlLmNhbGwodGhpcywgbyk7CiAgICB9LAoKICAgIGdldFN0YXRlIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgbyA9IHtjb2x1bW5zOiBbXX0sCiAgICAgICAgICAgIHN0b3JlID0gdGhpcy5zdG9yZSwKICAgICAgICAgICAgc3MsCiAgICAgICAgICAgIGdzOwoKICAgICAgICBmb3IodmFyIGkgPSAwLCBjOyAoYyA9IHRoaXMuY29sTW9kZWwuY29uZmlnW2ldKTsgaSsrKXsKICAgICAgICAgICAgby5jb2x1bW5zW2ldID0gewogICAgICAgICAgICAgICAgaWQ6IGMuaWQsCiAgICAgICAgICAgICAgICB3aWR0aDogYy53aWR0aAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZihjLmhpZGRlbil7CiAgICAgICAgICAgICAgICBvLmNvbHVtbnNbaV0uaGlkZGVuID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihjLnNvcnRhYmxlKXsKICAgICAgICAgICAgICAgIG8uY29sdW1uc1tpXS5zb3J0YWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYoc3RvcmUpewogICAgICAgICAgICBzcyA9IHN0b3JlLmdldFNvcnRTdGF0ZSgpOwogICAgICAgICAgICBpZihzcyl7CiAgICAgICAgICAgICAgICBvLnNvcnQgPSBzczsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihzdG9yZS5nZXRHcm91cFN0YXRlKXsKICAgICAgICAgICAgICAgIGdzID0gc3RvcmUuZ2V0R3JvdXBTdGF0ZSgpOwogICAgICAgICAgICAgICAgaWYoZ3MpewogICAgICAgICAgICAgICAgICAgIG8uZ3JvdXAgPSBnczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbzsKICAgIH0sCgogICAgCiAgICBhZnRlclJlbmRlciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmdyaWQuR3JpZFBhbmVsLnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgdiA9IHRoaXMudmlldzsKICAgICAgICB0aGlzLm9uKCdib2R5cmVzaXplJywgdi5sYXlvdXQsIHYpOwogICAgICAgIHYubGF5b3V0KHRydWUpOwogICAgICAgIGlmKHRoaXMuZGVmZXJSb3dSZW5kZXIpewogICAgICAgICAgICBpZiAoIXRoaXMuZGVmZXJSb3dSZW5kZXJUYXNrKXsKICAgICAgICAgICAgICAgIHRoaXMuZGVmZXJSb3dSZW5kZXJUYXNrID0gbmV3IEV4dC51dGlsLkRlbGF5ZWRUYXNrKHYuYWZ0ZXJSZW5kZXIsIHRoaXMudmlldyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5kZWZlclJvd1JlbmRlclRhc2suZGVsYXkoMTApOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB2LmFmdGVyUmVuZGVyKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMudmlld1JlYWR5ID0gdHJ1ZTsKICAgIH0sCgogICAgCiAgICByZWNvbmZpZ3VyZSA6IGZ1bmN0aW9uKHN0b3JlLCBjb2xNb2RlbCl7CiAgICAgICAgdmFyIHJlbmRlcmVkID0gdGhpcy5yZW5kZXJlZDsKICAgICAgICBpZihyZW5kZXJlZCl7CiAgICAgICAgICAgIGlmKHRoaXMubG9hZE1hc2spewogICAgICAgICAgICAgICAgdGhpcy5sb2FkTWFzay5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB0aGlzLmxvYWRNYXNrID0gbmV3IEV4dC5Mb2FkTWFzayh0aGlzLmJ3cmFwLAogICAgICAgICAgICAgICAgICAgICAgICBFeHQuYXBwbHkoe30sIHtzdG9yZTpzdG9yZX0sIHRoaXMuaW5pdGlhbENvbmZpZy5sb2FkTWFzaykpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMudmlldyl7CiAgICAgICAgICAgIHRoaXMudmlldy5pbml0RGF0YShzdG9yZSwgY29sTW9kZWwpOwogICAgICAgIH0KICAgICAgICB0aGlzLnN0b3JlID0gc3RvcmU7CiAgICAgICAgdGhpcy5jb2xNb2RlbCA9IGNvbE1vZGVsOwogICAgICAgIGlmKHJlbmRlcmVkKXsKICAgICAgICAgICAgdGhpcy52aWV3LnJlZnJlc2godHJ1ZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdyZWNvbmZpZ3VyZScsIHRoaXMsIHN0b3JlLCBjb2xNb2RlbCk7CiAgICB9LAoKICAgIAogICAgb25EZXN0cm95IDogZnVuY3Rpb24oKXsKICAgICAgICBpZiAodGhpcy5kZWZlclJvd1JlbmRlclRhc2sgJiYgdGhpcy5kZWZlclJvd1JlbmRlclRhc2suY2FuY2VsKXsKICAgICAgICAgICAgdGhpcy5kZWZlclJvd1JlbmRlclRhc2suY2FuY2VsKCk7CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMucmVuZGVyZWQpewogICAgICAgICAgICBFeHQuZGVzdHJveSh0aGlzLnZpZXcsIHRoaXMubG9hZE1hc2spOwogICAgICAgIH1lbHNlIGlmKHRoaXMuc3RvcmUgJiYgdGhpcy5zdG9yZS5hdXRvRGVzdHJveSl7CiAgICAgICAgICAgIHRoaXMuc3RvcmUuZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgICBFeHQuZGVzdHJveSh0aGlzLmNvbE1vZGVsLCB0aGlzLnNlbE1vZGVsKTsKICAgICAgICB0aGlzLnN0b3JlID0gdGhpcy5zZWxNb2RlbCA9IHRoaXMuY29sTW9kZWwgPSB0aGlzLnZpZXcgPSB0aGlzLmxvYWRNYXNrID0gbnVsbDsKICAgICAgICBFeHQuZ3JpZC5HcmlkUGFuZWwuc3VwZXJjbGFzcy5vbkRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBwcm9jZXNzRXZlbnQgOiBmdW5jdGlvbihuYW1lLCBlKXsKICAgICAgICB0aGlzLnZpZXcucHJvY2Vzc0V2ZW50KG5hbWUsIGUpOwogICAgfSwKCiAgICAKICAgIG9uQ2xpY2sgOiBmdW5jdGlvbihlKXsKICAgICAgICB0aGlzLnByb2Nlc3NFdmVudCgnY2xpY2snLCBlKTsKICAgIH0sCgogICAgCiAgICBvbk1vdXNlRG93biA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMucHJvY2Vzc0V2ZW50KCdtb3VzZWRvd24nLCBlKTsKICAgIH0sCgogICAgCiAgICBvbkNvbnRleHRNZW51IDogZnVuY3Rpb24oZSwgdCl7CiAgICAgICAgdGhpcy5wcm9jZXNzRXZlbnQoJ2NvbnRleHRtZW51JywgZSk7CiAgICB9LAoKICAgIAogICAgb25EYmxDbGljayA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMucHJvY2Vzc0V2ZW50KCdkYmxjbGljaycsIGUpOwogICAgfSwKCiAgICAKICAgIHdhbGtDZWxscyA6IGZ1bmN0aW9uKHJvdywgY29sLCBzdGVwLCBmbiwgc2NvcGUpewogICAgICAgIHZhciBjbSAgICA9IHRoaXMuY29sTW9kZWwsCiAgICAgICAgICAgIGNsZW4gID0gY20uZ2V0Q29sdW1uQ291bnQoKSwKICAgICAgICAgICAgZHMgICAgPSB0aGlzLnN0b3JlLAogICAgICAgICAgICBybGVuICA9IGRzLmdldENvdW50KCksCiAgICAgICAgICAgIGZpcnN0ID0gdHJ1ZTsKCiAgICAgICAgaWYoc3RlcCA8IDApewogICAgICAgICAgICBpZihjb2wgPCAwKXsKICAgICAgICAgICAgICAgIHJvdy0tOwogICAgICAgICAgICAgICAgZmlyc3QgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZShyb3cgPj0gMCl7CiAgICAgICAgICAgICAgICBpZighZmlyc3QpewogICAgICAgICAgICAgICAgICAgIGNvbCA9IGNsZW4tMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZpcnN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICB3aGlsZShjb2wgPj0gMCl7CiAgICAgICAgICAgICAgICAgICAgaWYoZm4uY2FsbChzY29wZSB8fCB0aGlzLCByb3csIGNvbCwgY20pID09PSB0cnVlKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtyb3csIGNvbF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcm93LS07CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZihjb2wgPj0gY2xlbil7CiAgICAgICAgICAgICAgICByb3crKzsKICAgICAgICAgICAgICAgIGZpcnN0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUocm93IDwgcmxlbil7CiAgICAgICAgICAgICAgICBpZighZmlyc3QpewogICAgICAgICAgICAgICAgICAgIGNvbCA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmaXJzdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgd2hpbGUoY29sIDwgY2xlbil7CiAgICAgICAgICAgICAgICAgICAgaWYoZm4uY2FsbChzY29wZSB8fCB0aGlzLCByb3csIGNvbCwgY20pID09PSB0cnVlKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtyb3csIGNvbF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcm93Kys7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIAogICAgZ2V0R3JpZEVsIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5ib2R5OwogICAgfSwKCiAgICAKICAgIHN0b3BFZGl0aW5nIDogRXh0LmVtcHR5Rm4sCgogICAgCiAgICBnZXRTZWxlY3Rpb25Nb2RlbCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMuc2VsTW9kZWwpewogICAgICAgICAgICB0aGlzLnNlbE1vZGVsID0gbmV3IEV4dC5ncmlkLlJvd1NlbGVjdGlvbk1vZGVsKAogICAgICAgICAgICAgICAgICAgIHRoaXMuZGlzYWJsZVNlbGVjdGlvbiA/IHtzZWxlY3RSb3c6IEV4dC5lbXB0eUZufSA6IG51bGwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5zZWxNb2RlbDsKICAgIH0sCgogICAgCiAgICBnZXRTdG9yZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmU7CiAgICB9LAoKICAgIAogICAgZ2V0Q29sdW1uTW9kZWwgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmNvbE1vZGVsOwogICAgfSwKCiAgICAKICAgIGdldFZpZXcgOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMudmlldykgewogICAgICAgICAgICB0aGlzLnZpZXcgPSBuZXcgRXh0LmdyaWQuR3JpZFZpZXcodGhpcy52aWV3Q29uZmlnKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRoaXMudmlldzsKICAgIH0sCiAgICAKICAgIGdldERyYWdEcm9wVGV4dCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGNvdW50ID0gdGhpcy5zZWxNb2RlbC5nZXRDb3VudCgpOwogICAgICAgIHJldHVybiBTdHJpbmcuZm9ybWF0KHRoaXMuZGRUZXh0LCBjb3VudCwgY291bnQgPT0gMSA/ICcnIDogJ3MnKTsKICAgIH0KCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKCgoKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAp9KTsKRXh0LnJlZygnZ3JpZCcsIEV4dC5ncmlkLkdyaWRQYW5lbCk7CkV4dC5ncmlkLlBpdm90R3JpZCA9IEV4dC5leHRlbmQoRXh0LmdyaWQuR3JpZFBhbmVsLCB7CiAgICAKICAgIAogICAgYWdncmVnYXRvcjogJ3N1bScsCiAgICAKICAgIAogICAgcmVuZGVyZXI6IHVuZGVmaW5lZCwKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICBpbml0Q29tcG9uZW50OiBmdW5jdGlvbigpIHsKICAgICAgICBFeHQuZ3JpZC5QaXZvdEdyaWQuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgCiAgICAgICAgdGhpcy5pbml0QXhlcygpOwogICAgICAgIAogICAgICAgIAogICAgICAgIHRoaXMuZW5hYmxlQ29sdW1uUmVzaXplID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgdGhpcy52aWV3Q29uZmlnID0gRXh0LmFwcGx5KHRoaXMudmlld0NvbmZpZyB8fCB7fSwgewogICAgICAgICAgICBmb3JjZUZpdDogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgIHRoaXMuY29sTW9kZWwgPSBuZXcgRXh0LmdyaWQuQ29sdW1uTW9kZWwoe30pOwogICAgfSwKICAgIAogICAgCiAgICBnZXRBZ2dyZWdhdG9yOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodHlwZW9mIHRoaXMuYWdncmVnYXRvciA9PSAnc3RyaW5nJykgewogICAgICAgICAgICByZXR1cm4gRXh0LmdyaWQuUGl2b3RBZ2dyZWdhdG9yTWdyLnR5cGVzW3RoaXMuYWdncmVnYXRvcl07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWdncmVnYXRvcjsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIHNldEFnZ3JlZ2F0b3I6IGZ1bmN0aW9uKGFnZ3JlZ2F0b3IpIHsKICAgICAgICB0aGlzLmFnZ3JlZ2F0b3IgPSBhZ2dyZWdhdG9yOwogICAgfSwKICAgIAogICAgCiAgICBzZXRNZWFzdXJlOiBmdW5jdGlvbihtZWFzdXJlKSB7CiAgICAgICAgdGhpcy5tZWFzdXJlID0gbWVhc3VyZTsKICAgIH0sCiAgICAKICAgIAogICAgc2V0TGVmdEF4aXM6IGZ1bmN0aW9uKGF4aXMsIHJlZnJlc2gpIHsKICAgICAgICAKICAgICAgICB0aGlzLmxlZnRBeGlzID0gYXhpczsKICAgICAgICAKICAgICAgICBpZiAocmVmcmVzaCkgewogICAgICAgICAgICB0aGlzLnZpZXcucmVmcmVzaCgpOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgc2V0VG9wQXhpczogZnVuY3Rpb24oYXhpcywgcmVmcmVzaCkgewogICAgICAgIAogICAgICAgIHRoaXMudG9wQXhpcyA9IGF4aXM7CiAgICAgICAgCiAgICAgICAgaWYgKHJlZnJlc2gpIHsKICAgICAgICAgICAgdGhpcy52aWV3LnJlZnJlc2goKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIGluaXRBeGVzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgUGl2b3RBeGlzID0gRXh0LmdyaWQuUGl2b3RBeGlzOwogICAgICAgIAogICAgICAgIGlmICghKHRoaXMubGVmdEF4aXMgaW5zdGFuY2VvZiBQaXZvdEF4aXMpKSB7CiAgICAgICAgICAgIHRoaXMuc2V0TGVmdEF4aXMobmV3IFBpdm90QXhpcyh7CiAgICAgICAgICAgICAgICBvcmllbnRhdGlvbjogJ3ZlcnRpY2FsJywKICAgICAgICAgICAgICAgIGRpbWVuc2lvbnMgOiB0aGlzLmxlZnRBeGlzIHx8IFtdLAogICAgICAgICAgICAgICAgc3RvcmUgICAgICA6IHRoaXMuc3RvcmUKICAgICAgICAgICAgfSkpOwogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgaWYgKCEodGhpcy50b3BBeGlzIGluc3RhbmNlb2YgUGl2b3RBeGlzKSkgewogICAgICAgICAgICB0aGlzLnNldFRvcEF4aXMobmV3IFBpdm90QXhpcyh7CiAgICAgICAgICAgICAgICBvcmllbnRhdGlvbjogJ2hvcml6b250YWwnLAogICAgICAgICAgICAgICAgZGltZW5zaW9ucyA6IHRoaXMudG9wQXhpcyB8fCBbXSwKICAgICAgICAgICAgICAgIHN0b3JlICAgICAgOiB0aGlzLnN0b3JlCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9OwogICAgfSwKICAgIAogICAgCiAgICBleHRyYWN0RGF0YTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlY29yZHMgID0gdGhpcy5zdG9yZS5kYXRhLml0ZW1zLAogICAgICAgICAgICByZWNDb3VudCA9IHJlY29yZHMubGVuZ3RoLAogICAgICAgICAgICBjZWxscyAgICA9IFtdLAogICAgICAgICAgICByZWNvcmQsIGksIGosIGs7CiAgICAgICAgCiAgICAgICAgaWYgKHJlY0NvdW50ID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB2YXIgbGVmdFR1cGxlcyA9IHRoaXMubGVmdEF4aXMuZ2V0VHVwbGVzKCksCiAgICAgICAgICAgIGxlZnRDb3VudCAgPSBsZWZ0VHVwbGVzLmxlbmd0aCwKICAgICAgICAgICAgdG9wVHVwbGVzICA9IHRoaXMudG9wQXhpcy5nZXRUdXBsZXMoKSwKICAgICAgICAgICAgdG9wQ291bnQgICA9IHRvcFR1cGxlcy5sZW5ndGgsCiAgICAgICAgICAgIGFnZ3JlZ2F0b3IgPSB0aGlzLmdldEFnZ3JlZ2F0b3IoKTsKICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmVjQ291bnQ7IGkrKykgewogICAgICAgICAgICByZWNvcmQgPSByZWNvcmRzW2ldOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGxlZnRDb3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICBjZWxsc1tqXSA9IGNlbGxzW2pdIHx8IFtdOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAobGVmdFR1cGxlc1tqXS5tYXRjaGVyKHJlY29yZCkgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgdG9wQ291bnQ7IGsrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjZWxsc1tqXVtrXSA9IGNlbGxzW2pdW2tdIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvcFR1cGxlc1trXS5tYXRjaGVyKHJlY29yZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlbGxzW2pdW2tdLnB1c2gocmVjb3JkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICB2YXIgcm93Q291bnQgPSBjZWxscy5sZW5ndGgsCiAgICAgICAgICAgIGNvbENvdW50LCByb3c7CiAgICAgICAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHJvd0NvdW50OyBpKyspIHsKICAgICAgICAgICAgcm93ID0gY2VsbHNbaV07CiAgICAgICAgICAgIGNvbENvdW50ID0gcm93Lmxlbmd0aDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBjb2xDb3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICBjZWxsc1tpXVtqXSA9IGFnZ3JlZ2F0b3IoY2VsbHNbaV1bal0sIHRoaXMubWVhc3VyZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIGNlbGxzOwogICAgfSwKICAgIAogICAgCiAgICBnZXRWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMudmlldykgewogICAgICAgICAgICB0aGlzLnZpZXcgPSBuZXcgRXh0LmdyaWQuUGl2b3RHcmlkVmlldyh0aGlzLnZpZXdDb25maWcpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gdGhpcy52aWV3OwogICAgfQp9KTsKCkV4dC5yZWcoJ3Bpdm90Z3JpZCcsIEV4dC5ncmlkLlBpdm90R3JpZCk7CgoKRXh0LmdyaWQuUGl2b3RBZ2dyZWdhdG9yTWdyID0gbmV3IEV4dC5BYnN0cmFjdE1hbmFnZXIoKTsKCkV4dC5ncmlkLlBpdm90QWdncmVnYXRvck1nci5yZWdpc3RlclR5cGUoJ3N1bScsIGZ1bmN0aW9uKHJlY29yZHMsIG1lYXN1cmUpIHsKICAgIHZhciBsZW5ndGggPSByZWNvcmRzLmxlbmd0aCwKICAgICAgICB0b3RhbCAgPSAwLAogICAgICAgIGk7CiAgICAKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRvdGFsICs9IHJlY29yZHNbaV0uZ2V0KG1lYXN1cmUpOwogICAgfQogICAgCiAgICByZXR1cm4gdG90YWw7Cn0pOwoKRXh0LmdyaWQuUGl2b3RBZ2dyZWdhdG9yTWdyLnJlZ2lzdGVyVHlwZSgnYXZnJywgZnVuY3Rpb24ocmVjb3JkcywgbWVhc3VyZSkgewogICAgdmFyIGxlbmd0aCA9IHJlY29yZHMubGVuZ3RoLAogICAgICAgIHRvdGFsICA9IDAsCiAgICAgICAgaTsKICAgIAogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG90YWwgKz0gcmVjb3Jkc1tpXS5nZXQobWVhc3VyZSk7CiAgICB9CiAgICAKICAgIHJldHVybiAodG90YWwgLyBsZW5ndGgpIHx8ICduL2EnOwp9KTsKCkV4dC5ncmlkLlBpdm90QWdncmVnYXRvck1nci5yZWdpc3RlclR5cGUoJ21pbicsIGZ1bmN0aW9uKHJlY29yZHMsIG1lYXN1cmUpIHsKICAgIHZhciBkYXRhICAgPSBbXSwKICAgICAgICBsZW5ndGggPSByZWNvcmRzLmxlbmd0aCwKICAgICAgICBpOwogICAgCiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBkYXRhLnB1c2gocmVjb3Jkc1tpXS5nZXQobWVhc3VyZSkpOwogICAgfQogICAgCiAgICByZXR1cm4gTWF0aC5taW4uYXBwbHkodGhpcywgZGF0YSkgfHwgJ24vYSc7Cn0pOwoKRXh0LmdyaWQuUGl2b3RBZ2dyZWdhdG9yTWdyLnJlZ2lzdGVyVHlwZSgnbWF4JywgZnVuY3Rpb24ocmVjb3JkcywgbWVhc3VyZSkgewogICAgdmFyIGRhdGEgICA9IFtdLAogICAgICAgIGxlbmd0aCA9IHJlY29yZHMubGVuZ3RoLAogICAgICAgIGk7CiAgICAKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGRhdGEucHVzaChyZWNvcmRzW2ldLmdldChtZWFzdXJlKSk7CiAgICB9CiAgICAKICAgIHJldHVybiBNYXRoLm1heC5hcHBseSh0aGlzLCBkYXRhKSB8fCAnbi9hJzsKfSk7CgpFeHQuZ3JpZC5QaXZvdEFnZ3JlZ2F0b3JNZ3IucmVnaXN0ZXJUeXBlKCdjb3VudCcsIGZ1bmN0aW9uKHJlY29yZHMsIG1lYXN1cmUpIHsKICAgIHJldHVybiByZWNvcmRzLmxlbmd0aDsKfSk7CkV4dC5ncmlkLkdyaWRWaWV3ID0gRXh0LmV4dGVuZChFeHQudXRpbC5PYnNlcnZhYmxlLCB7CiAgICAKCiAgICAKCiAgICAKCiAgICAKCiAgICAKCiAgICAKICAgIGRlZmVyRW1wdHlUZXh0IDogdHJ1ZSwKCiAgICAKICAgIHNjcm9sbE9mZnNldCA6IHVuZGVmaW5lZCwKCiAgICAKICAgIGF1dG9GaWxsIDogZmFsc2UsCgogICAgCiAgICBmb3JjZUZpdCA6IGZhbHNlLAoKICAgIAogICAgc29ydENsYXNzZXMgOiBbJ3NvcnQtYXNjJywgJ3NvcnQtZGVzYyddLAoKICAgIAogICAgc29ydEFzY1RleHQgOiAnU29ydCBBc2NlbmRpbmcnLAoKICAgIAogICAgc29ydERlc2NUZXh0IDogJ1NvcnQgRGVzY2VuZGluZycsCgogICAgCiAgICBjb2x1bW5zVGV4dCA6ICdDb2x1bW5zJywKCiAgICAKICAgIHNlbGVjdGVkUm93Q2xhc3MgOiAneC1ncmlkMy1yb3ctc2VsZWN0ZWQnLAoKICAgIAogICAgYm9yZGVyV2lkdGggOiAyLAogICAgdGRDbGFzcyA6ICd4LWdyaWQzLWNlbGwnLAogICAgaGRDbHMgOiAneC1ncmlkMy1oZCcsCiAgICAKICAgIAogICAgCiAgICBtYXJrRGlydHkgOiB0cnVlLAoKICAgIAogICAgY2VsbFNlbGVjdG9yRGVwdGggOiA0LAogICAgCiAgICAKICAgIHJvd1NlbGVjdG9yRGVwdGggOiAxMCwKCiAgICAKICAgIHJvd0JvZHlTZWxlY3RvckRlcHRoIDogMTAsCgogICAgCiAgICBjZWxsU2VsZWN0b3IgOiAndGQueC1ncmlkMy1jZWxsJywKICAgIAogICAgCiAgICByb3dTZWxlY3RvciA6ICdkaXYueC1ncmlkMy1yb3cnLAoKICAgIAogICAgcm93Qm9keVNlbGVjdG9yIDogJ2Rpdi54LWdyaWQzLXJvdy1ib2R5JywKCiAgICAKICAgIGZpcnN0Um93Q2xzOiAneC1ncmlkMy1yb3ctZmlyc3QnLAogICAgbGFzdFJvd0NsczogJ3gtZ3JpZDMtcm93LWxhc3QnLAogICAgcm93Q2xzUmU6IC8oPzpefFxzKyl4LWdyaWQzLXJvdy0oZmlyc3R8bGFzdHxhbHQpKD86XHMrfCQpL2csCiAgICAKICAgIAogICAgaGVhZGVyTWVudU9wZW5DbHM6ICd4LWdyaWQzLWhkLW1lbnUtb3BlbicsCiAgICAKICAgIAogICAgcm93T3ZlckNsczogJ3gtZ3JpZDMtcm93LW92ZXInLAoKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgRXh0LmFwcGx5KHRoaXMsIGNvbmZpZyk7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdGhpcy5hZGRFdmVudHMoCiAgICAgICAgICAgIAogICAgICAgICAgICAnYmVmb3Jlcm93cmVtb3ZlZCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZXJvd3NpbnNlcnRlZCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgJ2JlZm9yZXJlZnJlc2gnLAogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICdyb3dyZW1vdmVkJywKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAncm93c2luc2VydGVkJywKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAncm93dXBkYXRlZCcsCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgJ3JlZnJlc2gnCiAgICAgICAgKTsKICAgICAgICAKICAgICAgICBFeHQuZ3JpZC5HcmlkVmlldy5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgCiAgICAKICAgIG1hc3RlclRwbDogbmV3IEV4dC5UZW1wbGF0ZSgKICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMyIgaGlkZWZvY3VzPSJ0cnVlIj4nLAogICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy12aWV3cG9ydCI+JywKICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWdyaWQzLWhlYWRlciI+JywKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1oZWFkZXItaW5uZXIiPicsCiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWdyaWQzLWhlYWRlci1vZmZzZXQiIHN0eWxlPSJ7b3N0eWxlfSI+e2hlYWRlcn08L2Rpdj4nLAogICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nLAogICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWNsZWFyIj48L2Rpdj4nLAogICAgICAgICAgICAgICAgJzwvZGl2PicsCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1zY3JvbGxlciI+JywKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1ib2R5IiBzdHlsZT0ie2JzdHlsZX0iPntib2R5fTwvZGl2PicsCiAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9IiMiIGNsYXNzPSJ4LWdyaWQzLWZvY3VzIiB0YWJJbmRleD0iLTEiPjwvYT4nLAogICAgICAgICAgICAgICAgJzwvZGl2PicsCiAgICAgICAgICAgICc8L2Rpdj4nLAogICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1yZXNpemUtbWFya2VyIj4mIzE2MDs8L2Rpdj4nLAogICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1yZXNpemUtcHJveHkiPiYjMTYwOzwvZGl2PicsCiAgICAgICAgJzwvZGl2PicKICAgICksCiAgICAKICAgIAogICAgaGVhZGVyVHBsOiBuZXcgRXh0LlRlbXBsYXRlKAogICAgICAgICc8dGFibGUgYm9yZGVyPSIwIiBjZWxsc3BhY2luZz0iMCIgY2VsbHBhZGRpbmc9IjAiIHN0eWxlPSJ7dHN0eWxlfSI+JywKICAgICAgICAgICAgJzx0aGVhZD4nLAogICAgICAgICAgICAgICAgJzx0ciBjbGFzcz0ieC1ncmlkMy1oZC1yb3ciPntjZWxsc308L3RyPicsCiAgICAgICAgICAgICc8L3RoZWFkPicsCiAgICAgICAgJzwvdGFibGU+JwogICAgKSwKICAgIAogICAgCiAgICBib2R5VHBsOiBuZXcgRXh0LlRlbXBsYXRlKCd7cm93c30nKSwKICAgIAogICAgCiAgICBjZWxsVHBsOiBuZXcgRXh0LlRlbXBsYXRlKAogICAgICAgICc8dGQgY2xhc3M9IngtZ3JpZDMtY29sIHgtZ3JpZDMtY2VsbCB4LWdyaWQzLXRkLXtpZH0ge2Nzc30iIHN0eWxlPSJ7c3R5bGV9IiB0YWJJbmRleD0iMCIge2NlbGxBdHRyfT4nLAogICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1jZWxsLWlubmVyIHgtZ3JpZDMtY29sLXtpZH0iIHVuc2VsZWN0YWJsZT0ib24iIHthdHRyfT57dmFsdWV9PC9kaXY+JywKICAgICAgICAnPC90ZD4nCiAgICApLAogICAgCiAgICAKICAgIGluaXRUZW1wbGF0ZXMgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdGVtcGxhdGVzID0gdGhpcy50ZW1wbGF0ZXMgfHwge30sCiAgICAgICAgICAgIHRlbXBsYXRlLCBuYW1lLAogICAgICAgICAgICAKICAgICAgICAgICAgaGVhZGVyQ2VsbFRwbCA9IG5ldyBFeHQuVGVtcGxhdGUoCiAgICAgICAgICAgICAgICAnPHRkIGNsYXNzPSJ4LWdyaWQzLWhkIHgtZ3JpZDMtY2VsbCB4LWdyaWQzLXRkLXtpZH0ge2Nzc30iIHN0eWxlPSJ7c3R5bGV9Ij4nLAogICAgICAgICAgICAgICAgICAgICc8ZGl2IHt0b29sdGlwfSB7YXR0cn0gY2xhc3M9IngtZ3JpZDMtaGQtaW5uZXIgeC1ncmlkMy1oZC17aWR9IiB1bnNlbGVjdGFibGU9Im9uIiBzdHlsZT0ie2lzdHlsZX0iPicsIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdyaWQuZW5hYmxlSGRNZW51ID8gJzxhIGNsYXNzPSJ4LWdyaWQzLWhkLWJ0biIgaHJlZj0iIyI+PC9hPicgOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3t2YWx1ZX0nLAogICAgICAgICAgICAgICAgICAgICAgICAnPGltZyBhbHQ9IiIgY2xhc3M9IngtZ3JpZDMtc29ydC1pY29uIiBzcmM9IicsIEV4dC5CTEFOS19JTUFHRV9VUkwsICciIC8+JywKICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JywKICAgICAgICAgICAgICAgICc8L3RkPicKICAgICAgICAgICAgKSwKICAgICAgICAKICAgICAgICAgICAgcm93Qm9keVRleHQgPSBbCiAgICAgICAgICAgICAgICAnPHRyIGNsYXNzPSJ4LWdyaWQzLXJvdy1ib2R5LXRyIiBzdHlsZT0ie2JvZHlTdHlsZX0iPicsCiAgICAgICAgICAgICAgICAgICAgJzx0ZCBjb2xzcGFuPSJ7Y29sc30iIGNsYXNzPSJ4LWdyaWQzLWJvZHktY2VsbCIgdGFiSW5kZXg9IjAiIGhpZGVmb2N1cz0ib24iPicsCiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWdyaWQzLXJvdy1ib2R5Ij57Ym9keX08L2Rpdj4nLAogICAgICAgICAgICAgICAgICAgICc8L3RkPicsCiAgICAgICAgICAgICAgICAnPC90cj4nCiAgICAgICAgICAgIF0uam9pbigiIiksCiAgICAgICAgCiAgICAgICAgICAgIGlubmVyVGV4dCA9IFsKICAgICAgICAgICAgICAgICc8dGFibGUgY2xhc3M9IngtZ3JpZDMtcm93LXRhYmxlIiBib3JkZXI9IjAiIGNlbGxzcGFjaW5nPSIwIiBjZWxscGFkZGluZz0iMCIgc3R5bGU9Int0c3R5bGV9Ij4nLAogICAgICAgICAgICAgICAgICAgICAnPHRib2R5PicsCiAgICAgICAgICAgICAgICAgICAgICAgICc8dHI+e2NlbGxzfTwvdHI+JywKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmFibGVSb3dCb2R5ID8gcm93Qm9keVRleHQgOiAnJywKICAgICAgICAgICAgICAgICAgICAgJzwvdGJvZHk+JywKICAgICAgICAgICAgICAgICc8L3RhYmxlPicKICAgICAgICAgICAgXS5qb2luKCIiKTsKICAgICAgICAKICAgICAgICBFeHQuYXBwbHlJZih0ZW1wbGF0ZXMsIHsKICAgICAgICAgICAgaGNlbGwgICA6IGhlYWRlckNlbGxUcGwsCiAgICAgICAgICAgIGNlbGwgICAgOiB0aGlzLmNlbGxUcGwsCiAgICAgICAgICAgIGJvZHkgICAgOiB0aGlzLmJvZHlUcGwsCiAgICAgICAgICAgIGhlYWRlciAgOiB0aGlzLmhlYWRlclRwbCwKICAgICAgICAgICAgbWFzdGVyICA6IHRoaXMubWFzdGVyVHBsLAogICAgICAgICAgICByb3cgICAgIDogbmV3IEV4dC5UZW1wbGF0ZSgnPGRpdiBjbGFzcz0ieC1ncmlkMy1yb3cge2FsdH0iIHN0eWxlPSJ7dHN0eWxlfSI+JyArIGlubmVyVGV4dCArICc8L2Rpdj4nKSwKICAgICAgICAgICAgcm93SW5uZXI6IG5ldyBFeHQuVGVtcGxhdGUoaW5uZXJUZXh0KQogICAgICAgIH0pOwoKICAgICAgICBmb3IgKG5hbWUgaW4gdGVtcGxhdGVzKSB7CiAgICAgICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGVzW25hbWVdOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRlbXBsYXRlICYmIEV4dC5pc0Z1bmN0aW9uKHRlbXBsYXRlLmNvbXBpbGUpICYmICF0ZW1wbGF0ZS5jb21waWxlZCkgewogICAgICAgICAgICAgICAgdGVtcGxhdGUuZGlzYWJsZUZvcm1hdHMgPSB0cnVlOwogICAgICAgICAgICAgICAgdGVtcGxhdGUuY29tcGlsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRlbXBsYXRlcyA9IHRlbXBsYXRlczsKICAgICAgICB0aGlzLmNvbFJlID0gbmV3IFJlZ0V4cCgneC1ncmlkMy10ZC0oW15cXHNdKyknLCAnJyk7CiAgICB9LAoKICAgIAogICAgZmx5IDogZnVuY3Rpb24oZWwpIHsKICAgICAgICBpZiAoIXRoaXMuX2ZseXdlaWdodCkgewogICAgICAgICAgICB0aGlzLl9mbHl3ZWlnaHQgPSBuZXcgRXh0LkVsZW1lbnQuRmx5d2VpZ2h0KGRvY3VtZW50LmJvZHkpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9mbHl3ZWlnaHQuZG9tID0gZWw7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZseXdlaWdodDsKICAgIH0sCgogICAgCiAgICBnZXRFZGl0b3JQYXJlbnQgOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxlci5kb207CiAgICB9LAoKICAgIAogICAgaW5pdEVsZW1lbnRzIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIEVsZW1lbnQgID0gRXh0LkVsZW1lbnQsCiAgICAgICAgICAgIGVsICAgICAgID0gRXh0LmdldCh0aGlzLmdyaWQuZ2V0R3JpZEVsKCkuZG9tLmZpcnN0Q2hpbGQpLAogICAgICAgICAgICBtYWluV3JhcCA9IG5ldyBFbGVtZW50KGVsLmNoaWxkKCdkaXYueC1ncmlkMy12aWV3cG9ydCcpKSwKICAgICAgICAgICAgbWFpbkhkICAgPSBuZXcgRWxlbWVudChtYWluV3JhcC5jaGlsZCgnZGl2LngtZ3JpZDMtaGVhZGVyJykpLAogICAgICAgICAgICBzY3JvbGxlciA9IG5ldyBFbGVtZW50KG1haW5XcmFwLmNoaWxkKCdkaXYueC1ncmlkMy1zY3JvbGxlcicpKTsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5ncmlkLmhpZGVIZWFkZXJzKSB7CiAgICAgICAgICAgIG1haW5IZC5zZXREaXNwbGF5ZWQoZmFsc2UpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAodGhpcy5mb3JjZUZpdCkgewogICAgICAgICAgICBzY3JvbGxlci5zZXRTdHlsZSgnb3ZlcmZsb3cteCcsICdoaWRkZW4nKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgRXh0LmFwcGx5KHRoaXMsIHsKICAgICAgICAgICAgZWwgICAgICA6IGVsLAogICAgICAgICAgICBtYWluV3JhcDogbWFpbldyYXAsCiAgICAgICAgICAgIHNjcm9sbGVyOiBzY3JvbGxlciwKICAgICAgICAgICAgbWFpbkhkICA6IG1haW5IZCwKICAgICAgICAgICAgaW5uZXJIZCA6IG1haW5IZC5jaGlsZCgnZGl2LngtZ3JpZDMtaGVhZGVyLWlubmVyJykuZG9tLAogICAgICAgICAgICBtYWluQm9keTogbmV3IEVsZW1lbnQoRWxlbWVudC5mbHkoc2Nyb2xsZXIpLmNoaWxkKCdkaXYueC1ncmlkMy1ib2R5JykpLAogICAgICAgICAgICBmb2N1c0VsIDogbmV3IEVsZW1lbnQoRWxlbWVudC5mbHkoc2Nyb2xsZXIpLmNoaWxkKCdhJykpLAogICAgICAgICAgICAKICAgICAgICAgICAgcmVzaXplTWFya2VyOiBuZXcgRWxlbWVudChlbC5jaGlsZCgnZGl2LngtZ3JpZDMtcmVzaXplLW1hcmtlcicpKSwKICAgICAgICAgICAgcmVzaXplUHJveHkgOiBuZXcgRWxlbWVudChlbC5jaGlsZCgnZGl2LngtZ3JpZDMtcmVzaXplLXByb3h5JykpCiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgdGhpcy5mb2N1c0VsLnN3YWxsb3dFdmVudCgnY2xpY2snLCB0cnVlKTsKICAgIH0sCgogICAgCiAgICBnZXRSb3dzIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaGFzUm93cygpID8gdGhpcy5tYWluQm9keS5kb20uY2hpbGROb2RlcyA6IFtdOwogICAgfSwKCiAgICAKCiAgICAKICAgIGZpbmRDZWxsIDogZnVuY3Rpb24oZWwpIHsKICAgICAgICBpZiAoIWVsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuZmx5KGVsKS5maW5kUGFyZW50KHRoaXMuY2VsbFNlbGVjdG9yLCB0aGlzLmNlbGxTZWxlY3RvckRlcHRoKTsKICAgIH0sCgogICAgCiAgICBmaW5kQ2VsbEluZGV4IDogZnVuY3Rpb24oZWwsIHJlcXVpcmVkQ2xzKSB7CiAgICAgICAgdmFyIGNlbGwgPSB0aGlzLmZpbmRDZWxsKGVsKSwKICAgICAgICAgICAgaGFzQ2xzOwogICAgICAgIAogICAgICAgIGlmIChjZWxsKSB7CiAgICAgICAgICAgIGhhc0NscyA9IHRoaXMuZmx5KGNlbGwpLmhhc0NsYXNzKHJlcXVpcmVkQ2xzKTsKICAgICAgICAgICAgaWYgKCFyZXF1aXJlZENscyB8fCBoYXNDbHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENlbGxJbmRleChjZWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIAogICAgZ2V0Q2VsbEluZGV4IDogZnVuY3Rpb24oZWwpIHsKICAgICAgICBpZiAoZWwpIHsKICAgICAgICAgICAgdmFyIG1hdGNoID0gZWwuY2xhc3NOYW1lLm1hdGNoKHRoaXMuY29sUmUpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKG1hdGNoICYmIG1hdGNoWzFdKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jbS5nZXRJbmRleEJ5SWQobWF0Y2hbMV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgCiAgICBmaW5kSGVhZGVyQ2VsbCA6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgdmFyIGNlbGwgPSB0aGlzLmZpbmRDZWxsKGVsKTsKICAgICAgICByZXR1cm4gY2VsbCAmJiB0aGlzLmZseShjZWxsKS5oYXNDbGFzcyh0aGlzLmhkQ2xzKSA/IGNlbGwgOiBudWxsOwogICAgfSwKCiAgICAKICAgIGZpbmRIZWFkZXJJbmRleCA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICByZXR1cm4gdGhpcy5maW5kQ2VsbEluZGV4KGVsLCB0aGlzLmhkQ2xzKTsKICAgIH0sCgogICAgCiAgICBmaW5kUm93IDogZnVuY3Rpb24oZWwpIHsKICAgICAgICBpZiAoIWVsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuZmx5KGVsKS5maW5kUGFyZW50KHRoaXMucm93U2VsZWN0b3IsIHRoaXMucm93U2VsZWN0b3JEZXB0aCk7CiAgICB9LAoKICAgIAogICAgZmluZFJvd0luZGV4IDogZnVuY3Rpb24oZWwpIHsKICAgICAgICB2YXIgcm93ID0gdGhpcy5maW5kUm93KGVsKTsKICAgICAgICByZXR1cm4gcm93ID8gcm93LnJvd0luZGV4IDogZmFsc2U7CiAgICB9LAoKICAgIAogICAgZmluZFJvd0JvZHkgOiBmdW5jdGlvbihlbCkgewogICAgICAgIGlmICghZWwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gdGhpcy5mbHkoZWwpLmZpbmRQYXJlbnQodGhpcy5yb3dCb2R5U2VsZWN0b3IsIHRoaXMucm93Qm9keVNlbGVjdG9yRGVwdGgpOwogICAgfSwKCiAgICAKCiAgICAKICAgIGdldFJvdyA6IGZ1bmN0aW9uKHJvdykgewogICAgICAgIHJldHVybiB0aGlzLmdldFJvd3MoKVtyb3ddOwogICAgfSwKCiAgICAKICAgIGdldENlbGwgOiBmdW5jdGlvbihyb3csIGNvbCkgewogICAgICAgIHJldHVybiBFeHQuZmx5KHRoaXMuZ2V0Um93KHJvdykpLnF1ZXJ5KHRoaXMuY2VsbFNlbGVjdG9yKVtjb2xdOyAKICAgIH0sCgogICAgCiAgICBnZXRIZWFkZXJDZWxsIDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICByZXR1cm4gdGhpcy5tYWluSGQuZG9tLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0ZCcpW2luZGV4XTsKICAgIH0sCgogICAgCgogICAgCiAgICBhZGRSb3dDbGFzcyA6IGZ1bmN0aW9uKHJvd0lkLCBjbHMpIHsKICAgICAgICB2YXIgcm93ID0gdGhpcy5nZXRSb3cocm93SWQpOwogICAgICAgIGlmIChyb3cpIHsKICAgICAgICAgICAgdGhpcy5mbHkocm93KS5hZGRDbGFzcyhjbHMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZW1vdmVSb3dDbGFzcyA6IGZ1bmN0aW9uKHJvdywgY2xzKSB7CiAgICAgICAgdmFyIHIgPSB0aGlzLmdldFJvdyhyb3cpOwogICAgICAgIGlmKHIpewogICAgICAgICAgICB0aGlzLmZseShyKS5yZW1vdmVDbGFzcyhjbHMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZW1vdmVSb3cgOiBmdW5jdGlvbihyb3cpIHsKICAgICAgICBFeHQucmVtb3ZlTm9kZSh0aGlzLmdldFJvdyhyb3cpKTsKICAgICAgICB0aGlzLnN5bmNGb2N1c0VsKHJvdyk7CiAgICB9LAoKICAgIAogICAgcmVtb3ZlUm93cyA6IGZ1bmN0aW9uKGZpcnN0Um93LCBsYXN0Um93KSB7CiAgICAgICAgdmFyIGJkID0gdGhpcy5tYWluQm9keS5kb20sCiAgICAgICAgICAgIHJvd0luZGV4OwogICAgICAgICAgICAKICAgICAgICBmb3IgKHJvd0luZGV4ID0gZmlyc3RSb3c7IHJvd0luZGV4IDw9IGxhc3RSb3c7IHJvd0luZGV4KyspewogICAgICAgICAgICBFeHQucmVtb3ZlTm9kZShiZC5jaGlsZE5vZGVzW2ZpcnN0Um93XSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMuc3luY0ZvY3VzRWwoZmlyc3RSb3cpOwogICAgfSwKCiAgICAKICAgIAogICAgCiAgICBnZXRTY3JvbGxTdGF0ZSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzYiA9IHRoaXMuc2Nyb2xsZXIuZG9tOwogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGxlZnQ6IHNiLnNjcm9sbExlZnQsIAogICAgICAgICAgICB0b3AgOiBzYi5zY3JvbGxUb3AKICAgICAgICB9OwogICAgfSwKCiAgICAKICAgIHJlc3RvcmVTY3JvbGwgOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIHZhciBzYiA9IHRoaXMuc2Nyb2xsZXIuZG9tOwogICAgICAgIHNiLnNjcm9sbExlZnQgPSBzdGF0ZS5sZWZ0OwogICAgICAgIHNiLnNjcm9sbFRvcCAgPSBzdGF0ZS50b3A7CiAgICB9LAoKICAgIAogICAgc2Nyb2xsVG9Ub3AgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZG9tID0gdGhpcy5zY3JvbGxlci5kb207CiAgICAgICAgCiAgICAgICAgZG9tLnNjcm9sbFRvcCAgPSAwOwogICAgICAgIGRvbS5zY3JvbGxMZWZ0ID0gMDsKICAgIH0sCgogICAgCiAgICBzeW5jU2Nyb2xsIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zeW5jSGVhZGVyU2Nyb2xsKCk7CiAgICAgICAgdmFyIG1iID0gdGhpcy5zY3JvbGxlci5kb207CiAgICAgICAgdGhpcy5ncmlkLmZpcmVFdmVudCgnYm9keXNjcm9sbCcsIG1iLnNjcm9sbExlZnQsIG1iLnNjcm9sbFRvcCk7CiAgICB9LAoKICAgIAogICAgc3luY0hlYWRlclNjcm9sbCA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpbm5lckhkICAgID0gdGhpcy5pbm5lckhkLAogICAgICAgICAgICBzY3JvbGxMZWZ0ID0gdGhpcy5zY3JvbGxlci5kb20uc2Nyb2xsTGVmdDsKICAgICAgICAKICAgICAgICBpbm5lckhkLnNjcm9sbExlZnQgPSBzY3JvbGxMZWZ0OwogICAgICAgIGlubmVySGQuc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnQ7IAogICAgfSwKICAgIAogICAgCiAgICB1cGRhdGVTb3J0SWNvbiA6IGZ1bmN0aW9uKGNvbCwgZGlyKSB7CiAgICAgICAgdmFyIHNvcnRDbGFzc2VzID0gdGhpcy5zb3J0Q2xhc3NlcywKICAgICAgICAgICAgc29ydENsYXNzICAgPSBzb3J0Q2xhc3Nlc1tkaXIgPT0gIkRFU0MiID8gMSA6IDBdLAogICAgICAgICAgICBoZWFkZXJzICAgICA9IHRoaXMubWFpbkhkLnNlbGVjdCgndGQnKS5yZW1vdmVDbGFzcyhzb3J0Q2xhc3Nlcyk7CiAgICAgICAgCiAgICAgICAgaGVhZGVycy5pdGVtKGNvbCkuYWRkQ2xhc3Moc29ydENsYXNzKTsKICAgIH0sCgogICAgCiAgICB1cGRhdGVBbGxDb2x1bW5XaWR0aHMgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdG90YWxXaWR0aCA9IHRoaXMuZ2V0VG90YWxXaWR0aCgpLAogICAgICAgICAgICBjb2xDb3VudCAgID0gdGhpcy5jbS5nZXRDb2x1bW5Db3VudCgpLAogICAgICAgICAgICByb3dzICAgICAgID0gdGhpcy5nZXRSb3dzKCksCiAgICAgICAgICAgIHJvd0NvdW50ICAgPSByb3dzLmxlbmd0aCwKICAgICAgICAgICAgd2lkdGhzICAgICA9IFtdLAogICAgICAgICAgICByb3csIHJvd0ZpcnN0Q2hpbGQsIHRyb3csIGksIGo7CiAgICAgICAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbENvdW50OyBpKyspIHsKICAgICAgICAgICAgd2lkdGhzW2ldID0gdGhpcy5nZXRDb2x1bW5XaWR0aChpKTsKICAgICAgICAgICAgdGhpcy5nZXRIZWFkZXJDZWxsKGkpLnN0eWxlLndpZHRoID0gd2lkdGhzW2ldOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLnVwZGF0ZUhlYWRlcldpZHRoKCk7CiAgICAgICAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHJvd0NvdW50OyBpKyspIHsKICAgICAgICAgICAgcm93ID0gcm93c1tpXTsKICAgICAgICAgICAgcm93LnN0eWxlLndpZHRoID0gdG90YWxXaWR0aDsKICAgICAgICAgICAgcm93Rmlyc3RDaGlsZCA9IHJvdy5maXJzdENoaWxkOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHJvd0ZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIHJvd0ZpcnN0Q2hpbGQuc3R5bGUud2lkdGggPSB0b3RhbFdpZHRoOwogICAgICAgICAgICAgICAgdHJvdyA9IHJvd0ZpcnN0Q2hpbGQucm93c1swXTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGNvbENvdW50OyBqKyspIHsKICAgICAgICAgICAgICAgICAgICB0cm93LmNoaWxkTm9kZXNbal0uc3R5bGUud2lkdGggPSB3aWR0aHNbal07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5vbkFsbENvbHVtbldpZHRoc1VwZGF0ZWQod2lkdGhzLCB0b3RhbFdpZHRoKTsKICAgIH0sCgogICAgCiAgICB1cGRhdGVDb2x1bW5XaWR0aCA6IGZ1bmN0aW9uKGNvbHVtbiwgd2lkdGgpIHsKICAgICAgICB2YXIgY29sdW1uV2lkdGggPSB0aGlzLmdldENvbHVtbldpZHRoKGNvbHVtbiksCiAgICAgICAgICAgIHRvdGFsV2lkdGggID0gdGhpcy5nZXRUb3RhbFdpZHRoKCksCiAgICAgICAgICAgIGhlYWRlckNlbGwgID0gdGhpcy5nZXRIZWFkZXJDZWxsKGNvbHVtbiksCiAgICAgICAgICAgIG5vZGVzICAgICAgID0gdGhpcy5nZXRSb3dzKCksCiAgICAgICAgICAgIG5vZGVDb3VudCAgID0gbm9kZXMubGVuZ3RoLAogICAgICAgICAgICByb3csIGksIGZpcnN0Q2hpbGQ7CiAgICAgICAgCiAgICAgICAgdGhpcy51cGRhdGVIZWFkZXJXaWR0aCgpOwogICAgICAgIGhlYWRlckNlbGwuc3R5bGUud2lkdGggPSBjb2x1bW5XaWR0aDsKICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZUNvdW50OyBpKyspIHsKICAgICAgICAgICAgcm93ID0gbm9kZXNbaV07CiAgICAgICAgICAgIGZpcnN0Q2hpbGQgPSByb3cuZmlyc3RDaGlsZDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJvdy5zdHlsZS53aWR0aCA9IHRvdGFsV2lkdGg7CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBmaXJzdENoaWxkLnN0eWxlLndpZHRoID0gdG90YWxXaWR0aDsKICAgICAgICAgICAgICAgIGZpcnN0Q2hpbGQucm93c1swXS5jaGlsZE5vZGVzW2NvbHVtbl0uc3R5bGUud2lkdGggPSBjb2x1bW5XaWR0aDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLm9uQ29sdW1uV2lkdGhVcGRhdGVkKGNvbHVtbiwgY29sdW1uV2lkdGgsIHRvdGFsV2lkdGgpOwogICAgfSwKICAgIAogICAgCiAgICB1cGRhdGVDb2x1bW5IaWRkZW4gOiBmdW5jdGlvbihjb2wsIGhpZGRlbikgewogICAgICAgIHZhciB0b3RhbFdpZHRoID0gdGhpcy5nZXRUb3RhbFdpZHRoKCksCiAgICAgICAgICAgIGRpc3BsYXkgICAgPSBoaWRkZW4gPyAnbm9uZScgOiAnJywKICAgICAgICAgICAgaGVhZGVyQ2VsbCA9IHRoaXMuZ2V0SGVhZGVyQ2VsbChjb2wpLAogICAgICAgICAgICBub2RlcyAgICAgID0gdGhpcy5nZXRSb3dzKCksCiAgICAgICAgICAgIG5vZGVDb3VudCAgPSBub2Rlcy5sZW5ndGgsCiAgICAgICAgICAgIHJvdywgcm93Rmlyc3RDaGlsZCwgaTsKICAgICAgICAKICAgICAgICB0aGlzLnVwZGF0ZUhlYWRlcldpZHRoKCk7CiAgICAgICAgaGVhZGVyQ2VsbC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZUNvdW50OyBpKyspIHsKICAgICAgICAgICAgcm93ID0gbm9kZXNbaV07CiAgICAgICAgICAgIHJvdy5zdHlsZS53aWR0aCA9IHRvdGFsV2lkdGg7CiAgICAgICAgICAgIHJvd0ZpcnN0Q2hpbGQgPSByb3cuZmlyc3RDaGlsZDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChyb3dGaXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICByb3dGaXJzdENoaWxkLnN0eWxlLndpZHRoID0gdG90YWxXaWR0aDsKICAgICAgICAgICAgICAgIHJvd0ZpcnN0Q2hpbGQucm93c1swXS5jaGlsZE5vZGVzW2NvbF0uc3R5bGUuZGlzcGxheSA9IGRpc3BsYXk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5vbkNvbHVtbkhpZGRlblVwZGF0ZWQoY29sLCBoaWRkZW4sIHRvdGFsV2lkdGgpOwogICAgICAgIGRlbGV0ZSB0aGlzLmxhc3RWaWV3V2lkdGg7IAogICAgICAgIHRoaXMubGF5b3V0KCk7CiAgICB9LAoKICAgIAogICAgZG9SZW5kZXIgOiBmdW5jdGlvbihjb2x1bW5zLCByZWNvcmRzLCBzdG9yZSwgc3RhcnRSb3csIGNvbENvdW50LCBzdHJpcGUpIHsKICAgICAgICB2YXIgdGVtcGxhdGVzID0gdGhpcy50ZW1wbGF0ZXMsCiAgICAgICAgICAgIGNlbGxUZW1wbGF0ZSA9IHRlbXBsYXRlcy5jZWxsLAogICAgICAgICAgICByb3dUZW1wbGF0ZSA9IHRlbXBsYXRlcy5yb3csCiAgICAgICAgICAgIGxhc3QgPSBjb2xDb3VudCAtIDEsCiAgICAgICAgICAgIHRzdHlsZSA9ICd3aWR0aDonICsgdGhpcy5nZXRUb3RhbFdpZHRoKCkgKyAnOycsCiAgICAgICAgICAgIAogICAgICAgICAgICByb3dCdWZmZXIgPSBbXSwKICAgICAgICAgICAgY29sQnVmZmVyID0gW10sCiAgICAgICAgICAgIHJvd1BhcmFtcyA9IHt0c3R5bGU6IHRzdHlsZX0sCiAgICAgICAgICAgIG1ldGEgPSB7fSwKICAgICAgICAgICAgbGVuICA9IHJlY29yZHMubGVuZ3RoLAogICAgICAgICAgICBhbHQsCiAgICAgICAgICAgIGNvbHVtbiwKICAgICAgICAgICAgcmVjb3JkLCBpLCBqLCByb3dJbmRleDsKCiAgICAgICAgCiAgICAgICAgZm9yIChqID0gMDsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgIHJlY29yZCAgICA9IHJlY29yZHNbal07CiAgICAgICAgICAgIGNvbEJ1ZmZlciA9IFtdOwoKICAgICAgICAgICAgcm93SW5kZXggPSBqICsgc3RhcnRSb3c7CgogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGNvbHVtbiA9IGNvbHVtbnNbaV07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIG1ldGEuaWQgICAgPSBjb2x1bW4uaWQ7CiAgICAgICAgICAgICAgICBtZXRhLmNzcyAgID0gaSA9PT0gMCA/ICd4LWdyaWQzLWNlbGwtZmlyc3QgJyA6IChpID09IGxhc3QgPyAneC1ncmlkMy1jZWxsLWxhc3QgJyA6ICcnKTsKICAgICAgICAgICAgICAgIG1ldGEuYXR0ciAgPSBtZXRhLmNlbGxBdHRyID0gJyc7CiAgICAgICAgICAgICAgICBtZXRhLnN0eWxlID0gY29sdW1uLnN0eWxlOwogICAgICAgICAgICAgICAgbWV0YS52YWx1ZSA9IGNvbHVtbi5yZW5kZXJlci5jYWxsKGNvbHVtbi5zY29wZSwgcmVjb3JkLmRhdGFbY29sdW1uLm5hbWVdLCBtZXRhLCByZWNvcmQsIHJvd0luZGV4LCBpLCBzdG9yZSk7CgogICAgICAgICAgICAgICAgaWYgKEV4dC5pc0VtcHR5KG1ldGEudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbWV0YS52YWx1ZSA9ICcmIzE2MDsnOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm1hcmtEaXJ0eSAmJiByZWNvcmQuZGlydHkgJiYgdHlwZW9mIHJlY29yZC5tb2RpZmllZFtjb2x1bW4ubmFtZV0gIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICBtZXRhLmNzcyArPSAnIHgtZ3JpZDMtZGlydHktY2VsbCc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29sQnVmZmVyW2NvbEJ1ZmZlci5sZW5ndGhdID0gY2VsbFRlbXBsYXRlLmFwcGx5KG1ldGEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhbHQgPSBbXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChzdHJpcGUgJiYgKChyb3dJbmRleCArIDEpICUgMiA9PT0gMCkpIHsKICAgICAgICAgICAgICAgIGFsdFswXSA9ICd4LWdyaWQzLXJvdy1hbHQnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocmVjb3JkLmRpcnR5KSB7CiAgICAgICAgICAgICAgICBhbHRbMV0gPSAnIHgtZ3JpZDMtZGlydHktcm93JzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcm93UGFyYW1zLmNvbHMgPSBjb2xDb3VudDsKCiAgICAgICAgICAgIGlmICh0aGlzLmdldFJvd0NsYXNzKSB7CiAgICAgICAgICAgICAgICBhbHRbMl0gPSB0aGlzLmdldFJvd0NsYXNzKHJlY29yZCwgcm93SW5kZXgsIHJvd1BhcmFtcywgc3RvcmUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByb3dQYXJhbXMuYWx0ICAgPSBhbHQuam9pbignICcpOwogICAgICAgICAgICByb3dQYXJhbXMuY2VsbHMgPSBjb2xCdWZmZXIuam9pbignJyk7CgogICAgICAgICAgICByb3dCdWZmZXJbcm93QnVmZmVyLmxlbmd0aF0gPSByb3dUZW1wbGF0ZS5hcHBseShyb3dQYXJhbXMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJvd0J1ZmZlci5qb2luKCcnKTsKICAgIH0sCgogICAgCiAgICBwcm9jZXNzUm93cyA6IGZ1bmN0aW9uKHN0YXJ0Um93LCBza2lwU3RyaXBlKSB7CiAgICAgICAgaWYgKCF0aGlzLmRzIHx8IHRoaXMuZHMuZ2V0Q291bnQoKSA8IDEpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJvd3MgICA9IHRoaXMuZ2V0Um93cygpLAogICAgICAgICAgICBsZW5ndGggPSByb3dzLmxlbmd0aCwKICAgICAgICAgICAgcm93LCBpOwoKICAgICAgICBza2lwU3RyaXBlID0gc2tpcFN0cmlwZSB8fCAhdGhpcy5ncmlkLnN0cmlwZVJvd3M7CiAgICAgICAgc3RhcnRSb3cgICA9IHN0YXJ0Um93ICAgfHwgMDsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHJvdyA9IHJvd3NbaV07CiAgICAgICAgICAgIGlmIChyb3cpIHsKICAgICAgICAgICAgICAgIHJvdy5yb3dJbmRleCA9IGk7CiAgICAgICAgICAgICAgICBpZiAoIXNraXBTdHJpcGUpIHsKICAgICAgICAgICAgICAgICAgICByb3cuY2xhc3NOYW1lID0gcm93LmNsYXNzTmFtZS5yZXBsYWNlKHRoaXMucm93Q2xzUmUsICcgJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKChpICsgMSkgJSAyID09PSAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgcm93LmNsYXNzTmFtZSArPSAnIHgtZ3JpZDMtcm93LWFsdCc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAKICAgICAgICBpZiAoc3RhcnRSb3cgPT09IDApIHsKICAgICAgICAgICAgRXh0LmZseShyb3dzWzBdKS5hZGRDbGFzcyh0aGlzLmZpcnN0Um93Q2xzKTsKICAgICAgICB9CgogICAgICAgIEV4dC5mbHkocm93c1tsZW5ndGggLSAxXSkuYWRkQ2xhc3ModGhpcy5sYXN0Um93Q2xzKTsKICAgIH0sCiAgICAKICAgIAogICAgYWZ0ZXJSZW5kZXIgOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuZHMgfHwgIXRoaXMuY20pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLm1haW5Cb2R5LmRvbS5pbm5lckhUTUwgPSB0aGlzLnJlbmRlckJvZHkoKSB8fCAnJiMxNjA7JzsKICAgICAgICB0aGlzLnByb2Nlc3NSb3dzKDAsIHRydWUpOwoKICAgICAgICBpZiAodGhpcy5kZWZlckVtcHR5VGV4dCAhPT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLmFwcGx5RW1wdHlUZXh0KCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMuZ3JpZC5maXJlRXZlbnQoJ3ZpZXdyZWFkeScsIHRoaXMuZ3JpZCk7CiAgICB9LAogICAgCiAgICAKICAgIGFmdGVyUmVuZGVyVUk6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBncmlkID0gdGhpcy5ncmlkOwogICAgICAgIAogICAgICAgIHRoaXMuaW5pdEVsZW1lbnRzKCk7CgogICAgICAgIAogICAgICAgIEV4dC5mbHkodGhpcy5pbm5lckhkKS5vbignY2xpY2snLCB0aGlzLmhhbmRsZUhkRG93biwgdGhpcyk7CgogICAgICAgIHRoaXMubWFpbkhkLm9uKHsKICAgICAgICAgICAgc2NvcGUgICAgOiB0aGlzLAogICAgICAgICAgICBtb3VzZW92ZXI6IHRoaXMuaGFuZGxlSGRPdmVyLAogICAgICAgICAgICBtb3VzZW91dCA6IHRoaXMuaGFuZGxlSGRPdXQsCiAgICAgICAgICAgIG1vdXNlbW92ZTogdGhpcy5oYW5kbGVIZE1vdmUKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5zY3JvbGxlci5vbignc2Nyb2xsJywgdGhpcy5zeW5jU2Nyb2xsLCAgdGhpcyk7CiAgICAgICAgCiAgICAgICAgaWYgKGdyaWQuZW5hYmxlQ29sdW1uUmVzaXplICE9PSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLnNwbGl0Wm9uZSA9IG5ldyBFeHQuZ3JpZC5HcmlkVmlldy5TcGxpdERyYWdab25lKGdyaWQsIHRoaXMubWFpbkhkLmRvbSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZ3JpZC5lbmFibGVDb2x1bW5Nb3ZlKSB7CiAgICAgICAgICAgIHRoaXMuY29sdW1uRHJhZyA9IG5ldyBFeHQuZ3JpZC5HcmlkVmlldy5Db2x1bW5EcmFnWm9uZShncmlkLCB0aGlzLmlubmVySGQpOwogICAgICAgICAgICB0aGlzLmNvbHVtbkRyb3AgPSBuZXcgRXh0LmdyaWQuSGVhZGVyRHJvcFpvbmUoZ3JpZCwgdGhpcy5tYWluSGQuZG9tKTsKICAgICAgICB9CgogICAgICAgIGlmIChncmlkLmVuYWJsZUhkTWVudSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy5obWVudSA9IG5ldyBFeHQubWVudS5NZW51KHtpZDogZ3JpZC5pZCArICctaGN0eCd9KTsKICAgICAgICAgICAgdGhpcy5obWVudS5hZGQoCiAgICAgICAgICAgICAgICB7aXRlbUlkOidhc2MnLCAgdGV4dDogdGhpcy5zb3J0QXNjVGV4dCwgIGNsczogJ3hnLWhtZW51LXNvcnQtYXNjJ30sCiAgICAgICAgICAgICAgICB7aXRlbUlkOidkZXNjJywgdGV4dDogdGhpcy5zb3J0RGVzY1RleHQsIGNsczogJ3hnLWhtZW51LXNvcnQtZGVzYyd9CiAgICAgICAgICAgICk7CgogICAgICAgICAgICBpZiAoZ3JpZC5lbmFibGVDb2x1bW5IaWRlICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgdGhpcy5jb2xNZW51ID0gbmV3IEV4dC5tZW51Lk1lbnUoe2lkOmdyaWQuaWQgKyAnLWhjb2xzLW1lbnUnfSk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbE1lbnUub24oewogICAgICAgICAgICAgICAgICAgIHNjb3BlICAgICA6IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgYmVmb3Jlc2hvdzogdGhpcy5iZWZvcmVDb2xNZW51U2hvdywKICAgICAgICAgICAgICAgICAgICBpdGVtY2xpY2sgOiB0aGlzLmhhbmRsZUhkTWVudUNsaWNrCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMuaG1lbnUuYWRkKCctJywgewogICAgICAgICAgICAgICAgICAgIGl0ZW1JZDonY29sdW1ucycsCiAgICAgICAgICAgICAgICAgICAgaGlkZU9uQ2xpY2s6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMuY29sdW1uc1RleHQsCiAgICAgICAgICAgICAgICAgICAgbWVudTogdGhpcy5jb2xNZW51LAogICAgICAgICAgICAgICAgICAgIGljb25DbHM6ICd4LWNvbHMtaWNvbicKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmhtZW51Lm9uKCdpdGVtY2xpY2snLCB0aGlzLmhhbmRsZUhkTWVudUNsaWNrLCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIGlmIChncmlkLnRyYWNrTW91c2VPdmVyKSB7CiAgICAgICAgICAgIHRoaXMubWFpbkJvZHkub24oewogICAgICAgICAgICAgICAgc2NvcGUgICAgOiB0aGlzLAogICAgICAgICAgICAgICAgbW91c2VvdmVyOiB0aGlzLm9uUm93T3ZlciwKICAgICAgICAgICAgICAgIG1vdXNlb3V0IDogdGhpcy5vblJvd091dAogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmIChncmlkLmVuYWJsZURyYWdEcm9wIHx8IGdyaWQuZW5hYmxlRHJhZykgewogICAgICAgICAgICB0aGlzLmRyYWdab25lID0gbmV3IEV4dC5ncmlkLkdyaWREcmFnWm9uZShncmlkLCB7CiAgICAgICAgICAgICAgICBkZEdyb3VwIDogZ3JpZC5kZEdyb3VwIHx8ICdHcmlkREQnCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdGhpcy51cGRhdGVIZWFkZXJTb3J0U3RhdGUoKTsKICAgIH0sCgogICAgCiAgICByZW5kZXJVSSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0ZW1wbGF0ZXMgPSB0aGlzLnRlbXBsYXRlczsKCiAgICAgICAgcmV0dXJuIHRlbXBsYXRlcy5tYXN0ZXIuYXBwbHkoewogICAgICAgICAgICBib2R5ICA6IHRlbXBsYXRlcy5ib2R5LmFwcGx5KHtyb3dzOicmIzE2MDsnfSksCiAgICAgICAgICAgIGhlYWRlcjogdGhpcy5yZW5kZXJIZWFkZXJzKCksCiAgICAgICAgICAgIG9zdHlsZTogJ3dpZHRoOicgKyB0aGlzLmdldE9mZnNldFdpZHRoKCkgKyAnOycsCiAgICAgICAgICAgIGJzdHlsZTogJ3dpZHRoOicgKyB0aGlzLmdldFRvdGFsV2lkdGgoKSAgKyAnOycKICAgICAgICB9KTsKICAgIH0sCgogICAgCiAgICBwcm9jZXNzRXZlbnQgOiBmdW5jdGlvbihuYW1lLCBlKSB7CiAgICAgICAgdmFyIHRhcmdldCA9IGUuZ2V0VGFyZ2V0KCksCiAgICAgICAgICAgIGdyaWQgICA9IHRoaXMuZ3JpZCwKICAgICAgICAgICAgaGVhZGVyID0gdGhpcy5maW5kSGVhZGVySW5kZXgodGFyZ2V0KSwKICAgICAgICAgICAgcm93LCBjZWxsLCBjb2wsIGJvZHk7CgogICAgICAgIGdyaWQuZmlyZUV2ZW50KG5hbWUsIGUpOwoKICAgICAgICBpZiAoaGVhZGVyICE9PSBmYWxzZSkgewogICAgICAgICAgICBncmlkLmZpcmVFdmVudCgnaGVhZGVyJyArIG5hbWUsIGdyaWQsIGhlYWRlciwgZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm93ID0gdGhpcy5maW5kUm93SW5kZXgodGFyZ2V0KTsKCgoKCiAgICAgICAgICAgIGlmIChyb3cgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBjZWxsID0gdGhpcy5maW5kQ2VsbEluZGV4KHRhcmdldCk7CiAgICAgICAgICAgICAgICBpZiAoY2VsbCAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBjb2wgPSBncmlkLmNvbE1vZGVsLmdldENvbHVtbkF0KGNlbGwpOwogICAgICAgICAgICAgICAgICAgIGlmIChncmlkLmZpcmVFdmVudCgnY2VsbCcgKyBuYW1lLCBncmlkLCByb3csIGNlbGwsIGUpICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbCB8fCAoY29sLnByb2Nlc3NFdmVudCAmJiAoY29sLnByb2Nlc3NFdmVudChuYW1lLCBlLCBncmlkLCByb3csIGNlbGwpICE9PSBmYWxzZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmlkLmZpcmVFdmVudCgncm93JyArIG5hbWUsIGdyaWQsIHJvdywgZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChncmlkLmZpcmVFdmVudCgncm93JyArIG5hbWUsIGdyaWQsIHJvdywgZSkgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIChib2R5ID0gdGhpcy5maW5kUm93Qm9keSh0YXJnZXQpKSAmJiBncmlkLmZpcmVFdmVudCgncm93Ym9keScgKyBuYW1lLCBncmlkLCByb3csIGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGdyaWQuZmlyZUV2ZW50KCdjb250YWluZXInICsgbmFtZSwgZ3JpZCwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgbGF5b3V0IDogZnVuY3Rpb24oaW5pdGlhbCkgewogICAgICAgIGlmICghdGhpcy5tYWluQm9keSkgewogICAgICAgICAgICByZXR1cm47IAogICAgICAgIH0KCiAgICAgICAgdmFyIGdyaWQgICAgICAgPSB0aGlzLmdyaWQsCiAgICAgICAgICAgIGdyaWRFbCAgICAgPSBncmlkLmdldEdyaWRFbCgpLAogICAgICAgICAgICBncmlkU2l6ZSAgID0gZ3JpZEVsLmdldFNpemUodHJ1ZSksCiAgICAgICAgICAgIGdyaWRXaWR0aCAgPSBncmlkU2l6ZS53aWR0aCwKICAgICAgICAgICAgZ3JpZEhlaWdodCA9IGdyaWRTaXplLmhlaWdodCwKICAgICAgICAgICAgc2Nyb2xsZXIgICA9IHRoaXMuc2Nyb2xsZXIsCiAgICAgICAgICAgIHNjcm9sbFN0eWxlLCBoZWFkZXJIZWlnaHQsIHNjcm9sbEhlaWdodDsKICAgICAgICAKICAgICAgICBpZiAoZ3JpZFdpZHRoIDwgMjAgfHwgZ3JpZEhlaWdodCA8IDIwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGdyaWQuYXV0b0hlaWdodCkgewogICAgICAgICAgICBzY3JvbGxTdHlsZSA9IHNjcm9sbGVyLmRvbS5zdHlsZTsKICAgICAgICAgICAgc2Nyb2xsU3R5bGUub3ZlcmZsb3cgPSAndmlzaWJsZSc7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRXh0LmlzV2ViS2l0KSB7CiAgICAgICAgICAgICAgICBzY3JvbGxTdHlsZS5wb3NpdGlvbiA9ICdzdGF0aWMnOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5lbC5zZXRTaXplKGdyaWRXaWR0aCwgZ3JpZEhlaWdodCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBoZWFkZXJIZWlnaHQgPSB0aGlzLm1haW5IZC5nZXRIZWlnaHQoKTsKICAgICAgICAgICAgc2Nyb2xsSGVpZ2h0ID0gZ3JpZEhlaWdodCAtIGhlYWRlckhlaWdodDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHNjcm9sbGVyLnNldFNpemUoZ3JpZFdpZHRoLCBzY3JvbGxIZWlnaHQpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuaW5uZXJIZCkgewogICAgICAgICAgICAgICAgdGhpcy5pbm5lckhkLnN0eWxlLndpZHRoID0gKGdyaWRXaWR0aCkgKyAicHgiOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLmZvcmNlRml0IHx8IChpbml0aWFsID09PSB0cnVlICYmIHRoaXMuYXV0b0ZpbGwpKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmxhc3RWaWV3V2lkdGggIT0gZ3JpZFdpZHRoKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZpdENvbHVtbnMoZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdFZpZXdXaWR0aCA9IGdyaWRXaWR0aDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuYXV0b0V4cGFuZCgpOwogICAgICAgICAgICB0aGlzLnN5bmNIZWFkZXJTY3JvbGwoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5vbkxheW91dChncmlkV2lkdGgsIHNjcm9sbEhlaWdodCk7CiAgICB9LAoKICAgIAogICAgCiAgICBvbkxheW91dCA6IGZ1bmN0aW9uKHZ3LCB2aCkgewogICAgICAgIAogICAgfSwKCiAgICBvbkNvbHVtbldpZHRoVXBkYXRlZCA6IGZ1bmN0aW9uKGNvbCwgdywgdHcpIHsKICAgICAgICAKICAgIH0sCgogICAgb25BbGxDb2x1bW5XaWR0aHNVcGRhdGVkIDogZnVuY3Rpb24od3MsIHR3KSB7CiAgICAgICAgCiAgICB9LAoKICAgIG9uQ29sdW1uSGlkZGVuVXBkYXRlZCA6IGZ1bmN0aW9uKGNvbCwgaGlkZGVuLCB0dykgewogICAgICAgIAogICAgfSwKCiAgICB1cGRhdGVDb2x1bW5UZXh0IDogZnVuY3Rpb24oY29sLCB0ZXh0KSB7CiAgICAgICAgCiAgICB9LAoKICAgIGFmdGVyTW92ZSA6IGZ1bmN0aW9uKGNvbEluZGV4KSB7CiAgICAgICAgCiAgICB9LAoKICAgIAogICAgCiAgICBpbml0IDogZnVuY3Rpb24oZ3JpZCkgewogICAgICAgIHRoaXMuZ3JpZCA9IGdyaWQ7CgogICAgICAgIHRoaXMuaW5pdFRlbXBsYXRlcygpOwogICAgICAgIHRoaXMuaW5pdERhdGEoZ3JpZC5zdG9yZSwgZ3JpZC5jb2xNb2RlbCk7CiAgICAgICAgdGhpcy5pbml0VUkoZ3JpZCk7CiAgICB9LAoKICAgIAogICAgZ2V0Q29sdW1uSWQgOiBmdW5jdGlvbihpbmRleCl7CiAgICAgICAgcmV0dXJuIHRoaXMuY20uZ2V0Q29sdW1uSWQoaW5kZXgpOwogICAgfSwKCiAgICAKICAgIGdldE9mZnNldFdpZHRoIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLmNtLmdldFRvdGFsV2lkdGgoKSArIHRoaXMuZ2V0U2Nyb2xsT2Zmc2V0KCkpICsgJ3B4JzsKICAgIH0sCgogICAgCiAgICBnZXRTY3JvbGxPZmZzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBFeHQubnVtKHRoaXMuc2Nyb2xsT2Zmc2V0LCBFeHQuZ2V0U2Nyb2xsQmFyV2lkdGgoKSk7CiAgICB9LAoKICAgIAogICAgcmVuZGVySGVhZGVycyA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjb2xNb2RlbCAgID0gdGhpcy5jbSwKICAgICAgICAgICAgdGVtcGxhdGVzICA9IHRoaXMudGVtcGxhdGVzLAogICAgICAgICAgICBoZWFkZXJUcGwgID0gdGVtcGxhdGVzLmhjZWxsLAogICAgICAgICAgICBwcm9wZXJ0aWVzID0ge30sCiAgICAgICAgICAgIGNvbENvdW50ICAgPSBjb2xNb2RlbC5nZXRDb2x1bW5Db3VudCgpLAogICAgICAgICAgICBsYXN0ICAgICAgID0gY29sQ291bnQgLSAxLAogICAgICAgICAgICBjZWxscyAgICAgID0gW10sCiAgICAgICAgICAgIGksIGNzc0NsczsKICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29sQ291bnQ7IGkrKykgewogICAgICAgICAgICBpZiAoaSA9PSAwKSB7CiAgICAgICAgICAgICAgICBjc3NDbHMgPSAneC1ncmlkMy1jZWxsLWZpcnN0ICc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjc3NDbHMgPSBpID09IGxhc3QgPyAneC1ncmlkMy1jZWxsLWxhc3QgJyA6ICcnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBwcm9wZXJ0aWVzID0gewogICAgICAgICAgICAgICAgaWQgICAgIDogY29sTW9kZWwuZ2V0Q29sdW1uSWQoaSksCiAgICAgICAgICAgICAgICB2YWx1ZSAgOiBjb2xNb2RlbC5nZXRDb2x1bW5IZWFkZXIoaSkgfHwgJycsCiAgICAgICAgICAgICAgICBzdHlsZSAgOiB0aGlzLmdldENvbHVtblN0eWxlKGksIHRydWUpLAogICAgICAgICAgICAgICAgY3NzICAgIDogY3NzQ2xzLAogICAgICAgICAgICAgICAgdG9vbHRpcDogdGhpcy5nZXRDb2x1bW5Ub29sdGlwKGkpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoY29sTW9kZWwuY29uZmlnW2ldLmFsaWduID09ICdyaWdodCcpIHsKICAgICAgICAgICAgICAgIHByb3BlcnRpZXMuaXN0eWxlID0gJ3BhZGRpbmctcmlnaHQ6IDE2cHg7JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBwcm9wZXJ0aWVzLmlzdHlsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY2VsbHNbaV0gPSBoZWFkZXJUcGwuYXBwbHkocHJvcGVydGllcyk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB0ZW1wbGF0ZXMuaGVhZGVyLmFwcGx5KHsKICAgICAgICAgICAgY2VsbHMgOiBjZWxscy5qb2luKCIiKSwKICAgICAgICAgICAgdHN0eWxlOiBTdHJpbmcuZm9ybWF0KCJ3aWR0aDogezB9OyIsIHRoaXMuZ2V0VG90YWxXaWR0aCgpKQogICAgICAgIH0pOwogICAgfSwKCiAgICAKICAgIGdldENvbHVtblRvb2x0aXAgOiBmdW5jdGlvbihpKSB7CiAgICAgICAgdmFyIHRvb2x0aXAgPSB0aGlzLmNtLmdldENvbHVtblRvb2x0aXAoaSk7CiAgICAgICAgaWYgKHRvb2x0aXApIHsKICAgICAgICAgICAgaWYgKEV4dC5RdWlja1RpcHMuaXNFbmFibGVkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiAnZXh0OnF0aXA9IicgKyB0b29sdGlwICsgJyInOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICd0aXRsZT0iJyArIHRvb2x0aXAgKyAnIic7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuICcnOwogICAgfSwKCiAgICAKICAgIGJlZm9yZVVwZGF0ZSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZ3JpZC5zdG9wRWRpdGluZyh0cnVlKTsKICAgIH0sCgogICAgCiAgICB1cGRhdGVIZWFkZXJzIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5pbm5lckhkLmZpcnN0Q2hpbGQuaW5uZXJIVE1MID0gdGhpcy5yZW5kZXJIZWFkZXJzKCk7CiAgICAgICAgCiAgICAgICAgdGhpcy51cGRhdGVIZWFkZXJXaWR0aChmYWxzZSk7CiAgICB9LAogICAgCiAgICAKICAgIHVwZGF0ZUhlYWRlcldpZHRoOiBmdW5jdGlvbih1cGRhdGVNYWluKSB7CiAgICAgICAgdmFyIGlubmVySGRDaGlsZCA9IHRoaXMuaW5uZXJIZC5maXJzdENoaWxkLAogICAgICAgICAgICB0b3RhbFdpZHRoICAgPSB0aGlzLmdldFRvdGFsV2lkdGgoKTsKICAgICAgICAKICAgICAgICBpbm5lckhkQ2hpbGQuc3R5bGUud2lkdGggPSB0aGlzLmdldE9mZnNldFdpZHRoKCk7CiAgICAgICAgaW5uZXJIZENoaWxkLmZpcnN0Q2hpbGQuc3R5bGUud2lkdGggPSB0b3RhbFdpZHRoOwogICAgICAgIAogICAgICAgIGlmICh1cGRhdGVNYWluICE9PSBmYWxzZSkgewogICAgICAgICAgICB0aGlzLm1haW5Cb2R5LmRvbS5zdHlsZS53aWR0aCA9IHRvdGFsV2lkdGg7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGZvY3VzUm93IDogZnVuY3Rpb24ocm93KSB7CiAgICAgICAgdGhpcy5mb2N1c0NlbGwocm93LCAwLCBmYWxzZSk7CiAgICB9LAoKICAgIAogICAgZm9jdXNDZWxsIDogZnVuY3Rpb24ocm93LCBjb2wsIGhzY3JvbGwpIHsKICAgICAgICB0aGlzLnN5bmNGb2N1c0VsKHRoaXMuZW5zdXJlVmlzaWJsZShyb3csIGNvbCwgaHNjcm9sbCkpOwogICAgICAgIAogICAgICAgIHZhciBmb2N1c0VsID0gdGhpcy5mb2N1c0VsOwogICAgICAgIAogICAgICAgIGlmIChFeHQuaXNHZWNrbykgewogICAgICAgICAgICBmb2N1c0VsLmZvY3VzKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9jdXNFbC5mb2N1cy5kZWZlcigxLCBmb2N1c0VsKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVzb2x2ZUNlbGwgOiBmdW5jdGlvbihyb3csIGNvbCwgaHNjcm9sbCkgewogICAgICAgIGlmICghRXh0LmlzTnVtYmVyKHJvdykpIHsKICAgICAgICAgICAgcm93ID0gcm93LnJvd0luZGV4OwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoIXRoaXMuZHMpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChyb3cgPCAwIHx8IHJvdyA+PSB0aGlzLmRzLmdldENvdW50KCkpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGNvbCA9IChjb2wgIT09IHVuZGVmaW5lZCA/IGNvbCA6IDApOwoKICAgICAgICB2YXIgcm93RWwgICAgPSB0aGlzLmdldFJvdyhyb3cpLAogICAgICAgICAgICBjb2xNb2RlbCA9IHRoaXMuY20sCiAgICAgICAgICAgIGNvbENvdW50ID0gY29sTW9kZWwuZ2V0Q29sdW1uQ291bnQoKSwKICAgICAgICAgICAgY2VsbEVsOwogICAgICAgICAgICAKICAgICAgICBpZiAoIShoc2Nyb2xsID09PSBmYWxzZSAmJiBjb2wgPT09IDApKSB7CiAgICAgICAgICAgIHdoaWxlIChjb2wgPCBjb2xDb3VudCAmJiBjb2xNb2RlbC5pc0hpZGRlbihjb2wpKSB7CiAgICAgICAgICAgICAgICBjb2wrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY2VsbEVsID0gdGhpcy5nZXRDZWxsKHJvdywgY29sKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7cm93OiByb3dFbCwgY2VsbDogY2VsbEVsfTsKICAgIH0sCgogICAgCiAgICBnZXRSZXNvbHZlZFhZIDogZnVuY3Rpb24ocmVzb2x2ZWQpIHsKICAgICAgICBpZiAoIXJlc29sdmVkKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB2YXIgY2VsbCA9IHJlc29sdmVkLmNlbGwsCiAgICAgICAgICAgIHJvdyAgPSByZXNvbHZlZC5yb3c7CiAgICAgICAgCiAgICAgICAgaWYgKGNlbGwpIHsKICAgICAgICAgICAgcmV0dXJuIEV4dC5mbHkoY2VsbCkuZ2V0WFkoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gW3RoaXMuZWwuZ2V0WCgpLCBFeHQuZmx5KHJvdykuZ2V0WSgpXTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc3luY0ZvY3VzRWwgOiBmdW5jdGlvbihyb3csIGNvbCwgaHNjcm9sbCkgewogICAgICAgIHZhciB4eSA9IHJvdzsKICAgICAgICAKICAgICAgICBpZiAoIUV4dC5pc0FycmF5KHh5KSkgewogICAgICAgICAgICByb3cgPSBNYXRoLm1pbihyb3csIE1hdGgubWF4KDAsIHRoaXMuZ2V0Um93cygpLmxlbmd0aC0xKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaXNOYU4ocm93KSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB4eSA9IHRoaXMuZ2V0UmVzb2x2ZWRYWSh0aGlzLnJlc29sdmVDZWxsKHJvdywgY29sLCBoc2Nyb2xsKSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMuZm9jdXNFbC5zZXRYWSh4eSB8fCB0aGlzLnNjcm9sbGVyLmdldFhZKCkpOwogICAgfSwKCiAgICAKICAgIGVuc3VyZVZpc2libGUgOiBmdW5jdGlvbihyb3csIGNvbCwgaHNjcm9sbCkgewogICAgICAgIHZhciByZXNvbHZlZCA9IHRoaXMucmVzb2x2ZUNlbGwocm93LCBjb2wsIGhzY3JvbGwpOwogICAgICAgIAogICAgICAgIGlmICghcmVzb2x2ZWQgfHwgIXJlc29sdmVkLnJvdykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHZhciByb3dFbCAgPSByZXNvbHZlZC5yb3csCiAgICAgICAgICAgIGNlbGxFbCA9IHJlc29sdmVkLmNlbGwsCiAgICAgICAgICAgIGMgPSB0aGlzLnNjcm9sbGVyLmRvbSwKICAgICAgICAgICAgcCA9IHJvd0VsLAogICAgICAgICAgICBjdG9wID0gMCwKICAgICAgICAgICAgc3RvcCA9IHRoaXMuZWwuZG9tOwoKICAgICAgICB3aGlsZSAocCAmJiBwICE9IHN0b3ApIHsKICAgICAgICAgICAgY3RvcCArPSBwLm9mZnNldFRvcDsKICAgICAgICAgICAgcCA9IHAub2Zmc2V0UGFyZW50OwogICAgICAgIH0KCiAgICAgICAgY3RvcCAtPSB0aGlzLm1haW5IZC5kb20ub2Zmc2V0SGVpZ2h0OwogICAgICAgIHN0b3AgPSBwYXJzZUludChjLnNjcm9sbFRvcCwgMTApOwoKICAgICAgICB2YXIgY2JvdCA9IGN0b3AgKyByb3dFbC5vZmZzZXRIZWlnaHQsCiAgICAgICAgICAgIGNoID0gYy5jbGllbnRIZWlnaHQsCiAgICAgICAgICAgIHNib3QgPSBzdG9wICsgY2g7CgoKICAgICAgICBpZiAoY3RvcCA8IHN0b3ApIHsKICAgICAgICAgIGMuc2Nyb2xsVG9wID0gY3RvcDsKICAgICAgICB9IGVsc2UgaWYoY2JvdCA+IHNib3QpIHsKICAgICAgICAgICAgYy5zY3JvbGxUb3AgPSBjYm90LWNoOwogICAgICAgIH0KCiAgICAgICAgaWYgKGhzY3JvbGwgIT09IGZhbHNlKSB7CiAgICAgICAgICAgIHZhciBjbGVmdCAgPSBwYXJzZUludChjZWxsRWwub2Zmc2V0TGVmdCwgMTApLAogICAgICAgICAgICAgICAgY3JpZ2h0ID0gY2xlZnQgKyBjZWxsRWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgICBzbGVmdCAgPSBwYXJzZUludChjLnNjcm9sbExlZnQsIDEwKSwKICAgICAgICAgICAgICAgIHNyaWdodCA9IHNsZWZ0ICsgYy5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoY2xlZnQgPCBzbGVmdCkgewogICAgICAgICAgICAgICAgYy5zY3JvbGxMZWZ0ID0gY2xlZnQ7CiAgICAgICAgICAgIH0gZWxzZSBpZihjcmlnaHQgPiBzcmlnaHQpIHsKICAgICAgICAgICAgICAgIGMuc2Nyb2xsTGVmdCA9IGNyaWdodC1jLmNsaWVudFdpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB0aGlzLmdldFJlc29sdmVkWFkocmVzb2x2ZWQpOwogICAgfSwKCiAgICAKICAgIGluc2VydFJvd3MgOiBmdW5jdGlvbihkbSwgZmlyc3RSb3csIGxhc3RSb3csIGlzVXBkYXRlKSB7CiAgICAgICAgdmFyIGxhc3QgPSBkbS5nZXRDb3VudCgpIC0gMTsKICAgICAgICBpZiggIWlzVXBkYXRlICYmIGZpcnN0Um93ID09PSAwICYmIGxhc3RSb3cgPj0gbGFzdCkgewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnYmVmb3Jlcm93c2luc2VydGVkJywgdGhpcywgZmlyc3RSb3csIGxhc3RSb3cpOwogICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdyb3dzaW5zZXJ0ZWQnLCB0aGlzLCBmaXJzdFJvdywgbGFzdFJvdyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCFpc1VwZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2JlZm9yZXJvd3NpbnNlcnRlZCcsIHRoaXMsIGZpcnN0Um93LCBsYXN0Um93KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaHRtbCA9IHRoaXMucmVuZGVyUm93cyhmaXJzdFJvdywgbGFzdFJvdyksCiAgICAgICAgICAgICAgICBiZWZvcmUgPSB0aGlzLmdldFJvdyhmaXJzdFJvdyk7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICAgIGlmKGZpcnN0Um93ID09PSAwKXsKICAgICAgICAgICAgICAgICAgICBFeHQuZmx5KHRoaXMuZ2V0Um93KDApKS5yZW1vdmVDbGFzcyh0aGlzLmZpcnN0Um93Q2xzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEV4dC5Eb21IZWxwZXIuaW5zZXJ0SHRtbCgnYmVmb3JlQmVnaW4nLCBiZWZvcmUsIGh0bWwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIHIgPSB0aGlzLmdldFJvdyhsYXN0IC0gMSk7CiAgICAgICAgICAgICAgICBpZihyKXsKICAgICAgICAgICAgICAgICAgICBFeHQuZmx5KHIpLnJlbW92ZUNsYXNzKHRoaXMubGFzdFJvd0Nscyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBFeHQuRG9tSGVscGVyLmluc2VydEh0bWwoJ2JlZm9yZUVuZCcsIHRoaXMubWFpbkJvZHkuZG9tLCBodG1sKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWlzVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLnByb2Nlc3NSb3dzKGZpcnN0Um93KTsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdyb3dzaW5zZXJ0ZWQnLCB0aGlzLCBmaXJzdFJvdywgbGFzdFJvdyk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlyc3RSb3cgPT09IDAgfHwgZmlyc3RSb3cgPj0gbGFzdCkgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBFeHQuZmx5KHRoaXMuZ2V0Um93KGZpcnN0Um93KSkuYWRkQ2xhc3MoZmlyc3RSb3cgPT09IDAgPyB0aGlzLmZpcnN0Um93Q2xzIDogdGhpcy5sYXN0Um93Q2xzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnN5bmNGb2N1c0VsKGZpcnN0Um93KTsKICAgIH0sCgogICAgCiAgICBkZWxldGVSb3dzIDogZnVuY3Rpb24oZG0sIGZpcnN0Um93LCBsYXN0Um93KSB7CiAgICAgICAgaWYgKGRtLmdldFJvd0NvdW50KCkgPCAxKSB7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVyb3dzZGVsZXRlZCcsIHRoaXMsIGZpcnN0Um93LCBsYXN0Um93KTsKCiAgICAgICAgICAgIHRoaXMucmVtb3ZlUm93cyhmaXJzdFJvdywgbGFzdFJvdyk7CgogICAgICAgICAgICB0aGlzLnByb2Nlc3NSb3dzKGZpcnN0Um93KTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3Jvd3NkZWxldGVkJywgdGhpcywgZmlyc3RSb3csIGxhc3RSb3cpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRDb2x1bW5TdHlsZSA6IGZ1bmN0aW9uKGNvbEluZGV4LCBpc0hlYWRlcikgewogICAgICAgIHZhciBjb2xNb2RlbCAgPSB0aGlzLmNtLAogICAgICAgICAgICBjb2xDb25maWcgPSBjb2xNb2RlbC5jb25maWcsCiAgICAgICAgICAgIHN0eWxlICAgICA9IGlzSGVhZGVyID8gJycgOiBjb2xDb25maWdbY29sSW5kZXhdLmNzcyB8fCAnJywKICAgICAgICAgICAgYWxpZ24gICAgID0gY29sQ29uZmlnW2NvbEluZGV4XS5hbGlnbjsKICAgICAgICAKICAgICAgICBzdHlsZSArPSBTdHJpbmcuZm9ybWF0KCJ3aWR0aDogezB9OyIsIHRoaXMuZ2V0Q29sdW1uV2lkdGgoY29sSW5kZXgpKTsKICAgICAgICAKICAgICAgICBpZiAoY29sTW9kZWwuaXNIaWRkZW4oY29sSW5kZXgpKSB7CiAgICAgICAgICAgIHN0eWxlICs9ICdkaXNwbGF5OiBub25lOyAnOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoYWxpZ24pIHsKICAgICAgICAgICAgc3R5bGUgKz0gU3RyaW5nLmZvcm1hdCgidGV4dC1hbGlnbjogezB9OyIsIGFsaWduKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHN0eWxlOwogICAgfSwKCiAgICAKICAgIGdldENvbHVtbldpZHRoIDogZnVuY3Rpb24oY29sdW1uKSB7CiAgICAgICAgdmFyIGNvbHVtbldpZHRoID0gdGhpcy5jbS5nZXRDb2x1bW5XaWR0aChjb2x1bW4pLAogICAgICAgICAgICBib3JkZXJXaWR0aCA9IHRoaXMuYm9yZGVyV2lkdGg7CiAgICAgICAgCiAgICAgICAgaWYgKEV4dC5pc051bWJlcihjb2x1bW5XaWR0aCkpIHsKICAgICAgICAgICAgaWYgKEV4dC5pc0JvcmRlckJveCB8fCAoRXh0LmlzV2ViS2l0ICYmICFFeHQuaXNTYWZhcmkyKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNvbHVtbldpZHRoICsgInB4IjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLm1heChjb2x1bW5XaWR0aCAtIGJvcmRlcldpZHRoLCAwKSArICJweCI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gY29sdW1uV2lkdGg7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldFRvdGFsV2lkdGggOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5jbS5nZXRUb3RhbFdpZHRoKCkgKyAncHgnOwogICAgfSwKCiAgICAKICAgIGZpdENvbHVtbnMgOiBmdW5jdGlvbihwcmV2ZW50UmVmcmVzaCwgb25seUV4cGFuZCwgb21pdENvbHVtbikgewogICAgICAgIHZhciBncmlkICAgICAgICAgID0gdGhpcy5ncmlkLAogICAgICAgICAgICBjb2xNb2RlbCAgICAgID0gdGhpcy5jbSwKICAgICAgICAgICAgdG90YWxDb2xXaWR0aCA9IGNvbE1vZGVsLmdldFRvdGFsV2lkdGgoZmFsc2UpLAogICAgICAgICAgICBncmlkV2lkdGggICAgID0gdGhpcy5nZXRHcmlkSW5uZXJXaWR0aCgpLAogICAgICAgICAgICBleHRyYVdpZHRoICAgID0gZ3JpZFdpZHRoIC0gdG90YWxDb2xXaWR0aCwKICAgICAgICAgICAgY29sdW1ucyAgICAgICA9IFtdLAogICAgICAgICAgICBleHRyYUNvbCAgICAgID0gMCwKICAgICAgICAgICAgd2lkdGggICAgICAgICA9IDAsCiAgICAgICAgICAgIGNvbFdpZHRoLCBmcmFjdGlvbiwgaTsKICAgICAgICAKICAgICAgICAKICAgICAgICBpZiAoZ3JpZFdpZHRoIDwgMjAgfHwgZXh0cmFXaWR0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHZhciB2aXNpYmxlQ29sQ291bnQgPSBjb2xNb2RlbC5nZXRDb2x1bW5Db3VudCh0cnVlKSwKICAgICAgICAgICAgdG90YWxDb2xDb3VudCAgID0gY29sTW9kZWwuZ2V0Q29sdW1uQ291bnQoZmFsc2UpLAogICAgICAgICAgICBhZGpDb3VudCAgICAgICAgPSB2aXNpYmxlQ29sQ291bnQgLSAoRXh0LmlzTnVtYmVyKG9taXRDb2x1bW4pID8gMSA6IDApOwogICAgICAgIAogICAgICAgIGlmIChhZGpDb3VudCA9PT0gMCkgewogICAgICAgICAgICBhZGpDb3VudCA9IDE7CiAgICAgICAgICAgIG9taXRDb2x1bW4gPSB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCB0b3RhbENvbENvdW50OyBpKyspIHsKICAgICAgICAgICAgaWYgKCFjb2xNb2RlbC5pc0ZpeGVkKGkpICYmIGkgIT09IG9taXRDb2x1bW4pIHsKICAgICAgICAgICAgICAgIGNvbFdpZHRoID0gY29sTW9kZWwuZ2V0Q29sdW1uV2lkdGgoaSk7CiAgICAgICAgICAgICAgICBjb2x1bW5zLnB1c2goaSwgY29sV2lkdGgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoIWNvbE1vZGVsLmlzSGlkZGVuKGkpKSB7CiAgICAgICAgICAgICAgICAgICAgZXh0cmFDb2wgPSBpOwogICAgICAgICAgICAgICAgICAgIHdpZHRoICs9IGNvbFdpZHRoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZyYWN0aW9uID0gKGdyaWRXaWR0aCAtIGNvbE1vZGVsLmdldFRvdGFsV2lkdGgoKSkgLyB3aWR0aDsKICAgICAgICAKICAgICAgICB3aGlsZSAoY29sdW1ucy5sZW5ndGgpIHsKICAgICAgICAgICAgY29sV2lkdGggPSBjb2x1bW5zLnBvcCgpOwogICAgICAgICAgICBpICAgICAgICA9IGNvbHVtbnMucG9wKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjb2xNb2RlbC5zZXRDb2x1bW5XaWR0aChpLCBNYXRoLm1heChncmlkLm1pbkNvbHVtbldpZHRoLCBNYXRoLmZsb29yKGNvbFdpZHRoICsgY29sV2lkdGggKiBmcmFjdGlvbikpLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdG90YWxDb2xXaWR0aCA9IGNvbE1vZGVsLmdldFRvdGFsV2lkdGgoZmFsc2UpOwogICAgICAgIAogICAgICAgIGlmICh0b3RhbENvbFdpZHRoID4gZ3JpZFdpZHRoKSB7CiAgICAgICAgICAgIHZhciBhZGp1c3RDb2wgPSAoYWRqQ291bnQgPT0gdmlzaWJsZUNvbENvdW50KSA/IGV4dHJhQ29sIDogb21pdENvbHVtbiwKICAgICAgICAgICAgICAgIG5ld1dpZHRoICA9IE1hdGgubWF4KDEsIGNvbE1vZGVsLmdldENvbHVtbldpZHRoKGFkanVzdENvbCkgLSAodG90YWxDb2xXaWR0aCAtIGdyaWRXaWR0aCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgY29sTW9kZWwuc2V0Q29sdW1uV2lkdGgoYWRqdXN0Q29sLCBuZXdXaWR0aCwgdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChwcmV2ZW50UmVmcmVzaCAhPT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZUFsbENvbHVtbldpZHRocygpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgCiAgICBhdXRvRXhwYW5kIDogZnVuY3Rpb24ocHJldmVudFVwZGF0ZSkgewogICAgICAgIHZhciBncmlkICAgICAgICAgICAgID0gdGhpcy5ncmlkLAogICAgICAgICAgICBjb2xNb2RlbCAgICAgICAgID0gdGhpcy5jbSwKICAgICAgICAgICAgZ3JpZFdpZHRoICAgICAgICA9IHRoaXMuZ2V0R3JpZElubmVyV2lkdGgoKSwKICAgICAgICAgICAgdG90YWxDb2x1bW5XaWR0aCA9IGNvbE1vZGVsLmdldFRvdGFsV2lkdGgoZmFsc2UpLAogICAgICAgICAgICBhdXRvRXhwYW5kQ29sdW1uID0gZ3JpZC5hdXRvRXhwYW5kQ29sdW1uOwogICAgICAgIAogICAgICAgIGlmICghdGhpcy51c2VyUmVzaXplZCAmJiBhdXRvRXhwYW5kQ29sdW1uKSB7CiAgICAgICAgICAgIGlmIChncmlkV2lkdGggIT0gdG90YWxDb2x1bW5XaWR0aCkgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2YXIgY29sSW5kZXggICAgID0gY29sTW9kZWwuZ2V0SW5kZXhCeUlkKGF1dG9FeHBhbmRDb2x1bW4pLAogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRXaWR0aCA9IGNvbE1vZGVsLmdldENvbHVtbldpZHRoKGNvbEluZGV4KSwKICAgICAgICAgICAgICAgICAgICBkZXNpcmVkV2lkdGggPSBncmlkV2lkdGggLSB0b3RhbENvbHVtbldpZHRoICsgY3VycmVudFdpZHRoLAogICAgICAgICAgICAgICAgICAgIG5ld1dpZHRoICAgICA9IE1hdGgubWluKE1hdGgubWF4KGRlc2lyZWRXaWR0aCwgZ3JpZC5hdXRvRXhwYW5kTWluKSwgZ3JpZC5hdXRvRXhwYW5kTWF4KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRXaWR0aCAhPSBuZXdXaWR0aCkgewogICAgICAgICAgICAgICAgICAgIGNvbE1vZGVsLnNldENvbHVtbldpZHRoKGNvbEluZGV4LCBuZXdXaWR0aCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZlbnRVcGRhdGUgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5XaWR0aChjb2xJbmRleCwgbmV3V2lkdGgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCiAgICAKICAgIAogICAgZ2V0R3JpZElubmVyV2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdyaWQuZ2V0R3JpZEVsKCkuZ2V0V2lkdGgodHJ1ZSkgLSB0aGlzLmdldFNjcm9sbE9mZnNldCgpOwogICAgfSwKCiAgICAKICAgIGdldENvbHVtbkRhdGEgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29sdW1ucyAgPSBbXSwKICAgICAgICAgICAgY29sTW9kZWwgPSB0aGlzLmNtLAogICAgICAgICAgICBjb2xDb3VudCA9IGNvbE1vZGVsLmdldENvbHVtbkNvdW50KCksCiAgICAgICAgICAgIGZpZWxkcyAgID0gdGhpcy5kcy5maWVsZHMsCiAgICAgICAgICAgIGksIG5hbWU7CiAgICAgICAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbENvdW50OyBpKyspIHsKICAgICAgICAgICAgbmFtZSA9IGNvbE1vZGVsLmdldERhdGFJbmRleChpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbHVtbnNbaV0gPSB7CiAgICAgICAgICAgICAgICBuYW1lICAgIDogRXh0LmlzRGVmaW5lZChuYW1lKSA/IG5hbWUgOiAoZmllbGRzLmdldChpKSA/IGZpZWxkcy5nZXQoaSkubmFtZSA6IHVuZGVmaW5lZCksCiAgICAgICAgICAgICAgICByZW5kZXJlcjogY29sTW9kZWwuZ2V0UmVuZGVyZXIoaSksCiAgICAgICAgICAgICAgICBzY29wZSAgIDogY29sTW9kZWwuZ2V0UmVuZGVyZXJTY29wZShpKSwKICAgICAgICAgICAgICAgIGlkICAgICAgOiBjb2xNb2RlbC5nZXRDb2x1bW5JZChpKSwKICAgICAgICAgICAgICAgIHN0eWxlICAgOiB0aGlzLmdldENvbHVtblN0eWxlKGkpCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBjb2x1bW5zOwogICAgfSwKCiAgICAKICAgIHJlbmRlclJvd3MgOiBmdW5jdGlvbihzdGFydFJvdywgZW5kUm93KSB7CiAgICAgICAgdmFyIGdyaWQgICAgID0gdGhpcy5ncmlkLAogICAgICAgICAgICBzdG9yZSAgICA9IGdyaWQuc3RvcmUsCiAgICAgICAgICAgIHN0cmlwZSAgID0gZ3JpZC5zdHJpcGVSb3dzLAogICAgICAgICAgICBjb2xNb2RlbCA9IGdyaWQuY29sTW9kZWwsCiAgICAgICAgICAgIGNvbENvdW50ID0gY29sTW9kZWwuZ2V0Q29sdW1uQ291bnQoKSwKICAgICAgICAgICAgcm93Q291bnQgPSBzdG9yZS5nZXRDb3VudCgpLAogICAgICAgICAgICByZWNvcmRzOwogICAgICAgIAogICAgICAgIGlmIChyb3dDb3VudCA8IDEpIHsKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBzdGFydFJvdyA9IHN0YXJ0Um93IHx8IDA7CiAgICAgICAgZW5kUm93ICAgPSBFeHQuaXNEZWZpbmVkKGVuZFJvdykgPyBlbmRSb3cgOiByb3dDb3VudCAtIDE7CiAgICAgICAgcmVjb3JkcyAgPSBzdG9yZS5nZXRSYW5nZShzdGFydFJvdywgZW5kUm93KTsKICAgICAgICAKICAgICAgICByZXR1cm4gdGhpcy5kb1JlbmRlcih0aGlzLmdldENvbHVtbkRhdGEoKSwgcmVjb3Jkcywgc3RvcmUsIHN0YXJ0Um93LCBjb2xDb3VudCwgc3RyaXBlKTsKICAgIH0sCgogICAgCiAgICByZW5kZXJCb2R5IDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgbWFya3VwID0gdGhpcy5yZW5kZXJSb3dzKCkgfHwgJyYjMTYwOyc7CiAgICAgICAgcmV0dXJuIHRoaXMudGVtcGxhdGVzLmJvZHkuYXBwbHkoe3Jvd3M6IG1hcmt1cH0pOwogICAgfSwKCiAgICAKICAgIHJlZnJlc2hSb3c6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICAgIHZhciBzdG9yZSAgICAgPSB0aGlzLmRzLAogICAgICAgICAgICBjb2xDb3VudCAgPSB0aGlzLmNtLmdldENvbHVtbkNvdW50KCksCiAgICAgICAgICAgIGNvbHVtbnMgICA9IHRoaXMuZ2V0Q29sdW1uRGF0YSgpLAogICAgICAgICAgICBsYXN0ICAgICAgPSBjb2xDb3VudCAtIDEsCiAgICAgICAgICAgIGNscyAgICAgICA9IFsneC1ncmlkMy1yb3cnXSwKICAgICAgICAgICAgcm93UGFyYW1zID0gewogICAgICAgICAgICAgICAgdHN0eWxlOiBTdHJpbmcuZm9ybWF0KCJ3aWR0aDogezB9OyIsIHRoaXMuZ2V0VG90YWxXaWR0aCgpKQogICAgICAgICAgICB9LAogICAgICAgICAgICBjb2xCdWZmZXIgPSBbXSwKICAgICAgICAgICAgY2VsbFRwbCAgID0gdGhpcy50ZW1wbGF0ZXMuY2VsbCwKICAgICAgICAgICAgcm93SW5kZXgsIHJvdywgY29sdW1uLCBtZXRhLCBjc3MsIGk7CiAgICAgICAgCiAgICAgICAgaWYgKEV4dC5pc051bWJlcihyZWNvcmQpKSB7CiAgICAgICAgICAgIHJvd0luZGV4ID0gcmVjb3JkOwogICAgICAgICAgICByZWNvcmQgICA9IHN0b3JlLmdldEF0KHJvd0luZGV4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb3dJbmRleCA9IHN0b3JlLmluZGV4T2YocmVjb3JkKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgaWYgKCFyZWNvcmQgfHwgcm93SW5kZXggPCAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbENvdW50OyBpKyspIHsKICAgICAgICAgICAgY29sdW1uID0gY29sdW1uc1tpXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChpID09IDApIHsKICAgICAgICAgICAgICAgIGNzcyA9ICd4LWdyaWQzLWNlbGwtZmlyc3QnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3NzID0gKGkgPT0gbGFzdCkgPyAneC1ncmlkMy1jZWxsLWxhc3QgJyA6ICcnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBtZXRhID0gewogICAgICAgICAgICAgICAgaWQgICAgICA6IGNvbHVtbi5pZCwKICAgICAgICAgICAgICAgIHN0eWxlICAgOiBjb2x1bW4uc3R5bGUsCiAgICAgICAgICAgICAgICBjc3MgICAgIDogY3NzLAogICAgICAgICAgICAgICAgYXR0ciAgICA6ICIiLAogICAgICAgICAgICAgICAgY2VsbEF0dHI6ICIiCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICBtZXRhLnZhbHVlID0gY29sdW1uLnJlbmRlcmVyLmNhbGwoY29sdW1uLnNjb3BlLCByZWNvcmQuZGF0YVtjb2x1bW4ubmFtZV0sIG1ldGEsIHJlY29yZCwgcm93SW5kZXgsIGksIHN0b3JlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIChFeHQuaXNFbXB0eShtZXRhLnZhbHVlKSkgewogICAgICAgICAgICAgICAgbWV0YS52YWx1ZSA9ICcmIzE2MDsnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5tYXJrRGlydHkgJiYgcmVjb3JkLmRpcnR5ICYmIHR5cGVvZiByZWNvcmQubW9kaWZpZWRbY29sdW1uLm5hbWVdICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICBtZXRhLmNzcyArPSAnIHgtZ3JpZDMtZGlydHktY2VsbCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbEJ1ZmZlcltpXSA9IGNlbGxUcGwuYXBwbHkobWV0YSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJvdyA9IHRoaXMuZ2V0Um93KHJvd0luZGV4KTsKICAgICAgICByb3cuY2xhc3NOYW1lID0gJyc7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuZ3JpZC5zdHJpcGVSb3dzICYmICgocm93SW5kZXggKyAxKSAlIDIgPT09IDApKSB7CiAgICAgICAgICAgIGNscy5wdXNoKCd4LWdyaWQzLXJvdy1hbHQnKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuZ2V0Um93Q2xhc3MpIHsKICAgICAgICAgICAgcm93UGFyYW1zLmNvbHMgPSBjb2xDb3VudDsKICAgICAgICAgICAgY2xzLnB1c2godGhpcy5nZXRSb3dDbGFzcyhyZWNvcmQsIHJvd0luZGV4LCByb3dQYXJhbXMsIHN0b3JlKSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMuZmx5KHJvdykuYWRkQ2xhc3MoY2xzKS5zZXRTdHlsZShyb3dQYXJhbXMudHN0eWxlKTsKICAgICAgICByb3dQYXJhbXMuY2VsbHMgPSBjb2xCdWZmZXIuam9pbigiIik7CiAgICAgICAgcm93LmlubmVySFRNTCA9IHRoaXMudGVtcGxhdGVzLnJvd0lubmVyLmFwcGx5KHJvd1BhcmFtcyk7CiAgICAgICAgCiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3Jvd3VwZGF0ZWQnLCB0aGlzLCByb3dJbmRleCwgcmVjb3JkKTsKICAgIH0sCgogICAgCiAgICByZWZyZXNoIDogZnVuY3Rpb24oaGVhZGVyc1RvbykgewogICAgICAgIHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVyZWZyZXNoJywgdGhpcyk7CiAgICAgICAgdGhpcy5ncmlkLnN0b3BFZGl0aW5nKHRydWUpOwoKICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5yZW5kZXJCb2R5KCk7CiAgICAgICAgdGhpcy5tYWluQm9keS51cGRhdGUocmVzdWx0KS5zZXRXaWR0aCh0aGlzLmdldFRvdGFsV2lkdGgoKSk7CiAgICAgICAgaWYgKGhlYWRlcnNUb28gPT09IHRydWUpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVIZWFkZXJzKCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlSGVhZGVyU29ydFN0YXRlKCk7CiAgICAgICAgfQogICAgICAgIHRoaXMucHJvY2Vzc1Jvd3MoMCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5sYXlvdXQoKTsKICAgICAgICB0aGlzLmFwcGx5RW1wdHlUZXh0KCk7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3JlZnJlc2gnLCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBhcHBseUVtcHR5VGV4dCA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmVtcHR5VGV4dCAmJiAhdGhpcy5oYXNSb3dzKCkpIHsKICAgICAgICAgICAgdGhpcy5tYWluQm9keS51cGRhdGUoJzxkaXYgY2xhc3M9IngtZ3JpZC1lbXB0eSI+JyArIHRoaXMuZW1wdHlUZXh0ICsgJzwvZGl2PicpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICB1cGRhdGVIZWFkZXJTb3J0U3RhdGUgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3RhdGUgPSB0aGlzLmRzLmdldFNvcnRTdGF0ZSgpOwogICAgICAgIGlmICghc3RhdGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGlzLnNvcnRTdGF0ZSB8fCAodGhpcy5zb3J0U3RhdGUuZmllbGQgIT0gc3RhdGUuZmllbGQgfHwgdGhpcy5zb3J0U3RhdGUuZGlyZWN0aW9uICE9IHN0YXRlLmRpcmVjdGlvbikpIHsKICAgICAgICAgICAgdGhpcy5ncmlkLmZpcmVFdmVudCgnc29ydGNoYW5nZScsIHRoaXMuZ3JpZCwgc3RhdGUpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zb3J0U3RhdGUgPSBzdGF0ZTsKCiAgICAgICAgdmFyIHNvcnRDb2x1bW4gPSB0aGlzLmNtLmZpbmRDb2x1bW5JbmRleChzdGF0ZS5maWVsZCk7CiAgICAgICAgaWYgKHNvcnRDb2x1bW4gIT0gLTEpIHsKICAgICAgICAgICAgdmFyIHNvcnREaXIgPSBzdGF0ZS5kaXJlY3Rpb247CiAgICAgICAgICAgIHRoaXMudXBkYXRlU29ydEljb24oc29ydENvbHVtbiwgc29ydERpcik7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGNsZWFySGVhZGVyU29ydFN0YXRlIDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLnNvcnRTdGF0ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuZ3JpZC5maXJlRXZlbnQoJ3NvcnRjaGFuZ2UnLCB0aGlzLmdyaWQsIG51bGwpOwogICAgICAgIHRoaXMubWFpbkhkLnNlbGVjdCgndGQnKS5yZW1vdmVDbGFzcyh0aGlzLnNvcnRDbGFzc2VzKTsKICAgICAgICBkZWxldGUgdGhpcy5zb3J0U3RhdGU7CiAgICB9LAoKICAgIAogICAgZGVzdHJveSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBtZSAgICAgICAgICAgICAgPSB0aGlzLAogICAgICAgICAgICBncmlkICAgICAgICAgICAgPSBtZS5ncmlkLAogICAgICAgICAgICBncmlkRWwgICAgICAgICAgPSBncmlkLmdldEdyaWRFbCgpLAogICAgICAgICAgICBkcmFnWm9uZSAgICAgICAgPSBtZS5kcmFnWm9uZSwKICAgICAgICAgICAgc3BsaXRab25lICAgICAgID0gbWUuc3BsaXRab25lLAogICAgICAgICAgICBjb2x1bW5EcmFnICAgICAgPSBtZS5jb2x1bW5EcmFnLAogICAgICAgICAgICBjb2x1bW5Ecm9wICAgICAgPSBtZS5jb2x1bW5Ecm9wLAogICAgICAgICAgICBzY3JvbGxUb1RvcFRhc2sgPSBtZS5zY3JvbGxUb1RvcFRhc2ssCiAgICAgICAgICAgIGNvbHVtbkRyYWdEYXRhLAogICAgICAgICAgICBjb2x1bW5EcmFnUHJveHk7CiAgICAgICAgCiAgICAgICAgaWYgKHNjcm9sbFRvVG9wVGFzayAmJiBzY3JvbGxUb1RvcFRhc2suY2FuY2VsKSB7CiAgICAgICAgICAgIHNjcm9sbFRvVG9wVGFzay5jYW5jZWwoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgRXh0LmRlc3Ryb3lNZW1iZXJzKG1lLCAnY29sTWVudScsICdobWVudScpOwoKICAgICAgICBtZS5pbml0RGF0YShudWxsLCBudWxsKTsKICAgICAgICBtZS5wdXJnZUxpc3RlbmVycygpOwogICAgICAgIAogICAgICAgIEV4dC5mbHkobWUuaW5uZXJIZCkudW4oImNsaWNrIiwgbWUuaGFuZGxlSGREb3duLCBtZSk7CgogICAgICAgIGlmIChncmlkLmVuYWJsZUNvbHVtbk1vdmUpIHsKICAgICAgICAgICAgY29sdW1uRHJhZ0RhdGEgPSBjb2x1bW5EcmFnLmRyYWdEYXRhOwogICAgICAgICAgICBjb2x1bW5EcmFnUHJveHkgPSBjb2x1bW5EcmFnLnByb3h5OwogICAgICAgICAgICBFeHQuZGVzdHJveSgKICAgICAgICAgICAgICAgIGNvbHVtbkRyYWcuZWwsCiAgICAgICAgICAgICAgICBjb2x1bW5EcmFnUHJveHkuZ2hvc3QsCiAgICAgICAgICAgICAgICBjb2x1bW5EcmFnUHJveHkuZWwsCiAgICAgICAgICAgICAgICBjb2x1bW5Ecm9wLmVsLAogICAgICAgICAgICAgICAgY29sdW1uRHJvcC5wcm94eVRvcCwKICAgICAgICAgICAgICAgIGNvbHVtbkRyb3AucHJveHlCb3R0b20sCiAgICAgICAgICAgICAgICBjb2x1bW5EcmFnRGF0YS5kZGVsLAogICAgICAgICAgICAgICAgY29sdW1uRHJhZ0RhdGEuaGVhZGVyCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoY29sdW1uRHJhZ1Byb3h5LmFuaW0pIHsKICAgICAgICAgICAgICAgIEV4dC5kZXN0cm95KGNvbHVtbkRyYWdQcm94eS5hbmltKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgZGVsZXRlIGNvbHVtbkRyYWdQcm94eS5naG9zdDsKICAgICAgICAgICAgZGVsZXRlIGNvbHVtbkRyYWdEYXRhLmRkZWw7CiAgICAgICAgICAgIGRlbGV0ZSBjb2x1bW5EcmFnRGF0YS5oZWFkZXI7CiAgICAgICAgICAgIGNvbHVtbkRyYWcuZGVzdHJveSgpOwogICAgICAgICAgICAKICAgICAgICAgICAgZGVsZXRlIEV4dC5kZC5ERE0ubG9jYXRpb25DYWNoZVtjb2x1bW5EcmFnLmlkXTsKICAgICAgICAgICAgZGVsZXRlIGNvbHVtbkRyYWcuX2RvbVJlZjsKCiAgICAgICAgICAgIGRlbGV0ZSBjb2x1bW5Ecm9wLnByb3h5VG9wOwogICAgICAgICAgICBkZWxldGUgY29sdW1uRHJvcC5wcm94eUJvdHRvbTsKICAgICAgICAgICAgY29sdW1uRHJvcC5kZXN0cm95KCk7CiAgICAgICAgICAgIGRlbGV0ZSBFeHQuZGQuRERNLmxvY2F0aW9uQ2FjaGVbImdyaWRIZWFkZXIiICsgZ3JpZEVsLmlkXTsKICAgICAgICAgICAgZGVsZXRlIGNvbHVtbkRyb3AuX2RvbVJlZjsKICAgICAgICAgICAgZGVsZXRlIEV4dC5kZC5ERE0uaWRzW2NvbHVtbkRyb3AuZGRHcm91cF07CiAgICAgICAgfQoKICAgICAgICBpZiAoc3BsaXRab25lKSB7IAogICAgICAgICAgICBzcGxpdFpvbmUuZGVzdHJveSgpOwogICAgICAgICAgICBkZWxldGUgc3BsaXRab25lLl9kb21SZWY7CiAgICAgICAgICAgIGRlbGV0ZSBFeHQuZGQuRERNLmlkc1siZ3JpZFNwbGl0dGVycyIgKyBncmlkRWwuaWRdOwogICAgICAgIH0KCiAgICAgICAgRXh0LmZseShtZS5pbm5lckhkKS5yZW1vdmVBbGxMaXN0ZW5lcnMoKTsKICAgICAgICBFeHQucmVtb3ZlTm9kZShtZS5pbm5lckhkKTsKICAgICAgICBkZWxldGUgbWUuaW5uZXJIZDsKCiAgICAgICAgRXh0LmRlc3Ryb3koCiAgICAgICAgICAgIG1lLmVsLAogICAgICAgICAgICBtZS5tYWluV3JhcCwKICAgICAgICAgICAgbWUubWFpbkhkLAogICAgICAgICAgICBtZS5zY3JvbGxlciwKICAgICAgICAgICAgbWUubWFpbkJvZHksCiAgICAgICAgICAgIG1lLmZvY3VzRWwsCiAgICAgICAgICAgIG1lLnJlc2l6ZU1hcmtlciwKICAgICAgICAgICAgbWUucmVzaXplUHJveHksCiAgICAgICAgICAgIG1lLmFjdGl2ZUhkQnRuLAogICAgICAgICAgICBtZS5fZmx5d2VpZ2h0LAogICAgICAgICAgICBkcmFnWm9uZSwKICAgICAgICAgICAgc3BsaXRab25lCiAgICAgICAgKTsKCiAgICAgICAgZGVsZXRlIGdyaWQuY29udGFpbmVyOwoKICAgICAgICBpZiAoZHJhZ1pvbmUpIHsKICAgICAgICAgICAgZHJhZ1pvbmUuZGVzdHJveSgpOwogICAgICAgIH0KCiAgICAgICAgRXh0LmRkLkRETS5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICBkZWxldGUgRXh0LmRkLkRETS5sb2NhdGlvbkNhY2hlW2dyaWRFbC5pZF07CgogICAgICAgIEV4dC5FdmVudE1hbmFnZXIucmVtb3ZlUmVzaXplTGlzdGVuZXIobWUub25XaW5kb3dSZXNpemUsIG1lKTsKICAgIH0sCgogICAgCiAgICBvbkRlbnlDb2x1bW5IaWRlIDogZnVuY3Rpb24oKSB7CgogICAgfSwKCiAgICAKICAgIHJlbmRlciA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmF1dG9GaWxsKSB7CiAgICAgICAgICAgIHZhciBjdCA9IHRoaXMuZ3JpZC5vd25lckN0OwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGN0ICYmIGN0LmdldExheW91dCgpKSB7CiAgICAgICAgICAgICAgICBjdC5vbignYWZ0ZXJsYXlvdXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZpdENvbHVtbnModHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWFkZXJzKCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVIZWFkZXJTb3J0U3RhdGUoKTsKICAgICAgICAgICAgICAgIH0sIHRoaXMsIHtzaW5nbGU6IHRydWV9KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAodGhpcy5mb3JjZUZpdCkgewogICAgICAgICAgICB0aGlzLmZpdENvbHVtbnModHJ1ZSwgZmFsc2UpOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5ncmlkLmF1dG9FeHBhbmRDb2x1bW4pIHsKICAgICAgICAgICAgdGhpcy5hdXRvRXhwYW5kKHRydWUpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLmdyaWQuZ2V0R3JpZEVsKCkuZG9tLmlubmVySFRNTCA9IHRoaXMucmVuZGVyVUkoKTsKICAgICAgICAKICAgICAgICB0aGlzLmFmdGVyUmVuZGVyVUkoKTsKICAgIH0sCgogICAgCiAgICAKICAgIAogICAgaW5pdERhdGEgOiBmdW5jdGlvbihuZXdTdG9yZSwgbmV3Q29sTW9kZWwpIHsKICAgICAgICB2YXIgbWUgPSB0aGlzOwogICAgICAgIAogICAgICAgIGlmIChtZS5kcykgewogICAgICAgICAgICB2YXIgb2xkU3RvcmUgPSBtZS5kczsKICAgICAgICAgICAgCiAgICAgICAgICAgIG9sZFN0b3JlLnVuKCdhZGQnLCBtZS5vbkFkZCwgbWUpOwogICAgICAgICAgICBvbGRTdG9yZS51bignbG9hZCcsIG1lLm9uTG9hZCwgbWUpOwogICAgICAgICAgICBvbGRTdG9yZS51bignY2xlYXInLCBtZS5vbkNsZWFyLCBtZSk7CiAgICAgICAgICAgIG9sZFN0b3JlLnVuKCdyZW1vdmUnLCBtZS5vblJlbW92ZSwgbWUpOwogICAgICAgICAgICBvbGRTdG9yZS51bigndXBkYXRlJywgbWUub25VcGRhdGUsIG1lKTsKICAgICAgICAgICAgb2xkU3RvcmUudW4oJ2RhdGFjaGFuZ2VkJywgbWUub25EYXRhQ2hhbmdlLCBtZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAob2xkU3RvcmUgIT09IG5ld1N0b3JlICYmIG9sZFN0b3JlLmF1dG9EZXN0cm95KSB7CiAgICAgICAgICAgICAgICBvbGRTdG9yZS5kZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKG5ld1N0b3JlKSB7CiAgICAgICAgICAgIG5ld1N0b3JlLm9uKHsKICAgICAgICAgICAgICAgIHNjb3BlICAgICAgOiBtZSwKICAgICAgICAgICAgICAgIGxvYWQgICAgICAgOiBtZS5vbkxvYWQsCiAgICAgICAgICAgICAgICBhZGQgICAgICAgIDogbWUub25BZGQsCiAgICAgICAgICAgICAgICByZW1vdmUgICAgIDogbWUub25SZW1vdmUsCiAgICAgICAgICAgICAgICB1cGRhdGUgICAgIDogbWUub25VcGRhdGUsCiAgICAgICAgICAgICAgICBjbGVhciAgICAgIDogbWUub25DbGVhciwKICAgICAgICAgICAgICAgIGRhdGFjaGFuZ2VkOiBtZS5vbkRhdGFDaGFuZ2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChtZS5jbSkgewogICAgICAgICAgICB2YXIgb2xkQ29sTW9kZWwgPSBtZS5jbTsKICAgICAgICAgICAgCiAgICAgICAgICAgIG9sZENvbE1vZGVsLnVuKCdjb25maWdjaGFuZ2UnLCBtZS5vbkNvbENvbmZpZ0NoYW5nZSwgbWUpOwogICAgICAgICAgICBvbGRDb2xNb2RlbC51bignd2lkdGhjaGFuZ2UnLCAgbWUub25Db2xXaWR0aENoYW5nZSwgbWUpOwogICAgICAgICAgICBvbGRDb2xNb2RlbC51bignaGVhZGVyY2hhbmdlJywgbWUub25IZWFkZXJDaGFuZ2UsIG1lKTsKICAgICAgICAgICAgb2xkQ29sTW9kZWwudW4oJ2hpZGRlbmNoYW5nZScsIG1lLm9uSGlkZGVuQ2hhbmdlLCBtZSk7CiAgICAgICAgICAgIG9sZENvbE1vZGVsLnVuKCdjb2x1bW5tb3ZlZCcsICBtZS5vbkNvbHVtbk1vdmUsIG1lKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKG5ld0NvbE1vZGVsKSB7CiAgICAgICAgICAgIGRlbGV0ZSBtZS5sYXN0Vmlld1dpZHRoOwogICAgICAgICAgICAKICAgICAgICAgICAgbmV3Q29sTW9kZWwub24oewogICAgICAgICAgICAgICAgc2NvcGUgICAgICAgOiBtZSwKICAgICAgICAgICAgICAgIGNvbmZpZ2NoYW5nZTogbWUub25Db2xDb25maWdDaGFuZ2UsCiAgICAgICAgICAgICAgICB3aWR0aGNoYW5nZSA6IG1lLm9uQ29sV2lkdGhDaGFuZ2UsCiAgICAgICAgICAgICAgICBoZWFkZXJjaGFuZ2U6IG1lLm9uSGVhZGVyQ2hhbmdlLAogICAgICAgICAgICAgICAgaGlkZGVuY2hhbmdlOiBtZS5vbkhpZGRlbkNoYW5nZSwKICAgICAgICAgICAgICAgIGNvbHVtbm1vdmVkIDogbWUub25Db2x1bW5Nb3ZlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBtZS5kcyA9IG5ld1N0b3JlOwogICAgICAgIG1lLmNtID0gbmV3Q29sTW9kZWw7CiAgICB9LAoKICAgIAogICAgb25EYXRhQ2hhbmdlIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnJlZnJlc2godHJ1ZSk7CiAgICAgICAgdGhpcy51cGRhdGVIZWFkZXJTb3J0U3RhdGUoKTsKICAgICAgICB0aGlzLnN5bmNGb2N1c0VsKDApOwogICAgfSwKCiAgICAKICAgIG9uQ2xlYXIgOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICB0aGlzLnN5bmNGb2N1c0VsKDApOwogICAgfSwKCiAgICAKICAgIG9uVXBkYXRlIDogZnVuY3Rpb24oc3RvcmUsIHJlY29yZCkgewogICAgICAgIHRoaXMucmVmcmVzaFJvdyhyZWNvcmQpOwogICAgfSwKCiAgICAKICAgIG9uQWRkIDogZnVuY3Rpb24oc3RvcmUsIHJlY29yZHMsIGluZGV4KSB7CiAgICAgICAgdGhpcy5pbnNlcnRSb3dzKHN0b3JlLCBpbmRleCwgaW5kZXggKyAocmVjb3Jkcy5sZW5ndGgtMSkpOwogICAgfSwKCiAgICAKICAgIG9uUmVtb3ZlIDogZnVuY3Rpb24oc3RvcmUsIHJlY29yZCwgaW5kZXgsIGlzVXBkYXRlKSB7CiAgICAgICAgaWYgKGlzVXBkYXRlICE9PSB0cnVlKSB7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVyb3dyZW1vdmVkJywgdGhpcywgaW5kZXgsIHJlY29yZCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMucmVtb3ZlUm93KGluZGV4KTsKICAgICAgICAKICAgICAgICBpZiAoaXNVcGRhdGUgIT09IHRydWUpIHsKICAgICAgICAgICAgdGhpcy5wcm9jZXNzUm93cyhpbmRleCk7CiAgICAgICAgICAgIHRoaXMuYXBwbHlFbXB0eVRleHQoKTsKICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3Jvd3JlbW92ZWQnLCB0aGlzLCBpbmRleCwgcmVjb3JkKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25Mb2FkIDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKEV4dC5pc0dlY2tvKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5zY3JvbGxUb1RvcFRhc2spIHsKICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9Ub3BUYXNrID0gbmV3IEV4dC51dGlsLkRlbGF5ZWRUYXNrKHRoaXMuc2Nyb2xsVG9Ub3AsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9Ub3BUYXNrLmRlbGF5KDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9Ub3AoKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25Db2xXaWR0aENoYW5nZSA6IGZ1bmN0aW9uKGNtLCBjb2wsIHdpZHRoKSB7CiAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5XaWR0aChjb2wsIHdpZHRoKTsKICAgIH0sCgogICAgCiAgICBvbkhlYWRlckNoYW5nZSA6IGZ1bmN0aW9uKGNtLCBjb2wsIHRleHQpIHsKICAgICAgICB0aGlzLnVwZGF0ZUhlYWRlcnMoKTsKICAgIH0sCgogICAgCiAgICBvbkhpZGRlbkNoYW5nZSA6IGZ1bmN0aW9uKGNtLCBjb2wsIGhpZGRlbikgewogICAgICAgIHRoaXMudXBkYXRlQ29sdW1uSGlkZGVuKGNvbCwgaGlkZGVuKTsKICAgIH0sCgogICAgCiAgICBvbkNvbHVtbk1vdmUgOiBmdW5jdGlvbihjbSwgb2xkSW5kZXgsIG5ld0luZGV4KSB7CiAgICAgICAgdGhpcy5pbmRleE1hcCA9IG51bGw7CiAgICAgICAgdGhpcy5yZWZyZXNoKHRydWUpOwogICAgICAgIHRoaXMucmVzdG9yZVNjcm9sbCh0aGlzLmdldFNjcm9sbFN0YXRlKCkpOwogICAgICAgIAogICAgICAgIHRoaXMuYWZ0ZXJNb3ZlKG5ld0luZGV4KTsKICAgICAgICB0aGlzLmdyaWQuZmlyZUV2ZW50KCdjb2x1bW5tb3ZlJywgb2xkSW5kZXgsIG5ld0luZGV4KTsKICAgIH0sCgogICAgCiAgICBvbkNvbENvbmZpZ0NoYW5nZSA6IGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLmxhc3RWaWV3V2lkdGg7CiAgICAgICAgdGhpcy5pbmRleE1hcCA9IG51bGw7CiAgICAgICAgdGhpcy5yZWZyZXNoKHRydWUpOwogICAgfSwKCiAgICAKICAgIAogICAgaW5pdFVJIDogZnVuY3Rpb24oZ3JpZCkgewogICAgICAgIGdyaWQub24oJ2hlYWRlcmNsaWNrJywgdGhpcy5vbkhlYWRlckNsaWNrLCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBpbml0RXZlbnRzIDogRXh0LmVtcHR5Rm4sCgogICAgCiAgICBvbkhlYWRlckNsaWNrIDogZnVuY3Rpb24oZywgaW5kZXgpIHsKICAgICAgICBpZiAodGhpcy5oZWFkZXJzRGlzYWJsZWQgfHwgIXRoaXMuY20uaXNTb3J0YWJsZShpbmRleCkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBnLnN0b3BFZGl0aW5nKHRydWUpOwogICAgICAgIGcuc3RvcmUuc29ydCh0aGlzLmNtLmdldERhdGFJbmRleChpbmRleCkpOwogICAgfSwKCiAgICAKICAgIG9uUm93T3ZlciA6IGZ1bmN0aW9uKGUsIHRhcmdldCkgewogICAgICAgIHZhciByb3cgPSB0aGlzLmZpbmRSb3dJbmRleCh0YXJnZXQpOwogICAgICAgIAogICAgICAgIGlmIChyb3cgIT09IGZhbHNlKSB7CiAgICAgICAgICAgIHRoaXMuYWRkUm93Q2xhc3Mocm93LCB0aGlzLnJvd092ZXJDbHMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblJvd091dCA6IGZ1bmN0aW9uKGUsIHRhcmdldCkgewogICAgICAgIHZhciByb3cgPSB0aGlzLmZpbmRSb3dJbmRleCh0YXJnZXQpOwogICAgICAgIAogICAgICAgIGlmIChyb3cgIT09IGZhbHNlICYmICFlLndpdGhpbih0aGlzLmdldFJvdyhyb3cpLCB0cnVlKSkgewogICAgICAgICAgICB0aGlzLnJlbW92ZVJvd0NsYXNzKHJvdywgdGhpcy5yb3dPdmVyQ2xzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25Sb3dTZWxlY3QgOiBmdW5jdGlvbihyb3cpIHsKICAgICAgICB0aGlzLmFkZFJvd0NsYXNzKHJvdywgdGhpcy5zZWxlY3RlZFJvd0NsYXNzKTsKICAgIH0sCgogICAgCiAgICBvblJvd0Rlc2VsZWN0IDogZnVuY3Rpb24ocm93KSB7CiAgICAgICAgdGhpcy5yZW1vdmVSb3dDbGFzcyhyb3csIHRoaXMuc2VsZWN0ZWRSb3dDbGFzcyk7CiAgICB9LAoKICAgIAogICAgb25DZWxsU2VsZWN0IDogZnVuY3Rpb24ocm93LCBjb2wpIHsKICAgICAgICB2YXIgY2VsbCA9IHRoaXMuZ2V0Q2VsbChyb3csIGNvbCk7CiAgICAgICAgaWYgKGNlbGwpIHsKICAgICAgICAgICAgdGhpcy5mbHkoY2VsbCkuYWRkQ2xhc3MoJ3gtZ3JpZDMtY2VsbC1zZWxlY3RlZCcpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkNlbGxEZXNlbGVjdCA6IGZ1bmN0aW9uKHJvdywgY29sKSB7CiAgICAgICAgdmFyIGNlbGwgPSB0aGlzLmdldENlbGwocm93LCBjb2wpOwogICAgICAgIGlmIChjZWxsKSB7CiAgICAgICAgICAgIHRoaXMuZmx5KGNlbGwpLnJlbW92ZUNsYXNzKCd4LWdyaWQzLWNlbGwtc2VsZWN0ZWQnKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaGFuZGxlV2hlZWwgOiBmdW5jdGlvbihlKSB7CiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH0sCgogICAgCiAgICBvbkNvbHVtblNwbGl0dGVyTW92ZWQgOiBmdW5jdGlvbihjZWxsSW5kZXgsIHdpZHRoKSB7CiAgICAgICAgdGhpcy51c2VyUmVzaXplZCA9IHRydWU7CiAgICAgICAgdGhpcy5ncmlkLmNvbE1vZGVsLnNldENvbHVtbldpZHRoKGNlbGxJbmRleCwgd2lkdGgsIHRydWUpOwoKICAgICAgICBpZiAodGhpcy5mb3JjZUZpdCkgewogICAgICAgICAgICB0aGlzLmZpdENvbHVtbnModHJ1ZSwgZmFsc2UsIGNlbGxJbmRleCk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlQWxsQ29sdW1uV2lkdGhzKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5XaWR0aChjZWxsSW5kZXgsIHdpZHRoKTsKICAgICAgICAgICAgdGhpcy5zeW5jSGVhZGVyU2Nyb2xsKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmdyaWQuZmlyZUV2ZW50KCdjb2x1bW5yZXNpemUnLCBjZWxsSW5kZXgsIHdpZHRoKTsKICAgIH0sCgogICAgCiAgICBiZWZvcmVDb2xNZW51U2hvdyA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjb2xNb2RlbCA9IHRoaXMuY20sCiAgICAgICAgICAgIGNvbENvdW50ID0gY29sTW9kZWwuZ2V0Q29sdW1uQ291bnQoKSwKICAgICAgICAgICAgY29sTWVudSAgPSB0aGlzLmNvbE1lbnUsCiAgICAgICAgICAgIGk7CgogICAgICAgIGNvbE1lbnUucmVtb3ZlQWxsKCk7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb2xDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChjb2xNb2RlbC5jb25maWdbaV0uaGlkZWFibGUgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICBjb2xNZW51LmFkZChuZXcgRXh0Lm1lbnUuQ2hlY2tJdGVtKHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICAgICAgIDogY29sTW9kZWwuZ2V0Q29sdW1uSGVhZGVyKGkpLAogICAgICAgICAgICAgICAgICAgIGl0ZW1JZCAgICAgOiAnY29sLScgKyBjb2xNb2RlbC5nZXRDb2x1bW5JZChpKSwKICAgICAgICAgICAgICAgICAgICBjaGVja2VkICAgIDogIWNvbE1vZGVsLmlzSGlkZGVuKGkpLAogICAgICAgICAgICAgICAgICAgIGRpc2FibGVkICAgOiBjb2xNb2RlbC5jb25maWdbaV0uaGlkZWFibGUgPT09IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGhpZGVPbkNsaWNrOiBmYWxzZQogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBoYW5kbGVIZE1lbnVDbGljayA6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICB2YXIgc3RvcmUgICAgID0gdGhpcy5kcywKICAgICAgICAgICAgZGF0YUluZGV4ID0gdGhpcy5jbS5nZXREYXRhSW5kZXgodGhpcy5oZEN0eEluZGV4KTsKCiAgICAgICAgc3dpdGNoIChpdGVtLmdldEl0ZW1JZCgpKSB7CiAgICAgICAgICAgIGNhc2UgJ2FzYyc6CiAgICAgICAgICAgICAgICBzdG9yZS5zb3J0KGRhdGFJbmRleCwgJ0FTQycpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2Rlc2MnOgogICAgICAgICAgICAgICAgc3RvcmUuc29ydChkYXRhSW5kZXgsICdERVNDJyk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlSGRNZW51Q2xpY2tEZWZhdWx0KGl0ZW0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICAKICAgIAogICAgaGFuZGxlSGRNZW51Q2xpY2tEZWZhdWx0OiBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgdmFyIGNvbE1vZGVsID0gdGhpcy5jbSwKICAgICAgICAgICAgaXRlbUlkICAgPSBpdGVtLmdldEl0ZW1JZCgpLAogICAgICAgICAgICBpbmRleCAgICA9IGNvbE1vZGVsLmdldEluZGV4QnlJZChpdGVtSWQuc3Vic3RyKDQpKTsKCiAgICAgICAgaWYgKGluZGV4ICE9IC0xKSB7CiAgICAgICAgICAgIGlmIChpdGVtLmNoZWNrZWQgJiYgY29sTW9kZWwuZ2V0Q29sdW1uc0J5KHRoaXMuaXNIaWRlYWJsZUNvbHVtbiwgdGhpcykubGVuZ3RoIDw9IDEpIHsKICAgICAgICAgICAgICAgIHRoaXMub25EZW55Q29sdW1uSGlkZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbE1vZGVsLnNldEhpZGRlbihpbmRleCwgaXRlbS5jaGVja2VkKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaGFuZGxlSGREb3duIDogZnVuY3Rpb24oZSwgdGFyZ2V0KSB7CiAgICAgICAgaWYgKEV4dC5mbHkodGFyZ2V0KS5oYXNDbGFzcygneC1ncmlkMy1oZC1idG4nKSkgewogICAgICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGNvbE1vZGVsICA9IHRoaXMuY20sCiAgICAgICAgICAgICAgICBoZWFkZXIgICAgPSB0aGlzLmZpbmRIZWFkZXJDZWxsKHRhcmdldCksCiAgICAgICAgICAgICAgICBpbmRleCAgICAgPSB0aGlzLmdldENlbGxJbmRleChoZWFkZXIpLAogICAgICAgICAgICAgICAgc29ydGFibGUgID0gY29sTW9kZWwuaXNTb3J0YWJsZShpbmRleCksCiAgICAgICAgICAgICAgICBtZW51ICAgICAgPSB0aGlzLmhtZW51LAogICAgICAgICAgICAgICAgbWVudUl0ZW1zID0gbWVudS5pdGVtcywKICAgICAgICAgICAgICAgIG1lbnVDbHMgICA9IHRoaXMuaGVhZGVyTWVudU9wZW5DbHM7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmhkQ3R4SW5kZXggPSBpbmRleDsKICAgICAgICAgICAgCiAgICAgICAgICAgIEV4dC5mbHkoaGVhZGVyKS5hZGRDbGFzcyhtZW51Q2xzKTsKICAgICAgICAgICAgbWVudUl0ZW1zLmdldCgnYXNjJykuc2V0RGlzYWJsZWQoIXNvcnRhYmxlKTsKICAgICAgICAgICAgbWVudUl0ZW1zLmdldCgnZGVzYycpLnNldERpc2FibGVkKCFzb3J0YWJsZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBtZW51Lm9uKCdoaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBFeHQuZmx5KGhlYWRlcikucmVtb3ZlQ2xhc3MobWVudUNscyk7CiAgICAgICAgICAgIH0sIHRoaXMsIHtzaW5nbGU6dHJ1ZX0pOwogICAgICAgICAgICAKICAgICAgICAgICAgbWVudS5zaG93KHRhcmdldCwgJ3RsLWJsPycpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBoYW5kbGVIZE1vdmUgOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIGhlYWRlciA9IHRoaXMuZmluZEhlYWRlckNlbGwodGhpcy5hY3RpdmVIZFJlZik7CiAgICAgICAgCiAgICAgICAgaWYgKGhlYWRlciAmJiAhdGhpcy5oZWFkZXJzRGlzYWJsZWQpIHsKICAgICAgICAgICAgdmFyIGhhbmRsZVdpZHRoICA9IHRoaXMuc3BsaXRIYW5kbGVXaWR0aCB8fCA1LAogICAgICAgICAgICAgICAgYWN0aXZlUmVnaW9uID0gdGhpcy5hY3RpdmVIZFJlZ2lvbiwKICAgICAgICAgICAgICAgIGhlYWRlclN0eWxlICA9IGhlYWRlci5zdHlsZSwKICAgICAgICAgICAgICAgIGNvbE1vZGVsICAgICA9IHRoaXMuY20sCiAgICAgICAgICAgICAgICBjdXJzb3IgICAgICAgPSAnJywKICAgICAgICAgICAgICAgIHBhZ2VYICAgICAgICA9IGUuZ2V0UGFnZVgoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5ncmlkLmVuYWJsZUNvbHVtblJlc2l6ZSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHZhciBhY3RpdmVIZWFkZXJJbmRleCA9IHRoaXMuYWN0aXZlSGRJbmRleCwKICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1Zpc2libGUgICA9IHRoaXMuZ2V0UHJldmlvdXNWaXNpYmxlKGFjdGl2ZUhlYWRlckluZGV4KSwKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UmVzaXphYmxlICA9IGNvbE1vZGVsLmlzUmVzaXphYmxlKGFjdGl2ZUhlYWRlckluZGV4KSwKICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1Jlc2l6YWJsZSA9IHByZXZpb3VzVmlzaWJsZSAmJiBjb2xNb2RlbC5pc1Jlc2l6YWJsZShwcmV2aW91c1Zpc2libGUpLAogICAgICAgICAgICAgICAgICAgIGluTGVmdFJlc2l6ZXIgICAgID0gcGFnZVggLSBhY3RpdmVSZWdpb24ubGVmdCA8PSBoYW5kbGVXaWR0aCwKICAgICAgICAgICAgICAgICAgICBpblJpZ2h0UmVzaXplciAgICA9IGFjdGl2ZVJlZ2lvbi5yaWdodCAtIHBhZ2VYIDw9ICghdGhpcy5hY3RpdmVIZEJ0biA/IGhhbmRsZVdpZHRoIDogMik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChpbkxlZnRSZXNpemVyICYmIHByZXZpb3VzUmVzaXphYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgY3Vyc29yID0gRXh0LmlzQWlyID8gJ21vdmUnIDogRXh0LmlzV2ViS2l0ID8gJ2UtcmVzaXplJyA6ICdjb2wtcmVzaXplJzsgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluUmlnaHRSZXNpemVyICYmIGN1cnJlbnRSZXNpemFibGUpIHsKICAgICAgICAgICAgICAgICAgICBjdXJzb3IgPSBFeHQuaXNBaXIgPyAnbW92ZScgOiBFeHQuaXNXZWJLaXQgPyAndy1yZXNpemUnIDogJ2NvbC1yZXNpemUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBoZWFkZXJTdHlsZS5jdXJzb3IgPSBjdXJzb3I7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBnZXRQcmV2aW91c1Zpc2libGU6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgd2hpbGUgKGluZGV4ID4gMCkgewogICAgICAgICAgICBpZiAoIXRoaXMuY20uaXNIaWRkZW4oaW5kZXggLSAxKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgfQogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9LAoKICAgIAogICAgaGFuZGxlSGRPdmVyIDogZnVuY3Rpb24oZSwgdGFyZ2V0KSB7CiAgICAgICAgdmFyIGhlYWRlciA9IHRoaXMuZmluZEhlYWRlckNlbGwodGFyZ2V0KTsKICAgICAgICAKICAgICAgICBpZiAoaGVhZGVyICYmICF0aGlzLmhlYWRlcnNEaXNhYmxlZCkgewogICAgICAgICAgICB2YXIgZmx5ID0gdGhpcy5mbHkoaGVhZGVyKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuYWN0aXZlSGRSZWYgPSB0YXJnZXQ7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlSGRJbmRleCA9IHRoaXMuZ2V0Q2VsbEluZGV4KGhlYWRlcik7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlSGRSZWdpb24gPSBmbHkuZ2V0UmVnaW9uKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIXRoaXMuaXNNZW51RGlzYWJsZWQodGhpcy5hY3RpdmVIZEluZGV4LCBmbHkpKSB7CiAgICAgICAgICAgICAgICBmbHkuYWRkQ2xhc3MoJ3gtZ3JpZDMtaGQtb3ZlcicpOwogICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVIZEJ0biA9IGZseS5jaGlsZCgnLngtZ3JpZDMtaGQtYnRuJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZUhkQnRuKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVIZEJ0bi5kb20uc3R5bGUuaGVpZ2h0ID0gKGhlYWRlci5maXJzdENoaWxkLm9mZnNldEhlaWdodCAtIDEpICsgJ3B4JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBoYW5kbGVIZE91dCA6IGZ1bmN0aW9uKGUsIHRhcmdldCkgewogICAgICAgIHZhciBoZWFkZXIgPSB0aGlzLmZpbmRIZWFkZXJDZWxsKHRhcmdldCk7CiAgICAgICAgCiAgICAgICAgaWYgKGhlYWRlciAmJiAoIUV4dC5pc0lFIHx8ICFlLndpdGhpbihoZWFkZXIsIHRydWUpKSkgewogICAgICAgICAgICB0aGlzLmFjdGl2ZUhkUmVmID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5mbHkoaGVhZGVyKS5yZW1vdmVDbGFzcygneC1ncmlkMy1oZC1vdmVyJyk7CiAgICAgICAgICAgIGhlYWRlci5zdHlsZS5jdXJzb3IgPSAnJzsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIGlzTWVudURpc2FibGVkOiBmdW5jdGlvbihjZWxsSW5kZXgsIGVsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY20uaXNNZW51RGlzYWJsZWQoY2VsbEluZGV4KTsKICAgIH0sCgogICAgCiAgICBoYXNSb3dzIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGZjID0gdGhpcy5tYWluQm9keS5kb20uZmlyc3RDaGlsZDsKICAgICAgICByZXR1cm4gZmMgJiYgZmMubm9kZVR5cGUgPT0gMSAmJiBmYy5jbGFzc05hbWUgIT0gJ3gtZ3JpZC1lbXB0eSc7CiAgICB9LAogICAgCiAgICAKICAgIGlzSGlkZWFibGVDb2x1bW4gOiBmdW5jdGlvbihjKSB7CiAgICAgICAgcmV0dXJuICFjLmhpZGRlbjsKICAgIH0sCgogICAgCiAgICBiaW5kIDogZnVuY3Rpb24oZCwgYykgewogICAgICAgIHRoaXMuaW5pdERhdGEoZCwgYyk7CiAgICB9Cn0pOwoKCgoKRXh0LmdyaWQuR3JpZFZpZXcuU3BsaXREcmFnWm9uZSA9IEV4dC5leHRlbmQoRXh0LmRkLkREUHJveHksIHsKCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oZ3JpZCwgaGQpewogICAgICAgIHRoaXMuZ3JpZCA9IGdyaWQ7CiAgICAgICAgdGhpcy52aWV3ID0gZ3JpZC5nZXRWaWV3KCk7CiAgICAgICAgdGhpcy5tYXJrZXIgPSB0aGlzLnZpZXcucmVzaXplTWFya2VyOwogICAgICAgIHRoaXMucHJveHkgPSB0aGlzLnZpZXcucmVzaXplUHJveHk7CiAgICAgICAgRXh0LmdyaWQuR3JpZFZpZXcuU3BsaXREcmFnWm9uZS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgaGQsCiAgICAgICAgICAgICdncmlkU3BsaXR0ZXJzJyArIHRoaXMuZ3JpZC5nZXRHcmlkRWwoKS5pZCwgewogICAgICAgICAgICBkcmFnRWxJZCA6IEV4dC5pZCh0aGlzLnByb3h5LmRvbSksIHJlc2l6ZUZyYW1lOmZhbHNlCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5zY3JvbGwgPSBmYWxzZTsKICAgICAgICB0aGlzLmh3ID0gdGhpcy52aWV3LnNwbGl0SGFuZGxlV2lkdGggfHwgNTsKICAgIH0sCgogICAgYjRTdGFydERyYWcgOiBmdW5jdGlvbih4LCB5KXsKICAgICAgICB0aGlzLmRyYWdIZWFkZXJzRGlzYWJsZWQgPSB0aGlzLnZpZXcuaGVhZGVyc0Rpc2FibGVkOwogICAgICAgIHRoaXMudmlldy5oZWFkZXJzRGlzYWJsZWQgPSB0cnVlOwogICAgICAgIHZhciBoID0gdGhpcy52aWV3Lm1haW5XcmFwLmdldEhlaWdodCgpOwogICAgICAgIHRoaXMubWFya2VyLnNldEhlaWdodChoKTsKICAgICAgICB0aGlzLm1hcmtlci5zaG93KCk7CiAgICAgICAgdGhpcy5tYXJrZXIuYWxpZ25Ubyh0aGlzLnZpZXcuZ2V0SGVhZGVyQ2VsbCh0aGlzLmNlbGxJbmRleCksICd0bC10bCcsIFstMiwgMF0pOwogICAgICAgIHRoaXMucHJveHkuc2V0SGVpZ2h0KGgpOwogICAgICAgIHZhciB3ID0gdGhpcy5jbS5nZXRDb2x1bW5XaWR0aCh0aGlzLmNlbGxJbmRleCksCiAgICAgICAgICAgIG1pbncgPSBNYXRoLm1heCh3LXRoaXMuZ3JpZC5taW5Db2x1bW5XaWR0aCwgMCk7CiAgICAgICAgdGhpcy5yZXNldENvbnN0cmFpbnRzKCk7CiAgICAgICAgdGhpcy5zZXRYQ29uc3RyYWludChtaW53LCAxMDAwKTsKICAgICAgICB0aGlzLnNldFlDb25zdHJhaW50KDAsIDApOwogICAgICAgIHRoaXMubWluWCA9IHggLSBtaW53OwogICAgICAgIHRoaXMubWF4WCA9IHggKyAxMDAwOwogICAgICAgIHRoaXMuc3RhcnRQb3MgPSB4OwogICAgICAgIEV4dC5kZC5ERFByb3h5LnByb3RvdHlwZS5iNFN0YXJ0RHJhZy5jYWxsKHRoaXMsIHgsIHkpOwogICAgfSwKCiAgICBhbGxvd0hlYWRlckRyYWcgOiBmdW5jdGlvbihlKXsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgaGFuZGxlTW91c2VEb3duIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIHQgPSB0aGlzLnZpZXcuZmluZEhlYWRlckNlbGwoZS5nZXRUYXJnZXQoKSk7CiAgICAgICAgaWYodCAmJiB0aGlzLmFsbG93SGVhZGVyRHJhZyhlKSl7CiAgICAgICAgICAgIHZhciB4eSA9IHRoaXMudmlldy5mbHkodCkuZ2V0WFkoKSwgCiAgICAgICAgICAgICAgICB4ID0geHlbMF0sCiAgICAgICAgICAgICAgICBleHkgPSBlLmdldFhZKCksIAogICAgICAgICAgICAgICAgZXggPSBleHlbMF0sCiAgICAgICAgICAgICAgICB3ID0gdC5vZmZzZXRXaWR0aCwgCiAgICAgICAgICAgICAgICBhZGp1c3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZigoZXggLSB4KSA8PSB0aGlzLmh3KXsKICAgICAgICAgICAgICAgIGFkanVzdCA9IC0xOwogICAgICAgICAgICB9ZWxzZSBpZigoeCt3KSAtIGV4IDw9IHRoaXMuaHcpewogICAgICAgICAgICAgICAgYWRqdXN0ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihhZGp1c3QgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIHRoaXMuY20gPSB0aGlzLmdyaWQuY29sTW9kZWw7CiAgICAgICAgICAgICAgICB2YXIgY2kgPSB0aGlzLnZpZXcuZ2V0Q2VsbEluZGV4KHQpOwogICAgICAgICAgICAgICAgaWYoYWRqdXN0ID09IC0xKXsKICAgICAgICAgICAgICAgICAgaWYgKGNpICsgYWRqdXN0IDwgMCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHdoaWxlKHRoaXMuY20uaXNIaWRkZW4oY2krYWRqdXN0KSl7CiAgICAgICAgICAgICAgICAgICAgICAgIC0tYWRqdXN0OwogICAgICAgICAgICAgICAgICAgICAgICBpZihjaSthZGp1c3QgPCAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY2VsbEluZGV4ID0gY2krYWRqdXN0OwogICAgICAgICAgICAgICAgdGhpcy5zcGxpdCA9IHQuZG9tOwogICAgICAgICAgICAgICAgaWYodGhpcy5jbS5pc1Jlc2l6YWJsZSh0aGlzLmNlbGxJbmRleCkgJiYgIXRoaXMuY20uaXNGaXhlZCh0aGlzLmNlbGxJbmRleCkpewogICAgICAgICAgICAgICAgICAgIEV4dC5ncmlkLkdyaWRWaWV3LlNwbGl0RHJhZ1pvbmUuc3VwZXJjbGFzcy5oYW5kbGVNb3VzZURvd24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWVsc2UgaWYodGhpcy52aWV3LmNvbHVtbkRyYWcpewogICAgICAgICAgICAgICAgdGhpcy52aWV3LmNvbHVtbkRyYWcuY2FsbEhhbmRsZU1vdXNlRG93bihlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgZW5kRHJhZyA6IGZ1bmN0aW9uKGUpewogICAgICAgIHRoaXMubWFya2VyLmhpZGUoKTsKICAgICAgICB2YXIgdiA9IHRoaXMudmlldywKICAgICAgICAgICAgZW5kWCA9IE1hdGgubWF4KHRoaXMubWluWCwgZS5nZXRQYWdlWCgpKSwKICAgICAgICAgICAgZGlmZiA9IGVuZFggLSB0aGlzLnN0YXJ0UG9zLAogICAgICAgICAgICBkaXNhYmxlZCA9IHRoaXMuZHJhZ0hlYWRlcnNEaXNhYmxlZDsKICAgICAgICAgICAgCiAgICAgICAgdi5vbkNvbHVtblNwbGl0dGVyTW92ZWQodGhpcy5jZWxsSW5kZXgsIHRoaXMuY20uZ2V0Q29sdW1uV2lkdGgodGhpcy5jZWxsSW5kZXgpK2RpZmYpOwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgdi5oZWFkZXJzRGlzYWJsZWQgPSBkaXNhYmxlZDsKICAgICAgICB9LCA1MCk7CiAgICB9LAoKICAgIGF1dG9PZmZzZXQgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuc2V0RGVsdGEoMCwwKTsKICAgIH0KfSk7CgpFeHQuZ3JpZC5QaXZvdEdyaWRWaWV3ID0gRXh0LmV4dGVuZChFeHQuZ3JpZC5HcmlkVmlldywgewogICAgCiAgICAKICAgIGNvbEhlYWRlckNlbGxDbHM6ICdncmlkLWhkLWdyb3VwLWNlbGwnLAogICAgCiAgICAKICAgIHRpdGxlOiAnJywKICAgIAogICAgCiAgICAKICAgIAogICAgZ2V0Q29sdW1uSGVhZGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ3JpZC50b3BBeGlzLmJ1aWxkSGVhZGVycygpOzsKICAgIH0sCiAgICAKICAgIAogICAgZ2V0Um93SGVhZGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ3JpZC5sZWZ0QXhpcy5idWlsZEhlYWRlcnMoKTsKICAgIH0sCiAgICAKICAgIAogICAgcmVuZGVyUm93cyA6IGZ1bmN0aW9uKHN0YXJ0Um93LCBlbmRSb3cpIHsKICAgICAgICB2YXIgZ3JpZCAgICAgICAgICA9IHRoaXMuZ3JpZCwKICAgICAgICAgICAgcm93cyAgICAgICAgICA9IGdyaWQuZXh0cmFjdERhdGEoKSwKICAgICAgICAgICAgcm93Q291bnQgICAgICA9IHJvd3MubGVuZ3RoLAogICAgICAgICAgICB0ZW1wbGF0ZXMgICAgID0gdGhpcy50ZW1wbGF0ZXMsCiAgICAgICAgICAgIHJlbmRlcmVyICAgICAgPSBncmlkLnJlbmRlcmVyLAogICAgICAgICAgICBoYXNSZW5kZXJlciAgID0gdHlwZW9mIHJlbmRlcmVyID09ICdmdW5jdGlvbicsCiAgICAgICAgICAgIGdldENlbGxDbHMgICAgPSB0aGlzLmdldENlbGxDbHMsCiAgICAgICAgICAgIGhhc0dldENlbGxDbHMgPSB0eXBlb2YgZ2V0Q2VsbENscyA9PSAnZnVuY3Rpb24nLAogICAgICAgICAgICBjZWxsVGVtcGxhdGUgID0gdGVtcGxhdGVzLmNlbGwsCiAgICAgICAgICAgIHJvd1RlbXBsYXRlICAgPSB0ZW1wbGF0ZXMucm93LAogICAgICAgICAgICByb3dCdWZmZXIgICAgID0gW10sCiAgICAgICAgICAgIG1ldGEgICAgICAgICAgPSB7fSwKICAgICAgICAgICAgdHN0eWxlICAgICAgICA9ICd3aWR0aDonICsgdGhpcy5nZXRHcmlkSW5uZXJXaWR0aCgpICsgJ3B4OycsCiAgICAgICAgICAgIGNvbEJ1ZmZlciwgY29sQ291bnQsIGNvbHVtbiwgaSwgcm93OwogICAgICAgIAogICAgICAgIHN0YXJ0Um93ID0gc3RhcnRSb3cgfHwgMDsKICAgICAgICBlbmRSb3cgICA9IEV4dC5pc0RlZmluZWQoZW5kUm93KSA/IGVuZFJvdyA6IHJvd0NvdW50IC0gMTsKICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcm93Q291bnQ7IGkrKykgewogICAgICAgICAgICByb3cgPSByb3dzW2ldOwogICAgICAgICAgICBjb2xDb3VudCAgPSByb3cubGVuZ3RoOwogICAgICAgICAgICBjb2xCdWZmZXIgPSBbXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGNvbENvdW50OyBqKyspIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbWV0YS5pZCAgICA9IGkgKyAnLScgKyBqOwogICAgICAgICAgICAgICAgbWV0YS5jc3MgICA9IGogPT09IDAgPyAneC1ncmlkMy1jZWxsLWZpcnN0ICcgOiAoaiA9PSAoY29sQ291bnQgLSAxKSA/ICd4LWdyaWQzLWNlbGwtbGFzdCAnIDogJycpOwogICAgICAgICAgICAgICAgbWV0YS5hdHRyICA9IG1ldGEuY2VsbEF0dHIgPSAnJzsKICAgICAgICAgICAgICAgIG1ldGEudmFsdWUgPSByb3dbal07CgogICAgICAgICAgICAgICAgaWYgKEV4dC5pc0VtcHR5KG1ldGEudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbWV0YS52YWx1ZSA9ICcmIzE2MDsnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoaGFzUmVuZGVyZXIpIHsKICAgICAgICAgICAgICAgICAgICBtZXRhLnZhbHVlID0gcmVuZGVyZXIobWV0YS52YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChoYXNHZXRDZWxsQ2xzKSB7CiAgICAgICAgICAgICAgICAgICAgbWV0YS5jc3MgKz0gZ2V0Q2VsbENscyhtZXRhLnZhbHVlKSArICcgJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb2xCdWZmZXJbY29sQnVmZmVyLmxlbmd0aF0gPSBjZWxsVGVtcGxhdGUuYXBwbHkobWV0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJvd0J1ZmZlcltyb3dCdWZmZXIubGVuZ3RoXSA9IHJvd1RlbXBsYXRlLmFwcGx5KHsKICAgICAgICAgICAgICAgIHRzdHlsZTogdHN0eWxlLAogICAgICAgICAgICAgICAgY29scyAgOiBjb2xDb3VudCwKICAgICAgICAgICAgICAgIGNlbGxzIDogY29sQnVmZmVyLmpvaW4oIiIpLAogICAgICAgICAgICAgICAgYWx0ICAgOiAnJwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJvd0J1ZmZlci5qb2luKCIiKTsKICAgIH0sCiAgICAKICAgIAogICAgbWFzdGVyVHBsOiBuZXcgRXh0LlRlbXBsYXRlKAogICAgICAgICc8ZGl2IGNsYXNzPSJ4LWdyaWQzIHgtcGl2b3RncmlkIiBoaWRlZm9jdXM9InRydWUiPicsCiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWdyaWQzLXZpZXdwb3J0Ij4nLAogICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9IngtZ3JpZDMtaGVhZGVyIj4nLAogICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWdyaWQzLWhlYWRlci10aXRsZSI+PHNwYW4+e3RpdGxlfTwvc3Bhbj48L2Rpdj4nLAogICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWdyaWQzLWhlYWRlci1pbm5lciI+JywKICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9IngtZ3JpZDMtaGVhZGVyLW9mZnNldCIgc3R5bGU9Intvc3R5bGV9Ij48L2Rpdj4nLAogICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nLAogICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ4LWNsZWFyIj48L2Rpdj4nLAogICAgICAgICAgICAgICAgJzwvZGl2PicsCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1zY3JvbGxlciI+JywKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1yb3ctaGVhZGVycyI+PC9kaXY+JywKICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1ib2R5IiBzdHlsZT0ie2JzdHlsZX0iPntib2R5fTwvZGl2PicsCiAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9IiMiIGNsYXNzPSJ4LWdyaWQzLWZvY3VzIiB0YWJJbmRleD0iLTEiPjwvYT4nLAogICAgICAgICAgICAgICAgJzwvZGl2PicsCiAgICAgICAgICAgICc8L2Rpdj4nLAogICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1yZXNpemUtbWFya2VyIj4mIzE2MDs8L2Rpdj4nLAogICAgICAgICAgICAnPGRpdiBjbGFzcz0ieC1ncmlkMy1yZXNpemUtcHJveHkiPiYjMTYwOzwvZGl2PicsCiAgICAgICAgJzwvZGl2PicKICAgICksCiAgICAKICAgIAogICAgaW5pdFRlbXBsYXRlczogZnVuY3Rpb24oKSB7CiAgICAgICAgRXh0LmdyaWQuUGl2b3RHcmlkVmlldy5zdXBlcmNsYXNzLmluaXRUZW1wbGF0ZXMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAKICAgICAgICB2YXIgdGVtcGxhdGVzID0gdGhpcy50ZW1wbGF0ZXMgfHwge307CiAgICAgICAgaWYgKCF0ZW1wbGF0ZXMuZ2NlbGwpIHsKICAgICAgICAgICAgdGVtcGxhdGVzLmdjZWxsID0gbmV3IEV4dC5YVGVtcGxhdGUoCiAgICAgICAgICAgICAgICAnPHRkIGNsYXNzPSJ4LWdyaWQzLWhkIHgtZ3JpZDMtZ2NlbGwgeC1ncmlkMy10ZC17aWR9IHV4LWdyaWQtaGQtZ3JvdXAtcm93LXtyb3d9ICcgKyB0aGlzLmNvbEhlYWRlckNlbGxDbHMgKyAnIiBzdHlsZT0ie3N0eWxlfSI+JywKICAgICAgICAgICAgICAgICAgICAnPGRpdiB7dG9vbHRpcH0gY2xhc3M9IngtZ3JpZDMtaGQtaW5uZXIgeC1ncmlkMy1oZC17aWR9IiB1bnNlbGVjdGFibGU9Im9uIiBzdHlsZT0ie2lzdHlsZX0iPicsIAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdyaWQuZW5hYmxlSGRNZW51ID8gJzxhIGNsYXNzPSJ4LWdyaWQzLWhkLWJ0biIgaHJlZj0iIyI+PC9hPicgOiAnJywgJ3t2YWx1ZX0nLAogICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nLAogICAgICAgICAgICAgICAgJzwvdGQ+JwogICAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLnRlbXBsYXRlcyA9IHRlbXBsYXRlczsKICAgICAgICB0aGlzLmhyb3dSZSA9IG5ldyBSZWdFeHAoInV4LWdyaWQtaGQtZ3JvdXAtcm93LShcXGQrKSIsICIiKTsKICAgIH0sCiAgICAKICAgIAogICAgaW5pdEVsZW1lbnRzOiBmdW5jdGlvbigpIHsKICAgICAgICBFeHQuZ3JpZC5QaXZvdEdyaWRWaWV3LnN1cGVyY2xhc3MuaW5pdEVsZW1lbnRzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdGhpcy5yb3dIZWFkZXJzRWwgPSBuZXcgRXh0LkVsZW1lbnQodGhpcy5zY3JvbGxlci5jaGlsZCgnZGl2LngtZ3JpZDMtcm93LWhlYWRlcnMnKSk7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgdGhpcy5oZWFkZXJUaXRsZUVsID0gbmV3IEV4dC5FbGVtZW50KHRoaXMubWFpbkhkLmNoaWxkKCdkaXYueC1ncmlkMy1oZWFkZXItdGl0bGUnKSk7CiAgICB9LAogICAgCiAgICAKICAgIGdldEdyaWRJbm5lcldpZHRoOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcHJldmlvdXNXaWR0aCA9IEV4dC5ncmlkLlBpdm90R3JpZFZpZXcuc3VwZXJjbGFzcy5nZXRHcmlkSW5uZXJXaWR0aC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIAogICAgICAgIHJldHVybiBwcmV2aW91c1dpZHRoIC0gdGhpcy5nZXRUb3RhbFJvd0hlYWRlcldpZHRoKCk7CiAgICB9LAogICAgCiAgICAKICAgIGdldFRvdGFsUm93SGVhZGVyV2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBoZWFkZXJzID0gdGhpcy5nZXRSb3dIZWFkZXJzKCksCiAgICAgICAgICAgIGxlbmd0aCAgPSBoZWFkZXJzLmxlbmd0aCwKICAgICAgICAgICAgdG90YWwgICA9IDAsCiAgICAgICAgICAgIGk7CiAgICAgICAgCiAgICAgICAgZm9yIChpID0gMDsgaTwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdG90YWwgKz0gaGVhZGVyc1tpXS53aWR0aDsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRvdGFsOwogICAgfSwKICAgIAogICAgCiAgICBnZXRUb3RhbENvbHVtbkhlYWRlckhlaWdodDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29sdW1uSGVhZGVycygpLmxlbmd0aCAqIDIxOwogICAgfSwKICAgIAogICAgCiAgICBnZXRDZWxsSW5kZXggOiBmdW5jdGlvbihlbCkgewogICAgICAgIGlmIChlbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBlbC5jbGFzc05hbWUubWF0Y2godGhpcy5jb2xSZSksCiAgICAgICAgICAgICAgICBkYXRhOwogCiAgICAgICAgICAgIGlmIChtYXRjaCAmJiAoZGF0YSA9IG1hdGNoWzFdKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW50KGRhdGEuc3BsaXQoJy0nKVsxXSwgMTApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICAKICAgIAogICAgCiAgICByZW5kZXJVSSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0ZW1wbGF0ZXMgID0gdGhpcy50ZW1wbGF0ZXMsCiAgICAgICAgICAgIGlubmVyV2lkdGggPSB0aGlzLmdldEdyaWRJbm5lcldpZHRoKCk7CiAgICAgICAgICAgIAogICAgICAgIHJldHVybiB0ZW1wbGF0ZXMubWFzdGVyLmFwcGx5KHsKICAgICAgICAgICAgYm9keSAgOiB0ZW1wbGF0ZXMuYm9keS5hcHBseSh7cm93czonJiMxNjA7J30pLAogICAgICAgICAgICBvc3R5bGU6ICd3aWR0aDonICsgaW5uZXJXaWR0aCArICdweCcsCiAgICAgICAgICAgIGJzdHlsZTogJ3dpZHRoOicgKyBpbm5lcldpZHRoICsgJ3B4JwogICAgICAgIH0pOwogICAgfSwKICAgIAogICAgCiAgICBvbkxheW91dDogZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewogICAgICAgIEV4dC5ncmlkLlBpdm90R3JpZFZpZXcuc3VwZXJjbGFzcy5vbkxheW91dC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIAogICAgICAgIHZhciB3aWR0aCA9IHRoaXMuZ2V0R3JpZElubmVyV2lkdGgoKTsKICAgICAgICAKICAgICAgICB0aGlzLnJlc2l6ZUNvbHVtbkhlYWRlcnMod2lkdGgpOwogICAgICAgIHRoaXMucmVzaXplQWxsUm93cyh3aWR0aCk7CiAgICB9LAogICAgCiAgICAKICAgIHJlZnJlc2ggOiBmdW5jdGlvbihoZWFkZXJzVG9vKSB7CiAgICAgICAgdGhpcy5maXJlRXZlbnQoJ2JlZm9yZXJlZnJlc2gnLCB0aGlzKTsKICAgICAgICB0aGlzLmdyaWQuc3RvcEVkaXRpbmcodHJ1ZSk7CiAgICAgICAgCiAgICAgICAgdmFyIHJlc3VsdCA9IHRoaXMucmVuZGVyQm9keSgpOwogICAgICAgIHRoaXMubWFpbkJvZHkudXBkYXRlKHJlc3VsdCkuc2V0V2lkdGgodGhpcy5nZXRHcmlkSW5uZXJXaWR0aCgpKTsKICAgICAgICBpZiAoaGVhZGVyc1RvbyA9PT0gdHJ1ZSkgewogICAgICAgICAgICB0aGlzLnVwZGF0ZUhlYWRlcnMoKTsKICAgICAgICAgICAgdGhpcy51cGRhdGVIZWFkZXJTb3J0U3RhdGUoKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5wcm9jZXNzUm93cygwLCB0cnVlKTsKICAgICAgICB0aGlzLmxheW91dCgpOwogICAgICAgIHRoaXMuYXBwbHlFbXB0eVRleHQoKTsKICAgICAgICB0aGlzLmZpcmVFdmVudCgncmVmcmVzaCcsIHRoaXMpOwogICAgfSwKICAgIAogICAgCiAgICByZW5kZXJIZWFkZXJzOiBFeHQuZW1wdHlGbiwKICAgIAogICAgCiAgICBmaXRDb2x1bW5zOiBFeHQuZW1wdHlGbiwKICAgIAogICAgCiAgICByZXNpemVDb2x1bW5IZWFkZXJzOiBmdW5jdGlvbih3aWR0aCkgewogICAgICAgIHZhciB0b3BBeGlzID0gdGhpcy5ncmlkLnRvcEF4aXM7CiAgICAgICAgCiAgICAgICAgaWYgKHRvcEF4aXMucmVuZGVyZWQpIHsKICAgICAgICAgICAgdG9wQXhpcy5lbC5zZXRXaWR0aCh3aWR0aCk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICByZXNpemVSb3dIZWFkZXJzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcm93SGVhZGVyV2lkdGggPSB0aGlzLmdldFRvdGFsUm93SGVhZGVyV2lkdGgoKSwKICAgICAgICAgICAgbWFyZ2luU3R5bGUgICAgPSBTdHJpbmcuZm9ybWF0KCJtYXJnaW4tbGVmdDogezB9cHg7Iiwgcm93SGVhZGVyV2lkdGgpOwogICAgICAgIAogICAgICAgIHRoaXMucm93SGVhZGVyc0VsLnNldFdpZHRoKHJvd0hlYWRlcldpZHRoKTsKICAgICAgICB0aGlzLm1haW5Cb2R5LmFwcGx5U3R5bGVzKG1hcmdpblN0eWxlKTsKICAgICAgICBFeHQuZmx5KHRoaXMuaW5uZXJIZCkuYXBwbHlTdHlsZXMobWFyZ2luU3R5bGUpOwogICAgICAgIAogICAgICAgIHRoaXMuaGVhZGVyVGl0bGVFbC5zZXRXaWR0aChyb3dIZWFkZXJXaWR0aCk7CiAgICAgICAgdGhpcy5oZWFkZXJUaXRsZUVsLnNldEhlaWdodCh0aGlzLmdldFRvdGFsQ29sdW1uSGVhZGVySGVpZ2h0KCkpOwogICAgfSwKICAgIAogICAgCiAgICByZXNpemVBbGxSb3dzOiBmdW5jdGlvbih3aWR0aCkgewogICAgICAgIHZhciByb3dzICAgPSB0aGlzLmdldFJvd3MoKSwKICAgICAgICAgICAgbGVuZ3RoID0gcm93cy5sZW5ndGgsCiAgICAgICAgICAgIGk7CiAgICAgICAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIEV4dC5mbHkocm93c1tpXSkuc2V0V2lkdGgod2lkdGgpOwogICAgICAgICAgICBFeHQuZmx5KHJvd3NbaV0pLmNoaWxkKCd0YWJsZScpLnNldFdpZHRoKHdpZHRoKTsKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIHVwZGF0ZUhlYWRlcnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucmVuZGVyR3JvdXBSb3dIZWFkZXJzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJHcm91cENvbHVtbkhlYWRlcnMoKTsKICAgIH0sCiAgICAKICAgIAogICAgcmVuZGVyR3JvdXBSb3dIZWFkZXJzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbGVmdEF4aXMgPSB0aGlzLmdyaWQubGVmdEF4aXM7CiAgICAgICAgCiAgICAgICAgdGhpcy5yZXNpemVSb3dIZWFkZXJzKCk7CiAgICAgICAgbGVmdEF4aXMucmVuZGVyZWQgPSBmYWxzZTsKICAgICAgICBsZWZ0QXhpcy5yZW5kZXIodGhpcy5yb3dIZWFkZXJzRWwpOwogICAgICAgIAogICAgICAgIHRoaXMuc2V0VGl0bGUodGhpcy50aXRsZSk7CiAgICB9LAogICAgCiAgICAKICAgIHNldFRpdGxlOiBmdW5jdGlvbih0aXRsZSkgewogICAgICAgIHRoaXMuaGVhZGVyVGl0bGVFbC5jaGlsZCgnc3BhbicpLmRvbS5pbm5lckhUTUwgPSB0aXRsZTsKICAgIH0sCiAgICAKICAgIAogICAgcmVuZGVyR3JvdXBDb2x1bW5IZWFkZXJzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdG9wQXhpcyA9IHRoaXMuZ3JpZC50b3BBeGlzOwogICAgICAgIAogICAgICAgIHRvcEF4aXMucmVuZGVyZWQgPSBmYWxzZTsKICAgICAgICB0b3BBeGlzLnJlbmRlcih0aGlzLmlubmVySGQuZmlyc3RDaGlsZCk7CiAgICB9LAogICAgCiAgICAKICAgIGlzTWVudURpc2FibGVkOiBmdW5jdGlvbihjZWxsSW5kZXgsIGVsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Cn0pOwpFeHQuZ3JpZC5QaXZvdEF4aXMgPSBFeHQuZXh0ZW5kKEV4dC5Db21wb25lbnQsIHsKICAgIAogICAgb3JpZW50YXRpb246ICdob3Jpem9udGFsJywKICAgIAogICAgCiAgICBkZWZhdWx0SGVhZGVyV2lkdGg6IDgwLAogICAgCiAgICAKICAgIHBhZGRpbmdXaWR0aDogNywKICAgIAogICAgCiAgICBzZXREaW1lbnNpb25zOiBmdW5jdGlvbihkaW1lbnNpb25zKSB7CiAgICAgICAgdGhpcy5kaW1lbnNpb25zID0gZGltZW5zaW9uczsKICAgIH0sCiAgICAKICAgIAogICAgb25SZW5kZXI6IGZ1bmN0aW9uKGN0LCBwb3NpdGlvbikgewogICAgICAgIHZhciByb3dzID0gdGhpcy5vcmllbnRhdGlvbiA9PSAnaG9yaXpvbnRhbCcKICAgICAgICAgICAgICAgICA/IHRoaXMucmVuZGVySG9yaXpvbnRhbFJvd3MoKQogICAgICAgICAgICAgICAgIDogdGhpcy5yZW5kZXJWZXJ0aWNhbFJvd3MoKTsKICAgICAgICAKICAgICAgICB0aGlzLmVsID0gRXh0LkRvbUhlbHBlci5vdmVyd3JpdGUoY3QuZG9tLCB7dGFnOiAndGFibGUnLCBjbjogcm93c30sIHRydWUpOwogICAgfSwKICAgIAogICAgCiAgICByZW5kZXJIb3Jpem9udGFsUm93czogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGhlYWRlcnMgID0gdGhpcy5idWlsZEhlYWRlcnMoKSwKICAgICAgICAgICAgcm93Q291bnQgPSBoZWFkZXJzLmxlbmd0aCwKICAgICAgICAgICAgcm93cyAgICAgPSBbXSwKICAgICAgICAgICAgY2VsbHMsIGNvbHMsIGNvbENvdW50LCBpLCBqOwogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCByb3dDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGNlbGxzID0gW107CiAgICAgICAgICAgIGNvbHMgID0gaGVhZGVyc1tpXS5pdGVtczsKICAgICAgICAgICAgY29sQ291bnQgPSBjb2xzLmxlbmd0aDsKCiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBjb2xDb3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICBjZWxscy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICB0YWc6ICd0ZCcsCiAgICAgICAgICAgICAgICAgICAgaHRtbDogY29sc1tqXS5oZWFkZXIsCiAgICAgICAgICAgICAgICAgICAgY29sc3BhbjogY29sc1tqXS5zcGFuCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcm93c1tpXSA9IHsKICAgICAgICAgICAgICAgIHRhZzogJ3RyJywKICAgICAgICAgICAgICAgIGNuOiBjZWxscwogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gcm93czsKICAgIH0sCiAgICAKICAgIAogICAgcmVuZGVyVmVydGljYWxSb3dzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaGVhZGVycyAgPSB0aGlzLmJ1aWxkSGVhZGVycygpLAogICAgICAgICAgICBjb2xDb3VudCA9IGhlYWRlcnMubGVuZ3RoLAogICAgICAgICAgICByb3dDZWxscyA9IFtdLAogICAgICAgICAgICByb3dzICAgICA9IFtdLAogICAgICAgICAgICByb3dDb3VudCwgY29sLCByb3csIGNvbFdpZHRoLCBpLCBqOwogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb2xDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGNvbCA9IGhlYWRlcnNbaV07CiAgICAgICAgICAgIGNvbFdpZHRoID0gY29sLndpZHRoIHx8IDgwOwogICAgICAgICAgICByb3dDb3VudCA9IGNvbC5pdGVtcy5sZW5ndGg7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgcm93Q291bnQ7IGorKykgewogICAgICAgICAgICAgICAgcm93ID0gY29sLml0ZW1zW2pdOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByb3dDZWxsc1tyb3cuc3RhcnRdID0gcm93Q2VsbHNbcm93LnN0YXJ0XSB8fCBbXTsKICAgICAgICAgICAgICAgIHJvd0NlbGxzW3Jvdy5zdGFydF0ucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgdGFnICAgIDogJ3RkJywKICAgICAgICAgICAgICAgICAgICBodG1sICAgOiByb3cuaGVhZGVyLAogICAgICAgICAgICAgICAgICAgIHJvd3NwYW46IHJvdy5zcGFuLAogICAgICAgICAgICAgICAgICAgIHdpZHRoICA6IEV4dC5pc0JvcmRlckJveCA/IGNvbFdpZHRoIDogY29sV2lkdGggLSB0aGlzLnBhZGRpbmdXaWR0aAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcm93Q291bnQgPSByb3dDZWxscy5sZW5ndGg7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHJvd0NvdW50OyBpKyspIHsKICAgICAgICAgICAgcm93c1tpXSA9IHsKICAgICAgICAgICAgICAgIHRhZzogJ3RyJywKICAgICAgICAgICAgICAgIGNuIDogcm93Q2VsbHNbaV0KICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJvd3M7CiAgICB9LAogICAgCiAgICAKICAgIGdldFR1cGxlczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG5ld1N0b3JlID0gbmV3IEV4dC5kYXRhLlN0b3JlKHt9KTsKICAgICAgICAKICAgICAgICBuZXdTdG9yZS5kYXRhID0gdGhpcy5zdG9yZS5kYXRhLmNsb25lKCk7CiAgICAgICAgbmV3U3RvcmUuZmllbGRzID0gdGhpcy5zdG9yZS5maWVsZHM7CiAgICAgICAgCiAgICAgICAgdmFyIHNvcnRlcnMgICAgPSBbXSwKICAgICAgICAgICAgZGltZW5zaW9ucyA9IHRoaXMuZGltZW5zaW9ucywKICAgICAgICAgICAgbGVuZ3RoICAgICA9IGRpbWVuc2lvbnMubGVuZ3RoLAogICAgICAgICAgICBpOwogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBzb3J0ZXJzLnB1c2goewogICAgICAgICAgICAgICAgZmllbGQgICAgOiBkaW1lbnNpb25zW2ldLmRhdGFJbmRleCwKICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogZGltZW5zaW9uc1tpXS5kaXJlY3Rpb24gfHwgJ0FTQycKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIG5ld1N0b3JlLnNvcnQoc29ydGVycyk7CiAgICAgICAgCiAgICAgICAgdmFyIHJlY29yZHMgPSBuZXdTdG9yZS5kYXRhLml0ZW1zLAogICAgICAgICAgICBoYXNoZXMgID0gW10sCiAgICAgICAgICAgIHR1cGxlcyAgPSBbXSwKICAgICAgICAgICAgcmVjRGF0YSwgaGFzaCwgaW5mbywgZGF0YSwga2V5OwogICAgICAgIAogICAgICAgIGxlbmd0aCA9IHJlY29yZHMubGVuZ3RoOwogICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICBpbmZvID0gdGhpcy5nZXRSZWNvcmRJbmZvKHJlY29yZHNbaV0pOwogICAgICAgICAgICBkYXRhID0gaW5mby5kYXRhOwogICAgICAgICAgICBoYXNoID0gIiI7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGtleSBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgICBoYXNoICs9IGRhdGFba2V5XSArICctLS0nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaGFzaGVzLmluZGV4T2YoaGFzaCkgPT0gLTEpIHsKICAgICAgICAgICAgICAgIGhhc2hlcy5wdXNoKGhhc2gpOwogICAgICAgICAgICAgICAgdHVwbGVzLnB1c2goaW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgbmV3U3RvcmUuZGVzdHJveSgpOwogICAgICAgIAogICAgICAgIHJldHVybiB0dXBsZXM7CiAgICB9LAogICAgCiAgICAKICAgIGdldFJlY29yZEluZm86IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICAgIHZhciBkaW1lbnNpb25zID0gdGhpcy5kaW1lbnNpb25zLAogICAgICAgICAgICBsZW5ndGggID0gZGltZW5zaW9ucy5sZW5ndGgsCiAgICAgICAgICAgIGRhdGEgICAgPSB7fSwKICAgICAgICAgICAgZGltZW5zaW9uLCBkYXRhSW5kZXgsIGk7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGRpbWVuc2lvbiA9IGRpbWVuc2lvbnNbaV07CiAgICAgICAgICAgIGRhdGFJbmRleCA9IGRpbWVuc2lvbi5kYXRhSW5kZXg7CiAgICAgICAgICAgIAogICAgICAgICAgICBkYXRhW2RhdGFJbmRleF0gPSByZWNvcmQuZ2V0KGRhdGFJbmRleCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgIHZhciBjcmVhdGVNYXRjaGVyRnVuY3Rpb24gPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGRhdGFJbmRleCBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5nZXQoZGF0YUluZGV4KSAhPSBkYXRhW2RhdGFJbmRleF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH07CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICBtYXRjaGVyOiBjcmVhdGVNYXRjaGVyRnVuY3Rpb24oZGF0YSkKICAgICAgICB9OwogICAgfSwKICAgIAogICAgCiAgICBidWlsZEhlYWRlcnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0dXBsZXMgICAgID0gdGhpcy5nZXRUdXBsZXMoKSwKICAgICAgICAgICAgcm93Q291bnQgICA9IHR1cGxlcy5sZW5ndGgsCiAgICAgICAgICAgIGRpbWVuc2lvbnMgPSB0aGlzLmRpbWVuc2lvbnMsCiAgICAgICAgICAgIGRpbWVuc2lvbiwKICAgICAgICAgICAgY29sQ291bnQgICA9IGRpbWVuc2lvbnMubGVuZ3RoLAogICAgICAgICAgICBoZWFkZXJzICAgID0gW10sCiAgICAgICAgICAgIHR1cGxlLCByb3dzLCBjdXJyZW50SGVhZGVyLCBwcmV2aW91c0hlYWRlciwgc3Bhbiwgc3RhcnQsIGlzTGFzdCwgY2hhbmdlZCwgaSwgajsKICAgICAgICAKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29sQ291bnQ7IGkrKykgewogICAgICAgICAgICBkaW1lbnNpb24gPSBkaW1lbnNpb25zW2ldOwogICAgICAgICAgICByb3dzICA9IFtdOwogICAgICAgICAgICBzcGFuICA9IDA7CiAgICAgICAgICAgIHN0YXJ0ID0gMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCByb3dDb3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICB0dXBsZSAgPSB0dXBsZXNbal07CiAgICAgICAgICAgICAgICBpc0xhc3QgPSBqID09IChyb3dDb3VudCAtIDEpOwogICAgICAgICAgICAgICAgY3VycmVudEhlYWRlciA9IHR1cGxlLmRhdGFbZGltZW5zaW9uLmRhdGFJbmRleF07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY2hhbmdlZCA9IHByZXZpb3VzSGVhZGVyICE9IHVuZGVmaW5lZCAmJiBwcmV2aW91c0hlYWRlciAhPSBjdXJyZW50SGVhZGVyOwogICAgICAgICAgICAgICAgaWYgKGkgPiAwICYmIGogPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbmdlZCA9IGNoYW5nZWQgfHwgdHVwbGUuZGF0YVtkaW1lbnNpb25zW2ktMV0uZGF0YUluZGV4XSAhPSB0dXBsZXNbai0xXS5kYXRhW2RpbWVuc2lvbnNbaS0xXS5kYXRhSW5kZXhdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoY2hhbmdlZCkgeyAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcm93cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyOiBwcmV2aW91c0hlYWRlciwKICAgICAgICAgICAgICAgICAgICAgICAgc3BhbiAgOiBzcGFuLAogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA6IHN0YXJ0CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc3RhcnQgKz0gc3BhbjsKICAgICAgICAgICAgICAgICAgICBzcGFuID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGlzTGFzdCkgewogICAgICAgICAgICAgICAgICAgIHJvd3MucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcjogY3VycmVudEhlYWRlciwKICAgICAgICAgICAgICAgICAgICAgICAgc3BhbiAgOiBzcGFuICsgMSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgOiBzdGFydAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHN0YXJ0ICs9IHNwYW47CiAgICAgICAgICAgICAgICAgICAgc3BhbiA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHByZXZpb3VzSGVhZGVyID0gY3VycmVudEhlYWRlcjsKICAgICAgICAgICAgICAgIHNwYW4rKzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaGVhZGVycy5wdXNoKHsKICAgICAgICAgICAgICAgIGl0ZW1zOiByb3dzLAogICAgICAgICAgICAgICAgd2lkdGg6IGRpbWVuc2lvbi53aWR0aCB8fCB0aGlzLmRlZmF1bHRIZWFkZXJXaWR0aAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHByZXZpb3VzSGVhZGVyID0gdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gaGVhZGVyczsKICAgIH0KfSk7CgoKRXh0LmdyaWQuSGVhZGVyRHJhZ1pvbmUgPSBFeHQuZXh0ZW5kKEV4dC5kZC5EcmFnWm9uZSwgewogICAgbWF4RHJhZ1dpZHRoOiAxMjAsCiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oZ3JpZCwgaGQsIGhkMil7CiAgICAgICAgdGhpcy5ncmlkID0gZ3JpZDsKICAgICAgICB0aGlzLnZpZXcgPSBncmlkLmdldFZpZXcoKTsKICAgICAgICB0aGlzLmRkR3JvdXAgPSAiZ3JpZEhlYWRlciIgKyB0aGlzLmdyaWQuZ2V0R3JpZEVsKCkuaWQ7CiAgICAgICAgRXh0LmdyaWQuSGVhZGVyRHJhZ1pvbmUuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGhkKTsKICAgICAgICBpZihoZDIpewogICAgICAgICAgICB0aGlzLnNldEhhbmRsZUVsSWQoRXh0LmlkKGhkKSk7CiAgICAgICAgICAgIHRoaXMuc2V0T3V0ZXJIYW5kbGVFbElkKEV4dC5pZChoZDIpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zY3JvbGwgPSBmYWxzZTsKICAgIH0sCiAgICAKICAgIGdldERyYWdEYXRhIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIHQgPSBFeHQubGliLkV2ZW50LmdldFRhcmdldChlKSwKICAgICAgICAgICAgaCA9IHRoaXMudmlldy5maW5kSGVhZGVyQ2VsbCh0KTsKICAgICAgICBpZihoKXsKICAgICAgICAgICAgcmV0dXJuIHtkZGVsOiBoLmZpcnN0Q2hpbGQsIGhlYWRlcjpofTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICBvbkluaXREcmFnIDogZnVuY3Rpb24oZSl7CiAgICAgICAgCiAgICAgICAgdGhpcy5kcmFnSGVhZGVyc0Rpc2FibGVkID0gdGhpcy52aWV3LmhlYWRlcnNEaXNhYmxlZDsKICAgICAgICB0aGlzLnZpZXcuaGVhZGVyc0Rpc2FibGVkID0gdHJ1ZTsKICAgICAgICB2YXIgY2xvbmUgPSB0aGlzLmRyYWdEYXRhLmRkZWwuY2xvbmVOb2RlKHRydWUpOwogICAgICAgIGNsb25lLmlkID0gRXh0LmlkKCk7CiAgICAgICAgY2xvbmUuc3R5bGUud2lkdGggPSBNYXRoLm1pbih0aGlzLmRyYWdEYXRhLmhlYWRlci5vZmZzZXRXaWR0aCx0aGlzLm1heERyYWdXaWR0aCkgKyAicHgiOwogICAgICAgIHRoaXMucHJveHkudXBkYXRlKGNsb25lKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgYWZ0ZXJWYWxpZERyb3AgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuY29tcGxldGVEcm9wKCk7CiAgICB9LAoKICAgIGFmdGVySW52YWxpZERyb3AgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuY29tcGxldGVEcm9wKCk7CiAgICB9LAogICAgCiAgICBjb21wbGV0ZURyb3A6IGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHYgPSB0aGlzLnZpZXcsCiAgICAgICAgICAgIGRpc2FibGVkID0gdGhpcy5kcmFnSGVhZGVyc0Rpc2FibGVkOwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgdi5oZWFkZXJzRGlzYWJsZWQgPSBkaXNhYmxlZDsKICAgICAgICB9LCA1MCk7CiAgICB9Cn0pOwoKCgpFeHQuZ3JpZC5IZWFkZXJEcm9wWm9uZSA9IEV4dC5leHRlbmQoRXh0LmRkLkRyb3Bab25lLCB7CiAgICBwcm94eU9mZnNldHMgOiBbLTQsIC05XSwKICAgIGZseTogRXh0LkVsZW1lbnQuZmx5LAogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGdyaWQsIGhkLCBoZDIpewogICAgICAgIHRoaXMuZ3JpZCA9IGdyaWQ7CiAgICAgICAgdGhpcy52aWV3ID0gZ3JpZC5nZXRWaWV3KCk7CiAgICAgICAgCiAgICAgICAgdGhpcy5wcm94eVRvcCA9IEV4dC5Eb21IZWxwZXIuYXBwZW5kKGRvY3VtZW50LmJvZHksIHsKICAgICAgICAgICAgY2xzOiJjb2wtbW92ZS10b3AiLCBodG1sOiImIzE2MDsiCiAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5wcm94eUJvdHRvbSA9IEV4dC5Eb21IZWxwZXIuYXBwZW5kKGRvY3VtZW50LmJvZHksIHsKICAgICAgICAgICAgY2xzOiJjb2wtbW92ZS1ib3R0b20iLCBodG1sOiImIzE2MDsiCiAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5wcm94eVRvcC5oaWRlID0gdGhpcy5wcm94eUJvdHRvbS5oaWRlID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgdGhpcy5zZXRMZWZ0VG9wKC0xMDAsLTEwMCk7CiAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUoInZpc2liaWxpdHkiLCAiaGlkZGVuIik7CiAgICAgICAgfTsKICAgICAgICB0aGlzLmRkR3JvdXAgPSAiZ3JpZEhlYWRlciIgKyB0aGlzLmdyaWQuZ2V0R3JpZEVsKCkuaWQ7CiAgICAgICAgCiAgICAgICAgCiAgICAgICAgRXh0LmdyaWQuSGVhZGVyRHJvcFpvbmUuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGdyaWQuZ2V0R3JpZEVsKCkuZG9tKTsKICAgIH0sCgogICAgZ2V0VGFyZ2V0RnJvbUV2ZW50IDogZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIHQgPSBFeHQubGliLkV2ZW50LmdldFRhcmdldChlKSwKICAgICAgICAgICAgY2luZGV4ID0gdGhpcy52aWV3LmZpbmRDZWxsSW5kZXgodCk7CiAgICAgICAgaWYoY2luZGV4ICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnZpZXcuZ2V0SGVhZGVyQ2VsbChjaW5kZXgpOwogICAgICAgIH0KICAgIH0sCgogICAgbmV4dFZpc2libGUgOiBmdW5jdGlvbihoKXsKICAgICAgICB2YXIgdiA9IHRoaXMudmlldywgY20gPSB0aGlzLmdyaWQuY29sTW9kZWw7CiAgICAgICAgaCA9IGgubmV4dFNpYmxpbmc7CiAgICAgICAgd2hpbGUoaCl7CiAgICAgICAgICAgIGlmKCFjbS5pc0hpZGRlbih2LmdldENlbGxJbmRleChoKSkpewogICAgICAgICAgICAgICAgcmV0dXJuIGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaCA9IGgubmV4dFNpYmxpbmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICBwcmV2VmlzaWJsZSA6IGZ1bmN0aW9uKGgpewogICAgICAgIHZhciB2ID0gdGhpcy52aWV3LCBjbSA9IHRoaXMuZ3JpZC5jb2xNb2RlbDsKICAgICAgICBoID0gaC5wcmV2U2libGluZzsKICAgICAgICB3aGlsZShoKXsKICAgICAgICAgICAgaWYoIWNtLmlzSGlkZGVuKHYuZ2V0Q2VsbEluZGV4KGgpKSl7CiAgICAgICAgICAgICAgICByZXR1cm4gaDsKICAgICAgICAgICAgfQogICAgICAgICAgICBoID0gaC5wcmV2U2libGluZzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIHBvc2l0aW9uSW5kaWNhdG9yIDogZnVuY3Rpb24oaCwgbiwgZSl7CiAgICAgICAgdmFyIHggPSBFeHQubGliLkV2ZW50LmdldFBhZ2VYKGUpLAogICAgICAgICAgICByID0gRXh0LmxpYi5Eb20uZ2V0UmVnaW9uKG4uZmlyc3RDaGlsZCksCiAgICAgICAgICAgIHB4LCAKICAgICAgICAgICAgcHQsIAogICAgICAgICAgICBweSA9IHIudG9wICsgdGhpcy5wcm94eU9mZnNldHNbMV07CiAgICAgICAgaWYoKHIucmlnaHQgLSB4KSA8PSAoci5yaWdodC1yLmxlZnQpLzIpewogICAgICAgICAgICBweCA9IHIucmlnaHQrdGhpcy52aWV3LmJvcmRlcldpZHRoOwogICAgICAgICAgICBwdCA9ICJhZnRlciI7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHB4ID0gci5sZWZ0OwogICAgICAgICAgICBwdCA9ICJiZWZvcmUiOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5ncmlkLmNvbE1vZGVsLmlzRml4ZWQodGhpcy52aWV3LmdldENlbGxJbmRleChuKSkpewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBweCArPSAgdGhpcy5wcm94eU9mZnNldHNbMF07CiAgICAgICAgdGhpcy5wcm94eVRvcC5zZXRMZWZ0VG9wKHB4LCBweSk7CiAgICAgICAgdGhpcy5wcm94eVRvcC5zaG93KCk7CiAgICAgICAgaWYoIXRoaXMuYm90dG9tT2Zmc2V0KXsKICAgICAgICAgICAgdGhpcy5ib3R0b21PZmZzZXQgPSB0aGlzLnZpZXcubWFpbkhkLmdldEhlaWdodCgpOwogICAgICAgIH0KICAgICAgICB0aGlzLnByb3h5Qm90dG9tLnNldExlZnRUb3AocHgsIHB5K3RoaXMucHJveHlUb3AuZG9tLm9mZnNldEhlaWdodCt0aGlzLmJvdHRvbU9mZnNldCk7CiAgICAgICAgdGhpcy5wcm94eUJvdHRvbS5zaG93KCk7CiAgICAgICAgcmV0dXJuIHB0OwogICAgfSwKCiAgICBvbk5vZGVFbnRlciA6IGZ1bmN0aW9uKG4sIGRkLCBlLCBkYXRhKXsKICAgICAgICBpZihkYXRhLmhlYWRlciAhPSBuKXsKICAgICAgICAgICAgdGhpcy5wb3NpdGlvbkluZGljYXRvcihkYXRhLmhlYWRlciwgbiwgZSk7CiAgICAgICAgfQogICAgfSwKCiAgICBvbk5vZGVPdmVyIDogZnVuY3Rpb24obiwgZGQsIGUsIGRhdGEpewogICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKICAgICAgICBpZihkYXRhLmhlYWRlciAhPSBuKXsKICAgICAgICAgICAgcmVzdWx0ID0gdGhpcy5wb3NpdGlvbkluZGljYXRvcihkYXRhLmhlYWRlciwgbiwgZSk7CiAgICAgICAgfQogICAgICAgIGlmKCFyZXN1bHQpewogICAgICAgICAgICB0aGlzLnByb3h5VG9wLmhpZGUoKTsKICAgICAgICAgICAgdGhpcy5wcm94eUJvdHRvbS5oaWRlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQgPyB0aGlzLmRyb3BBbGxvd2VkIDogdGhpcy5kcm9wTm90QWxsb3dlZDsKICAgIH0sCgogICAgb25Ob2RlT3V0IDogZnVuY3Rpb24obiwgZGQsIGUsIGRhdGEpewogICAgICAgIHRoaXMucHJveHlUb3AuaGlkZSgpOwogICAgICAgIHRoaXMucHJveHlCb3R0b20uaGlkZSgpOwogICAgfSwKCiAgICBvbk5vZGVEcm9wIDogZnVuY3Rpb24obiwgZGQsIGUsIGRhdGEpewogICAgICAgIHZhciBoID0gZGF0YS5oZWFkZXI7CiAgICAgICAgaWYoaCAhPSBuKXsKICAgICAgICAgICAgdmFyIGNtID0gdGhpcy5ncmlkLmNvbE1vZGVsLAogICAgICAgICAgICAgICAgeCA9IEV4dC5saWIuRXZlbnQuZ2V0UGFnZVgoZSksCiAgICAgICAgICAgICAgICByID0gRXh0LmxpYi5Eb20uZ2V0UmVnaW9uKG4uZmlyc3RDaGlsZCksCiAgICAgICAgICAgICAgICBwdCA9IChyLnJpZ2h0IC0geCkgPD0gKChyLnJpZ2h0LXIubGVmdCkvMikgPyAiYWZ0ZXIiIDogImJlZm9yZSIsCiAgICAgICAgICAgICAgICBvbGRJbmRleCA9IHRoaXMudmlldy5nZXRDZWxsSW5kZXgoaCksCiAgICAgICAgICAgICAgICBuZXdJbmRleCA9IHRoaXMudmlldy5nZXRDZWxsSW5kZXgobik7CiAgICAgICAgICAgIGlmKHB0ID09ICJhZnRlciIpewogICAgICAgICAgICAgICAgbmV3SW5kZXgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihvbGRJbmRleCA8IG5ld0luZGV4KXsKICAgICAgICAgICAgICAgIG5ld0luZGV4LS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY20ubW92ZUNvbHVtbihvbGRJbmRleCwgbmV3SW5kZXgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9KTsKCkV4dC5ncmlkLkdyaWRWaWV3LkNvbHVtbkRyYWdab25lID0gRXh0LmV4dGVuZChFeHQuZ3JpZC5IZWFkZXJEcmFnWm9uZSwgewogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGdyaWQsIGhkKXsKICAgICAgICBFeHQuZ3JpZC5HcmlkVmlldy5Db2x1bW5EcmFnWm9uZS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgZ3JpZCwgaGQsIG51bGwpOwogICAgICAgIHRoaXMucHJveHkuZWwuYWRkQ2xhc3MoJ3gtZ3JpZDMtY29sLWRkJyk7CiAgICB9LAogICAgCiAgICBoYW5kbGVNb3VzZURvd24gOiBmdW5jdGlvbihlKXsKICAgIH0sCgogICAgY2FsbEhhbmRsZU1vdXNlRG93biA6IGZ1bmN0aW9uKGUpewogICAgICAgIEV4dC5ncmlkLkdyaWRWaWV3LkNvbHVtbkRyYWdab25lLnN1cGVyY2xhc3MuaGFuZGxlTW91c2VEb3duLmNhbGwodGhpcywgZSk7CiAgICB9Cn0pOwoKRXh0LmdyaWQuU3BsaXREcmFnWm9uZSA9IEV4dC5leHRlbmQoRXh0LmRkLkREUHJveHksIHsKICAgIGZseTogRXh0LkVsZW1lbnQuZmx5LAogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGdyaWQsIGhkLCBoZDIpewogICAgICAgIHRoaXMuZ3JpZCA9IGdyaWQ7CiAgICAgICAgdGhpcy52aWV3ID0gZ3JpZC5nZXRWaWV3KCk7CiAgICAgICAgdGhpcy5wcm94eSA9IHRoaXMudmlldy5yZXNpemVQcm94eTsKICAgICAgICBFeHQuZ3JpZC5TcGxpdERyYWdab25lLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLCBoZCwKICAgICAgICAgICAgImdyaWRTcGxpdHRlcnMiICsgdGhpcy5ncmlkLmdldEdyaWRFbCgpLmlkLCB7CiAgICAgICAgICAgIGRyYWdFbElkIDogRXh0LmlkKHRoaXMucHJveHkuZG9tKSwgcmVzaXplRnJhbWU6ZmFsc2UKICAgICAgICB9KTsKICAgICAgICB0aGlzLnNldEhhbmRsZUVsSWQoRXh0LmlkKGhkKSk7CiAgICAgICAgdGhpcy5zZXRPdXRlckhhbmRsZUVsSWQoRXh0LmlkKGhkMikpOwogICAgICAgIHRoaXMuc2Nyb2xsID0gZmFsc2U7CiAgICB9LAoKICAgIGI0U3RhcnREcmFnIDogZnVuY3Rpb24oeCwgeSl7CiAgICAgICAgdGhpcy52aWV3LmhlYWRlcnNEaXNhYmxlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wcm94eS5zZXRIZWlnaHQodGhpcy52aWV3Lm1haW5XcmFwLmdldEhlaWdodCgpKTsKICAgICAgICB2YXIgdyA9IHRoaXMuY20uZ2V0Q29sdW1uV2lkdGgodGhpcy5jZWxsSW5kZXgpOwogICAgICAgIHZhciBtaW53ID0gTWF0aC5tYXgody10aGlzLmdyaWQubWluQ29sdW1uV2lkdGgsIDApOwogICAgICAgIHRoaXMucmVzZXRDb25zdHJhaW50cygpOwogICAgICAgIHRoaXMuc2V0WENvbnN0cmFpbnQobWludywgMTAwMCk7CiAgICAgICAgdGhpcy5zZXRZQ29uc3RyYWludCgwLCAwKTsKICAgICAgICB0aGlzLm1pblggPSB4IC0gbWludzsKICAgICAgICB0aGlzLm1heFggPSB4ICsgMTAwMDsKICAgICAgICB0aGlzLnN0YXJ0UG9zID0geDsKICAgICAgICBFeHQuZGQuRERQcm94eS5wcm90b3R5cGUuYjRTdGFydERyYWcuY2FsbCh0aGlzLCB4LCB5KTsKICAgIH0sCgoKICAgIGhhbmRsZU1vdXNlRG93biA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciBldiA9IEV4dC5FdmVudE9iamVjdC5zZXRFdmVudChlKTsKICAgICAgICB2YXIgdCA9IHRoaXMuZmx5KGV2LmdldFRhcmdldCgpKTsKICAgICAgICBpZih0Lmhhc0NsYXNzKCJ4LWdyaWQtc3BsaXQiKSl7CiAgICAgICAgICAgIHRoaXMuY2VsbEluZGV4ID0gdGhpcy52aWV3LmdldENlbGxJbmRleCh0LmRvbSk7CiAgICAgICAgICAgIHRoaXMuc3BsaXQgPSB0LmRvbTsKICAgICAgICAgICAgdGhpcy5jbSA9IHRoaXMuZ3JpZC5jb2xNb2RlbDsKICAgICAgICAgICAgaWYodGhpcy5jbS5pc1Jlc2l6YWJsZSh0aGlzLmNlbGxJbmRleCkgJiYgIXRoaXMuY20uaXNGaXhlZCh0aGlzLmNlbGxJbmRleCkpewogICAgICAgICAgICAgICAgRXh0LmdyaWQuU3BsaXREcmFnWm9uZS5zdXBlcmNsYXNzLmhhbmRsZU1vdXNlRG93bi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICBlbmREcmFnIDogZnVuY3Rpb24oZSl7CiAgICAgICAgdGhpcy52aWV3LmhlYWRlcnNEaXNhYmxlZCA9IGZhbHNlOwogICAgICAgIHZhciBlbmRYID0gTWF0aC5tYXgodGhpcy5taW5YLCBFeHQubGliLkV2ZW50LmdldFBhZ2VYKGUpKTsKICAgICAgICB2YXIgZGlmZiA9IGVuZFggLSB0aGlzLnN0YXJ0UG9zOwogICAgICAgIHRoaXMudmlldy5vbkNvbHVtblNwbGl0dGVyTW92ZWQodGhpcy5jZWxsSW5kZXgsIHRoaXMuY20uZ2V0Q29sdW1uV2lkdGgodGhpcy5jZWxsSW5kZXgpK2RpZmYpOwogICAgfSwKCiAgICBhdXRvT2Zmc2V0IDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnNldERlbHRhKDAsMCk7CiAgICB9Cn0pOwpFeHQuZ3JpZC5HcmlkRHJhZ1pvbmUgPSBmdW5jdGlvbihncmlkLCBjb25maWcpewogICAgdGhpcy52aWV3ID0gZ3JpZC5nZXRWaWV3KCk7CiAgICBFeHQuZ3JpZC5HcmlkRHJhZ1pvbmUuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIHRoaXMudmlldy5tYWluQm9keS5kb20sIGNvbmZpZyk7CiAgICB0aGlzLnNjcm9sbCA9IGZhbHNlOwogICAgdGhpcy5ncmlkID0gZ3JpZDsKICAgIHRoaXMuZGRlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgdGhpcy5kZGVsLmNsYXNzTmFtZSA9ICd4LWdyaWQtZGQtd3JhcCc7Cn07CgpFeHQuZXh0ZW5kKEV4dC5ncmlkLkdyaWREcmFnWm9uZSwgRXh0LmRkLkRyYWdab25lLCB7CiAgICBkZEdyb3VwIDogIkdyaWRERCIsCgogICAgCiAgICBnZXREcmFnRGF0YSA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciB0ID0gRXh0LmxpYi5FdmVudC5nZXRUYXJnZXQoZSk7CiAgICAgICAgdmFyIHJvd0luZGV4ID0gdGhpcy52aWV3LmZpbmRSb3dJbmRleCh0KTsKICAgICAgICBpZihyb3dJbmRleCAhPT0gZmFsc2UpewogICAgICAgICAgICB2YXIgc20gPSB0aGlzLmdyaWQuc2VsTW9kZWw7CiAgICAgICAgICAgIGlmKCFzbS5pc1NlbGVjdGVkKHJvd0luZGV4KSB8fCBlLmhhc01vZGlmaWVyKCkpewogICAgICAgICAgICAgICAgc20uaGFuZGxlTW91c2VEb3duKHRoaXMuZ3JpZCwgcm93SW5kZXgsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB7Z3JpZDogdGhpcy5ncmlkLCBkZGVsOiB0aGlzLmRkZWwsIHJvd0luZGV4OiByb3dJbmRleCwgc2VsZWN0aW9uczpzbS5nZXRTZWxlY3Rpb25zKCl9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIAogICAgb25Jbml0RHJhZyA6IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciBkYXRhID0gdGhpcy5kcmFnRGF0YTsKICAgICAgICB0aGlzLmRkZWwuaW5uZXJIVE1MID0gdGhpcy5ncmlkLmdldERyYWdEcm9wVGV4dCgpOwogICAgICAgIHRoaXMucHJveHkudXBkYXRlKHRoaXMuZGRlbCk7CiAgICAgICAgCiAgICB9LAoKICAgIAogICAgYWZ0ZXJSZXBhaXIgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKICAgIH0sCgogICAgCiAgICBnZXRSZXBhaXJYWSA6IGZ1bmN0aW9uKGUsIGRhdGEpewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgb25FbmREcmFnIDogZnVuY3Rpb24oZGF0YSwgZSl7CiAgICAgICAgCiAgICB9LAoKICAgIG9uVmFsaWREcm9wIDogZnVuY3Rpb24oZGQsIGUsIGlkKXsKICAgICAgICAKICAgICAgICB0aGlzLmhpZGVQcm94eSgpOwogICAgfSwKCiAgICBiZWZvcmVJbnZhbGlkRHJvcCA6IGZ1bmN0aW9uKGUsIGlkKXsKCiAgICB9Cn0pOwoKRXh0LmdyaWQuQ29sdW1uTW9kZWwgPSBFeHQuZXh0ZW5kKEV4dC51dGlsLk9ic2VydmFibGUsIHsKICAgIAogICAgZGVmYXVsdFdpZHRoOiAxMDAsCgogICAgCiAgICBkZWZhdWx0U29ydGFibGU6IGZhbHNlLAoKICAgIAoKICAgIAoKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgCgkgICAgaWYgKGNvbmZpZy5jb2x1bW5zKSB7CgkgICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwoJICAgICAgICB0aGlzLnNldENvbmZpZyhjb25maWcuY29sdW1ucywgdHJ1ZSk7CgkgICAgfSBlbHNlIHsKCSAgICAgICAgdGhpcy5zZXRDb25maWcoY29uZmlnLCB0cnVlKTsKCSAgICB9CgkgICAgCgkgICAgdGhpcy5hZGRFdmVudHMoCgkgICAgICAgIAoJICAgICAgICAid2lkdGhjaGFuZ2UiLAoJICAgICAgICAKCSAgICAgICAgCgkgICAgICAgICJoZWFkZXJjaGFuZ2UiLAoJICAgICAgICAKCSAgICAgICAgCgkgICAgICAgICJoaWRkZW5jaGFuZ2UiLAoJICAgICAgICAKCSAgICAgICAgCgkgICAgICAgICJjb2x1bW5tb3ZlZCIsCgkgICAgICAgIAoJICAgICAgICAKCSAgICAgICAgImNvbmZpZ2NoYW5nZSIKCSAgICApOwoJICAgIAoJICAgIEV4dC5ncmlkLkNvbHVtbk1vZGVsLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBnZXRDb2x1bW5JZCA6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uZmlnW2luZGV4XS5pZDsKICAgIH0sCgogICAgZ2V0Q29sdW1uQXQgOiBmdW5jdGlvbihpbmRleCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ1tpbmRleF07CiAgICB9LAoKICAgIAogICAgc2V0Q29uZmlnIDogZnVuY3Rpb24oY29uZmlnLCBpbml0aWFsKSB7CiAgICAgICAgdmFyIGksIGMsIGxlbjsKICAgICAgICAKICAgICAgICBpZiAoIWluaXRpYWwpIHsgCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnRvdGFsV2lkdGg7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSB0aGlzLmNvbmZpZy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgYyA9IHRoaXMuY29uZmlnW2ldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoYy5zZXRFZGl0b3IpIHsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBjLnNldEVkaXRvcihudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgCiAgICAgICAgdGhpcy5kZWZhdWx0cyA9IEV4dC5hcHBseSh7CiAgICAgICAgICAgIHdpZHRoOiB0aGlzLmRlZmF1bHRXaWR0aCwKICAgICAgICAgICAgc29ydGFibGU6IHRoaXMuZGVmYXVsdFNvcnRhYmxlCiAgICAgICAgfSwgdGhpcy5kZWZhdWx0cyk7CgogICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnOwogICAgICAgIHRoaXMubG9va3VwID0ge307CgogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGNvbmZpZy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICBjID0gRXh0LmFwcGx5SWYoY29uZmlnW2ldLCB0aGlzLmRlZmF1bHRzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoRXh0LmlzRW1wdHkoYy5pZCkpIHsKICAgICAgICAgICAgICAgIGMuaWQgPSBpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWMuaXNDb2x1bW4pIHsKICAgICAgICAgICAgICAgIHZhciBDbHMgPSBFeHQuZ3JpZC5Db2x1bW4udHlwZXNbYy54dHlwZSB8fCAnZ3JpZGNvbHVtbiddOwogICAgICAgICAgICAgICAgYyA9IG5ldyBDbHMoYyk7CiAgICAgICAgICAgICAgICBjb25maWdbaV0gPSBjOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmxvb2t1cFtjLmlkXSA9IGM7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgnY29uZmlnY2hhbmdlJywgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldENvbHVtbkJ5SWQgOiBmdW5jdGlvbihpZCkgewogICAgICAgIHJldHVybiB0aGlzLmxvb2t1cFtpZF07CiAgICB9LAoKICAgIAogICAgZ2V0SW5kZXhCeUlkIDogZnVuY3Rpb24oaWQpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5jb25maWcubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKHRoaXMuY29uZmlnW2ldLmlkID09IGlkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9LAoKICAgIAogICAgbW92ZUNvbHVtbiA6IGZ1bmN0aW9uKG9sZEluZGV4LCBuZXdJbmRleCkgewogICAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZywKICAgICAgICAgICAgYyAgICAgID0gY29uZmlnW29sZEluZGV4XTsKICAgICAgICAgICAgCiAgICAgICAgY29uZmlnLnNwbGljZShvbGRJbmRleCwgMSk7CiAgICAgICAgY29uZmlnLnNwbGljZShuZXdJbmRleCwgMCwgYyk7CiAgICAgICAgdGhpcy5kYXRhTWFwID0gbnVsbDsKICAgICAgICB0aGlzLmZpcmVFdmVudCgiY29sdW1ubW92ZWQiLCB0aGlzLCBvbGRJbmRleCwgbmV3SW5kZXgpOwogICAgfSwKCiAgICAKICAgIGdldENvbHVtbkNvdW50IDogZnVuY3Rpb24odmlzaWJsZU9ubHkpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gdGhpcy5jb25maWcubGVuZ3RoLAogICAgICAgICAgICBjID0gMCwKICAgICAgICAgICAgaTsKICAgICAgICAKICAgICAgICBpZiAodmlzaWJsZU9ubHkgPT09IHRydWUpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNIaWRkZW4oaSkpIHsKICAgICAgICAgICAgICAgICAgICBjKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBjOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gbGVuZ3RoOwogICAgfSwKCiAgICAKICAgIGdldENvbHVtbnNCeSA6IGZ1bmN0aW9uKGZuLCBzY29wZSkgewogICAgICAgIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZywKICAgICAgICAgICAgbGVuZ3RoID0gY29uZmlnLmxlbmd0aCwKICAgICAgICAgICAgcmVzdWx0ID0gW10sCiAgICAgICAgICAgIGksIGM7CiAgICAgICAgICAgIAogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGMgPSBjb25maWdbaV07CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoZm4uY2FsbChzY29wZSB8fCB0aGlzLCBjLCBpKSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgcmVzdWx0W3Jlc3VsdC5sZW5ndGhdID0gYzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKCiAgICAKICAgIGlzU29ydGFibGUgOiBmdW5jdGlvbihjb2wpIHsKICAgICAgICByZXR1cm4gISF0aGlzLmNvbmZpZ1tjb2xdLnNvcnRhYmxlOwogICAgfSwKCiAgICAKICAgIGlzTWVudURpc2FibGVkIDogZnVuY3Rpb24oY29sKSB7CiAgICAgICAgcmV0dXJuICEhdGhpcy5jb25maWdbY29sXS5tZW51RGlzYWJsZWQ7CiAgICB9LAoKICAgIAogICAgZ2V0UmVuZGVyZXIgOiBmdW5jdGlvbihjb2wpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25maWdbY29sXS5yZW5kZXJlciB8fCBFeHQuZ3JpZC5Db2x1bW5Nb2RlbC5kZWZhdWx0UmVuZGVyZXI7CiAgICB9LAoKICAgIGdldFJlbmRlcmVyU2NvcGUgOiBmdW5jdGlvbihjb2wpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25maWdbY29sXS5zY29wZTsKICAgIH0sCgogICAgCiAgICBzZXRSZW5kZXJlciA6IGZ1bmN0aW9uKGNvbCwgZm4pIHsKICAgICAgICB0aGlzLmNvbmZpZ1tjb2xdLnJlbmRlcmVyID0gZm47CiAgICB9LAoKICAgIAogICAgZ2V0Q29sdW1uV2lkdGggOiBmdW5jdGlvbihjb2wpIHsKICAgICAgICB2YXIgd2lkdGggPSB0aGlzLmNvbmZpZ1tjb2xdLndpZHRoOwogICAgICAgIGlmKHR5cGVvZiB3aWR0aCAhPSAnbnVtYmVyJyl7CiAgICAgICAgICAgIHdpZHRoID0gdGhpcy5kZWZhdWx0V2lkdGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiB3aWR0aDsKICAgIH0sCgogICAgCiAgICBzZXRDb2x1bW5XaWR0aCA6IGZ1bmN0aW9uKGNvbCwgd2lkdGgsIHN1cHByZXNzRXZlbnQpIHsKICAgICAgICB0aGlzLmNvbmZpZ1tjb2xdLndpZHRoID0gd2lkdGg7CiAgICAgICAgdGhpcy50b3RhbFdpZHRoID0gbnVsbDsKICAgICAgICAKICAgICAgICBpZiAoIXN1cHByZXNzRXZlbnQpIHsKICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJ3aWR0aGNoYW5nZSIsIHRoaXMsIGNvbCwgd2lkdGgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBnZXRUb3RhbFdpZHRoIDogZnVuY3Rpb24oaW5jbHVkZUhpZGRlbikgewogICAgICAgIGlmICghdGhpcy50b3RhbFdpZHRoKSB7CiAgICAgICAgICAgIHRoaXMudG90YWxXaWR0aCA9IDA7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmNvbmZpZy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVIaWRkZW4gfHwgIXRoaXMuaXNIaWRkZW4oaSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRvdGFsV2lkdGggKz0gdGhpcy5nZXRDb2x1bW5XaWR0aChpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy50b3RhbFdpZHRoOwogICAgfSwKCiAgICAKICAgIGdldENvbHVtbkhlYWRlciA6IGZ1bmN0aW9uKGNvbCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ1tjb2xdLmhlYWRlcjsKICAgIH0sCgogICAgCiAgICBzZXRDb2x1bW5IZWFkZXIgOiBmdW5jdGlvbihjb2wsIGhlYWRlcikgewogICAgICAgIHRoaXMuY29uZmlnW2NvbF0uaGVhZGVyID0gaGVhZGVyOwogICAgICAgIHRoaXMuZmlyZUV2ZW50KCJoZWFkZXJjaGFuZ2UiLCB0aGlzLCBjb2wsIGhlYWRlcik7CiAgICB9LAoKICAgIAogICAgZ2V0Q29sdW1uVG9vbHRpcCA6IGZ1bmN0aW9uKGNvbCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5jb25maWdbY29sXS50b29sdGlwOwogICAgfSwKICAgIAogICAgc2V0Q29sdW1uVG9vbHRpcCA6IGZ1bmN0aW9uKGNvbCwgdG9vbHRpcCkgewogICAgICAgICAgICB0aGlzLmNvbmZpZ1tjb2xdLnRvb2x0aXAgPSB0b29sdGlwOwogICAgfSwKCiAgICAKICAgIGdldERhdGFJbmRleCA6IGZ1bmN0aW9uKGNvbCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ1tjb2xdLmRhdGFJbmRleDsKICAgIH0sCgogICAgCiAgICBzZXREYXRhSW5kZXggOiBmdW5jdGlvbihjb2wsIGRhdGFJbmRleCkgewogICAgICAgIHRoaXMuY29uZmlnW2NvbF0uZGF0YUluZGV4ID0gZGF0YUluZGV4OwogICAgfSwKCiAgICAKICAgIGZpbmRDb2x1bW5JbmRleCA6IGZ1bmN0aW9uKGRhdGFJbmRleCkgewogICAgICAgIHZhciBjID0gdGhpcy5jb25maWc7CiAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gYy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGlmKGNbaV0uZGF0YUluZGV4ID09IGRhdGFJbmRleCl7CiAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICB9LAoKICAgIAogICAgaXNDZWxsRWRpdGFibGUgOiBmdW5jdGlvbihjb2xJbmRleCwgcm93SW5kZXgpIHsKICAgICAgICB2YXIgYyA9IHRoaXMuY29uZmlnW2NvbEluZGV4XSwKICAgICAgICAgICAgZWQgPSBjLmVkaXRhYmxlOwoKICAgICAgICAKICAgICAgICByZXR1cm4gISEoZWQgfHwgKCFFeHQuaXNEZWZpbmVkKGVkKSAmJiBjLmVkaXRvcikpOwogICAgfSwKCiAgICAKICAgIGdldENlbGxFZGl0b3IgOiBmdW5jdGlvbihjb2xJbmRleCwgcm93SW5kZXgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25maWdbY29sSW5kZXhdLmdldENlbGxFZGl0b3Iocm93SW5kZXgpOwogICAgfSwKCiAgICAKICAgIHNldEVkaXRhYmxlIDogZnVuY3Rpb24oY29sLCBlZGl0YWJsZSkgewogICAgICAgIHRoaXMuY29uZmlnW2NvbF0uZWRpdGFibGUgPSBlZGl0YWJsZTsKICAgIH0sCgogICAgCiAgICBpc0hpZGRlbiA6IGZ1bmN0aW9uKGNvbEluZGV4KSB7CiAgICAgICAgcmV0dXJuICEhdGhpcy5jb25maWdbY29sSW5kZXhdLmhpZGRlbjsgCiAgICB9LAoKICAgIAogICAgaXNGaXhlZCA6IGZ1bmN0aW9uKGNvbEluZGV4KSB7CiAgICAgICAgcmV0dXJuICEhdGhpcy5jb25maWdbY29sSW5kZXhdLmZpeGVkOwogICAgfSwKCiAgICAKICAgIGlzUmVzaXphYmxlIDogZnVuY3Rpb24oY29sSW5kZXgpIHsKICAgICAgICByZXR1cm4gY29sSW5kZXggPj0gMCAmJiB0aGlzLmNvbmZpZ1tjb2xJbmRleF0ucmVzaXphYmxlICE9PSBmYWxzZSAmJiB0aGlzLmNvbmZpZ1tjb2xJbmRleF0uZml4ZWQgIT09IHRydWU7CiAgICB9LAogICAgCiAgICAKICAgIHNldEhpZGRlbiA6IGZ1bmN0aW9uKGNvbEluZGV4LCBoaWRkZW4pIHsKICAgICAgICB2YXIgYyA9IHRoaXMuY29uZmlnW2NvbEluZGV4XTsKICAgICAgICBpZihjLmhpZGRlbiAhPT0gaGlkZGVuKXsKICAgICAgICAgICAgYy5oaWRkZW4gPSBoaWRkZW47CiAgICAgICAgICAgIHRoaXMudG90YWxXaWR0aCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJoaWRkZW5jaGFuZ2UiLCB0aGlzLCBjb2xJbmRleCwgaGlkZGVuKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgc2V0RWRpdG9yIDogZnVuY3Rpb24oY29sLCBlZGl0b3IpIHsKICAgICAgICB0aGlzLmNvbmZpZ1tjb2xdLnNldEVkaXRvcihlZGl0b3IpOwogICAgfSwKCiAgICAKICAgIGRlc3Ryb3kgOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbGVuZ3RoID0gdGhpcy5jb25maWcubGVuZ3RoLAogICAgICAgICAgICBpID0gMDsKCiAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIHRoaXMuY29uZmlnW2ldLmRlc3Ryb3koKTsgCiAgICAgICAgfQogICAgICAgIGRlbGV0ZSB0aGlzLmNvbmZpZzsKICAgICAgICBkZWxldGUgdGhpcy5sb29rdXA7CiAgICAgICAgdGhpcy5wdXJnZUxpc3RlbmVycygpOwogICAgfSwKCiAgICAKICAgIHNldFN0YXRlIDogZnVuY3Rpb24oY29sLCBzdGF0ZSkgewogICAgICAgIHN0YXRlID0gRXh0LmFwcGx5SWYoc3RhdGUsIHRoaXMuZGVmYXVsdHMpOwogICAgICAgIEV4dC5hcHBseSh0aGlzLmNvbmZpZ1tjb2xdLCBzdGF0ZSk7CiAgICB9Cn0pOwoKCkV4dC5ncmlkLkNvbHVtbk1vZGVsLmRlZmF1bHRSZW5kZXJlciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlID09ICJzdHJpbmciICYmIHZhbHVlLmxlbmd0aCA8IDEpIHsKICAgICAgICByZXR1cm4gIiYjMTYwOyI7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7Cn07CkV4dC5ncmlkLkFic3RyYWN0U2VsZWN0aW9uTW9kZWwgPSBFeHQuZXh0ZW5kKEV4dC51dGlsLk9ic2VydmFibGUsICB7CiAgICAKCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5sb2NrZWQgPSBmYWxzZTsKICAgICAgICBFeHQuZ3JpZC5BYnN0cmFjdFNlbGVjdGlvbk1vZGVsLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICBpbml0IDogZnVuY3Rpb24oZ3JpZCl7CiAgICAgICAgdGhpcy5ncmlkID0gZ3JpZDsKICAgICAgICBpZih0aGlzLmxvY2tPbkluaXQpewogICAgICAgICAgICBkZWxldGUgdGhpcy5sb2NrT25Jbml0OwogICAgICAgICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmxvY2soKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5pbml0RXZlbnRzKCk7CiAgICB9LAoKICAgIAogICAgbG9jayA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMubG9ja2VkKXsKICAgICAgICAgICAgdGhpcy5sb2NrZWQgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGcgPSB0aGlzLmdyaWQ7CiAgICAgICAgICAgIGlmKGcpewogICAgICAgICAgICAgICAgZy5nZXRWaWV3KCkub24oewogICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgICAgIGJlZm9yZXJlZnJlc2g6IHRoaXMuc29ydFVuTG9jaywKICAgICAgICAgICAgICAgICAgICByZWZyZXNoOiB0aGlzLnNvcnRMb2NrCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICB0aGlzLmxvY2tPbkluaXQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNvcnRMb2NrIDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sb2NrZWQgPSB0cnVlOwogICAgfSwKCiAgICAKICAgIHNvcnRVbkxvY2sgOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlOwogICAgfSwKCiAgICAKICAgIHVubG9jayA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYodGhpcy5sb2NrZWQpewogICAgICAgICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB2YXIgZyA9IHRoaXMuZ3JpZCwKICAgICAgICAgICAgICAgIGd2OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBpZihnKXsKICAgICAgICAgICAgICAgIGd2ID0gZy5nZXRWaWV3KCk7CiAgICAgICAgICAgICAgICBndi51bignYmVmb3JlcmVmcmVzaCcsIHRoaXMuc29ydFVuTG9jaywgdGhpcyk7CiAgICAgICAgICAgICAgICBndi51bigncmVmcmVzaCcsIHRoaXMuc29ydExvY2ssIHRoaXMpOyAgICAKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5sb2NrT25Jbml0OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGlzTG9ja2VkIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5sb2NrZWQ7CiAgICB9LAoKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy51bmxvY2soKTsKICAgICAgICB0aGlzLnB1cmdlTGlzdGVuZXJzKCk7CiAgICB9Cn0pOwpFeHQuZ3JpZC5Sb3dTZWxlY3Rpb25Nb2RlbCA9IEV4dC5leHRlbmQoRXh0LmdyaWQuQWJzdHJhY3RTZWxlY3Rpb25Nb2RlbCwgIHsKICAgIAogICAgc2luZ2xlU2VsZWN0IDogZmFsc2UsCiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKICAgICAgICB0aGlzLnNlbGVjdGlvbnMgPSBuZXcgRXh0LnV0aWwuTWl4ZWRDb2xsZWN0aW9uKGZhbHNlLCBmdW5jdGlvbihvKXsKICAgICAgICAgICAgcmV0dXJuIG8uaWQ7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMubGFzdCA9IGZhbHNlOwogICAgICAgIHRoaXMubGFzdEFjdGl2ZSA9IGZhbHNlOwoKICAgICAgICB0aGlzLmFkZEV2ZW50cygKCSAgICAgICAgCgkgICAgICAgICdzZWxlY3Rpb25jaGFuZ2UnLAoJICAgICAgICAKCSAgICAgICAgJ2JlZm9yZXJvd3NlbGVjdCcsCgkgICAgICAgIAoJICAgICAgICAncm93c2VsZWN0JywKCSAgICAgICAgCgkgICAgICAgICdyb3dkZXNlbGVjdCcKICAgICAgICApOwogICAgICAgIEV4dC5ncmlkLlJvd1NlbGVjdGlvbk1vZGVsLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzKTsKICAgIH0sCgogICAgCiAgICAKICAgIGluaXRFdmVudHMgOiBmdW5jdGlvbigpewoKICAgICAgICBpZighdGhpcy5ncmlkLmVuYWJsZURyYWdEcm9wICYmICF0aGlzLmdyaWQuZW5hYmxlRHJhZyl7CiAgICAgICAgICAgIHRoaXMuZ3JpZC5vbigncm93bW91c2Vkb3duJywgdGhpcy5oYW5kbGVNb3VzZURvd24sIHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5yb3dOYXYgPSBuZXcgRXh0LktleU5hdih0aGlzLmdyaWQuZ2V0R3JpZEVsKCksIHsKICAgICAgICAgICAgdXA6IHRoaXMub25LZXlQcmVzcywgCiAgICAgICAgICAgIGRvd246IHRoaXMub25LZXlQcmVzcywKICAgICAgICAgICAgc2NvcGU6IHRoaXMKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5ncmlkLmdldFZpZXcoKS5vbih7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICByZWZyZXNoOiB0aGlzLm9uUmVmcmVzaCwKICAgICAgICAgICAgcm93dXBkYXRlZDogdGhpcy5vblJvd1VwZGF0ZWQsCiAgICAgICAgICAgIHJvd3JlbW92ZWQ6IHRoaXMub25SZW1vdmUKICAgICAgICB9KTsKICAgIH0sCiAgICAKICAgIG9uS2V5UHJlc3MgOiBmdW5jdGlvbihlLCBuYW1lKXsKICAgICAgICB2YXIgdXAgPSBuYW1lID09ICd1cCcsCiAgICAgICAgICAgIG1ldGhvZCA9IHVwID8gJ3NlbGVjdFByZXZpb3VzJyA6ICdzZWxlY3ROZXh0JywKICAgICAgICAgICAgYWRkID0gdXAgPyAtMSA6IDEsCiAgICAgICAgICAgIGxhc3Q7CiAgICAgICAgaWYoIWUuc2hpZnRLZXkgfHwgdGhpcy5zaW5nbGVTZWxlY3QpewogICAgICAgICAgICB0aGlzW21ldGhvZF0oZmFsc2UpOwogICAgICAgIH1lbHNlIGlmKHRoaXMubGFzdCAhPT0gZmFsc2UgJiYgdGhpcy5sYXN0QWN0aXZlICE9PSBmYWxzZSl7CiAgICAgICAgICAgIGxhc3QgPSB0aGlzLmxhc3Q7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0UmFuZ2UodGhpcy5sYXN0LCAgdGhpcy5sYXN0QWN0aXZlICsgYWRkKTsKICAgICAgICAgICAgdGhpcy5ncmlkLmdldFZpZXcoKS5mb2N1c1Jvdyh0aGlzLmxhc3RBY3RpdmUpOwogICAgICAgICAgICBpZihsYXN0ICE9PSBmYWxzZSl7CiAgICAgICAgICAgICAgICB0aGlzLmxhc3QgPSBsYXN0OwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgdGhpcy5zZWxlY3RGaXJzdFJvdygpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvblJlZnJlc2ggOiBmdW5jdGlvbigpewogICAgICAgIHZhciBkcyA9IHRoaXMuZ3JpZC5zdG9yZSwKICAgICAgICAgICAgcyA9IHRoaXMuZ2V0U2VsZWN0aW9ucygpLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gcy5sZW5ndGgsIAogICAgICAgICAgICBpbmRleCwgcjsKICAgICAgICAgICAgCiAgICAgICAgdGhpcy5zaWxlbnQgPSB0cnVlOwogICAgICAgIHRoaXMuY2xlYXJTZWxlY3Rpb25zKHRydWUpOwogICAgICAgIGZvcig7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIHIgPSBzW2ldOwogICAgICAgICAgICBpZigoaW5kZXggPSBkcy5pbmRleE9mSWQoci5pZCkpICE9IC0xKXsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0Um93KGluZGV4LCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZihzLmxlbmd0aCAhPSB0aGlzLnNlbGVjdGlvbnMuZ2V0Q291bnQoKSl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzZWxlY3Rpb25jaGFuZ2UnLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zaWxlbnQgPSBmYWxzZTsKICAgIH0sCgogICAgCiAgICBvblJlbW92ZSA6IGZ1bmN0aW9uKHYsIGluZGV4LCByKXsKICAgICAgICBpZih0aGlzLnNlbGVjdGlvbnMucmVtb3ZlKHIpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzZWxlY3Rpb25jaGFuZ2UnLCB0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25Sb3dVcGRhdGVkIDogZnVuY3Rpb24odiwgaW5kZXgsIHIpewogICAgICAgIGlmKHRoaXMuaXNTZWxlY3RlZChyKSl7CiAgICAgICAgICAgIHYub25Sb3dTZWxlY3QoaW5kZXgpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZWxlY3RSZWNvcmRzIDogZnVuY3Rpb24ocmVjb3Jkcywga2VlcEV4aXN0aW5nKXsKICAgICAgICBpZigha2VlcEV4aXN0aW5nKXsKICAgICAgICAgICAgdGhpcy5jbGVhclNlbGVjdGlvbnMoKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRzID0gdGhpcy5ncmlkLnN0b3JlLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gcmVjb3Jkcy5sZW5ndGg7CiAgICAgICAgZm9yKDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgdGhpcy5zZWxlY3RSb3coZHMuaW5kZXhPZihyZWNvcmRzW2ldKSwgdHJ1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldENvdW50IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3Rpb25zLmxlbmd0aDsKICAgIH0sCgogICAgCiAgICBzZWxlY3RGaXJzdFJvdyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zZWxlY3RSb3coMCk7CiAgICB9LAoKICAgIAogICAgc2VsZWN0TGFzdFJvdyA6IGZ1bmN0aW9uKGtlZXBFeGlzdGluZyl7CiAgICAgICAgdGhpcy5zZWxlY3RSb3codGhpcy5ncmlkLnN0b3JlLmdldENvdW50KCkgLSAxLCBrZWVwRXhpc3RpbmcpOwogICAgfSwKCiAgICAKICAgIHNlbGVjdE5leHQgOiBmdW5jdGlvbihrZWVwRXhpc3RpbmcpewogICAgICAgIGlmKHRoaXMuaGFzTmV4dCgpKXsKICAgICAgICAgICAgdGhpcy5zZWxlY3RSb3codGhpcy5sYXN0KzEsIGtlZXBFeGlzdGluZyk7CiAgICAgICAgICAgIHRoaXMuZ3JpZC5nZXRWaWV3KCkuZm9jdXNSb3codGhpcy5sYXN0KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgCiAgICBzZWxlY3RQcmV2aW91cyA6IGZ1bmN0aW9uKGtlZXBFeGlzdGluZyl7CiAgICAgICAgaWYodGhpcy5oYXNQcmV2aW91cygpKXsKICAgICAgICAgICAgdGhpcy5zZWxlY3RSb3codGhpcy5sYXN0LTEsIGtlZXBFeGlzdGluZyk7CiAgICAgICAgICAgIHRoaXMuZ3JpZC5nZXRWaWV3KCkuZm9jdXNSb3codGhpcy5sYXN0KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgCiAgICBoYXNOZXh0IDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5sYXN0ICE9PSBmYWxzZSAmJiAodGhpcy5sYXN0KzEpIDwgdGhpcy5ncmlkLnN0b3JlLmdldENvdW50KCk7CiAgICB9LAoKICAgIAogICAgaGFzUHJldmlvdXMgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiAhIXRoaXMubGFzdDsKICAgIH0sCgoKICAgIAogICAgZ2V0U2VsZWN0aW9ucyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIFtdLmNvbmNhdCh0aGlzLnNlbGVjdGlvbnMuaXRlbXMpOwogICAgfSwKCiAgICAKICAgIGdldFNlbGVjdGVkIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3Rpb25zLml0ZW1BdCgwKTsKICAgIH0sCgogICAgCiAgICBlYWNoIDogZnVuY3Rpb24oZm4sIHNjb3BlKXsKICAgICAgICB2YXIgcyA9IHRoaXMuZ2V0U2VsZWN0aW9ucygpLAogICAgICAgICAgICBpID0gMCwKICAgICAgICAgICAgbGVuID0gcy5sZW5ndGg7CiAgICAgICAgICAgIAogICAgICAgIGZvcig7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGlmKGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgc1tpXSwgaSkgPT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCgogICAgCiAgICBjbGVhclNlbGVjdGlvbnMgOiBmdW5jdGlvbihmYXN0KXsKICAgICAgICBpZih0aGlzLmlzTG9ja2VkKCkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKGZhc3QgIT09IHRydWUpewogICAgICAgICAgICB2YXIgZHMgPSB0aGlzLmdyaWQuc3RvcmUsCiAgICAgICAgICAgICAgICBzID0gdGhpcy5zZWxlY3Rpb25zOwogICAgICAgICAgICBzLmVhY2goZnVuY3Rpb24ocil7CiAgICAgICAgICAgICAgICB0aGlzLmRlc2VsZWN0Um93KGRzLmluZGV4T2ZJZChyLmlkKSk7CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICBzLmNsZWFyKCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0aW9ucy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICB0aGlzLmxhc3QgPSBmYWxzZTsKICAgIH0sCgoKICAgIAogICAgc2VsZWN0QWxsIDogZnVuY3Rpb24oKXsKICAgICAgICBpZih0aGlzLmlzTG9ja2VkKCkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuc2VsZWN0aW9ucy5jbGVhcigpOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IHRoaXMuZ3JpZC5zdG9yZS5nZXRDb3VudCgpOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICB0aGlzLnNlbGVjdFJvdyhpLCB0cnVlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaGFzU2VsZWN0aW9uIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3Rpb25zLmxlbmd0aCA+IDA7CiAgICB9LAoKICAgIAogICAgaXNTZWxlY3RlZCA6IGZ1bmN0aW9uKGluZGV4KXsKICAgICAgICB2YXIgciA9IEV4dC5pc051bWJlcihpbmRleCkgPyB0aGlzLmdyaWQuc3RvcmUuZ2V0QXQoaW5kZXgpIDogaW5kZXg7CiAgICAgICAgcmV0dXJuIChyICYmIHRoaXMuc2VsZWN0aW9ucy5rZXkoci5pZCkgPyB0cnVlIDogZmFsc2UpOwogICAgfSwKCiAgICAKICAgIGlzSWRTZWxlY3RlZCA6IGZ1bmN0aW9uKGlkKXsKICAgICAgICByZXR1cm4gKHRoaXMuc2VsZWN0aW9ucy5rZXkoaWQpID8gdHJ1ZSA6IGZhbHNlKTsKICAgIH0sCgogICAgCiAgICBoYW5kbGVNb3VzZURvd24gOiBmdW5jdGlvbihnLCByb3dJbmRleCwgZSl7CiAgICAgICAgaWYoZS5idXR0b24gIT09IDAgfHwgdGhpcy5pc0xvY2tlZCgpKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgdmlldyA9IHRoaXMuZ3JpZC5nZXRWaWV3KCk7CiAgICAgICAgaWYoZS5zaGlmdEtleSAmJiAhdGhpcy5zaW5nbGVTZWxlY3QgJiYgdGhpcy5sYXN0ICE9PSBmYWxzZSl7CiAgICAgICAgICAgIHZhciBsYXN0ID0gdGhpcy5sYXN0OwogICAgICAgICAgICB0aGlzLnNlbGVjdFJhbmdlKGxhc3QsIHJvd0luZGV4LCBlLmN0cmxLZXkpOwogICAgICAgICAgICB0aGlzLmxhc3QgPSBsYXN0OyAKICAgICAgICAgICAgdmlldy5mb2N1c1Jvdyhyb3dJbmRleCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHZhciBpc1NlbGVjdGVkID0gdGhpcy5pc1NlbGVjdGVkKHJvd0luZGV4KTsKICAgICAgICAgICAgaWYoZS5jdHJsS2V5ICYmIGlzU2VsZWN0ZWQpewogICAgICAgICAgICAgICAgdGhpcy5kZXNlbGVjdFJvdyhyb3dJbmRleCk7CiAgICAgICAgICAgIH1lbHNlIGlmKCFpc1NlbGVjdGVkIHx8IHRoaXMuZ2V0Q291bnQoKSA+IDEpewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RSb3cocm93SW5kZXgsIGUuY3RybEtleSB8fCBlLnNoaWZ0S2V5KTsKICAgICAgICAgICAgICAgIHZpZXcuZm9jdXNSb3cocm93SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNlbGVjdFJvd3MgOiBmdW5jdGlvbihyb3dzLCBrZWVwRXhpc3RpbmcpewogICAgICAgIGlmKCFrZWVwRXhpc3RpbmcpewogICAgICAgICAgICB0aGlzLmNsZWFyU2VsZWN0aW9ucygpOwogICAgICAgIH0KICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSByb3dzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgdGhpcy5zZWxlY3RSb3cocm93c1tpXSwgdHJ1ZSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNlbGVjdFJhbmdlIDogZnVuY3Rpb24oc3RhcnRSb3csIGVuZFJvdywga2VlcEV4aXN0aW5nKXsKICAgICAgICB2YXIgaTsKICAgICAgICBpZih0aGlzLmlzTG9ja2VkKCkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKCFrZWVwRXhpc3RpbmcpewogICAgICAgICAgICB0aGlzLmNsZWFyU2VsZWN0aW9ucygpOwogICAgICAgIH0KICAgICAgICBpZihzdGFydFJvdyA8PSBlbmRSb3cpewogICAgICAgICAgICBmb3IoaSA9IHN0YXJ0Um93OyBpIDw9IGVuZFJvdzsgaSsrKXsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0Um93KGksIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIGZvcihpID0gc3RhcnRSb3c7IGkgPj0gZW5kUm93OyBpLS0pewogICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RSb3coaSwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZGVzZWxlY3RSYW5nZSA6IGZ1bmN0aW9uKHN0YXJ0Um93LCBlbmRSb3csIHByZXZlbnRWaWV3Tm90aWZ5KXsKICAgICAgICBpZih0aGlzLmlzTG9ja2VkKCkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGZvcih2YXIgaSA9IHN0YXJ0Um93OyBpIDw9IGVuZFJvdzsgaSsrKXsKICAgICAgICAgICAgdGhpcy5kZXNlbGVjdFJvdyhpLCBwcmV2ZW50Vmlld05vdGlmeSk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHNlbGVjdFJvdyA6IGZ1bmN0aW9uKGluZGV4LCBrZWVwRXhpc3RpbmcsIHByZXZlbnRWaWV3Tm90aWZ5KXsKICAgICAgICBpZih0aGlzLmlzTG9ja2VkKCkgfHwgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLmdyaWQuc3RvcmUuZ2V0Q291bnQoKSkgfHwgKGtlZXBFeGlzdGluZyAmJiB0aGlzLmlzU2VsZWN0ZWQoaW5kZXgpKSl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHIgPSB0aGlzLmdyaWQuc3RvcmUuZ2V0QXQoaW5kZXgpOwogICAgICAgIGlmKHIgJiYgdGhpcy5maXJlRXZlbnQoJ2JlZm9yZXJvd3NlbGVjdCcsIHRoaXMsIGluZGV4LCBrZWVwRXhpc3RpbmcsIHIpICE9PSBmYWxzZSl7CiAgICAgICAgICAgIGlmKCFrZWVwRXhpc3RpbmcgfHwgdGhpcy5zaW5nbGVTZWxlY3QpewogICAgICAgICAgICAgICAgdGhpcy5jbGVhclNlbGVjdGlvbnMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNlbGVjdGlvbnMuYWRkKHIpOwogICAgICAgICAgICB0aGlzLmxhc3QgPSB0aGlzLmxhc3RBY3RpdmUgPSBpbmRleDsKICAgICAgICAgICAgaWYoIXByZXZlbnRWaWV3Tm90aWZ5KXsKICAgICAgICAgICAgICAgIHRoaXMuZ3JpZC5nZXRWaWV3KCkub25Sb3dTZWxlY3QoaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCF0aGlzLnNpbGVudCl7CiAgICAgICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgncm93c2VsZWN0JywgdGhpcywgaW5kZXgsIHIpOwogICAgICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoJ3NlbGVjdGlvbmNoYW5nZScsIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRlc2VsZWN0Um93IDogZnVuY3Rpb24oaW5kZXgsIHByZXZlbnRWaWV3Tm90aWZ5KXsKICAgICAgICBpZih0aGlzLmlzTG9ja2VkKCkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmKHRoaXMubGFzdCA9PSBpbmRleCl7CiAgICAgICAgICAgIHRoaXMubGFzdCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmxhc3RBY3RpdmUgPT0gaW5kZXgpewogICAgICAgICAgICB0aGlzLmxhc3RBY3RpdmUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIHIgPSB0aGlzLmdyaWQuc3RvcmUuZ2V0QXQoaW5kZXgpOwogICAgICAgIGlmKHIpewogICAgICAgICAgICB0aGlzLnNlbGVjdGlvbnMucmVtb3ZlKHIpOwogICAgICAgICAgICBpZighcHJldmVudFZpZXdOb3RpZnkpewogICAgICAgICAgICAgICAgdGhpcy5ncmlkLmdldFZpZXcoKS5vblJvd0Rlc2VsZWN0KGluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgncm93ZGVzZWxlY3QnLCB0aGlzLCBpbmRleCwgcik7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdzZWxlY3Rpb25jaGFuZ2UnLCB0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgYWNjZXB0c05hdiA6IGZ1bmN0aW9uKHJvdywgY29sLCBjbSl7CiAgICAgICAgcmV0dXJuICFjbS5pc0hpZGRlbihjb2wpICYmIGNtLmlzQ2VsbEVkaXRhYmxlKGNvbCwgcm93KTsKICAgIH0sCgogICAgCiAgICBvbkVkaXRvcktleSA6IGZ1bmN0aW9uKGZpZWxkLCBlKXsKICAgICAgICB2YXIgayA9IGUuZ2V0S2V5KCksIAogICAgICAgICAgICBuZXdDZWxsLCAKICAgICAgICAgICAgZyA9IHRoaXMuZ3JpZCwgCiAgICAgICAgICAgIGxhc3QgPSBnLmxhc3RFZGl0LAogICAgICAgICAgICBlZCA9IGcuYWN0aXZlRWRpdG9yLAogICAgICAgICAgICBzaGlmdCA9IGUuc2hpZnRLZXksCiAgICAgICAgICAgIGFlLCBsYXN0LCByLCBjOwogICAgICAgICAgICAKICAgICAgICBpZihrID09IGUuVEFCKXsKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgZWQuY29tcGxldGVFZGl0KCk7CiAgICAgICAgICAgIGlmKHNoaWZ0KXsKICAgICAgICAgICAgICAgIG5ld0NlbGwgPSBnLndhbGtDZWxscyhlZC5yb3csIGVkLmNvbC0xLCAtMSwgdGhpcy5hY2NlcHRzTmF2LCB0aGlzKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBuZXdDZWxsID0gZy53YWxrQ2VsbHMoZWQucm93LCBlZC5jb2wrMSwgMSwgdGhpcy5hY2NlcHRzTmF2LCB0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgIH1lbHNlIGlmKGsgPT0gZS5FTlRFUil7CiAgICAgICAgICAgIGlmKHRoaXMubW92ZUVkaXRvck9uRW50ZXIgIT09IGZhbHNlKXsKICAgICAgICAgICAgICAgIGlmKHNoaWZ0KXsKICAgICAgICAgICAgICAgICAgICBuZXdDZWxsID0gZy53YWxrQ2VsbHMobGFzdC5yb3cgLSAxLCBsYXN0LmNvbCwgLTEsIHRoaXMuYWNjZXB0c05hdiwgdGhpcyk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICBuZXdDZWxsID0gZy53YWxrQ2VsbHMobGFzdC5yb3cgKyAxLCBsYXN0LmNvbCwgMSwgdGhpcy5hY2NlcHRzTmF2LCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZihuZXdDZWxsKXsKICAgICAgICAgICAgciA9IG5ld0NlbGxbMF07CiAgICAgICAgICAgIGMgPSBuZXdDZWxsWzFdOwoKICAgICAgICAgICAgdGhpcy5vbkVkaXRvclNlbGVjdChyLCBsYXN0LnJvdyk7CgogICAgICAgICAgICBpZihnLmlzRWRpdG9yICYmIGcuZWRpdGluZyl7IAogICAgICAgICAgICAgICAgYWUgPSBnLmFjdGl2ZUVkaXRvcjsKICAgICAgICAgICAgICAgIGlmKGFlICYmIGFlLmZpZWxkLnRyaWdnZXJCbHVyKXsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBhZS5maWVsZC50cmlnZ2VyQmx1cigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGcuc3RhcnRFZGl0aW5nKHIsIGMpOwogICAgICAgIH0KICAgIH0sCiAgICAKICAgIG9uRWRpdG9yU2VsZWN0OiBmdW5jdGlvbihyb3csIGxhc3RSb3cpewogICAgICAgIGlmKGxhc3RSb3cgIT0gcm93KXsKICAgICAgICAgICAgdGhpcy5zZWxlY3RSb3cocm93KTsgCiAgICAgICAgfQogICAgfSwKICAgIAogICAgZGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmRlc3Ryb3kodGhpcy5yb3dOYXYpOwogICAgICAgIHRoaXMucm93TmF2ID0gbnVsbDsKICAgICAgICBFeHQuZ3JpZC5Sb3dTZWxlY3Rpb25Nb2RlbC5zdXBlcmNsYXNzLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgIH0KfSk7CgpFeHQuZ3JpZC5Db2x1bW4gPSBFeHQuZXh0ZW5kKEV4dC51dGlsLk9ic2VydmFibGUsIHsKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAoKICAgIAogICAgaXNDb2x1bW4gOiB0cnVlLAoKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKCiAgICAgICAgaWYoRXh0LmlzU3RyaW5nKHRoaXMucmVuZGVyZXIpKXsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IEV4dC51dGlsLkZvcm1hdFt0aGlzLnJlbmRlcmVyXTsKICAgICAgICB9ZWxzZSBpZihFeHQuaXNPYmplY3QodGhpcy5yZW5kZXJlcikpewogICAgICAgICAgICB0aGlzLnNjb3BlID0gdGhpcy5yZW5kZXJlci5zY29wZTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJlciA9IHRoaXMucmVuZGVyZXIuZm47CiAgICAgICAgfQogICAgICAgIGlmKCF0aGlzLnNjb3BlKXsKICAgICAgICAgICAgdGhpcy5zY29wZSA9IHRoaXM7CiAgICAgICAgfQoKICAgICAgICB2YXIgZWQgPSB0aGlzLmVkaXRvcjsKICAgICAgICBkZWxldGUgdGhpcy5lZGl0b3I7CiAgICAgICAgdGhpcy5zZXRFZGl0b3IoZWQpOwogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgJ2NsaWNrJywKICAgICAgICAgICAgCiAgICAgICAgICAgICdjb250ZXh0bWVudScsCiAgICAgICAgICAgIAogICAgICAgICAgICAnZGJsY2xpY2snLAogICAgICAgICAgICAKICAgICAgICAgICAgJ21vdXNlZG93bicKICAgICAgICApOwogICAgICAgIEV4dC5ncmlkLkNvbHVtbi5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgcHJvY2Vzc0V2ZW50IDogZnVuY3Rpb24obmFtZSwgZSwgZ3JpZCwgcm93SW5kZXgsIGNvbEluZGV4KXsKICAgICAgICByZXR1cm4gdGhpcy5maXJlRXZlbnQobmFtZSwgdGhpcywgZ3JpZCwgcm93SW5kZXgsIGUpOwogICAgfSwKCiAgICAKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmKHRoaXMuc2V0RWRpdG9yKXsKICAgICAgICAgICAgdGhpcy5zZXRFZGl0b3IobnVsbCk7CiAgICAgICAgfQogICAgICAgIHRoaXMucHVyZ2VMaXN0ZW5lcnMoKTsKICAgIH0sCgogICAgCiAgICByZW5kZXJlciA6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAoKICAgIAogICAgZ2V0RWRpdG9yOiBmdW5jdGlvbihyb3dJbmRleCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZWRpdGFibGUgIT09IGZhbHNlID8gdGhpcy5lZGl0b3IgOiBudWxsOwogICAgfSwKCiAgICAKICAgIHNldEVkaXRvciA6IGZ1bmN0aW9uKGVkaXRvcil7CiAgICAgICAgdmFyIGVkID0gdGhpcy5lZGl0b3I7CiAgICAgICAgaWYoZWQpewogICAgICAgICAgICBpZihlZC5ncmlkRWRpdG9yKXsKICAgICAgICAgICAgICAgIGVkLmdyaWRFZGl0b3IuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgZGVsZXRlIGVkLmdyaWRFZGl0b3I7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgZWQuZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuZWRpdG9yID0gbnVsbDsKICAgICAgICBpZihlZGl0b3IpewogICAgICAgICAgICAKICAgICAgICAgICAgaWYoIWVkaXRvci5pc1hUeXBlKXsKICAgICAgICAgICAgICAgIGVkaXRvciA9IEV4dC5jcmVhdGUoZWRpdG9yLCAndGV4dGZpZWxkJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3I7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGdldENlbGxFZGl0b3I6IGZ1bmN0aW9uKHJvd0luZGV4KXsKICAgICAgICB2YXIgZWQgPSB0aGlzLmdldEVkaXRvcihyb3dJbmRleCk7CiAgICAgICAgaWYoZWQpewogICAgICAgICAgICBpZighZWQuc3RhcnRFZGl0KXsKICAgICAgICAgICAgICAgIGlmKCFlZC5ncmlkRWRpdG9yKXsKICAgICAgICAgICAgICAgICAgICBlZC5ncmlkRWRpdG9yID0gbmV3IEV4dC5ncmlkLkdyaWRFZGl0b3IoZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWQgPSBlZC5ncmlkRWRpdG9yOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlZDsKICAgIH0KfSk7CgoKRXh0LmdyaWQuQm9vbGVhbkNvbHVtbiA9IEV4dC5leHRlbmQoRXh0LmdyaWQuQ29sdW1uLCB7CiAgICAKICAgIHRydWVUZXh0OiAndHJ1ZScsCiAgICAKICAgIGZhbHNlVGV4dDogJ2ZhbHNlJywKICAgIAogICAgdW5kZWZpbmVkVGV4dDogJyYjMTYwOycsCgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNmZyl7CiAgICAgICAgRXh0LmdyaWQuQm9vbGVhbkNvbHVtbi5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgY2ZnKTsKICAgICAgICB2YXIgdCA9IHRoaXMudHJ1ZVRleHQsIGYgPSB0aGlzLmZhbHNlVGV4dCwgdSA9IHRoaXMudW5kZWZpbmVkVGV4dDsKICAgICAgICB0aGlzLnJlbmRlcmVyID0gZnVuY3Rpb24odil7CiAgICAgICAgICAgIGlmKHYgPT09IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICByZXR1cm4gdTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZighdiB8fCB2ID09PSAnZmFsc2UnKXsKICAgICAgICAgICAgICAgIHJldHVybiBmOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0OwogICAgICAgIH07CiAgICB9Cn0pOwoKCkV4dC5ncmlkLk51bWJlckNvbHVtbiA9IEV4dC5leHRlbmQoRXh0LmdyaWQuQ29sdW1uLCB7CiAgICAKICAgIGZvcm1hdCA6ICcwLDAwMC4wMCcsCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oY2ZnKXsKICAgICAgICBFeHQuZ3JpZC5OdW1iZXJDb2x1bW4uc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGNmZyk7CiAgICAgICAgdGhpcy5yZW5kZXJlciA9IEV4dC51dGlsLkZvcm1hdC5udW1iZXJSZW5kZXJlcih0aGlzLmZvcm1hdCk7CiAgICB9Cn0pOwoKCkV4dC5ncmlkLkRhdGVDb2x1bW4gPSBFeHQuZXh0ZW5kKEV4dC5ncmlkLkNvbHVtbiwgewogICAgCiAgICBmb3JtYXQgOiAnbS9kL1knLAogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNmZyl7CiAgICAgICAgRXh0LmdyaWQuRGF0ZUNvbHVtbi5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgY2ZnKTsKICAgICAgICB0aGlzLnJlbmRlcmVyID0gRXh0LnV0aWwuRm9ybWF0LmRhdGVSZW5kZXJlcih0aGlzLmZvcm1hdCk7CiAgICB9Cn0pOwoKCkV4dC5ncmlkLlRlbXBsYXRlQ29sdW1uID0gRXh0LmV4dGVuZChFeHQuZ3JpZC5Db2x1bW4sIHsKICAgIAogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNmZyl7CiAgICAgICAgRXh0LmdyaWQuVGVtcGxhdGVDb2x1bW4uc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIGNmZyk7CiAgICAgICAgdmFyIHRwbCA9ICghRXh0LmlzUHJpbWl0aXZlKHRoaXMudHBsKSAmJiB0aGlzLnRwbC5jb21waWxlKSA/IHRoaXMudHBsIDogbmV3IEV4dC5YVGVtcGxhdGUodGhpcy50cGwpOwogICAgICAgIHRoaXMucmVuZGVyZXIgPSBmdW5jdGlvbih2YWx1ZSwgcCwgcil7CiAgICAgICAgICAgIHJldHVybiB0cGwuYXBwbHkoci5kYXRhKTsKICAgICAgICB9OwogICAgICAgIHRoaXMudHBsID0gdHBsOwogICAgfQp9KTsKCgpFeHQuZ3JpZC5BY3Rpb25Db2x1bW4gPSBFeHQuZXh0ZW5kKEV4dC5ncmlkLkNvbHVtbiwgewogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIAogICAgCiAgICAKICAgIGhlYWRlcjogJyYjMTYwOycsCgogICAgYWN0aW9uSWRSZTogL3gtYWN0aW9uLWNvbC0oXGQrKS8sCiAgICAKICAgIAogICAgYWx0VGV4dDogJycsCgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGNmZykgewogICAgICAgIHZhciBtZSA9IHRoaXMsCiAgICAgICAgICAgIGl0ZW1zID0gY2ZnLml0ZW1zIHx8IChtZS5pdGVtcyA9IFttZV0pLAogICAgICAgICAgICBsID0gaXRlbXMubGVuZ3RoLAogICAgICAgICAgICBpLAogICAgICAgICAgICBpdGVtOwoKICAgICAgICBFeHQuZ3JpZC5BY3Rpb25Db2x1bW4uc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKG1lLCBjZmcpOwoKCgogICAgICAgIG1lLnJlbmRlcmVyID0gZnVuY3Rpb24odiwgbWV0YSkgewoKICAgICAgICAgICAgdiA9IEV4dC5pc0Z1bmN0aW9uKGNmZy5yZW5kZXJlcikgPyBjZmcucmVuZGVyZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKXx8JycgOiAnJzsKCiAgICAgICAgICAgIG1ldGEuY3NzICs9ICcgeC1hY3Rpb24tY29sLWNlbGwnOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpdGVtID0gaXRlbXNbaV07CiAgICAgICAgICAgICAgICB2ICs9ICc8aW1nIGFsdD0iJyArIChpdGVtLmFsdFRleHQgfHwgbWUuYWx0VGV4dCkgKyAnIiBzcmM9IicgKyAoaXRlbS5pY29uIHx8IEV4dC5CTEFOS19JTUFHRV9VUkwpICsKICAgICAgICAgICAgICAgICAgICAnIiBjbGFzcz0ieC1hY3Rpb24tY29sLWljb24geC1hY3Rpb24tY29sLScgKyBTdHJpbmcoaSkgKyAnICcgKyAoaXRlbS5pY29uQ2xzIHx8ICcnKSArCiAgICAgICAgICAgICAgICAgICAgJyAnICsgKEV4dC5pc0Z1bmN0aW9uKGl0ZW0uZ2V0Q2xhc3MpID8gaXRlbS5nZXRDbGFzcy5hcHBseShpdGVtLnNjb3BlfHx0aGlzLnNjb3BlfHx0aGlzLCBhcmd1bWVudHMpIDogJycpICsgJyInICsKICAgICAgICAgICAgICAgICAgICAoKGl0ZW0udG9vbHRpcCkgPyAnIGV4dDpxdGlwPSInICsgaXRlbS50b29sdGlwICsgJyInIDogJycpICsgJyAvPic7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgfTsKICAgIH0sCgogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuaXRlbXM7CiAgICAgICAgZGVsZXRlIHRoaXMucmVuZGVyZXI7CiAgICAgICAgcmV0dXJuIEV4dC5ncmlkLkFjdGlvbkNvbHVtbi5zdXBlcmNsYXNzLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgCiAgICBwcm9jZXNzRXZlbnQgOiBmdW5jdGlvbihuYW1lLCBlLCBncmlkLCByb3dJbmRleCwgY29sSW5kZXgpewogICAgICAgIHZhciBtID0gZS5nZXRUYXJnZXQoKS5jbGFzc05hbWUubWF0Y2godGhpcy5hY3Rpb25JZFJlKSwKICAgICAgICAgICAgaXRlbSwgZm47CiAgICAgICAgaWYgKG0gJiYgKGl0ZW0gPSB0aGlzLml0ZW1zW3BhcnNlSW50KG1bMV0sIDEwKV0pKSB7CiAgICAgICAgICAgIGlmIChuYW1lID09ICdjbGljaycpIHsKICAgICAgICAgICAgICAgIChmbiA9IGl0ZW0uaGFuZGxlciB8fCB0aGlzLmhhbmRsZXIpICYmIGZuLmNhbGwoaXRlbS5zY29wZXx8dGhpcy5zY29wZXx8dGhpcywgZ3JpZCwgcm93SW5kZXgsIGNvbEluZGV4LCBpdGVtLCBlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICgobmFtZSA9PSAnbW91c2Vkb3duJykgJiYgKGl0ZW0uc3RvcFNlbGVjdGlvbiAhPT0gZmFsc2UpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIEV4dC5ncmlkLkFjdGlvbkNvbHVtbi5zdXBlcmNsYXNzLnByb2Nlc3NFdmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQp9KTsKCgpFeHQuZ3JpZC5Db2x1bW4udHlwZXMgPSB7CiAgICBncmlkY29sdW1uIDogRXh0LmdyaWQuQ29sdW1uLAogICAgYm9vbGVhbmNvbHVtbjogRXh0LmdyaWQuQm9vbGVhbkNvbHVtbiwKICAgIG51bWJlcmNvbHVtbjogRXh0LmdyaWQuTnVtYmVyQ29sdW1uLAogICAgZGF0ZWNvbHVtbjogRXh0LmdyaWQuRGF0ZUNvbHVtbiwKICAgIHRlbXBsYXRlY29sdW1uOiBFeHQuZ3JpZC5UZW1wbGF0ZUNvbHVtbiwKICAgIGFjdGlvbmNvbHVtbjogRXh0LmdyaWQuQWN0aW9uQ29sdW1uCn07CkV4dC5ncmlkLlJvd051bWJlcmVyID0gRXh0LmV4dGVuZChPYmplY3QsIHsKICAgIAogICAgaGVhZGVyOiAiIiwKICAgIAogICAgd2lkdGg6IDIzLAogICAgCiAgICBzb3J0YWJsZTogZmFsc2UsCiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgICBFeHQuYXBwbHkodGhpcywgY29uZmlnKTsKICAgICAgICBpZih0aGlzLnJvd3NwYW4pewogICAgICAgICAgICB0aGlzLnJlbmRlcmVyID0gdGhpcy5yZW5kZXJlci5jcmVhdGVEZWxlZ2F0ZSh0aGlzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZml4ZWQ6dHJ1ZSwKICAgIGhpZGVhYmxlOiBmYWxzZSwKICAgIG1lbnVEaXNhYmxlZDp0cnVlLAogICAgZGF0YUluZGV4OiAnJywKICAgIGlkOiAnbnVtYmVyZXInLAogICAgcm93c3BhbjogdW5kZWZpbmVkLAoKICAgIAogICAgcmVuZGVyZXIgOiBmdW5jdGlvbih2LCBwLCByZWNvcmQsIHJvd0luZGV4KXsKICAgICAgICBpZih0aGlzLnJvd3NwYW4pewogICAgICAgICAgICBwLmNlbGxBdHRyID0gJ3Jvd3NwYW49IicrdGhpcy5yb3dzcGFuKyciJzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvd0luZGV4KzE7CiAgICB9Cn0pOwpFeHQuZ3JpZC5DaGVja2JveFNlbGVjdGlvbk1vZGVsID0gRXh0LmV4dGVuZChFeHQuZ3JpZC5Sb3dTZWxlY3Rpb25Nb2RlbCwgewoKICAgIAogICAgCiAgICBoZWFkZXIgOiAnPGRpdiBjbGFzcz0ieC1ncmlkMy1oZC1jaGVja2VyIj4mIzE2MDs8L2Rpdj4nLAogICAgCiAgICB3aWR0aCA6IDIwLAogICAgCiAgICBzb3J0YWJsZSA6IGZhbHNlLAoKICAgIAogICAgbWVudURpc2FibGVkIDogdHJ1ZSwKICAgIGZpeGVkIDogdHJ1ZSwKICAgIGhpZGVhYmxlOiBmYWxzZSwKICAgIGRhdGFJbmRleCA6ICcnLAogICAgaWQgOiAnY2hlY2tlcicsCiAgICBpc0NvbHVtbjogdHJ1ZSwgCgogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5ncmlkLkNoZWNrYm94U2VsZWN0aW9uTW9kZWwuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGlmKHRoaXMuY2hlY2tPbmx5KXsKICAgICAgICAgICAgdGhpcy5oYW5kbGVNb3VzZURvd24gPSBFeHQuZW1wdHlGbjsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgaW5pdEV2ZW50cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmdyaWQuQ2hlY2tib3hTZWxlY3Rpb25Nb2RlbC5zdXBlcmNsYXNzLmluaXRFdmVudHMuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmdyaWQub24oJ3JlbmRlcicsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIEV4dC5mbHkodGhpcy5ncmlkLmdldFZpZXcoKS5pbm5lckhkKS5vbignbW91c2Vkb3duJywgdGhpcy5vbkhkTW91c2VEb3duLCB0aGlzKTsKICAgICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgCiAgICBwcm9jZXNzRXZlbnQgOiBmdW5jdGlvbihuYW1lLCBlLCBncmlkLCByb3dJbmRleCwgY29sSW5kZXgpewogICAgICAgIGlmIChuYW1lID09ICdtb3VzZWRvd24nKSB7CiAgICAgICAgICAgIHRoaXMub25Nb3VzZURvd24oZSwgZS5nZXRUYXJnZXQoKSk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gRXh0LmdyaWQuQ29sdW1uLnByb3RvdHlwZS5wcm9jZXNzRXZlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25Nb3VzZURvd24gOiBmdW5jdGlvbihlLCB0KXsKICAgICAgICBpZihlLmJ1dHRvbiA9PT0gMCAmJiB0LmNsYXNzTmFtZSA9PSAneC1ncmlkMy1yb3ctY2hlY2tlcicpeyAKICAgICAgICAgICAgZS5zdG9wRXZlbnQoKTsKICAgICAgICAgICAgdmFyIHJvdyA9IGUuZ2V0VGFyZ2V0KCcueC1ncmlkMy1yb3cnKTsKICAgICAgICAgICAgaWYocm93KXsKICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHJvdy5yb3dJbmRleDsKICAgICAgICAgICAgICAgIGlmKHRoaXMuaXNTZWxlY3RlZChpbmRleCkpewogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVzZWxlY3RSb3coaW5kZXgpOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RSb3coaW5kZXgsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JpZC5nZXRWaWV3KCkuZm9jdXNSb3coaW5kZXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIG9uSGRNb3VzZURvd24gOiBmdW5jdGlvbihlLCB0KSB7CiAgICAgICAgaWYodC5jbGFzc05hbWUgPT0gJ3gtZ3JpZDMtaGQtY2hlY2tlcicpewogICAgICAgICAgICBlLnN0b3BFdmVudCgpOwogICAgICAgICAgICB2YXIgaGQgPSBFeHQuZmx5KHQucGFyZW50Tm9kZSk7CiAgICAgICAgICAgIHZhciBpc0NoZWNrZWQgPSBoZC5oYXNDbGFzcygneC1ncmlkMy1oZC1jaGVja2VyLW9uJyk7CiAgICAgICAgICAgIGlmKGlzQ2hlY2tlZCl7CiAgICAgICAgICAgICAgICBoZC5yZW1vdmVDbGFzcygneC1ncmlkMy1oZC1jaGVja2VyLW9uJyk7CiAgICAgICAgICAgICAgICB0aGlzLmNsZWFyU2VsZWN0aW9ucygpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGhkLmFkZENsYXNzKCd4LWdyaWQzLWhkLWNoZWNrZXItb24nKTsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0QWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVuZGVyZXIgOiBmdW5jdGlvbih2LCBwLCByZWNvcmQpewogICAgICAgIHJldHVybiAnPGRpdiBjbGFzcz0ieC1ncmlkMy1yb3ctY2hlY2tlciI+JiMxNjA7PC9kaXY+JzsKICAgIH0sCiAgICAKICAgIG9uRWRpdG9yU2VsZWN0OiBmdW5jdGlvbihyb3csIGxhc3RSb3cpewogICAgICAgIGlmKGxhc3RSb3cgIT0gcm93ICYmICF0aGlzLmNoZWNrT25seSl7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0Um93KHJvdyk7IAogICAgICAgIH0KICAgIH0KfSk7CkV4dC5ncmlkLkNlbGxTZWxlY3Rpb25Nb2RlbCA9IEV4dC5leHRlbmQoRXh0LmdyaWQuQWJzdHJhY3RTZWxlY3Rpb25Nb2RlbCwgIHsKICAgIAogICAgY29uc3RydWN0b3IgOiBmdW5jdGlvbihjb25maWcpewogICAgICAgIEV4dC5hcHBseSh0aGlzLCBjb25maWcpOwoKCSAgICB0aGlzLnNlbGVjdGlvbiA9IG51bGw7CgkKCSAgICB0aGlzLmFkZEV2ZW50cygKCSAgICAgICAgCgkgICAgICAgICJiZWZvcmVjZWxsc2VsZWN0IiwKCSAgICAgICAgCgkgICAgICAgICJjZWxsc2VsZWN0IiwKCSAgICAgICAgCgkgICAgICAgICJzZWxlY3Rpb25jaGFuZ2UiCgkgICAgKTsKCQoJICAgIEV4dC5ncmlkLkNlbGxTZWxlY3Rpb25Nb2RlbC5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyk7CiAgICB9LAoKICAgIAogICAgaW5pdEV2ZW50cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5ncmlkLm9uKCdjZWxsbW91c2Vkb3duJywgdGhpcy5oYW5kbGVNb3VzZURvd24sIHRoaXMpOwogICAgICAgIHRoaXMuZ3JpZC5vbihFeHQuRXZlbnRNYW5hZ2VyLmdldEtleUV2ZW50KCksIHRoaXMuaGFuZGxlS2V5RG93biwgdGhpcyk7CiAgICAgICAgdGhpcy5ncmlkLmdldFZpZXcoKS5vbih7CiAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICByZWZyZXNoOiB0aGlzLm9uVmlld0NoYW5nZSwKICAgICAgICAgICAgcm93dXBkYXRlZDogdGhpcy5vblJvd1VwZGF0ZWQsCiAgICAgICAgICAgIGJlZm9yZXJvd3JlbW92ZWQ6IHRoaXMuY2xlYXJTZWxlY3Rpb25zLAogICAgICAgICAgICBiZWZvcmVyb3dzaW5zZXJ0ZWQ6IHRoaXMuY2xlYXJTZWxlY3Rpb25zCiAgICAgICAgfSk7CiAgICAgICAgaWYodGhpcy5ncmlkLmlzRWRpdG9yKXsKICAgICAgICAgICAgdGhpcy5ncmlkLm9uKCdiZWZvcmVlZGl0JywgdGhpcy5iZWZvcmVFZGl0LCAgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCgkKICAgIGJlZm9yZUVkaXQgOiBmdW5jdGlvbihlKXsKICAgICAgICB0aGlzLnNlbGVjdChlLnJvdywgZS5jb2x1bW4sIGZhbHNlLCB0cnVlLCBlLnJlY29yZCk7CiAgICB9LAoKCQogICAgb25Sb3dVcGRhdGVkIDogZnVuY3Rpb24odiwgaW5kZXgsIHIpewogICAgICAgIGlmKHRoaXMuc2VsZWN0aW9uICYmIHRoaXMuc2VsZWN0aW9uLnJlY29yZCA9PSByKXsKICAgICAgICAgICAgdi5vbkNlbGxTZWxlY3QoaW5kZXgsIHRoaXMuc2VsZWN0aW9uLmNlbGxbMV0pOwogICAgICAgIH0KICAgIH0sCgoJCiAgICBvblZpZXdDaGFuZ2UgOiBmdW5jdGlvbigpewogICAgICAgIHRoaXMuY2xlYXJTZWxlY3Rpb25zKHRydWUpOwogICAgfSwKCgkKICAgIGdldFNlbGVjdGVkQ2VsbCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0aW9uID8gdGhpcy5zZWxlY3Rpb24uY2VsbCA6IG51bGw7CiAgICB9LAoKICAgIAogICAgY2xlYXJTZWxlY3Rpb25zIDogZnVuY3Rpb24ocHJldmVudE5vdGlmeSl7CiAgICAgICAgdmFyIHMgPSB0aGlzLnNlbGVjdGlvbjsKICAgICAgICBpZihzKXsKICAgICAgICAgICAgaWYocHJldmVudE5vdGlmeSAhPT0gdHJ1ZSl7CiAgICAgICAgICAgICAgICB0aGlzLmdyaWQudmlldy5vbkNlbGxEZXNlbGVjdChzLmNlbGxbMF0sIHMuY2VsbFsxXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zZWxlY3Rpb24gPSBudWxsOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgic2VsZWN0aW9uY2hhbmdlIiwgdGhpcywgbnVsbCk7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGhhc1NlbGVjdGlvbiA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0aW9uID8gdHJ1ZSA6IGZhbHNlOwogICAgfSwKCiAgICAKICAgIGhhbmRsZU1vdXNlRG93biA6IGZ1bmN0aW9uKGcsIHJvdywgY2VsbCwgZSl7CiAgICAgICAgaWYoZS5idXR0b24gIT09IDAgfHwgdGhpcy5pc0xvY2tlZCgpKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLnNlbGVjdChyb3csIGNlbGwpOwogICAgfSwKCiAgICAKICAgIHNlbGVjdCA6IGZ1bmN0aW9uKHJvd0luZGV4LCBjb2xJbmRleCwgcHJldmVudFZpZXdOb3RpZnksIHByZXZlbnRGb2N1cywgIHIpewogICAgICAgIGlmKHRoaXMuZmlyZUV2ZW50KCJiZWZvcmVjZWxsc2VsZWN0IiwgdGhpcywgcm93SW5kZXgsIGNvbEluZGV4KSAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLmNsZWFyU2VsZWN0aW9ucygpOwogICAgICAgICAgICByID0gciB8fCB0aGlzLmdyaWQuc3RvcmUuZ2V0QXQocm93SW5kZXgpOwogICAgICAgICAgICB0aGlzLnNlbGVjdGlvbiA9IHsKICAgICAgICAgICAgICAgIHJlY29yZCA6IHIsCiAgICAgICAgICAgICAgICBjZWxsIDogW3Jvd0luZGV4LCBjb2xJbmRleF0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYoIXByZXZlbnRWaWV3Tm90aWZ5KXsKICAgICAgICAgICAgICAgIHZhciB2ID0gdGhpcy5ncmlkLmdldFZpZXcoKTsKICAgICAgICAgICAgICAgIHYub25DZWxsU2VsZWN0KHJvd0luZGV4LCBjb2xJbmRleCk7CiAgICAgICAgICAgICAgICBpZihwcmV2ZW50Rm9jdXMgIT09IHRydWUpewogICAgICAgICAgICAgICAgICAgIHYuZm9jdXNDZWxsKHJvd0luZGV4LCBjb2xJbmRleCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5maXJlRXZlbnQoImNlbGxzZWxlY3QiLCB0aGlzLCByb3dJbmRleCwgY29sSW5kZXgpOwogICAgICAgICAgICB0aGlzLmZpcmVFdmVudCgic2VsZWN0aW9uY2hhbmdlIiwgdGhpcywgdGhpcy5zZWxlY3Rpb24pOwogICAgICAgIH0KICAgIH0sCgoJCiAgICBpc1NlbGVjdGFibGUgOiBmdW5jdGlvbihyb3dJbmRleCwgY29sSW5kZXgsIGNtKXsKICAgICAgICByZXR1cm4gIWNtLmlzSGlkZGVuKGNvbEluZGV4KTsKICAgIH0sCiAgICAKICAgIAogICAgb25FZGl0b3JLZXk6IGZ1bmN0aW9uKGZpZWxkLCBlKXsKICAgICAgICBpZihlLmdldEtleSgpID09IGUuVEFCKXsKICAgICAgICAgICAgdGhpcy5oYW5kbGVLZXlEb3duKGUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBoYW5kbGVLZXlEb3duIDogZnVuY3Rpb24oZSl7CiAgICAgICAgaWYoIWUuaXNOYXZLZXlQcmVzcygpKXsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB2YXIgayA9IGUuZ2V0S2V5KCksCiAgICAgICAgICAgIGcgPSB0aGlzLmdyaWQsCiAgICAgICAgICAgIHMgPSB0aGlzLnNlbGVjdGlvbiwKICAgICAgICAgICAgc20gPSB0aGlzLAogICAgICAgICAgICB3YWxrID0gZnVuY3Rpb24ocm93LCBjb2wsIHN0ZXApewogICAgICAgICAgICAgICAgcmV0dXJuIGcud2Fsa0NlbGxzKAogICAgICAgICAgICAgICAgICAgIHJvdywKICAgICAgICAgICAgICAgICAgICBjb2wsCiAgICAgICAgICAgICAgICAgICAgc3RlcCwKICAgICAgICAgICAgICAgICAgICBnLmlzRWRpdG9yICYmIGcuZWRpdGluZyA/IHNtLmFjY2VwdHNOYXYgOiBzbS5pc1NlbGVjdGFibGUsIAogICAgICAgICAgICAgICAgICAgIHNtCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjZWxsLCBuZXdDZWxsLCByLCBjLCBhZTsKCiAgICAgICAgc3dpdGNoKGspewogICAgICAgICAgICBjYXNlIGUuRVNDOgogICAgICAgICAgICBjYXNlIGUuUEFHRV9VUDoKICAgICAgICAgICAgY2FzZSBlLlBBR0VfRE9XTjoKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGUuc3RvcEV2ZW50KCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGlmKCFzKXsKICAgICAgICAgICAgY2VsbCA9IHdhbGsoMCwgMCwgMSk7IAogICAgICAgICAgICBpZihjZWxsKXsKICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0KGNlbGxbMF0sIGNlbGxbMV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNlbGwgPSBzLmNlbGw7ICAKICAgICAgICByID0gY2VsbFswXTsgICAgCiAgICAgICAgYyA9IGNlbGxbMV07ICAgIAogICAgICAgIAogICAgICAgIHN3aXRjaChrKXsKICAgICAgICAgICAgY2FzZSBlLlRBQjoKICAgICAgICAgICAgICAgIGlmKGUuc2hpZnRLZXkpewogICAgICAgICAgICAgICAgICAgIG5ld0NlbGwgPSB3YWxrKHIsIGMgLSAxLCAtMSk7CiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICBuZXdDZWxsID0gd2FsayhyLCBjICsgMSwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBlLkRPV046CiAgICAgICAgICAgICAgICBuZXdDZWxsID0gd2FsayhyICsgMSwgYywgMSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBlLlVQOgogICAgICAgICAgICAgICAgbmV3Q2VsbCA9IHdhbGsociAtIDEsIGMsIC0xKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIGUuUklHSFQ6CiAgICAgICAgICAgICAgICBuZXdDZWxsID0gd2FsayhyLCBjICsgMSwgMSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBlLkxFRlQ6CiAgICAgICAgICAgICAgICBuZXdDZWxsID0gd2FsayhyLCBjIC0gMSwgLTEpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgZS5FTlRFUjoKICAgICAgICAgICAgICAgIGlmIChnLmlzRWRpdG9yICYmICFnLmVkaXRpbmcpIHsKICAgICAgICAgICAgICAgICAgICBnLnN0YXJ0RWRpdGluZyhyLCBjKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGlmKG5ld0NlbGwpewogICAgICAgICAgICAKICAgICAgICAgICAgciA9IG5ld0NlbGxbMF07CiAgICAgICAgICAgIGMgPSBuZXdDZWxsWzFdOwoKICAgICAgICAgICAgdGhpcy5zZWxlY3QociwgYyk7IAoKICAgICAgICAgICAgaWYoZy5pc0VkaXRvciAmJiBnLmVkaXRpbmcpeyAKICAgICAgICAgICAgICAgIGFlID0gZy5hY3RpdmVFZGl0b3I7CiAgICAgICAgICAgICAgICBpZihhZSAmJiBhZS5maWVsZC50cmlnZ2VyQmx1cil7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgYWUuZmllbGQudHJpZ2dlckJsdXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGcuc3RhcnRFZGl0aW5nKHIsIGMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICBhY2NlcHRzTmF2IDogZnVuY3Rpb24ocm93LCBjb2wsIGNtKXsKICAgICAgICByZXR1cm4gIWNtLmlzSGlkZGVuKGNvbCkgJiYgY20uaXNDZWxsRWRpdGFibGUoY29sLCByb3cpOwogICAgfQp9KTsKRXh0LmdyaWQuRWRpdG9yR3JpZFBhbmVsID0gRXh0LmV4dGVuZChFeHQuZ3JpZC5HcmlkUGFuZWwsIHsKICAgIAogICAgY2xpY2tzVG9FZGl0OiAyLAoKICAgIAogICAgZm9yY2VWYWxpZGF0aW9uOiBmYWxzZSwKCiAgICAKICAgIGlzRWRpdG9yIDogdHJ1ZSwKICAgIAogICAgZGV0ZWN0RWRpdDogZmFsc2UsCgogICAgCiAgICBhdXRvRW5jb2RlIDogZmFsc2UsCgogICAgCiAgICAKICAgIHRyYWNrTW91c2VPdmVyOiBmYWxzZSwgCgogICAgCiAgICBpbml0Q29tcG9uZW50IDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZ3JpZC5FZGl0b3JHcmlkUGFuZWwuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7CgogICAgICAgIGlmKCF0aGlzLnNlbE1vZGVsKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2VsTW9kZWwgPSBuZXcgRXh0LmdyaWQuQ2VsbFNlbGVjdGlvbk1vZGVsKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmFjdGl2ZUVkaXRvciA9IG51bGw7CgogICAgICAgIHRoaXMuYWRkRXZlbnRzKAogICAgICAgICAgICAKICAgICAgICAgICAgImJlZm9yZWVkaXQiLAogICAgICAgICAgICAKICAgICAgICAgICAgImFmdGVyZWRpdCIsCiAgICAgICAgICAgIAogICAgICAgICAgICAidmFsaWRhdGVlZGl0IgogICAgICAgICk7CiAgICB9LAoKICAgIAogICAgaW5pdEV2ZW50cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmdyaWQuRWRpdG9yR3JpZFBhbmVsLnN1cGVyY2xhc3MuaW5pdEV2ZW50cy5jYWxsKHRoaXMpOwoKICAgICAgICB0aGlzLmdldEdyaWRFbCgpLm9uKCdtb3VzZXdoZWVsJywgdGhpcy5zdG9wRWRpdGluZy5jcmVhdGVEZWxlZ2F0ZSh0aGlzLCBbdHJ1ZV0pLCB0aGlzKTsKICAgICAgICB0aGlzLm9uKCdjb2x1bW5yZXNpemUnLCB0aGlzLnN0b3BFZGl0aW5nLCB0aGlzLCBbdHJ1ZV0pOwoKICAgICAgICBpZih0aGlzLmNsaWNrc1RvRWRpdCA9PSAxKXsKICAgICAgICAgICAgdGhpcy5vbigiY2VsbGNsaWNrIiwgdGhpcy5vbkNlbGxEYmxDbGljaywgdGhpcyk7CiAgICAgICAgfWVsc2UgewogICAgICAgICAgICB2YXIgdmlldyA9IHRoaXMuZ2V0VmlldygpOwogICAgICAgICAgICBpZih0aGlzLmNsaWNrc1RvRWRpdCA9PSAnYXV0bycgJiYgdmlldy5tYWluQm9keSl7CiAgICAgICAgICAgICAgICB2aWV3Lm1haW5Cb2R5Lm9uKCdtb3VzZWRvd24nLCB0aGlzLm9uQXV0b0VkaXRDbGljaywgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5vbignY2VsbGRibGNsaWNrJywgdGhpcy5vbkNlbGxEYmxDbGljaywgdGhpcyk7CiAgICAgICAgfQogICAgfSwKCiAgICBvblJlc2l6ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmdyaWQuRWRpdG9yR3JpZFBhbmVsLnN1cGVyY2xhc3Mub25SZXNpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB2YXIgYWUgPSB0aGlzLmFjdGl2ZUVkaXRvcjsKICAgICAgICBpZih0aGlzLmVkaXRpbmcgJiYgYWUpewogICAgICAgICAgICBhZS5yZWFsaWduKHRydWUpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkNlbGxEYmxDbGljayA6IGZ1bmN0aW9uKGcsIHJvdywgY29sKXsKICAgICAgICB0aGlzLnN0YXJ0RWRpdGluZyhyb3csIGNvbCk7CiAgICB9LAoKICAgIAogICAgb25BdXRvRWRpdENsaWNrIDogZnVuY3Rpb24oZSwgdCl7CiAgICAgICAgaWYoZS5idXR0b24gIT09IDApewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciByb3cgPSB0aGlzLnZpZXcuZmluZFJvd0luZGV4KHQpLAogICAgICAgICAgICBjb2wgPSB0aGlzLnZpZXcuZmluZENlbGxJbmRleCh0KTsKICAgICAgICBpZihyb3cgIT09IGZhbHNlICYmIGNvbCAhPT0gZmFsc2UpewogICAgICAgICAgICB0aGlzLnN0b3BFZGl0aW5nKCk7CiAgICAgICAgICAgIGlmKHRoaXMuc2VsTW9kZWwuZ2V0U2VsZWN0ZWRDZWxsKXsgCiAgICAgICAgICAgICAgICB2YXIgc2MgPSB0aGlzLnNlbE1vZGVsLmdldFNlbGVjdGVkQ2VsbCgpOwogICAgICAgICAgICAgICAgaWYoc2MgJiYgc2NbMF0gPT09IHJvdyAmJiBzY1sxXSA9PT0gY29sKXsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0RWRpdGluZyhyb3csIGNvbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgaWYodGhpcy5zZWxNb2RlbC5pc1NlbGVjdGVkKHJvdykpewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRFZGl0aW5nKHJvdywgY29sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkVkaXRDb21wbGV0ZSA6IGZ1bmN0aW9uKGVkLCB2YWx1ZSwgc3RhcnRWYWx1ZSl7CiAgICAgICAgdGhpcy5lZGl0aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5sYXN0QWN0aXZlRWRpdG9yID0gdGhpcy5hY3RpdmVFZGl0b3I7CiAgICAgICAgdGhpcy5hY3RpdmVFZGl0b3IgPSBudWxsOwoKICAgICAgICB2YXIgciA9IGVkLnJlY29yZCwKICAgICAgICAgICAgZmllbGQgPSB0aGlzLmNvbE1vZGVsLmdldERhdGFJbmRleChlZC5jb2wpOwogICAgICAgIHZhbHVlID0gdGhpcy5wb3N0RWRpdFZhbHVlKHZhbHVlLCBzdGFydFZhbHVlLCByLCBmaWVsZCk7CiAgICAgICAgaWYodGhpcy5mb3JjZVZhbGlkYXRpb24gPT09IHRydWUgfHwgU3RyaW5nKHZhbHVlKSAhPT0gU3RyaW5nKHN0YXJ0VmFsdWUpKXsKICAgICAgICAgICAgdmFyIGUgPSB7CiAgICAgICAgICAgICAgICBncmlkOiB0aGlzLAogICAgICAgICAgICAgICAgcmVjb3JkOiByLAogICAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkLAogICAgICAgICAgICAgICAgb3JpZ2luYWxWYWx1ZTogc3RhcnRWYWx1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICAgIHJvdzogZWQucm93LAogICAgICAgICAgICAgICAgY29sdW1uOiBlZC5jb2wsCiAgICAgICAgICAgICAgICBjYW5jZWw6ZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoInZhbGlkYXRlZWRpdCIsIGUpICE9PSBmYWxzZSAmJiAhZS5jYW5jZWwgJiYgU3RyaW5nKHZhbHVlKSAhPT0gU3RyaW5nKHN0YXJ0VmFsdWUpKXsKICAgICAgICAgICAgICAgIHIuc2V0KGZpZWxkLCBlLnZhbHVlKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBlLmNhbmNlbDsKICAgICAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCJhZnRlcmVkaXQiLCBlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnZpZXcuZm9jdXNDZWxsKGVkLnJvdywgZWQuY29sKTsKICAgIH0sCgogICAgCiAgICBzdGFydEVkaXRpbmcgOiBmdW5jdGlvbihyb3csIGNvbCl7CiAgICAgICAgdGhpcy5zdG9wRWRpdGluZygpOwogICAgICAgIGlmKHRoaXMuY29sTW9kZWwuaXNDZWxsRWRpdGFibGUoY29sLCByb3cpKXsKICAgICAgICAgICAgdGhpcy52aWV3LmVuc3VyZVZpc2libGUocm93LCBjb2wsIHRydWUpOwogICAgICAgICAgICB2YXIgciA9IHRoaXMuc3RvcmUuZ2V0QXQocm93KSwKICAgICAgICAgICAgICAgIGZpZWxkID0gdGhpcy5jb2xNb2RlbC5nZXREYXRhSW5kZXgoY29sKSwKICAgICAgICAgICAgICAgIGUgPSB7CiAgICAgICAgICAgICAgICAgICAgZ3JpZDogdGhpcywKICAgICAgICAgICAgICAgICAgICByZWNvcmQ6IHIsCiAgICAgICAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiByLmRhdGFbZmllbGRdLAogICAgICAgICAgICAgICAgICAgIHJvdzogcm93LAogICAgICAgICAgICAgICAgICAgIGNvbHVtbjogY29sLAogICAgICAgICAgICAgICAgICAgIGNhbmNlbDpmYWxzZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYodGhpcy5maXJlRXZlbnQoImJlZm9yZWVkaXQiLCBlKSAhPT0gZmFsc2UgJiYgIWUuY2FuY2VsKXsKICAgICAgICAgICAgICAgIHRoaXMuZWRpdGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgZWQgPSB0aGlzLmNvbE1vZGVsLmdldENlbGxFZGl0b3IoY29sLCByb3cpOwogICAgICAgICAgICAgICAgaWYoIWVkKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZighZWQucmVuZGVyZWQpewogICAgICAgICAgICAgICAgICAgIGVkLnBhcmVudEVsID0gdGhpcy52aWV3LmdldEVkaXRvclBhcmVudChlZCk7CiAgICAgICAgICAgICAgICAgICAgZWQub24oewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZTogdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24oYyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYy5maWVsZC5mb2N1cyhmYWxzZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2luZ2xlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lhbGtleTogZnVuY3Rpb24oZmllbGQsIGUpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRTZWxlY3Rpb25Nb2RlbCgpLm9uRWRpdG9yS2V5KGZpZWxkLCBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IHRoaXMub25FZGl0Q29tcGxldGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGNhbmNlbGVkaXQ6IHRoaXMuc3RvcEVkaXRpbmcuY3JlYXRlRGVsZWdhdGUodGhpcywgW3RydWVdKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgRXh0LmFwcGx5KGVkLCB7CiAgICAgICAgICAgICAgICAgICAgcm93ICAgICA6IHJvdywKICAgICAgICAgICAgICAgICAgICBjb2wgICAgIDogY29sLAogICAgICAgICAgICAgICAgICAgIHJlY29yZCAgOiByCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRoaXMubGFzdEVkaXQgPSB7CiAgICAgICAgICAgICAgICAgICAgcm93OiByb3csCiAgICAgICAgICAgICAgICAgICAgY29sOiBjb2wKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZUVkaXRvciA9IGVkOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVkLnNlbGVjdFNhbWVFZGl0b3IgPSAodGhpcy5hY3RpdmVFZGl0b3IgPT0gdGhpcy5sYXN0QWN0aXZlRWRpdG9yKTsKICAgICAgICAgICAgICAgIHZhciB2ID0gdGhpcy5wcmVFZGl0VmFsdWUociwgZmllbGQpOwogICAgICAgICAgICAgICAgZWQuc3RhcnRFZGl0KHRoaXMudmlldy5nZXRDZWxsKHJvdywgY29sKS5maXJzdENoaWxkLCBFeHQuaXNEZWZpbmVkKHYpID8gdiA6ICcnKTsKCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBlZC5zZWxlY3RTYW1lRWRpdG9yOwogICAgICAgICAgICAgICAgfSkuZGVmZXIoNTApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIHByZUVkaXRWYWx1ZSA6IGZ1bmN0aW9uKHIsIGZpZWxkKXsKICAgICAgICB2YXIgdmFsdWUgPSByLmRhdGFbZmllbGRdOwogICAgICAgIHJldHVybiB0aGlzLmF1dG9FbmNvZGUgJiYgRXh0LmlzU3RyaW5nKHZhbHVlKSA/IEV4dC51dGlsLkZvcm1hdC5odG1sRGVjb2RlKHZhbHVlKSA6IHZhbHVlOwogICAgfSwKCiAgICAKICAgIHBvc3RFZGl0VmFsdWUgOiBmdW5jdGlvbih2YWx1ZSwgb3JpZ2luYWxWYWx1ZSwgciwgZmllbGQpewogICAgICAgIHJldHVybiB0aGlzLmF1dG9FbmNvZGUgJiYgRXh0LmlzU3RyaW5nKHZhbHVlKSA/IEV4dC51dGlsLkZvcm1hdC5odG1sRW5jb2RlKHZhbHVlKSA6IHZhbHVlOwogICAgfSwKCiAgICAKICAgIHN0b3BFZGl0aW5nIDogZnVuY3Rpb24oY2FuY2VsKXsKICAgICAgICBpZih0aGlzLmVkaXRpbmcpewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGFlID0gdGhpcy5sYXN0QWN0aXZlRWRpdG9yID0gdGhpcy5hY3RpdmVFZGl0b3I7CiAgICAgICAgICAgIGlmKGFlKXsKICAgICAgICAgICAgICAgIGFlW2NhbmNlbCA9PT0gdHJ1ZSA/ICdjYW5jZWxFZGl0JyA6ICdjb21wbGV0ZUVkaXQnXSgpOwogICAgICAgICAgICAgICAgdGhpcy52aWV3LmZvY3VzQ2VsbChhZS5yb3csIGFlLmNvbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5hY3RpdmVFZGl0b3IgPSBudWxsOwogICAgICAgIH0KICAgICAgICB0aGlzLmVkaXRpbmcgPSBmYWxzZTsKICAgIH0KfSk7CkV4dC5yZWcoJ2VkaXRvcmdyaWQnLCBFeHQuZ3JpZC5FZGl0b3JHcmlkUGFuZWwpOwoKRXh0LmdyaWQuR3JpZEVkaXRvciA9IGZ1bmN0aW9uKGZpZWxkLCBjb25maWcpewogICAgRXh0LmdyaWQuR3JpZEVkaXRvci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcywgZmllbGQsIGNvbmZpZyk7CiAgICBmaWVsZC5tb25pdG9yVGFiID0gZmFsc2U7Cn07CgpFeHQuZXh0ZW5kKEV4dC5ncmlkLkdyaWRFZGl0b3IsIEV4dC5FZGl0b3IsIHsKICAgIGFsaWdubWVudDogInRsLXRsIiwKICAgIGF1dG9TaXplOiAid2lkdGgiLAogICAgaGlkZUVsIDogZmFsc2UsCiAgICBjbHM6ICJ4LXNtYWxsLWVkaXRvciB4LWdyaWQtZWRpdG9yIiwKICAgIHNoaW06ZmFsc2UsCiAgICBzaGFkb3c6ZmFsc2UKfSk7CkV4dC5ncmlkLlByb3BlcnR5UmVjb3JkID0gRXh0LmRhdGEuUmVjb3JkLmNyZWF0ZShbCiAgICB7bmFtZTonbmFtZScsdHlwZTonc3RyaW5nJ30sICd2YWx1ZScKXSk7CgoKRXh0LmdyaWQuUHJvcGVydHlTdG9yZSA9IEV4dC5leHRlbmQoRXh0LnV0aWwuT2JzZXJ2YWJsZSwgewogICAgCiAgICBjb25zdHJ1Y3RvciA6IGZ1bmN0aW9uKGdyaWQsIHNvdXJjZSl7CiAgICAgICAgdGhpcy5ncmlkID0gZ3JpZDsKICAgICAgICB0aGlzLnN0b3JlID0gbmV3IEV4dC5kYXRhLlN0b3JlKHsKICAgICAgICAgICAgcmVjb3JkVHlwZSA6IEV4dC5ncmlkLlByb3BlcnR5UmVjb3JkCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5zdG9yZS5vbigndXBkYXRlJywgdGhpcy5vblVwZGF0ZSwgIHRoaXMpOwogICAgICAgIGlmKHNvdXJjZSl7CiAgICAgICAgICAgIHRoaXMuc2V0U291cmNlKHNvdXJjZSk7CiAgICAgICAgfQogICAgICAgIEV4dC5ncmlkLlByb3BlcnR5U3RvcmUuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMpOyAgICAKICAgIH0sCiAgICAKICAgIAogICAgc2V0U291cmNlIDogZnVuY3Rpb24obyl7CiAgICAgICAgdGhpcy5zb3VyY2UgPSBvOwogICAgICAgIHRoaXMuc3RvcmUucmVtb3ZlQWxsKCk7CiAgICAgICAgdmFyIGRhdGEgPSBbXTsKICAgICAgICBmb3IodmFyIGsgaW4gbyl7CiAgICAgICAgICAgIGlmKHRoaXMuaXNFZGl0YWJsZVZhbHVlKG9ba10pKXsKICAgICAgICAgICAgICAgIGRhdGEucHVzaChuZXcgRXh0LmdyaWQuUHJvcGVydHlSZWNvcmQoe25hbWU6IGssIHZhbHVlOiBvW2tdfSwgaykpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RvcmUubG9hZFJlY29yZHMoe3JlY29yZHM6IGRhdGF9LCB7fSwgdHJ1ZSk7CiAgICB9LAoKICAgIAogICAgb25VcGRhdGUgOiBmdW5jdGlvbihkcywgcmVjb3JkLCB0eXBlKXsKICAgICAgICBpZih0eXBlID09IEV4dC5kYXRhLlJlY29yZC5FRElUKXsKICAgICAgICAgICAgdmFyIHYgPSByZWNvcmQuZGF0YS52YWx1ZTsKICAgICAgICAgICAgdmFyIG9sZFZhbHVlID0gcmVjb3JkLm1vZGlmaWVkLnZhbHVlOwogICAgICAgICAgICBpZih0aGlzLmdyaWQuZmlyZUV2ZW50KCdiZWZvcmVwcm9wZXJ0eWNoYW5nZScsIHRoaXMuc291cmNlLCByZWNvcmQuaWQsIHYsIG9sZFZhbHVlKSAhPT0gZmFsc2UpewogICAgICAgICAgICAgICAgdGhpcy5zb3VyY2VbcmVjb3JkLmlkXSA9IHY7CiAgICAgICAgICAgICAgICByZWNvcmQuY29tbWl0KCk7CiAgICAgICAgICAgICAgICB0aGlzLmdyaWQuZmlyZUV2ZW50KCdwcm9wZXJ0eWNoYW5nZScsIHRoaXMuc291cmNlLCByZWNvcmQuaWQsIHYsIG9sZFZhbHVlKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICByZWNvcmQucmVqZWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZ2V0UHJvcGVydHkgOiBmdW5jdGlvbihyb3cpewogICAgICAgcmV0dXJuIHRoaXMuc3RvcmUuZ2V0QXQocm93KTsKICAgIH0sCgogICAgCiAgICBpc0VkaXRhYmxlVmFsdWU6IGZ1bmN0aW9uKHZhbCl7CiAgICAgICAgcmV0dXJuIEV4dC5pc1ByaW1pdGl2ZSh2YWwpIHx8IEV4dC5pc0RhdGUodmFsKTsKICAgIH0sCgogICAgCiAgICBzZXRWYWx1ZSA6IGZ1bmN0aW9uKHByb3AsIHZhbHVlLCBjcmVhdGUpewogICAgICAgIHZhciByID0gdGhpcy5nZXRSZWMocHJvcCk7CiAgICAgICAgaWYocil7CiAgICAgICAgICAgIHIuc2V0KCd2YWx1ZScsIHZhbHVlKTsKICAgICAgICAgICAgdGhpcy5zb3VyY2VbcHJvcF0gPSB2YWx1ZTsKICAgICAgICB9ZWxzZSBpZihjcmVhdGUpewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5zb3VyY2VbcHJvcF0gPSB2YWx1ZTsKICAgICAgICAgICAgciA9IG5ldyBFeHQuZ3JpZC5Qcm9wZXJ0eVJlY29yZCh7bmFtZTogcHJvcCwgdmFsdWU6IHZhbHVlfSwgcHJvcCk7CiAgICAgICAgICAgIHRoaXMuc3RvcmUuYWRkKHIpOwoKICAgICAgICB9CiAgICB9LAogICAgCiAgICAKICAgIHJlbW92ZSA6IGZ1bmN0aW9uKHByb3ApewogICAgICAgIHZhciByID0gdGhpcy5nZXRSZWMocHJvcCk7CiAgICAgICAgaWYocil7CiAgICAgICAgICAgIHRoaXMuc3RvcmUucmVtb3ZlKHIpOwogICAgICAgICAgICBkZWxldGUgdGhpcy5zb3VyY2VbcHJvcF07CiAgICAgICAgfQogICAgfSwKICAgIAogICAgCiAgICBnZXRSZWMgOiBmdW5jdGlvbihwcm9wKXsKICAgICAgICByZXR1cm4gdGhpcy5zdG9yZS5nZXRCeUlkKHByb3ApOwogICAgfSwKCiAgICAKICAgIGdldFNvdXJjZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMuc291cmNlOwogICAgfQp9KTsKCgpFeHQuZ3JpZC5Qcm9wZXJ0eUNvbHVtbk1vZGVsID0gRXh0LmV4dGVuZChFeHQuZ3JpZC5Db2x1bW5Nb2RlbCwgewogICAgCiAgICBuYW1lVGV4dCA6ICdOYW1lJywKICAgIHZhbHVlVGV4dCA6ICdWYWx1ZScsCiAgICBkYXRlRm9ybWF0IDogJ20vai9ZJywKICAgIHRydWVUZXh0OiAndHJ1ZScsCiAgICBmYWxzZVRleHQ6ICdmYWxzZScsCiAgICAKICAgIGNvbnN0cnVjdG9yIDogZnVuY3Rpb24oZ3JpZCwgc3RvcmUpewogICAgICAgIHZhciBnID0gRXh0LmdyaWQsCgkgICAgICAgIGYgPSBFeHQuZm9ybTsKCSAgICAgICAgCgkgICAgdGhpcy5ncmlkID0gZ3JpZDsKCSAgICBnLlByb3BlcnR5Q29sdW1uTW9kZWwuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsIFsKCSAgICAgICAge2hlYWRlcjogdGhpcy5uYW1lVGV4dCwgd2lkdGg6NTAsIHNvcnRhYmxlOiB0cnVlLCBkYXRhSW5kZXg6J25hbWUnLCBpZDogJ25hbWUnLCBtZW51RGlzYWJsZWQ6dHJ1ZX0sCgkgICAgICAgIHtoZWFkZXI6IHRoaXMudmFsdWVUZXh0LCB3aWR0aDo1MCwgcmVzaXphYmxlOmZhbHNlLCBkYXRhSW5kZXg6ICd2YWx1ZScsIGlkOiAndmFsdWUnLCBtZW51RGlzYWJsZWQ6dHJ1ZX0KCSAgICBdKTsKCSAgICB0aGlzLnN0b3JlID0gc3RvcmU7CgkKCSAgICB2YXIgYmZpZWxkID0gbmV3IGYuRmllbGQoewoJICAgICAgICBhdXRvQ3JlYXRlOiB7dGFnOiAnc2VsZWN0JywgY2hpbGRyZW46IFsKCSAgICAgICAgICAgIHt0YWc6ICdvcHRpb24nLCB2YWx1ZTogJ3RydWUnLCBodG1sOiB0aGlzLnRydWVUZXh0fSwKCSAgICAgICAgICAgIHt0YWc6ICdvcHRpb24nLCB2YWx1ZTogJ2ZhbHNlJywgaHRtbDogdGhpcy5mYWxzZVRleHR9CgkgICAgICAgIF19LAoJICAgICAgICBnZXRWYWx1ZSA6IGZ1bmN0aW9uKCl7CgkgICAgICAgICAgICByZXR1cm4gdGhpcy5lbC5kb20udmFsdWUgPT0gJ3RydWUnOwoJICAgICAgICB9CgkgICAgfSk7CgkgICAgdGhpcy5lZGl0b3JzID0gewoJICAgICAgICAnZGF0ZScgOiBuZXcgZy5HcmlkRWRpdG9yKG5ldyBmLkRhdGVGaWVsZCh7c2VsZWN0T25Gb2N1czp0cnVlfSkpLAoJICAgICAgICAnc3RyaW5nJyA6IG5ldyBnLkdyaWRFZGl0b3IobmV3IGYuVGV4dEZpZWxkKHtzZWxlY3RPbkZvY3VzOnRydWV9KSksCgkgICAgICAgICdudW1iZXInIDogbmV3IGcuR3JpZEVkaXRvcihuZXcgZi5OdW1iZXJGaWVsZCh7c2VsZWN0T25Gb2N1czp0cnVlLCBzdHlsZTondGV4dC1hbGlnbjpsZWZ0Oyd9KSksCgkgICAgICAgICdib29sZWFuJyA6IG5ldyBnLkdyaWRFZGl0b3IoYmZpZWxkLCB7CgkgICAgICAgICAgICBhdXRvU2l6ZTogJ2JvdGgnCgkgICAgICAgIH0pCgkgICAgfTsKCSAgICB0aGlzLnJlbmRlckNlbGxEZWxlZ2F0ZSA9IHRoaXMucmVuZGVyQ2VsbC5jcmVhdGVEZWxlZ2F0ZSh0aGlzKTsKCSAgICB0aGlzLnJlbmRlclByb3BEZWxlZ2F0ZSA9IHRoaXMucmVuZGVyUHJvcC5jcmVhdGVEZWxlZ2F0ZSh0aGlzKTsKICAgIH0sCgogICAgCiAgICByZW5kZXJEYXRlIDogZnVuY3Rpb24oZGF0ZVZhbCl7CiAgICAgICAgcmV0dXJuIGRhdGVWYWwuZGF0ZUZvcm1hdCh0aGlzLmRhdGVGb3JtYXQpOwogICAgfSwKCiAgICAKICAgIHJlbmRlckJvb2wgOiBmdW5jdGlvbihiVmFsKXsKICAgICAgICByZXR1cm4gdGhpc1tiVmFsID8gJ3RydWVUZXh0JyA6ICdmYWxzZVRleHQnXTsKICAgIH0sCgogICAgCiAgICBpc0NlbGxFZGl0YWJsZSA6IGZ1bmN0aW9uKGNvbEluZGV4LCByb3dJbmRleCl7CiAgICAgICAgcmV0dXJuIGNvbEluZGV4ID09IDE7CiAgICB9LAoKICAgIAogICAgZ2V0UmVuZGVyZXIgOiBmdW5jdGlvbihjb2wpewogICAgICAgIHJldHVybiBjb2wgPT0gMSA/CiAgICAgICAgICAgIHRoaXMucmVuZGVyQ2VsbERlbGVnYXRlIDogdGhpcy5yZW5kZXJQcm9wRGVsZWdhdGU7CiAgICB9LAoKICAgIAogICAgcmVuZGVyUHJvcCA6IGZ1bmN0aW9uKHYpewogICAgICAgIHJldHVybiB0aGlzLmdldFByb3BlcnR5TmFtZSh2KTsKICAgIH0sCgogICAgCiAgICByZW5kZXJDZWxsIDogZnVuY3Rpb24odmFsLCBtZXRhLCByZWMpewogICAgICAgIHZhciByZW5kZXJlciA9IHRoaXMuZ3JpZC5jdXN0b21SZW5kZXJlcnNbcmVjLmdldCgnbmFtZScpXTsKICAgICAgICBpZihyZW5kZXJlcil7CiAgICAgICAgICAgIHJldHVybiByZW5kZXJlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICB2YXIgcnYgPSB2YWw7CiAgICAgICAgaWYoRXh0LmlzRGF0ZSh2YWwpKXsKICAgICAgICAgICAgcnYgPSB0aGlzLnJlbmRlckRhdGUodmFsKTsKICAgICAgICB9ZWxzZSBpZih0eXBlb2YgdmFsID09ICdib29sZWFuJyl7CiAgICAgICAgICAgIHJ2ID0gdGhpcy5yZW5kZXJCb29sKHZhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBFeHQudXRpbC5Gb3JtYXQuaHRtbEVuY29kZShydik7CiAgICB9LAoKICAgIAogICAgZ2V0UHJvcGVydHlOYW1lIDogZnVuY3Rpb24obmFtZSl7CiAgICAgICAgdmFyIHBuID0gdGhpcy5ncmlkLnByb3BlcnR5TmFtZXM7CiAgICAgICAgcmV0dXJuIHBuICYmIHBuW25hbWVdID8gcG5bbmFtZV0gOiBuYW1lOwogICAgfSwKCiAgICAKICAgIGdldENlbGxFZGl0b3IgOiBmdW5jdGlvbihjb2xJbmRleCwgcm93SW5kZXgpewogICAgICAgIHZhciBwID0gdGhpcy5zdG9yZS5nZXRQcm9wZXJ0eShyb3dJbmRleCksCiAgICAgICAgICAgIG4gPSBwLmRhdGEubmFtZSwgCiAgICAgICAgICAgIHZhbCA9IHAuZGF0YS52YWx1ZTsKICAgICAgICBpZih0aGlzLmdyaWQuY3VzdG9tRWRpdG9yc1tuXSl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdyaWQuY3VzdG9tRWRpdG9yc1tuXTsKICAgICAgICB9CiAgICAgICAgaWYoRXh0LmlzRGF0ZSh2YWwpKXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWRpdG9ycy5kYXRlOwogICAgICAgIH1lbHNlIGlmKHR5cGVvZiB2YWwgPT0gJ251bWJlcicpewogICAgICAgICAgICByZXR1cm4gdGhpcy5lZGl0b3JzLm51bWJlcjsKICAgICAgICB9ZWxzZSBpZih0eXBlb2YgdmFsID09ICdib29sZWFuJyl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVkaXRvcnNbJ2Jvb2xlYW4nXTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWRpdG9ycy5zdHJpbmc7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgIEV4dC5ncmlkLlByb3BlcnR5Q29sdW1uTW9kZWwuc3VwZXJjbGFzcy5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5kZXN0cm95RWRpdG9ycyh0aGlzLmVkaXRvcnMpOwogICAgICAgIHRoaXMuZGVzdHJveUVkaXRvcnModGhpcy5ncmlkLmN1c3RvbUVkaXRvcnMpOwogICAgfSwKICAgIAogICAgZGVzdHJveUVkaXRvcnM6IGZ1bmN0aW9uKGVkaXRvcnMpewogICAgICAgIGZvcih2YXIgZWQgaW4gZWRpdG9ycyl7CiAgICAgICAgICAgIEV4dC5kZXN0cm95KGVkaXRvcnNbZWRdKTsKICAgICAgICB9CiAgICB9Cn0pOwoKCkV4dC5ncmlkLlByb3BlcnR5R3JpZCA9IEV4dC5leHRlbmQoRXh0LmdyaWQuRWRpdG9yR3JpZFBhbmVsLCB7CiAgICAKICAgIAogICAgCiAgICAKICAgIAoKICAgIAogICAgZW5hYmxlQ29sdW1uTW92ZTpmYWxzZSwKICAgIHN0cmlwZVJvd3M6ZmFsc2UsCiAgICB0cmFja01vdXNlT3ZlcjogZmFsc2UsCiAgICBjbGlja3NUb0VkaXQ6MSwKICAgIGVuYWJsZUhkTWVudSA6IGZhbHNlLAogICAgdmlld0NvbmZpZyA6IHsKICAgICAgICBmb3JjZUZpdDp0cnVlCiAgICB9LAoKICAgIAogICAgaW5pdENvbXBvbmVudCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5jdXN0b21SZW5kZXJlcnMgPSB0aGlzLmN1c3RvbVJlbmRlcmVycyB8fCB7fTsKICAgICAgICB0aGlzLmN1c3RvbUVkaXRvcnMgPSB0aGlzLmN1c3RvbUVkaXRvcnMgfHwge307CiAgICAgICAgdGhpcy5sYXN0RWRpdFJvdyA9IG51bGw7CiAgICAgICAgdmFyIHN0b3JlID0gbmV3IEV4dC5ncmlkLlByb3BlcnR5U3RvcmUodGhpcyk7CiAgICAgICAgdGhpcy5wcm9wU3RvcmUgPSBzdG9yZTsKICAgICAgICB2YXIgY20gPSBuZXcgRXh0LmdyaWQuUHJvcGVydHlDb2x1bW5Nb2RlbCh0aGlzLCBzdG9yZSk7CiAgICAgICAgc3RvcmUuc3RvcmUuc29ydCgnbmFtZScsICdBU0MnKTsKICAgICAgICB0aGlzLmFkZEV2ZW50cygKICAgICAgICAgICAgCiAgICAgICAgICAgICdiZWZvcmVwcm9wZXJ0eWNoYW5nZScsCiAgICAgICAgICAgIAogICAgICAgICAgICAncHJvcGVydHljaGFuZ2UnCiAgICAgICAgKTsKICAgICAgICB0aGlzLmNtID0gY207CiAgICAgICAgdGhpcy5kcyA9IHN0b3JlLnN0b3JlOwogICAgICAgIEV4dC5ncmlkLlByb3BlcnR5R3JpZC5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTsKCgkJdGhpcy5tb24odGhpcy5zZWxNb2RlbCwgJ2JlZm9yZWNlbGxzZWxlY3QnLCBmdW5jdGlvbihzbSwgcm93SW5kZXgsIGNvbEluZGV4KXsKICAgICAgICAgICAgaWYoY29sSW5kZXggPT09IDApewogICAgICAgICAgICAgICAgdGhpcy5zdGFydEVkaXRpbmcuZGVmZXIoMjAwLCB0aGlzLCBbcm93SW5kZXgsIDFdKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0sIHRoaXMpOwogICAgfSwKCiAgICAKICAgIG9uUmVuZGVyIDogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZ3JpZC5Qcm9wZXJ0eUdyaWQuc3VwZXJjbGFzcy5vblJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICB0aGlzLmdldEdyaWRFbCgpLmFkZENsYXNzKCd4LXByb3BzLWdyaWQnKTsKICAgIH0sCgogICAgCiAgICBhZnRlclJlbmRlcjogZnVuY3Rpb24oKXsKICAgICAgICBFeHQuZ3JpZC5Qcm9wZXJ0eUdyaWQuc3VwZXJjbGFzcy5hZnRlclJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGlmKHRoaXMuc291cmNlKXsKICAgICAgICAgICAgdGhpcy5zZXRTb3VyY2UodGhpcy5zb3VyY2UpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBzZXRTb3VyY2UgOiBmdW5jdGlvbihzb3VyY2UpewogICAgICAgIHRoaXMucHJvcFN0b3JlLnNldFNvdXJjZShzb3VyY2UpOwogICAgfSwKCiAgICAKICAgIGdldFNvdXJjZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHRoaXMucHJvcFN0b3JlLmdldFNvdXJjZSgpOwogICAgfSwKICAgIAogICAgCiAgICBzZXRQcm9wZXJ0eSA6IGZ1bmN0aW9uKHByb3AsIHZhbHVlLCBjcmVhdGUpewogICAgICAgIHRoaXMucHJvcFN0b3JlLnNldFZhbHVlKHByb3AsIHZhbHVlLCBjcmVhdGUpOyAgICAKICAgIH0sCiAgICAKICAgIAogICAgcmVtb3ZlUHJvcGVydHkgOiBmdW5jdGlvbihwcm9wKXsKICAgICAgICB0aGlzLnByb3BTdG9yZS5yZW1vdmUocHJvcCk7CiAgICB9CgogICAgCiAgICAKICAgIAogICAgCn0pOwpFeHQucmVnKCJwcm9wZXJ0eWdyaWQiLCBFeHQuZ3JpZC5Qcm9wZXJ0eUdyaWQpOwoKRXh0LmdyaWQuR3JvdXBpbmdWaWV3ID0gRXh0LmV4dGVuZChFeHQuZ3JpZC5HcmlkVmlldywgewoKICAgIAogICAgZ3JvdXBCeVRleHQgOiAnR3JvdXAgQnkgVGhpcyBGaWVsZCcsCiAgICAKICAgIHNob3dHcm91cHNUZXh0IDogJ1Nob3cgaW4gR3JvdXBzJywKICAgIAogICAgaGlkZUdyb3VwZWRDb2x1bW4gOiBmYWxzZSwKICAgIAogICAgc2hvd0dyb3VwTmFtZSA6IHRydWUsCiAgICAKICAgIHN0YXJ0Q29sbGFwc2VkIDogZmFsc2UsCiAgICAKICAgIGVuYWJsZUdyb3VwaW5nIDogdHJ1ZSwKICAgIAogICAgZW5hYmxlR3JvdXBpbmdNZW51IDogdHJ1ZSwKICAgIAogICAgZW5hYmxlTm9Hcm91cHMgOiB0cnVlLAogICAgCiAgICBlbXB0eUdyb3VwVGV4dCA6ICcoTm9uZSknLAogICAgCiAgICBpZ25vcmVBZGQgOiBmYWxzZSwKICAgIAogICAgZ3JvdXBUZXh0VHBsIDogJ3t0ZXh0fScsCgogICAgCiAgICBncm91cE1vZGU6ICd2YWx1ZScsCgogICAgCiAgICAKICAgIAogICAgY2FuY2VsRWRpdE9uVG9nZ2xlOiB0cnVlLAoKICAgIAogICAgaW5pdFRlbXBsYXRlcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgRXh0LmdyaWQuR3JvdXBpbmdWaWV3LnN1cGVyY2xhc3MuaW5pdFRlbXBsYXRlcy5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuc3RhdGUgPSB7fTsKCiAgICAgICAgdmFyIHNtID0gdGhpcy5ncmlkLmdldFNlbGVjdGlvbk1vZGVsKCk7CiAgICAgICAgc20ub24oc20uc2VsZWN0Um93ID8gJ2JlZm9yZXJvd3NlbGVjdCcgOiAnYmVmb3JlY2VsbHNlbGVjdCcsCiAgICAgICAgICAgICAgICB0aGlzLm9uQmVmb3JlUm93U2VsZWN0LCB0aGlzKTsKCiAgICAgICAgaWYoIXRoaXMuc3RhcnRHcm91cCl7CiAgICAgICAgICAgIHRoaXMuc3RhcnRHcm91cCA9IG5ldyBFeHQuWFRlbXBsYXRlKAogICAgICAgICAgICAgICAgJzxkaXYgaWQ9Intncm91cElkfSIgY2xhc3M9IngtZ3JpZC1ncm91cCB7Y2xzfSI+JywKICAgICAgICAgICAgICAgICAgICAnPGRpdiBpZD0ie2dyb3VwSWR9LWhkIiBjbGFzcz0ieC1ncmlkLWdyb3VwLWhkIiBzdHlsZT0ie3N0eWxlfSI+PGRpdiBjbGFzcz0ieC1ncmlkLWdyb3VwLXRpdGxlIj4nLCB0aGlzLmdyb3VwVGV4dFRwbCAsJzwvZGl2PjwvZGl2PicsCiAgICAgICAgICAgICAgICAgICAgJzxkaXYgaWQ9Intncm91cElkfS1iZCIgY2xhc3M9IngtZ3JpZC1ncm91cC1ib2R5Ij4nCiAgICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RhcnRHcm91cC5jb21waWxlKCk7CgogICAgICAgIGlmICghdGhpcy5lbmRHcm91cCkgewogICAgICAgICAgICB0aGlzLmVuZEdyb3VwID0gJzwvZGl2PjwvZGl2Pic7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGZpbmRHcm91cCA6IGZ1bmN0aW9uKGVsKXsKICAgICAgICByZXR1cm4gRXh0LmZseShlbCkudXAoJy54LWdyaWQtZ3JvdXAnLCB0aGlzLm1haW5Cb2R5LmRvbSk7CiAgICB9LAoKICAgIAogICAgZ2V0R3JvdXBzIDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gdGhpcy5oYXNSb3dzKCkgPyB0aGlzLm1haW5Cb2R5LmRvbS5jaGlsZE5vZGVzIDogW107CiAgICB9LAoKICAgIAogICAgb25BZGQgOiBmdW5jdGlvbihkcywgcmVjb3JkcywgaW5kZXgpIHsKICAgICAgICBpZiAodGhpcy5jYW5Hcm91cCgpICYmICF0aGlzLmlnbm9yZUFkZCkgewogICAgICAgICAgICB2YXIgc3MgPSB0aGlzLmdldFNjcm9sbFN0YXRlKCk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdiZWZvcmVyb3dzaW5zZXJ0ZWQnLCBkcywgaW5kZXgsIGluZGV4ICsgKHJlY29yZHMubGVuZ3RoLTEpKTsKICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgICAgIHRoaXMucmVzdG9yZVNjcm9sbChzcyk7CiAgICAgICAgICAgIHRoaXMuZmlyZUV2ZW50KCdyb3dzaW5zZXJ0ZWQnLCBkcywgaW5kZXgsIGluZGV4ICsgKHJlY29yZHMubGVuZ3RoLTEpKTsKICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmNhbkdyb3VwKCkpIHsKICAgICAgICAgICAgRXh0LmdyaWQuR3JvdXBpbmdWaWV3LnN1cGVyY2xhc3Mub25BZGQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgb25SZW1vdmUgOiBmdW5jdGlvbihkcywgcmVjb3JkLCBpbmRleCwgaXNVcGRhdGUpewogICAgICAgIEV4dC5ncmlkLkdyb3VwaW5nVmlldy5zdXBlcmNsYXNzLm9uUmVtb3ZlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdmFyIGcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChyZWNvcmQuX2dyb3VwSWQpOwogICAgICAgIGlmKGcgJiYgZy5jaGlsZE5vZGVzWzFdLmNoaWxkTm9kZXMubGVuZ3RoIDwgMSl7CiAgICAgICAgICAgIEV4dC5yZW1vdmVOb2RlKGcpOwogICAgICAgIH0KICAgICAgICB0aGlzLmFwcGx5RW1wdHlUZXh0KCk7CiAgICB9LAoKICAgIAogICAgcmVmcmVzaFJvdyA6IGZ1bmN0aW9uKHJlY29yZCl7CiAgICAgICAgaWYodGhpcy5kcy5nZXRDb3VudCgpPT0xKXsKICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHRoaXMuaXNVcGRhdGluZyA9IHRydWU7CiAgICAgICAgICAgIEV4dC5ncmlkLkdyb3VwaW5nVmlldy5zdXBlcmNsYXNzLnJlZnJlc2hSb3cuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5pc1VwZGF0aW5nID0gZmFsc2U7CiAgICAgICAgfQogICAgfSwKCiAgICAKICAgIGJlZm9yZU1lbnVTaG93IDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgaXRlbSwgaXRlbXMgPSB0aGlzLmhtZW51Lml0ZW1zLCBkaXNhYmxlZCA9IHRoaXMuY20uY29uZmlnW3RoaXMuaGRDdHhJbmRleF0uZ3JvdXBhYmxlID09PSBmYWxzZTsKICAgICAgICBpZigoaXRlbSA9IGl0ZW1zLmdldCgnZ3JvdXBCeScpKSl7CiAgICAgICAgICAgIGl0ZW0uc2V0RGlzYWJsZWQoZGlzYWJsZWQpOwogICAgICAgIH0KICAgICAgICBpZigoaXRlbSA9IGl0ZW1zLmdldCgnc2hvd0dyb3VwcycpKSl7CiAgICAgICAgICAgIGl0ZW0uc2V0RGlzYWJsZWQoZGlzYWJsZWQpOwogICAgICAgICAgICBpdGVtLnNldENoZWNrZWQodGhpcy5jYW5Hcm91cCgpLCB0cnVlKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgcmVuZGVyVUkgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBtYXJrdXAgPSBFeHQuZ3JpZC5Hcm91cGluZ1ZpZXcuc3VwZXJjbGFzcy5yZW5kZXJVSS5jYWxsKHRoaXMpOwoKICAgICAgICBpZih0aGlzLmVuYWJsZUdyb3VwaW5nTWVudSAmJiB0aGlzLmhtZW51KXsKICAgICAgICAgICAgdGhpcy5obWVudS5hZGQoJy0nLHsKICAgICAgICAgICAgICAgIGl0ZW1JZDonZ3JvdXBCeScsCiAgICAgICAgICAgICAgICB0ZXh0OiB0aGlzLmdyb3VwQnlUZXh0LAogICAgICAgICAgICAgICAgaGFuZGxlcjogdGhpcy5vbkdyb3VwQnlDbGljaywKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgaWNvbkNsczoneC1ncm91cC1ieS1pY29uJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYodGhpcy5lbmFibGVOb0dyb3Vwcyl7CiAgICAgICAgICAgICAgICB0aGlzLmhtZW51LmFkZCh7CiAgICAgICAgICAgICAgICAgICAgaXRlbUlkOidzaG93R3JvdXBzJywKICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0aGlzLnNob3dHcm91cHNUZXh0LAogICAgICAgICAgICAgICAgICAgIGNoZWNrZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgY2hlY2tIYW5kbGVyOiB0aGlzLm9uU2hvd0dyb3Vwc0NsaWNrLAogICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhtZW51Lm9uKCdiZWZvcmVzaG93JywgdGhpcy5iZWZvcmVNZW51U2hvdywgdGhpcyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXJrdXA7CiAgICB9LAoKICAgIHByb2Nlc3NFdmVudDogZnVuY3Rpb24obmFtZSwgZSl7CiAgICAgICAgRXh0LmdyaWQuR3JvdXBpbmdWaWV3LnN1cGVyY2xhc3MucHJvY2Vzc0V2ZW50LmNhbGwodGhpcywgbmFtZSwgZSk7CiAgICAgICAgdmFyIGhkID0gZS5nZXRUYXJnZXQoJy54LWdyaWQtZ3JvdXAtaGQnLCB0aGlzLm1haW5Cb2R5KTsKICAgICAgICBpZihoZCl7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgZmllbGQgPSB0aGlzLmdldEdyb3VwRmllbGQoKSwKICAgICAgICAgICAgICAgIHByZWZpeCA9IHRoaXMuZ2V0UHJlZml4KGZpZWxkKSwKICAgICAgICAgICAgICAgIGdyb3VwVmFsdWUgPSBoZC5pZC5zdWJzdHJpbmcocHJlZml4Lmxlbmd0aCksCiAgICAgICAgICAgICAgICBlbXB0eVJlID0gbmV3IFJlZ0V4cCgnZ3AtJyArIEV4dC5lc2NhcGVSZShmaWVsZCkgKyAnLS1oZCcpOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIGdyb3VwVmFsdWUgPSBncm91cFZhbHVlLnN1YnN0cigwLCBncm91cFZhbHVlLmxlbmd0aCAtIDMpOwogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKGdyb3VwVmFsdWUgfHwgZW1wdHlSZS50ZXN0KGhkLmlkKSl7CiAgICAgICAgICAgICAgICB0aGlzLmdyaWQuZmlyZUV2ZW50KCdncm91cCcgKyBuYW1lLCB0aGlzLmdyaWQsIGZpZWxkLCBncm91cFZhbHVlLCBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihuYW1lID09ICdtb3VzZWRvd24nICYmIGUuYnV0dG9uID09IDApewogICAgICAgICAgICAgICAgdGhpcy50b2dnbGVHcm91cChoZC5wYXJlbnROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIAogICAgb25Hcm91cEJ5Q2xpY2sgOiBmdW5jdGlvbigpewogICAgICAgIHZhciBncmlkID0gdGhpcy5ncmlkOwogICAgICAgIHRoaXMuZW5hYmxlR3JvdXBpbmcgPSB0cnVlOwogICAgICAgIGdyaWQuc3RvcmUuZ3JvdXBCeSh0aGlzLmNtLmdldERhdGFJbmRleCh0aGlzLmhkQ3R4SW5kZXgpKTsKICAgICAgICBncmlkLmZpcmVFdmVudCgnZ3JvdXBjaGFuZ2UnLCBncmlkLCBncmlkLnN0b3JlLmdldEdyb3VwU3RhdGUoKSk7CiAgICAgICAgdGhpcy5iZWZvcmVNZW51U2hvdygpOyAKICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgIH0sCgogICAgCiAgICBvblNob3dHcm91cHNDbGljayA6IGZ1bmN0aW9uKG1pLCBjaGVja2VkKXsKICAgICAgICB0aGlzLmVuYWJsZUdyb3VwaW5nID0gY2hlY2tlZDsKICAgICAgICBpZihjaGVja2VkKXsKICAgICAgICAgICAgdGhpcy5vbkdyb3VwQnlDbGljaygpOwogICAgICAgIH1lbHNlewogICAgICAgICAgICB0aGlzLmdyaWQuc3RvcmUuY2xlYXJHcm91cGluZygpOwogICAgICAgICAgICB0aGlzLmdyaWQuZmlyZUV2ZW50KCdncm91cGNoYW5nZScsIHRoaXMsIG51bGwpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICB0b2dnbGVSb3dJbmRleCA6IGZ1bmN0aW9uKHJvd0luZGV4LCBleHBhbmRlZCl7CiAgICAgICAgaWYoIXRoaXMuY2FuR3JvdXAoKSl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIHJvdyA9IHRoaXMuZ2V0Um93KHJvd0luZGV4KTsKICAgICAgICBpZihyb3cpewogICAgICAgICAgICB0aGlzLnRvZ2dsZUdyb3VwKHRoaXMuZmluZEdyb3VwKHJvdyksIGV4cGFuZGVkKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgdG9nZ2xlR3JvdXAgOiBmdW5jdGlvbihncm91cCwgZXhwYW5kZWQpewogICAgICAgIHZhciBnZWwgPSBFeHQuZ2V0KGdyb3VwKSwKICAgICAgICAgICAgaWQgPSBFeHQudXRpbC5Gb3JtYXQuaHRtbEVuY29kZShnZWwuaWQpOwogCiAgICAgICAgZXhwYW5kZWQgPSBFeHQuaXNEZWZpbmVkKGV4cGFuZGVkKSA/IGV4cGFuZGVkIDogZ2VsLmhhc0NsYXNzKCd4LWdyaWQtZ3JvdXAtY29sbGFwc2VkJyk7CiAgICAgICAgaWYodGhpcy5zdGF0ZVtpZF0gIT09IGV4cGFuZGVkKXsKICAgICAgICAgICAgaWYgKHRoaXMuY2FuY2VsRWRpdE9uVG9nZ2xlICE9PSBmYWxzZSkgewogICAgICAgICAgICAgICAgdGhpcy5ncmlkLnN0b3BFZGl0aW5nKHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc3RhdGVbaWRdID0gZXhwYW5kZWQ7CiAgICAgICAgICAgIGdlbFtleHBhbmRlZCA/ICdyZW1vdmVDbGFzcycgOiAnYWRkQ2xhc3MnXSgneC1ncmlkLWdyb3VwLWNvbGxhcHNlZCcpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICB0b2dnbGVBbGxHcm91cHMgOiBmdW5jdGlvbihleHBhbmRlZCl7CiAgICAgICAgdmFyIGdyb3VwcyA9IHRoaXMuZ2V0R3JvdXBzKCk7CiAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gZ3JvdXBzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgdGhpcy50b2dnbGVHcm91cChncm91cHNbaV0sIGV4cGFuZGVkKTsKICAgICAgICB9CiAgICB9LAoKICAgIAogICAgZXhwYW5kQWxsR3JvdXBzIDogZnVuY3Rpb24oKXsKICAgICAgICB0aGlzLnRvZ2dsZUFsbEdyb3Vwcyh0cnVlKTsKICAgIH0sCgogICAgCiAgICBjb2xsYXBzZUFsbEdyb3VwcyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy50b2dnbGVBbGxHcm91cHMoZmFsc2UpOwogICAgfSwKCiAgICAKICAgIGdldEdyb3VwIDogZnVuY3Rpb24odiwgciwgZ3JvdXBSZW5kZXJlciwgcm93SW5kZXgsIGNvbEluZGV4LCBkcyl7CiAgICAgICAgdmFyIGNvbHVtbiA9IHRoaXMuY20uY29uZmlnW2NvbEluZGV4XSwKICAgICAgICAgICAgZyA9IGdyb3VwUmVuZGVyZXIgPyBncm91cFJlbmRlcmVyLmNhbGwoY29sdW1uLnNjb3BlLCB2LCB7fSwgciwgcm93SW5kZXgsIGNvbEluZGV4LCBkcykgOiBTdHJpbmcodik7CiAgICAgICAgaWYoZyA9PT0gJycgfHwgZyA9PT0gJyYjMTYwOycpewogICAgICAgICAgICBnID0gY29sdW1uLmVtcHR5R3JvdXBUZXh0IHx8IHRoaXMuZW1wdHlHcm91cFRleHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnOwogICAgfSwKCiAgICAKICAgIGdldEdyb3VwRmllbGQgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmdyaWQuc3RvcmUuZ2V0R3JvdXBTdGF0ZSgpOwogICAgfSwKCiAgICAKICAgIGFmdGVyUmVuZGVyIDogZnVuY3Rpb24oKXsKICAgICAgICBpZighdGhpcy5kcyB8fCAhdGhpcy5jbSl7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgRXh0LmdyaWQuR3JvdXBpbmdWaWV3LnN1cGVyY2xhc3MuYWZ0ZXJSZW5kZXIuY2FsbCh0aGlzKTsKICAgICAgICBpZih0aGlzLmdyaWQuZGVmZXJSb3dSZW5kZXIpewogICAgICAgICAgICB0aGlzLnVwZGF0ZUdyb3VwV2lkdGhzKCk7CiAgICAgICAgfQogICAgfSwKICAgIAogICAgYWZ0ZXJSZW5kZXJVSTogZnVuY3Rpb24gKCkgewogICAgICAgIEV4dC5ncmlkLkdyb3VwaW5nVmlldy5zdXBlcmNsYXNzLmFmdGVyUmVuZGVyVUkuY2FsbCh0aGlzKTsKCiAgICAgICAgaWYgKHRoaXMuZW5hYmxlR3JvdXBpbmdNZW51ICYmIHRoaXMuaG1lbnUpIHsKICAgICAgICAgICAgdGhpcy5obWVudS5hZGQoJy0nLHsKICAgICAgICAgICAgICAgIGl0ZW1JZDonZ3JvdXBCeScsCiAgICAgICAgICAgICAgICB0ZXh0OiB0aGlzLmdyb3VwQnlUZXh0LAogICAgICAgICAgICAgICAgaGFuZGxlcjogdGhpcy5vbkdyb3VwQnlDbGljaywKICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzLAogICAgICAgICAgICAgICAgaWNvbkNsczoneC1ncm91cC1ieS1pY29uJwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmVuYWJsZU5vR3JvdXBzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmhtZW51LmFkZCh7CiAgICAgICAgICAgICAgICAgICAgaXRlbUlkOidzaG93R3JvdXBzJywKICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0aGlzLnNob3dHcm91cHNUZXh0LAogICAgICAgICAgICAgICAgICAgIGNoZWNrZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgY2hlY2tIYW5kbGVyOiB0aGlzLm9uU2hvd0dyb3Vwc0NsaWNrLAogICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5obWVudS5vbignYmVmb3Jlc2hvdycsIHRoaXMuYmVmb3JlTWVudVNob3csIHRoaXMpOwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICByZW5kZXJSb3dzIDogZnVuY3Rpb24oKXsKICAgICAgICB2YXIgZ3JvdXBGaWVsZCA9IHRoaXMuZ2V0R3JvdXBGaWVsZCgpOwogICAgICAgIHZhciBlZyA9ICEhZ3JvdXBGaWVsZDsKICAgICAgICAKICAgICAgICBpZih0aGlzLmhpZGVHcm91cGVkQ29sdW1uKSB7CiAgICAgICAgICAgIHZhciBjb2xJbmRleCA9IHRoaXMuY20uZmluZENvbHVtbkluZGV4KGdyb3VwRmllbGQpLAogICAgICAgICAgICAgICAgaGFzTGFzdEdyb3VwRmllbGQgPSBFeHQuaXNEZWZpbmVkKHRoaXMubGFzdEdyb3VwRmllbGQpOwogICAgICAgICAgICBpZighZWcgJiYgaGFzTGFzdEdyb3VwRmllbGQpewogICAgICAgICAgICAgICAgdGhpcy5tYWluQm9keS51cGRhdGUoJycpOwogICAgICAgICAgICAgICAgdGhpcy5jbS5zZXRIaWRkZW4odGhpcy5jbS5maW5kQ29sdW1uSW5kZXgodGhpcy5sYXN0R3JvdXBGaWVsZCksIGZhbHNlKTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxhc3RHcm91cEZpZWxkOwogICAgICAgICAgICB9ZWxzZSBpZiAoZWcgJiYgIWhhc0xhc3RHcm91cEZpZWxkKXsKICAgICAgICAgICAgICAgIHRoaXMubGFzdEdyb3VwRmllbGQgPSBncm91cEZpZWxkOwogICAgICAgICAgICAgICAgdGhpcy5jbS5zZXRIaWRkZW4oY29sSW5kZXgsIHRydWUpOwogICAgICAgICAgICB9ZWxzZSBpZiAoZWcgJiYgaGFzTGFzdEdyb3VwRmllbGQgJiYgZ3JvdXBGaWVsZCAhPT0gdGhpcy5sYXN0R3JvdXBGaWVsZCkgewogICAgICAgICAgICAgICAgdGhpcy5tYWluQm9keS51cGRhdGUoJycpOwogICAgICAgICAgICAgICAgdmFyIG9sZEluZGV4ID0gdGhpcy5jbS5maW5kQ29sdW1uSW5kZXgodGhpcy5sYXN0R3JvdXBGaWVsZCk7CiAgICAgICAgICAgICAgICB0aGlzLmNtLnNldEhpZGRlbihvbGRJbmRleCwgZmFsc2UpOwogICAgICAgICAgICAgICAgdGhpcy5sYXN0R3JvdXBGaWVsZCA9IGdyb3VwRmllbGQ7CiAgICAgICAgICAgICAgICB0aGlzLmNtLnNldEhpZGRlbihjb2xJbmRleCwgdHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIEV4dC5ncmlkLkdyb3VwaW5nVmlldy5zdXBlcmNsYXNzLnJlbmRlclJvd3MuYXBwbHkoCiAgICAgICAgICAgICAgICAgICAgdGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgCiAgICBkb1JlbmRlciA6IGZ1bmN0aW9uKGNzLCBycywgZHMsIHN0YXJ0Um93LCBjb2xDb3VudCwgc3RyaXBlKXsKICAgICAgICBpZihycy5sZW5ndGggPCAxKXsKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0KCiAgICAgICAgaWYoIXRoaXMuY2FuR3JvdXAoKSB8fCB0aGlzLmlzVXBkYXRpbmcpewogICAgICAgICAgICByZXR1cm4gRXh0LmdyaWQuR3JvdXBpbmdWaWV3LnN1cGVyY2xhc3MuZG9SZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICB9CgogICAgICAgIHZhciBncm91cEZpZWxkID0gdGhpcy5nZXRHcm91cEZpZWxkKCksCiAgICAgICAgICAgIGNvbEluZGV4ID0gdGhpcy5jbS5maW5kQ29sdW1uSW5kZXgoZ3JvdXBGaWVsZCksCiAgICAgICAgICAgIGcsCiAgICAgICAgICAgIGdzdHlsZSA9ICd3aWR0aDonICsgdGhpcy5nZXRUb3RhbFdpZHRoKCkgKyAnOycsCiAgICAgICAgICAgIGNmZyA9IHRoaXMuY20uY29uZmlnW2NvbEluZGV4XSwKICAgICAgICAgICAgZ3JvdXBSZW5kZXJlciA9IGNmZy5ncm91cFJlbmRlcmVyIHx8IGNmZy5yZW5kZXJlciwKICAgICAgICAgICAgcHJlZml4ID0gdGhpcy5zaG93R3JvdXBOYW1lID8gKGNmZy5ncm91cE5hbWUgfHwgY2ZnLmhlYWRlcikrJzogJyA6ICcnLAogICAgICAgICAgICBncm91cHMgPSBbXSwKICAgICAgICAgICAgY3VyR3JvdXAsIGksIGxlbiwgZ2lkOwoKICAgICAgICBmb3IoaSA9IDAsIGxlbiA9IHJzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgdmFyIHJvd0luZGV4ID0gc3RhcnRSb3cgKyBpLAogICAgICAgICAgICAgICAgciA9IHJzW2ldLAogICAgICAgICAgICAgICAgZ3ZhbHVlID0gci5kYXRhW2dyb3VwRmllbGRdOwoKICAgICAgICAgICAgICAgIGcgPSB0aGlzLmdldEdyb3VwKGd2YWx1ZSwgciwgZ3JvdXBSZW5kZXJlciwgcm93SW5kZXgsIGNvbEluZGV4LCBkcyk7CiAgICAgICAgICAgIGlmKCFjdXJHcm91cCB8fCBjdXJHcm91cC5ncm91cCAhPSBnKXsKICAgICAgICAgICAgICAgIGdpZCA9IHRoaXMuY29uc3RydWN0SWQoZ3ZhbHVlLCBncm91cEZpZWxkLCBjb2xJbmRleCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGhpcy5zdGF0ZVtnaWRdID0gIShFeHQuaXNEZWZpbmVkKHRoaXMuc3RhdGVbZ2lkXSkgPyAhdGhpcy5zdGF0ZVtnaWRdIDogdGhpcy5zdGFydENvbGxhcHNlZCk7CiAgICAgICAgICAgICAgICBjdXJHcm91cCA9IHsKICAgICAgICAgICAgICAgICAgICBncm91cDogZywKICAgICAgICAgICAgICAgICAgICBndmFsdWU6IGd2YWx1ZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0OiBwcmVmaXggKyBnLAogICAgICAgICAgICAgICAgICAgIGdyb3VwSWQ6IGdpZCwKICAgICAgICAgICAgICAgICAgICBzdGFydFJvdzogcm93SW5kZXgsCiAgICAgICAgICAgICAgICAgICAgcnM6IFtyXSwKICAgICAgICAgICAgICAgICAgICBjbHM6IHRoaXMuc3RhdGVbZ2lkXSA/ICcnIDogJ3gtZ3JpZC1ncm91cC1jb2xsYXBzZWQnLAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiBnc3R5bGUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBncm91cHMucHVzaChjdXJHcm91cCk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgY3VyR3JvdXAucnMucHVzaChyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByLl9ncm91cElkID0gZ2lkOwogICAgICAgIH0KCiAgICAgICAgdmFyIGJ1ZiA9IFtdOwogICAgICAgIGZvcihpID0gMCwgbGVuID0gZ3JvdXBzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgZyA9IGdyb3Vwc1tpXTsKICAgICAgICAgICAgdGhpcy5kb0dyb3VwU3RhcnQoYnVmLCBnLCBjcywgZHMsIGNvbENvdW50KTsKICAgICAgICAgICAgYnVmW2J1Zi5sZW5ndGhdID0gRXh0LmdyaWQuR3JvdXBpbmdWaWV3LnN1cGVyY2xhc3MuZG9SZW5kZXIuY2FsbCgKICAgICAgICAgICAgICAgICAgICB0aGlzLCBjcywgZy5ycywgZHMsIGcuc3RhcnRSb3csIGNvbENvdW50LCBzdHJpcGUpOwoKICAgICAgICAgICAgdGhpcy5kb0dyb3VwRW5kKGJ1ZiwgZywgY3MsIGRzLCBjb2xDb3VudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBidWYuam9pbignJyk7CiAgICB9LAoKICAgIAogICAgZ2V0R3JvdXBJZCA6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICB2YXIgZmllbGQgPSB0aGlzLmdldEdyb3VwRmllbGQoKTsKICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3RJZCh2YWx1ZSwgZmllbGQsIHRoaXMuY20uZmluZENvbHVtbkluZGV4KGZpZWxkKSk7CiAgICB9LAoKICAgIAogICAgY29uc3RydWN0SWQgOiBmdW5jdGlvbih2YWx1ZSwgZmllbGQsIGlkeCl7CiAgICAgICAgdmFyIGNmZyA9IHRoaXMuY20uY29uZmlnW2lkeF0sCiAgICAgICAgICAgIGdyb3VwUmVuZGVyZXIgPSBjZmcuZ3JvdXBSZW5kZXJlciB8fCBjZmcucmVuZGVyZXIsCiAgICAgICAgICAgIHZhbCA9ICh0aGlzLmdyb3VwTW9kZSA9PSAndmFsdWUnKSA/IHZhbHVlIDogdGhpcy5nZXRHcm91cCh2YWx1ZSwge2RhdGE6e319LCBncm91cFJlbmRlcmVyLCAwLCBpZHgsIHRoaXMuZHMpOwoKICAgICAgICByZXR1cm4gdGhpcy5nZXRQcmVmaXgoZmllbGQpICsgRXh0LnV0aWwuRm9ybWF0Lmh0bWxFbmNvZGUodmFsKTsKICAgIH0sCgogICAgCiAgICBjYW5Hcm91cCAgOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiB0aGlzLmVuYWJsZUdyb3VwaW5nICYmICEhdGhpcy5nZXRHcm91cEZpZWxkKCk7CiAgICB9LAoKICAgIAogICAgZ2V0UHJlZml4OiBmdW5jdGlvbihmaWVsZCl7CiAgICAgICAgcmV0dXJuIHRoaXMuZ3JpZC5nZXRHcmlkRWwoKS5pZCArICctZ3AtJyArIGZpZWxkICsgJy0nOwogICAgfSwKCiAgICAKICAgIGRvR3JvdXBTdGFydCA6IGZ1bmN0aW9uKGJ1ZiwgZywgY3MsIGRzLCBjb2xDb3VudCl7CiAgICAgICAgYnVmW2J1Zi5sZW5ndGhdID0gdGhpcy5zdGFydEdyb3VwLmFwcGx5KGcpOwogICAgfSwKCiAgICAKICAgIGRvR3JvdXBFbmQgOiBmdW5jdGlvbihidWYsIGcsIGNzLCBkcywgY29sQ291bnQpewogICAgICAgIGJ1ZltidWYubGVuZ3RoXSA9IHRoaXMuZW5kR3JvdXA7CiAgICB9LAoKICAgIAogICAgZ2V0Um93cyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMuY2FuR3JvdXAoKSl7CiAgICAgICAgICAgIHJldHVybiBFeHQuZ3JpZC5Hcm91cGluZ1ZpZXcuc3VwZXJjbGFzcy5nZXRSb3dzLmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgICAgIHZhciByID0gW10sCiAgICAgICAgICAgIGdzID0gdGhpcy5nZXRHcm91cHMoKSwKICAgICAgICAgICAgZywKICAgICAgICAgICAgaSA9IDAsCiAgICAgICAgICAgIGxlbiA9IGdzLmxlbmd0aCwKICAgICAgICAgICAgaiwKICAgICAgICAgICAgamxlbjsKICAgICAgICBmb3IoOyBpIDwgbGVuOyArK2kpewogICAgICAgICAgICBnID0gZ3NbaV0uY2hpbGROb2Rlc1sxXTsKICAgICAgICAgICAgaWYoZyl7CiAgICAgICAgICAgICAgICBnID0gZy5jaGlsZE5vZGVzOwogICAgICAgICAgICAgICAgZm9yKGogPSAwLCBqbGVuID0gZy5sZW5ndGg7IGogPCBqbGVuOyArK2opewogICAgICAgICAgICAgICAgICAgIHJbci5sZW5ndGhdID0gZ1tqXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcjsKICAgIH0sCgogICAgCiAgICB1cGRhdGVHcm91cFdpZHRocyA6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYoIXRoaXMuY2FuR3JvdXAoKSB8fCAhdGhpcy5oYXNSb3dzKCkpewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciB0dyA9IE1hdGgubWF4KHRoaXMuY20uZ2V0VG90YWxXaWR0aCgpLCB0aGlzLmVsLmRvbS5vZmZzZXRXaWR0aC10aGlzLmdldFNjcm9sbE9mZnNldCgpKSArJ3B4JzsKICAgICAgICB2YXIgZ3MgPSB0aGlzLmdldEdyb3VwcygpOwogICAgICAgIGZvcih2YXIgaSA9IDAsIGxlbiA9IGdzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgZ3NbaV0uZmlyc3RDaGlsZC5zdHlsZS53aWR0aCA9IHR3OwogICAgICAgIH0KICAgIH0sCgogICAgCiAgICBvbkNvbHVtbldpZHRoVXBkYXRlZCA6IGZ1bmN0aW9uKGNvbCwgdywgdHcpewogICAgICAgIEV4dC5ncmlkLkdyb3VwaW5nVmlldy5zdXBlcmNsYXNzLm9uQ29sdW1uV2lkdGhVcGRhdGVkLmNhbGwodGhpcywgY29sLCB3LCB0dyk7CiAgICAgICAgdGhpcy51cGRhdGVHcm91cFdpZHRocygpOwogICAgfSwKCiAgICAKICAgIG9uQWxsQ29sdW1uV2lkdGhzVXBkYXRlZCA6IGZ1bmN0aW9uKHdzLCB0dyl7CiAgICAgICAgRXh0LmdyaWQuR3JvdXBpbmdWaWV3LnN1cGVyY2xhc3Mub25BbGxDb2x1bW5XaWR0aHNVcGRhdGVkLmNhbGwodGhpcywgd3MsIHR3KTsKICAgICAgICB0aGlzLnVwZGF0ZUdyb3VwV2lkdGhzKCk7CiAgICB9LAoKICAgIAogICAgb25Db2x1bW5IaWRkZW5VcGRhdGVkIDogZnVuY3Rpb24oY29sLCBoaWRkZW4sIHR3KXsKICAgICAgICBFeHQuZ3JpZC5Hcm91cGluZ1ZpZXcuc3VwZXJjbGFzcy5vbkNvbHVtbkhpZGRlblVwZGF0ZWQuY2FsbCh0aGlzLCBjb2wsIGhpZGRlbiwgdHcpOwogICAgICAgIHRoaXMudXBkYXRlR3JvdXBXaWR0aHMoKTsKICAgIH0sCgogICAgCiAgICBvbkxheW91dCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy51cGRhdGVHcm91cFdpZHRocygpOwogICAgfSwKCiAgICAKICAgIG9uQmVmb3JlUm93U2VsZWN0IDogZnVuY3Rpb24oc20sIHJvd0luZGV4KXsKICAgICAgICB0aGlzLnRvZ2dsZVJvd0luZGV4KHJvd0luZGV4LCB0cnVlKTsKICAgIH0KfSk7CgpFeHQuZ3JpZC5Hcm91cGluZ1ZpZXcuR1JPVVBfSUQgPSAxMDAwOwo=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPBody>
      </HTTPResponse>
    </HTTPTask>
    <HTTPTask id="23" hostname="demo.borland.com" path="/InsuranceWebExtJS/javascript/serializer.js" url="http://demo.borland.com/InsuranceWebExtJS/javascript/serializer.js" ip="143.186.120.171" port="80" client_ip="192.168.0.123" client_port="15237" connectionId="1852" origin="HTML" encodingType="ANSI" ordinal="4" startDateTime="2019-02-27T16:49:29.185+05:30" startTime="3827" endTime="3995" blockedTime="0" dnsTime="0" connectTime="0" sendTime="0" waitTime="0" receiveTime="0" sslNegotiateTime="0" responseBodySize="0">
      <HTTPRequest method="GET">
        <HTTPHeaders>
          <HTTPHeaderEntity name="Referer" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>aHR0cDovL2RlbW8uYm9ybGFuZC5jb20vSW5zdXJhbmNlV2ViRXh0SlMvYWdlbnRfbG9va3VwLmpzZg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="User-Agent" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzcyLjAuMzYyNi4xMTkgU2FmYXJpLzUzNy4zNg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Encoding" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Z3ppcCwgZGVmbGF0ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Language" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZW4tVVMsZW47cT0wLjk=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ki8q</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Connection" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>S2VlcC1BbGl2ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Host" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZGVtby5ib3JsYW5kLmNvbQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Cookie" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFC</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>R0VUIC9JbnN1cmFuY2VXZWJFeHRKUy9qYXZhc2NyaXB0L3NlcmlhbGl6ZXIuanMgSFRUUC8xLjENClJlZmVyZXI6IGh0dHA6Ly9kZW1vLmJvcmxhbmQuY29tL0luc3VyYW5jZVdlYkV4dEpTL2FnZW50X2xvb2t1cC5qc2YNClVzZXItQWdlbnQ6IE1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS83Mi4wLjM2MjYuMTE5IFNhZmFyaS81MzcuMzYNCkFjY2VwdC1FbmNvZGluZzogZ3ppcCwgZGVmbGF0ZQ0KQWNjZXB0LUxhbmd1YWdlOiBlbi1VUyxlbjtxPTAuOQ0KQWNjZXB0OiAqLyoNCkNvbm5lY3Rpb246IEtlZXAtQWxpdmUNCkhvc3Q6IGRlbW8uYm9ybGFuZC5jb20NCkNvb2tpZTogSlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFCDQoNCg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
          <HTTPCookies>
            <HTTPHeaderEntity name="JSESSIONID" index="0">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
            <HTTPHeaderEntity name="UserSessionFilter.sessionId" index="1">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
          </HTTPCookies>
        </HTTPHeaders>
      </HTTPRequest>
      <HTTPResponse>
        <contentLenght>1601</contentLenght>
        <HTTPHeaders>
          <HTTPHeaderEntity name="Content-Length" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>MTYwMQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Content-Type" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>YXBwbGljYXRpb24vamF2YXNjcmlwdA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Last-Modified" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>VHVlLCAxMSBEZWMgMjAxMiAwOTo0MDo0NCBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Ranges" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ynl0ZXM=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="ETag" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Vy8iMTYwMS0xMzU1MjE4ODQ0MDAwIg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Server" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TWljcm9zb2Z0LUlJUy83LjU=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-Powered-By" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>QVNQLk5FVA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-FRAME-OPTIONS" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>U0FNRU9SSUdJTg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Date" index="8">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>V2VkLCAyNyBGZWIgMjAxOSAxMToxODo1NyBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTYwMQ0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpMYXN0LU1vZGlmaWVkOiBUdWUsIDExIERlYyAyMDEyIDA5OjQwOjQ0IEdNVA0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkVUYWc6IFcvIjE2MDEtMTM1NTIxODg0NDAwMCINClNlcnZlcjogTWljcm9zb2Z0LUlJUy83LjUNClgtUG93ZXJlZC1CeTogQVNQLk5FVA0KWC1GUkFNRS1PUFRJT05TOiBTQU1FT1JJR0lODQpEYXRlOiBXZWQsIDI3IEZlYiAyMDE5IDExOjE4OjU3IEdNVA0KDQo=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
        </HTTPHeaders>
        <HTTPBody>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>DQpmdW5jdGlvbiBlbmNvZGUodHlwZSwgb2JqKXsNCglpZih0eXBlID09ICdqc29uJyl7CQ0KCQlyZXR1cm4gRXh0LmVuY29kZShvYmopOw0KCX0NCgllbHNlew0KCQl2YXIgcmV0ID0gIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cIlVURi04XCIgc3RhbmRhbG9uZT1cIm5vXCI/PjxkYXRhc2V0PiI7DQoJCWZvcihpIGluIG9iail7DQoJCQlyZXQgPSByZXQrIjwiK2krIj4iK29ialtpXSsiPC8iK2krIj4iOwkJCQ0KCQl9DQoJCXJldCA9IHJldCsiPC9kYXRhc2V0PiI7DQoJCXJldHVybiByZXQ7DQoJfQ0KfQ0KDQpmdW5jdGlvbiBkZWNvZGUodHlwZSwgdG9EZWNvZGUpew0KCWlmKHR5cGUgPT0gJ2pzb24nKXsJCQkJDQoJCXJldHVybiBFeHQuZGVjb2RlKHRvRGVjb2RlKTsJCQ0KCX0NCgllbHNlew0KCQlpZiAodHlwZW9mIERPTVBhcnNlciA9PSAidW5kZWZpbmVkIikgew0KCQkJdmFyIHhtbG9iamVjdCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MRE9NIik7DQoJCQl4bWxvYmplY3QuYXN5bmM9ImZhbHNlIjsNCgkJCXhtbG9iamVjdC5sb2FkWE1MKHRvRGVjb2RlKTsNCgkJCXZhciByb290ID0geG1sb2JqZWN0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkYXRhc2V0JylbMF07DQoJCQkNCgkJCXZhciB4ID0gbmV3IEFycmF5KCk7DQoJCQlmb3IgKHZhciBub2RlID0gMDsgbm9kZSA8IHJvb3QuY2hpbGROb2Rlcy5sZW5ndGg7IG5vZGUrKykgew0KCQkJCXZhciBuID0gcm9vdC5jaGlsZE5vZGVzLml0ZW0obm9kZSk7DQoJCQkJZm9yICh2YXIgbm9kZTIgPSAwOyBub2RlMiA8IG4uY2hpbGROb2Rlcy5sZW5ndGg7IG5vZGUyKyspIHsNCgkJCQkJdmFyIG4yID0gbi5jaGlsZE5vZGVzW25vZGUyXTsNCgkJCQkJdmFyIHRhZyA9IG4yLm5vZGVOYW1lOwkJDQoJCQkJCXZhciB2YWx1ZSA9IG4yLnRleHQ7CQkJCQkNCgkJCQkJaWYoeFtub2RlXSA9PSBudWxsKQ0KCQkJCQkJeFtub2RlXSA9IG5ldyBPYmplY3QoKTsNCgkJCQkJeFtub2RlXVtuMi5ub2RlTmFtZV0gPSAgbjIudGV4dDsJCQkJDQoJCQkJfQkJCQ0KCQkJfQ0KCQkJcmV0dXJuKHgpOw0KCQl9DQoJCWVsc2V7CQkNCgkJCXZhciB4bWxvYmplY3QgPSAobmV3IERPTVBhcnNlcigpKS5wYXJzZUZyb21TdHJpbmcodG9EZWNvZGUsICJ0ZXh0L3htbCIpOw0KCQkJdmFyIHJvb3QgPSB4bWxvYmplY3QuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2RhdGFzZXQnKVswXTsNCgkJCXZhciB4ID0gbmV3IEFycmF5KCk7DQoJCQlmb3IgKHZhciBub2RlID0gMDsgbm9kZSA8IHJvb3QuY2hpbGROb2Rlcy5sZW5ndGg7IG5vZGUrKykgew0KCQkJCXZhciBuID0gcm9vdC5jaGlsZE5vZGVzLml0ZW0obm9kZSk7CQkJDQoJCQkJZm9yICh2YXIgbm9kZTIgPSAwOyBub2RlMiA8IG4uY2hpbGROb2Rlcy5sZW5ndGg7IG5vZGUyKyspIHsNCgkJCQkJdmFyIG4yID0gbi5jaGlsZE5vZGVzLml0ZW0obm9kZTIpOw0KCQkJCQlpZih4W25vZGVdID09IG51bGwpDQoJCQkJCQl4W25vZGVdID0gbmV3IE9iamVjdCgpOw0KCQkJCQl4W25vZGVdW24yLmxvY2FsTmFtZV0gPSAgbjIudGV4dENvbnRlbnQ7CQkJCQ0KCQkJCX0JCQkNCgkJCX0NCgkJCXJldHVybih4KTsNCgkJfQ0KCX0NCn0=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPBody>
      </HTTPResponse>
    </HTTPTask>
    <HTTPTask id="24" hostname="demo.borland.com" path="/InsuranceWebExtJS/javascript/agentTable.js" url="http://demo.borland.com/InsuranceWebExtJS/javascript/agentTable.js" ip="143.186.120.171" port="80" client_ip="192.168.0.123" client_port="15238" connectionId="1860" origin="HTML" encodingType="ANSI" ordinal="5" startDateTime="2019-02-27T16:49:29.185+05:30" startTime="3827" endTime="4016" blockedTime="0" dnsTime="0" connectTime="0" sendTime="0" waitTime="0" receiveTime="0" sslNegotiateTime="0" responseBodySize="0">
      <HTTPRequest method="GET">
        <HTTPHeaders>
          <HTTPHeaderEntity name="Referer" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>aHR0cDovL2RlbW8uYm9ybGFuZC5jb20vSW5zdXJhbmNlV2ViRXh0SlMvYWdlbnRfbG9va3VwLmpzZg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="User-Agent" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzcyLjAuMzYyNi4xMTkgU2FmYXJpLzUzNy4zNg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Encoding" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Z3ppcCwgZGVmbGF0ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Language" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZW4tVVMsZW47cT0wLjk=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ki8q</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Connection" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>S2VlcC1BbGl2ZQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Host" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>ZGVtby5ib3JsYW5kLmNvbQ==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Cookie" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFC</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>R0VUIC9JbnN1cmFuY2VXZWJFeHRKUy9qYXZhc2NyaXB0L2FnZW50VGFibGUuanMgSFRUUC8xLjENClJlZmVyZXI6IGh0dHA6Ly9kZW1vLmJvcmxhbmQuY29tL0luc3VyYW5jZVdlYkV4dEpTL2FnZW50X2xvb2t1cC5qc2YNClVzZXItQWdlbnQ6IE1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS83Mi4wLjM2MjYuMTE5IFNhZmFyaS81MzcuMzYNCkFjY2VwdC1FbmNvZGluZzogZ3ppcCwgZGVmbGF0ZQ0KQWNjZXB0LUxhbmd1YWdlOiBlbi1VUyxlbjtxPTAuOQ0KQWNjZXB0OiAqLyoNCkNvbm5lY3Rpb246IEtlZXAtQWxpdmUNCkhvc3Q6IGRlbW8uYm9ybGFuZC5jb20NCkNvb2tpZTogSlNFU1NJT05JRD1FODJGQUZFQjkxMEY3OEZDMzlFRkY1NzFFRTBGOUExQjsgVXNlclNlc3Npb25GaWx0ZXIuc2Vzc2lvbklkPUU4MkZBRkVCOTEwRjc4RkMzOUVGRjU3MUVFMEY5QTFCDQoNCg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
          <HTTPCookies>
            <HTTPHeaderEntity name="JSESSIONID" index="0">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
            <HTTPHeaderEntity name="UserSessionFilter.sessionId" index="1">
              <HTTPDataSet>
                <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                  <ActualData>RTgyRkFGRUI5MTBGNzhGQzM5RUZGNTcxRUUwRjlBMUI=</ActualData>
                </HTTPData>
              </HTTPDataSet>
              <IsExternalData>false</IsExternalData>
            </HTTPHeaderEntity>
          </HTTPCookies>
        </HTTPHeaders>
      </HTTPRequest>
      <HTTPResponse>
        <contentLenght>3863</contentLenght>
        <HTTPHeaders>
          <HTTPHeaderEntity name="Content-Length" index="0">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Mzg2Mw==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Content-Type" index="1">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>YXBwbGljYXRpb24vamF2YXNjcmlwdA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Last-Modified" index="2">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>VHVlLCAyMiBKYW4gMjAxMyAxMDozNzo1MiBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Accept-Ranges" index="3">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Ynl0ZXM=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="ETag" index="4">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>Vy8iMzg2My0xMzU4ODUxMDcyMDAwIg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Server" index="5">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>TWljcm9zb2Z0LUlJUy83LjU=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-Powered-By" index="6">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>QVNQLk5FVA==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="X-FRAME-OPTIONS" index="7">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>U0FNRU9SSUdJTg==</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPHeaderEntity name="Date" index="8">
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>V2VkLCAyNyBGZWIgMjAxOSAxMToxODo1NyBHTVQ=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPHeaderEntity>
          <HTTPAllHeaders>
            <HTTPDataSet>
              <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
                <ActualData>SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzg2Mw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpMYXN0LU1vZGlmaWVkOiBUdWUsIDIyIEphbiAyMDEzIDEwOjM3OjUyIEdNVA0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkVUYWc6IFcvIjM4NjMtMTM1ODg1MTA3MjAwMCINClNlcnZlcjogTWljcm9zb2Z0LUlJUy83LjUNClgtUG93ZXJlZC1CeTogQVNQLk5FVA0KWC1GUkFNRS1PUFRJT05TOiBTQU1FT1JJR0lODQpEYXRlOiBXZWQsIDI3IEZlYiAyMDE5IDExOjE4OjU3IEdNVA0KDQo=</ActualData>
              </HTTPData>
            </HTTPDataSet>
            <IsExternalData>false</IsExternalData>
          </HTTPAllHeaders>
        </HTTPHeaders>
        <HTTPBody>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>RXh0Lm9uUmVhZHkoZnVuY3Rpb24oKXsNCgkNCglkb2N1bWVudC5sb2NhdGlvbi5ocmVmLm1hdGNoKC94bWwvKSA/IHJlc3VtZUZ1bmMoInhtbCIpIDogcmVzdW1lRnVuYyh7cmVzcG9uc2VUZXh0OiJhcHBsaWNhdGlvbi9qc29uIn0pOw0KICAgIA0KICAgIGZ1bmN0aW9uIHJlc3VtZUZ1bmMobXNnKXsNCiAgICAJDQogICAgCXZhciByZWNvcmREZWYgPSBFeHQuZGF0YS5SZWNvcmQuY3JlYXRlKA0KICAgIAkJCVsNCiAgICAJCQkge25hbWU6ICdGaXJzdE5hbWUnLCBtYXBwaW5nOiAnRmlyc3ROYW1lJywgdHlwZTonc3RyaW5nJyB9LA0KICAgIAkJCSB7bmFtZTogJ0xhc3ROYW1lJywgbWFwcGluZzogJ0xhc3ROYW1lJywgdHlwZTonc3RyaW5nJ30sDQogICAgCQkJIHtuYW1lOiAnQ2l0eScsIG1hcHBpbmc6ICdDaXR5JywgdHlwZTonc3RyaW5nJ30sDQogICAgCQkJIHtuYW1lOiAnU3RhdGUnLCBtYXBwaW5nOiAnU3RhdGUnLCB0eXBlOidzdHJpbmcnfSwNCiAgICAJCQkge25hbWU6ICdBZGRyZXNzJywgbWFwcGluZzogJ0FkZHJlc3MnLCB0eXBlOidzdHJpbmcnfSwNCiAgICAJCQkge25hbWU6ICdaaXBDb2RlJywgbWFwcGluZzogJ1ppcENvZGUnLCB0eXBlOidzdHJpbmcnfSwNCiAgICAJCQkge25hbWU6ICdQaG9uZScsIG1hcHBpbmc6ICdQaG9uZScsIHR5cGU6J3N0cmluZyd9DQogICAgCQkJXQ0KICAgIAkJKTsNCiAgICAJCQ0KICAgIAkJdmFyIHNlcmlhbGl6YXRpb25IdHRwUHJveHkgPSBuZXcgRXh0LmRhdGEuSHR0cFByb3h5KHsNCiAgICAJCQl1cmw6ICdzZXJpYWxpemF0aW9uJywNCiAgICAJCQltZXRob2Q6ICdQT1NUJw0KICAgIAkJfSk7DQogICAgCQlzZXJpYWxpemF0aW9uSHR0cFByb3h5Lm9uICggJ2JlZm9yZWxvYWQnLCBmdW5jdGlvbiAoIHQsIHAgKSB7IHAubm9jYWNoZSA9IDE7IHAubWV0aG9kID0gbXNnOyB9ICk7DQoNCiAgICAJCXZhciBzdG9yZV9BY3Rpb25JdGVtcyA9IG5ldyBFeHQuZGF0YS5TdG9yZSh7DQogICAgCQkJcHJveHk6IHNlcmlhbGl6YXRpb25IdHRwUHJveHksICAgIAkJDQogICAgCQkJYXV0b0xvYWQ6IGZhbHNlDQogICAgCQl9KTsgICAgCQkgDQogICAgCQkNCiAgICAJCXZhciBxdW90ZUh0dHBQcm94eSA9IG5ldyBFeHQuZGF0YS5IdHRwUHJveHkoew0KICAgIAkJCXVybDogZG9jdW1lbnQubG9jYXRpb24uaHJlZi5tYXRjaCgveG1sLykgPyAnZGF0YS9hZ2VudFhtbERhdGEuanNmJyA6ICdkYXRhL2FnZW50RGF0YS5qc2YnLA0KICAgIAkJCSBtZXRob2Q6ICdQT1NUJw0KICAgIAkJfSk7DQogICAgCQlxdW90ZUh0dHBQcm94eS5vbiAoICdiZWZvcmVsb2FkJywgZnVuY3Rpb24gKCB0LCBwICkgeyBwLm5vY2FjaGUgPSAxOyBwLm1ldGhvZCA9IG1zZzsgfSApOw0KICAgIAkJcXVvdGVIdHRwUHJveHkuZ2V0Q29ubmVjdGlvbigpLm9uKCdyZXF1ZXN0ZXhjZXB0aW9uJywgcmVxdWVzdEZhaWxlZCk7ICAgIAkJICAgCQ0KICAgIAkJdmFyIGRhdGFSZWFkZXI7DQogICAgCQlpZihtc2cgPT0gInhtbCIpeyAgICAJCQkNCiAgICAJCQlkYXRhUmVhZGVyID0gbmV3IEV4dC5kYXRhLlhtbFJlYWRlcih7cmVjb3JkOiAncm93J30sIHJlY29yZERlZiApOw0KICAgIAkJfQ0KICAgIAkJZWxzZQ0KICAgIAkJCWRhdGFSZWFkZXIgPSBuZXcgRXh0LmRhdGEuSnNvblJlYWRlcih7cm9vdDogJyd9LAlyZWNvcmREZWYgKTsNCiAgICAJCQ0KICAgIAkJdmFyIHF1b3RlRGF0YVN0b3JlID0gbmV3IEV4dC5kYXRhLlN0b3JlKHsJCQ0KICAgIAkJCXByb3h5OiBxdW90ZUh0dHBQcm94eSwNCiAgICAJCQlyZWFkZXI6IGRhdGFSZWFkZXIsDQogICAgCQkJYXV0b0xvYWQ6IHRydWUNCiAgICAJCX0pOw0KICAgIAkJDQogICAgCQlxdW90ZURhdGFTdG9yZS5vbignbG9hZGV4Y2VwdGlvbicsIGxvYWRGYWlsZWRNb2RlbCk7DQogICAgCQkJCQkJIA0KICAgIAkgICAgdmFyIGdyaWQgPSBuZXcgRXh0LmdyaWQuR3JpZFBhbmVsKHsNCiAgICAJCQlzdG9yZTogcXVvdGVEYXRhU3RvcmUsDQogICAgCQkJY29sdW1uczogWw0KICAgIAkJCSAgICAgICAgICB7aGVhZGVyOiAnRmlyc3QgbmFtZScsICAJZGF0YUluZGV4OiAnRmlyc3ROYW1lJywgc29ydGFibGU6IHRydWUsIHdpZHRoOjgwIH0sDQogICAgCQkJICAgICAgICAgIHtoZWFkZXI6ICdMYXN0IG5hbWUnLCAgCWRhdGFJbmRleDogJ0xhc3ROYW1lJywgc29ydGFibGU6IHRydWUsIHdpZHRoOjEyMCB9LA0KICAgIAkJCSAgICAgICAgICB7aGVhZGVyOiAnQ2l0eScsIAlkYXRhSW5kZXg6ICdDaXR5Jywgc29ydGFibGU6IHRydWV9LA0KICAgIAkJCSAgICAgICAgICB7aGVhZGVyOiAnU3RhdGUnLCAgCWRhdGFJbmRleDogJ1N0YXRlJywgc29ydGFibGU6IHRydWUsIHdpZHRoOjUwfSAgICAJCQkgICAgICAgICAgDQogICAgCQkJICAgICAgICAgIF0sDQogICAgCQkJd2lkdGg6IDM3MCwNCiAgICAJCSAgICBsaXN0ZW5lcnM6ew0KICAgIAkJCSAgCXJvd2RibGNsaWNrIDogZnVuY3Rpb24oZ3JpZCxyb3dJbmRleCl7ICAgIAkgICAgCQ0KICAgIAkgICAgCQkJcmVjID0gZ3JpZC5nZXRTdG9yZSgpLmdldEF0KHJvd0luZGV4KTsgICAgCSAgICAJCQkNCiAgICAJICAgIAkJICB2YXIgd2luID0gbmV3IEV4dC5XaW5kb3coew0KCQkJCSAgICAgIHdpZHRoOjQyMCwNCgkJCQkgICAgICBoZWlnaHQ6MTUwLA0KCQkJCSAgICAgIHRpdGxlOiIiK3JlYy5nZXQoJ0ZpcnN0TmFtZScpKyIgIityZWMuZ2V0KCdMYXN0TmFtZScpLA0KCQkJCSAgICAgIGl0ZW1zOg0KCQkJCSAgICAgIFsNCgkJCQkJCW5ldyBFeHQuUGFuZWwoew0KCQkJCQkJCWF1dG9IZWlnaHQ6ZmFsc2UsDQoJCQkJCQkJaGVpZ2h0OiAxMzAsDQoJCQkJCQkJaHRtbDogIjx0YWJsZSBzdHlsZT0nYm9yZGVyLXNwYWNpbmc6NXB0O2ZvbnQtc2l6ZTptZWRpdW0nID48dHI+PHRkPjxiPk5hbWU6PC9iPjwvdGQ+PHRkPiIrcmVjLmdldCgnRmlyc3ROYW1lJykrIiAiK3JlYy5nZXQoJ0xhc3ROYW1lJykrIjwvdGQ+PC90cj48dHI+PHRkPjxiPkFkZHJlc3M6IDwvYj48L3RkPjx0ZD4iK3JlYy5nZXQoJ0FkZHJlc3MnKSsiLCIrcmVjLmdldCgnQ2l0eScpKyIgIityZWMuZ2V0KCdaaXBDb2RlJykrIjwvdGQ+PC90cj48dHI+PHRkPjxiPlN0YXRlOiA8L2I+PC90ZD48dGQ+IityZWMuZ2V0KCdTdGF0ZScpKyI8L3RkPjwvdHI+PHRyPjx0ZD48Yj5QaG9uZTogPC9iPjwvdGQ+PHRkPiIrcmVjLmdldCgnUGhvbmUnKSsiPC90ZD48L3RyPjwvdGFibGU+Ig0KCQkJCQkJfSkNCgkJCQkgICAgICBdDQoJCQkJICAgfSk7DQogICAgCSAgICAJICAgd2luLnNob3coKTsNCiAgICAJCQkgICAgICAJCX0gICAgCQkJICAgICAgCQkNCiAgICAJCQkgICAgICAJfSwNCiAgICAJICAgICAgICByZW5kZXJUbzogJ2FnZW50VGFibGVESVYnLA0KICAgIAkJCXRpdGxlOiAnSW5zdXJhbmNlIENvLiBBZ2VudHMgKCcrbXNnLnJlc3BvbnNlVGV4dCsnKScsCQkNCiAgICAJCQlhdXRvSGVpZ2h0OiB0cnVlLA0KICAgIAkJCWZyYW1lOiB0cnVlDQogICAgCQl9KTsgICAgCSAgIA0KICAgIAkgICAgZ3JpZC5yZW5kZXIoKTsgICAgCSAgICAJDQogICAgfQ0KDQogICAgZnVuY3Rpb24gcmVxdWVzdEZhaWxlZChjb25uZWN0aW9uLCByZXNwb25zZSwgb3B0aW9ucykgew0KCQlFeHQuTWVzc2FnZUJveC5hbGVydCgnRXJyb3IgTWVzc2FnZScsIA0KCQkJCSJQbGVhc2UgY29udGFjdCBzdXBwb3J0IHdpdGggdGhlIGZvbGxvd2luZzogIiArIA0KCQkJCSJTdGF0dXM6ICIgKyByZXNwb25zZS5zdGF0dXMgKyANCgkJCQkiLCBTdGF0dXMgVGV4dDogIiArIHJlc3BvbnNlLnN0YXR1c1RleHQpOw0KCX0NCiAgICANCiAgICBmdW5jdGlvbiBsb2FkRmFpbGVkTW9kZWwocHJveHksIG9wdGlvbnMsIHJlc3BvbnNlLCBlcnJvcikgew0KCQlhbGVydChlcnJvcik7DQogICAgfQ0KDQp9KTs=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPBody>
      </HTTPResponse>
    </HTTPTask>
  </HTTPTask>
</HTTPSnapshot>